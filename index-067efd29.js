var MM=Object.defineProperty;var UM=(r,e,t)=>e in r?MM(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var k=(r,e,t)=>(UM(r,typeof e!="symbol"?e+"":e,t),t),V8=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var ce=(r,e,t)=>(V8(r,e,"read from private field"),t?t.call(r):e.get(r)),vt=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},Xe=(r,e,t,n)=>(V8(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t);var Rg=(r,e,t,n)=>({set _(s){Xe(r,e,s,t)},get _(){return ce(r,e,n)}});import{C as B,f as BM,a as zM,b as Ys,c as FM,d as le,r as VM,e as Is,g as jM,h as M,i as Gi,j as me,k as Ge,l as L,t as C,m as fn,n as wT,o as qM,p as bT,w as KM,q as GM,s as HM,u as WM,v as mT,x as Z6,y as ht,z as QM,P as zt,A as ET,R as Y0,B as vT,W as X0,D as _T,E as ka,F as to,G as Ad,H as Vo,I as Nc,J as Wr,K as Qr,L as Yr,M as Lo,N as Je,O as Mo,Q as Lt,S as ST,T as _w,U as j8,V as YM,X as XM,Y as JM,Z as ZM,_ as eU,$ as tU,a0 as rU,a1 as nU,a2 as J0,a3 as em,a4 as AT,a5 as sU,a6 as Qe,a7 as _l,a8 as yi,a9 as tm,aa as $d,ab as $T,ac as RT,ad as rm,ae as TT,af as iU,ag as oU,ah as aU,ai as q8,aj as K8,ak as cU,al as IT,am as G8,an as Tg,ao as vp,ap as Vl}from"./index-2b10586a.js";const H8={sha1:"sha1","sha2-256":"sha256","sha2-512":"sha512"};function W8(r,e,t,n,s){if(s!=="sha1"&&s!=="sha2-256"&&s!=="sha2-512"){const a=Object.keys(H8).join(" / ");throw new B(`Hash '${s}' is unknown or not supported. Must be ${a}`,"ERR_UNSUPPORTED_HASH_TYPE")}const i=H8[s],o=BM(r,e,t,n,i);return zM.encode64(o,null)}function Sw(r,e){for(let t=0;t<r.byteLength;t++){if(r[t]<e[t])return-1;if(r[t]>e[t])return 1}return r.byteLength>e.byteLength?1:r.byteLength<e.byteLength?-1:0}function Rd(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");const t=Ys(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return FM(t)}function lU(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var uU=lU,dU=uU;const hU=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let fU=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},pU=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return CT(this,e)}},gU=class{constructor(e){this.decoders=e}or(e){return CT(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const CT=(r,e)=>new gU({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let yU=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new fU(e,t,n),this.decoder=new pU(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const xT=({name:r,prefix:e,encode:t,decode:n})=>new yU(r,e,t,n),DT=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=dU(t,e);return xT({prefix:r,name:e,encode:n,decode:i=>hU(s(i))})},wU=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},bU=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},wn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>xT({prefix:e,name:r,encode(s){return bU(s,n,t)},decode(s){return wU(s,n,t,r)}}),mU=DT({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});DT({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const EU=wn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});wn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});wn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});wn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});wn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});wn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});wn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});wn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});wn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const vU=wn({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});wn({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});wn({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});wn({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});le.formatters.b=r=>r==null?"undefined":mU.baseEncode(r);le.formatters.t=r=>r==null?"undefined":EU.baseEncode(r);le.formatters.m=r=>r==null?"undefined":vU.baseEncode(r);le.formatters.p=r=>r==null?"undefined":r.toString();le.formatters.c=r=>r==null?"undefined":r.toString();le.formatters.k=r=>r==null?"undefined":r.toString();le.formatters.a=r=>r==null?"undefined":r.toString();function _U(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function N(r){let e=_U(`${r}:trace`);return le.enabled(`${r}:trace`)&&le.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=le(`${r}:trace`)),Object.assign(le(r),{error:le(`${r}:error`),trace:e})}let Q8=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Wa(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}function Td(r,e,t){const n=t??{},s=Wa(r);async function*i(){let o;const a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){const{abortMessage:l,abortCode:d}=n;throw new Q8(l,d)}const u=new Promise((l,d)=>{o=()=>{const{abortMessage:f,abortCode:g}=n;d(new Q8(f,g))}});c=await Promise.race([u,s.next()]),o=null}catch(u){e.removeEventListener("abort",a);const l=u.type==="aborted"&&e.aborted;if(l&&n.onAbort!=null&&n.onAbort(r),typeof s.return=="function")try{const d=s.return();d instanceof Promise&&d.catch(f=>{n.onReturnError!=null&&n.onReturnError(f)})}catch(d){n.onReturnError!=null&&n.onReturnError(d)}if(l&&n.returnOnAbort===!0)return;throw u}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return i()}function OT(r){const e=new globalThis.AbortController;function t(){e.abort();for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(const i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=n,s}function Pe(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}let Y8=class{constructor(e){k(this,"buffer");k(this,"mask");k(this,"top");k(this,"btm");k(this,"next");if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}},Ig=class{constructor(e={}){k(this,"size");k(this,"hwm");k(this,"head");k(this,"tail");this.hwm=e.splitLimit??16,this.head=new Y8(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new Y8(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}},SU=class extends Error{constructor(t,n){super(t??"The operation was aborted");k(this,"type");k(this,"code");this.type="aborted",this.code=n??"ABORT_ERR"}};function Mt(r={}){return kT(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function PT(r={}){return kT(t=>{let n;const s=[];for(;!t.isEmpty()&&(n=t.shift(),n!=null);){if(n.error!=null)throw n.error;n.done===!1&&s.push(n.value)}return n==null?{done:!0}:{done:n.done===!0,value:s}},r)}function kT(r,e){e=e??{};let t=e.onEnd,n=new Ig,s,i,o,a=Pe();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((w,y)=>{i=E=>{i=null,n.push(E);try{w(r(n))}catch(m){y(m)}return s}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=Pe()})}},u=w=>i!=null?i(w):(n.push(w),s),l=w=>(n=new Ig,i!=null?i({error:w}):(n.push({error:w}),s)),d=w=>{if(o)return s;if(e?.objectMode!==!0&&w?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return u({done:!1,value:w})},f=w=>o?s:(o=!0,w!=null?l(w):u({done:!0})),g=()=>(n=new Ig,f(),{done:!0}),h=w=>(f(w),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:g,throw:h,push:d,end:f,get readableLength(){return n.size},onEmpty:async w=>{const y=w?.signal;if(y?.throwIfAborted(),n.isEmpty())return;let E,m;y!=null&&(E=new Promise((b,v)=>{m=()=>{v(new SU)},y.addEventListener("abort",m)}));try{await Promise.race([a.promise,E])}finally{m!=null&&y!=null&&y?.removeEventListener("abort",m)}}},t==null)return s;const p=s;return s={[Symbol.asyncIterator](){return this},next(){return p.next()},throw(w){return p.throw(w),t!=null&&(t(w),t=void 0),{done:!0}},return(){return p.return(),t!=null&&(t(),t=void 0),{done:!0}},push:d,end(w){return p.end(w),t!=null&&(t(w),t=void 0),s},get readableLength(){return p.readableLength}},s}var Z0=class{constructor(e={}){this.points=e.points,this.duration=e.duration,this.blockDuration=e.blockDuration,this.execEvenly=e.execEvenly,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs,this.keyPrefix=e.keyPrefix}get points(){return this._points}set points(e){this._points=e>=0?e:4}get duration(){return this._duration}set duration(e){this._duration=typeof e>"u"?1:e}get msDuration(){return this.duration*1e3}get blockDuration(){return this._blockDuration}set blockDuration(e){this._blockDuration=typeof e>"u"?0:e}get msBlockDuration(){return this.blockDuration*1e3}get execEvenly(){return this._execEvenly}set execEvenly(e){this._execEvenly=typeof e>"u"?!1:!!e}get execEvenlyMinDelayMs(){return this._execEvenlyMinDelayMs}set execEvenlyMinDelayMs(e){this._execEvenlyMinDelayMs=typeof e>"u"?Math.ceil(this.msDuration/this.points):e}get keyPrefix(){return this._keyPrefix}set keyPrefix(e){if(typeof e>"u"&&(e="rlflx"),typeof e!="string")throw new Error("keyPrefix must be string");this._keyPrefix=e}_getKeySecDuration(e={}){return e&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}consume(){throw new Error("You have to implement the method 'consume'!")}penalty(){throw new Error("You have to implement the method 'penalty'!")}reward(){throw new Error("You have to implement the method 'reward'!")}get(){throw new Error("You have to implement the method 'get'!")}set(){throw new Error("You have to implement the method 'set'!")}block(){throw new Error("You have to implement the method 'block'!")}delete(){throw new Error("You have to implement the method 'delete'!")}},AU=class{constructor(){this._keys={},this._addedKeysAmount=0}collectExpired(){const e=Date.now();Object.keys(this._keys).forEach(t=>{this._keys[t]<=e&&delete this._keys[t]}),this._addedKeysAmount=Object.keys(this._keys).length}add(e,t){this.addMs(e,t*1e3)}addMs(e,t){this._keys[e]=Date.now()+t,this._addedKeysAmount++,this._addedKeysAmount>999&&this.collectExpired()}msBeforeExpire(e){const t=this._keys[e];if(t&&t>=Date.now()){this.collectExpired();const n=Date.now();return t>=n?t-n:0}return 0}delete(e){e?delete this._keys[e]:Object.keys(this._keys).forEach(t=>{delete this._keys[t]})}};const $U=AU;var RU=$U,Jn=class{constructor(e,t,n,s){this.remainingPoints=typeof e>"u"?0:e,this.msBeforeNext=typeof t>"u"?0:t,this.consumedPoints=typeof n>"u"?0:n,this.isFirstInDuration=typeof s>"u"?!1:s}get msBeforeNext(){return this._msBeforeNext}set msBeforeNext(e){return this._msBeforeNext=e,this}get remainingPoints(){return this._remainingPoints}set remainingPoints(e){return this._remainingPoints=e,this}get consumedPoints(){return this._consumedPoints}set consumedPoints(e){return this._consumedPoints=e,this}get isFirstInDuration(){return this._isFirstInDuration}set isFirstInDuration(e){this._isFirstInDuration=!!e}_getDecoratedProperties(){return{remainingPoints:this.remainingPoints,msBeforeNext:this.msBeforeNext,consumedPoints:this.consumedPoints,isFirstInDuration:this.isFirstInDuration}}[Symbol.for("nodejs.util.inspect.custom")](){return this._getDecoratedProperties()}toString(){return JSON.stringify(this._getDecoratedProperties())}toJSON(){return this._getDecoratedProperties()}};const Cg=Z0,TU=RU,X8=Jn;var ch=class extends Cg{constructor(e={}){super(e),this.inMemoryBlockOnConsumed=e.inMemoryBlockOnConsumed||e.inmemoryBlockOnConsumed,this.inMemoryBlockDuration=e.inMemoryBlockDuration||e.inmemoryBlockDuration,this.insuranceLimiter=e.insuranceLimiter,this._inMemoryBlockedKeys=new TU}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("storeClient is not set");this._client=e}_afterConsume(e,t,n,s,i,o={}){const a=this._getRateLimiterRes(n,s,i);if(this.inMemoryBlockOnConsumed>0&&!(this.inMemoryBlockDuration>0)&&a.consumedPoints>=this.inMemoryBlockOnConsumed)return this._inMemoryBlockedKeys.addMs(n,a.msBeforeNext),a.consumedPoints>this.points?t(a):e(a);if(a.consumedPoints>this.points){let c=Promise.resolve();this.blockDuration>0&&a.consumedPoints<=this.points+s&&(a.msBeforeNext=this.msBlockDuration,c=this._block(n,a.consumedPoints,this.msBlockDuration,o)),this.inMemoryBlockOnConsumed>0&&a.consumedPoints>=this.inMemoryBlockOnConsumed&&(this._inMemoryBlockedKeys.add(n,this.inMemoryBlockDuration),a.msBeforeNext=this.msInMemoryBlockDuration),c.then(()=>{t(a)}).catch(u=>{t(u)})}else if(this.execEvenly&&a.msBeforeNext>0&&!a.isFirstInDuration){let c=Math.ceil(a.msBeforeNext/(a.remainingPoints+2));c<this.execEvenlyMinDelayMs&&(c=a.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(e,c,a)}else e(a)}_handleError(e,t,n,s,i,o=!1,a={}){this.insuranceLimiter instanceof Cg?this.insuranceLimiter[t](i,o,a).then(c=>{n(c)}).catch(c=>{s(c)}):s(e)}get _inmemoryBlockedKeys(){return this._inMemoryBlockedKeys}getInmemoryBlockMsBeforeExpire(e){return this.getInMemoryBlockMsBeforeExpire(e)}get inmemoryBlockOnConsumed(){return this.inMemoryBlockOnConsumed}set inmemoryBlockOnConsumed(e){this.inMemoryBlockOnConsumed=e}get inmemoryBlockDuration(){return this.inMemoryBlockDuration}set inmemoryBlockDuration(e){this.inMemoryBlockDuration=e}get msInmemoryBlockDuration(){return this.inMemoryBlockDuration*1e3}getInMemoryBlockMsBeforeExpire(e){return this.inMemoryBlockOnConsumed>0?this._inMemoryBlockedKeys.msBeforeExpire(e):0}get inMemoryBlockOnConsumed(){return this._inMemoryBlockOnConsumed}set inMemoryBlockOnConsumed(e){if(this._inMemoryBlockOnConsumed=e?parseInt(e):0,this.inMemoryBlockOnConsumed>0&&this.points>this.inMemoryBlockOnConsumed)throw new Error('inMemoryBlockOnConsumed option must be greater or equal "points" option')}get inMemoryBlockDuration(){return this._inMemoryBlockDuration}set inMemoryBlockDuration(e){if(this._inMemoryBlockDuration=e?parseInt(e):0,this.inMemoryBlockDuration>0&&this.inMemoryBlockOnConsumed===0)throw new Error("inMemoryBlockOnConsumed option must be set up")}get msInMemoryBlockDuration(){return this._inMemoryBlockDuration*1e3}get insuranceLimiter(){return this._insuranceLimiter}set insuranceLimiter(e){if(typeof e<"u"&&!(e instanceof Cg))throw new Error("insuranceLimiter must be instance of RateLimiterAbstract");this._insuranceLimiter=e,this._insuranceLimiter&&(this._insuranceLimiter.blockDuration=this.blockDuration,this._insuranceLimiter.execEvenly=this.execEvenly)}block(e,t,n={}){const s=t*1e3;return this._block(this.getKey(e),this.points+1,s,n)}set(e,t,n,s={}){const i=(n>=0?n:this.duration)*1e3;return this._block(this.getKey(e),t,i,s)}consume(e,t=1,n={}){return new Promise((s,i)=>{const o=this.getKey(e),a=this.getInMemoryBlockMsBeforeExpire(o);if(a>0)return i(new X8(0,a));this._upsert(o,t,this._getKeySecDuration(n)*1e3,!1,n).then(c=>{this._afterConsume(s,i,o,t,c)}).catch(c=>{this._handleError(c,"consume",s,i,e,t,n)})})}penalty(e,t=1,n={}){const s=this.getKey(e);return new Promise((i,o)=>{this._upsert(s,t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{i(this._getRateLimiterRes(s,t,a))}).catch(a=>{this._handleError(a,"penalty",i,o,e,t,n)})})}reward(e,t=1,n={}){const s=this.getKey(e);return new Promise((i,o)=>{this._upsert(s,-t,this._getKeySecDuration(n)*1e3,!1,n).then(a=>{i(this._getRateLimiterRes(s,-t,a))}).catch(a=>{this._handleError(a,"reward",i,o,e,t,n)})})}get(e,t={}){const n=this.getKey(e);return new Promise((s,i)=>{this._get(n,t).then(o=>{s(o===null||typeof o>"u"?null:this._getRateLimiterRes(n,0,o))}).catch(o=>{this._handleError(o,"get",s,i,e,t)})})}delete(e,t={}){const n=this.getKey(e);return new Promise((s,i)=>{this._delete(n,t).then(o=>{this._inMemoryBlockedKeys.delete(n),s(o)}).catch(o=>{this._handleError(o,"delete",s,i,e,t)})})}deleteInMemoryBlockedAll(){this._inMemoryBlockedKeys.delete()}_getRateLimiterRes(e,t,n){throw new Error("You have to implement the method '_getRateLimiterRes'!")}_block(e,t,n,s={}){return new Promise((i,o)=>{this._upsert(e,t,n,!0,s).then(()=>{i(new X8(0,n>0?n:-1,t))}).catch(a=>{this._handleError(a,"block",i,o,this.parseKey(e),n/1e3,s)})})}_get(e,t={}){throw new Error("You have to implement the method '_get'!")}_delete(e,t={}){throw new Error("You have to implement the method '_delete'!")}_upsert(e,t,n,s=!1,i={}){throw new Error("You have to implement the method '_upsert'!")}};const IU=ch,CU=Jn,J8="redis.call('set', KEYS[1], 0, 'EX', ARGV[2], 'NX') local consumed = redis.call('incrby', KEYS[1], ARGV[1]) local ttl = redis.call('pttl', KEYS[1]) if ttl == -1 then   redis.call('expire', KEYS[1], ARGV[2])   ttl = 1000 * ARGV[2] end return {consumed, ttl} ";let xU=class extends IU{constructor(e){super(e),e.redis?this.client=e.redis:this.client=e.storeClient,this._rejectIfRedisNotReady=!!e.rejectIfRedisNotReady,typeof this.client.defineCommand=="function"&&this.client.defineCommand("rlflxIncr",{numberOfKeys:1,lua:J8})}_isRedisReady(){return this._rejectIfRedisNotReady?!(this.client.status&&this.client.status!=="ready"||typeof this.client.isReady=="function"&&!this.client.isReady()):!0}_getRateLimiterRes(e,t,n){let[s,i]=n;Array.isArray(s)&&([,s]=s,[,i]=i);const o=new CU;return o.consumedPoints=parseInt(s),o.isFirstInDuration=o.consumedPoints===t,o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.msBeforeNext=i,o}_upsert(e,t,n,s=!1){return new Promise((i,o)=>{if(!this._isRedisReady())return o(new Error("Redis connection is not ready"));const a=Math.floor(n/1e3),c=this.client.multi();if(s)a>0?c.set(e,t,"EX",a):c.set(e,t),c.pttl(e).exec((u,l)=>u?o(u):i(l));else if(a>0){const u=function(l,d){return l?o(l):i(d)};typeof this.client.rlflxIncr=="function"?this.client.rlflxIncr(e,t,a,u):this.client.eval(J8,1,e,t,a,u)}else c.incrby(e,t).pttl(e).exec((u,l)=>u?o(u):i(l))})}_get(e){return new Promise((t,n)=>{if(!this._isRedisReady())return n(new Error("Redis connection is not ready"));this.client.multi().get(e).pttl(e).exec((s,i)=>{if(s)n(s);else{const[o]=i;if(o===null)return t(null);t(i)}})})}_delete(e){return new Promise((t,n)=>{this.client.del(e,(s,i)=>{s?n(s):t(i>0)})})}};var DU=xU;const OU=ch,PU=Jn;function Z8(r){try{const e=r.client?r.client:r,{version:t}=e.topology.s.options.metadata.driver,n=t.split(".").map(s=>parseInt(s));return{major:n[0],feature:n[1],patch:n[2]}}catch{return{major:0,feature:0,patch:0}}}let kU=class NT extends OU{constructor(e){super(e),this.dbName=e.dbName,this.tableName=e.tableName,this.indexKeyPrefix=e.indexKeyPrefix,e.mongo?this.client=e.mongo:this.client=e.storeClient,typeof this.client.then=="function"?this.client.then(t=>{this.client=t,this._initCollection(),this._driverVersion=Z8(this.client)}):(this._initCollection(),this._driverVersion=Z8(this.client))}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?NT.getDbName():e}static getDbName(){return"node-rate-limiter-flexible"}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get client(){return this._client}set client(e){if(typeof e>"u")throw new Error("mongo is not set");this._client=e}get indexKeyPrefix(){return this._indexKeyPrefix}set indexKeyPrefix(e){this._indexKeyPrefix=e||{}}_initCollection(){const t=(typeof this.client.db=="function"?this.client.db(this.dbName):this.client).collection(this.tableName);t.createIndex({expire:-1},{expireAfterSeconds:0}),t.createIndex(Object.assign({},this.indexKeyPrefix,{key:1}),{unique:!0}),this._collection=t}_getRateLimiterRes(e,t,n){const s=new PU;let i;return typeof n.value>"u"?i=n:i=n.value,s.isFirstInDuration=i.points===t,s.consumedPoints=i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire!==null?Math.max(new Date(i.expire).getTime()-Date.now(),0):-1,s}_upsert(e,t,n,s=!1,i={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const o=i.attrs||{};let a,c;s?(a={key:e},a=Object.assign(a,o),c={$set:{key:e,points:t,expire:n>0?new Date(Date.now()+n):null}},c.$set=Object.assign(c.$set,o)):(a={$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}],key:e},a=Object.assign(a,o),c={$setOnInsert:{key:e,expire:n>0?new Date(Date.now()+n):null},$inc:{points:t}},c.$setOnInsert=Object.assign(c.$setOnInsert,o));const u={upsert:!0};return this._driverVersion.major>=4||this._driverVersion.major===3&&this._driverVersion.feature>=7||this._driverVersion.feature>=6&&this._driverVersion.patch>=7?u.returnDocument="after":u.returnOriginal=!1,new Promise((l,d)=>{this._collection.findOneAndUpdate(a,c,u).then(f=>{l(f)}).catch(f=>{if(f&&f.code===11e3){const g=Object.assign({$or:[{expire:{$lte:new Date}},{expire:{$eq:null}}],key:e},o),h={$set:Object.assign({key:e,points:t,expire:n>0?new Date(Date.now()+n):null},o)};this._collection.findOneAndUpdate(g,h,u).then(p=>{l(p)}).catch(p=>{p&&p.code===11e3?this._upsert(e,t,n,s).then(w=>l(w)).catch(w=>d(w)):d(p)})}else d(f)})})}_get(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const n=t.attrs||{},s=Object.assign({key:e,$or:[{expire:{$gt:new Date}},{expire:{$eq:null}}]},n);return this._collection.findOne(s)}_delete(e,t={}){if(!this._collection)return Promise.reject(Error("Mongo connection is not established"));const n=t.attrs||{},s=Object.assign({key:e},n);return this._collection.deleteOne(s).then(i=>i.deletedCount>0)}};var NU=kU;const LU=ch,MU=Jn;let UU=class extends LU{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.dbName=e.dbName,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?(this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()):this._createDbAndTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{this._getConnection().then(n=>{n.query("DELETE FROM ??.?? WHERE expire < ?",[this.dbName,this.tableName,e],()=>{this._releaseConnection(n),t()})}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return new Promise((e,t)=>{this.client.getConnection((n,s)=>{if(n)return t(n);e(s)})});case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return e.release();case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);default:return!0}}_createDbAndTable(){return new Promise((e,t)=>{this._getConnection().then(n=>{n.query(`CREATE DATABASE IF NOT EXISTS \`${this.dbName}\`;`,s=>{if(s)return this._releaseConnection(n),t(s);n.query(this._getCreateTableStmt(),i=>{if(i)return this._releaseConnection(n),t(i);this._releaseConnection(n),e()})})}).catch(n=>{t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS \`${this.dbName}\`.\`${this.tableName}\` (\`key\` VARCHAR(255) CHARACTER SET utf8 NOT NULL,\`points\` INT(9) NOT NULL default 0,\`expire\` BIGINT UNSIGNED,PRIMARY KEY (\`key\`)) ENGINE = INNODB;`}get clientType(){return this._clientType}set clientType(e){if(typeof e>"u")if(this.client.constructor.name==="Connection")e="connection";else if(this.client.constructor.name==="Pool")e="pool";else if(this.client.constructor.name==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get dbName(){return this._dbName}set dbName(e){this._dbName=typeof e>"u"?"rtlmtrflx":e}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:!!e}_getRateLimiterRes(e,t,n){const s=new MU,[i]=n;return s.isFirstInDuration=t===i.points,s.consumedPoints=s.isFirstInDuration?t:i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire?Math.max(i.expire-Date.now(),0):-1,s}_upsertTransaction(e,t,n,s,i){return new Promise((o,a)=>{e.query("BEGIN",c=>{if(c)return e.rollback(),a(c);const u=Date.now(),l=s>0?u+s:null;let d,f;i?(d=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = ?, 
            expire = ?;`,f=[this.dbName,this.tableName,t,n,l,n,l]):(d=`INSERT INTO ??.?? VALUES (?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            points = IF(expire <= ?, ?, points + (?)), 
            expire = IF(expire <= ?, ?, expire);`,f=[this.dbName,this.tableName,t,n,l,u,n,n,u,l]),e.query(d,f,g=>{if(g)return e.rollback(),a(g);e.query("SELECT points, expire FROM ??.?? WHERE `key` = ?;",[this.dbName,this.tableName,t],(h,p)=>{if(h)return e.rollback(),a(h);e.query("COMMIT",w=>{if(w)return e.rollback(),a(w);o(p)})})})})})}_upsert(e,t,n,s=!1){return this.tableCreated?new Promise((i,o)=>{this._getConnection().then(a=>{this._upsertTransaction(a,e,t,n,s).then(c=>{i(c),this._releaseConnection(a)}).catch(c=>{o(c),this._releaseConnection(a)})}).catch(a=>{o(a)})}):Promise.reject(Error("Table is not created yet"))}_get(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(s=>{s.query("SELECT points, expire FROM ??.?? WHERE `key` = ? AND (`expire` > ? OR `expire` IS NULL)",[this.dbName,this.tableName,e,Date.now()],(i,o)=>{i?n(i):o.length===0?t(null):t(o),this._releaseConnection(s)})}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?new Promise((t,n)=>{this._getConnection().then(s=>{s.query("DELETE FROM ??.?? WHERE `key` = ?",[this.dbName,this.tableName,e],(i,o)=>{i?n(i):t(o.affectedRows>0),this._releaseConnection(s)})}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}};var BU=UU;const zU=ch,FU=Jn;let VU=class extends zU{constructor(e,t=null){super(e),this.client=e.storeClient,this.clientType=e.storeType,this.tableName=e.tableName,this.clearExpiredByTimeout=e.clearExpiredByTimeout,this.tableCreated=e.tableCreated,this.tableCreated?typeof t=="function"&&t():this._createTable().then(()=>{this.tableCreated=!0,this.clearExpiredByTimeout&&this._clearExpiredHourAgo(),typeof t=="function"&&t()}).catch(n=>{if(typeof t=="function")t(n);else throw n})}clearExpired(e){return new Promise(t=>{const n={name:"rlflx-clear-expired",text:`DELETE FROM ${this.tableName} WHERE expire < $1`,values:[e]};this._query(n).then(()=>{t()}).catch(()=>{t()})})}_clearExpiredHourAgo(){this._clearExpiredTimeoutId&&clearTimeout(this._clearExpiredTimeoutId),this._clearExpiredTimeoutId=setTimeout(()=>{this.clearExpired(Date.now()-36e5).then(()=>{this._clearExpiredHourAgo()})},3e5),this._clearExpiredTimeoutId.unref()}_getConnection(){switch(this.clientType){case"pool":return Promise.resolve(this.client);case"sequelize":return this.client.connectionManager.getConnection();case"knex":return this.client.client.acquireConnection();case"typeorm":return Promise.resolve(this.client.driver.master);default:return Promise.resolve(this.client)}}_releaseConnection(e){switch(this.clientType){case"pool":return!0;case"sequelize":return this.client.connectionManager.releaseConnection(e);case"knex":return this.client.client.releaseConnection(e);case"typeorm":return!0;default:return!0}}_createTable(){return new Promise((e,t)=>{this._query({text:this._getCreateTableStmt()}).then(()=>{e()}).catch(n=>{n.code==="23505"?e():t(n)})})}_getCreateTableStmt(){return`CREATE TABLE IF NOT EXISTS ${this.tableName} ( 
      key varchar(255) PRIMARY KEY,
      points integer NOT NULL DEFAULT 0,
      expire bigint
    );`}get clientType(){return this._clientType}set clientType(e){const t=this.client.constructor.name;if(typeof e>"u")if(t==="Client")e="client";else if(t==="Pool"||t==="BoundPool")e="pool";else if(t==="Sequelize")e="sequelize";else throw new Error("storeType is not defined");this._clientType=e.toLowerCase()}get tableName(){return this._tableName}set tableName(e){this._tableName=typeof e>"u"?this.keyPrefix:e}get tableCreated(){return this._tableCreated}set tableCreated(e){this._tableCreated=typeof e>"u"?!1:!!e}get clearExpiredByTimeout(){return this._clearExpiredByTimeout}set clearExpiredByTimeout(e){this._clearExpiredByTimeout=typeof e>"u"?!0:!!e}_getRateLimiterRes(e,t,n){const s=new FU,i=n.rows[0];return s.isFirstInDuration=t===i.points,s.consumedPoints=s.isFirstInDuration?t:i.points,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=i.expire?Math.max(i.expire-Date.now(),0):-1,s}_query(e){const n={name:`${this.tableName.toLowerCase()}:${e.name}`,text:e.text,values:e.values};return new Promise((s,i)=>{this._getConnection().then(o=>{o.query(n).then(a=>{s(a),this._releaseConnection(o)}).catch(a=>{i(a),this._releaseConnection(o)})}).catch(o=>{i(o)})})}_upsert(e,t,n,s=!1){if(!this.tableCreated)return Promise.reject(Error("Table is not created yet"));const i=n>0?Date.now()+n:null,o=s?" $3 ":` CASE
             WHEN ${this.tableName}.expire <= $4 THEN $3
             ELSE ${this.tableName}.expire
            END `;return this._query({name:s?"rlflx-upsert-force":"rlflx-upsert",text:`
            INSERT INTO ${this.tableName} VALUES ($1, $2, $3)
              ON CONFLICT(key) DO UPDATE SET
                points = CASE
                          WHEN (${this.tableName}.expire <= $4 OR 1=${s?1:0}) THEN $2
                          ELSE ${this.tableName}.points + ($2)
                         END,
                expire = ${o}
            RETURNING points, expire;`,values:[e,t,i,Date.now()]})}_get(e){return this.tableCreated?new Promise((t,n)=>{this._query({name:"rlflx-get",text:`
            SELECT points, expire FROM ${this.tableName} WHERE key = $1 AND (expire > $2 OR expire IS NULL);`,values:[e,Date.now()]}).then(s=>{s.rowCount===0&&(s=null),t(s)}).catch(s=>{n(s)})}):Promise.reject(Error("Table is not created yet"))}_delete(e){return this.tableCreated?this._query({name:"rlflx-delete",text:`DELETE FROM ${this.tableName} WHERE key = $1`,values:[e]}).then(t=>t.rowCount>0):Promise.reject(Error("Table is not created yet"))}};var jU=VU,qU=class{constructor(e,t,n=null){this.value=e,this.expiresAt=t,this.timeoutId=n}get value(){return this._value}set value(e){this._value=parseInt(e)}get expiresAt(){return this._expiresAt}set expiresAt(e){!(e instanceof Date)&&Number.isInteger(e)&&(e=new Date(e)),this._expiresAt=e}get timeoutId(){return this._timeoutId}set timeoutId(e){this._timeoutId=e}};const KU=qU,xg=Jn;var GU=class{constructor(){this._storage={}}incrby(e,t,n){if(this._storage[e]){const s=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return s!==0?(this._storage[e].value=this._storage[e].value+t,new xg(0,s,this._storage[e].value,!1)):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const s=n*1e3;return this._storage[e]&&this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),this._storage[e]=new KU(t,s>0?new Date(Date.now()+s):null),s>0&&(this._storage[e].timeoutId=setTimeout(()=>{delete this._storage[e]},s),this._storage[e].timeoutId.unref&&this._storage[e].timeoutId.unref()),new xg(0,s===0?-1:s,this._storage[e].value,!0)}get(e){if(this._storage[e]){const t=this._storage[e].expiresAt?this._storage[e].expiresAt.getTime()-new Date().getTime():-1;return new xg(0,t,this._storage[e].value,!1)}return null}delete(e){return this._storage[e]?(this._storage[e].timeoutId&&clearTimeout(this._storage[e].timeoutId),delete this._storage[e],!0):!1}};const HU=Z0,WU=GU,e7=Jn;let QU=class extends HU{constructor(e={}){super(e),this._memoryStorage=new WU}consume(e,t=1,n={}){return new Promise((s,i)=>{const o=this.getKey(e),a=this._getKeySecDuration(n);let c=this._memoryStorage.incrby(o,t,a);if(c.remainingPoints=Math.max(this.points-c.consumedPoints,0),c.consumedPoints>this.points)this.blockDuration>0&&c.consumedPoints<=this.points+t&&(c=this._memoryStorage.set(o,c.consumedPoints,this.blockDuration)),i(c);else if(this.execEvenly&&c.msBeforeNext>0&&!c.isFirstInDuration){let u=Math.ceil(c.msBeforeNext/(c.remainingPoints+2));u<this.execEvenlyMinDelayMs&&(u=c.consumedPoints*this.execEvenlyMinDelayMs),setTimeout(s,u,c)}else s(c)})}penalty(e,t=1,n={}){const s=this.getKey(e);return new Promise(i=>{const o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(s,t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),i(a)})}reward(e,t=1,n={}){const s=this.getKey(e);return new Promise(i=>{const o=this._getKeySecDuration(n),a=this._memoryStorage.incrby(s,-t,o);a.remainingPoints=Math.max(this.points-a.consumedPoints,0),i(a)})}block(e,t){const n=t*1e3,s=this.points+1;return this._memoryStorage.set(this.getKey(e),s,t),Promise.resolve(new e7(0,n===0?-1:n,s))}set(e,t,n){const s=(n>=0?n:this.duration)*1e3;return this._memoryStorage.set(this.getKey(e),t,n),Promise.resolve(new e7(0,s===0?-1:s,t))}get(e){const t=this._memoryStorage.get(this.getKey(e));return t!==null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),Promise.resolve(t)}delete(e){return Promise.resolve(this._memoryStorage.delete(this.getKey(e)))}};var LT=QU;const t7=jM,YU=VM(),XU=Z0,MT=LT,JU=Jn,Gn="rate_limiter_flexible";let Vc=null;const r7=function(r,e,t,n){let s;n===null||n===!0||n===!1?s=n:s={remainingPoints:n.remainingPoints,msBeforeNext:n.msBeforeNext,consumedPoints:n.consumedPoints,isFirstInDuration:n.isFirstInDuration},r.send({channel:Gn,keyPrefix:e.keyPrefix,promiseId:e.promiseId,type:t,data:s})},UT=function(r){setTimeout(()=>{this._initiated?Is.send(r):typeof this._promises[r.promiseId]<"u"&&UT.call(this,r)},30)},ac=function(r,e,t,n,s){const i={channel:Gn,keyPrefix:this.keyPrefix,func:r,promiseId:e,data:{key:t,arg:n,opts:s}};this._initiated?Is.send(i):UT.call(this,i)},BT=function(r,e){if(!e||e.channel!==Gn||typeof this._rateLimiters[e.keyPrefix]>"u")return!1;let t;switch(e.func){case"consume":t=this._rateLimiters[e.keyPrefix].consume(e.data.key,e.data.arg,e.data.opts);break;case"penalty":t=this._rateLimiters[e.keyPrefix].penalty(e.data.key,e.data.arg,e.data.opts);break;case"reward":t=this._rateLimiters[e.keyPrefix].reward(e.data.key,e.data.arg,e.data.opts);break;case"block":t=this._rateLimiters[e.keyPrefix].block(e.data.key,e.data.arg,e.data.opts);break;case"get":t=this._rateLimiters[e.keyPrefix].get(e.data.key,e.data.opts);break;case"delete":t=this._rateLimiters[e.keyPrefix].delete(e.data.key,e.data.opts);break;default:return!1}t&&t.then(n=>{r7(r,e,"resolve",n)}).catch(n=>{r7(r,e,"reject",n)})},ZU=function(r){if(!r||r.channel!==Gn||r.keyPrefix!==this.keyPrefix)return!1;if(this._promises[r.promiseId]){clearTimeout(this._promises[r.promiseId].timeoutId);let e;switch(r.data===null||r.data===!0||r.data===!1?e=r.data:e=new JU(r.data.remainingPoints,r.data.msBeforeNext,r.data.consumedPoints,r.data.isFirstInDuration),r.type){case"resolve":this._promises[r.promiseId].resolve(e);break;case"reject":this._promises[r.promiseId].reject(e);break;default:throw new Error(`RateLimiterCluster: no such message type '${r.type}'`)}delete this._promises[r.promiseId]}},eB=function(){return{points:this.points,duration:this.duration,blockDuration:this.blockDuration,execEvenly:this.execEvenly,execEvenlyMinDelayMs:this.execEvenlyMinDelayMs,keyPrefix:this.keyPrefix}},cc=function(r,e){const t=Is.hrtime();let n=t[0].toString()+t[1].toString();return typeof this._promises[n]<"u"&&(n+=YU.randomBytes(12).toString("base64")),this._promises[n]={resolve:r,reject:e,timeoutId:setTimeout(()=>{delete this._promises[n],e(new Error("RateLimiterCluster timeout: no answer from master in time"))},this.timeoutMs)},n};let tB=class{constructor(){if(Vc)return Vc;this._rateLimiters={},t7.setMaxListeners(0),t7.on("message",(e,t)=>{t&&t.channel===Gn&&t.type==="init"?(typeof this._rateLimiters[t.opts.keyPrefix]>"u"&&(this._rateLimiters[t.opts.keyPrefix]=new MT(t.opts)),e.send({channel:Gn,type:"init",keyPrefix:t.opts.keyPrefix})):BT.call(this,e,t)}),Vc=this}},rB=class{constructor(e){if(Vc)return Vc;this._rateLimiters={},e.launchBus((t,n)=>{n.on("process:msg",s=>{const i=s.raw;if(i&&i.channel===Gn&&i.type==="init")typeof this._rateLimiters[i.opts.keyPrefix]>"u"&&(this._rateLimiters[i.opts.keyPrefix]=new MT(i.opts)),e.sendDataToProcessId(s.process.pm_id,{data:{},topic:Gn,channel:Gn,type:"init",keyPrefix:i.opts.keyPrefix},(o,a)=>{o&&console.log(o,a)});else{const o={send:a=>{const c=a;c.topic=Gn,typeof c.data>"u"&&(c.data={}),e.sendDataToProcessId(s.process.pm_id,c,(u,l)=>{u&&console.log(u,l)})}};BT.call(this,o,i)}})}),Vc=this}};class nB extends XU{get timeoutMs(){return this._timeoutMs}set timeoutMs(e){this._timeoutMs=typeof e>"u"?5e3:Math.abs(parseInt(e))}constructor(e={}){super(e),Is.setMaxListeners(0),this.timeoutMs=e.timeoutMs,this._initiated=!1,Is.on("message",t=>{t&&t.channel===Gn&&t.type==="init"&&t.keyPrefix===this.keyPrefix?this._initiated=!0:ZU.call(this,t)}),Is.send({channel:Gn,type:"init",opts:eB.call(this)}),this._promises={}}consume(e,t=1,n={}){return new Promise((s,i)=>{const o=cc.call(this,s,i);ac.call(this,"consume",o,e,t,n)})}penalty(e,t=1,n={}){return new Promise((s,i)=>{const o=cc.call(this,s,i);ac.call(this,"penalty",o,e,t,n)})}reward(e,t=1,n={}){return new Promise((s,i)=>{const o=cc.call(this,s,i);ac.call(this,"reward",o,e,t,n)})}block(e,t,n={}){return new Promise((s,i)=>{const o=cc.call(this,s,i);ac.call(this,"block",o,e,t,n)})}get(e,t={}){return new Promise((n,s)=>{const i=cc.call(this,n,s);ac.call(this,"get",i,e,t)})}delete(e,t={}){return new Promise((n,s)=>{const i=cc.call(this,n,s);ac.call(this,"delete",i,e,t)})}}var sB={RateLimiterClusterMaster:tB,RateLimiterClusterMasterPM2:rB,RateLimiterCluster:nB};const iB=ch,oB=Jn;let aB=class extends iB{constructor(e){super(e),this.client=e.storeClient}_getRateLimiterRes(e,t,n){const s=new oB;return s.consumedPoints=parseInt(n.consumedPoints),s.isFirstInDuration=n.consumedPoints===t,s.remainingPoints=Math.max(this.points-s.consumedPoints,0),s.msBeforeNext=n.msBeforeNext,s}_upsert(e,t,n,s=!1,i={}){return new Promise((o,a)=>{const c=Date.now(),u=Math.floor(n/1e3);s?this.client.set(e,t,u,l=>{l?a(l):this.client.set(`${e}_expire`,u>0?c+u*1e3:-1,u,()=>{const d={consumedPoints:t,msBeforeNext:u>0?u*1e3:-1};o(d)})}):this.client.incr(e,t,(l,d)=>{l||d===!1?this.client.add(e,t,u,(f,g)=>{if(f||!g)if(typeof i.attemptNumber>"u"||i.attemptNumber<3){const h=Object.assign({},i);h.attemptNumber=h.attemptNumber?h.attemptNumber+1:1,this._upsert(e,t,n,s,h).then(p=>o(p)).catch(p=>a(p))}else a(new Error("Can not add key"));else this.client.add(`${e}_expire`,u>0?c+u*1e3:-1,u,()=>{const h={consumedPoints:t,msBeforeNext:u>0?u*1e3:-1};o(h)})}):this.client.get(`${e}_expire`,(f,g)=>{if(f)a(f);else{const h=g===!1?0:g,p={consumedPoints:d,msBeforeNext:h>=0?Math.max(h-c,0):-1};o(p)}})})})}_get(e){return new Promise((t,n)=>{const s=Date.now();this.client.get(e,(i,o)=>{o?this.client.get(`${e}_expire`,(a,c)=>{if(a)n(a);else{const u=c===!1?0:c,l={consumedPoints:o,msBeforeNext:u>=0?Math.max(u-s,0):-1};t(l)}}):t(null)})})}_delete(e){return new Promise((t,n)=>{this.client.del(e,(s,i)=>{s?n(s):i===!1?t(i):this.client.del(`${e}_expire`,o=>{o?n(o):t(i)})})})}};var cB=aB;const n7=Jn;var lB=class{constructor(e={}){this.limiter=e.limiter,this.blackList=e.blackList,this.whiteList=e.whiteList,this.isBlackListed=e.isBlackListed,this.isWhiteListed=e.isWhiteListed,this.runActionAnyway=e.runActionAnyway}get limiter(){return this._limiter}set limiter(e){if(typeof e>"u")throw new Error("limiter is not set");this._limiter=e}get runActionAnyway(){return this._runActionAnyway}set runActionAnyway(e){this._runActionAnyway=typeof e>"u"?!1:e}get blackList(){return this._blackList}set blackList(e){this._blackList=Array.isArray(e)?e:[]}get isBlackListed(){return this._isBlackListed}set isBlackListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isBlackListed must be function");this._isBlackListed=e}get whiteList(){return this._whiteList}set whiteList(e){this._whiteList=Array.isArray(e)?e:[]}get isWhiteListed(){return this._isWhiteListed}set isWhiteListed(e){if(typeof e>"u"&&(e=()=>!1),typeof e!="function")throw new Error("isWhiteListed must be function");this._isWhiteListed=e}isBlackListedSomewhere(e){return this.blackList.indexOf(e)>=0||this.isBlackListed(e)}isWhiteListedSomewhere(e){return this.whiteList.indexOf(e)>=0||this.isWhiteListed(e)}getBlackRes(){return new n7(0,Number.MAX_SAFE_INTEGER,0,!1)}getWhiteRes(){return new n7(Number.MAX_SAFE_INTEGER,0,0,!1)}rejectBlack(){return Promise.reject(this.getBlackRes())}resolveBlack(){return Promise.resolve(this.getBlackRes())}resolveWhite(){return Promise.resolve(this.getWhiteRes())}consume(e,t=1){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.rejectBlack()),typeof n>"u"?this.limiter.consume(e,t):(this.runActionAnyway&&this.limiter.consume(e,t).catch(()=>{}),n)}block(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.block(e,t):(this.runActionAnyway&&this.limiter.block(e,t).catch(()=>{}),n)}penalty(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.penalty(e,t):(this.runActionAnyway&&this.limiter.penalty(e,t).catch(()=>{}),n)}reward(e,t){let n;return this.isWhiteListedSomewhere(e)?n=this.resolveWhite():this.isBlackListedSomewhere(e)&&(n=this.resolveBlack()),typeof n>"u"?this.limiter.reward(e,t):(this.runActionAnyway&&this.limiter.reward(e,t).catch(()=>{}),n)}get(e){let t;return this.isWhiteListedSomewhere(e)?t=this.resolveWhite():this.isBlackListedSomewhere(e)&&(t=this.resolveBlack()),typeof t>"u"||this.runActionAnyway?this.limiter.get(e):t}delete(e){return this.limiter.delete(e)}};const uB=Z0;var dB=class{constructor(...e){if(e.length<1)throw new Error("RateLimiterUnion: at least one limiter have to be passed");e.forEach(t=>{if(!(t instanceof uB))throw new Error("RateLimiterUnion: all limiters have to be instance of RateLimiterAbstract")}),this._limiters=e}consume(e,t=1){return new Promise((n,s)=>{const i=[];this._limiters.forEach(o=>{i.push(o.consume(e,t).catch(a=>({rejected:!0,rej:a})))}),Promise.all(i).then(o=>{const a={};let c=!1;o.forEach(u=>{u.rejected===!0&&(c=!0)});for(let u=0;u<o.length;u++)c&&o[u].rejected===!0?a[this._limiters[u].keyPrefix]=o[u].rej:c||(a[this._limiters[u].keyPrefix]=o[u]);c?s(a):n(a)})})}},hB=class extends Error{constructor(e,t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="CustomError",this.message=e,t&&(this.extra=t)}};const s7=hB,zT=4294967295,Aw="limiter";var fB=class{constructor(e,t={maxQueueSize:zT}){this._queueLimiters={KEY_DEFAULT:new i7(e,t)},this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(e=Aw){return this._queueLimiters[e]?this._queueLimiters[e].getTokensRemaining():Promise.resolve(this._limiterFlexible.points)}removeTokens(e,t=Aw){return this._queueLimiters[t]||(this._queueLimiters[t]=new i7(this._limiterFlexible,{key:t,maxQueueSize:this._maxQueueSize})),this._queueLimiters[t].removeTokens(e)}};class i7{constructor(e,t={maxQueueSize:zT,key:Aw}){this._key=t.key,this._waitTimeout=null,this._queue=[],this._limiterFlexible=e,this._maxQueueSize=t.maxQueueSize}getTokensRemaining(){return this._limiterFlexible.get(this._key).then(e=>e!==null?e.remainingPoints:this._limiterFlexible.points)}removeTokens(e){const t=this;return new Promise((n,s)=>{if(e>t._limiterFlexible.points){s(new s7(`Requested tokens ${e} exceeds maximum ${t._limiterFlexible.points} tokens per interval`));return}t._queue.length>0?t._queueRequest.call(t,n,s,e):t._limiterFlexible.consume(t._key,e).then(i=>{n(i.remainingPoints)}).catch(i=>{i instanceof Error?s(i):(t._queueRequest.call(t,n,s,e),t._waitTimeout===null&&(t._waitTimeout=setTimeout(t._processFIFO.bind(t),i.msBeforeNext)))})})}_queueRequest(e,t,n){const s=this;s._queue.length<s._maxQueueSize?s._queue.push({resolve:e,reject:t,tokens:n}):t(new s7(`Number of requests reached it's maximum ${s._maxQueueSize}`))}_processFIFO(){const e=this;if(e._waitTimeout!==null&&(clearTimeout(e._waitTimeout),e._waitTimeout=null),e._queue.length===0)return;const t=e._queue.shift();e._limiterFlexible.consume(e._key,t.tokens).then(n=>{t.resolve(n.remainingPoints),e._processFIFO.call(e)}).catch(n=>{n instanceof Error?(t.reject(n),e._processFIFO.call(e)):(e._queue.unshift(t),e._waitTimeout===null&&(e._waitTimeout=setTimeout(e._processFIFO.bind(e),n.msBeforeNext)))})}}const Dg=Jn;var pB=class{constructor(e,t){this._rateLimiter=e,this._burstLimiter=t}_combineRes(e,t){return e?new Dg(e.remainingPoints,Math.min(e.msBeforeNext,t?t.msBeforeNext:0),e.consumedPoints,e.isFirstInDuration):null}consume(e,t=1,n={}){return this._rateLimiter.consume(e,t,n).catch(s=>s instanceof Dg?this._burstLimiter.consume(e,t,n).then(i=>Promise.resolve(this._combineRes(s,i))).catch(i=>i instanceof Dg?Promise.reject(this._combineRes(s,i)):Promise.reject(i)):Promise.reject(s))}get(e){return Promise.all([this._rateLimiter.get(e),this._burstLimiter.get(e)]).then(([t,n])=>this._combineRes(t,n))}get points(){return this._rateLimiter.points}};const gB=DU,yB=NU,wB=BU,bB=jU,{RateLimiterClusterMaster:mB,RateLimiterClusterMasterPM2:EB,RateLimiterCluster:vB}=sB,_B=LT,SB=cB,AB=lB,$B=dB,RB=fB,TB=pB,IB=Jn;var nm={RateLimiterRedis:gB,RateLimiterMongo:yB,RateLimiterMySQL:wB,RateLimiterPostgres:bB,RateLimiterMemory:_B,RateLimiterMemcache:SB,RateLimiterClusterMaster:mB,RateLimiterClusterMasterPM2:EB,RateLimiterCluster:vB,RLWrapperBlackAndWhite:AB,RateLimiterUnion:$B,RateLimiterQueue:RB,BurstyRateLimiter:TB,RateLimiterRes:IB};const FT=Symbol.for("@achingbrain/uint8arraylist");function o7(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const s=t+n.byteLength;if(e<s)return{buf:n,index:e-t};t=s}throw new RangeError("index is out of bounds")}function ha(r){return!!r?.[FT]}class ue{constructor(...e){Object.defineProperty(this,FT,{value:!0}),this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(ha(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(ha(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=o7(this.bufs,e);return t.buf[t.index]}set(e,t){const n=o7(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(ha(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:s}=this._subList(e,t);return M(n,s)}subarray(e,t){const{bufs:n,length:s}=this._subList(e,t);return n.length===1?n[0]:M(n,s)}sublist(e,t){const{bufs:n,length:s}=this._subList(e,t),i=new ue;return i.length=s,i.bufs=n,i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:[...this.bufs],length:this.length};const n=[];let s=0;for(let i=0;i<this.bufs.length;i++){const o=this.bufs[i],a=s,c=a+o.byteLength;if(s=c,e>=c)continue;const u=e>=a&&e<c,l=t>a&&t<=c;if(u&&l){if(e===a&&t===c){n.push(o);break}const d=e-a;n.push(o.subarray(d,d+(t-e)));break}if(u){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(l){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!ha(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const s=n.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,o=new Int32Array(i);for(let d=0;d<i;d++)o[d]=-1;for(let d=0;d<s;d++)o[n[d]]=d;const a=o,c=this.byteLength-n.byteLength,u=n.byteLength-1;let l;for(let d=t;d<=c;d+=l){l=0;for(let f=u;f>=0;f--){const g=this.get(d+f);if(n[f]!==g){l=Math.max(1,f-a[g]);break}}if(l===0)return d}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=Ys(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const s=Gi(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,n),this.write(s,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const s=Gi(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,n),this.write(s,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const s=Gi(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,n),this.write(s,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=Ys(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const s=Gi(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,n),this.write(s,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const s=Gi(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,n),this.write(s,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const s=Gi(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,n),this.write(s,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const s=Gi(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,n),this.write(s,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const s=Gi(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,n),this.write(s,e)}equals(e){if(e==null||!(e instanceof ue)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!me(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new ue;return n.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),n.length=t,n}}var Te;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(Te||(Te={}));const sm=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),a7=Object.freeze({NEW_STREAM:Te.NEW_STREAM,MESSAGE:Te.MESSAGE_INITIATOR,CLOSE:Te.CLOSE_INITIATOR,RESET:Te.RESET_INITIATOR}),CB=Object.freeze({MESSAGE:Te.MESSAGE_RECEIVER,CLOSE:Te.CLOSE_RECEIVER,RESET:Te.RESET_RECEIVER}),VT=1<<20,xB=4<<20;let DB=class{constructor(e=VT,t=xB){k(this,"_buffer");k(this,"_headerInfo");k(this,"_maxMessageSize");k(this,"_maxUnprocessedMessageQueueSize");this._buffer=new ue,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(u){if(u.code==="ERR_MSG_TOO_BIG")throw u;break}const{id:n,type:s,length:i,offset:o}=this._headerInfo;if(this._buffer.length-o<i)break;const c={id:n,type:s};(s===Te.NEW_STREAM||s===Te.MESSAGE_INITIATOR||s===Te.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+i)),t.push(c),this._buffer.consume(o+i),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=l7(e),{value:s,offset:i}=l7(e,n),o=t&7;if(sm[o]==null)throw new Error(`Invalid type received: ${o}`);if(s>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:o,offset:n+i,length:s}}};const OB=128,c7=127;function l7(r,e=0){let t=0,n=0,s=e,i;const o=r.length;do{if(s>=o||n>49)throw e=0,new RangeError("Could not decode varint");i=r.get(s++),t+=n<28?(i&c7)<<n:(i&c7)*Math.pow(2,n),n+=7}while(i>=OB);return e=s-e,{value:t,offset:e}}function PB(r){return r[Symbol.asyncIterator]!=null}const rf=1024*1024,u7=(r,e)=>{e.append(r)};function kB(r,e){return PB(r)?async function*(){let t=new ue,n=!1,s=Pe(),i=Number(e?.size??rf);if((isNaN(i)||i===0||i<0)&&(i=rf),i!==Math.round(i))throw new Error("Batch size must be an integer");const o=e?.yieldAfter??0,a=e?.serialize??u7;for(Promise.resolve().then(async()=>{try{let c;for await(const u of r){if(a(u,t),t.byteLength>=i){clearTimeout(c),s.resolve();continue}c=setTimeout(()=>{s.resolve()},o)}clearTimeout(c),s.resolve()}catch(c){s.reject(c)}finally{n=!0}});!n;)if(await s.promise,s=Pe(),t.byteLength>0){const c=t;t=new ue,yield c.subarray()}}():function*(){const t=new ue;let n=Number(e?.size??rf);if((isNaN(n)||n===0||n<0)&&(n=rf),n!==Math.round(n))throw new Error("Batch size must be an integer");const s=e?.serialize??u7;for(const i of r)s(i,t),t.byteLength>=n&&(yield t.subarray(0,n),t.consume(n));t.byteLength>0&&(yield t.subarray())}()}var NB=$w,d7=128,LB=127,MB=~LB,UB=Math.pow(2,31);function $w(r,e,t){if(Number.MAX_SAFE_INTEGER&&r>Number.MAX_SAFE_INTEGER)throw $w.bytes=0,new RangeError("Could not encode varint");e=e||[],t=t||0;for(var n=t;r>=UB;)e[t++]=r&255|d7,r/=128;for(;r&MB;)e[t++]=r&255|d7,r>>>=7;return e[t]=r|0,$w.bytes=t-n+1,e}var BB=Rw,zB=128,h7=127;function Rw(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a||s>49)throw Rw.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&h7)<<s:(o&h7)*Math.pow(2,s),s+=7}while(o>=zB);return Rw.bytes=i-n,t}var FB=Math.pow(2,7),VB=Math.pow(2,14),jB=Math.pow(2,21),qB=Math.pow(2,28),KB=Math.pow(2,35),GB=Math.pow(2,42),HB=Math.pow(2,49),WB=Math.pow(2,56),QB=Math.pow(2,63),YB=function(r){return r<FB?1:r<VB?2:r<jB?3:r<qB?4:r<KB?5:r<GB?6:r<HB?7:r<WB?8:r<QB?9:10},jT={encode:NB,decode:BB,encodingLength:YB};const D=Ge(jT);function f7(r){return new Uint8Array(r)}const Og=10*1024;let XB=class{constructor(){k(this,"_pool");k(this,"_poolOffset");this._pool=f7(Og),this._poolOffset=0}write(e,t){const n=this._pool;let s=this._poolOffset;D.encode(e.id<<3|e.type,n,s),s+=D.encode.bytes??0,(e.type===Te.NEW_STREAM||e.type===Te.MESSAGE_INITIATOR||e.type===Te.MESSAGE_RECEIVER)&&e.data!=null?D.encode(e.data.length,n,s):D.encode(0,n,s),s+=D.encode.bytes??0;const i=n.subarray(this._poolOffset,s);Og-s<100?(this._pool=f7(Og),this._poolOffset=0):this._poolOffset=s,t.append(i),(e.type===Te.NEW_STREAM||e.type===Te.MESSAGE_INITIATOR||e.type===Te.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}};const p7=new XB;async function*JB(r,e=0){if(e==null||e===0){for await(const t of r){const n=new ue;for(const s of t)p7.write(s,n);yield n.subarray()}return}yield*kB(r,{size:e,serialize:(t,n)=>{for(const s of t)p7.write(s,n)}})}const ln=N("libp2p:stream"),Pg="ERR_STREAM_RESET",ZB="ERR_STREAM_ABORT",ez="ERR_SINK_ENDED",tz="ERR_DOUBLE_SINK";function Qo(r){return r!=null&&typeof r.then=="function"}class rz{constructor(e){k(this,"id");k(this,"stat");k(this,"metadata");k(this,"source");k(this,"abortController");k(this,"resetController");k(this,"closeController");k(this,"sourceEnded");k(this,"sinkEnded");k(this,"sinkSunk");k(this,"endErr");k(this,"streamSource");k(this,"onEnd");k(this,"maxDataSize");this.abortController=new AbortController,this.resetController=new AbortController,this.closeController=new AbortController,this.sourceEnded=!1,this.sinkEnded=!1,this.sinkSunk=!1,this.id=e.id,this.metadata=e.metadata??{},this.stat={direction:e.direction,timeline:{open:Date.now()}},this.maxDataSize=e.maxDataSize,this.onEnd=e.onEnd,this.source=this.streamSource=Mt({onEnd:()=>{if(this.stat.timeline.reset!==null){const t=this.sendCloseRead();Qo(t)&&t.catch(n=>{ln.error("error while sending close read",n)})}this.onSourceEnd()}}),this.sink=this.sink.bind(this)}onSourceEnd(e){this.sourceEnded||(this.stat.timeline.closeRead=Date.now(),this.sourceEnded=!0,ln.trace("%s stream %s source end - err: %o",this.stat.direction,this.id,e),e!=null&&this.endErr==null&&(this.endErr=e),this.sinkEnded&&(this.stat.timeline.close=Date.now(),this.onEnd!=null&&this.onEnd(this.endErr)))}onSinkEnd(e){this.sinkEnded||(this.stat.timeline.closeWrite=Date.now(),this.sinkEnded=!0,ln.trace("%s stream %s sink end - err: %o",this.stat.direction,this.id,e),e!=null&&this.endErr==null&&(this.endErr=e),this.sourceEnded&&(this.stat.timeline.close=Date.now(),this.onEnd!=null&&this.onEnd(this.endErr)))}close(){ln.trace("%s stream %s close",this.stat.direction,this.id),this.closeRead(),this.closeWrite()}closeRead(){ln.trace("%s stream %s closeRead",this.stat.direction,this.id),!this.sourceEnded&&this.streamSource.end()}closeWrite(){if(ln.trace("%s stream %s closeWrite",this.stat.direction,this.id),!this.sinkEnded){this.closeController.abort();try{const e=this.sendCloseWrite();Qo(e)&&e.catch(t=>{ln.error("error while sending close write",t)})}catch(e){ln.trace("%s stream %s error sending close",this.stat.direction,this.id,e)}this.onSinkEnd()}}abort(e){ln.trace("%s stream %s abort",this.stat.direction,this.id,e),this.streamSource.end(e),this.abortController.abort(),this.onSinkEnd(e)}reset(){const e=new B("stream reset",Pg);this.resetController.abort(),this.streamSource.end(e),this.onSinkEnd(e)}async sink(e){if(this.sinkSunk)throw new B("sink already called on stream",tz);if(this.sinkSunk=!0,this.sinkEnded)throw new B("stream closed for writing",ez);const t=OT([this.abortController.signal,this.resetController.signal,this.closeController.signal]);try{if(e=Td(e,t),this.stat.direction==="outbound"){const n=this.sendNewStream();Qo(n)&&await n}for await(let n of e)for(;n.length>0;){if(n.length<=this.maxDataSize){const i=this.sendData(n instanceof Uint8Array?new ue(n):n);Qo(i)&&await i;break}n=n instanceof Uint8Array?new ue(n):n;const s=this.sendData(n.sublist(0,this.maxDataSize));Qo(s)&&await s,n.consume(this.maxDataSize)}}catch(n){if(n.type==="aborted"&&n.message==="The operation was aborted"){if(this.closeController.signal.aborted)return;this.resetController.signal.aborted&&(n.message="stream reset",n.code=Pg),this.abortController.signal.aborted&&(n.message="stream aborted",n.code=ZB)}if(n.code===Pg)ln.trace("%s stream %s reset",this.stat.direction,this.id);else{ln.trace("%s stream %s error",this.stat.direction,this.id,n);try{const s=this.sendReset();Qo(s)&&await s,this.stat.timeline.reset=Date.now()}catch(s){ln.trace("%s stream %s error sending reset",this.stat.direction,this.id,s)}}throw this.streamSource.end(n),this.onSinkEnd(n),n}finally{t.clear()}try{const n=this.sendCloseWrite();Qo(n)&&await n}catch(n){ln.trace("%s stream %s error sending close",this.stat.direction,this.id,n)}this.onSinkEnd()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}class nz extends rz{constructor(t){super(t);k(this,"name");k(this,"streamId");k(this,"send");k(this,"types");this.types=t.direction==="outbound"?a7:CB,this.send=t.send,this.name=t.name,this.streamId=t.streamId}sendNewStream(){this.send({id:this.streamId,type:a7.NEW_STREAM,data:new ue(L(this.name))})}sendData(t){this.send({id:this.streamId,type:this.types.MESSAGE,data:t})}sendReset(){this.send({id:this.streamId,type:this.types.RESET})}sendCloseWrite(){this.send({id:this.streamId,type:this.types.CLOSE})}sendCloseRead(){}}function sz(r){const{id:e,name:t,send:n,onEnd:s,type:i="initiator",maxMsgSize:o=VT}=r;return new nz({id:i==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:i==="initiator"?"outbound":"inbound",maxDataSize:o,onEnd:s,send:n})}const ns=N("libp2p:mplex"),iz=1024,oz=1024,az=1024*1024*4,cz=5;function g7(r){const e={...r,type:`${sm[r.type]} (${r.type})`};return r.type===Te.NEW_STREAM&&(e.data=C(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===Te.MESSAGE_INITIATOR||r.type===Te.MESSAGE_RECEIVER)&&(e.data=C(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}let lz=class{constructor(e){k(this,"protocol","/mplex/6.7.0");k(this,"sink");k(this,"source");k(this,"_streamId");k(this,"_streams");k(this,"_init");k(this,"_source");k(this,"closeController");k(this,"rateLimiter");e=e??{},this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=e,this.sink=this._createSink();const t=this._createSource();this._source=t,this.source=t,this.closeController=new AbortController,this.rateLimiter=new nm.RateLimiterMemory({points:e.disconnectThreshold??cz,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}close(e){this.closeController.signal.aborted||(e!=null?this.streams.forEach(t=>{t.abort(e)}):this.streams.forEach(t=>{t.close()}),this.closeController.abort())}_newReceiverStream(e){const{id:t,name:n}=e,s=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:s})}_newStream(e){const{id:t,name:n,type:s,registry:i}=e;if(ns("new %s stream %s",s,t),s==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??oz))throw new B("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(i.has(t))throw new Error(`${s} stream ${t} already exists!`);const c=sz({id:t,name:n,send:u=>{ns.enabled&&ns.trace("%s stream %s send",s,t,g7(u)),this._source.push(u)},type:s,onEnd:()=>{ns("%s stream with id %s and protocol %s ended",s,t,c.stat.protocol),i.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize});return i.set(t,c),c}_createSink(){return async t=>{const n=OT([this.closeController.signal,this._init.signal]);try{t=Td(t,n);const s=new DB(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const i of t)for(const o of s.write(i))await this._handleIncoming(o);this._source.end()}catch(s){ns("error in sink",s),this._source.end(s)}finally{n.clear()}}}_createSource(){const t=PT({objectMode:!0,onEnd:n=>{this.close(n)}});return Object.assign(JB(t,this._init.minSendBytes),{push:t.push,end:t.end,return:t.return})}async _handleIncoming(e){const{id:t,type:n}=e;if(ns.enabled&&ns.trace("incoming message",g7(e)),e.type===Te.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??iz)){ns("too many inbound streams open"),this._source.push({id:t,type:Te.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{ns("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this._source.end(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:C(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const i=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(i==null){ns("missing stream %s for message type %s",t,sm[n]);return}const o=this._init.maxStreamBufferSize??az;switch(n){case Te.MESSAGE_INITIATOR:case Te.MESSAGE_RECEIVER:if(i.sourceReadableLength()>o){this._source.push({id:e.id,type:n===Te.MESSAGE_INITIATOR?Te.RESET_RECEIVER:Te.RESET_INITIATOR});const a=new B("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");i.abort(a);return}i.sourcePush(e.data);break;case Te.CLOSE_INITIATOR:case Te.CLOSE_RECEIVER:i.closeRead();break;case Te.RESET_INITIATOR:case Te.RESET_RECEIVER:i.reset();break;default:ns("unknown message type %s",n)}}},uz=class{constructor(e={}){k(this,"protocol","/mplex/6.7.0");k(this,"_init");this._init=e}createStreamMuxer(e={}){return new lz({...e,...this._init})}};function dz(r={}){return()=>new uz(r)}var hz=r=>{if(Object.prototype.toString.call(r)!=="[object Object]")return!1;const e=Object.getPrototypeOf(r);return e===null||e===Object.prototype};const _p=hz,{hasOwnProperty:qT}=Object.prototype,{propertyIsEnumerable:fz}=Object,el=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0}),pz=fn,y7={concatArrays:!1,ignoreUndefined:!1},e2=r=>{const e=[];for(const t in r)qT.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(r);for(const n of t)fz.call(r,n)&&e.push(n)}return e};function Sl(r){return Array.isArray(r)?gz(r):_p(r)?yz(r):r}function gz(r){const e=r.slice(0,0);return e2(r).forEach(t=>{el(e,t,Sl(r[t]))}),e}function yz(r){const e=Object.getPrototypeOf(r)===null?Object.create(null):{};return e2(r).forEach(t=>{el(e,t,Sl(r[t]))}),e}const KT=(r,e,t,n)=>(t.forEach(s=>{typeof e[s]>"u"&&n.ignoreUndefined||(s in r&&r[s]!==Object.getPrototypeOf(r)?el(r,s,Tw(r[s],e[s],n)):el(r,s,Sl(e[s])))}),r),wz=(r,e,t)=>{let n=r.slice(0,0),s=0;return[r,e].forEach(i=>{const o=[];for(let a=0;a<i.length;a++)qT.call(i,a)&&(o.push(String(a)),i===r?el(n,s++,i[a]):el(n,s++,Sl(i[a])));n=KT(n,i,e2(i).filter(a=>!o.includes(a)),t)}),n};function Tw(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?wz(r,e,t):!_p(e)||!_p(r)?Sl(e):KT(r,e,e2(e),t)}var bz=function(...r){const e=Tw(Sl(y7),this!==pz&&this||{},y7);let t={_:{}};for(const n of r)if(n!==void 0){if(!_p(n))throw new TypeError("`"+n+"` is not an Option Object");t=Tw(t,{_:n},e)}return t._};const et=Ge(bz),mz=Object.freeze(Object.defineProperty({__proto__:null,default:et},Symbol.toStringTag,{value:"Module"})),Ez=qM,t2=typeof window=="object"&&typeof document=="object"&&document.nodeType===9,lh=Ez(),vz=t2&&!lh,_z=lh&&!t2,Sz=lh&&t2,Az=typeof wT=="function"&&typeof Is<"u"&&typeof Is.release<"u"&&Is.release.name==="node"&&!lh,$z=typeof importScripts=="function"&&typeof self<"u"&&typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope,Rz=typeof Is<"u"&&typeof Is.env<"u"&&!1,Tz=typeof navigator<"u"&&navigator.product==="ReactNative";var Pi={isTest:Rz,isElectron:lh,isElectronMain:_z,isElectronRenderer:Sz,isNode:Az,isBrowser:vz,isWebWorker:$z,isEnvWithDom:t2,isReactNative:Tz};function w7(r,e){for(const t in e)Object.defineProperty(r,t,{value:e[t],enumerable:!0,configurable:!0});return r}function Iz(r,e,t){if(!r||typeof r=="string")throw new TypeError("Please pass an Error to err-code");t||(t={}),typeof e=="object"&&(t=e,e=""),e&&(t.code=e);try{return w7(r,t)}catch{t.message=r.message,t.stack=r.stack;const s=function(){};return s.prototype=Object.create(Object.getPrototypeOf(r)),w7(new s,t)}}var Cz=Iz;const $=Ge(Cz);var GT={},HT={},xz=Id,im=bT();(Id.prototype=Object.create(im.EventEmitter.prototype)).constructor=Id;function Id(r,e,t){if(typeof r!="function")throw TypeError("rpcImpl must be a function");im.EventEmitter.call(this),this.rpcImpl=r,this.requestDelimited=!!e,this.responseDelimited=!!t}Id.prototype.rpcCall=function r(e,t,n,s,i){if(!s)throw TypeError("request must be specified");var o=this;if(!i)return im.asPromise(r,o,e,t,n,s);if(!o.rpcImpl){setTimeout(function(){i(Error("already ended"))},0);return}try{return o.rpcImpl(e,t[o.requestDelimited?"encodeDelimited":"encode"](s).finish(),function(c,u){if(c)return o.emit("error",c,e),i(c);if(u===null){o.end(!0);return}if(!(u instanceof n))try{u=n[o.responseDelimited?"decodeDelimited":"decode"](u)}catch(l){return o.emit("error",l,e),i(l)}return o.emit("data",u,e),i(null,u)})}catch(a){o.emit("error",a,e),setTimeout(function(){i(a)},0);return}};Id.prototype.end=function(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};(function(r){var e=r;e.Service=xz})(HT);var Dz={};(function(r){var e=r;e.build="minimal",e.Writer=KM,e.BufferWriter=GM,e.Reader=HM,e.BufferReader=WM,e.util=bT(),e.rpc=HT,e.roots=Dz,e.configure=t;function t(){e.util._configure(),e.Writer._configure(e.BufferWriter),e.Reader._configure(e.BufferReader)}t()})(GT);var Oz=GT;const X=Ge(Oz),tl=X.Reader,om=X.Writer,re=X.util,Kt=X.roots["ipfs-unixfs"]||(X.roots["ipfs-unixfs"]={}),Pz=Kt.Data=(()=>{function r(e){if(this.blocksizes=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.Type=0,r.prototype.Data=re.newBuffer([]),r.prototype.filesize=re.Long?re.Long.fromBits(0,0,!0):0,r.prototype.blocksizes=re.emptyArray,r.prototype.hashType=re.Long?re.Long.fromBits(0,0,!0):0,r.prototype.fanout=re.Long?re.Long.fromBits(0,0,!0):0,r.prototype.mode=0,r.prototype.mtime=null,r.encode=function(t,n){if(n||(n=om.create()),n.uint32(8).int32(t.Type),t.Data!=null&&Object.hasOwnProperty.call(t,"Data")&&n.uint32(18).bytes(t.Data),t.filesize!=null&&Object.hasOwnProperty.call(t,"filesize")&&n.uint32(24).uint64(t.filesize),t.blocksizes!=null&&t.blocksizes.length)for(var s=0;s<t.blocksizes.length;++s)n.uint32(32).uint64(t.blocksizes[s]);return t.hashType!=null&&Object.hasOwnProperty.call(t,"hashType")&&n.uint32(40).uint64(t.hashType),t.fanout!=null&&Object.hasOwnProperty.call(t,"fanout")&&n.uint32(48).uint64(t.fanout),t.mode!=null&&Object.hasOwnProperty.call(t,"mode")&&n.uint32(56).uint32(t.mode),t.mtime!=null&&Object.hasOwnProperty.call(t,"mtime")&&Kt.UnixTime.encode(t.mtime,n.uint32(66).fork()).ldelim(),n},r.decode=function(t,n){t instanceof tl||(t=tl.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new Kt.Data;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.Type=t.int32();break;case 2:i.Data=t.bytes();break;case 3:i.filesize=t.uint64();break;case 4:if(i.blocksizes&&i.blocksizes.length||(i.blocksizes=[]),(o&7)===2)for(var a=t.uint32()+t.pos;t.pos<a;)i.blocksizes.push(t.uint64());else i.blocksizes.push(t.uint64());break;case 5:i.hashType=t.uint64();break;case 6:i.fanout=t.uint64();break;case 7:i.mode=t.uint32();break;case 8:i.mtime=Kt.UnixTime.decode(t,t.uint32());break;default:t.skipType(o&7);break}}if(!i.hasOwnProperty("Type"))throw re.ProtocolError("missing required 'Type'",{instance:i});return i},r.fromObject=function(t){if(t instanceof Kt.Data)return t;var n=new Kt.Data;switch(t.Type){case"Raw":case 0:n.Type=0;break;case"Directory":case 1:n.Type=1;break;case"File":case 2:n.Type=2;break;case"Metadata":case 3:n.Type=3;break;case"Symlink":case 4:n.Type=4;break;case"HAMTShard":case 5:n.Type=5;break}if(t.Data!=null&&(typeof t.Data=="string"?re.base64.decode(t.Data,n.Data=re.newBuffer(re.base64.length(t.Data)),0):t.Data.length&&(n.Data=t.Data)),t.filesize!=null&&(re.Long?(n.filesize=re.Long.fromValue(t.filesize)).unsigned=!0:typeof t.filesize=="string"?n.filesize=parseInt(t.filesize,10):typeof t.filesize=="number"?n.filesize=t.filesize:typeof t.filesize=="object"&&(n.filesize=new re.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0))),t.blocksizes){if(!Array.isArray(t.blocksizes))throw TypeError(".Data.blocksizes: array expected");n.blocksizes=[];for(var s=0;s<t.blocksizes.length;++s)re.Long?(n.blocksizes[s]=re.Long.fromValue(t.blocksizes[s])).unsigned=!0:typeof t.blocksizes[s]=="string"?n.blocksizes[s]=parseInt(t.blocksizes[s],10):typeof t.blocksizes[s]=="number"?n.blocksizes[s]=t.blocksizes[s]:typeof t.blocksizes[s]=="object"&&(n.blocksizes[s]=new re.LongBits(t.blocksizes[s].low>>>0,t.blocksizes[s].high>>>0).toNumber(!0))}if(t.hashType!=null&&(re.Long?(n.hashType=re.Long.fromValue(t.hashType)).unsigned=!0:typeof t.hashType=="string"?n.hashType=parseInt(t.hashType,10):typeof t.hashType=="number"?n.hashType=t.hashType:typeof t.hashType=="object"&&(n.hashType=new re.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0))),t.fanout!=null&&(re.Long?(n.fanout=re.Long.fromValue(t.fanout)).unsigned=!0:typeof t.fanout=="string"?n.fanout=parseInt(t.fanout,10):typeof t.fanout=="number"?n.fanout=t.fanout:typeof t.fanout=="object"&&(n.fanout=new re.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0))),t.mode!=null&&(n.mode=t.mode>>>0),t.mtime!=null){if(typeof t.mtime!="object")throw TypeError(".Data.mtime: object expected");n.mtime=Kt.UnixTime.fromObject(t.mtime)}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.blocksizes=[]),n.defaults){if(s.Type=n.enums===String?"Raw":0,n.bytes===String?s.Data="":(s.Data=[],n.bytes!==Array&&(s.Data=re.newBuffer(s.Data))),re.Long){var i=new re.Long(0,0,!0);s.filesize=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.filesize=n.longs===String?"0":0;if(re.Long){var i=new re.Long(0,0,!0);s.hashType=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.hashType=n.longs===String?"0":0;if(re.Long){var i=new re.Long(0,0,!0);s.fanout=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.fanout=n.longs===String?"0":0;s.mode=0,s.mtime=null}if(t.Type!=null&&t.hasOwnProperty("Type")&&(s.Type=n.enums===String?Kt.Data.DataType[t.Type]:t.Type),t.Data!=null&&t.hasOwnProperty("Data")&&(s.Data=n.bytes===String?re.base64.encode(t.Data,0,t.Data.length):n.bytes===Array?Array.prototype.slice.call(t.Data):t.Data),t.filesize!=null&&t.hasOwnProperty("filesize")&&(typeof t.filesize=="number"?s.filesize=n.longs===String?String(t.filesize):t.filesize:s.filesize=n.longs===String?re.Long.prototype.toString.call(t.filesize):n.longs===Number?new re.LongBits(t.filesize.low>>>0,t.filesize.high>>>0).toNumber(!0):t.filesize),t.blocksizes&&t.blocksizes.length){s.blocksizes=[];for(var o=0;o<t.blocksizes.length;++o)typeof t.blocksizes[o]=="number"?s.blocksizes[o]=n.longs===String?String(t.blocksizes[o]):t.blocksizes[o]:s.blocksizes[o]=n.longs===String?re.Long.prototype.toString.call(t.blocksizes[o]):n.longs===Number?new re.LongBits(t.blocksizes[o].low>>>0,t.blocksizes[o].high>>>0).toNumber(!0):t.blocksizes[o]}return t.hashType!=null&&t.hasOwnProperty("hashType")&&(typeof t.hashType=="number"?s.hashType=n.longs===String?String(t.hashType):t.hashType:s.hashType=n.longs===String?re.Long.prototype.toString.call(t.hashType):n.longs===Number?new re.LongBits(t.hashType.low>>>0,t.hashType.high>>>0).toNumber(!0):t.hashType),t.fanout!=null&&t.hasOwnProperty("fanout")&&(typeof t.fanout=="number"?s.fanout=n.longs===String?String(t.fanout):t.fanout:s.fanout=n.longs===String?re.Long.prototype.toString.call(t.fanout):n.longs===Number?new re.LongBits(t.fanout.low>>>0,t.fanout.high>>>0).toNumber(!0):t.fanout),t.mode!=null&&t.hasOwnProperty("mode")&&(s.mode=t.mode),t.mtime!=null&&t.hasOwnProperty("mtime")&&(s.mtime=Kt.UnixTime.toObject(t.mtime,n)),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},r.DataType=function(){const e={},t=Object.create(e);return t[e[0]="Raw"]=0,t[e[1]="Directory"]=1,t[e[2]="File"]=2,t[e[3]="Metadata"]=3,t[e[4]="Symlink"]=4,t[e[5]="HAMTShard"]=5,t}(),r})();Kt.UnixTime=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.Seconds=re.Long?re.Long.fromBits(0,0,!1):0,r.prototype.FractionalNanoseconds=0,r.encode=function(t,n){return n||(n=om.create()),n.uint32(8).int64(t.Seconds),t.FractionalNanoseconds!=null&&Object.hasOwnProperty.call(t,"FractionalNanoseconds")&&n.uint32(21).fixed32(t.FractionalNanoseconds),n},r.decode=function(t,n){t instanceof tl||(t=tl.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new Kt.UnixTime;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.Seconds=t.int64();break;case 2:i.FractionalNanoseconds=t.fixed32();break;default:t.skipType(o&7);break}}if(!i.hasOwnProperty("Seconds"))throw re.ProtocolError("missing required 'Seconds'",{instance:i});return i},r.fromObject=function(t){if(t instanceof Kt.UnixTime)return t;var n=new Kt.UnixTime;return t.Seconds!=null&&(re.Long?(n.Seconds=re.Long.fromValue(t.Seconds)).unsigned=!1:typeof t.Seconds=="string"?n.Seconds=parseInt(t.Seconds,10):typeof t.Seconds=="number"?n.Seconds=t.Seconds:typeof t.Seconds=="object"&&(n.Seconds=new re.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber())),t.FractionalNanoseconds!=null&&(n.FractionalNanoseconds=t.FractionalNanoseconds>>>0),n},r.toObject=function(t,n){n||(n={});var s={};if(n.defaults){if(re.Long){var i=new re.Long(0,0,!1);s.Seconds=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.Seconds=n.longs===String?"0":0;s.FractionalNanoseconds=0}return t.Seconds!=null&&t.hasOwnProperty("Seconds")&&(typeof t.Seconds=="number"?s.Seconds=n.longs===String?String(t.Seconds):t.Seconds:s.Seconds=n.longs===String?re.Long.prototype.toString.call(t.Seconds):n.longs===Number?new re.LongBits(t.Seconds.low>>>0,t.Seconds.high>>>0).toNumber():t.Seconds),t.FractionalNanoseconds!=null&&t.hasOwnProperty("FractionalNanoseconds")&&(s.FractionalNanoseconds=t.FractionalNanoseconds),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},r})();Kt.Metadata=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.MimeType="",r.encode=function(t,n){return n||(n=om.create()),t.MimeType!=null&&Object.hasOwnProperty.call(t,"MimeType")&&n.uint32(10).string(t.MimeType),n},r.decode=function(t,n){t instanceof tl||(t=tl.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new Kt.Metadata;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.MimeType=t.string();break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof Kt.Metadata)return t;var n=new Kt.Metadata;return t.MimeType!=null&&(n.MimeType=String(t.MimeType)),n},r.toObject=function(t,n){n||(n={});var s={};return n.defaults&&(s.MimeType=""),t.MimeType!=null&&t.hasOwnProperty("MimeType")&&(s.MimeType=t.MimeType),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},r})();const ci=Pz,b7=["raw","directory","file","metadata","symlink","hamt-sharded-directory"],kz=["directory","hamt-sharded-directory"],m7=parseInt("0644",8),E7=parseInt("0755",8);function jc(r){if(r!=null)return typeof r=="number"?r&4095:(r=r.toString(),r.substring(0,1)==="0"?parseInt(r,8)&4095:parseInt(r,10)&4095)}function Cd(r){if(r==null)return;let e;if(r.secs!=null&&(e={secs:r.secs,nsecs:r.nsecs}),r.Seconds!=null&&(e={secs:r.Seconds,nsecs:r.FractionalNanoseconds}),Array.isArray(r)&&(e={secs:r[0],nsecs:r[1]}),r instanceof Date){const t=r.getTime(),n=Math.floor(t/1e3);e={secs:n,nsecs:(t-n*1e3)*1e3}}if(Object.prototype.hasOwnProperty.call(e,"secs")){if(e!=null&&e.nsecs!=null&&(e.nsecs<0||e.nsecs>999999999))throw $(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return e}}class Ze{static unmarshal(e){const t=ci.decode(e),n=ci.toObject(t,{defaults:!1,arrays:!0,longs:Number,objects:!1}),s=new Ze({type:b7[n.Type],data:n.Data,blockSizes:n.blocksizes,mode:n.mode,mtime:n.mtime?{secs:n.mtime.Seconds,nsecs:n.mtime.FractionalNanoseconds}:void 0});return s._originalMode=n.mode||0,s}constructor(e={type:"file"}){const{type:t,data:n,blockSizes:s,hashType:i,fanout:o,mtime:a,mode:c}=e;if(t&&!b7.includes(t))throw $(new Error("Type: "+t+" is not valid"),"ERR_INVALID_TYPE");this.type=t||"file",this.data=n,this.hashType=i,this.fanout=o,this.blockSizes=s||[],this._originalMode=0,this.mode=jc(c),a&&(this.mtime=Cd(a),this.mtime&&!this.mtime.nsecs&&(this.mtime.nsecs=0))}set mode(e){this._mode=this.isDirectory()?E7:m7;const t=jc(e);t!==void 0&&(this._mode=t)}get mode(){return this._mode}isDirectory(){return!!(this.type&&kz.includes(this.type))}addBlockSize(e){this.blockSizes.push(e)}removeBlockSize(e){this.blockSizes.splice(e,1)}fileSize(){if(this.isDirectory())return 0;let e=0;return this.blockSizes.forEach(t=>{e+=t}),this.data&&(e+=this.data.length),e}marshal(){let e;switch(this.type){case"raw":e=ci.DataType.Raw;break;case"directory":e=ci.DataType.Directory;break;case"file":e=ci.DataType.File;break;case"metadata":e=ci.DataType.Metadata;break;case"symlink":e=ci.DataType.Symlink;break;case"hamt-sharded-directory":e=ci.DataType.HAMTShard;break;default:throw $(new Error("Type: "+e+" is not valid"),"ERR_INVALID_TYPE")}let t=this.data;(!this.data||!this.data.length)&&(t=void 0);let n;this.mode!=null&&(n=this._originalMode&4294963200|(jc(this.mode)||0),n===m7&&!this.isDirectory()&&(n=void 0),n===E7&&this.isDirectory()&&(n=void 0));let s;if(this.mtime!=null){const o=Cd(this.mtime);o&&(s={Seconds:o.secs,FractionalNanoseconds:o.nsecs},s.FractionalNanoseconds===0&&delete s.FractionalNanoseconds)}const i={Type:e,Data:t,filesize:this.isDirectory()?void 0:this.fileSize(),blocksizes:this.blockSizes,hashType:this.hashType,fanout:this.fanout,mode:n,mtime:s};return ci.encode(i).finish()}}const Nz=["string","number","bigint","symbol"],Lz=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function Mz(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";const e=typeof r;if(Nz.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(Uz(r))return"Buffer";const t=Bz(r);return t||"Object"}function Uz(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function Bz(r){const e=Object.prototype.toString.call(r).slice(8,-1);if(Lz.includes(e))return e}class x{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}}x.uint=new x(0,"uint",!0);x.negint=new x(1,"negint",!0);x.bytes=new x(2,"bytes",!0);x.string=new x(3,"string",!0);x.array=new x(4,"array",!1);x.map=new x(5,"map",!1);x.tag=new x(6,"tag",!1);x.float=new x(7,"float",!0);x.false=new x(7,"false",!0);x.true=new x(7,"true",!0);x.null=new x(7,"null",!0);x.undefined=new x(7,"undefined",!0);x.break=new x(7,"break",!0);class q{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const Al=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",zz=new TextDecoder,Fz=new TextEncoder;function Sp(r){return Al&&globalThis.Buffer.isBuffer(r)}function am(r){return r instanceof Uint8Array?Sp(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}const Vz=Al?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):_7(r,e,t):(r,e,t)=>t-e>64?zz.decode(r.subarray(e,t)):_7(r,e,t),WT=Al?r=>r.length>64?globalThis.Buffer.from(r):v7(r):r=>r.length>64?Fz.encode(r):v7(r),cm=Al?(r,e,t)=>Sp(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),jz=Al?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),am(globalThis.Buffer.concat(r,e))):(r,e)=>{const t=new Uint8Array(e);let n=0;for(let s of r)n+s.length>t.length&&(s=s.subarray(0,t.length-n)),t.set(s,n),n+=s.length;return t},qz=Al?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function Kz(r,e){if(Sp(r)&&Sp(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function v7(r,e=1/0){let t;const n=r.length;let s=null;const i=[];for(let o=0;o<n;++o){if(t=r.charCodeAt(o),t>55295&&t<57344){if(!s){if(t>56319){(e-=3)>-1&&i.push(239,191,189);continue}else if(o+1===n){(e-=3)>-1&&i.push(239,191,189);continue}s=t;continue}if(t<56320){(e-=3)>-1&&i.push(239,191,189),s=t;continue}t=(s-55296<<10|t-56320)+65536}else s&&(e-=3)>-1&&i.push(239,191,189);if(s=null,t<128){if((e-=1)<0)break;i.push(t)}else if(t<2048){if((e-=2)<0)break;i.push(t>>6|192,t&63|128)}else if(t<65536){if((e-=3)<0)break;i.push(t>>12|224,t>>6&63|128,t&63|128)}else if(t<1114112){if((e-=4)<0)break;i.push(t>>18|240,t>>12&63|128,t>>6&63|128,t&63|128)}else throw new Error("Invalid code point")}return i}function _7(r,e,t){const n=[];for(;e<t;){const s=r[e];let i=null,o=s>239?4:s>223?3:s>191?2:1;if(e+o<=t){let a,c,u,l;switch(o){case 1:s<128&&(i=s);break;case 2:a=r[e+1],(a&192)===128&&(l=(s&31)<<6|a&63,l>127&&(i=l));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(l=(s&15)<<12|(a&63)<<6|c&63,l>2047&&(l<55296||l>57343)&&(i=l));break;case 4:a=r[e+1],c=r[e+2],u=r[e+3],(a&192)===128&&(c&192)===128&&(u&192)===128&&(l=(s&15)<<18|(a&63)<<12|(c&63)<<6|u&63,l>65535&&l<1114112&&(i=l))}}i===null?(i=65533,o=1):i>65535&&(i-=65536,n.push(i>>>10&1023|55296),i=56320|i&1023),n.push(i),e+=o}return QT(n)}const S7=4096;function QT(r){const e=r.length;if(e<=S7)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=S7));return t}const Gz=256;class YT{constructor(e=Gz){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){const s=t.length-(this.maxCursor-this.cursor)-1;t.set(e,s)}else{if(t){const s=t.length-(this.maxCursor-this.cursor)-1;s<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,s),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=qz(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){const n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=cm(n,0,this.cursor)}else t=jz(this.chunks,this.cursor);return e&&this.reset(),t}}const ee="CBOR decode error:",ma="CBOR encode error:";function $l(r,e,t){if(r.length-e<t)throw new Error(`${ee} not enough data for type`)}const Ht=[24,256,65536,4294967296,BigInt("18446744073709551616")];function Qa(r,e,t){$l(r,e,1);const n=r[e];if(t.strict===!0&&n<Ht[0])throw new Error(`${ee} integer encoded in more bytes than necessary (strict decode)`);return n}function Ya(r,e,t){$l(r,e,2);const n=r[e]<<8|r[e+1];if(t.strict===!0&&n<Ht[1])throw new Error(`${ee} integer encoded in more bytes than necessary (strict decode)`);return n}function Xa(r,e,t){$l(r,e,4);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<Ht[2])throw new Error(`${ee} integer encoded in more bytes than necessary (strict decode)`);return n}function Ja(r,e,t){$l(r,e,8);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],s=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],i=(BigInt(n)<<BigInt(32))+BigInt(s);if(t.strict===!0&&i<Ht[3])throw new Error(`${ee} integer encoded in more bytes than necessary (strict decode)`);if(i<=Number.MAX_SAFE_INTEGER)return Number(i);if(t.allowBigInt===!0)return i;throw new Error(`${ee} integers outside of the safe integer range are not supported`)}function Hz(r,e,t,n){return new q(x.uint,Qa(r,e+1,n),2)}function Wz(r,e,t,n){return new q(x.uint,Ya(r,e+1,n),3)}function Qz(r,e,t,n){return new q(x.uint,Xa(r,e+1,n),5)}function Yz(r,e,t,n){return new q(x.uint,Ja(r,e+1,n),9)}function Za(r,e){return Zn(r,0,e.value)}function Zn(r,e,t){if(t<Ht[0]){const n=Number(t);r.push([e|n])}else if(t<Ht[1]){const n=Number(t);r.push([e|24,n])}else if(t<Ht[2]){const n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<Ht[3]){const n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{const n=BigInt(t);if(n<Ht[4]){const s=[e|27,0,0,0,0,0,0,0];let i=Number(n&BigInt(4294967295)),o=Number(n>>BigInt(32)&BigInt(4294967295));s[8]=i&255,i=i>>8,s[7]=i&255,i=i>>8,s[6]=i&255,i=i>>8,s[5]=i&255,s[4]=o&255,o=o>>8,s[3]=o&255,o=o>>8,s[2]=o&255,o=o>>8,s[1]=o&255,r.push(s)}else throw new Error(`${ee} encountered BigInt larger than allowable range`)}}Za.encodedSize=function(e){return Zn.encodedSize(e.value)};Zn.encodedSize=function(e){return e<Ht[0]?1:e<Ht[1]?2:e<Ht[2]?3:e<Ht[3]?5:9};Za.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function Xz(r,e,t,n){return new q(x.negint,-1-Qa(r,e+1,n),2)}function Jz(r,e,t,n){return new q(x.negint,-1-Ya(r,e+1,n),3)}function Zz(r,e,t,n){return new q(x.negint,-1-Xa(r,e+1,n),5)}const lm=BigInt(-1),XT=BigInt(1);function eF(r,e,t,n){const s=Ja(r,e+1,n);if(typeof s!="bigint"){const i=-1-s;if(i>=Number.MIN_SAFE_INTEGER)return new q(x.negint,i,9)}if(n.allowBigInt!==!0)throw new Error(`${ee} integers outside of the safe integer range are not supported`);return new q(x.negint,lm-BigInt(s),9)}function um(r,e){const t=e.value,n=typeof t=="bigint"?t*lm-XT:t*-1-1;Zn(r,e.type.majorEncoded,n)}um.encodedSize=function(e){const t=e.value,n=typeof t=="bigint"?t*lm-XT:t*-1-1;return n<Ht[0]?1:n<Ht[1]?2:n<Ht[2]?3:n<Ht[3]?5:9};um.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function uh(r,e,t,n){$l(r,e,t+n);const s=cm(r,e+t,e+t+n);return new q(x.bytes,s,t+n)}function tF(r,e,t,n){return uh(r,e,1,t)}function rF(r,e,t,n){return uh(r,e,2,Qa(r,e+1,n))}function nF(r,e,t,n){return uh(r,e,3,Ya(r,e+1,n))}function sF(r,e,t,n){return uh(r,e,5,Xa(r,e+1,n))}function iF(r,e,t,n){const s=Ja(r,e+1,n);if(typeof s=="bigint")throw new Error(`${ee} 64-bit integer bytes lengths not supported`);return uh(r,e,9,s)}function Ap(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===x.string?WT(r.value):r.value),r.encodedBytes}function r2(r,e){const t=Ap(e);Zn(r,e.type.majorEncoded,t.length),r.push(t)}r2.encodedSize=function(e){const t=Ap(e);return Zn.encodedSize(t.length)+t.length};r2.compareTokens=function(e,t){return oF(Ap(e),Ap(t))};function oF(r,e){return r.length<e.length?-1:r.length>e.length?1:Kz(r,e)}function dh(r,e,t,n,s){const i=t+n;$l(r,e,i);const o=new q(x.string,Vz(r,e+t,e+i),i);return s.retainStringBytes===!0&&(o.byteValue=cm(r,e+t,e+i)),o}function aF(r,e,t,n){return dh(r,e,1,t,n)}function cF(r,e,t,n){return dh(r,e,2,Qa(r,e+1,n),n)}function lF(r,e,t,n){return dh(r,e,3,Ya(r,e+1,n),n)}function uF(r,e,t,n){return dh(r,e,5,Xa(r,e+1,n),n)}function dF(r,e,t,n){const s=Ja(r,e+1,n);if(typeof s=="bigint")throw new Error(`${ee} 64-bit integer string lengths not supported`);return dh(r,e,9,s,n)}const hF=r2;function Rl(r,e,t,n){return new q(x.array,n,t)}function fF(r,e,t,n){return Rl(r,e,1,t)}function pF(r,e,t,n){return Rl(r,e,2,Qa(r,e+1,n))}function gF(r,e,t,n){return Rl(r,e,3,Ya(r,e+1,n))}function yF(r,e,t,n){return Rl(r,e,5,Xa(r,e+1,n))}function wF(r,e,t,n){const s=Ja(r,e+1,n);if(typeof s=="bigint")throw new Error(`${ee} 64-bit integer array lengths not supported`);return Rl(r,e,9,s)}function bF(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ee} indefinite length items not allowed`);return Rl(r,e,1,1/0)}function dm(r,e){Zn(r,x.array.majorEncoded,e.value)}dm.compareTokens=Za.compareTokens;dm.encodedSize=function(e){return Zn.encodedSize(e.value)};function Tl(r,e,t,n){return new q(x.map,n,t)}function mF(r,e,t,n){return Tl(r,e,1,t)}function EF(r,e,t,n){return Tl(r,e,2,Qa(r,e+1,n))}function vF(r,e,t,n){return Tl(r,e,3,Ya(r,e+1,n))}function _F(r,e,t,n){return Tl(r,e,5,Xa(r,e+1,n))}function SF(r,e,t,n){const s=Ja(r,e+1,n);if(typeof s=="bigint")throw new Error(`${ee} 64-bit integer map lengths not supported`);return Tl(r,e,9,s)}function AF(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ee} indefinite length items not allowed`);return Tl(r,e,1,1/0)}function hm(r,e){Zn(r,x.map.majorEncoded,e.value)}hm.compareTokens=Za.compareTokens;hm.encodedSize=function(e){return Zn.encodedSize(e.value)};function $F(r,e,t,n){return new q(x.tag,t,1)}function RF(r,e,t,n){return new q(x.tag,Qa(r,e+1,n),2)}function TF(r,e,t,n){return new q(x.tag,Ya(r,e+1,n),3)}function IF(r,e,t,n){return new q(x.tag,Xa(r,e+1,n),5)}function CF(r,e,t,n){return new q(x.tag,Ja(r,e+1,n),9)}function fm(r,e){Zn(r,x.tag.majorEncoded,e.value)}fm.compareTokens=Za.compareTokens;fm.encodedSize=function(e){return Zn.encodedSize(e.value)};const xF=20,DF=21,OF=22,PF=23;function kF(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${ee} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new q(x.null,null,1):new q(x.undefined,void 0,1)}function NF(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ee} indefinite length items not allowed`);return new q(x.break,void 0,1)}function pm(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${ee} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${ee} Infinity values are not supported`)}return new q(x.float,r,e)}function LF(r,e,t,n){return pm(ym(r,e+1),3,n)}function MF(r,e,t,n){return pm(wm(r,e+1),5,n)}function UF(r,e,t,n){return pm(tI(r,e+1),9,n)}function gm(r,e,t){const n=e.value;if(n===!1)r.push([x.float.majorEncoded|xF]);else if(n===!0)r.push([x.float.majorEncoded|DF]);else if(n===null)r.push([x.float.majorEncoded|OF]);else if(n===void 0)r.push([x.float.majorEncoded|PF]);else{let s,i=!1;(!t||t.float64!==!0)&&(ZT(n),s=ym(cs,1),n===s||Number.isNaN(n)?(cs[0]=249,r.push(cs.slice(0,3)),i=!0):(eI(n),s=wm(cs,1),n===s&&(cs[0]=250,r.push(cs.slice(0,5)),i=!0))),i||(BF(n),s=tI(cs,1),cs[0]=251,r.push(cs.slice(0,9)))}}gm.encodedSize=function(e,t){const n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){ZT(n);let s=ym(cs,1);if(n===s||Number.isNaN(n))return 3;if(eI(n),s=wm(cs,1),n===s)return 5}return 9};const JT=new ArrayBuffer(9),Fn=new DataView(JT,1),cs=new Uint8Array(JT,0);function ZT(r){if(r===1/0)Fn.setUint16(0,31744,!1);else if(r===-1/0)Fn.setUint16(0,64512,!1);else if(Number.isNaN(r))Fn.setUint16(0,32256,!1);else{Fn.setFloat32(0,r);const e=Fn.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)Fn.setUint16(0,31744,!1);else if(t===0)Fn.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{const s=t-127;s<-24?Fn.setUint16(0,0):s<-14?Fn.setUint16(0,(e&2147483648)>>16|1<<24+s,!1):Fn.setUint16(0,(e&2147483648)>>16|s+15<<10|n>>13,!1)}}}function ym(r,e){if(r.length-e<2)throw new Error(`${ee} not enough data for float16`);const t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;const n=t>>10&31,s=t&1023;let i;return n===0?i=s*2**-24:n!==31?i=(s+1024)*2**(n-25):i=s===0?1/0:NaN,t&32768?-i:i}function eI(r){Fn.setFloat32(0,r,!1)}function wm(r,e){if(r.length-e<4)throw new Error(`${ee} not enough data for float32`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function BF(r){Fn.setFloat64(0,r,!1)}function tI(r,e){if(r.length-e<8)throw new Error(`${ee} not enough data for float64`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}gm.compareTokens=Za.compareTokens;function Ce(r,e,t){throw new Error(`${ee} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function n2(r){return()=>{throw new Error(`${ee} ${r}`)}}const G=[];for(let r=0;r<=23;r++)G[r]=Ce;G[24]=Hz;G[25]=Wz;G[26]=Qz;G[27]=Yz;G[28]=Ce;G[29]=Ce;G[30]=Ce;G[31]=Ce;for(let r=32;r<=55;r++)G[r]=Ce;G[56]=Xz;G[57]=Jz;G[58]=Zz;G[59]=eF;G[60]=Ce;G[61]=Ce;G[62]=Ce;G[63]=Ce;for(let r=64;r<=87;r++)G[r]=tF;G[88]=rF;G[89]=nF;G[90]=sF;G[91]=iF;G[92]=Ce;G[93]=Ce;G[94]=Ce;G[95]=n2("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)G[r]=aF;G[120]=cF;G[121]=lF;G[122]=uF;G[123]=dF;G[124]=Ce;G[125]=Ce;G[126]=Ce;G[127]=n2("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)G[r]=fF;G[152]=pF;G[153]=gF;G[154]=yF;G[155]=wF;G[156]=Ce;G[157]=Ce;G[158]=Ce;G[159]=bF;for(let r=160;r<=183;r++)G[r]=mF;G[184]=EF;G[185]=vF;G[186]=_F;G[187]=SF;G[188]=Ce;G[189]=Ce;G[190]=Ce;G[191]=AF;for(let r=192;r<=215;r++)G[r]=$F;G[216]=RF;G[217]=TF;G[218]=IF;G[219]=CF;G[220]=Ce;G[221]=Ce;G[222]=Ce;G[223]=Ce;for(let r=224;r<=243;r++)G[r]=n2("simple values are not supported");G[244]=Ce;G[245]=Ce;G[246]=Ce;G[247]=kF;G[248]=n2("simple values are not supported");G[249]=LF;G[250]=MF;G[251]=UF;G[252]=Ce;G[253]=Ce;G[254]=Ce;G[255]=NF;const ri=[];for(let r=0;r<24;r++)ri[r]=new q(x.uint,r,1);for(let r=-1;r>=-24;r--)ri[31-r]=new q(x.negint,r,1);ri[64]=new q(x.bytes,new Uint8Array(0),1);ri[96]=new q(x.string,"",1);ri[128]=new q(x.array,0,1);ri[160]=new q(x.map,0,1);ri[244]=new q(x.false,!1,1);ri[245]=new q(x.true,!0,1);ri[246]=new q(x.null,null,1);function zF(){const r=[];return r[x.uint.major]=Za,r[x.negint.major]=um,r[x.bytes.major]=r2,r[x.string.major]=hF,r[x.array.major]=dm,r[x.map.major]=hm,r[x.tag.major]=fm,r[x.float.major]=gm,r}zF();const kg=new YT;class $p{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${ma} object contains circular references`);return new $p(t,e)}}const Hi={null:new q(x.null,null),undefined:new q(x.undefined,void 0),true:new q(x.true,!0),false:new q(x.false,!1),emptyArray:new q(x.array,0),emptyMap:new q(x.map,0)},Uo={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new q(x.float,r):r>=0?new q(x.uint,r):new q(x.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new q(x.uint,r):new q(x.negint,r)},Uint8Array(r,e,t,n){return new q(x.bytes,r)},string(r,e,t,n){return new q(x.string,r)},boolean(r,e,t,n){return r?Hi.true:Hi.false},null(r,e,t,n){return Hi.null},undefined(r,e,t,n){return Hi.undefined},ArrayBuffer(r,e,t,n){return new q(x.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new q(x.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[Hi.emptyArray,new q(x.break)]:Hi.emptyArray;n=$p.createCheck(n,r);const s=[];let i=0;for(const o of r)s[i++]=Zf(o,t,n);return t.addBreakTokens?[new q(x.array,r.length),s,new q(x.break)]:[new q(x.array,r.length),s]},Object(r,e,t,n){const s=e!=="Object",i=s?r.keys():Object.keys(r),o=s?r.size:i.length;if(!o)return t.addBreakTokens===!0?[Hi.emptyMap,new q(x.break)]:Hi.emptyMap;n=$p.createCheck(n,r);const a=[];let c=0;for(const u of i)a[c++]=[Zf(u,t,n),Zf(s?r.get(u):r[u],t,n)];return FF(a,t),t.addBreakTokens?[new q(x.map,o),a,new q(x.break)]:[new q(x.map,o),a]}};Uo.Map=Uo.Object;Uo.Buffer=Uo.Uint8Array;for(const r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Uo[`${r}Array`]=Uo.DataView;function Zf(r,e={},t){const n=Mz(r),s=e&&e.typeEncoders&&e.typeEncoders[n]||Uo[n];if(typeof s=="function"){const o=s(r,n,e,t);if(o!=null)return o}const i=Uo[n];if(!i)throw new Error(`${ma} unsupported type: ${n}`);return i(r,n,e,t)}function FF(r,e){e.mapSorter&&r.sort(e.mapSorter)}function rI(r,e,t,n){if(Array.isArray(e))for(const s of e)rI(r,s,t,n);else t[e.type.major](r,e,n)}function VF(r,e,t){const n=Zf(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){const s=t.quickEncodeToken(n);if(s)return s;const i=e[n.type.major];if(i.encodedSize){const o=i.encodedSize(n,t),a=new YT(o);if(i(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return am(a.chunks[0])}}return kg.reset(),rI(kg,n,e,t),kg.toBytes(!0)}const jF={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class qF{constructor(e,t={}){this.pos=0,this.data=e,this.options=t}done(){return this.pos>=this.data.length}next(){const e=this.data[this.pos];let t=ri[e];if(t===void 0){const n=G[e];if(!n)throw new Error(`${ee} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);const s=e&31;t=n(this.data,this.pos,s,this.options)}return this.pos+=t.encodedLength,t}}const xd=Symbol.for("DONE"),s2=Symbol.for("BREAK");function KF(r,e,t){const n=[];for(let s=0;s<r.value;s++){const i=Dd(e,t);if(i===s2){if(r.value===1/0)break;throw new Error(`${ee} got unexpected break to lengthed array`)}if(i===xd)throw new Error(`${ee} found array but not enough entries (got ${s}, expected ${r.value})`);n[s]=i}return n}function GF(r,e,t){const n=t.useMaps===!0,s=n?void 0:{},i=n?new Map:void 0;for(let o=0;o<r.value;o++){const a=Dd(e,t);if(a===s2){if(r.value===1/0)break;throw new Error(`${ee} got unexpected break to lengthed map`)}if(a===xd)throw new Error(`${ee} found map but not enough entries (got ${o} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${ee} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&i.has(a)||!n&&a in s))throw new Error(`${ee} found repeat map key "${a}"`);const c=Dd(e,t);if(c===xd)throw new Error(`${ee} found map but not enough entries (got ${o} [no value], expected ${r.value})`);n?i.set(a,c):s[a]=c}return n?i:s}function Dd(r,e){if(r.done())return xd;const t=r.next();if(t.type===x.break)return s2;if(t.type.terminal)return t.value;if(t.type===x.array)return KF(t,r,e);if(t.type===x.map)return GF(t,r,e);if(t.type===x.tag){if(e.tags&&typeof e.tags[t.value]=="function"){const n=Dd(r,e);return e.tags[t.value](n)}throw new Error(`${ee} tag not supported (${t.value})`)}throw new Error("unsupported")}function HF(r,e){if(!(r instanceof Uint8Array))throw new Error(`${ee} data to decode must be a Uint8Array`);e=Object.assign({},jF,e);const t=e.tokenizer||new qF(r,e),n=Dd(t,e);if(n===xd)throw new Error(`${ee} did not find any content to decode`);if(n===s2)throw new Error(`${ee} got unexpected break`);if(!t.done())throw new Error(`${ee} too many terminals, data makes no sense`);return n}class WF extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){const t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===x.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===x.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[x.uint.major](e,t){this.prefix(e);const n=String(t.value),s=[];for(let i=0;i<n.length;i++)s[i]=n.charCodeAt(i);e.push(s)}[x.negint.major](e,t){this[x.uint.major](e,t)}[x.bytes.major](e,t){throw new Error(`${ma} unsupported type: Uint8Array`)}[x.string.major](e,t){this.prefix(e);const n=WT(JSON.stringify(t.value));e.push(n.length>32?am(n):n)}[x.array.major](e,t){this.prefix(e),this.inRecursive.push({type:x.array,elements:0}),e.push([91])}[x.map.major](e,t){this.prefix(e),this.inRecursive.push({type:x.map,elements:0}),e.push([123])}[x.tag.major](e,t){}[x.float.major](e,t){if(t.type.name==="break"){const o=this.inRecursive.pop();if(o){if(o.type===x.array)e.push([93]);else if(o.type===x.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${ma} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}const n=String(t.value),s=[];let i=!1;for(let o=0;o<n.length;o++)s[o]=n.charCodeAt(o),!i&&(s[o]===46||s[o]===101||s[o]===69)&&(i=!0);i||(s.push(46),s.push(48)),e.push(s)}}function QF(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${ma} complex map keys are not supported`);const t=r[0],n=e[0];if(t.type!==x.string||n.type!==x.string)throw new Error(`${ma} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${ma} unexpected duplicate map keys, this is not supported`)}const YF={addBreakTokens:!0,mapSorter:QF};function XF(r,e){return e=Object.assign({},YF,e),VF(r,new WF,e)}class nI{constructor(e,t={}){this.pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}done(){return this.pos>=this.data.length}ch(){return this.data[this.pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this.pos]}expect(e){if(this.data.length-this.pos<e.length)throw new Error(`${ee} unexpected end of input at position ${this.pos}`);for(let t=0;t<e.length;t++)if(this.data[this.pos++]!==e[t])throw new Error(`${ee} unexpected token at position ${this.pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this.pos;let t=!1,n=!1;const s=a=>{for(;!this.done();){const c=this.ch();if(a.includes(c))this.pos++;else break}};if(this.ch()===45&&(t=!0,this.pos++),this.ch()===48)if(this.pos++,this.ch()===46)this.pos++,n=!0;else return new q(x.uint,0,this.pos-e);if(s([48,49,50,51,52,53,54,55,56,57]),t&&this.pos===e+1)throw new Error(`${ee} unexpected token at position ${this.pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${ee} unexpected token at position ${this.pos}`);n=!0,this.pos++,s([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this.pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this.pos++,s([48,49,50,51,52,53,54,55,56,57]));const i=String.fromCharCode.apply(null,this.data.subarray(e,this.pos)),o=parseFloat(i);return n?new q(x.float,o,this.pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new q(o>=0?x.uint:x.negint,o,this.pos-e):new q(o>=0?x.uint:x.negint,BigInt(i),this.pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${ee} unexpected character at position ${this.pos}; this shouldn't happen`);this.pos++;for(let i=this.pos,o=0;i<this.data.length&&o<65536;i++,o++){const a=this.data[i];if(a===92||a<32||a>=128)break;if(a===34){const c=String.fromCharCode.apply(null,this.data.subarray(this.pos,i));return this.pos=i+1,new q(x.string,c,o)}}const e=this.pos,t=[],n=()=>{if(this.pos+4>=this.data.length)throw new Error(`${ee} unexpected end of unicode escape sequence at position ${this.pos}`);let i=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${ee} unexpected unicode escape character at position ${this.pos}`);i=i*16+a,this.pos++}return i},s=()=>{const i=this.ch();let o=null,a=i>239?4:i>223?3:i>191?2:1;if(this.pos+a>this.data.length)throw new Error(`${ee} unexpected unicode sequence at position ${this.pos}`);let c,u,l,d;switch(a){case 1:i<128&&(o=i);break;case 2:c=this.data[this.pos+1],(c&192)===128&&(d=(i&31)<<6|c&63,d>127&&(o=d));break;case 3:c=this.data[this.pos+1],u=this.data[this.pos+2],(c&192)===128&&(u&192)===128&&(d=(i&15)<<12|(c&63)<<6|u&63,d>2047&&(d<55296||d>57343)&&(o=d));break;case 4:c=this.data[this.pos+1],u=this.data[this.pos+2],l=this.data[this.pos+3],(c&192)===128&&(u&192)===128&&(l&192)===128&&(d=(i&15)<<18|(c&63)<<12|(u&63)<<6|l&63,d>65535&&d<1114112&&(o=d))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this.pos+=a};for(;!this.done();){const i=this.ch();let o;switch(i){case 92:if(this.pos++,this.done())throw new Error(`${ee} unexpected string termination at position ${this.pos}`);switch(o=this.ch(),this.pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${ee} unexpected string escape character at position ${this.pos}`)}break;case 34:return this.pos++,new q(x.string,QT(t),this.pos-e);default:if(i<32)throw new Error(`${ee} invalid control character at position ${this.pos}`);i<128?(t.push(i),this.pos++):s()}}throw new Error(`${ee} unexpected end of string at position ${this.pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this.pos++,new q(x.map,1/0,1);case 91:return this.modeStack.push("array-start"),this.pos++,new q(x.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new q(x.null,null,4);case 102:return this.expect([102,97,108,115,101]),new q(x.false,!1,5);case 116:return this.expect([116,114,117,101]),new q(x.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${ee} unexpected character at position ${this.pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this.pos++,this.skipWhitespace(),new q(x.break,void 0,1);if(this.ch()!==44)throw new Error(`${ee} unexpected character at position ${this.pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this.pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this.pos++,this.skipWhitespace(),new q(x.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this.pos++,this.skipWhitespace(),new q(x.break,void 0,1);if(this.ch()!==44)throw new Error(`${ee} unexpected character at position ${this.pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this.pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this.pos++,this.skipWhitespace(),new q(x.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${ee} unexpected character at position ${this.pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this.pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${ee} unexpected parse state at position ${this.pos}; this shouldn't happen`)}}}function JF(r,e){return e=Object.assign({tokenizer:new nI(r,e)},e),HF(r,e)}var ZF=sI,A7=128,eV=127,tV=~eV,rV=Math.pow(2,31);function sI(r,e,t){e=e||[],t=t||0;for(var n=t;r>=rV;)e[t++]=r&255|A7,r/=128;for(;r&tV;)e[t++]=r&255|A7,r>>>=7;return e[t]=r|0,sI.bytes=t-n+1,e}var nV=Iw,sV=128,$7=127;function Iw(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Iw.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&$7)<<s:(o&$7)*Math.pow(2,s),s+=7}while(o>=sV);return Iw.bytes=i-n,t}var iV=Math.pow(2,7),oV=Math.pow(2,14),aV=Math.pow(2,21),cV=Math.pow(2,28),lV=Math.pow(2,35),uV=Math.pow(2,42),dV=Math.pow(2,49),hV=Math.pow(2,56),fV=Math.pow(2,63),pV=function(r){return r<iV?1:r<oV?2:r<aV?3:r<cV?4:r<lV?5:r<uV?6:r<dV?7:r<hV?8:r<fV?9:10},gV={encode:ZF,decode:nV,encodingLength:pV},Rp=gV;const Cw=(r,e=0)=>[Rp.decode(r,e),Rp.decode.bytes],Tp=(r,e,t=0)=>(Rp.encode(r,e,t),e),Ip=r=>Rp.encodingLength(r),yV=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},bm=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},wV=(r,e)=>{const t=e.byteLength,n=Ip(r),s=n+Ip(t),i=new Uint8Array(s+t);return Tp(r,i,0),Tp(t,i,n),i.set(e,s),new mm(r,t,e,i)},bV=r=>{const e=bm(r),[t,n]=Cw(e),[s,i]=Cw(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new mm(t,s,o,e)},mV=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&yV(r.bytes,t.bytes)}};let mm=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function EV(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var vV=EV,_V=vV;let SV=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},AV=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return iI(this,e)}},$V=class{constructor(e){this.decoders=e}or(e){return iI(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const iI=(r,e)=>new $V({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let RV=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new SV(e,t,n),this.decoder=new AV(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const oI=({name:r,prefix:e,encode:t,decode:n})=>new RV(r,e,t,n),aI=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=_V(t,e);return oI({prefix:r,name:e,encode:n,decode:i=>bm(s(i))})},TV=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},IV=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},bn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>oI({prefix:e,name:r,encode(s){return IV(s,n,t)},decode(s){return TV(s,n,t,r)}}),ro=aI({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});aI({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const ep=bn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});bn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});bn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});bn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});bn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});bn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});bn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});bn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});bn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const R7=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return xV(t,xw(r),e||ro.encoder);default:return DV(t,xw(r),e||ep.encoder)}},T7=new WeakMap,xw=r=>{const e=T7.get(r);if(e==null){const t=new Map;return T7.set(r,t),t}return e};let cI=class dr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==jl)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==OV)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return dr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=wV(e,t);return dr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return dr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&mV(e.multihash,n.multihash)}toString(e){return R7(this,e)}toJSON(){return{"/":R7(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof dr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new dr(n,s,i,o||I7(n,s,i.bytes))}else if(t[PV]===!0){const{version:n,multihash:s,code:i}=t,o=bV(s);return dr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==jl)throw new Error(`Version 0 CID must use dag-pb (code: ${jl}) block encoding`);return new dr(e,t,n,n.bytes)}case 1:{const s=I7(e,t,n.bytes);return new dr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return dr.create(0,jl,e)}static createV1(e,t){return dr.create(1,e,t)}static decode(e){const[t,n]=dr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=dr.inspectBytes(e),n=t.size-t.multihashSize,s=bm(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new mm(t.multihashCode,t.digestSize,i,s);return[t.version===0?dr.createV0(o):dr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Cw(e.subarray(t));return t+=f,d};let s=n(),i=jl;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=CV(e,t),i=dr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return xw(i).set(n,e),i}};const CV=(r,e)=>{switch(r[0]){case"Q":{const t=e||ro;return[ro.prefix,t.decode(`${ro.prefix}${r}`)]}case ro.prefix:{const t=e||ro;return[ro.prefix,t.decode(r)]}case ep.prefix:{const t=e||ep;return[ep.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},xV=(r,e,t)=>{const{prefix:n}=t;if(n!==ro.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},DV=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},jl=112,OV=18,I7=(r,e,t)=>{const n=Ip(r),s=n+Ip(e),i=new Uint8Array(s+t.byteLength);return Tp(r,i,0),Tp(e,i,n),i.set(t,s),i},PV=Symbol.for("@ipld/js-cid/CID"),lI=bn({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});bn({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});bn({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});bn({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function kV(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=cI.asCID(r);if(!e)return null;const t=e.toString();return[new q(x.map,1/0,1),new q(x.string,"/",1),new q(x.string,t,t.length),new q(x.break,void 0,1)]}function Cp(r){const e=lI.encode(r).slice(1);return[new q(x.map,1/0,1),new q(x.string,"/",1),new q(x.map,1/0,1),new q(x.string,"bytes",5),new q(x.string,e,e.length),new q(x.break,void 0,1),new q(x.break,void 0,1)]}function ss(r){return Cp(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}function NV(r){return Cp(new Uint8Array(r))}function LV(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function MV(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const UV={typeEncoders:{Object:kV,Buffer:Cp,Uint8Array:Cp,Int8Array:ss,Uint16Array:ss,Int16Array:ss,Uint32Array:ss,Int32Array:ss,Float32Array:ss,Float64Array:ss,Uint8ClampedArray:ss,BigInt64Array:ss,BigUint64Array:ss,DataView:ss,ArrayBuffer:NV,undefined:LV,number:MV}};class BV extends nI{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===x.map){const t=this._next();if(t.type===x.string&&t.value==="/"){const n=this._next();if(n.type===x.string){if(this._next().type!==x.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new q(x.tag,42,0)}if(n.type===x.map){const s=this._next();if(s.type===x.string&&s.value==="bytes"){const i=this._next();if(i.type===x.string){for(let a=0;a<2;a++)if(this._next().type!==x.break)throw new Error("Invalid encoded Bytes form");const o=lI.decode(`m${i.value}`);return new q(x.bytes,o,i.value.length)}this.tokenBuffer.push(i)}this.tokenBuffer.push(s)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}}const Dw={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Dw.tags[42]=cI.parse;const zV="dag-json",uI=297,dI=r=>XF(r,UV),hI=r=>{const e=Object.assign(Dw,{tokenizer:new BV(r,Dw)});return JF(r,e)},C7=r=>FV.decode(dI(r)),FV=new TextDecoder,VV=r=>hI(jV.encode(r)),jV=new TextEncoder,fI=Object.freeze(Object.defineProperty({__proto__:null,code:uI,decode:hI,encode:dI,format:C7,name:zV,parse:VV,stringify:C7},Symbol.toStringTag,{value:"Module"}));function qV(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var KV=qV,GV=KV;const HV=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Em=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let WV=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},QV=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return pI(this,e)}},YV=class{constructor(e){this.decoders=e}or(e){return pI(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const pI=(r,e)=>new YV({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let XV=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new WV(e,t,n),this.decoder=new QV(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const gI=({name:r,prefix:e,encode:t,decode:n})=>new XV(r,e,t,n),yI=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=GV(t,e);return gI({prefix:r,name:e,encode:n,decode:i=>Em(s(i))})},JV=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},ZV=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},mn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>gI({prefix:e,name:r,encode(s){return ZV(s,n,t)},decode(s){return JV(s,n,t,r)}});mn({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});mn({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});const wI=mn({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});mn({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function _i(r){return wI.encode(r).slice(1)}function qs(r){return wI.decode(`u${r}`)}var ej=bI,x7=128,tj=127,rj=~tj,nj=Math.pow(2,31);function bI(r,e,t){e=e||[],t=t||0;for(var n=t;r>=nj;)e[t++]=r&255|x7,r/=128;for(;r&rj;)e[t++]=r&255|x7,r>>>=7;return e[t]=r|0,bI.bytes=t-n+1,e}var sj=Ow,ij=128,D7=127;function Ow(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Ow.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&D7)<<s:(o&D7)*Math.pow(2,s),s+=7}while(o>=ij);return Ow.bytes=i-n,t}var oj=Math.pow(2,7),aj=Math.pow(2,14),cj=Math.pow(2,21),lj=Math.pow(2,28),uj=Math.pow(2,35),dj=Math.pow(2,42),hj=Math.pow(2,49),fj=Math.pow(2,56),pj=Math.pow(2,63),gj=function(r){return r<oj?1:r<aj?2:r<cj?3:r<lj?4:r<uj?5:r<dj?6:r<hj?7:r<fj?8:r<pj?9:10},yj={encode:ej,decode:sj,encodingLength:gj},xp=yj;const Pw=(r,e=0)=>[xp.decode(r,e),xp.decode.bytes],Dp=(r,e,t=0)=>(xp.encode(r,e,t),e),Op=r=>xp.encodingLength(r),wj=(r,e)=>{const t=e.byteLength,n=Op(r),s=n+Op(t),i=new Uint8Array(s+t);return Dp(r,i,0),Dp(t,i,n),i.set(e,s),new vm(r,t,e,i)},bj=r=>{const e=Em(r),[t,n]=Pw(e),[s,i]=Pw(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new vm(t,s,o,e)},mj=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&HV(r.bytes,t.bytes)}};let vm=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const no=yI({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});yI({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const tp=mn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});mn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});mn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});mn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});mn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});mn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});mn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});mn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});mn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const O7=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return vj(t,kw(r),e||no.encoder);default:return _j(t,kw(r),e||tp.encoder)}},P7=new WeakMap,kw=r=>{const e=P7.get(r);if(e==null){const t=new Map;return P7.set(r,t),t}return e};let _m=class hr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ql)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Sj)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return hr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=wj(e,t);return hr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return hr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&mj(e.multihash,n.multihash)}toString(e){return O7(this,e)}toJSON(){return{"/":O7(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof hr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new hr(n,s,i,o||k7(n,s,i.bytes))}else if(t[Aj]===!0){const{version:n,multihash:s,code:i}=t,o=bj(s);return hr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ql)throw new Error(`Version 0 CID must use dag-pb (code: ${ql}) block encoding`);return new hr(e,t,n,n.bytes)}case 1:{const s=k7(e,t,n.bytes);return new hr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return hr.create(0,ql,e)}static createV1(e,t){return hr.create(1,e,t)}static decode(e){const[t,n]=hr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=hr.inspectBytes(e),n=t.size-t.multihashSize,s=Em(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new vm(t.multihashCode,t.digestSize,i,s);return[t.version===0?hr.createV0(o):hr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Pw(e.subarray(t));return t+=f,d};let s=n(),i=ql;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=Ej(e,t),i=hr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return kw(i).set(n,e),i}};const Ej=(r,e)=>{switch(r[0]){case"Q":{const t=e||no;return[no.prefix,t.decode(`${no.prefix}${r}`)]}case no.prefix:{const t=e||no;return[no.prefix,t.decode(r)]}case tp.prefix:{const t=e||tp;return[tp.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},vj=(r,e,t)=>{const{prefix:n}=t;if(n!==no.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},_j=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},ql=112,Sj=18,k7=(r,e,t)=>{const n=Op(r),s=n+Op(e),i=new Uint8Array(s+t.byteLength);return Dp(r,i,0),Dp(e,i,n),i.set(t,s),i},Aj=Symbol.for("@ipld/js-cid/CID");function $j(r){const[e,t,n]=r;return{payload:t,signatures:[{protected:e,signature:n}],link:_m.decode(qs(t))}}function Rj(r){const e={signature:qs(r.signature)};return r.header&&(e.header=r.header),r.protected&&(e.protected=qs(r.protected)),e}function Tj(r){const e=qs(r.payload);try{_m.decode(e)}catch{throw new Error("Not a valid DagJWS")}return{payload:e,signatures:r.signatures.map(Rj)}}function Ij(r){const e={signature:_i(r.signature)};return r.header&&(e.header=r.header),r.protected&&(e.protected=_i(r.protected)),e}function Cj(r){const e={payload:_i(r.payload),signatures:r.signatures.map(Ij)};return e.link=_m.decode(new Uint8Array(r.payload)),e}function xj(r){const[e,t,n,s,i]=r,o={ciphertext:s,iv:n,protected:e,tag:i};return t&&(o.recipients=[{encrypted_key:t}]),o}function Dj(r){const e={};return r.encrypted_key&&(e.encrypted_key=qs(r.encrypted_key)),r.header&&(e.header=r.header),e}function Oj(r){const e={ciphertext:qs(r.ciphertext),protected:qs(r.protected),iv:qs(r.iv),tag:qs(r.tag)};return r.aad&&(e.aad=qs(r.aad)),r.recipients&&(e.recipients=r.recipients.map(Dj)),r.unprotected&&(e.unprotected=r.unprotected),e}function Pj(r){const e={};return r.encrypted_key&&(e.encrypted_key=_i(r.encrypted_key)),r.header&&(e.header=r.header),e}function kj(r){const e={ciphertext:_i(r.ciphertext),protected:_i(r.protected),iv:_i(r.iv),tag:_i(r.tag)};return r.aad&&(e.aad=_i(r.aad)),r.recipients&&(e.recipients=r.recipients.map(Pj)),r.unprotected&&(e.unprotected=r.unprotected),e}const Nj="dag-jose",Lj=133;function mI(r){return"payload"in r&&typeof r.payload=="string"&&"signatures"in r&&Array.isArray(r.signatures)}function Mj(r){return"payload"in r&&r.payload instanceof Uint8Array&&"signatures"in r&&Array.isArray(r.signatures)}function Uj(r){return"ciphertext"in r&&r.ciphertext instanceof Uint8Array&&"iv"in r&&r.iv instanceof Uint8Array&&"protected"in r&&r.protected instanceof Uint8Array&&"tag"in r&&r.tag instanceof Uint8Array}function EI(r){return"ciphertext"in r&&typeof r.ciphertext=="string"&&"iv"in r&&typeof r.iv=="string"&&"protected"in r&&typeof r.protected=="string"&&"tag"in r&&typeof r.tag=="string"}function vI(r){if(typeof r=="string"){const e=r.split(".");if(e.length===3)return $j(e);if(e.length===5)return xj(e);throw new Error("Not a valid JOSE string")}if(mI(r)||EI(r))return r;throw new Error("Not a valid unencoded JOSE object")}function Bj(r){typeof r=="string"&&(r=vI(r));let e;if(mI(r))e=Tj(r);else if(EI(r))e=Oj(r);else throw new Error("Not a valid JOSE object");return new Uint8Array(mT(e))}function zj(r){let e;try{e=Z6(r)}catch{throw new Error("Not a valid DAG-JOSE object")}if(Mj(e))return Cj(e);if(Uj(e))return kj(e);throw new Error("Not a valid DAG-JOSE object")}const _I=Object.freeze(Object.defineProperty({__proto__:null,code:Lj,decode:zj,encode:Bj,name:Nj,toGeneral:vI},Symbol.toStringTag,{value:"Module"})),Fj=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Il=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Vj=r=>new TextEncoder().encode(r),jj=r=>new TextDecoder().decode(r);var qj=SI,N7=128,Kj=127,Gj=~Kj,Hj=Math.pow(2,31);function SI(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Hj;)e[t++]=r&255|N7,r/=128;for(;r&Gj;)e[t++]=r&255|N7,r>>>=7;return e[t]=r|0,SI.bytes=t-n+1,e}var Wj=Nw,Qj=128,L7=127;function Nw(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Nw.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&L7)<<s:(o&L7)*Math.pow(2,s),s+=7}while(o>=Qj);return Nw.bytes=i-n,t}var Yj=Math.pow(2,7),Xj=Math.pow(2,14),Jj=Math.pow(2,21),Zj=Math.pow(2,28),eq=Math.pow(2,35),tq=Math.pow(2,42),rq=Math.pow(2,49),nq=Math.pow(2,56),sq=Math.pow(2,63),iq=function(r){return r<Yj?1:r<Xj?2:r<Jj?3:r<Zj?4:r<eq?5:r<tq?6:r<rq?7:r<nq?8:r<sq?9:10},oq={encode:qj,decode:Wj,encodingLength:iq},Pp=oq;const Lw=(r,e=0)=>[Pp.decode(r,e),Pp.decode.bytes],kp=(r,e,t=0)=>(Pp.encode(r,e,t),e),Np=r=>Pp.encodingLength(r),Lp=(r,e)=>{const t=e.byteLength,n=Np(r),s=n+Np(t),i=new Uint8Array(s+t);return kp(r,i,0),kp(t,i,n),i.set(e,s),new Am(r,t,e,i)},Sm=r=>{const e=Il(r),[t,n]=Lw(e),[s,i]=Lw(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Am(t,s,o,e)},aq=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Fj(r.bytes,t.bytes)}};let Am=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const AI=0,cq="identity",$I=Il,lq=r=>Lp(AI,$I(r)),Mw={code:AI,name:cq,encode:$I,digest:lq},uq=Object.freeze(Object.defineProperty({__proto__:null,identity:Mw},Symbol.toStringTag,{value:"Module"}));function dq(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var hq=dq,fq=hq;let pq=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},gq=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return RI(this,e)}},yq=class{constructor(e){this.decoders=e}or(e){return RI(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const RI=(r,e)=>new yq({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let wq=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new pq(e,t,n),this.decoder=new gq(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const i2=({name:r,prefix:e,encode:t,decode:n})=>new wq(r,e,t,n),hh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=fq(t,e);return i2({prefix:r,name:e,encode:n,decode:i=>Il(s(i))})},bq=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},mq=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Qt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>i2({prefix:e,name:r,encode(s){return mq(s,n,t)},decode(s){return bq(s,n,t,r)}}),Eq=i2({prefix:"\0",name:"identity",encode:r=>jj(r),decode:r=>Vj(r)}),vq=Object.freeze(Object.defineProperty({__proto__:null,identity:Eq},Symbol.toStringTag,{value:"Module"})),_q=Qt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Sq=Object.freeze(Object.defineProperty({__proto__:null,base2:_q},Symbol.toStringTag,{value:"Module"})),Aq=Qt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),$q=Object.freeze(Object.defineProperty({__proto__:null,base8:Aq},Symbol.toStringTag,{value:"Module"})),Rq=hh({prefix:"9",name:"base10",alphabet:"0123456789"}),Tq=Object.freeze(Object.defineProperty({__proto__:null,base10:Rq},Symbol.toStringTag,{value:"Module"})),Iq=Qt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Cq=Qt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),xq=Object.freeze(Object.defineProperty({__proto__:null,base16:Iq,base16upper:Cq},Symbol.toStringTag,{value:"Module"})),Ea=Qt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Dq=Qt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Oq=Qt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Pq=Qt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),kq=Qt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Nq=Qt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Lq=Qt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Mq=Qt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Uq=Qt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Bq=Object.freeze(Object.defineProperty({__proto__:null,base32:Ea,base32hex:kq,base32hexpad:Lq,base32hexpadupper:Mq,base32hexupper:Nq,base32pad:Oq,base32padupper:Pq,base32upper:Dq,base32z:Uq},Symbol.toStringTag,{value:"Module"})),Mp=hh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),zq=hh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Fq=Object.freeze(Object.defineProperty({__proto__:null,base36:Mp,base36upper:zq},Symbol.toStringTag,{value:"Module"})),qr=hh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Vq=hh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),jq=Object.freeze(Object.defineProperty({__proto__:null,base58btc:qr,base58flickr:Vq},Symbol.toStringTag,{value:"Module"})),qq=Qt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Kq=Qt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Gq=Qt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Hq=Qt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Wq=Object.freeze(Object.defineProperty({__proto__:null,base64:qq,base64pad:Kq,base64url:Gq,base64urlpad:Hq},Symbol.toStringTag,{value:"Module"})),TI=Array.from(""),Qq=TI.reduce((r,e,t)=>(r[t]=e,r),[]),Yq=TI.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function Xq(r){return r.reduce((e,t)=>(e+=Qq[t],e),"")}function Jq(r){const e=[];for(const t of r){const n=Yq[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const Zq=i2({prefix:"",name:"base256emoji",encode:Xq,decode:Jq}),eK=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:Zq},Symbol.toStringTag,{value:"Module"})),II=({name:r,code:e,encode:t})=>new tK(r,e,t);let tK=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Lp(this.code,t):t.then(n=>Lp(this.code,n))}else throw Error("Unknown type, must be binary type")}};const CI=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),rl=II({name:"sha2-256",code:18,encode:CI("SHA-256")}),rK=II({name:"sha2-512",code:19,encode:CI("SHA-512")}),nK=Object.freeze(Object.defineProperty({__proto__:null,sha256:rl,sha512:rK},Symbol.toStringTag,{value:"Module"})),sK="raw",$m=85,iK=r=>Il(r),oK=r=>Il(r),aK=Object.freeze(Object.defineProperty({__proto__:null,code:$m,decode:oK,encode:iK,name:sK},Symbol.toStringTag,{value:"Module"})),cK=new TextEncoder,lK=new TextDecoder,uK="json",xI=512,dK=r=>cK.encode(JSON.stringify(r)),hK=r=>JSON.parse(lK.decode(r)),fK=Object.freeze(Object.defineProperty({__proto__:null,code:xI,decode:hK,encode:dK,name:uK},Symbol.toStringTag,{value:"Module"})),M7=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return gK(t,Uw(r),e||qr.encoder);default:return yK(t,Uw(r),e||Ea.encoder)}},U7=new WeakMap,Uw=r=>{const e=U7.get(r);if(e==null){const t=new Map;return U7.set(r,t),t}return e};let ne=class fr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Kl)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==wK)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return fr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Lp(e,t);return fr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return fr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&aq(e.multihash,n.multihash)}toString(e){return M7(this,e)}toJSON(){return{"/":M7(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof fr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new fr(n,s,i,o||B7(n,s,i.bytes))}else if(t[bK]===!0){const{version:n,multihash:s,code:i}=t,o=Sm(s);return fr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Kl)throw new Error(`Version 0 CID must use dag-pb (code: ${Kl}) block encoding`);return new fr(e,t,n,n.bytes)}case 1:{const s=B7(e,t,n.bytes);return new fr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return fr.create(0,Kl,e)}static createV1(e,t){return fr.create(1,e,t)}static decode(e){const[t,n]=fr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=fr.inspectBytes(e),n=t.size-t.multihashSize,s=Il(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Am(t.multihashCode,t.digestSize,i,s);return[t.version===0?fr.createV0(o):fr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Lw(e.subarray(t));return t+=f,d};let s=n(),i=Kl;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=pK(e,t),i=fr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Uw(i).set(n,e),i}};const pK=(r,e)=>{switch(r[0]){case"Q":{const t=e||qr;return[qr.prefix,t.decode(`${qr.prefix}${r}`)]}case qr.prefix:{const t=e||qr;return[qr.prefix,t.decode(r)]}case Ea.prefix:{const t=e||Ea;return[Ea.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},gK=(r,e,t)=>{const{prefix:n}=t;if(n!==qr.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},yK=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Kl=112,wK=18,B7=(r,e,t)=>{const n=Np(r),s=n+Np(e),i=new Uint8Array(s+t.byteLength);return kp(r,i,0),kp(e,i,n),i.set(t,s),i},bK=Symbol.for("@ipld/js-cid/CID"),DI={...vq,...Sq,...$q,...Tq,...xq,...Bq,...Fq,...jq,...Wq,...eK},mK={...nK,...uq},EK={raw:aK,json:fK};class fh extends Error{constructor(e="not initialized"){super(e),this.name="NotInitializedError",this.code=fh.code}}fh.code="ERR_NOT_INITIALIZED";class vK extends Error{constructor(e="cannot initialize an initializing node"){super(e),this.name="AlreadyInitializingError",this.code=Na.code}}vK.code="ERR_ALREADY_INITIALIZING";class Na extends Error{constructor(e="cannot re-initialize an initialized node"){super(e),this.name="AlreadyInitializedError",this.code=Na.code}}Na.code="ERR_ALREADY_INITIALIZED";class ph extends Error{constructor(e="not started"){super(e),this.name="NotStartedError",this.code=ph.code}}ph.code="ERR_NOT_STARTED";class o2 extends Error{constructor(e="cannot start, already startin"){super(e),this.name="AlreadyStartingError",this.code=o2.code}}o2.code="ERR_ALREADY_STARTING";class a2 extends Error{constructor(e="cannot start, already started"){super(e),this.name="AlreadyStartedError",this.code=a2.code}}a2.code="ERR_ALREADY_STARTED";class Cl extends Error{constructor(e="not enabled"){super(e),this.name="NotEnabledError",this.code=Cl.code}}Cl.code="ERR_NOT_ENABLED";var _K=function(){return Date.now()};const nf=_K;class SK{constructor(e,t,n){const s=this;this._started=nf(),this._rescheduled=0,this._scheduled=t,this._args=n,this._triggered=!1,this._timerWrapper=()=>{s._rescheduled>0?(s._scheduled=s._rescheduled-(nf()-s._started),s._schedule(s._scheduled)):(s._triggered=!0,e.apply(null,s._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);const t=nf();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=nf(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}}function AK(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var e=0;e<r.length;e++)r[e]=arguments[e+2]}return new SK(arguments[0],arguments[1],r)}var OI=AK;const z7=Ge(OI),{AbortController:$K}=globalThis,F7=OI;class Rm extends $K{constructor(e){super(),this._ms=e,this._timer=F7(()=>this.abort(),e),Object.setPrototypeOf(this,Rm.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=F7(()=>this.abort(),this._ms)}}var ft={TimeoutController:Rm};function RK(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var TK=RK,IK=TK;const CK=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Tm=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},xK=r=>new TextEncoder().encode(r),DK=r=>new TextDecoder().decode(r);let OK=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},PK=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return PI(this,e)}},kK=class{constructor(e){this.decoders=e}or(e){return PI(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const PI=(r,e)=>new kK({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let NK=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new OK(e,t,n),this.decoder=new PK(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const c2=({name:r,prefix:e,encode:t,decode:n})=>new NK(r,e,t,n),gh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=IK(t,e);return c2({prefix:r,name:e,encode:n,decode:i=>Tm(s(i))})},LK=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},MK=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Yt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>c2({prefix:e,name:r,encode(s){return MK(s,n,t)},decode(s){return LK(s,n,t,r)}}),mi=gh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),UK=gh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),BK=Object.freeze(Object.defineProperty({__proto__:null,base58btc:mi,base58flickr:UK},Symbol.toStringTag,{value:"Module"})),hd=Yt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),zK=Yt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),FK=Yt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),VK=Yt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),jK=Yt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),qK=Yt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),KK=Yt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),GK=Yt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),HK=Yt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),WK=Object.freeze(Object.defineProperty({__proto__:null,base32:hd,base32hex:jK,base32hexpad:KK,base32hexpadupper:GK,base32hexupper:qK,base32pad:FK,base32padupper:VK,base32upper:zK,base32z:HK},Symbol.toStringTag,{value:"Module"}));var QK=kI,V7=128,YK=127,XK=~YK,JK=Math.pow(2,31);function kI(r,e,t){e=e||[],t=t||0;for(var n=t;r>=JK;)e[t++]=r&255|V7,r/=128;for(;r&XK;)e[t++]=r&255|V7,r>>>=7;return e[t]=r|0,kI.bytes=t-n+1,e}var ZK=Bw,eG=128,j7=127;function Bw(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Bw.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&j7)<<s:(o&j7)*Math.pow(2,s),s+=7}while(o>=eG);return Bw.bytes=i-n,t}var tG=Math.pow(2,7),rG=Math.pow(2,14),nG=Math.pow(2,21),sG=Math.pow(2,28),iG=Math.pow(2,35),oG=Math.pow(2,42),aG=Math.pow(2,49),cG=Math.pow(2,56),lG=Math.pow(2,63),uG=function(r){return r<tG?1:r<rG?2:r<nG?3:r<sG?4:r<iG?5:r<oG?6:r<aG?7:r<cG?8:r<lG?9:10},dG={encode:QK,decode:ZK,encodingLength:uG},Up=dG;const zw=(r,e=0)=>[Up.decode(r,e),Up.decode.bytes],Bp=(r,e,t=0)=>(Up.encode(r,e,t),e),zp=r=>Up.encodingLength(r),hG=(r,e)=>{const t=e.byteLength,n=zp(r),s=n+zp(t),i=new Uint8Array(s+t);return Bp(r,i,0),Bp(t,i,n),i.set(e,s),new Im(r,t,e,i)},fG=r=>{const e=Tm(r),[t,n]=zw(e),[s,i]=zw(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Im(t,s,o,e)},pG=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&CK(r.bytes,t.bytes)}};let Im=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};class gG{constructor(){k(this,"index",0);k(this,"input","")}new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,s){return this.readAtomically(()=>{let i=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",u=2**(8*s)-1;for(;;){const l=this.readAtomically(()=>{const d=this.readChar();if(d===void 0)return;const f=Number.parseInt(d,e);if(!Number.isNaN(f))return f});if(l===void 0)break;if(i*=e,i+=l,i>u||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const s=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[s]=o[0],t[s+1]=o[1],t[s+2]=o[2],t[s+3]=o[3],[s+4,!0]}const i=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];t[s]=i>>8,t[s+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,s]=e(t);if(n===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),o=16-(n+2),[a]=e(i.subarray(0,o));return t.set(i.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const NI=45,yG=15,nl=new gG;function wG(r){if(!(r.length>yG))return nl.new(r).parseWith(()=>nl.readIPv4Addr())}function bG(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>NI))return nl.new(r).parseWith(()=>nl.readIPv6Addr())}function mG(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>NI))return nl.new(r).parseWith(()=>nl.readIPAddr())}function es(r){return!!wG(r)}function ts(r){return!!bG(r)}function tt(r){return!!mG(r)}const Sn=-1,Fw={},Vw={},EG=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Sn,"ip6zone"],[43,8,"ipcidr"],[53,Sn,"dns",!0],[54,Sn,"dns4",!0],[55,Sn,"dns6",!0],[56,Sn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc"],[281,0,"webrtc-w3c"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Sn,"unix",!1,!0],[421,Sn,"ipfs"],[421,Sn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Sn,"garlic64"],[448,0,"tls"],[449,Sn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Sn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Sn,"memory"]];EG.forEach(r=>{const e=vG(...r);Vw[e.code]=e,Fw[e.name]=e});function vG(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function sf(r){if(typeof r=="number"){if(Vw[r]!=null)return Vw[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(Fw[r]!=null)return Fw[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}const q7=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return SG(t,jw(r),e||mi.encoder);default:return AG(t,jw(r),e||hd.encoder)}},K7=new WeakMap,jw=r=>{const e=K7.get(r);if(e==null){const t=new Map;return K7.set(r,t),t}return e};let Ng=class pr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Gl)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==$G)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return pr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=hG(e,t);return pr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return pr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&pG(e.multihash,n.multihash)}toString(e){return q7(this,e)}toJSON(){return{"/":q7(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof pr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new pr(n,s,i,o||G7(n,s,i.bytes))}else if(t[RG]===!0){const{version:n,multihash:s,code:i}=t,o=fG(s);return pr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Gl)throw new Error(`Version 0 CID must use dag-pb (code: ${Gl}) block encoding`);return new pr(e,t,n,n.bytes)}case 1:{const s=G7(e,t,n.bytes);return new pr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return pr.create(0,Gl,e)}static createV1(e,t){return pr.create(1,e,t)}static decode(e){const[t,n]=pr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=pr.inspectBytes(e),n=t.size-t.multihashSize,s=Tm(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Im(t.multihashCode,t.digestSize,i,s);return[t.version===0?pr.createV0(o):pr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=zw(e.subarray(t));return t+=f,d};let s=n(),i=Gl;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=_G(e,t),i=pr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return jw(i).set(n,e),i}};const _G=(r,e)=>{switch(r[0]){case"Q":{const t=e||mi;return[mi.prefix,t.decode(`${mi.prefix}${r}`)]}case mi.prefix:{const t=e||mi;return[mi.prefix,t.decode(r)]}case hd.prefix:{const t=e||hd;return[hd.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},SG=(r,e,t)=>{const{prefix:n}=t;if(n!==mi.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},AG=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Gl=112,$G=18,G7=(r,e,t)=>{const n=zp(r),s=n+zp(e),i=new Uint8Array(s+t.byteLength);return Bp(r,i,0),Bp(e,i,n),i.set(t,s),i},RG=Symbol.for("@ipld/js-cid/CID"),TG=c2({prefix:"\0",name:"identity",encode:r=>DK(r),decode:r=>xK(r)}),IG=Object.freeze(Object.defineProperty({__proto__:null,identity:TG},Symbol.toStringTag,{value:"Module"})),CG=Yt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),xG=Object.freeze(Object.defineProperty({__proto__:null,base2:CG},Symbol.toStringTag,{value:"Module"})),DG=Yt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),OG=Object.freeze(Object.defineProperty({__proto__:null,base8:DG},Symbol.toStringTag,{value:"Module"})),PG=gh({prefix:"9",name:"base10",alphabet:"0123456789"}),kG=Object.freeze(Object.defineProperty({__proto__:null,base10:PG},Symbol.toStringTag,{value:"Module"})),NG=Yt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),LG=Yt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),MG=Object.freeze(Object.defineProperty({__proto__:null,base16:NG,base16upper:LG},Symbol.toStringTag,{value:"Module"})),UG=gh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),BG=gh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),zG=Object.freeze(Object.defineProperty({__proto__:null,base36:UG,base36upper:BG},Symbol.toStringTag,{value:"Module"})),FG=Yt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),VG=Yt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),jG=Yt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),qG=Yt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),KG=Object.freeze(Object.defineProperty({__proto__:null,base64:FG,base64pad:VG,base64url:jG,base64urlpad:qG},Symbol.toStringTag,{value:"Module"})),LI=Array.from(""),GG=LI.reduce((r,e,t)=>(r[t]=e,r),[]),HG=LI.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function WG(r){return r.reduce((e,t)=>(e+=GG[t],e),"")}function QG(r){const e=[];for(const t of r){const n=HG[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const YG=c2({prefix:"",name:"base256emoji",encode:WG,decode:QG}),XG=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:YG},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const JG={...IG,...xG,...OG,...kG,...MG,...WK,...zG,...BK,...KG,...XG},Lg=Object.values(JG).map(r=>r.decoder);(function(){let r=Lg[0].or(Lg[1]);return Lg.slice(2).forEach(e=>r=r.or(e)),r})();globalThis&&globalThis.__classPrivateFieldGet;globalThis&&globalThis.__classPrivateFieldSet;sf("dns").code,sf("dns4").code,sf("dns6").code,sf("dnsaddr").code;class l2 extends Error{constructor(t,n,s){super(t);k(this,"code");k(this,"props");this.code=n,this.name=s?.name??"CodeError",this.props=s??{}}}function ZG(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var eH=ZG,tH=eH;const rH=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},nH=r=>new TextEncoder().encode(r),sH=r=>new TextDecoder().decode(r);let iH=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},oH=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return MI(this,e)}},aH=class{constructor(e){this.decoders=e}or(e){return MI(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const MI=(r,e)=>new aH({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let cH=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new iH(e,t,n),this.decoder=new oH(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const u2=({name:r,prefix:e,encode:t,decode:n})=>new cH(r,e,t,n),yh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=tH(t,e);return u2({prefix:r,name:e,encode:n,decode:i=>rH(s(i))})},lH=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},uH=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Xt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>u2({prefix:e,name:r,encode(s){return uH(s,n,t)},decode(s){return lH(s,n,t,r)}}),dH=yh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),hH=yh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),fH=Object.freeze(Object.defineProperty({__proto__:null,base58btc:dH,base58flickr:hH},Symbol.toStringTag,{value:"Module"})),pH=Xt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),gH=Xt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),yH=Xt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),wH=Xt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),bH=Xt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),mH=Xt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),EH=Xt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),vH=Xt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),_H=Xt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),SH=Object.freeze(Object.defineProperty({__proto__:null,base32:pH,base32hex:bH,base32hexpad:EH,base32hexpadupper:vH,base32hexupper:mH,base32pad:yH,base32padupper:wH,base32upper:gH,base32z:_H},Symbol.toStringTag,{value:"Module"})),AH=u2({prefix:"\0",name:"identity",encode:r=>sH(r),decode:r=>nH(r)}),$H=Object.freeze(Object.defineProperty({__proto__:null,identity:AH},Symbol.toStringTag,{value:"Module"})),RH=Xt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),TH=Object.freeze(Object.defineProperty({__proto__:null,base2:RH},Symbol.toStringTag,{value:"Module"})),IH=Xt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),CH=Object.freeze(Object.defineProperty({__proto__:null,base8:IH},Symbol.toStringTag,{value:"Module"})),xH=yh({prefix:"9",name:"base10",alphabet:"0123456789"}),DH=Object.freeze(Object.defineProperty({__proto__:null,base10:xH},Symbol.toStringTag,{value:"Module"})),OH=Xt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),PH=Xt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),kH=Object.freeze(Object.defineProperty({__proto__:null,base16:OH,base16upper:PH},Symbol.toStringTag,{value:"Module"})),NH=yh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),LH=yh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),MH=Object.freeze(Object.defineProperty({__proto__:null,base36:NH,base36upper:LH},Symbol.toStringTag,{value:"Module"})),UH=Xt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),BH=Xt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),zH=Xt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),FH=Xt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),VH=Object.freeze(Object.defineProperty({__proto__:null,base64:UH,base64pad:BH,base64url:zH,base64urlpad:FH},Symbol.toStringTag,{value:"Module"})),UI=Array.from(""),jH=UI.reduce((r,e,t)=>(r[t]=e,r),[]),qH=UI.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function KH(r){return r.reduce((e,t)=>(e+=jH[t],e),"")}function GH(r){const e=[];for(const t of r){const n=qH[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const HH=u2({prefix:"",name:"base256emoji",encode:KH,decode:GH}),WH=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:HH},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const QH={...$H,...TH,...CH,...DH,...kH,...SH,...MH,...fH,...VH,...WH},An=-1,qw={},Kw={},YH=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,An,"ip6zone"],[43,8,"ipcidr"],[53,An,"dns",!0],[54,An,"dns4",!0],[55,An,"dns6",!0],[56,An,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,An,"unix",!1,!0],[421,An,"ipfs"],[421,An,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,An,"garlic64"],[448,0,"tls"],[449,An,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,An,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,An,"memory"]];YH.forEach(r=>{const e=XH(...r);Kw[e.code]=e,qw[e.name]=e});function XH(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function fa(r){if(typeof r=="number"){if(Kw[r]!=null)return Kw[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(qw[r]!=null)return qw[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}fa("ip4");fa("ip6");fa("ipcidr");const Mg=Object.values(QH).map(r=>r.decoder);(function(){let r=Mg[0].or(Mg[1]);return Mg.slice(2).forEach(e=>r=r.or(e)),r})();fa("dns").code,fa("dns4").code,fa("dns6").code,fa("dnsaddr").code;const JH=typeof navigator<"u"&&navigator.product==="ReactNative";function ZH(){return JH?"http://localhost":self.location?self.location.protocol+"//"+self.location.host:""}const fd=self.URL,BI=ZH();let eW=class{constructor(e="",t=BI){this.super=new fd(e,t),this.path=this.pathname+this.search,this.auth=this.username&&this.password?this.username+":"+this.password:null,this.query=this.search&&this.search.startsWith("?")?this.search.slice(1):null}get hash(){return this.super.hash}get host(){return this.super.host}get hostname(){return this.super.hostname}get href(){return this.super.href}get origin(){return this.super.origin}get password(){return this.super.password}get pathname(){return this.super.pathname}get port(){return this.super.port}get protocol(){return this.super.protocol}get search(){return this.super.search}get searchParams(){return this.super.searchParams}get username(){return this.super.username}set hash(e){this.super.hash=e}set host(e){this.super.host=e}set hostname(e){this.super.hostname=e}set href(e){this.super.href=e}set password(e){this.super.password=e}set pathname(e){this.super.pathname=e}set port(e){this.super.port=e}set protocol(e){this.super.protocol=e}set search(e){this.super.search=e}set username(e){this.super.username=e}static createObjectURL(e){return fd.createObjectURL(e)}static revokeObjectURL(e){fd.revokeObjectURL(e)}toJSON(){return this.super.toJSON()}toString(){return this.super.toString()}format(){return this.toString()}};function tW(r){if(typeof r=="string")return new fd(r).toString();if(!(r instanceof fd)){const e=r.username&&r.password?`${r.username}:${r.password}@`:"",t=r.auth?r.auth+"@":"",n=r.port?":"+r.port:"",s=r.protocol?r.protocol+"//":"",i=r.host||"",o=r.hostname||"",a=r.search||(r.query?"?"+r.query:""),c=r.hash||"",u=r.pathname||"",l=r.path||u+a;return`${s}${e||t}${i||o+n}${l}${c}`}}var zI={URLWithLegacySupport:eW,URLSearchParams:self.URLSearchParams,defaultBase:BI,format:tW};const{URLWithLegacySupport:H7,format:rW}=zI;var nW=(r,e={},t={},n)=>{let s=e.protocol?e.protocol.replace(":",""):"http";s=(t[s]||n||s)+":";let i;try{i=new H7(r)}catch{i={}}const o=Object.assign({},e,{protocol:s||i.protocol,host:e.host||i.host});return new H7(r,rW(o)).toString()};const{URLWithLegacySupport:sW,format:iW,URLSearchParams:oW,defaultBase:aW}=zI,cW=nW;var Cm={URL:sW,URLSearchParams:oW,format:iW,relative:cW,defaultBase:aW};const Fp=/^\/(ip[fn]s)\/([^/?#]+)/,FI=1,VI=2,jI=/^https?:\/\/([^/]+)\.(ip[fn]s)\.[^/?]+/,lW=/^(([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])\.)+([a-z0-9]|[a-z0-9][a-z0-9-]*[a-z0-9])$/;function xm(r){try{return GI(r)?!!Ng.parse(r):r instanceof Uint8Array?!!Ng.decode(r):!!Ng.asCID(r)}catch{return!1}}function qI(r,e,t=FI,n=VI){const s=HI(r);if(s===!1)return!1;const i=s.match(e);if(i==null||i[t]!=="ipfs")return!1;let o=i[n];return o!=null&&e===jI&&(o=o.toLowerCase()),xm(o)}function KI(r,e,t=FI,n=VI){const s=HI(r);if(s===!1)return!1;const i=s.match(e);if(i==null||i[t]!=="ipns")return!1;let o=i[n];if(o!=null&&e===jI){if(o=o.toLowerCase(),xm(o))return!0;try{!o.includes(".")&&o.includes("-")&&(o=o.replace(/--/g,"@").replace(/-/g,".").replace(/@/g,"-"));const{hostname:a}=new Cm.URL(`http://${o}`);return lW.test(a)}catch{return!1}}return!0}function GI(r){return typeof r=="string"}function HI(r){return r instanceof Uint8Array?C(r,"base58btc"):GI(r)?r:!1}const WI=r=>qI(r,Fp)||KI(r,Fp),uW=r=>qI(r,Fp),QI=r=>KI(r,Fp);let YI=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");const wi="/",XI=new TextEncoder().encode(wi),of=XI[0];class ie{constructor(e,t){if(typeof e=="string")this._buf=L(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==of)throw new Error("Invalid key")}toString(e="utf8"){return C(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new ie(e.join(wi))}static random(){return new ie(YI().replace(/-/g,""))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new ie(e):typeof e.uint8Array=="function"?new ie(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=XI),this._buf[0]!==of){const e=new Uint8Array(this._buf.byteLength+1);e.fill(of,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===of;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let s=0;s<t.length;s++){if(n.length<s+1)return!1;const i=t[s],o=n[s];if(i<o)return!0;if(i>o)return!1}return t.length<n.length}reverse(){return ie.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(wi).slice(1)}type(){return dW(this.baseNamespace())}name(){return hW(this.baseNamespace())}instance(e){return new ie(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(wi)||(e+=wi),e+=this.type(),new ie(e)}parent(){const e=this.list();return e.length===1?new ie(wi):new ie(e.slice(0,-1).join(wi))}child(e){return this.toString()===wi?e:e.toString()===wi?this:new ie(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return ie.withNamespaces([...this.namespaces(),...fW(e.map(t=>t.namespaces()))])}}function dW(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function hW(r){const e=r.split(":");return e[e.length-1]}function fW(r){return[].concat(...r)}var Dm={exports:{}};function JI(r){const e=new globalThis.AbortController;function t(){e.abort();for(const n of r)!n||!n.removeEventListener||n.removeEventListener("abort",t)}for(const n of r)if(!(!n||!n.addEventListener)){if(n.aborted){t();break}n.addEventListener("abort",t)}return e.signal}Dm.exports=JI;var Xs=Dm.exports.anySignal=JI,pW=Dm.exports;let gW=/(-?(?:\d+\.?\d*|\d*\.?\d+)(?:e[-+]?\d+)?)\s*([\p{L}]*)/uig;fe.nanosecond=fe.ns=1/1e6;fe.s=fe.s=fe.us=fe.microsecond=1/1e3;fe.millisecond=fe.ms=fe[""]=1;fe.second=fe.sec=fe.s=fe.ms*1e3;fe.minute=fe.min=fe.m=fe.s*60;fe.hour=fe.hr=fe.h=fe.m*60;fe.day=fe.d=fe.h*24;fe.week=fe.wk=fe.w=fe.d*7;fe.month=fe.b=fe.d*(365.25/12);fe.year=fe.yr=fe.y=fe.d*365.25;function fe(r="",e="ms"){var t=null;r=(r+"").replace(/(\d)[,_](\d)/g,"$1$2");var n=r[0]==="-";return r.replace(gW,function(s,i,o){o=W7(o),o&&(t=(t||0)+Math.abs(parseFloat(i,10))*o)}),t&&t/(W7(e)||1)*(n?-1:1)}function W7(r){return fe[r]||fe[r.toLowerCase().replace(/s$/,"")]}let rp=class ZI extends Error{constructor(e="request timed out"){super(e),this.name="TimeoutError",this.code=ZI.code}};rp.code="ERR_TIMEOUT";function F(r,e){return(...t)=>{const n=t[e??t.length-1];if(!n||!n.timeout)return r(...t);const s=typeof n.timeout=="string"?fe(n.timeout):n.timeout,i=new ft.TimeoutController(s);n.signal=Xs([n.signal,i.signal]);const o=r(...t),a=new Promise((l,d)=>{i.signal.addEventListener("abort",()=>{d(new rp)})}),c=Date.now(),u=()=>{if(i.signal.aborted)throw new rp;if(Date.now()-c>s)throw i.abort(),new rp};return o[Symbol.asyncIterator]?async function*(){const l=o[Symbol.asyncIterator]();try{for(;;){const{value:d,done:f}=await Promise.race([l.next(),a]);if(f)break;u(),yield d}}catch(d){throw u(),d}finally{i.clear(),l.return&&l.return()}}():(async()=>{try{const l=await Promise.race([o,a]);return u(),l}catch(l){throw u(),l}finally{i.clear()}})()}}var yW=eC,Q7=128,wW=127,bW=~wW,mW=Math.pow(2,31);function eC(r,e,t){e=e||[],t=t||0;for(var n=t;r>=mW;)e[t++]=r&255|Q7,r/=128;for(;r&bW;)e[t++]=r&255|Q7,r>>>=7;return e[t]=r|0,eC.bytes=t-n+1,e}var EW=Gw,vW=128,Y7=127;function Gw(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Gw.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Y7)<<s:(o&Y7)*Math.pow(2,s),s+=7}while(o>=vW);return Gw.bytes=i-n,t}var _W=Math.pow(2,7),SW=Math.pow(2,14),AW=Math.pow(2,21),$W=Math.pow(2,28),RW=Math.pow(2,35),TW=Math.pow(2,42),IW=Math.pow(2,49),CW=Math.pow(2,56),xW=Math.pow(2,63),DW=function(r){return r<_W?1:r<SW?2:r<AW?3:r<$W?4:r<RW?5:r<TW?6:r<IW?7:r<CW?8:r<xW?9:10},OW={encode:yW,decode:EW,encodingLength:DW},Vp=OW;const Hw=(r,e=0)=>[Vp.decode(r,e),Vp.decode.bytes],jp=(r,e,t=0)=>(Vp.encode(r,e,t),e),qp=r=>Vp.encodingLength(r),PW=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Om=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},kW=r=>new TextEncoder().encode(r),NW=r=>new TextDecoder().decode(r),LW=(r,e)=>{const t=e.byteLength,n=qp(r),s=n+qp(t),i=new Uint8Array(s+t);return jp(r,i,0),jp(t,i,n),i.set(e,s),new Pm(r,t,e,i)},tC=r=>{const e=Om(r),[t,n]=Hw(e),[s,i]=Hw(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Pm(t,s,o,e)},MW=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&PW(r.bytes,t.bytes)}};let Pm=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function UW(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var BW=UW,zW=BW;let FW=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},VW=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return rC(this,e)}},jW=class{constructor(e){this.decoders=e}or(e){return rC(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const rC=(r,e)=>new jW({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let qW=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new FW(e,t,n),this.decoder=new VW(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const d2=({name:r,prefix:e,encode:t,decode:n})=>new qW(r,e,t,n),wh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=zW(t,e);return d2({prefix:r,name:e,encode:n,decode:i=>Om(s(i))})},KW=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},GW=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Jt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>d2({prefix:e,name:r,encode(s){return GW(s,n,t)},decode(s){return KW(s,n,t,r)}}),fs=wh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),HW=wh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),WW=Object.freeze(Object.defineProperty({__proto__:null,base58btc:fs,base58flickr:HW},Symbol.toStringTag,{value:"Module"})),va=Jt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),QW=Jt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),YW=Jt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),XW=Jt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),JW=Jt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),ZW=Jt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),eQ=Jt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),tQ=Jt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),rQ=Jt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),nQ=Object.freeze(Object.defineProperty({__proto__:null,base32:va,base32hex:JW,base32hexpad:eQ,base32hexpadupper:tQ,base32hexupper:ZW,base32pad:YW,base32padupper:XW,base32upper:QW,base32z:rQ},Symbol.toStringTag,{value:"Module"})),X7=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return iQ(t,Ww(r),e||fs.encoder);default:return oQ(t,Ww(r),e||va.encoder)}},J7=new WeakMap,Ww=r=>{const e=J7.get(r);if(e==null){const t=new Map;return J7.set(r,t),t}return e};let _a=class gr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Hl)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==aQ)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return gr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=LW(e,t);return gr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return gr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&MW(e.multihash,n.multihash)}toString(e){return X7(this,e)}toJSON(){return{"/":X7(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof gr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new gr(n,s,i,o||Z7(n,s,i.bytes))}else if(t[cQ]===!0){const{version:n,multihash:s,code:i}=t,o=tC(s);return gr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Hl)throw new Error(`Version 0 CID must use dag-pb (code: ${Hl}) block encoding`);return new gr(e,t,n,n.bytes)}case 1:{const s=Z7(e,t,n.bytes);return new gr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return gr.create(0,Hl,e)}static createV1(e,t){return gr.create(1,e,t)}static decode(e){const[t,n]=gr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=gr.inspectBytes(e),n=t.size-t.multihashSize,s=Om(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Pm(t.multihashCode,t.digestSize,i,s);return[t.version===0?gr.createV0(o):gr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Hw(e.subarray(t));return t+=f,d};let s=n(),i=Hl;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=sQ(e,t),i=gr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Ww(i).set(n,e),i}};const sQ=(r,e)=>{switch(r[0]){case"Q":{const t=e||fs;return[fs.prefix,t.decode(`${fs.prefix}${r}`)]}case fs.prefix:{const t=e||fs;return[fs.prefix,t.decode(r)]}case va.prefix:{const t=e||va;return[va.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},iQ=(r,e,t)=>{const{prefix:n}=t;if(n!==fs.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},oQ=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Hl=112,aQ=18,Z7=(r,e,t)=>{const n=qp(r),s=n+qp(e),i=new Uint8Array(s+t.byteLength);return jp(r,i,0),jp(e,i,n),i.set(t,s),i},cQ=Symbol.for("@ipld/js-cid/CID"),eE="/ipfs/";function bh(r){if(r instanceof Uint8Array)try{r=_a.decode(r)}catch(s){throw $(s,"ERR_INVALID_CID")}let e=_a.asCID(r);if(e)return{cid:e,path:void 0};r=r.toString(),r.startsWith(eE)&&(r=r.substring(eE.length));const t=r.split("/");let n;try{e=_a.parse(t.shift()||"")}catch(s){throw $(s,"ERR_INVALID_CID")}return t.length&&(n=`/${t.join("/")}`),{cid:e,path:n}}const lQ="ERR_BAD_PATH",nC="This command must be run in online mode. Try running 'ipfs daemon' first.",Qw=new ie("/local/filesroot"),uQ=262144,dQ=r=>{if(ne.asCID(r))return`/ipfs/${r}`;const t=r.toString();try{return`/ipfs/${ne.parse(t)}`}catch{}if(WI(t))return t;throw $(new Error(`invalid path: ${r}`),lQ)},km=r=>r instanceof Uint8Array?ne.decode(r).toString():(r=r.toString(),r.indexOf("/ipfs/")===0&&(r=r.substring(6)),r.charAt(r.length-1)==="/"&&(r=r.substring(0,r.length-1)),r),h2=async function(r,e,t,n={}){const{cid:s,path:i}=bh(t);i&&(n.path=i);let o=s,a=n.path||"";if(a.startsWith("/")&&(a=a.substring(1)),n.path)try{for await(const{value:c,remainderPath:u}of Od(s,n.path,e,r,{signal:n.signal})){if(!ne.asCID(c))break;a=u,o=c}}catch(c){throw c.message.startsWith("Object has no property")&&(c.message=`no link named "${a.split("/")[0]}" under ${o}`,c.code="ERR_NO_LINK"),c}return{cid:o,remainderPath:a||""}},tE=r=>{if(r.type!=="file"&&r.type!=="directory"&&r.type!=="raw")throw new Error(`Unknown node type '${r.type}'`);const e={cid:r.cid,path:r.path,name:r.name,size:r.size,type:"file"};return r.type==="directory"&&(e.type="dir"),r.type==="file"&&(e.size=r.unixfs.fileSize()),(r.type==="file"||r.type==="directory")&&(e.mode=r.unixfs.mode,r.unixfs.mtime!==void 0&&(e.mtime=r.unixfs.mtime)),e},hQ=F(async(r,e)=>await r),Od=async function*(r,e,t,n,s){const i=async u=>{const l=await t.getCodec(u.code),d=await n.blocks.get(u,s);return l.decode(d)},o=e.split("/").filter(Boolean);let a=await i(r),c=r;for(;o.length;){const u=o.shift();if(!u)throw $(new Error(`Could not resolve path "${e}"`),"ERR_INVALID_PATH");if(r.code===ht&&Array.isArray(a.Links)){const l=a.Links.find(d=>d.Name===u);if(l){yield{value:l.Hash,remainderPath:o.join("/")},a=await i(l.Hash),c=l.Hash;continue}}if(Object.prototype.hasOwnProperty.call(a,u))a=a[u],yield{value:a,remainderPath:o.join("/")};else throw $(new Error(`no link named "${u}" under ${c}`),"ERR_NO_LINK");ne.asCID(a)&&(c=a,a=await i(a))}yield{value:a,remainderPath:""}};class us{static create({start:e,stop:t}){return new us(e,t)}static async start(e,t){const{state:n,activate:s}=e;switch(n.status){case"stopped":try{const i=s(t);e.state={status:"starting",ready:i};const o=await i;return e.state={status:"started",value:o},o}catch(i){throw e.state={status:"stopped"},i}case"starting":throw new o2;case"started":throw new a2;case"stopping":return await n.ready,await us.start(e,t);default:return us.panic(e)}}static async stop(e){const{state:t,deactivate:n}=e;switch(t.status){case"stopped":break;case"starting":{try{await t.ready}catch{}return await us.stop(e)}case"stopping":return await t.ready;case"started":{n&&await n(t.value),e.state={status:"stopped"};break}default:us.panic(t)}}static try({state:e}){switch(e.status){case"started":return e.value;default:return null}}static async use({state:e},t){switch(e.status){case"started":return e.value;case"starting":return await hQ(e.ready,t);default:throw new ph}}static panic({state:e}){const t=JSON.stringify({status:e.status});throw RangeError(`Service in invalid state ${t}, should never happen if you see this please report a bug`)}constructor(e,t){this.activate=e,this.deactivate=t,this.state={status:"stopped"}}async use(e){return await us.use(this,e)}try(){return us.try(this)}}function fQ({network:r,preload:e,peerId:t,keychain:n,repo:s,ipns:i,mfsPreload:o,print:a,hashers:c,options:u}){return async()=>{const{libp2p:d}=await us.start(r,{peerId:t,repo:s,print:a,hashers:c,options:u});await Promise.all([i.startOnline({keychain:n,libp2p:d,peerId:t,repo:s}),e.start(),o.start()])}}function pQ({network:r,preload:e,ipns:t,repo:n,mfsPreload:s}){return async()=>{await Promise.all([e.stop(),t.stop(),s.stop()]),await us.stop(r),await n.close()}}var gQ=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function s(i,o){t[i]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||n[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),n[i]!==void 0&&(n[i]=void 0)},get:function(i){var o=t[i];if(o!==void 0)return o;if((o=n[i])!==void 0)return s(i,o),o},set:function(i,o){t[i]!==void 0?t[i]=o:s(i,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}};const f2=Ge(gQ);let yQ=class{constructor(e){this.lru=f2(e)}get(e){const t=this.lru.get(e);if(t){if(t.expire&&t.expire<Date.now()){this.lru.remove(e);return}return t.value}}set(e,t,n){this.lru.set(e,{value:t,expire:Date.now()+n})}has(e){return!!this.get(e)}remove(e){this.lru.remove(e)}clear(){this.lru.clear()}};var mh={};let wQ=class extends Error{constructor(e="Request timed out"){super(e),this.name="TimeoutError"}};mh.TimeoutError=wQ;let bQ=class extends Error{constructor(e="The operation was aborted."){super(e),this.name="AbortError"}};mh.AbortError=bQ;let mQ=class extends Error{constructor(e){super(e.statusText),this.name="HTTPError",this.response=e}};mh.HTTPError=mQ;var Yw={exports:{}},af={exports:{}},rE;function cf(){return rE||(rE=1,function(r,e){var t=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof fn<"u")return fn;throw new Error("unable to locate global object")},n=t();r.exports=e=n.fetch,n.fetch&&(e.default=n.fetch.bind(n)),e.Headers=n.Headers,e.Request=n.Request,e.Response=n.Response}(af,af.exports)),af.exports}globalThis.fetch&&globalThis.Headers&&globalThis.Request&&globalThis.Response?Yw.exports={default:globalThis.fetch,Headers:globalThis.Headers,Request:globalThis.Request,Response:globalThis.Response}:Yw.exports={default:cf().default,Headers:cf().Headers,Request:cf().Request,Response:cf().Response};var EQ=Yw.exports,vQ=EQ;const{TimeoutError:_Q,AbortError:SQ}=mh,{Response:sC,Request:AQ,Headers:Nm,default:$Q}=vQ,RQ=(r,e={})=>{const t=new XMLHttpRequest;t.open(e.method||"GET",r.toString(),!0);const{timeout:n,headers:s}=e;if(n&&n>0&&n<1/0&&(t.timeout=n),e.overrideMimeType!=null&&t.overrideMimeType(e.overrideMimeType),s)for(const[i,o]of new Nm(s))t.setRequestHeader(i,o);return e.signal&&(e.signal.onabort=()=>t.abort()),e.onUploadProgress&&(t.upload.onprogress=e.onUploadProgress),t.responseType="arraybuffer",new Promise((i,o)=>{const a=c=>{switch(c.type){case"error":{i(sC.error());break}case"load":{i(new xQ(t.responseURL,t.response,{status:t.status,statusText:t.statusText,headers:CQ(t.getAllResponseHeaders())}));break}case"timeout":{o(new _Q);break}case"abort":{o(new SQ);break}}};t.onerror=a,t.onload=a,t.ontimeout=a,t.onabort=a,t.send(e.body)})},TQ=$Q,IQ=(r,e={})=>e.onUploadProgress!=null?RQ(r,e):TQ(r,e),CQ=r=>{const e=new Nm;for(const t of r.trim().split(/[\r\n]+/)){const n=t.indexOf(": ");n>0&&e.set(t.slice(0,n),t.slice(n+1))}return e};class xQ extends sC{constructor(e,t,n){super(t,n),Object.defineProperty(this,"url",{value:e})}}var DQ={fetch:IQ,Request:AQ,Headers:Nm};const OQ=QM(mz);async function*PQ(r,e={}){const t=r.getReader();try{for(;;){const n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&t.cancel(),t.releaseLock()}}var kQ=PQ;const NQ=async r=>{const e=[];for await(const t of r)e.push(t);return e};var LQ=NQ;const{fetch:MQ,Request:UQ,Headers:BQ}=DQ,{TimeoutError:Xw,HTTPError:iC}=mh,nE=OQ.bind({ignoreUndefined:!0}),{URL:sE,URLSearchParams:iE}=Cm,zQ=pW,FQ=kQ,{isBrowser:VQ,isWebWorker:jQ}=Pi,qQ=LQ,KQ=(r,e,t)=>{if(e===void 0)return r;const n=Date.now(),s=()=>Date.now()-n>=e;return new Promise((i,o)=>{const a=setTimeout(()=>{s()&&(o(new Xw),t.abort())},e),c=u=>d=>{if(clearTimeout(a),s()){o(new Xw);return}u(d)};r.then(c(i),c(o))})},GQ={throwHttpErrors:!0,credentials:"same-origin"};let an=class{constructor(e={}){this.opts=nE(GQ,e)}async fetch(e,t={}){const n=nE(this.opts,t),s=new BQ(n.headers);if(typeof e!="string"&&!(e instanceof sE||e instanceof UQ))throw new TypeError("`resource` must be a string, URL, or Request");const i=new sE(e.toString(),n.base),{searchParams:o,transformSearchParams:a,json:c}=n;o&&(typeof a=="function"?i.search=a(new iE(n.searchParams)):i.search=new iE(n.searchParams)),c&&(n.body=JSON.stringify(n.json),s.set("content-type","application/json"));const u=new AbortController,l=zQ([u.signal,n.signal]);globalThis.ReadableStream!=null&&n.body instanceof globalThis.ReadableStream&&(VQ||jQ)&&(n.body=new Blob(await qQ(FQ(n.body))));const d=await KQ(MQ(i.toString(),{...n,signal:l,timeout:void 0,headers:s,duplex:"half"}),n.timeout,u);if(!d.ok&&n.throwHttpErrors)throw n.handleError&&await n.handleError(d),new iC(d);return d.iterator=async function*(){yield*oC(d.body)},d.ndjson=async function*(){for await(const f of HQ(d.iterator()))t.transform?yield t.transform(f):yield f},d}post(e,t={}){return this.fetch(e,{...t,method:"POST"})}get(e,t={}){return this.fetch(e,{...t,method:"GET"})}put(e,t={}){return this.fetch(e,{...t,method:"PUT"})}delete(e,t={}){return this.fetch(e,{...t,method:"DELETE"})}options(e,t={}){return this.fetch(e,{...t,method:"OPTIONS"})}};const HQ=async function*(r){const e=new TextDecoder;let t="";for await(const n of r){t+=e.decode(n,{stream:!0});const s=t.split(/\r?\n/);for(let i=0;i<s.length-1;i++){const o=s[i].trim();o.length>0&&(yield JSON.parse(o))}t=s[s.length-1]}t+=e.decode(),t=t.trim(),t.length!==0&&(yield JSON.parse(t))},oC=r=>{if(WQ(r))return r;if(YQ(r)){const e=r[Symbol.asyncIterator]();return{[Symbol.asyncIterator](){return{next:e.next.bind(e),return(t){return r.destroy(),typeof e.return=="function"?e.return():Promise.resolve({done:!0,value:t})}}}}}if(QQ(r)){const e=r.getReader();return async function*(){try{for(;;){const{done:t,value:n}=await e.read();if(t)return;n&&(yield n)}}finally{e.releaseLock()}}()}throw new TypeError("Body can't be converted to AsyncIterable")},WQ=r=>typeof r=="object"&&r!==null&&typeof r[Symbol.asyncIterator]=="function",QQ=r=>r&&typeof r.getReader=="function",YQ=r=>Object.prototype.hasOwnProperty.call(r,"readable")&&Object.prototype.hasOwnProperty.call(r,"writable");an.HTTPError=iC;an.TimeoutError=Xw;an.streamToAsyncIterator=oC;an.post=(r,e)=>new an(e).post(r,e);an.get=(r,e)=>new an(e).get(r,e);an.put=(r,e)=>new an(e).put(r,e);an.delete=(r,e)=>new an(e).delete(r,e);an.options=(r,e)=>new an(e).options(r,e);var XQ=an;const Ii=Ge(XQ),Ug=new yQ(1e3),JQ=60*1e3,ZQ=zt.default?zt.default:zt,eY=new ZQ({concurrency:4}),oE=r=>{if(r.Path)return r.Path;throw new Error(r.Message)};async function tY(r,e){return(async(n,s={})=>{const i=new URLSearchParams(s);i.set("arg",n);const o=i.toString();if(!s.nocache&&Ug.has(o)){const c=Ug.get(o);return oE(c)}const a=await eY.add(async()=>{const c=await Ii.get("https://ipfs.io/api/v0/dns",{searchParams:i}),u=new URL(c.url).search.slice(1),l=await c.json();return Ug.set(u,l,JQ),l});return oE(a)})(r,e)}function rY(r){return r.endsWith(".eth")&&(r=r.replace(/.eth$/,".eth.link")),r}function nY(){return F(async(e,t={recursive:!0})=>{if(typeof e!="string")throw new Error("Invalid arguments, domain must be a string");return e=rY(e),tY(e,t)})}function sY({network:r}){return()=>{const e=r.try();return e!=null&&!!e.libp2p.isStarted()}}const aC=Symbol.for("@libp2p/peer-id");function xi(r){return r!=null&&!!r[aC]}function iY(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var oY=iY,aY=oY;const cY=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},p2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},lY=r=>new TextEncoder().encode(r),uY=r=>new TextDecoder().decode(r);let dY=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},hY=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return cC(this,e)}},fY=class{constructor(e){this.decoders=e}or(e){return cC(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const cC=(r,e)=>new fY({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let pY=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new dY(e,t,n),this.decoder=new hY(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const g2=({name:r,prefix:e,encode:t,decode:n})=>new pY(r,e,t,n),Eh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=aY(t,e);return g2({prefix:r,name:e,encode:n,decode:i=>p2(s(i))})},gY=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},yY=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Zt=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>g2({prefix:e,name:r,encode(s){return yY(s,n,t)},decode(s){return gY(s,n,t,r)}}),ps=Eh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),wY=Eh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),bY=Object.freeze(Object.defineProperty({__proto__:null,base58btc:ps,base58flickr:wY},Symbol.toStringTag,{value:"Module"})),mY=g2({prefix:"\0",name:"identity",encode:r=>uY(r),decode:r=>lY(r)}),EY=Object.freeze(Object.defineProperty({__proto__:null,identity:mY},Symbol.toStringTag,{value:"Module"})),vY=Zt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),_Y=Object.freeze(Object.defineProperty({__proto__:null,base2:vY},Symbol.toStringTag,{value:"Module"})),SY=Zt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),AY=Object.freeze(Object.defineProperty({__proto__:null,base8:SY},Symbol.toStringTag,{value:"Module"})),$Y=Eh({prefix:"9",name:"base10",alphabet:"0123456789"}),RY=Object.freeze(Object.defineProperty({__proto__:null,base10:$Y},Symbol.toStringTag,{value:"Module"})),TY=Zt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),IY=Zt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),CY=Object.freeze(Object.defineProperty({__proto__:null,base16:TY,base16upper:IY},Symbol.toStringTag,{value:"Module"})),pd=Zt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),xY=Zt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),DY=Zt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),OY=Zt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),PY=Zt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),kY=Zt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),NY=Zt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),LY=Zt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),MY=Zt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),UY=Object.freeze(Object.defineProperty({__proto__:null,base32:pd,base32hex:PY,base32hexpad:NY,base32hexpadupper:LY,base32hexupper:kY,base32pad:DY,base32padupper:OY,base32upper:xY,base32z:MY},Symbol.toStringTag,{value:"Module"})),BY=Eh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),zY=Eh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),FY=Object.freeze(Object.defineProperty({__proto__:null,base36:BY,base36upper:zY},Symbol.toStringTag,{value:"Module"})),VY=Zt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),jY=Zt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),qY=Zt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),KY=Zt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),GY=Object.freeze(Object.defineProperty({__proto__:null,base64:VY,base64pad:jY,base64url:qY,base64urlpad:KY},Symbol.toStringTag,{value:"Module"})),lC=Array.from(""),HY=lC.reduce((r,e,t)=>(r[t]=e,r),[]),WY=lC.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function QY(r){return r.reduce((e,t)=>(e+=HY[t],e),"")}function YY(r){const e=[];for(const t of r){const n=WY[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const XY=g2({prefix:"",name:"base256emoji",encode:QY,decode:YY}),JY=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:XY},Symbol.toStringTag,{value:"Module"}));var ZY=uC,aE=128,eX=127,tX=~eX,rX=Math.pow(2,31);function uC(r,e,t){e=e||[],t=t||0;for(var n=t;r>=rX;)e[t++]=r&255|aE,r/=128;for(;r&tX;)e[t++]=r&255|aE,r>>>=7;return e[t]=r|0,uC.bytes=t-n+1,e}var nX=Jw,sX=128,cE=127;function Jw(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Jw.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&cE)<<s:(o&cE)*Math.pow(2,s),s+=7}while(o>=sX);return Jw.bytes=i-n,t}var iX=Math.pow(2,7),oX=Math.pow(2,14),aX=Math.pow(2,21),cX=Math.pow(2,28),lX=Math.pow(2,35),uX=Math.pow(2,42),dX=Math.pow(2,49),hX=Math.pow(2,56),fX=Math.pow(2,63),pX=function(r){return r<iX?1:r<oX?2:r<aX?3:r<cX?4:r<lX?5:r<uX?6:r<dX?7:r<hX?8:r<fX?9:10},gX={encode:ZY,decode:nX,encodingLength:pX},Kp=gX;const Zw=(r,e=0)=>[Kp.decode(r,e),Kp.decode.bytes],Gp=(r,e,t=0)=>(Kp.encode(r,e,t),e),Hp=r=>Kp.encodingLength(r),sl=(r,e)=>{const t=e.byteLength,n=Hp(r),s=n+Hp(t),i=new Uint8Array(s+t);return Gp(r,i,0),Gp(t,i,n),i.set(e,s),new Mm(r,t,e,i)},Lm=r=>{const e=p2(r),[t,n]=Zw(e),[s,i]=Zw(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Mm(t,s,o,e)},yX=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&cY(r.bytes,t.bytes)}};let Mm=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const wX=({name:r,code:e,encode:t})=>new bX(r,e,t);let bX=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?sl(this.code,t):t.then(n=>sl(this.code,n))}else throw Error("Unknown type, must be binary type")}};const mX=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Um=wX({name:"sha2-256",code:18,encode:mX("SHA-256")}),dC=0,EX="identity",hC=p2,vX=r=>sl(dC,hC(r)),Wp={code:dC,name:EX,encode:hC,digest:vX};new TextEncoder;new TextDecoder;const lE=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return SX(t,eb(r),e||ps.encoder);default:return AX(t,eb(r),e||pd.encoder)}},uE=new WeakMap,eb=r=>{const e=uE.get(r);if(e==null){const t=new Map;return uE.set(r,t),t}return e};let fC=class yr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Wl)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==$X)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return yr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=sl(e,t);return yr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return yr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&yX(e.multihash,n.multihash)}toString(e){return lE(this,e)}toJSON(){return{"/":lE(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof yr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new yr(n,s,i,o||dE(n,s,i.bytes))}else if(t[RX]===!0){const{version:n,multihash:s,code:i}=t,o=Lm(s);return yr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Wl)throw new Error(`Version 0 CID must use dag-pb (code: ${Wl}) block encoding`);return new yr(e,t,n,n.bytes)}case 1:{const s=dE(e,t,n.bytes);return new yr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return yr.create(0,Wl,e)}static createV1(e,t){return yr.create(1,e,t)}static decode(e){const[t,n]=yr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=yr.inspectBytes(e),n=t.size-t.multihashSize,s=p2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Mm(t.multihashCode,t.digestSize,i,s);return[t.version===0?yr.createV0(o):yr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Zw(e.subarray(t));return t+=f,d};let s=n(),i=Wl;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=_X(e,t),i=yr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return eb(i).set(n,e),i}};const _X=(r,e)=>{switch(r[0]){case"Q":{const t=e||ps;return[ps.prefix,t.decode(`${ps.prefix}${r}`)]}case ps.prefix:{const t=e||ps;return[ps.prefix,t.decode(r)]}case pd.prefix:{const t=e||pd;return[pd.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},SX=(r,e,t)=>{const{prefix:n}=t;if(n!==ps.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},AX=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Wl=112,$X=18,dE=(r,e,t)=>{const n=Hp(r),s=n+Hp(e),i=new Uint8Array(s+t.byteLength);return Gp(r,i,0),Gp(e,i,n),i.set(t,s),i},RX=Symbol.for("@ipld/js-cid/CID"),hE={...EY,..._Y,...AY,...RY,...CY,...UY,...FY,...bY,...GY,...JY},TX=Symbol.for("nodejs.util.inspect.custom"),IX=Object.values(hE).map(r=>r.decoder).reduce((r,e)=>r.or(e),hE.identity.decoder),pC=114,Bm=36,zm=37;var uVe;let Fm=class{constructor(e){k(this,"type");k(this,"multihash");k(this,"privateKey");k(this,"publicKey");k(this,"string");k(this,uVe,!0);this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=ps.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return fC.createV1(pC,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(e instanceof Uint8Array)return me(this.multihash.bytes,e);if(typeof e=="string")return de(e).equals(this);if(e?.multihash?.bytes!=null)return me(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[(uVe=aC,TX)](){return`PeerId(${this.toString()})`}},vh=class extends Fm{constructor(t){super({...t,type:"RSA"});k(this,"type","RSA");k(this,"publicKey");this.publicKey=t.publicKey}},_h=class extends Fm{constructor(t){super({...t,type:"Ed25519"});k(this,"type","Ed25519");k(this,"publicKey");this.publicKey=t.multihash.digest}},Sh=class extends Fm{constructor(t){super({...t,type:"secp256k1"});k(this,"type","secp256k1");k(this,"publicKey");this.publicKey=t.multihash.digest}};function Gt(r){if(r.type==="RSA")return new vh(r);if(r.type==="Ed25519")return new _h(r);if(r.type==="secp256k1")return new Sh(r);throw new B("Not a PeerId","ERR_INVALID_PARAMETERS")}function de(r,e){if(r.charAt(0)==="1"||r.charAt(0)==="Q"){const t=Lm(ps.decode(`z${r}`));return r.startsWith("12D")?new _h({multihash:t}):r.startsWith("16U")?new Sh({multihash:t}):new vh({multihash:t})}return ni(IX.decode(r))}function ni(r){try{const e=Lm(r);if(e.code===Wp.code){if(e.digest.length===Bm)return new _h({multihash:e});if(e.digest.length===zm)return new Sh({multihash:e})}if(e.code===Um.code)return new vh({multihash:e})}catch{return CX(fC.decode(r))}throw new Error("Supplied PeerID CID is invalid")}function CX(r){if(r==null||r.multihash==null||r.version==null||r.version===1&&r.code!==pC)throw new Error("Supplied PeerID CID is invalid");const e=r.multihash;if(e.code===Um.code)return new vh({multihash:r.multihash});if(e.code===Wp.code){if(e.digest.length===Bm)return new _h({multihash:r.multihash});if(e.digest.length===zm)return new Sh({multihash:r.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function rs(r,e){return r.length===Bm?new _h({multihash:sl(Wp.code,r),privateKey:e}):r.length===zm?new Sh({multihash:sl(Wp.code,r),privateKey:e}):new vh({multihash:await Um.digest(r),publicKey:r,privateKey:e})}function xX({repo:r,codecs:e,bases:t,name:n}){async function s(i,o={}){if(!WI(i))throw new Error("invalid argument "+i);if(QI(i))for await(const w of n.resolve(i,o))i=w;const[,a,c,...u]=i.split("/"),l=o.cidBase?await t.getBase(o.cidBase):void 0,d=DX(c);if(u.length===0){const w=l?l.encoder.encode(d):c;return`/${a}/${w}`}const f=ne.decode(d);i=u.join("/");const g=Od(f,i,e,r,o);let h=f,p=i;for await(const w of g)ne.asCID(w.value)&&(h=w.value,p=w.remainderPath);return`/ipfs/${h.toString(l&&l.encoder)}${p?"/"+p:""}`}return F(s)}function DX(r){try{return de(r).toBytes()}catch{return ne.parse(r).bytes}}async function En(r){let e;for await(const t of r)e=t;return e}function OX({addAll:r}){return(e,t={})=>{let n;const s=ne.asCID(e);return s?n=r([{cid:s,...t}],t):n=r([{path:e.toString(),...t}],t),En(n)}}function PX(r){return Symbol.iterator in r}function kX(r){return Symbol.asyncIterator in r}function fE(r){return _a.asCID(r)!=null}async function*Ah(r){if(r==null)throw $(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT");const e=_a.asCID(r);if(e){yield jr({cid:e});return}if(r instanceof String||typeof r=="string"){yield jr({path:r});return}if(r.cid!=null||r.path!=null)return yield jr(r);if(PX(r)){const t=r[Symbol.iterator](),n=t.next();if(n.done)return t;if(fE(n.value)){yield jr({cid:n.value});for(const s of t)yield jr({cid:s});return}if(n.value instanceof String||typeof n.value=="string"){yield jr({path:n.value});for(const s of t)yield jr({path:s});return}if(n.value.cid!=null||n.value.path!=null){yield jr(n.value);for(const s of t)yield jr(s);return}throw $(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}if(kX(r)){const t=r[Symbol.asyncIterator](),n=await t.next();if(n.done)return t;if(fE(n.value)){yield jr({cid:n.value});for await(const s of t)yield jr({cid:s});return}if(n.value instanceof String||typeof n.value=="string"){yield jr({path:n.value});for await(const s of t)yield jr({path:s});return}if(n.value.cid!=null||n.value.path!=null){yield jr(n.value);for await(const s of t)yield jr(s);return}throw $(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}throw $(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}function jr(r){const e=r.cid||`${r.path}`;if(!e)throw $(new Error("Unexpected input: Please path either a CID or an IPFS path"),"ERR_UNEXPECTED_INPUT");const t={path:e,recursive:r.recursive!==!1};return r.metadata!=null&&(t.metadata=r.metadata),t}const De={direct:"direct",recursive:"recursive",indirect:"indirect",all:"all"};function NX({repo:r,codecs:e}){async function*t(n,s={}){const i=async function*(){for await(const{path:c,recursive:u,metadata:l}of Ah(n)){const{cid:d}=await h2(r,e,c),{reason:f}=await r.pins.isPinnedWithType(d,[De.recursive,De.direct]);if(f==="recursive"&&!u)throw new Error(`${d} already pinned recursively`);u?await r.pins.pinRecursively(d,{metadata:l}):await r.pins.pinDirectly(d,{metadata:l}),yield d}};if(!!!s.lock){yield*i();return}const a=await r.gcLock.readLock();try{yield*i()}finally{a()}}return F(t)}function Ql(r,e,t){const n={type:r,cid:e};return t&&(n.metadata=t),n}function LX({repo:r,codecs:e}){async function*t(n={}){let s=De.all;if(n.type&&(s=n.type,!Object.keys(De).includes(s)))throw $(new Error("Invalid pin type"),"ERR_INVALID_PIN_TYPE");if(n.paths){let i=!1;for await(const{path:o}of Ah(n.paths)){const{cid:a}=await h2(r,e,o),{reason:c,pinned:u,parent:l,metadata:d}=await r.pins.isPinnedWithType(a,s);if(!u)throw $(new Error(`path '${o}' is not pinned`),"ERR_NOT_PINNED");switch(c){case De.direct:case De.recursive:i=!0,yield Ql(c,a,d);break;default:i=!0,yield Ql(`${De.indirect} through ${l}`,a,d)}}if(!i)throw new Error("No match found");return}if(s===De.recursive||s===De.all)for await(const{cid:i,metadata:o}of r.pins.recursiveKeys())yield Ql(De.recursive,i,o);if(s===De.indirect||s===De.all)for await(const i of r.pins.indirectKeys(n))yield Ql(De.indirect,i);if(s===De.direct||s===De.all)for await(const{cid:i,metadata:o}of r.pins.directKeys())yield Ql(De.direct,i,o)}return F(t)}function MX({rmAll:r}){async function e(t,n={}){const s=await En(r([{path:t,...n}],n));if(!s)throw new Error("CID expected");return s}return e}function UX({repo:r,codecs:e}){async function*t(n,s={}){const i=await r.gcLock.readLock();try{for await(const{path:o,recursive:a}of Ah(n)){const{cid:c}=await h2(r,e,o),{pinned:u,reason:l}=await r.pins.isPinnedWithType(c,De.all);if(!u)throw new Error(`${c} is not pinned`);switch(l){case De.recursive:if(!a)throw new Error(`${c} is pinned recursively`);await r.pins.unpin(c),yield c;break;case De.direct:await r.pins.unpin(c),yield c;break;default:throw new Error(`${c} is pinned indirectly under ${l}`)}}}finally{i()}}return F(t)}class BX{constructor({codecs:e,repo:t}){const n=NX({codecs:e,repo:t});this.addAll=n,this.add=OX({addAll:n});const s=UX({codecs:e,repo:t});this.rmAll=s,this.rm=MX({rmAll:s}),this.ls=LX({codecs:e,repo:t}),this.remote={add:(i,o={})=>Promise.reject(new Error("Not implemented")),ls:async function*(i,o={}){return Promise.reject(new Error("Not implemented"))},rm:(i,o={})=>Promise.reject(new Error("Not implemented")),rmAll:(i,o={})=>Promise.reject(new Error("Not implemented")),service:{add:(i,o)=>Promise.reject(new Error("Not implemented")),rm:(i,o={})=>Promise.reject(new Error("Not implemented")),ls:(i={})=>Promise.reject(new Error("Not implemented"))}}}}function gC(r){return r=r||new Error("Cannot open database"),$(r,"ERR_DB_OPEN_FAILED")}function yC(r){return r=r||new Error("Delete failed"),$(r,"ERR_DB_DELETE_FAILED")}function tb(r){return r=r||new Error("Write failed"),$(r,"ERR_DB_WRITE_FAILED")}function Js(r){return r=r||new Error("Not Found"),$(r,"ERR_NOT_FOUND")}var wC={exports:{}};(function(r){(function(){r.exports=w;var e=86400,t=3200,n=146097*t/400,s=e*n,i=1e3*s,o=864e13,a=4294967296,c=1e6,u="000000000",l=Math.trunc||function(T){var P=T-T%1;return P==0&&(T<0||T===0&&1/T!=1/0)?-0:P},d=w.prototype,f=(w.fromDate=function(T){return new w(+T)},w.fromInt64BE=v(0,1,2,3,0,4),w.fromInt64LE=v(3,2,1,0,4,0),w.fromString=function(Y){var P,V=new w,Y=(Y+="").replace(/^\s*[+\-]?\d+/,function(se){var se=+se,Q=1970+(se-1970)%400;return V.year=se-Q,Q}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(te,se,Q){return se<0&&(Q*=-1),P=6e4*(60*+se+ +Q),""}).replace(/\.\d+$/,function(te){return V.nano=+(te+u).substr(1,9),""}).split(/\D+/);if(1<Y.length?Y[1]--:Y[1]=0,V.time=P=Date.UTC.apply(Date,Y)-(P||0),isNaN(P))throw new TypeError("Invalid Date");return y(V)},w.fromTimeT=function(T){return m(T,0)},d.year=0,d.time=0,d.nano=0,d.addNano=function(T){return this.nano+=+T||0,this},d.getNano=function(){var T=y(this);return(T.time%1e3*c+ +T.nano+1e9)%1e9},d.getTimeT=function(){var P=y(this),T=Math.floor(P.time/1e3),P=P.year;return P&&(T+=P*n*e/t),T},d.getYear=function(){return this.toDate().getUTCFullYear()+this.year},d.toDate=function(){return E(y(this).time)},d.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},d.toString=function(T){var P=this,V=P.toDate(),Y={H:function(){return _(V.getUTCHours())},L:function(){return A(V.getUTCMilliseconds(),3)},M:function(){return _(V.getUTCMinutes())},N:function(){return A(P.getNano(),9)},S:function(){return _(V.getUTCSeconds())},Y:function(){var te=P.getYear();return 999999<te?"+"+te:9999<te?"+"+A(te,6):0<=te?A(te,4):-999999<=te?"-"+A(-te,6):te},a:function(){return h[V.getUTCDay()]},b:function(){return g[V.getUTCMonth()]},d:function(){return _(V.getUTCDate())},e:function(){return function(te){return(9<te?"":" ")+(0|te)}(V.getUTCDate())},m:function(){return _(V.getUTCMonth()+1)}};return function te(se){return se.replace(/%./g,function(Q){var Ye=Q[1],ke=p[Ye],Ye=Y[Ye];return ke?te(ke):Ye?Ye():Q})}(T||f)},d.writeInt64BE=b(0,1,2,3,0,4),d.writeInt64LE=b(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),g=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],h=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],p={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return w;function w(T,P,V){var Y=this;if(!(Y instanceof w))return new w(T,P,V);Y.time=+T||0,Y.nano=+P||0,Y.year=+V||0,y(Y)}function y(T){var P,V,Y,te=T.year,se=T.time,Q=T.nano,ke=((Q<0||c<=Q)&&(Q-=(V=Math.floor(Q/c))*c,se+=V,V=1),te%t);return(se<-o||o<se||ke)&&((P=l(se/i))&&(te+=P*t,se-=P*i),(Y=E(se)).setUTCFullYear(ke+Y.getUTCFullYear()),Y=(se=+Y)+(P=l((te-=ke)/t))*i,P&&-o<=Y&&Y<=o&&(te-=P*t,se=Y),V=1),V&&(T.year=te,T.time=se,T.nano=Q),T}function E(T){var P=new Date(0);return P.setTime(T),P}function m(te,Y){te=+te||0;var V=l((Y=(Y|0)*a)/s)+l(te/s),Y=Y%s+te%s,te=l(Y/s);return te&&(V+=te,Y-=te*s),new w(1e3*Y,0,V*t)}function b(T,P,V,Y,te,se){return function(ke,Ye){var ai=y(this);ke=ke||new Array(8),S(ke,Ye|=0);var oc=Math.floor(ai.time/1e3),ai=ai.year*(n*e/t),oi=l(ai/a)+l(oc/a),ai=ai%a+oc%a,oc=Math.floor(ai/a);return oc&&(oi+=oc,ai-=oc*a),Q(ke,Ye+te,oi),Q(ke,Ye+se,ai),ke};function Q(ke,Ye,oi){ke[Ye+T]=oi>>24&255,ke[Ye+P]=oi>>16&255,ke[Ye+V]=oi>>8&255,ke[Ye+Y]=255&oi}}function v(T,P,V,Y,te,se){return function(ke,Ye){S(ke,Ye|=0);var oi=Q(ke,Ye+te);return m(Q(ke,Ye+se),oi)};function Q(ke,Ye){return 16777216*ke[Ye+T]+(ke[Ye+P]<<16|ke[Ye+V]<<8|ke[Ye+Y])}}function S(T,P){if(T=T&&T.length,T==null)throw new TypeError("Invalid Buffer");if(T<P+8)throw new RangeError("Out of range")}function _(T){return(9<T?"":"0")+(0|T)}function A(T,P){return(u+(0|T)).substr(-P)}})()})(wC);var zX=wC.exports;const FX=Ge(zX),bC=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let VX=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},jX=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return mC(this,e)}},qX=class{constructor(e){this.decoders=e}or(e){return mC(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const mC=(r,e)=>new qX({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let KX=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new VX(e,t,n),this.decoder=new jX(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const GX=({name:r,prefix:e,encode:t,decode:n})=>new KX(r,e,t,n),HX=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},WX=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Ni=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>GX({prefix:e,name:r,encode(s){return WX(s,n,t)},decode(s){return HX(s,n,t,r)}});Ni({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});const QX=Ni({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Ni({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Ni({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Ni({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Ni({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Ni({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Ni({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Ni({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const YX="ERR_IPNS_EXPIRED_RECORD",Vm="ERR_UNRECOGNIZED_VALIDITY",XX="ERR_SIGNATURE_CREATION",na="ERR_SIGNATURE_VERIFICATION",JX="ERR_UNRECOGNIZED_FORMAT",pE="ERR_UNDEFINED_PARAMETER",ZX="ERR_INVALID_RECORD_DATA",eJ="ERR_INVALID_EMBEDDED_KEY",tJ="ERR_MISSING_PRIVATE_KEY";function rJ(){ET._configure(),Y0._configure(vT),X0._configure(_T)}rJ();const EC=["uint64","int64","sint64","fixed64","sfixed64"];function nJ(r){for(const e of EC){if(r[e]==null)continue;const t=r[e];r[e]=function(){return BigInt(t.call(this).toString())}}return r}function sJ(r){return nJ(new Y0(r))}function iJ(r){for(const e of EC){if(r[e]==null)continue;const t=r[e];r[e]=function(n){return t.call(this,n.toString())}}return r}function oJ(){return iJ(X0.create())}function aJ(r,e){const t=sJ(r instanceof Uint8Array?r:r.subarray());return e.decode(t)}function cJ(r,e){const t=oJ();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var Qp;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(Qp||(Qp={}));function vC(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function lJ(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}const t=function(i,o){const a=e(i);o.int32(a)},n=function(i){const o=i.int32();return e(o)};return vC("enum",Qp.VARINT,t,n)}function uJ(r,e){return vC("message",Qp.LENGTH_DELIMITED,r,e)}var Zs;(function(r){(function(n){n.EOL="EOL"})(r.ValidityType||(r.ValidityType={}));let e;(function(n){n[n.EOL=0]="EOL"})(e||(e={})),function(n){n.codec=()=>lJ(e)}(r.ValidityType||(r.ValidityType={}));let t;r.codec=()=>(t==null&&(t=uJ((n,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),n.value!=null&&(s.uint32(10),s.bytes(n.value)),n.signature!=null&&(s.uint32(18),s.bytes(n.signature)),n.validityType!=null&&(s.uint32(24),r.ValidityType.codec().encode(n.validityType,s)),n.validity!=null&&(s.uint32(34),s.bytes(n.validity)),n.sequence!=null&&(s.uint32(40),s.uint64(n.sequence)),n.ttl!=null&&(s.uint32(48),s.uint64(n.ttl)),n.pubKey!=null&&(s.uint32(58),s.bytes(n.pubKey)),n.signatureV2!=null&&(s.uint32(66),s.bytes(n.signatureV2)),n.data!=null&&(s.uint32(74),s.bytes(n.data)),i.lengthDelimited!==!1&&s.ldelim()},(n,s)=>{const i={},o=s==null?n.len:n.pos+s;for(;n.pos<o;){const a=n.uint32();switch(a>>>3){case 1:i.value=n.bytes();break;case 2:i.signature=n.bytes();break;case 3:i.validityType=r.ValidityType.codec().decode(n);break;case 4:i.validity=n.bytes();break;case 5:i.sequence=n.uint64();break;case 6:i.ttl=n.uint64();break;case 7:i.pubKey=n.bytes();break;case 8:i.signatureV2=n.bytes();break;case 9:i.data=n.bytes();break;default:n.skipType(a&7);break}}return i})),t),r.encode=n=>cJ(n,r.codec()),r.decode=n=>aJ(n,r.codec())})(Zs||(Zs={}));const gE=N("ipns:utils"),_C=L("/ipns/");function rb(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),u=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,u))}const dJ=async(r,e)=>{if(e==null||r==null){const n=new Error("one or more of the provided parameters are not defined");throw gE.error(n),$(n,pE)}let t;if(e.pubKey!=null){try{t=ka(e.pubKey)}catch(s){throw gE.error(s),s}if(!(await rs(e.pubKey)).equals(r))throw $(new Error("Embedded public key did not match PeerID"),eJ)}else r.publicKey!=null&&(t=ka(r.publicKey));if(t!=null)return t;throw $(new Error("no public key is available"),pE)},hJ=(r,e,t)=>{const n=L(e);return M([r,t,n])},SC=r=>{const e=L("ipns-signature:");return M([e,r])},fJ=r=>Zs.encode(r),y2=r=>{const e=Zs.decode(r);return e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),{value:e.value??new Uint8Array(0),signature:e.signature??new Uint8Array(0),validityType:e.validityType??Zs.ValidityType.EOL,validity:e.validity??new Uint8Array(0),sequence:e.sequence??0n,pubKey:e.pubKey,ttl:e.ttl??void 0,signatureV2:e.signatureV2,data:e.data}},Yp=r=>M([_C,r.toBytes()]),pJ=r=>ni(r.slice(_C.length)),gJ=(r,e,t,n,s)=>{let i;if(t===Zs.ValidityType.EOL)i=0;else throw $(new Error("Unknown validity type"),Vm);return Ad({Value:r,Validity:e,ValidityType:i,Sequence:n,TTL:s})},yJ=r=>{const e=to(r);if(e.ValidityType===0)e.ValidityType=Zs.ValidityType.EOL;else throw $(new Error("Unknown validity type"),Vm);return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e};var wJ=AC,yE=128,bJ=127,mJ=~bJ,EJ=Math.pow(2,31);function AC(r,e,t){e=e||[],t=t||0;for(var n=t;r>=EJ;)e[t++]=r&255|yE,r/=128;for(;r&mJ;)e[t++]=r&255|yE,r>>>=7;return e[t]=r|0,AC.bytes=t-n+1,e}var vJ=nb,_J=128,wE=127;function nb(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw nb.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&wE)<<s:(o&wE)*Math.pow(2,s),s+=7}while(o>=_J);return nb.bytes=i-n,t}var SJ=Math.pow(2,7),AJ=Math.pow(2,14),$J=Math.pow(2,21),RJ=Math.pow(2,28),TJ=Math.pow(2,35),IJ=Math.pow(2,42),CJ=Math.pow(2,49),xJ=Math.pow(2,56),DJ=Math.pow(2,63),OJ=function(r){return r<SJ?1:r<AJ?2:r<$J?3:r<RJ?4:r<TJ?5:r<IJ?6:r<CJ?7:r<xJ?8:r<DJ?9:10},PJ={encode:wJ,decode:vJ,encodingLength:OJ},Xp=PJ;const bE=(r,e=0)=>[Xp.decode(r,e),Xp.decode.bytes],mE=(r,e,t=0)=>(Xp.encode(r,e,t),e),EE=r=>Xp.encodingLength(r),kJ=(r,e)=>{const t=e.byteLength,n=EE(r),s=n+EE(t),i=new Uint8Array(s+t);return mE(r,i,0),mE(t,i,n),i.set(e,s),new $C(r,t,e,i)},NJ=r=>{const e=bC(r),[t,n]=bE(e),[s,i]=bE(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new $C(t,s,o,e)};let $C=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const RC=0,LJ="identity",TC=bC,MJ=r=>kJ(RC,TC(r)),UJ={code:RC,name:LJ,encode:TC,digest:MJ},IC=N("ipns"),BJ=UJ.code,np="/ipns/",Bg=np.length,zJ=async(r,e,t,n)=>{const s=new FX(Date.now()+Number(n)),i=Zs.ValidityType.EOL,[o,a]=n.toString().split("."),c=BigInt(o)*BigInt(1e5)+BigInt(a??"0");return await FJ(r,e,t,i,s,c)},FJ=async(r,e,t,n,s,i)=>{t=BigInt(t);const o=L(s.toString());if(r.privateKey==null)throw $(new Error("Missing private key"),tJ);const a=await Vo(r.privateKey),c=await jJ(a,e,n,o),u=gJ(e,o,n,t,i),l=SC(u),d=await a.sign(l),f={value:e,signature:c,validityType:n,validity:o,sequence:t,ttl:i,signatureV2:d,data:u};if(r.publicKey!=null){const g=NJ(r.toBytes());(g.code!==BJ||!me(r.publicKey,g.digest))&&(f.pubKey=r.publicKey)}return IC("ipns entry for %b created",e),f},VJ=r=>QX.encode(r).slice(1),sb=r=>new ie(`/ipns/${VJ(r)}`),jJ=async(r,e,t,n)=>{try{const s=hJ(e,t,n);return await r.sign(s)}catch(s){throw IC.error("record signature creation failed",s),$(new Error("record signature creation failed"),XX)}},$n=N("ipfs:ipns:publisher"),vE=Js().code,CC=60*60*1e3;class sp{constructor(e,t){this._routing=e,this._datastore=t}async publishWithEOL(e,t,n,s){const i=await this._updateOrCreateRecord(e,t,n,s);return this._putRecordToRouting(i,e,s)}publish(e,t,n){return this.publishWithEOL(e,t,CC,n)}async _putRecordToRouting(e,t,n){if(!xi(t)){const i="peerId received is not valid";throw $n.error(i),$(new Error(i),"ERR_INVALID_PEER_ID")}if(t.publicKey==null)throw $(new Error("Public key was missing"),"ERR_MISSING_PUBLIC_KEY");const s=Yp(t);return await this._publishEntry(s,e,n),e}async _publishEntry(e,t,n){try{const s=await this._routing.put(e,t,n);return $n(`ipns record for ${C(e,"base32")} was stored in the routing`),s}catch(s){const i=`ipns record for ${C(e,"base32")} could not be stored in the routing - ${s.stack}`;throw $n.error(i),$n.error(s),$(new Error(i),"ERR_PUTTING_TO_ROUTING")}}async _getPublished(e,t={}){if(!xi(e)){const s="peerId received is not valid";throw $n.error(s),$(new Error(s),"ERR_INVALID_PEER_ID")}const n=t.checkRouting!==!1;try{const s=await this._datastore.get(sb(e.toBytes()));return this._unmarshalData(s)}catch(s){if(s.code!==vE){const i=`unexpected error getting the ipns record ${e.toString()} from datastore`;throw $n.error(i),$(new Error(i),"ERR_UNEXPECTED_DATASTORE_RESPONSE")}if(!n)throw $(s,"ERR_NOT_FOUND_AND_CHECK_ROUTING_NOT_ENABLED");try{const i=Yp(e),o=await this._routing.get(i);return this._unmarshalData(o)}catch(i){throw $n.error(i),i}}}_unmarshalData(e){try{return y2(e)}catch(t){throw $(t,"ERR_INVALID_RECORD_DATA")}}async _updateOrCreateRecord(e,t,n,s){if(!xi(e)){const u="peerId received is not valid";throw $n.error(u),$(new Error(u),"ERR_INVALID_PEER_ID")}const i={checkRouting:!0};let o;try{o=await this._getPublished(e,i)}catch(u){if(u.code!==vE){const l=`unexpected error when determining the last published IPNS record for ${e.toString()} ${u.stack}`;throw $n.error(l),$(new Error(l),"ERR_DETERMINING_PUBLISHED_RECORD")}}let a=0n;o&&o.sequence!==void 0&&(a=me(o.value,t)?o.sequence:o.sequence+BigInt(1));let c;try{c=await zJ(e,t,a,n)}catch(u){const l=`ipns record for ${t} could not be created`;throw $n.error(u),$(new Error(l),"ERR_CREATING_IPNS_RECORD")}try{const u=fJ(c);return await this._datastore.put(sb(e.toBytes()),u,s),$n(`ipns record for ${C(t,"base32")} was stored in the datastore`),u}catch{const l=`ipns record for ${t} could not be stored in the datastore`;throw $n.error(l),$(new Error(l),"ERR_STORING_IN_DATASTORE")}}}sp.defaultRecordLifetime=CC;const lf=N("ipfs:ipns:republisher"),xC=60*1e3,DC=60*xC,qJ=4*DC,KJ=24*DC;class GJ{constructor(e,t,n,s,i={pass:""}){this._publisher=e,this._datastore=t,this._peerId=n,this._keychain=s,this._options=i,this._republishHandle=null}async start(){if(this._republishHandle)throw $(new Error("republisher is already running"),"ERR_REPUBLISH_ALREADY_RUNNING");const e={_task:null,_inflightTask:null,_timeoutId:null,runPeriodically:s=>{e._timeoutId=setTimeout(async()=>{e._timeoutId=null;try{e._inflightTask=e._task(),await e._inflightTask,e._task&&e.runPeriodically(s)}catch(i){lf.error(i)}},s())},cancel:async()=>{e._timeoutId!=null&&clearTimeout(e._timeoutId),e._task=null,await e._inflightTask}},{pass:t}=this._options;let n=!0;e._task=async()=>{const s=new ft.TimeoutController(3e4);try{await this._republishEntries(this._peerId,t,{signal:s.signal})}finally{s.clear()}},e.runPeriodically(()=>n?(n=!1,this._options.initialBroadcastInterval||xC):this._options.broadcastInterval||qJ),this._republishHandle=e}async stop(){const e=this._republishHandle;if(!e)throw $(new Error("republisher is not running"),"ERR_REPUBLISH_NOT_RUNNING");this._republishHandle=null,await e.cancel()}async _republishEntries(e,t,n){try{await this._republishEntry(e,n)}catch{const i="cannot republish entry for the node's private key";lf.error(i);return}if(t)try{const s=await this._keychain.listKeys();for(const i of s){if(i.name==="self")continue;const o=await this._keychain.exportKey(i.name,t),a=await Nc(o,t),c=await rs(a.public.bytes,a.bytes);await this._republishEntry(c,n)}}catch(s){lf.error(s)}}async _republishEntry(e,t){try{const n=await this._getPreviousValue(e);await this._publisher.publishWithEOL(e,n,KJ,t)}catch(n){if(n.code==="ERR_NO_ENTRY_FOUND")return;throw n}}async _getPreviousValue(e){if(!xi(e))throw $(new Error("invalid peer ID"),"ERR_INVALID_PEER_ID");try{const t=await this._datastore.get(sb(e.toBytes()));if(!(t instanceof Uint8Array))throw $(new Error("found ipns record that we couldn't process"),"ERR_INVALID_IPNS_RECORD");try{return y2(t).value}catch(n){throw lf.error(n),$(new Error("found ipns record that we couldn't convert to a value"),"ERR_INVALID_IPNS_RECORD")}}catch(t){throw t&&t.notFound?$(new Error(`no previous entry for record with id: ${e.toString()}`),"ERR_NO_ENTRY_FOUND"):t}}}const Yl=N("ipns:validator"),HJ=async(r,e)=>{const{value:t,validityType:n,validity:s}=e;let i,o;if(e.signatureV2!=null&&e.data!=null)o=e.signatureV2,i=SC(e.data),WJ(e);else throw $(new Error("missing data or signatureV2"),na);let a;try{a=await r.verify(i,o)}catch{a=!1}if(!a)throw Yl.error("record signature verification failed"),$(new Error("record signature verification failed"),na);if(s!=null&&n===Zs.ValidityType.EOL){let c;try{c=rb(C(s))}catch{throw Yl.error("unrecognized validity format (not an rfc3339 format)"),$(new Error("unrecognized validity format (not an rfc3339 format)"),JX)}if(c.getTime()<Date.now())throw Yl.error("record has expired"),$(new Error("record has expired"),YX)}else if(n!=null)throw Yl.error("unrecognized validity type"),$(new Error("unrecognized validity type"),Vm);Yl("ipns entry for %b is valid",t)},WJ=r=>{if(r.data==null)throw $(new Error("Record data is missing"),ZX);const e=yJ(r.data);if(!me(e.Value,r.value))throw $(new Error('Field "value" did not match between protobuf and CBOR'),na);if(!me(e.Validity,r.validity))throw $(new Error('Field "validity" did not match between protobuf and CBOR'),na);if(e.ValidityType!==r.validityType)throw $(new Error('Field "validityType" did not match between protobuf and CBOR'),na);if(e.Sequence!==r.sequence)throw $(new Error('Field "sequence" did not match between protobuf and CBOR'),na);if(e.TTL!==r.ttl)throw $(new Error('Field "ttl" did not match between protobuf and CBOR'),na)},jm=async(r,e)=>{const t=pJ(r),n=y2(e),s=await dJ(t,n);await HJ(s,n)},zg=N("ipfs:ipns:resolver"),QJ=Js().code,_E=32;class YJ{constructor(e){this._routing=e}async resolve(e,t={}){if(typeof e!="string")throw $(new Error("invalid name"),"ERR_INVALID_NAME");const n=t.recursive&&t.recursive.toString()==="true",s=e.split("/");if(s.length!==3||s[0]!=="")throw $(new Error("invalid name"),"ERR_INVALID_NAME");const i=s[2];let o=1/0;n&&(o=_E);const a=await this.resolver(i,o,t);return zg(`${e} was locally resolved correctly`),a}async resolver(e,t,n){if(t===0){const o=`could not resolve name (recursion limit of ${_E} exceeded)`;throw zg.error(o),$(new Error(o),"ERR_RESOLVE_RECURSION_LIMIT")}const s=await this._resolveName(e,n),i=s.split("/");return i[1]==="ipfs"||!t?s:this.resolver(i[2],t-1,n)}async _resolveName(e,t){const n=de(e),s=Yp(n);let i;try{i=await this._routing.get(s,t)}catch(o){throw zg.error("could not get record from routing",o),o.code===QJ?$(new Error(`record requested for ${e} was not found in the network`),"ERR_NO_RECORD_FOUND"):$(new Error(`unexpected error getting the ipns record ${n.toString()}`),"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}return this._validateRecord(n,i)}async _validateRecord(e,t){await jm(M([L("/ipns/"),e.toBytes()]),t);const n=y2(t);return C(n.value)}}class XJ{constructor(e){this.lru=f2(e)}get(e){const t=this.lru.get(e);if(t){if(t.expire&&t.expire<Date.now()){this.lru.remove(e);return}return t.value}}set(e,t,n){this.lru.set(e,{value:t,expire:Date.now()+n})}has(e){return!!this.get(e)}remove(e){this.lru.remove(e)}clear(){this.lru.clear()}}const Xl=N("ipfs:ipns"),SE=60*1e3;class AE{constructor(e,t,n,s,i){this.publisher=new sp(e,t),this.republisher=new GJ(this.publisher,t,n,s,i),this.resolver=new YJ(e),this.cache=new XJ(1e3),this.routing=e}async publish(e,t,n=sp.defaultRecordLifetime,s){try{await this.publisher.publishWithEOL(e,t,n,s),Xl(`IPNS value ${C(t,"base32")} was published correctly`);const i=e.toString(),o=parseFloat(n),a=o<SE?o:SE;return this.cache.set(i,t,a),Xl(`IPNS value ${C(t,"base32")} was cached correctly`),{name:i,value:t}}catch(i){throw Xl.error(i),i}}async resolve(e,t={}){if(typeof e!="string")throw $(new Error("name received is not valid"),"ERR_INVALID_NAME");if(!t.nocache&&!t.recursive){const n=e.split("/")[2],s=this.cache.get(n);if(s)return s}try{const n=await this.resolver.resolve(e,t);return Xl(`IPNS record from ${e} was resolved correctly`),n}catch(n){throw Xl.error(n),n}}async initializeKeyspace(e,t,n){return this.publish(e,t,sp.defaultRecordLifetime,n)}}async function jo(r){const e=[];for await(const t of r)e.push(t);return e}const $E=(r,e)=>async function*(){yield*(await jo(r)).sort(e)}();async function Wt(r){for await(const e of r);}async function*dt(r,e){for await(const t of r)await e(t)&&(yield t)}async function*La(r,e){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}}class w2{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield{key:n,value:s}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await Wt(this.putMany(e,n)),e=[],await Wt(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null&&(n=dt(n,s=>s.key.toString().startsWith(e.prefix))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>dt(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>$E(s,i),n)),e.offset!=null){let s=0;n=dt(n,()=>s++>=e.offset)}return e.limit!=null&&(n=La(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null&&(n=dt(n,s=>s.toString().startsWith(e.prefix))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>dt(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>$E(s,i),n)),e.offset!=null){let s=0;n=dt(n,()=>s++>=e.offset)}return e.limit!=null&&(n=La(n,e.limit)),n}}const JJ=N("datastore:core:tiered");class ZJ extends w2{constructor(e){super(),this.stores=e.slice()}async open(){try{await Promise.all(this.stores.map(e=>e.open()))}catch(e){throw gC(e)}}async put(e,t,n){try{await Promise.all(this.stores.map(s=>s.put(e,t,n)))}catch(s){throw tb(s)}}async get(e,t){for(const n of this.stores)try{const s=await n.get(e,t);if(s)return s}catch(s){JJ.error(s)}throw Js()}async has(e,t){for(const n of this.stores)if(await n.has(e,t))return!0;return!1}async delete(e,t){try{await Promise.all(this.stores.map(n=>n.delete(e,t)))}catch(n){throw yC(n)}}async*putMany(e,t={}){let n;const s=this.stores.map(i=>{const o=Mt({objectMode:!0});return Wt(i.putMany(o,t)).catch(a=>{n=a}),o});try{for await(const i of e){if(n)throw n;s.forEach(o=>o.push(i)),yield i}}finally{s.forEach(i=>i.end())}}async*deleteMany(e,t={}){let n;const s=this.stores.map(i=>{const o=Mt({objectMode:!0});return Wt(i.deleteMany(o,t)).catch(a=>{n=a}),o});try{for await(const i of e){if(n)throw n;s.forEach(o=>o.push(i)),yield i}}finally{s.forEach(i=>i.end())}}async close(){await Promise.all(this.stores.map(e=>e.close()))}batch(){const e=this.stores.map(t=>t.batch());return{put:(t,n)=>{e.forEach(s=>s.put(t,n))},delete:t=>{e.forEach(n=>n.delete(t))},commit:async t=>{for(const n of e)await n.commit(t)}}}query(e,t){return this.stores[this.stores.length-1].query(e,t)}queryKeys(e,t){return this.stores[this.stores.length-1].queryKeys(e,t)}}function ve(r,e,t,n,s){for(e=e.split?e.split("."):e,n=0;n<e.length;n++)r=r?r[e[n]]:s;return r===s?t:r}const OC=(r,e)=>{const t=e.map((n,s)=>({entry:Zs.decode(n),index:s}));return t.sort((n,s)=>{if(n.entry.signatureV2!=null&&s.entry.signatureV2==null)return-1;if(n.entry.signatureV2==null&&s.entry.signatureV2!=null)return 1;const i=n.entry.sequence??0n,o=s.entry.sequence??0n;if(i>o)return-1;if(i<o)return 1;const a=n.entry.validity??new Uint8Array(0),c=s.entry.validity??new Uint8Array(0),u=rb(C(a)),l=rb(C(c));return u.getTime()>l.getTime()?-1:u.getTime()<l.getTime()?1:0}),t[0].index},eZ="SHARDING",tZ="_README";class rZ extends w2{constructor(){super(),this.data={}}open(){return Promise.resolve()}close(){return Promise.resolve()}async put(e,t){this.data[e.toString()]=t}async get(e){if(!await this.has(e))throw Js();return this.data[e.toString()]}async has(e){return this.data[e.toString()]!==void 0}async delete(e){delete this.data[e.toString()]}async*_all(){yield*Object.entries(this.data).map(([e,t])=>({key:new ie(e),value:t}))}async*_allKeys(){yield*Object.entries(this.data).map(([e])=>new ie(e))}}async function*Xr(r,e){for await(const t of r)yield e(t)}async function*nn(...r){const e=Mt({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(r.map(async t=>{for await(const n of t)e.push(n)})),e.end()}catch(t){e.end(t)}}),yield*e}const nZ=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},PC=r=>r!=null&&(typeof r[Symbol.asyncIterator]=="function"||typeof r[Symbol.iterator]=="function"||typeof r.next=="function"),Fg=r=>r!=null&&typeof r.sink=="function"&&PC(r.source),sZ=r=>e=>{const t=r.sink(e);if(t.then!=null){const n=Mt({objectMode:!0});return t.then(()=>{n.end()},i=>{n.end(i)}),nn(n,async function*(){yield*r.source,n.end()}())}return r.source};function Ae(r,...e){if(Fg(r)){const n=r;r=()=>n.source}else if(PC(r)){const n=r;r=()=>n}const t=[r,...e];if(t.length>1&&Fg(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)Fg(t[n])&&(t[n]=sZ(t[n]));return nZ(...t)}new ie(eZ);new ie(tZ);const ip="/record/";function RE(r){return C(r,"base32")}function uf(r){(typeof r=="string"||r instanceof String)&&(r=L(r.toString()));const e=C(r,"base64url");return`${ip}${e}`}function iZ(r){if(r.substring(0,ip.length)!==ip)throw new B("topic received is not from a record","ERR_TOPIC_IS_NOT_FROM_RECORD_NAMESPACE");const e=r.substring(ip.length);return L(e,"base64url")}const jt=N("datastore-pubsub:publisher");class oZ extends w2{constructor(e,t,n,s,i,o){if(super(),!s)throw new B("missing validator","ERR_INVALID_PARAMETERS");if(typeof s!="function")throw new B("missing validate function","ERR_INVALID_PARAMETERS");if(typeof i!="function")throw new B("missing select function","ERR_INVALID_PARAMETERS");if(o&&typeof o!="function")throw new B("invalid subscriptionKeyFn received","ERR_INVALID_PARAMETERS");this._pubsub=e,this._datastore=t,this._peerId=n,this._validator=s,this._selector=i,this._handleSubscriptionKeyFn=o,this._onMessage=this._onMessage.bind(this),this._pubsub.addEventListener("message",this._onMessage)}async put(e,t,n){if(!(e instanceof Uint8Array)){const i="datastore key does not have a valid format";throw jt.error(i),new B(i,"ERR_INVALID_DATASTORE_KEY")}if(!(t instanceof Uint8Array)){const i="received value is not a Uint8Array";throw jt.error(i),new B(i,"ERR_INVALID_VALUE_RECEIVED")}const s=uf(e);jt(`publish value for topic ${s}`),await this._pubsub.publish(s,t)}async get(e,t){if(!(e instanceof Uint8Array)){const i="datastore key does not have a valid format";throw jt.error(i),new B(i,"ERR_INVALID_DATASTORE_KEY")}const n=uf(e),s=await this._pubsub.getTopics();if(s&&Array.isArray(s)&&s.indexOf(n)>-1)return this._getLocal(e,t);try{await this._pubsub.subscribe(n)}catch{const o=`cannot subscribe topic ${n}`;throw jt.error(o),new B(o,"ERR_SUBSCRIBING_TOPIC")}return jt(`subscribed values for key ${n}`),this._getLocal(e)}unsubscribe(e){const t=uf(e);return this._pubsub.unsubscribe(t)}async _getLocal(e,t){const n=new ie("/"+RE(e),!1);let s;try{s=await this._datastore.get(n,t)}catch(i){if(i.code!=="ERR_NOT_FOUND"){const a=`unexpected error getting the ipns record for ${n.toString()}`;throw jt.error(a),new B(a,"ERR_UNEXPECTED_ERROR_GETTING_RECORD")}const o=`local record requested was not found for ${n.toString()}`;throw jt.error(o),new B(o,"ERR_NOT_FOUND")}if(!(s instanceof Uint8Array)){const i="found record that we couldn't convert to a value";throw jt.error(i),new B(i,"ERR_INVALID_RECORD_RECEIVED")}return s}async _onMessage(e){const t=e.detail;if(t.type!=="signed"){jt.error("unsigned message received, this module can only work with signed messages");return}const{data:n,from:s,topic:i}=t;let o;try{o=iZ(i)}catch(a){jt.error(a);return}if(jt(`message received for topic ${i}`),this._peerId.equals(s)){jt("message discarded as it is from the same peer");return}if(this._handleSubscriptionKeyFn){let a;try{a=await this._handleSubscriptionKeyFn(o)}catch{jt.error("message discarded by the subscriptionKeyFn");return}o=a}try{await this._storeIfSubscriptionIsBetter(o,n)}catch(a){jt.error(a)}}async _storeIfSubscriptionIsBetter(e,t,n){let s=!1;try{s=await this._isBetter(e,t)}catch(i){if(i.code!=="ERR_NOT_VALID_RECORD")throw i}s&&await this._storeRecord(e,t,n)}async _validateRecord(e,t){return this._validator(e,t)}async _selectRecord(e,t){return await this._selector(e,t)===0}async _isBetter(e,t){try{await this._validateRecord(e,t)}catch{const o="record received through pubsub is not valid";throw jt.error(o),new B(o,"ERR_NOT_VALID_RECORD")}const n=new ie(e);let s;try{s=await this._getLocal(n.uint8Array())}catch{return!0}return me(s,t)?!1:this._selectRecord(e,[s,t])}async _storeRecord(e,t,n){const s=new ie("/"+RE(e),!1);await this._datastore.put(s,t,n),jt(`record for ${uf(e)} was stored in the datastore`)}}const df=N("ipfs:ipns:pubsub");class ib{constructor(e,t,n){this._subscriptions={},this._handleSubscriptionKey=this._handleSubscriptionKey.bind(this),this._pubsubDs=new oZ(e,t,n,jm,OC,this._handleSubscriptionKey)}async put(e,t,n){try{await this._pubsubDs.put(e,t,n)}catch(s){throw df.error(s),s}}async get(e,t){let n,s;try{n=await this._pubsubDs.get(e,t)}catch(o){s=o}const i=e.slice(0,Bg);if(C(i)===np){const o=qr.encode(e).substring(1),a=qr.encode(e.slice(Bg)).substring(1);this._subscriptions[o]=a,df(`subscribed to pubsub topic ${o}, id ${a}`)}if(s)throw s;return n}_handleSubscriptionKey(e){e instanceof Uint8Array&&(e=C(e,"base58btc"));const t=this._subscriptions[e];if(!t)throw $(new Error(`key ${e} does not correspond to a subscription`),"ERR_INVALID_KEY");try{return Yp(de(t))}catch(n){throw df.error(n),n}}getSubscriptions(){return Object.values(this._subscriptions).filter(Boolean).map(t=>`${np}${t}`)}async cancel(e){if(typeof e!="string")throw $(new Error("invalid subscription name"),"ERR_INVALID_SUBSCRIPTION_NAME");e.startsWith(np)&&(e=e.substring(Bg));const t=Object.keys(this._subscriptions).find(s=>this._subscriptions[s]===e);if(!t)return{canceled:!1};const n=L(t);return this._pubsubDs.unsubscribe(n),delete this._subscriptions[t],df(`unsubscribed pubsub ${t}: ${e}`),{canceled:!0}}}var Jp;(function(r){let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={key:new Uint8Array(0),value:new Uint8Array(0),timeReceived:""},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.key=t.bytes();break;case 2:s.value=t.bytes();break;case 5:s.timeReceived=t.string();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(Jp||(Jp={}));function aZ(r){const e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),s=String(r.getUTCHours()).padStart(2,"0"),i=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${s}:${i}:${o}.${c}Z`}function cZ(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),u=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,s,i,o,a,c,u))}class Kr{constructor(e,t,n){k(this,"key");k(this,"value");k(this,"timeReceived");if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return Jp.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:aZ(this.timeReceived)}}static deserialize(e){const t=Jp.decode(e);return new Kr(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=cZ(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Kr(e.key,e.value,t)}}const Vg=N("ipfs:ipns:offline-datastore");class kC{constructor(e){this._datastore=e,this.stores=[]}async put(e,t,n){if(!(e instanceof Uint8Array))throw $(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");if(!(t instanceof Uint8Array))throw $(new Error("Offline datastore value must be a Uint8Array"),"ERR_INVALID_VALUE");let s;try{s=this._routingKey(e)}catch(o){throw Vg.error(o),$(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const i=new Kr(e,t,new Date);await this._datastore.put(s,i.serialize(),n)}async get(e,t){if(!(e instanceof Uint8Array))throw $(new Error("Offline datastore key must be a Uint8Array"),"ERR_INVALID_KEY");let n;try{n=this._routingKey(e)}catch(o){throw Vg.error(o),$(new Error("Not possible to generate the routing key"),"ERR_GENERATING_ROUTING_KEY")}const s=await this._datastore.get(n,t);let i;try{i=Kr.deserialize(s)}catch(o){throw Vg.error(o),o}return i.value}_routingKey(e){return new ie("/dht/record/"+C(e,"base32"),!1)}}const lZ=N("ipfs:ipns:dht-datastore");class uZ{constructor(e){this._dht=e}async put(e,t,n){try{await Wt(this._dht.put(e,t,n))}catch(s){throw lZ.error(s),s}}async get(e,t){for await(const n of this._dht.get(e,t))if(n.name==="VALUE")return n.value;throw Js()}}function dZ({libp2p:r,repo:e,peerId:t,options:n}){const s=[];let i;if(ve(n,"EXPERIMENTAL.ipnsPubsub",!1)&&(i=new ib(r.pubsub,e.datastore,t),s.push(i)),ve(n,"offline",!1)!==!0&&["dht","dhtclient","dhtserver"].includes(ve(n,"config.Routing.Type","none"))&&s.push(new uZ(r.dht)),ve(n,"offline",!1)||s.length===0){const o=new kC(e.datastore);s.push(o)}return new ZJ(s)}const hZ=N("ipfs:components:ipns");class fZ{constructor(e={pass:""}){this.options=e,this.offline=null,this.online=null}getIPNS(){const e=this.online||this.offline;if(e)return e;throw new fh}get routing(){return this.getIPNS().routing}startOffline({repo:e,peerId:t,keychain:n}){if(this.offline!=null)throw new Na;hZ("initializing IPNS keyspace (offline)");const s=new kC(e.datastore),i=new AE(s,e.datastore,t,n,this.options);this.offline=i}async startOnline({libp2p:e,repo:t,peerId:n,keychain:s}){if(this.online!=null)throw new Na;const i=dZ({libp2p:e,repo:t,peerId:n,options:this.options}),o=new AE(i,t.datastore,n,s,this.options);await o.republisher.start(),this.online=o}async stop(){const e=this.online;e&&(await e.republisher.stop(),this.online=null)}publish(e,t,n,s){return this.getIPNS().publish(e,t,n,s)}resolve(e,t){return this.getIPNS().resolve(e,t)}initializeKeyspace(e,t,n){return this.getIPNS().initializeKeyspace(e,t,n)}}async function pZ({ipns:r,repo:e,codecs:t},n,s){if(QI(n))return r.resolve(n);const{cid:i,path:o}=bh(n);await Wt(Od(i,o||"",t,e,s))}const jg=N("ipfs:name:publish");function gZ({ipns:r,repo:e,codecs:t,peerId:n,isOnline:s,keychain:i}){const o=async c=>{let u;if(c==="self"&&n.privateKey!=null)u=await Vo(n.privateKey);else try{const l=await i.exportKey(c,"temp");u=await Nc(l,"temp")}catch(l){throw jg.error(l),$(l,"ERR_CANNOT_GET_KEY")}return rs(u.public.bytes,u.bytes)};async function a(c,u={}){const l=u.resolve!==!1,d=u.lifetime||"24h",f=u.key||"self";if(!s())throw $(new Error(nC),"OFFLINE_ERROR");try{c=dQ(c)}catch(y){throw jg.error(y),y}let g=0;try{g=fe(d)||0,g=parseFloat(g.toFixed(6))}catch(y){throw jg.error(y),y}const h=await Promise.all([o(f),l?pZ({ipns:r,repo:e,codecs:t},c):Promise.resolve()]),p=L(c),w=await r.publish(h[0],p,g,u);return{name:w.name,value:C(w.value)}}return F(a)}var yZ=/^(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9])?\.){0,126}(?:[a-z0-9](?:[a-z0-9\-]{0,61}[a-z0-9]))\.?$/i,wZ=function(e,t){if(t==null&&(t=!1),e.length<2||e.length>255)return!1;var n=e[e.length-1];if(t){if(n!==".")return!1}else if(n===".")return!1;return yZ.test(e)};const bZ=Ge(wZ),mZ=et.bind({ignoreUndefined:!0}),EZ=N("ipfs:name:resolve"),TE=(r,e)=>e.length>0?r+"/"+e.join("/"):r;function vZ({dns:r,ipns:e,isOnline:t,options:{offline:n}}){async function*s(i,o={}){if(o=mZ({nocache:!1,recursive:!0},o),n&&o&&o.nocache)throw $(new Error("cannot specify both offline and nocache"),"ERR_NOCACHE_AND_OFFLINE");if(!t()&&!n)throw $(new Error(nC),"OFFLINE_ERROR");let a=i.toString();a.startsWith("/ipns/")||(a=`/ipns/${a}`);let[c,u,...l]=a.slice(1).split("/");try{if(u.substring(0,1)==="1"){const f=de(u),g=Sm(f.toBytes());u=ne.createV1(114,g).toString(Mp)}else{const f=ne.parse(u);f.version===1&&(u=f.toString(Mp))}}catch(f){if(bZ(u)){yield TE(await r(u,o),l);return}throw EZ.error(f),$(new Error("Invalid IPNS name"),"ERR_IPNS_INVALID_NAME")}const d=await e.resolve(`/${c}/${u}`,o);yield TE(d instanceof Uint8Array?C(d):d,l)}return F(s)}function qm(r,e){if(!r||!(e&&e.ipnsPubsub))throw $(new Error("IPNS pubsub subsystem is not enabled"),"ERR_IPNS_PUBSUB_NOT_ENABLED");if(r.routing instanceof ib)return r.routing;const t=(r.routing.stores||[]).find(n=>n instanceof ib);if(!t)throw $(new Error("IPNS pubsub datastore not found"),"ERR_PUBSUB_DATASTORE_NOT_FOUND");return t}function _Z({ipns:r,options:e}){const t=e.EXPERIMENTAL;async function n(s,i={}){return qm(r,t).cancel(s,i)}return F(n)}function SZ({ipns:r,options:e}){const t=e.EXPERIMENTAL;async function n(s={}){try{return{enabled:!!qm(r,t)}}catch{return{enabled:!1}}}return F(n)}function AZ({ipns:r,options:e}){const t=e.EXPERIMENTAL;async function n(s={}){return qm(r,t).getSubscriptions(s)}return F(n)}class $Z{constructor({ipns:e,options:t}){this.cancel=_Z({ipns:e,options:t}),this.state=SZ({ipns:e,options:t}),this.subs=AZ({ipns:e,options:t})}}class RZ{constructor({dns:e,ipns:t,repo:n,codecs:s,peerId:i,isOnline:o,keychain:a,options:c}){this.publish=gZ({ipns:t,repo:n,codecs:s,peerId:i,isOnline:o,keychain:a}),this.resolve=vZ({dns:e,ipns:t,isOnline:o,options:c}),this.pubsub=new $Z({ipns:t,options:c})}}const TZ=Js().code,ob={default:"<dst>",edges:"<src> -> <dst>"};function IZ({repo:r,codecs:e,resolve:t,preload:n}){async function*s(i,o={}){if(o.maxDepth===0)return;if(o.edges&&o.format&&o.format!==ob.default)throw new Error("Cannot set edges to true and also specify format");if(o.format=o.edges?ob.edges:o.format,typeof o.maxDepth!="number"&&(o.maxDepth=o.recursive?1/0:1),o.timeout){const l=[new ft.TimeoutController(o.timeout).signal];o.signal&&l.push(o.signal),o.signal=Xs(l)}const c=(Array.isArray(i)?i:[i]).map(u=>CZ(n,u,o));for(const u of c)try{yield*xZ(t,r,e,u,o)}catch(l){yield{ref:"",err:l.message}}}return s}function CZ(r,e,t){const{cid:n,path:s}=bh(e);return t.preload!==!1&&r(n),`/ipfs/${n}${s||""}`}async function*xZ(r,e,t,n,s){const i=await r(n,s),{cid:o}=bh(i),a=s.maxDepth!=null?s.maxDepth:1/0,c=s.unique||!1;for await(const u of OZ(e,t,o,a,c,s))u.parent&&(u.isDuplicate||(yield{ref:DZ(u.parent.cid,u.node.cid,u.node.name,s.format)}))}function DZ(r,e,t="",n=ob.default){let s=n.replace(/<src>/g,r.toString());return s=s.replace(/<dst>/g,e.toString()),s=s.replace(/<linkname>/g,t),s}async function*OZ(r,e,t,n,s,i){const o=new Set;async function*a(c,u){const l=u+1;if(!(l>n))try{for await(const d of PZ(r,e,c.cid,i))yield{parent:c,node:d,isDuplicate:s&&o.has(d.cid.toString())},s&&o.add(d.cid.toString()),yield*a(d,l)}catch(d){throw d.code===TZ&&(d.message=`Could not find object with CID: ${c.cid}`),d}}yield*a({cid:t},0)}async function*PZ(r,e,t,n){const s=await r.blocks.get(t,n),o=(await e.getCodec(t.code)).decode(s),a=t.code===ht,c=[];for(const[u,l]of ab(o,c)){if(a){const d=u.match(/^Links\/(\d+)\/Hash$/);if(d){const f=Number(d[1]);if(f<o.Links.length){yield{name:o.Links[f].Name,cid:l};continue}}}yield{name:u,cid:l}}}const ab=function*(r,e){if(r!=null&&!(r instanceof Uint8Array)){for(const[t,n]of Object.entries(r)){const s=[...e,t];if(n!=null&&typeof n=="object")if(Array.isArray(n))for(const[i,o]of n.entries()){const a=[...s,i],c=ne.asCID(o);c?yield[a.join("/"),c]:typeof o=="object"&&(yield*ab(o,a))}else{const i=ne.asCID(n);i?yield[s.join("/"),i]:yield*ab(n,s)}}return[]}};function kZ({repo:r}){async function*e(t={}){for await(const n of r.blocks.queryKeys({},{signal:t.signal}))yield{ref:n.toString()}}return F(e)}function NZ({network:r}){async function e(t={}){const{bitswap:n}=await r.use(t),s=n.getWantlist();return Array.from(s).map(i=>i[1].cid)}return F(e)}function LZ({network:r}){async function e(t,n={}){const{bitswap:s}=await r.use(n),i=s.wantlistForPeer(t);return Array.from(i).map(o=>o[1].cid)}return F(e)}function MZ({network:r}){async function e(t,n={}){const{bitswap:s}=await r.use(n);return Array.isArray(t)||(t=[t]),s.unwant(t)}return F(e)}function NC({network:r}){async function e(t={}){const n=(await r.use(t)).bitswap,s=n.stat().snapshot;return{provideBufLen:parseInt(s.providesBufferLength.toString()),blocksReceived:BigInt(s.blocksReceived.toString()),wantlist:Array.from(n.getWantlist()).map(i=>i[1].cid),peers:n.peers(),dupBlksReceived:BigInt(s.dupBlksReceived.toString()),dupDataReceived:BigInt(s.dupDataReceived.toString()),dataReceived:BigInt(s.dataReceived.toString()),blocksSent:BigInt(s.blocksSent.toString()),dataSent:BigInt(s.dataSent.toString())}}return F(e)}class UZ{constructor({network:e}){this.wantlist=NZ({network:e}),this.wantlistForPeer=LZ({network:e}),this.unwant=MZ({network:e}),this.stat=NC({network:e})}}function BZ(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var zZ=BZ,FZ=zZ;const VZ=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Km=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},jZ=r=>new TextEncoder().encode(r),qZ=r=>new TextDecoder().decode(r);let KZ=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},GZ=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return LC(this,e)}},HZ=class{constructor(e){this.decoders=e}or(e){return LC(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const LC=(r,e)=>new HZ({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let WZ=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new KZ(e,t,n),this.decoder=new GZ(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const b2=({name:r,prefix:e,encode:t,decode:n})=>new WZ(r,e,t,n),$h=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=FZ(t,e);return b2({prefix:r,name:e,encode:n,decode:i=>Km(s(i))})},QZ=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},YZ=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},er=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>b2({prefix:e,name:r,encode(s){return YZ(s,n,t)},decode(s){return QZ(s,n,t,r)}}),gs=$h({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),XZ=$h({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),JZ=Object.freeze(Object.defineProperty({__proto__:null,base58btc:gs,base58flickr:XZ},Symbol.toStringTag,{value:"Module"}));var ZZ=MC,IE=128,eee=127,tee=~eee,ree=Math.pow(2,31);function MC(r,e,t){e=e||[],t=t||0;for(var n=t;r>=ree;)e[t++]=r&255|IE,r/=128;for(;r&tee;)e[t++]=r&255|IE,r>>>=7;return e[t]=r|0,MC.bytes=t-n+1,e}var nee=cb,see=128,CE=127;function cb(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw cb.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&CE)<<s:(o&CE)*Math.pow(2,s),s+=7}while(o>=see);return cb.bytes=i-n,t}var iee=Math.pow(2,7),oee=Math.pow(2,14),aee=Math.pow(2,21),cee=Math.pow(2,28),lee=Math.pow(2,35),uee=Math.pow(2,42),dee=Math.pow(2,49),hee=Math.pow(2,56),fee=Math.pow(2,63),pee=function(r){return r<iee?1:r<oee?2:r<aee?3:r<cee?4:r<lee?5:r<uee?6:r<dee?7:r<hee?8:r<fee?9:10},gee={encode:ZZ,decode:nee,encodingLength:pee},Zp=gee;const lb=(r,e=0)=>[Zp.decode(r,e),Zp.decode.bytes],e1=(r,e,t=0)=>(Zp.encode(r,e,t),e),t1=r=>Zp.encodingLength(r),yee=(r,e)=>{const t=e.byteLength,n=t1(r),s=n+t1(t),i=new Uint8Array(s+t);return e1(r,i,0),e1(t,i,n),i.set(e,s),new Gm(r,t,e,i)},UC=r=>{const e=Km(r),[t,n]=lb(e),[s,i]=lb(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Gm(t,s,o,e)},wee=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&VZ(r.bytes,t.bytes)}};let Gm=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const Sa=er({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),bee=er({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),mee=er({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Eee=er({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),vee=er({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),_ee=er({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),See=er({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Aee=er({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),$ee=er({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Ree=Object.freeze(Object.defineProperty({__proto__:null,base32:Sa,base32hex:vee,base32hexpad:See,base32hexpadupper:Aee,base32hexupper:_ee,base32pad:mee,base32padupper:Eee,base32upper:bee,base32z:$ee},Symbol.toStringTag,{value:"Module"})),xE=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Iee(t,ub(r),e||gs.encoder);default:return Cee(t,ub(r),e||Sa.encoder)}},DE=new WeakMap,ub=r=>{const e=DE.get(r);if(e==null){const t=new Map;return DE.set(r,t),t}return e};let BC=class wr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Jl)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==xee)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return wr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=yee(e,t);return wr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return wr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&wee(e.multihash,n.multihash)}toString(e){return xE(this,e)}toJSON(){return{"/":xE(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof wr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new wr(n,s,i,o||OE(n,s,i.bytes))}else if(t[Dee]===!0){const{version:n,multihash:s,code:i}=t,o=UC(s);return wr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Jl)throw new Error(`Version 0 CID must use dag-pb (code: ${Jl}) block encoding`);return new wr(e,t,n,n.bytes)}case 1:{const s=OE(e,t,n.bytes);return new wr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return wr.create(0,Jl,e)}static createV1(e,t){return wr.create(1,e,t)}static decode(e){const[t,n]=wr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=wr.inspectBytes(e),n=t.size-t.multihashSize,s=Km(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Gm(t.multihashCode,t.digestSize,i,s);return[t.version===0?wr.createV0(o):wr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=lb(e.subarray(t));return t+=f,d};let s=n(),i=Jl;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=Tee(e,t),i=wr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return ub(i).set(n,e),i}};const Tee=(r,e)=>{switch(r[0]){case"Q":{const t=e||gs;return[gs.prefix,t.decode(`${gs.prefix}${r}`)]}case gs.prefix:{const t=e||gs;return[gs.prefix,t.decode(r)]}case Sa.prefix:{const t=e||Sa;return[Sa.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Iee=(r,e,t)=>{const{prefix:n}=t;if(n!==gs.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Cee=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Jl=112,xee=18,OE=(r,e,t)=>{const n=t1(r),s=n+t1(e),i=new Uint8Array(s+t.byteLength);return e1(r,i,0),e1(e,i,n),i.set(t,s),i},Dee=Symbol.for("@ipld/js-cid/CID"),Oee=Math.pow(2,7),Pee=Math.pow(2,14),kee=Math.pow(2,21),Hm=Math.pow(2,28),Wm=Math.pow(2,35),Qm=Math.pow(2,42),Ym=Math.pow(2,49),Le=128,Lr=127;function qo(r){if(r<Oee)return 1;if(r<Pee)return 2;if(r<kee)return 3;if(r<Hm)return 4;if(r<Wm)return 5;if(r<Qm)return 6;if(r<Ym)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function Nee(r,e,t=0){switch(qo(r)){case 8:e[t++]=r&255|Le,r/=128;case 7:e[t++]=r&255|Le,r/=128;case 6:e[t++]=r&255|Le,r/=128;case 5:e[t++]=r&255|Le,r/=128;case 4:e[t++]=r&255|Le,r>>>=7;case 3:e[t++]=r&255|Le,r>>>=7;case 2:e[t++]=r&255|Le,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function Lee(r,e,t=0){switch(qo(r)){case 8:e.set(t++,r&255|Le),r/=128;case 7:e.set(t++,r&255|Le),r/=128;case 6:e.set(t++,r&255|Le),r/=128;case 5:e.set(t++,r&255|Le),r/=128;case 4:e.set(t++,r&255|Le),r>>>=7;case 3:e.set(t++,r&255|Le),r>>>=7;case 2:e.set(t++,r&255|Le),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function Mee(r,e){let t=r[e],n=0;if(n+=t&Lr,t<Le||(t=r[e+1],n+=(t&Lr)<<7,t<Le)||(t=r[e+2],n+=(t&Lr)<<14,t<Le)||(t=r[e+3],n+=(t&Lr)<<21,t<Le)||(t=r[e+4],n+=(t&Lr)*Hm,t<Le)||(t=r[e+5],n+=(t&Lr)*Wm,t<Le)||(t=r[e+6],n+=(t&Lr)*Qm,t<Le)||(t=r[e+7],n+=(t&Lr)*Ym,t<Le))return n;throw new RangeError("Could not decode varint")}function Uee(r,e){let t=r.get(e),n=0;if(n+=t&Lr,t<Le||(t=r.get(e+1),n+=(t&Lr)<<7,t<Le)||(t=r.get(e+2),n+=(t&Lr)<<14,t<Le)||(t=r.get(e+3),n+=(t&Lr)<<21,t<Le)||(t=r.get(e+4),n+=(t&Lr)*Hm,t<Le)||(t=r.get(e+5),n+=(t&Lr)*Wm,t<Le)||(t=r.get(e+6),n+=(t&Lr)*Qm,t<Le)||(t=r.get(e+7),n+=(t&Lr)*Ym,t<Le))return n;throw new RangeError("Could not decode varint")}function m2(r,e,t=0){return e==null&&(e=Ys(qo(r))),e instanceof Uint8Array?Nee(r,e,t):Lee(r,e,t)}function Rh(r,e=0){return r instanceof Uint8Array?Mee(r,e):Uee(r,e)}const Bee=b2({prefix:"\0",name:"identity",encode:r=>qZ(r),decode:r=>jZ(r)}),zee=Object.freeze(Object.defineProperty({__proto__:null,identity:Bee},Symbol.toStringTag,{value:"Module"})),Fee=er({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Vee=Object.freeze(Object.defineProperty({__proto__:null,base2:Fee},Symbol.toStringTag,{value:"Module"})),jee=er({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),qee=Object.freeze(Object.defineProperty({__proto__:null,base8:jee},Symbol.toStringTag,{value:"Module"})),Kee=$h({prefix:"9",name:"base10",alphabet:"0123456789"}),Gee=Object.freeze(Object.defineProperty({__proto__:null,base10:Kee},Symbol.toStringTag,{value:"Module"})),Hee=er({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Wee=er({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Qee=Object.freeze(Object.defineProperty({__proto__:null,base16:Hee,base16upper:Wee},Symbol.toStringTag,{value:"Module"})),Yee=$h({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Xee=$h({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Jee=Object.freeze(Object.defineProperty({__proto__:null,base36:Yee,base36upper:Xee},Symbol.toStringTag,{value:"Module"})),Zee=er({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),ete=er({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),tte=er({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),rte=er({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),nte=Object.freeze(Object.defineProperty({__proto__:null,base64:Zee,base64pad:ete,base64url:tte,base64urlpad:rte},Symbol.toStringTag,{value:"Module"})),zC=Array.from(""),ste=zC.reduce((r,e,t)=>(r[t]=e,r),[]),ite=zC.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function ote(r){return r.reduce((e,t)=>(e+=ste[t],e),"")}function ate(r){const e=[];for(const t of r){const n=ite[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const cte=b2({prefix:"",name:"base256emoji",encode:ote,decode:ate}),lte=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:cte},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const ute={...zee,...Vee,...qee,...Gee,...Qee,...Ree,...Jee,...JZ,...nte,...lte},PE=es,dte=ts,FC=function(r){let e=0;if(r=r.toString().trim(),PE(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(dte(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=PE(t[n]);let o;i&&(o=FC(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},hte=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Rn=-1,Pd={},db={},fte=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Rn,"ip6zone"],[43,8,"ipcidr"],[53,Rn,"dns",!0],[54,Rn,"dns4",!0],[55,Rn,"dns6",!0],[56,Rn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Rn,"unix",!1,!0],[421,Rn,"ipfs"],[421,Rn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Rn,"garlic64"],[448,0,"tls"],[449,Rn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Rn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Rn,"memory"]];fte.forEach(r=>{const e=pte(...r);db[e.code]=e,Pd[e.name]=e});function pte(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function ct(r){if(typeof r=="number"){if(db[r]!=null)return db[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(Pd[r]!=null)return Pd[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}ct("ip4");ct("ip6");ct("ipcidr");function VC(r,e){switch(ct(r).code){case 4:case 41:return yte(e);case 42:return ME(e);case 6:case 273:case 33:case 132:return jC(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return ME(e);case 421:return Ete(e);case 444:return UE(e);case 445:return UE(e);case 466:return mte(e);default:return C(e,"base16")}}function kE(r,e){switch(ct(r).code){case 4:return NE(e);case 41:return NE(e);case 42:return LE(e);case 6:case 273:case 33:case 132:return Xm(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return LE(e);case 421:return wte(e);case 444:return vte(e);case 445:return _te(e);case 466:return bte(e);default:return L(e,"base16")}}const qg=Object.values(ute).map(r=>r.decoder),gte=function(){let r=qg[0].or(qg[1]);return qg.slice(2).forEach(e=>r=r.or(e)),r}();function NE(r){if(!tt(r))throw new Error("invalid ip address");return FC(r)}function yte(r){const e=hte(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function Xm(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function jC(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function LE(r){const e=L(r),t=Uint8Array.from(m2(e.length));return M([t,e],t.length+e.length)}function ME(r){const e=Rh(r);if(r=r.slice(qo(e)),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function wte(r){let e;r[0]==="Q"||r[0]==="1"?e=UC(gs.decode(`z${r}`)).bytes:e=BC.parse(r).multihash.bytes;const t=Uint8Array.from(m2(e.length));return M([t,e],t.length+e.length)}function bte(r){const e=gte.decode(r),t=Uint8Array.from(m2(e.length));return M([t,e],t.length+e.length)}function mte(r){const e=Rh(r),t=r.slice(qo(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function Ete(r){const e=Rh(r),t=r.slice(qo(e));if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function vte(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=Sa.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Xm(n);return M([t,s],t.length+s.length)}function _te(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Sa.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Xm(n);return M([t,s],t.length+s.length)}function UE(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=jC(t);return`${n}:${s}`}function Ste(r){r=hb(r);const e=[],t=[];let n=null;const s=r.split("/").slice(1);if(s.length===1&&s[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let i=0;i<s.length;i++){const o=s[i],a=ct(o);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(i++,i>=s.length)throw GC("invalid address: "+r);if(a.path===!0){n=hb(s.slice(i).join("/")),e.push([a.code,kE(a.code,n)]),t.push([a.code,n]);break}const c=kE(a.code,s[i]);e.push([a.code,c]),t.push([a.code,VC(a.code,c)])}return{string:qC(t),bytes:KC(e),tuples:e,stringTuples:t,path:n}}function BE(r){const e=[],t=[];let n=null,s=0;for(;s<r.length;){const i=Rh(r,s),o=qo(i),a=ct(i),c=Ate(a,r.slice(s+o));if(c===0){e.push([i]),t.push([i]),s+=o;continue}const u=r.slice(s+o,s+o+c);if(s+=c+o,s>r.length)throw GC("Invalid address Uint8Array: "+C(r,"base16"));e.push([i,u]);const l=VC(i,u);if(t.push([i,l]),a.path===!0){n=l;break}}return{bytes:Uint8Array.from(r),string:qC(t),tuples:e,stringTuples:t,path:n}}function qC(r){const e=[];return r.map(t=>{const n=ct(t[0]);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),hb(e.join("/"))}function KC(r){return M(r.map(e=>{const t=ct(e[0]);let n=Uint8Array.from(m2(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n}))}function Ate(r,e){if(r.size>0)return r.size/8;if(r.size===0)return 0;{const t=Rh(e instanceof Uint8Array?e:Uint8Array.from(e));return t+qo(t)}}function hb(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function GC(r){return new Error("Error parsing address: "+r)}const $te=Symbol.for("nodejs.util.inspect.custom"),Rte=[ct("dns").code,ct("dns4").code,ct("dns6").code,ct("dnsaddr").code],Tte=new Map,HC=Symbol.for("@multiformats/js-multiaddr/multiaddr");function Ite(r){return!!r?.[HC]}var Yc,go,eh,th,dVe,Ai;let Cte=(Ai=class{constructor(e){k(this,"bytes");vt(this,Yc,void 0);vt(this,go,void 0);vt(this,eh,void 0);vt(this,th,void 0);k(this,dVe,!0);e==null&&(e="");let t;if(e instanceof Uint8Array)t=BE(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=Ste(e)}else if(Ite(e))t=BE(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,Xe(this,Yc,t.string),Xe(this,go,t.tuples),Xe(this,eh,t.stringTuples),Xe(this,th,t.path)}toString(){return ce(this,Yc)}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=ct("tcp"),a=ct("udp"),c=ct("ip4"),u=ct("ip6"),l=ct("dns6"),d=ct("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),Rte.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=ct(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=ct(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return ce(this,go).map(([e])=>Object.assign({},ct(e)))}protoCodes(){return ce(this,go).map(([e])=>e)}protoNames(){return ce(this,go).map(([e])=>ct(e).name)}tuples(){return ce(this,go)}stringTuples(){return ce(this,eh)}encapsulate(e){return e=new Ai(e),new Ai(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Ai(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new Ai(KC(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([n,s])=>{n===Pd.p2p.code&&e.push([n,s]),n===Pd["p2p-circuit"].code&&(e=[])});const t=e.pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C(gs.decode(`z${n}`),"base58btc"):C(BC.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return ce(this,th)}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=Tte.get(t.name);if(n==null)throw new l2(`no available resolver for ${t.name}`,"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new Ai(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(dVe=HC,$te)](){return`Multiaddr(${ce(this,Yc)})`}},Yc=new WeakMap,go=new WeakMap,eh=new WeakMap,th=new WeakMap,Ai);function WC(r){return new Cte(r)}const xte=oe("dns4"),Dte=oe("dns6"),Ote=oe("dnsaddr"),Ma=Jr(oe("dns"),Ote,xte,Dte),E2=Jr(oe("ip4"),oe("ip6")),il=Jr(ye(E2,oe("tcp")),ye(Ma,oe("tcp"))),Jm=ye(E2,oe("udp")),Pte=ye(Jm,oe("utp")),kte=ye(Jm,oe("quic")),fb=Jr(ye(il,oe("ws")),ye(Ma,oe("ws"))),pb=Jr(ye(il,oe("wss")),ye(Ma,oe("wss")),ye(il,oe("tls"),oe("ws")),ye(Ma,oe("tls"),oe("ws"))),gb=Jr(ye(il,oe("http")),ye(E2,oe("http")),ye(Ma,oe("http"))),yb=Jr(ye(il,oe("https")),ye(E2,oe("https")),ye(Ma,oe("https"))),zE=ye(Jm,oe("webrtc"),oe("certhash")),QC=Jr(ye(zE,oe("p2p")),zE),YC=Jr(ye(fb,oe("p2p-webrtc-star"),oe("p2p")),ye(pb,oe("p2p-webrtc-star"),oe("p2p")),ye(fb,oe("p2p-webrtc-star")),ye(pb,oe("p2p-webrtc-star"))),XC=Jr(ye(gb,oe("p2p-webrtc-direct"),oe("p2p")),ye(yb,oe("p2p-webrtc-direct"),oe("p2p")),ye(gb,oe("p2p-webrtc-direct")),ye(yb,oe("p2p-webrtc-direct"))),wb=Jr(fb,pb,gb,yb,YC,XC,il,Pte,kte,Ma,QC),mo=Jr(ye(wb,oe("p2p")),YC,XC,QC,oe("p2p")),FE=Jr(ye(mo,oe("p2p-circuit"),mo),ye(mo,oe("p2p-circuit")),ye(oe("p2p-circuit"),mo),ye(wb,oe("p2p-circuit")),ye(oe("p2p-circuit"),wb),oe("p2p-circuit")),JC=()=>Jr(ye(FE,JC),FE),Zl=JC(),Nte=Jr(ye(Zl,mo,Zl),ye(mo,Zl),ye(Zl,mo),Zl,mo),Lte=Nte;function ZC(r){function e(t){let n;try{n=WC(t)}catch{return!1}const s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function ye(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:ZC(e),partialMatch:e}}function Jr(...r){function e(n){let s=null;return r.some(i=>{const o=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:ZC(e),partialMatch:e}}function oe(r){const e=r;function t(s){let i;try{i=WC(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}function ex(r){try{return Lte.matches(r)}catch{return!1}}function Mte({repo:r}){async function e(t,n={}){if(!ex(t))throw new Error(`${t} is not a valid Multiaddr`);const s=await r.config.getAll(n),i=s.Bootstrap||[];return i.push(t.toString()),s.Bootstrap=Array.from(new Set(i)).sort((o,a)=>o.localeCompare(a)),await r.config.replace(s),{Peers:[t]}}return F(e)}const VE=es,Ute=ts,tx=function(r){let e=0;if(r=r.toString().trim(),VE(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(Ute(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=VE(t[n]);let o;i&&(o=tx(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},Bte=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Tn=-1,r1={},bb={},zte=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Tn,"ip6zone"],[43,8,"ipcidr"],[53,Tn,"dns",!0],[54,Tn,"dns4",!0],[55,Tn,"dns6",!0],[56,Tn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc"],[281,0,"webrtc-w3c"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Tn,"unix",!1,!0],[421,Tn,"ipfs"],[421,Tn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Tn,"garlic64"],[448,0,"tls"],[449,Tn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Tn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Tn,"memory"]];zte.forEach(r=>{const e=Fte(...r);bb[e.code]=e,r1[e.name]=e});function Fte(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function Ct(r){if(typeof r=="number"){if(bb[r]!=null)return bb[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(r1[r]!=null)return r1[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}function Vte(r,e){switch(Ct(r).code){case 4:case 41:return Kte(e);case 42:return KE(e);case 6:case 273:case 33:case 132:return rx(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return KE(e);case 421:return Qte(e);case 444:return GE(e);case 445:return GE(e);case 466:return Wte(e);default:return C(e,"base16")}}function jte(r,e){switch(Ct(r).code){case 4:return jE(e);case 41:return jE(e);case 42:return qE(e);case 6:case 273:case 33:case 132:return Zm(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return qE(e);case 421:return Gte(e);case 444:return Yte(e);case 445:return Xte(e);case 466:return Hte(e);default:return L(e,"base16")}}const Kg=Object.values(DI).map(r=>r.decoder),qte=function(){let r=Kg[0].or(Kg[1]);return Kg.slice(2).forEach(e=>r=r.or(e)),r}();function jE(r){if(!tt(r))throw new Error("invalid ip address");return tx(r)}function Kte(r){const e=Bte(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function Zm(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function rx(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function qE(r){const e=L(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function KE(r){const e=D.decode(r);if(r=r.slice(D.decode.bytes),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function Gte(r){let e;r[0]==="Q"||r[0]==="1"?e=Sm(qr.decode(`z${r}`)).bytes:e=ne.parse(r).multihash.bytes;const t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function Hte(r){const e=qte.decode(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function Wte(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function Qte(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function Yte(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=Ea.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Zm(n);return M([t,s],t.length+s.length)}function Xte(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Ea.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=Zm(n);return M([t,s],t.length+s.length)}function GE(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=rx(t);return`${n}:${s}`}function Jte(r){const e=[],t=r.split("/").slice(1);if(t.length===1&&t[0]==="")return[];for(let n=0;n<t.length;n++){const s=t[n],i=Ct(s);if(i.size===0){e.push([s]);continue}if(n++,n>=t.length)throw ox("invalid address: "+r);if(i.path===!0){e.push([s,t4(t.slice(n).join("/"))]);break}e.push([s,t[n]])}return e}function Zte(r){const e=[];return r.map(t=>{const n=v2(t);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),t4(e.join("/"))}function ere(r){return r.map(e=>{Array.isArray(e)||(e=[e]);const t=v2(e);return e.length>1?[t.code,jte(t.code,e[1])]:[t.code]})}function nx(r){return r.map(e=>{const t=v2(e);return e[1]!=null?[t.code,Vte(t.code,e[1])]:[t.code]})}function sx(r){return mb(M(r.map(e=>{const t=v2(e);let n=Uint8Array.from(D.encode(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n})))}function ix(r,e){return r.size>0?r.size/8:r.size===0?0:D.decode(e)+(D.decode.bytes??0)}function e4(r){const e=[];let t=0;for(;t<r.length;){const n=D.decode(r,t),s=D.decode.bytes??0,i=Ct(n),o=ix(i,r.slice(t+s));if(o===0){e.push([n]),t+=s;continue}const a=r.slice(t+s,t+s+o);if(t+=o+s,t>r.length)throw ox("Invalid address Uint8Array: "+C(r,"base16"));e.push([n,a])}return e}function HE(r){const e=e4(r),t=nx(e);return Zte(t)}function tre(r){r=t4(r);const e=Jte(r),t=ere(e);return sx(t)}function rre(r){return tre(r)}function mb(r){const e=nre(r);if(e!=null)throw e;return Uint8Array.from(r)}function nre(r){try{e4(r)}catch(e){return e}}function t4(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function ox(r){return new Error("Error parsing address: "+r)}function v2(r){return Ct(r[0])}var lc=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Gg=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},eu,tu,ru,WE;const sre=Symbol.for("nodejs.util.inspect.custom"),ire=[Ct("dns").code,Ct("dns4").code,Ct("dns6").code,Ct("dnsaddr").code],ore=new Map,ax=Symbol.for("@multiformats/js-multiaddr/multiaddr");function are(r){return!!r?.[ax]}let cre=class Rc{constructor(e){if(eu.set(this,void 0),tu.set(this,void 0),ru.set(this,void 0),this[WE]=!0,e==null&&(e=""),e instanceof Uint8Array)this.bytes=mb(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=rre(e)}else if(are(e))this.bytes=mb(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr")}toString(){return lc(this,eu,"f")==null&&Gg(this,eu,HE(this.bytes),"f"),lc(this,eu,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=Ct("tcp"),a=Ct("udp"),c=Ct("ip4"),u=Ct("ip6"),l=Ct("dns6"),d=Ct("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),ire.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=Ct(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=Ct(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map(e=>Object.assign({},Ct(e)))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=D.decode(t,n),i=D.decode.bytes??0,o=Ct(s),a=ix(o,t.slice(n+i));n+=a+i,e.push(s)}return e}protoNames(){return this.protos().map(e=>e.name)}tuples(){return lc(this,tu,"f")==null&&Gg(this,tu,e4(this.bytes),"f"),lc(this,tu,"f")}stringTuples(){return lc(this,ru,"f")==null&&Gg(this,ru,nx(this.tuples()),"f"),lc(this,ru,"f")}encapsulate(e){return e=new Rc(e),new Rc(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Rc(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new Rc(sx(t.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter(n=>n[0]===r1.ipfs.code).pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C(qr.decode(`z${n}`),"base58btc"):C(ne.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){let e=null;try{e=this.stringTuples().filter(t=>Ct(t[0]).path===!0)[0][1],e==null&&(e=null)}catch{e=null}return e}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=ore.get(t.name);if(n==null)throw $(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new Rc(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(eu=new WeakMap,tu=new WeakMap,ru=new WeakMap,WE=ax,sre)](){return`Multiaddr(${HE(this.bytes)})`}};function xl(r){return new cre(r)}function lre({repo:r}){async function e(t={}){const n=await r.config.getAll(t),s=n.Bootstrap||[];return n.Bootstrap=[],await r.config.replace(n),{Peers:s.map(i=>xl(i))}}return F(e)}function ure({repo:r}){async function e(t={}){return{Peers:(await r.config.get("Bootstrap",t)||[]).map(s=>xl(s))}}return F(e)}const qc=()=>({Addresses:{Swarm:[],Announce:[],NoAnnounce:[],API:"",Gateway:"",RPC:"",Delegates:["/dns4/node0.delegate.ipfs.io/tcp/443/https","/dns4/node1.delegate.ipfs.io/tcp/443/https","/dns4/node2.delegate.ipfs.io/tcp/443/https","/dns4/node3.delegate.ipfs.io/tcp/443/https"]},Discovery:{MDNS:{Enabled:!1,Interval:10},webRTCStar:{Enabled:!0}},Bootstrap:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmZa1sAxajnQjVM8WjWXoMbmPd7NsWhfKsPkErzpm9wGkp","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dns4/node0.preload.ipfs.io/tcp/443/wss/p2p/QmZMxNdpMkewiVZLMRxaNxUeZpDUb34pWjZ1kZvsd16Zic","/dns4/node1.preload.ipfs.io/tcp/443/wss/p2p/Qmbut9Ywz9YEDrz8ySBSgWyJk41Uvm2QJPhwDJzJyGFsD6","/dns4/node2.preload.ipfs.io/tcp/443/wss/p2p/QmV7gnbW5VTcJ3oyM2Xk1rdFBJ3kTkvxc87UFGsun29STS","/dns4/node3.preload.ipfs.io/tcp/443/wss/p2p/QmY7JB6MQXhxHvq7dBDh4HpbH29v4yE9JRadAVpndvzySN"],Pubsub:{Enabled:!0},Swarm:{ConnMgr:{LowWater:5,HighWater:20},DisableNatPortMap:!0},Routing:{Type:"dhtclient"}});function dre({repo:r}){async function e(t={}){const n=await r.config.getAll(t);return n.Bootstrap=qc().Bootstrap,await r.config.replace(n),{Peers:qc().Bootstrap.map(s=>xl(s))}}return F(e)}function hre({repo:r}){async function e(t,n={}){if(!ex(t))throw new Error(`${t} is not a valid Multiaddr`);const s=await r.config.getAll(n);return s.Bootstrap=(s.Bootstrap||[]).filter(i=>i.toString()!==t.toString()),await r.config.replace(s),{Peers:[t]}}return F(e)}class fre{constructor({repo:e}){this.add=Mte({repo:e}),this.list=ure({repo:e}),this.rm=hre({repo:e}),this.clear=lre({repo:e}),this.reset=dre({repo:e})}}function pre({preload:r,repo:e}){async function t(n,s={}){return s.preload!==!1&&r(n),e.blocks.get(n,s)}return F(t)}function gre({codecs:r,hashers:e,repo:t,preload:n}){async function s(i,o={}){const a=o.pin?await t.gcLock.readLock():null;try{const c=o.version!=null?o.version:0,u=o.format||(c===0?"dag-pb":"raw"),d=await(await e.getHasher(o.mhtype||"sha2-256")).digest(i),f=await r.getCodec(u),g=ne.create(c,f.code,d);return await t.blocks.put(g,i,{signal:o.signal}),o.preload!==!1&&n(g),o.pin===!0&&await t.pins.pinRecursively(g,{signal:o.signal}),g}finally{a&&a()}}return F(s)}const hf=globalThis.CustomEvent??Event;async function*_2(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered==null?!1:e.ordered,s=new EventTarget,i=[];let o=Pe(),a=Pe(),c=!1,u,l=!1;s.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const h of r){if(i.length===t&&(o=Pe(),await o.promise),l)break;const p={done:!1};i.push(p),h().then(w=>{p.done=!0,p.ok=!0,p.value=w,s.dispatchEvent(new hf("task-complete"))},w=>{p.done=!0,p.err=w,s.dispatchEvent(new hf("task-complete"))})}c=!0,s.dispatchEvent(new hf("task-complete"))}catch(h){u=h,s.dispatchEvent(new hf("task-complete"))}});function d(){return n?i[0]?.done:!!i.find(h=>h.done)}function*f(){for(;i.length>0&&i[0].done;){const h=i[0];if(i.shift(),h.ok)yield h.value;else throw l=!0,o.resolve(),h.err;o.resolve()}}function*g(){for(;d();)for(let h=0;h<i.length;h++)if(i[h].done){const p=i[h];if(i.splice(h,1),h--,p.ok)yield p.value;else throw l=!0,o.resolve(),p.err;o.resolve()}}for(;;){if(d()||(a=Pe(),await a.promise),u!=null)throw u;if(n?yield*f():yield*g(),c&&i.length===0)break}}function cx(r){return r instanceof Uint8Array?ne.decode(r):ne.parse(r.toString())}const yre=8;function wre({repo:r}){async function*e(t,n={}){Array.isArray(t)||(t=[t]);const s=await r.gcLock.writeLock();try{yield*Ae(t,i=>Xr(i,o=>async()=>{o=cx(o);const a={cid:o};try{if(!await r.blocks.has(o))throw $(new Error("block not found"),"ERR_BLOCK_NOT_FOUND");await r.blocks.delete(o)}catch(c){n.force||(c.message=`cannot remove ${o}: ${c.message}`,a.error=c)}return a}),i=>_2(i,{concurrency:yre}),i=>dt(i,()=>!n.quiet))}finally{s()}}return F(e)}function bre({repo:r,preload:e}){async function t(n,s={}){n=cx(n),s.preload!==!1&&e(n);const i=await r.blocks.get(n);return{cid:n,size:i.length}}return F(t)}class mre{constructor({codecs:e,hashers:t,preload:n,repo:s}){this.get=pre({preload:n,repo:s}),this.put=gre({codecs:e,hashers:t,preload:n,repo:s}),this.rm=wre({repo:s}),this.stat=bre({preload:n,repo:s})}}async function*Ua(r,e={}){const t=r.getReader();try{for(;;){const n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}function Ere(r){return typeof r.stream=="function"?Ua(r.stream()):Ua(new Response(r).body)}function Th(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:s=>{n.push(s)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function Bo(r){return ArrayBuffer.isView(r)||r instanceof ArrayBuffer}function kd(r){return r.constructor&&(r.constructor.name==="Blob"||r.constructor.name==="File")&&typeof r.stream=="function"}function Eb(r){return typeof r=="object"&&(r.path||r.content)}const Nd=r=>r&&typeof r.getReader=="function";async function*ff(r){yield r}async function lx(r){if(Bo(r))return ff(Hg(r));if(typeof r=="string"||r instanceof String)return ff(Hg(r.toString()));if(kd(r))return Ere(r);if(Nd(r)&&(r=Ua(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const e=Th(r),{value:t,done:n}=await e.peek();if(n)return ff(new Uint8Array(0));if(e.push(t),Number.isInteger(t))return ff(Uint8Array.from(await jo(e)));if(Bo(t)||typeof t=="string"||t instanceof String)return Xr(e,Hg)}throw $(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT")}function Hg(r){return r instanceof Uint8Array?r:ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r instanceof ArrayBuffer?new Uint8Array(r):Array.isArray(r)?Uint8Array.from(r):L(r.toString())}async function*vre(r,e){if(r==null)throw $(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT");if(typeof r=="string"||r instanceof String){yield pf(r.toString(),e);return}if(Bo(r)||kd(r)){yield pf(r,e);return}if(Nd(r)&&(r=Ua(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const t=Th(r),{value:n,done:s}=await t.peek();if(s){yield{content:[]};return}if(t.push(n),Number.isInteger(n)||Bo(n)||typeof n=="string"||n instanceof String){yield pf(t,e);return}throw $(new Error("Unexpected input: multiple items passed - if you are using ipfs.add, please use ipfs.addAll instead"),"ERR_UNEXPECTED_INPUT")}if(Eb(r)){yield pf(r,e);return}throw $(new Error('Unexpected input: cannot convert "'+typeof r+'" into ImportCandidate'),"ERR_UNEXPECTED_INPUT")}async function pf(r,e){const{path:t,mode:n,mtime:s,content:i}=r,o={path:t||"",mode:jc(n),mtime:Cd(s)};return i?o.content=await e(i):t||(o.content=await e(r)),o}function ux(r){return vre(r,lx)}function _re({addAll:r}){async function e(t,n={}){const s=await En(r(ux(t),n));if(s==null)throw Error("Failed to add a file, if you see this please report a bug");return s}return e}async function*r4(r,e=1){let t=[];e<1&&(e=1);for await(const n of r)for(t.push(n);t.length>=e;)yield t.slice(0,e),t=t.slice(e);for(;t.length>0;)yield t.slice(0,e),t=t.slice(e)}async function*n4(r,e=1){for await(const t of r4(r,e)){const n=t.map(async s=>await s().then(i=>({ok:!0,value:i}),i=>({ok:!1,err:i})));for(let s=0;s<n.length;s++){const i=await n[s];if(i.ok)yield i.value;else throw i.err}}}const Sre=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Ih=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};var Are=dx,QE=128,$re=127,Rre=~$re,Tre=Math.pow(2,31);function dx(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Tre;)e[t++]=r&255|QE,r/=128;for(;r&Rre;)e[t++]=r&255|QE,r>>>=7;return e[t]=r|0,dx.bytes=t-n+1,e}var Ire=vb,Cre=128,YE=127;function vb(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw vb.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&YE)<<s:(o&YE)*Math.pow(2,s),s+=7}while(o>=Cre);return vb.bytes=i-n,t}var xre=Math.pow(2,7),Dre=Math.pow(2,14),Ore=Math.pow(2,21),Pre=Math.pow(2,28),kre=Math.pow(2,35),Nre=Math.pow(2,42),Lre=Math.pow(2,49),Mre=Math.pow(2,56),Ure=Math.pow(2,63),Bre=function(r){return r<xre?1:r<Dre?2:r<Ore?3:r<Pre?4:r<kre?5:r<Nre?6:r<Lre?7:r<Mre?8:r<Ure?9:10},zre={encode:Are,decode:Ire,encodingLength:Bre},n1=zre;const _b=(r,e=0)=>[n1.decode(r,e),n1.decode.bytes],s1=(r,e,t=0)=>(n1.encode(r,e,t),e),i1=r=>n1.encodingLength(r),Sb=(r,e)=>{const t=e.byteLength,n=i1(r),s=n+i1(t),i=new Uint8Array(s+t);return s1(r,i,0),s1(t,i,n),i.set(e,s),new s4(r,t,e,i)},Fre=r=>{const e=Ih(r),[t,n]=_b(e),[s,i]=_b(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new s4(t,s,o,e)},Vre=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Sre(r.bytes,t.bytes)}};let s4=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const jre=({name:r,code:e,encode:t})=>new qre(r,e,t);let qre=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Sb(this.code,t):t.then(n=>Sb(this.code,n))}else throw Error("Unknown type, must be binary type")}};const Kre=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),Ab=jre({name:"sha2-256",code:18,encode:Kre("SHA-256")});var Gre=hx,XE=128,Hre=127,Wre=~Hre,Qre=Math.pow(2,31);function hx(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Qre;)e[t++]=r&255|XE,r/=128;for(;r&Wre;)e[t++]=r&255|XE,r>>>=7;return e[t]=r|0,hx.bytes=t-n+1,e}var Yre=$b,Xre=128,JE=127;function $b(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw $b.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&JE)<<s:(o&JE)*Math.pow(2,s),s+=7}while(o>=Xre);return $b.bytes=i-n,t}var Jre=Math.pow(2,7),Zre=Math.pow(2,14),ene=Math.pow(2,21),tne=Math.pow(2,28),rne=Math.pow(2,35),nne=Math.pow(2,42),sne=Math.pow(2,49),ine=Math.pow(2,56),one=Math.pow(2,63),ane=function(r){return r<Jre?1:r<Zre?2:r<ene?3:r<tne?4:r<rne?5:r<nne?6:r<sne?7:r<ine?8:r<one?9:10},cne={encode:Gre,decode:Yre,encodingLength:ane},fx=cne;const ZE=(r,e,t=0)=>(fx.encode(r,e,t),e),e9=r=>fx.encodingLength(r),lne=new Uint8Array(0),une=r=>{const e=r.match(/../g);return e?new Uint8Array(e.map(t=>parseInt(t,16))):lne},dne=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},t9=(r,e)=>{const t=e.byteLength,n=e9(r),s=n+e9(t),i=new Uint8Array(s+t);return ZE(r,i,0),ZE(t,i,n),i.set(e,s),new hne(r,t,e,i)};let hne=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function fne(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var pne=fne,gne=pne;let yne=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},wne=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return px(this,e)}},bne=class{constructor(e){this.decoders=e}or(e){return px(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const px=(r,e)=>new bne({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let mne=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new yne(e,t,n),this.decoder=new wne(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const gx=({name:r,prefix:e,encode:t,decode:n})=>new mne(r,e,t,n),yx=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=gne(t,e);return gx({prefix:r,name:e,encode:n,decode:i=>dne(s(i))})},Ene=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},vne=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Li=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>gx({prefix:e,name:r,encode(s){return vne(s,n,t)},decode(s){return Ene(s,n,t,r)}});yx({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});yx({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});Li({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Li({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Li({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Li({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Li({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Li({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Li({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Li({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Li({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const _ne=({name:r,code:e,encode:t})=>new Sne(r,e,t);let Sne=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?t9(this.code,t):t.then(n=>t9(this.code,n))}else throw Error("Unknown type, must be binary type")}};var Rb={exports:{}};(function(r,e){(function(t,n){var s={version:"3.0.0",x86:{},x64:{},inputValidation:!0};function i(p){if(!Array.isArray(p)&&!ArrayBuffer.isView(p))return!1;for(var w=0;w<p.length;w++)if(!Number.isInteger(p[w])||p[w]<0||p[w]>255)return!1;return!0}function o(p,w){return(p&65535)*w+(((p>>>16)*w&65535)<<16)}function a(p,w){return p<<w|p>>>32-w}function c(p){return p^=p>>>16,p=o(p,2246822507),p^=p>>>13,p=o(p,3266489909),p^=p>>>16,p}function u(p,w){p=[p[0]>>>16,p[0]&65535,p[1]>>>16,p[1]&65535],w=[w[0]>>>16,w[0]&65535,w[1]>>>16,w[1]&65535];var y=[0,0,0,0];return y[3]+=p[3]+w[3],y[2]+=y[3]>>>16,y[3]&=65535,y[2]+=p[2]+w[2],y[1]+=y[2]>>>16,y[2]&=65535,y[1]+=p[1]+w[1],y[0]+=y[1]>>>16,y[1]&=65535,y[0]+=p[0]+w[0],y[0]&=65535,[y[0]<<16|y[1],y[2]<<16|y[3]]}function l(p,w){p=[p[0]>>>16,p[0]&65535,p[1]>>>16,p[1]&65535],w=[w[0]>>>16,w[0]&65535,w[1]>>>16,w[1]&65535];var y=[0,0,0,0];return y[3]+=p[3]*w[3],y[2]+=y[3]>>>16,y[3]&=65535,y[2]+=p[2]*w[3],y[1]+=y[2]>>>16,y[2]&=65535,y[2]+=p[3]*w[2],y[1]+=y[2]>>>16,y[2]&=65535,y[1]+=p[1]*w[3],y[0]+=y[1]>>>16,y[1]&=65535,y[1]+=p[2]*w[2],y[0]+=y[1]>>>16,y[1]&=65535,y[1]+=p[3]*w[1],y[0]+=y[1]>>>16,y[1]&=65535,y[0]+=p[0]*w[3]+p[1]*w[2]+p[2]*w[1]+p[3]*w[0],y[0]&=65535,[y[0]<<16|y[1],y[2]<<16|y[3]]}function d(p,w){return w%=64,w===32?[p[1],p[0]]:w<32?[p[0]<<w|p[1]>>>32-w,p[1]<<w|p[0]>>>32-w]:(w-=32,[p[1]<<w|p[0]>>>32-w,p[0]<<w|p[1]>>>32-w])}function f(p,w){return w%=64,w===0?p:w<32?[p[0]<<w|p[1]>>>32-w,p[1]<<w]:[p[1]<<w-32,0]}function g(p,w){return[p[0]^w[0],p[1]^w[1]]}function h(p){return p=g(p,[0,p[0]>>>1]),p=l(p,[4283543511,3981806797]),p=g(p,[0,p[0]>>>1]),p=l(p,[3301882366,444984403]),p=g(p,[0,p[0]>>>1]),p}s.x86.hash32=function(p,w){if(s.inputValidation&&!i(p))return n;w=w||0;for(var y=p.length%4,E=p.length-y,m=w,b=0,v=3432918353,S=461845907,_=0;_<E;_=_+4)b=p[_]|p[_+1]<<8|p[_+2]<<16|p[_+3]<<24,b=o(b,v),b=a(b,15),b=o(b,S),m^=b,m=a(m,13),m=o(m,5)+3864292196;switch(b=0,y){case 3:b^=p[_+2]<<16;case 2:b^=p[_+1]<<8;case 1:b^=p[_],b=o(b,v),b=a(b,15),b=o(b,S),m^=b}return m^=p.length,m=c(m),m>>>0},s.x86.hash128=function(p,w){if(s.inputValidation&&!i(p))return n;w=w||0;for(var y=p.length%16,E=p.length-y,m=w,b=w,v=w,S=w,_=0,A=0,T=0,P=0,V=597399067,Y=2869860233,te=951274213,se=2716044179,Q=0;Q<E;Q=Q+16)_=p[Q]|p[Q+1]<<8|p[Q+2]<<16|p[Q+3]<<24,A=p[Q+4]|p[Q+5]<<8|p[Q+6]<<16|p[Q+7]<<24,T=p[Q+8]|p[Q+9]<<8|p[Q+10]<<16|p[Q+11]<<24,P=p[Q+12]|p[Q+13]<<8|p[Q+14]<<16|p[Q+15]<<24,_=o(_,V),_=a(_,15),_=o(_,Y),m^=_,m=a(m,19),m+=b,m=o(m,5)+1444728091,A=o(A,Y),A=a(A,16),A=o(A,te),b^=A,b=a(b,17),b+=v,b=o(b,5)+197830471,T=o(T,te),T=a(T,17),T=o(T,se),v^=T,v=a(v,15),v+=S,v=o(v,5)+2530024501,P=o(P,se),P=a(P,18),P=o(P,V),S^=P,S=a(S,13),S+=m,S=o(S,5)+850148119;switch(_=0,A=0,T=0,P=0,y){case 15:P^=p[Q+14]<<16;case 14:P^=p[Q+13]<<8;case 13:P^=p[Q+12],P=o(P,se),P=a(P,18),P=o(P,V),S^=P;case 12:T^=p[Q+11]<<24;case 11:T^=p[Q+10]<<16;case 10:T^=p[Q+9]<<8;case 9:T^=p[Q+8],T=o(T,te),T=a(T,17),T=o(T,se),v^=T;case 8:A^=p[Q+7]<<24;case 7:A^=p[Q+6]<<16;case 6:A^=p[Q+5]<<8;case 5:A^=p[Q+4],A=o(A,Y),A=a(A,16),A=o(A,te),b^=A;case 4:_^=p[Q+3]<<24;case 3:_^=p[Q+2]<<16;case 2:_^=p[Q+1]<<8;case 1:_^=p[Q],_=o(_,V),_=a(_,15),_=o(_,Y),m^=_}return m^=p.length,b^=p.length,v^=p.length,S^=p.length,m+=b,m+=v,m+=S,b+=m,v+=m,S+=m,m=c(m),b=c(b),v=c(v),S=c(S),m+=b,m+=v,m+=S,b+=m,v+=m,S+=m,("00000000"+(m>>>0).toString(16)).slice(-8)+("00000000"+(b>>>0).toString(16)).slice(-8)+("00000000"+(v>>>0).toString(16)).slice(-8)+("00000000"+(S>>>0).toString(16)).slice(-8)},s.x64.hash128=function(p,w){if(s.inputValidation&&!i(p))return n;w=w||0;for(var y=p.length%16,E=p.length-y,m=[0,w],b=[0,w],v=[0,0],S=[0,0],_=[2277735313,289559509],A=[1291169091,658871167],T=0;T<E;T=T+16)v=[p[T+4]|p[T+5]<<8|p[T+6]<<16|p[T+7]<<24,p[T]|p[T+1]<<8|p[T+2]<<16|p[T+3]<<24],S=[p[T+12]|p[T+13]<<8|p[T+14]<<16|p[T+15]<<24,p[T+8]|p[T+9]<<8|p[T+10]<<16|p[T+11]<<24],v=l(v,_),v=d(v,31),v=l(v,A),m=g(m,v),m=d(m,27),m=u(m,b),m=u(l(m,[0,5]),[0,1390208809]),S=l(S,A),S=d(S,33),S=l(S,_),b=g(b,S),b=d(b,31),b=u(b,m),b=u(l(b,[0,5]),[0,944331445]);switch(v=[0,0],S=[0,0],y){case 15:S=g(S,f([0,p[T+14]],48));case 14:S=g(S,f([0,p[T+13]],40));case 13:S=g(S,f([0,p[T+12]],32));case 12:S=g(S,f([0,p[T+11]],24));case 11:S=g(S,f([0,p[T+10]],16));case 10:S=g(S,f([0,p[T+9]],8));case 9:S=g(S,[0,p[T+8]]),S=l(S,A),S=d(S,33),S=l(S,_),b=g(b,S);case 8:v=g(v,f([0,p[T+7]],56));case 7:v=g(v,f([0,p[T+6]],48));case 6:v=g(v,f([0,p[T+5]],40));case 5:v=g(v,f([0,p[T+4]],32));case 4:v=g(v,f([0,p[T+3]],24));case 3:v=g(v,f([0,p[T+2]],16));case 2:v=g(v,f([0,p[T+1]],8));case 1:v=g(v,[0,p[T]]),v=l(v,_),v=d(v,31),v=l(v,A),m=g(m,v)}return m=g(m,[0,p.length]),b=g(b,[0,p.length]),m=u(m,b),b=u(b,m),m=h(m),b=h(b),m=u(m,b),b=u(b,m),("00000000"+(m[0]>>>0).toString(16)).slice(-8)+("00000000"+(m[1]>>>0).toString(16)).slice(-8)+("00000000"+(b[0]>>>0).toString(16)).slice(-8)+("00000000"+(b[1]>>>0).toString(16)).slice(-8)},r.exports&&(e=r.exports=s),e.murmurHash3=s})()})(Rb,Rb.exports);var Ane=Rb.exports,$ne=Ane;const Rne=Ge($ne),S2=_ne({name:"murmur3-128",code:34,encode:r=>une(Rne.x64.hash128(r))});async function Tne(r){return(await S2.encode(r)).slice(0,8).reverse()}const Ine={chunker:"fixed",strategy:"balanced",rawLeaves:!1,onlyHash:!1,reduceSingleLeafToSelf:!0,hasher:Ab,leafType:"file",cidVersion:0,progress:()=>()=>{},shardSplitThreshold:1e3,fileImportConcurrency:50,blockWriteConcurrency:10,minChunkSize:262144,maxChunkSize:262144,avgChunkSize:262144,window:16,polynomial:0x3df305dfb2a804,maxChildrenPerNode:174,layerRepeat:4,wrapWithDirectory:!1,recursive:!1,hidden:!1,timeout:void 0,hamtHashFn:Tne,hamtHashCode:34,hamtBucketBits:8},Cne=(r={})=>et.bind({ignoreUndefined:!0})(Ine,r);function xne(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var Dne=xne,One=Dne;let Pne=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},kne=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return wx(this,e)}},Nne=class{constructor(e){this.decoders=e}or(e){return wx(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const wx=(r,e)=>new Nne({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let Lne=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Pne(e,t,n),this.decoder=new kne(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const bx=({name:r,prefix:e,encode:t,decode:n})=>new Lne(r,e,t,n),mx=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=One(t,e);return bx({prefix:r,name:e,encode:n,decode:i=>Ih(s(i))})},Mne=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Une=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Mi=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>bx({prefix:e,name:r,encode(s){return Une(s,n,t)},decode(s){return Mne(s,n,t,r)}}),so=mx({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});mx({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const op=Mi({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Mi({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Mi({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Mi({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Mi({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Mi({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Mi({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Mi({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Mi({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const r9=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Fne(t,Tb(r),e||so.encoder);default:return Vne(t,Tb(r),e||op.encoder)}},n9=new WeakMap,Tb=r=>{const e=n9.get(r);if(e==null){const t=new Map;return n9.set(r,t),t}return e};let Bne=class br{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==nu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==jne)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return br.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Sb(e,t);return br.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return br.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Vre(e.multihash,n.multihash)}toString(e){return r9(this,e)}toJSON(){return{"/":r9(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof br)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new br(n,s,i,o||s9(n,s,i.bytes))}else if(t[qne]===!0){const{version:n,multihash:s,code:i}=t,o=Fre(s);return br.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==nu)throw new Error(`Version 0 CID must use dag-pb (code: ${nu}) block encoding`);return new br(e,t,n,n.bytes)}case 1:{const s=s9(e,t,n.bytes);return new br(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return br.create(0,nu,e)}static createV1(e,t){return br.create(1,e,t)}static decode(e){const[t,n]=br.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=br.inspectBytes(e),n=t.size-t.multihashSize,s=Ih(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new s4(t.multihashCode,t.digestSize,i,s);return[t.version===0?br.createV0(o):br.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=_b(e.subarray(t));return t+=f,d};let s=n(),i=nu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=zne(e,t),i=br.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Tb(i).set(n,e),i}};const zne=(r,e)=>{switch(r[0]){case"Q":{const t=e||so;return[so.prefix,t.decode(`${so.prefix}${r}`)]}case so.prefix:{const t=e||so;return[so.prefix,t.decode(r)]}case op.prefix:{const t=e||op;return[op.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Fne=(r,e,t)=>{const{prefix:n}=t;if(n!==so.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Vne=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},nu=112,jne=18,s9=(r,e,t)=>{const n=i1(r),s=n+i1(e),i=new Uint8Array(s+t.byteLength);return s1(r,i,0),s1(e,i,n),i.set(t,s),i},qne=Symbol.for("@ipld/js-cid/CID"),ol=async(r,e,t)=>{t.codec||(t.codec=Lo),t.hasher||(t.hasher=Ab),t.cidVersion===void 0&&(t.cidVersion=1),t.codec===Lo&&t.hasher!==Ab&&(t.cidVersion=1);const n=await t.hasher.digest(r),s=Bne.create(t.cidVersion,t.codec.code,n);return t.onlyHash||await e.put(s,r,{signal:t.signal}),s},Kne=async(r,e,t)=>{const n=new Ze({type:"directory",mtime:r.mtime,mode:r.mode}),s=Je(Mo({Data:n.marshal()})),i=await ol(s,e,t),o=r.path;return{cid:i,path:o,unixfs:n,size:s.length}},Gne="raw",Ib=85,Hne=r=>Ih(r),Wne=r=>Ih(r),Qne=Object.freeze(Object.defineProperty({__proto__:null,code:Ib,decode:Wne,encode:Hne,name:Gne},Symbol.toStringTag,{value:"Module"}));async function Yne(r,e){return e(await jo(r))}function Xne(r,e,t){return Ex(r,e,t)}async function Ex(r,e,t){const n=[];for await(const s of r4(r,t.maxChildrenPerNode))n.push(await e(s));return n.length>1?Ex(n,e,t):n[0]}async function Jne(r,e,t){const n=new Zne(t.layerRepeat);let s=0,i=1,o=n;for await(const a of r4(r,t.maxChildrenPerNode))o.isFull()&&(o!==n&&n.addChild(await o.reduce(e)),s&&s%t.layerRepeat===0&&i++,o=new vx(i,t.layerRepeat,s),s++),o.append(a);return o&&o!==n&&n.addChild(await o.reduce(e)),n.reduce(e)}class vx{constructor(e,t,n=0){this.maxDepth=e,this.layerRepeat=t,this.currentDepth=1,this.iteration=n,this.root=this.node=this.parent={children:[],depth:this.currentDepth,maxDepth:e,maxChildren:(this.maxDepth-this.currentDepth)*this.layerRepeat}}isFull(){if(!this.root.data)return!1;if(this.currentDepth<this.maxDepth&&this.node.maxChildren)return this._addNextNodeToParent(this.node),!1;const e=this._findParent(this.node,this.currentDepth);return e?(this._addNextNodeToParent(e),!1):!0}_addNextNodeToParent(e){this.parent=e;const t={children:[],depth:e.depth+1,parent:e,maxDepth:this.maxDepth,maxChildren:Math.floor(e.children.length/this.layerRepeat)*this.layerRepeat};e.children.push(t),this.currentDepth=t.depth,this.node=t}append(e){this.node.data=e}reduce(e){return this._reduce(this.root,e)}async _reduce(e,t){let n=[];return e.children.length&&(n=await Promise.all(e.children.filter(s=>s.data).map(s=>this._reduce(s,t)))),t((e.data||[]).concat(n))}_findParent(e,t){const n=e.parent;if(!(!n||n.depth===0))return n.children.length===n.maxChildren||!n.maxChildren?this._findParent(n,t):n}}class Zne extends vx{constructor(e){super(0,e),this.root.depth=0,this.currentDepth=1}addChild(e){this.root.children.push(e)}reduce(e){return e((this.root.data||[]).concat(this.root.children))}}async function*ese(r,e,t){for await(let n of r.content)yield async()=>{t.progress(n.length,r.path);let s;const i={codec:Lo,cidVersion:t.cidVersion,hasher:t.hasher,onlyHash:t.onlyHash};return t.rawLeaves?(i.codec=Qne,i.cidVersion=1):(s=new Ze({type:t.leafType,data:n}),n=Je({Data:s.marshal(),Links:[]})),{cid:await ol(n,e,i),unixfs:s,size:n.length}}}const tse={flat:Yne,balanced:Xne,trickle:Jne};async function*rse(r,e,t){let n=-1,s,i;typeof t.bufferImporter=="function"?i=t.bufferImporter:i=ese;for await(const o of n4(i(r,e,t),t.blockWriteConcurrency)){if(n++,n===0){s=o;continue}else n===1&&s&&(yield s,s=null);yield o}s&&(s.single=!0,yield s)}const nse=(r,e,t)=>{async function n(s){if(s.length===1&&s[0].single&&t.reduceSingleLeafToSelf){const l=s[0];if(r.mtime!==void 0||r.mode!==void 0){let d=await e.get(l.cid);l.unixfs=new Ze({type:"file",mtime:r.mtime,mode:r.mode,data:d}),d=Je(Mo({Data:l.unixfs.marshal()})),l.cid=await ol(d,e,{...t,codec:Lo,hasher:t.hasher,cidVersion:t.cidVersion}),l.size=d.length}return{cid:l.cid,path:r.path,unixfs:l.unixfs,size:l.size}}const i=new Ze({type:"file",mtime:r.mtime,mode:r.mode}),o=s.filter(l=>l.cid.code===Ib&&l.size||l.unixfs&&!l.unixfs.data&&l.unixfs.fileSize()?!0:!!(l.unixfs&&l.unixfs.data&&l.unixfs.data.length)).map(l=>l.cid.code===Ib?(i.addBlockSize(l.size),{Name:"",Tsize:l.size,Hash:l.cid}):(!l.unixfs||!l.unixfs.data?i.addBlockSize(l.unixfs&&l.unixfs.fileSize()||0):i.addBlockSize(l.unixfs.data.length),{Name:"",Tsize:l.size,Hash:l.cid})),a={Data:i.marshal(),Links:o},c=Je(Mo(a));return{cid:await ol(c,e,t),path:r.path,unixfs:i,size:c.length+a.Links.reduce((l,d)=>l+d.Tsize,0)}}return n};function sse(r,e,t){const n=tse[t.strategy];if(!n)throw $(new Error(`Unknown importer build strategy name: ${t.strategy}`),"ERR_BAD_STRATEGY");return n(rse(r,e,t),nse(r,e,t),t)}let ise=class{constructor(e,t=12,n=8*1024,s=32*1024,i=64,o){this.bits=t,this.min=n,this.max=s,this.asModule=e,this.rabin=new e.Rabin(t,n,s,i,o),this.polynomial=o}fingerprint(e){const{__retain:t,__release:n,__allocArray:s,__getInt32Array:i,Int32Array_ID:o,Uint8Array_ID:a}=this.asModule,c=new Int32Array(Math.ceil(e.length/this.min)),u=t(s(o,c)),l=t(s(a,e)),d=this.rabin.fingerprint(l,u),f=i(d);n(l),n(u);const g=f.indexOf(0);return g>=0?f.subarray(0,g):f}};var ose=ise,Ch={};const Wg=-8,ap=-4,ase=0,i9=1,o9=1,gf=2,cse=5,a9=1024,c9=2048,lse=8192,use=0,Qg=4,dse=8,hse=12,l9=12,fse=16,pse=typeof BigUint64Array<"u",su=Symbol(),iu=1024;function _x(r,e){const t=new Uint32Array(r),n=new Uint16Array(r);var s=t[e+ap>>>2]>>>1,i=e>>>1;if(s<=iu)return String.fromCharCode.apply(String,n.subarray(i,i+s));const o=[];do{const a=n[i+iu-1],c=a>=55296&&a<56320?iu-1:iu;o.push(String.fromCharCode.apply(String,n.subarray(i,i+=c))),s-=c}while(s>iu);return o.join("")+String.fromCharCode.apply(String,n.subarray(i,i+s))}function i4(r){const e={};function t(s,i){return s?_x(s.buffer,i):"<yet unknown>"}const n=r.env=r.env||{};return n.abort=n.abort||function(i,o,a,c){const u=e.memory||n.memory;throw Error("abort: "+t(u,i)+" at "+t(u,o)+":"+a+":"+c)},n.trace=n.trace||function(i,o){const a=e.memory||n.memory;console.log("trace: "+t(a,i)+(o?" ":"")+Array.prototype.slice.call(arguments,2,2+o).join(", "))},r.Math=r.Math||Math,r.Date=r.Date||Date,e}function o4(r,e){const t=e.exports,n=t.memory,s=t.table,i=t.__alloc,o=t.__retain,a=t.__rtti_base||-1;function c(v){const S=new Uint32Array(n.buffer),_=S[a>>>2];if((v>>>=0)>=_)throw Error("invalid id: "+v);return S[(a+4>>>2)+v*2]}function u(v){const S=new Uint32Array(n.buffer),_=S[a>>>2];if((v>>>=0)>=_)throw Error("invalid id: "+v);return S[(a+4>>>2)+v*2+1]}function l(v){return 31-Math.clz32(v>>>cse&31)}function d(v){const S=v.length,_=i(S<<1,i9),A=new Uint16Array(n.buffer);for(var T=0,P=_>>>1;T<S;++T)A[P+T]=v.charCodeAt(T);return _}r.__allocString=d;function f(v){const S=n.buffer;if(new Uint32Array(S)[v+Wg>>>2]!==i9)throw Error("not a string: "+v);return _x(S,v)}r.__getString=f;function g(v,S,_){const A=n.buffer;if(_)switch(v){case 2:return new Float32Array(A);case 3:return new Float64Array(A)}else switch(v){case 0:return new(S?Int8Array:Uint8Array)(A);case 1:return new(S?Int16Array:Uint16Array)(A);case 2:return new(S?Int32Array:Uint32Array)(A);case 3:return new(S?BigInt64Array:BigUint64Array)(A)}throw Error("unsupported align: "+v)}function h(v,S){const _=c(v);if(!(_&(o9|gf)))throw Error("not an array: "+v+" @ "+_);const A=l(_),T=S.length,P=i(T<<A,ase),V=i(_&gf?fse:hse,v),Y=new Uint32Array(n.buffer);Y[V+use>>>2]=o(P),Y[V+Qg>>>2]=P,Y[V+dse>>>2]=T<<A,_&gf&&(Y[V+l9>>>2]=T);const te=g(A,_&a9,_&c9);if(_&lse)for(let se=0;se<T;++se)te[(P>>>A)+se]=o(S[se]);else te.set(S,P>>>A);return V}r.__allocArray=h;function p(v){const S=new Uint32Array(n.buffer),_=S[v+Wg>>>2],A=c(_);if(!(A&o9))throw Error("not an array: "+_);const T=l(A);var P=S[v+Qg>>>2];const V=A&gf?S[v+l9>>>2]:S[P+ap>>>2]>>>T;return g(T,A&a9,A&c9).subarray(P>>>=T,P+V)}r.__getArrayView=p;function w(v){const S=p(v),_=S.length,A=new Array(_);for(let T=0;T<_;T++)A[T]=S[T];return A}r.__getArray=w;function y(v){const S=n.buffer,_=new Uint32Array(S)[v+ap>>>2];return S.slice(v,v+_)}r.__getArrayBuffer=y;function E(v,S,_){return new v(m(v,S,_))}function m(v,S,_){const A=n.buffer,T=new Uint32Array(A),P=T[_+Qg>>>2];return new v(A,P,T[P+ap>>>2]>>>S)}r.__getInt8Array=E.bind(null,Int8Array,0),r.__getInt8ArrayView=m.bind(null,Int8Array,0),r.__getUint8Array=E.bind(null,Uint8Array,0),r.__getUint8ArrayView=m.bind(null,Uint8Array,0),r.__getUint8ClampedArray=E.bind(null,Uint8ClampedArray,0),r.__getUint8ClampedArrayView=m.bind(null,Uint8ClampedArray,0),r.__getInt16Array=E.bind(null,Int16Array,1),r.__getInt16ArrayView=m.bind(null,Int16Array,1),r.__getUint16Array=E.bind(null,Uint16Array,1),r.__getUint16ArrayView=m.bind(null,Uint16Array,1),r.__getInt32Array=E.bind(null,Int32Array,2),r.__getInt32ArrayView=m.bind(null,Int32Array,2),r.__getUint32Array=E.bind(null,Uint32Array,2),r.__getUint32ArrayView=m.bind(null,Uint32Array,2),pse&&(r.__getInt64Array=E.bind(null,BigInt64Array,3),r.__getInt64ArrayView=m.bind(null,BigInt64Array,3),r.__getUint64Array=E.bind(null,BigUint64Array,3),r.__getUint64ArrayView=m.bind(null,BigUint64Array,3)),r.__getFloat32Array=E.bind(null,Float32Array,2),r.__getFloat32ArrayView=m.bind(null,Float32Array,2),r.__getFloat64Array=E.bind(null,Float64Array,3),r.__getFloat64ArrayView=m.bind(null,Float64Array,3);function b(v,S){const _=new Uint32Array(n.buffer);var A=_[v+Wg>>>2];if(A<=_[a>>>2])do if(A==S)return!0;while(A=u(A));return!1}return r.__instanceof=b,r.memory=r.memory||n,r.table=r.table||s,Rx(t,r)}function Sx(r){return typeof Response<"u"&&r instanceof Response}async function Ax(r,e){return Sx(r=await r)?$x(r,e):o4(i4(e||(e={})),await WebAssembly.instantiate(r instanceof WebAssembly.Module?r:await WebAssembly.compile(r),e))}Ch.instantiate=Ax;function gse(r,e){return o4(i4(e||(e={})),new WebAssembly.Instance(r instanceof WebAssembly.Module?r:new WebAssembly.Module(r),e))}Ch.instantiateSync=gse;async function $x(r,e){return WebAssembly.instantiateStreaming?o4(i4(e||(e={})),(await WebAssembly.instantiateStreaming(r,e)).instance):Ax(Sx(r=await r)?r.arrayBuffer():r,e)}Ch.instantiateStreaming=$x;function Rx(r,e){var t=e?Object.create(e):{},n=r.__argumentsLength?function(s){r.__argumentsLength.value=s}:r.__setArgumentsLength||r.__setargc||function(){};for(let s in r){if(!Object.prototype.hasOwnProperty.call(r,s))continue;const i=r[s];let o=s.split("."),a=t;for(;o.length>1;){let l=o.shift();Object.prototype.hasOwnProperty.call(a,l)||(a[l]={}),a=a[l]}let c=o[0],u=c.indexOf("#");if(u>=0){let l=c.substring(0,u),d=a[l];if(typeof d>"u"||!d.prototype){let f=function(...g){return f.wrap(f.prototype.constructor(0,...g))};f.prototype={valueOf:function(){return this[su]}},f.wrap=function(g){return Object.create(f.prototype,{[su]:{value:g,writable:!1}})},d&&Object.getOwnPropertyNames(d).forEach(g=>Object.defineProperty(f,g,Object.getOwnPropertyDescriptor(d,g))),a[l]=f}if(c=c.substring(u+1),a=a[l].prototype,/^(get|set):/.test(c)){if(!Object.prototype.hasOwnProperty.call(a,c=c.substring(4))){let f=r[s.replace("set:","get:")],g=r[s.replace("get:","set:")];Object.defineProperty(a,c,{get:function(){return f(this[su])},set:function(h){g(this[su],h)},enumerable:!0})}}else c==="constructor"?(a[c]=(...f)=>(n(f.length),i(...f))).original=i:(a[c]=function(...f){return n(f.length),i(this[su],...f)}).original=i}else/^(get|set):/.test(c)?Object.prototype.hasOwnProperty.call(a,c=c.substring(4))||Object.defineProperty(a,c,{get:r[s.replace("set:","get:")],set:r[s.replace("get:","set:")],enumerable:!0}):typeof i=="function"&&i!==n?(a[c]=(...l)=>(n(l.length),i(...l))).original=i:a[c]=i}return t}Ch.demangle=Rx;const{instantiate:yse}=Ch;a4.supported=typeof WebAssembly<"u";function a4(r={}){if(!a4.supported)return null;var e=new Uint8Array([0,97,115,109,1,0,0,0,1,78,14,96,2,127,126,0,96,1,127,1,126,96,2,127,127,0,96,1,127,1,127,96,1,127,0,96,2,127,127,1,127,96,3,127,127,127,1,127,96,0,0,96,3,127,127,127,0,96,0,1,127,96,4,127,127,127,127,0,96,5,127,127,127,127,127,1,127,96,1,126,1,127,96,2,126,126,1,126,2,13,1,3,101,110,118,5,97,98,111,114,116,0,10,3,54,53,2,2,8,9,3,5,2,8,6,5,3,4,2,6,9,12,13,2,5,11,3,2,3,2,3,2,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,6,7,7,4,4,5,3,1,0,1,6,47,9,127,1,65,0,11,127,1,65,0,11,127,0,65,3,11,127,0,65,4,11,127,1,65,0,11,127,1,65,0,11,127,1,65,0,11,127,0,65,240,2,11,127,0,65,6,11,7,240,5,41,6,109,101,109,111,114,121,2,0,7,95,95,97,108,108,111,99,0,10,8,95,95,114,101,116,97,105,110,0,11,9,95,95,114,101,108,101,97,115,101,0,12,9,95,95,99,111,108,108,101,99,116,0,51,11,95,95,114,116,116,105,95,98,97,115,101,3,7,13,73,110,116,51,50,65,114,114,97,121,95,73,68,3,2,13,85,105,110,116,56,65,114,114,97,121,95,73,68,3,3,6,100,101,103,114,101,101,0,16,3,109,111,100,0,17,5,82,97,98,105,110,3,8,16,82,97,98,105,110,35,103,101,116,58,119,105,110,100,111,119,0,21,16,82,97,98,105,110,35,115,101,116,58,119,105,110,100,111,119,0,22,21,82,97,98,105,110,35,103,101,116,58,119,105,110,100,111,119,95,115,105,122,101,0,23,21,82,97,98,105,110,35,115,101,116,58,119,105,110,100,111,119,95,115,105,122,101,0,24,14,82,97,98,105,110,35,103,101,116,58,119,112,111,115,0,25,14,82,97,98,105,110,35,115,101,116,58,119,112,111,115,0,26,15,82,97,98,105,110,35,103,101,116,58,99,111,117,110,116,0,27,15,82,97,98,105,110,35,115,101,116,58,99,111,117,110,116,0,28,13,82,97,98,105,110,35,103,101,116,58,112,111,115,0,29,13,82,97,98,105,110,35,115,101,116,58,112,111,115,0,30,15,82,97,98,105,110,35,103,101,116,58,115,116,97,114,116,0,31,15,82,97,98,105,110,35,115,101,116,58,115,116,97,114,116,0,32,16,82,97,98,105,110,35,103,101,116,58,100,105,103,101,115,116,0,33,16,82,97,98,105,110,35,115,101,116,58,100,105,103,101,115,116,0,34,21,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,115,116,97,114,116,0,35,21,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,115,116,97,114,116,0,36,22,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,108,101,110,103,116,104,0,37,22,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,108,101,110,103,116,104,0,38,31,82,97,98,105,110,35,103,101,116,58,99,104,117,110,107,95,99,117,116,95,102,105,110,103,101,114,112,114,105,110,116,0,39,31,82,97,98,105,110,35,115,101,116,58,99,104,117,110,107,95,99,117,116,95,102,105,110,103,101,114,112,114,105,110,116,0,40,20,82,97,98,105,110,35,103,101,116,58,112,111,108,121,110,111,109,105,97,108,0,41,20,82,97,98,105,110,35,115,101,116,58,112,111,108,121,110,111,109,105,97,108,0,42,17,82,97,98,105,110,35,103,101,116,58,109,105,110,115,105,122,101,0,43,17,82,97,98,105,110,35,115,101,116,58,109,105,110,115,105,122,101,0,44,17,82,97,98,105,110,35,103,101,116,58,109,97,120,115,105,122,101,0,45,17,82,97,98,105,110,35,115,101,116,58,109,97,120,115,105,122,101,0,46,14,82,97,98,105,110,35,103,101,116,58,109,97,115,107,0,47,14,82,97,98,105,110,35,115,101,116,58,109,97,115,107,0,48,17,82,97,98,105,110,35,99,111,110,115,116,114,117,99,116,111,114,0,20,17,82,97,98,105,110,35,102,105,110,103,101,114,112,114,105,110,116,0,49,8,1,50,10,165,31,53,199,1,1,4,127,32,1,40,2,0,65,124,113,34,2,65,128,2,73,4,127,32,2,65,4,118,33,4,65,0,5,32,2,65,31,32,2,103,107,34,3,65,4,107,118,65,16,115,33,4,32,3,65,7,107,11,33,3,32,1,40,2,20,33,2,32,1,40,2,16,34,5,4,64,32,5,32,2,54,2,20,11,32,2,4,64,32,2,32,5,54,2,16,11,32,1,32,0,32,4,32,3,65,4,116,106,65,2,116,106,40,2,96,70,4,64,32,0,32,4,32,3,65,4,116,106,65,2,116,106,32,2,54,2,96,32,2,69,4,64,32,0,32,3,65,2,116,106,32,0,32,3,65,2,116,106,40,2,4,65,1,32,4,116,65,127,115,113,34,1,54,2,4,32,1,69,4,64,32,0,32,0,40,2,0,65,1,32,3,116,65,127,115,113,54,2,0,11,11,11,11,226,2,1,6,127,32,1,40,2,0,33,3,32,1,65,16,106,32,1,40,2,0,65,124,113,106,34,4,40,2,0,34,5,65,1,113,4,64,32,3,65,124,113,65,16,106,32,5,65,124,113,106,34,2,65,240,255,255,255,3,73,4,64,32,0,32,4,16,1,32,1,32,2,32,3,65,3,113,114,34,3,54,2,0,32,1,65,16,106,32,1,40,2,0,65,124,113,106,34,4,40,2,0,33,5,11,11,32,3,65,2,113,4,64,32,1,65,4,107,40,2,0,34,2,40,2,0,34,6,65,124,113,65,16,106,32,3,65,124,113,106,34,7,65,240,255,255,255,3,73,4,64,32,0,32,2,16,1,32,2,32,7,32,6,65,3,113,114,34,3,54,2,0,32,2,33,1,11,11,32,4,32,5,65,2,114,54,2,0,32,4,65,4,107,32,1,54,2,0,32,0,32,3,65,124,113,34,2,65,128,2,73,4,127,32,2,65,4,118,33,4,65,0,5,32,2,65,31,32,2,103,107,34,2,65,4,107,118,65,16,115,33,4,32,2,65,7,107,11,34,3,65,4,116,32,4,106,65,2,116,106,40,2,96,33,2,32,1,65,0,54,2,16,32,1,32,2,54,2,20,32,2,4,64,32,2,32,1,54,2,16,11,32,0,32,4,32,3,65,4,116,106,65,2,116,106,32,1,54,2,96,32,0,32,0,40,2,0,65,1,32,3,116,114,54,2,0,32,0,32,3,65,2,116,106,32,0,32,3,65,2,116,106,40,2,4,65,1,32,4,116,114,54,2,4,11,119,1,1,127,32,2,2,127,32,0,40,2,160,12,34,2,4,64,32,2,32,1,65,16,107,70,4,64,32,2,40,2,0,33,3,32,1,65,16,107,33,1,11,11,32,1,11,107,34,2,65,48,73,4,64,15,11,32,1,32,3,65,2,113,32,2,65,32,107,65,1,114,114,54,2,0,32,1,65,0,54,2,16,32,1,65,0,54,2,20,32,1,32,2,106,65,16,107,34,2,65,2,54,2,0,32,0,32,2,54,2,160,12,32,0,32,1,16,2,11,155,1,1,3,127,35,0,34,0,69,4,64,65,1,63,0,34,0,74,4,127,65,1,32,0,107,64,0,65,0,72,5,65,0,11,4,64,0,11,65,176,3,34,0,65,0,54,2,0,65,208,15,65,0,54,2,0,3,64,32,1,65,23,73,4,64,32,1,65,2,116,65,176,3,106,65,0,54,2,4,65,0,33,2,3,64,32,2,65,16,73,4,64,32,1,65,4,116,32,2,106,65,2,116,65,176,3,106,65,0,54,2,96,32,2,65,1,106,33,2,12,1,11,11,32,1,65,1,106,33,1,12,1,11,11,65,176,3,65,224,15,63,0,65,16,116,16,3,65,176,3,36,0,11,32,0,11,45,0,32,0,65,240,255,255,255,3,79,4,64,65,32,65,224,0,65,201,3,65,29,16,0,0,11,32,0,65,15,106,65,112,113,34,0,65,16,32,0,65,16,75,27,11,169,1,1,1,127,32,0,32,1,65,128,2,73,4,127,32,1,65,4,118,33,1,65,0,5,32,1,65,248,255,255,255,1,73,4,64,32,1,65,1,65,27,32,1,103,107,116,106,65,1,107,33,1,11,32,1,65,31,32,1,103,107,34,2,65,4,107,118,65,16,115,33,1,32,2,65,7,107,11,34,2,65,2,116,106,40,2,4,65,127,32,1,116,113,34,1,4,127,32,0,32,1,104,32,2,65,4,116,106,65,2,116,106,40,2,96,5,32,0,40,2,0,65,127,32,2,65,1,106,116,113,34,1,4,127,32,0,32,0,32,1,104,34,0,65,2,116,106,40,2,4,104,32,0,65,4,116,106,65,2,116,106,40,2,96,5,65,0,11,11,11,111,1,1,127,63,0,34,2,32,1,65,248,255,255,255,1,73,4,127,32,1,65,1,65,27,32,1,103,107,116,65,1,107,106,5,32,1,11,65,16,32,0,40,2,160,12,32,2,65,16,116,65,16,107,71,116,106,65,255,255,3,106,65,128,128,124,113,65,16,118,34,1,32,2,32,1,74,27,64,0,65,0,72,4,64,32,1,64,0,65,0,72,4,64,0,11,11,32,0,32,2,65,16,116,63,0,65,16,116,16,3,11,113,1,2,127,32,1,40,2,0,34,3,65,124,113,32,2,107,34,4,65,32,79,4,64,32,1,32,2,32,3,65,2,113,114,54,2,0,32,2,32,1,65,16,106,106,34,1,32,4,65,16,107,65,1,114,54,2,0,32,0,32,1,16,2,5,32,1,32,3,65,126,113,54,2,0,32,1,65,16,106,32,1,40,2,0,65,124,113,106,32,1,65,16,106,32,1,40,2,0,65,124,113,106,40,2,0,65,125,113,54,2,0,11,11,91,1,2,127,32,0,32,1,16,5,34,4,16,6,34,3,69,4,64,65,1,36,1,65,0,36,1,32,0,32,4,16,6,34,3,69,4,64,32,0,32,4,16,7,32,0,32,4,16,6,33,3,11,11,32,3,65,0,54,2,4,32,3,32,2,54,2,8,32,3,32,1,54,2,12,32,0,32,3,16,1,32,0,32,3,32,4,16,8,32,3,11,13,0,16,4,32,0,32,1,16,9,65,16,106,11,33,1,1,127,32,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,11,18,0,32,0,65,172,3,75,4,64,32,0,65,16,107,16,52,11,11,140,3,1,1,127,2,64,32,1,69,13,0,32,0,65,0,58,0,0,32,0,32,1,106,65,1,107,65,0,58,0,0,32,1,65,2,77,13,0,32,0,65,1,106,65,0,58,0,0,32,0,65,2,106,65,0,58,0,0,32,0,32,1,106,34,2,65,2,107,65,0,58,0,0,32,2,65,3,107,65,0,58,0,0,32,1,65,6,77,13,0,32,0,65,3,106,65,0,58,0,0,32,0,32,1,106,65,4,107,65,0,58,0,0,32,1,65,8,77,13,0,32,1,65,0,32,0,107,65,3,113,34,1,107,33,2,32,0,32,1,106,34,0,65,0,54,2,0,32,0,32,2,65,124,113,34,1,106,65,4,107,65,0,54,2,0,32,1,65,8,77,13,0,32,0,65,4,106,65,0,54,2,0,32,0,65,8,106,65,0,54,2,0,32,0,32,1,106,34,2,65,12,107,65,0,54,2,0,32,2,65,8,107,65,0,54,2,0,32,1,65,24,77,13,0,32,0,65,12,106,65,0,54,2,0,32,0,65,16,106,65,0,54,2,0,32,0,65,20,106,65,0,54,2,0,32,0,65,24,106,65,0,54,2,0,32,0,32,1,106,34,2,65,28,107,65,0,54,2,0,32,2,65,24,107,65,0,54,2,0,32,2,65,20,107,65,0,54,2,0,32,2,65,16,107,65,0,54,2,0,32,0,32,0,65,4,113,65,24,106,34,2,106,33,0,32,1,32,2,107,33,1,3,64,32,1,65,32,79,4,64,32,0,66,0,55,3,0,32,0,65,8,106,66,0,55,3,0,32,0,65,16,106,66,0,55,3,0,32,0,65,24,106,66,0,55,3,0,32,1,65,32,107,33,1,32,0,65,32,106,33,0,12,1,11,11,11,11,178,1,1,3,127,32,1,65,240,255,255,255,3,32,2,118,75,4,64,65,144,1,65,192,1,65,23,65,56,16,0,0,11,32,1,32,2,116,34,3,65,0,16,10,34,2,32,3,16,13,32,0,69,4,64,65,12,65,2,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,11,32,0,65,0,54,2,0,32,0,65,0,54,2,4,32,0,65,0,54,2,8,32,2,34,1,32,0,40,2,0,34,4,71,4,64,32,1,65,172,3,75,4,64,32,1,65,16,107,34,5,32,5,40,2,4,65,1,106,54,2,4,11,32,4,16,12,11,32,0,32,1,54,2,0,32,0,32,2,54,2,4,32,0,32,3,54,2,8,32,0,11,46,1,2,127,65,12,65,5,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,65,128,2,65,3,16,14,11,9,0,65,63,32,0,121,167,107,11,49,1,2,127,65,63,32,1,121,167,107,33,2,3,64,65,63,32,0,121,167,107,32,2,107,34,3,65,0,78,4,64,32,0,32,1,32,3,172,134,133,33,0,12,1,11,11,32,0,11,40,0,32,1,32,0,40,2,8,79,4,64,65,128,2,65,192,2,65,163,1,65,44,16,0,0,11,32,1,32,0,40,2,4,106,65,0,58,0,0,11,38,0,32,1,32,0,40,2,8,79,4,64,65,128,2,65,192,2,65,152,1,65,44,16,0,0,11,32,1,32,0,40,2,4,106,45,0,0,11,254,5,2,1,127,4,126,32,0,69,4,64,65,232,0,65,6,16,10,34,0,65,172,3,75,4,64,32,0,65,16,107,34,5,32,5,40,2,4,65,1,106,54,2,4,11,11,32,0,65,0,54,2,0,32,0,65,0,54,2,4,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,24,32,0,66,0,55,3,32,32,0,66,0,55,3,40,32,0,66,0,55,3,48,32,0,66,0,55,3,56,32,0,66,0,55,3,64,32,0,66,0,55,3,72,32,0,66,0,55,3,80,32,0,66,0,55,3,88,32,0,66,0,55,3,96,32,0,32,2,173,55,3,80,32,0,32,3,173,55,3,88,65,12,65,4,16,10,34,2,65,172,3,75,4,64,32,2,65,16,107,34,3,32,3,40,2,4,65,1,106,54,2,4,11,32,2,32,4,65,0,16,14,33,2,32,0,40,2,0,16,12,32,0,32,2,54,2,0,32,0,32,4,54,2,4,32,0,66,1,32,1,173,134,66,1,125,55,3,96,32,0,66,243,130,183,218,216,230,232,30,55,3,72,35,4,69,4,64,65,0,33,2,3,64,32,2,65,128,2,72,4,64,32,2,65,255,1,113,173,33,6,32,0,41,3,72,34,7,33,8,65,63,32,7,121,167,107,33,1,3,64,65,63,32,6,121,167,107,32,1,107,34,3,65,0,78,4,64,32,6,32,8,32,3,172,134,133,33,6,12,1,11,11,65,0,33,4,3,64,32,4,32,0,40,2,4,65,1,107,72,4,64,32,6,66,8,134,33,6,32,0,41,3,72,34,7,33,8,65,63,32,7,121,167,107,33,1,3,64,65,63,32,6,121,167,107,32,1,107,34,3,65,0,78,4,64,32,6,32,8,32,3,172,134,133,33,6,12,1,11,11,32,4,65,1,106,33,4,12,1,11,11,35,6,40,2,4,32,2,65,3,116,106,32,6,55,3,0,32,2,65,1,106,33,2,12,1,11,11,65,63,32,0,41,3,72,121,167,107,172,33,7,65,0,33,2,3,64,32,2,65,128,2,72,4,64,35,5,33,1,32,2,172,32,7,134,34,8,33,6,65,63,32,0,41,3,72,34,9,121,167,107,33,3,3,64,65,63,32,6,121,167,107,32,3,107,34,4,65,0,78,4,64,32,6,32,9,32,4,172,134,133,33,6,12,1,11,11,32,1,40,2,4,32,2,65,3,116,106,32,6,32,8,132,55,3,0,32,2,65,1,106,33,2,12,1,11,11,65,1,36,4,11,32,0,66,0,55,3,24,32,0,66,0,55,3,32,65,0,33,2,3,64,32,2,32,0,40,2,4,72,4,64,32,0,40,2,0,32,2,16,18,32,2,65,1,106,33,2,12,1,11,11,32,0,66,0,55,3,40,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,40,32,0,40,2,0,32,0,40,2,8,16,19,33,1,32,0,40,2,8,32,0,40,2,0,40,2,4,106,65,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,1,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,6,66,45,136,167,65,3,116,106,41,3,0,32,6,66,8,134,66,1,132,133,55,3,40,32,0,11,38,1,1,127,32,0,40,2,0,34,0,65,172,3,75,4,64,32,0,65,16,107,34,1,32,1,40,2,4,65,1,106,54,2,4,11,32,0,11,55,1,2,127,32,1,32,0,40,2,0,34,2,71,4,64,32,1,65,172,3,75,4,64,32,1,65,16,107,34,3,32,3,40,2,4,65,1,106,54,2,4,11,32,2,16,12,11,32,0,32,1,54,2,0,11,7,0,32,0,40,2,4,11,9,0,32,0,32,1,54,2,4,11,7,0,32,0,40,2,8,11,9,0,32,0,32,1,54,2,8,11,7,0,32,0,41,3,16,11,9,0,32,0,32,1,55,3,16,11,7,0,32,0,41,3,24,11,9,0,32,0,32,1,55,3,24,11,7,0,32,0,41,3,32,11,9,0,32,0,32,1,55,3,32,11,7,0,32,0,41,3,40,11,9,0,32,0,32,1,55,3,40,11,7,0,32,0,41,3,48,11,9,0,32,0,32,1,55,3,48,11,7,0,32,0,41,3,56,11,9,0,32,0,32,1,55,3,56,11,7,0,32,0,41,3,64,11,9,0,32,0,32,1,55,3,64,11,7,0,32,0,41,3,72,11,9,0,32,0,32,1,55,3,72,11,7,0,32,0,41,3,80,11,9,0,32,0,32,1,55,3,80,11,7,0,32,0,41,3,88,11,9,0,32,0,32,1,55,3,88,11,7,0,32,0,41,3,96,11,9,0,32,0,32,1,55,3,96,11,172,4,2,5,127,1,126,32,2,65,172,3,75,4,64,32,2,65,16,107,34,4,32,4,40,2,4,65,1,106,54,2,4,11,32,2,33,4,65,0,33,2,32,1,40,2,8,33,5,32,1,40,2,4,33,6,3,64,2,127,65,0,33,3,3,64,32,3,32,5,72,4,64,32,3,32,6,106,45,0,0,33,1,32,0,40,2,0,32,0,40,2,8,16,19,33,7,32,0,40,2,8,32,0,40,2,0,40,2,4,106,32,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,7,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,8,66,45,136,167,65,3,116,106,41,3,0,32,1,173,32,8,66,8,134,132,133,55,3,40,32,0,32,0,41,3,16,66,1,124,55,3,16,32,0,32,0,41,3,24,66,1,124,55,3,24,32,0,41,3,16,32,0,41,3,80,90,4,127,32,0,41,3,40,32,0,41,3,96,131,80,5,65,0,11,4,127,65,1,5,32,0,41,3,16,32,0,41,3,88,90,11,4,64,32,0,32,0,41,3,32,55,3,48,32,0,32,0,41,3,16,55,3,56,32,0,32,0,41,3,40,55,3,64,65,0,33,1,3,64,32,1,32,0,40,2,4,72,4,64,32,0,40,2,0,32,1,16,18,32,1,65,1,106,33,1,12,1,11,11,32,0,66,0,55,3,40,32,0,65,0,54,2,8,32,0,66,0,55,3,16,32,0,66,0,55,3,40,32,0,40,2,0,32,0,40,2,8,16,19,33,1,32,0,40,2,8,32,0,40,2,0,40,2,4,106,65,1,58,0,0,32,0,32,0,41,3,40,35,6,40,2,4,32,1,65,3,116,106,41,3,0,133,55,3,40,32,0,32,0,40,2,8,65,1,106,32,0,40,2,4,111,54,2,8,32,0,35,5,40,2,4,32,0,41,3,40,34,8,66,45,136,167,65,3,116,106,41,3,0,32,8,66,8,134,66,1,132,133,55,3,40,32,3,65,1,106,12,3,11,32,3,65,1,106,33,3,12,1,11,11,65,127,11,34,1,65,0,78,4,64,32,5,32,1,107,33,5,32,1,32,6,106,33,6,32,2,34,1,65,1,106,33,2,32,4,40,2,4,32,1,65,2,116,106,32,0,41,3,56,62,2,0,12,1,11,11,32,4,11,10,0,16,15,36,5,16,15,36,6,11,3,0,1,11,73,1,2,127,32,0,40,2,4,34,1,65,255,255,255,255,0,113,34,2,65,1,70,4,64,32,0,65,16,106,16,53,32,0,32,0,40,2,0,65,1,114,54,2,0,35,0,32,0,16,2,5,32,0,32,2,65,1,107,32,1,65,128,128,128,128,127,113,114,54,2,4,11,11,58,0,2,64,2,64,2,64,32,0,65,8,107,40,2,0,14,7,0,0,1,1,1,1,1,2,11,15,11,32,0,40,2,0,34,0,4,64,32,0,65,172,3,79,4,64,32,0,65,16,107,16,52,11,11,15,11,0,11,11,137,3,7,0,65,16,11,55,40,0,0,0,1,0,0,0,1,0,0,0,40,0,0,0,97,0,108,0,108,0,111,0,99,0,97,0,116,0,105,0,111,0,110,0,32,0,116,0,111,0,111,0,32,0,108,0,97,0,114,0,103,0,101,0,65,208,0,11,45,30,0,0,0,1,0,0,0,1,0,0,0,30,0,0,0,126,0,108,0,105,0,98,0,47,0,114,0,116,0,47,0,116,0,108,0,115,0,102,0,46,0,116,0,115,0,65,128,1,11,43,28,0,0,0,1,0,0,0,1,0,0,0,28,0,0,0,73,0,110,0,118,0,97,0,108,0,105,0,100,0,32,0,108,0,101,0,110,0,103,0,116,0,104,0,65,176,1,11,53,38,0,0,0,1,0,0,0,1,0,0,0,38,0,0,0,126,0,108,0,105,0,98,0,47,0,97,0,114,0,114,0,97,0,121,0,98,0,117,0,102,0,102,0,101,0,114,0,46,0,116,0,115,0,65,240,1,11,51,36,0,0,0,1,0,0,0,1,0,0,0,36,0,0,0,73,0,110,0,100,0,101,0,120,0,32,0,111,0,117,0,116,0,32,0,111,0,102,0,32,0,114,0,97,0,110,0,103,0,101,0,65,176,2,11,51,36,0,0,0,1,0,0,0,1,0,0,0,36,0,0,0,126,0,108,0,105,0,98,0,47,0,116,0,121,0,112,0,101,0,100,0,97,0,114,0,114,0,97,0,121,0,46,0,116,0,115,0,65,240,2,11,53,7,0,0,0,16,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,145,4,0,0,2,0,0,0,49,0,0,0,2,0,0,0,17,1,0,0,2,0,0,0,16,0,34,16,115,111,117,114,99,101,77,97,112,112,105,110,103,85,82,76,16,46,47,114,97,98,105,110,46,119,97,115,109,46,109,97,112]);return yse(new Response(new Blob([e],{type:"application/wasm"})),r)}var wse=a4;const Tx=ose,bse=wse,mse=async(r,e,t,n,s)=>{const i=await bse();return new Tx(i,r,e,t,n,s)};var Ese={Rabin:Tx,create:mse};async function*vse(r,e){let t,n,s;if(e.minChunkSize&&e.maxChunkSize&&e.avgChunkSize)s=e.avgChunkSize,t=e.minChunkSize,n=e.maxChunkSize;else if(e.avgChunkSize)s=e.avgChunkSize,t=s/3,n=s+s/2;else throw $(new Error("please specify an average chunk size"),"ERR_INVALID_AVG_CHUNK_SIZE");if(t<16)throw $(new Error("rabin min must be greater than 16"),"ERR_INVALID_MIN_CHUNK_SIZE");n<t&&(n=t),s<t&&(s=t);const i=Math.floor(Math.log2(s));for await(const o of _se(r,{min:t,max:n,bits:i,window:e.window,polynomial:e.polynomial}))yield o}async function*_se(r,e){const t=await Ese.create(e.bits,e.min,e.max,e.window),n=new ue;for await(const s of r){n.append(s);const i=t.fingerprint(s);for(let o=0;o<i.length;o++){const a=i[o],c=n.slice(0,a);n.consume(a),yield c}}n.length&&(yield n.subarray(0))}async function*Sse(r,e){let t=new ue,n=0,s=!1;const i=e.maxChunkSize;for await(const o of r)for(t.append(o),n+=o.length;n>=i;)if(yield t.slice(0,i),s=!0,i===t.length)t=new ue,n=0;else{const a=new ue;a.append(t.sublist(i)),t=a,n-=i}(!s||n)&&(yield t.subarray(0,n))}async function*Ase(r){for await(const e of r){if(e.length===void 0)throw $(new Error("Content was invalid"),"ERR_INVALID_CONTENT");if(typeof e=="string"||e instanceof String)yield L(e.toString());else if(Array.isArray(e))yield Uint8Array.from(e);else if(e instanceof Uint8Array)yield e;else throw $(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}}function $se(r){return Symbol.iterator in r}function Rse(r){return Symbol.asyncIterator in r}function Tse(r){try{if(r instanceof Uint8Array)return async function*(){yield r}();if($se(r))return async function*(){yield*r}();if(Rse(r))return r}catch{throw $(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}throw $(new Error("Content was invalid"),"ERR_INVALID_CONTENT")}async function*Ise(r,e,t){for await(const n of r)if(n.path&&(n.path.substring(0,2)==="./"&&(t.wrapWithDirectory=!0),n.path=n.path.split("/").filter(s=>s&&s!==".").join("/")),n.content){let s;typeof t.chunker=="function"?s=t.chunker:t.chunker==="rabin"?s=vse:s=Sse;let i;typeof t.chunkValidator=="function"?i=t.chunkValidator:i=Ase;const o={path:n.path,mtime:n.mtime,mode:n.mode,content:s(i(Tse(n.content),t),t)};yield()=>sse(o,e,t)}else if(n.path){const s={path:n.path,mtime:n.mtime,mode:n.mode};yield()=>Kne(s,e,t)}else throw new Error("Import candidate must have content or path or both")}let Ld=class{constructor(e,t){this.options=t||{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime,this.cid=void 0,this.size=void 0}async put(e,t){}get(e){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(e){}};class c4 extends Ld{constructor(e,t){super(e,t),this._children={}}async put(e,t){this.cid=void 0,this.size=void 0,this._children[e]=t}get(e){return Promise.resolve(this._children[e])}childCount(){return Object.keys(this._children).length}directChildrenCount(){return this.childCount()}onlyChild(){return this._children[Object.keys(this._children)[0]]}async*eachChildSeries(){const e=Object.keys(this._children);for(let t=0;t<e.length;t++){const n=e[t];yield{key:n,child:this._children[n]}}}async*flush(e){const t=Object.keys(this._children),n=[];for(let u=0;u<t.length;u++){let l=this._children[t[u]];if(l instanceof Ld)for await(const d of l.flush(e))l=d,yield l;l.size!=null&&l.cid&&n.push({Name:t[u],Tsize:l.size,Hash:l.cid})}const s=new Ze({type:"directory",mtime:this.mtime,mode:this.mode}),i={Data:s.marshal(),Links:n},o=Je(Mo(i)),a=await ol(o,e,this.options),c=o.length+i.Links.reduce((u,l)=>u+(l.Tsize==null?0:l.Tsize),0);this.cid=a,this.size=c,yield{cid:a,unixfs:s,path:this.path,size:c}}}const yf=7;var Cse=class{constructor(){this._bitArrays=[],this._data=[],this._length=0,this._changedLength=!1,this._changedData=!1}set(e,t){let n=this._internalPositionFor(e,!1);if(t===void 0)n!==-1&&(this._unsetInternalPos(n),this._unsetBit(e),this._changedLength=!0,this._changedData=!0);else{let s=!1;n===-1?(n=this._data.length,this._setBit(e),this._changedData=!0):s=!0,this._setInternalPos(n,e,t,s),this._changedLength=!0}}unset(e){this.set(e,void 0)}get(e){this._sortData();const t=this._internalPositionFor(e,!0);if(t!==-1)return this._data[t][1]}push(e){return this.set(this.length,e),this.length}get length(){if(this._sortData(),this._changedLength){const e=this._data[this._data.length-1];this._length=e?e[0]+1:0,this._changedLength=!1}return this._length}forEach(e){let t=0;for(;t<this.length;)e(this.get(t),t,this),t++}map(e){let t=0,n=new Array(this.length);for(;t<this.length;)n[t]=e(this.get(t),t,this),t++;return n}reduce(e,t){let n=0,s=t;for(;n<this.length;){const i=this.get(n);s=e(s,i,n),n++}return s}find(e){let t=0,n,s;for(;t<this.length&&!n;)s=this.get(t),n=e(s),t++;return n?s:void 0}_internalPositionFor(e,t){const n=this._bytePosFor(e,t);if(n>=this._bitArrays.length)return-1;const s=this._bitArrays[n],i=e-n*yf;if(!((s&1<<i)>0))return-1;const a=this._bitArrays.slice(0,n).reduce(xse,0),c=~(4294967295<<i+1),u=Ix(s&c);return a+u-1}_bytePosFor(e,t){const n=Math.floor(e/yf),s=n+1;for(;!t&&this._bitArrays.length<s;)this._bitArrays.push(0);return n}_setBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]|=1<<e-t*yf}_unsetBit(e){const t=this._bytePosFor(e,!1);this._bitArrays[t]&=~(1<<e-t*yf)}_setInternalPos(e,t,n,s){const i=this._data,o=[t,n];if(s)this._sortData(),i[e]=o;else{if(i.length)if(i[i.length-1][0]>=t)i.push(o);else if(i[0][0]<=t)i.unshift(o);else{const a=Math.round(i.length/2);this._data=i.slice(0,a).concat(o).concat(i.slice(a))}else this._data.push(o);this._changedData=!0,this._changedLength=!0}}_unsetInternalPos(e){this._data.splice(e,1)}_sortData(){this._changedData&&this._data.sort(Dse),this._changedData=!1}bitField(){const e=[];let t=8,n=0,s=0,i;const o=this._bitArrays.slice();for(;o.length||n;){n===0&&(i=o.shift(),n=7);const c=Math.min(n,t),u=~(255<<c),l=i&u;s|=l<<8-t,i=i>>>c,n-=c,t-=c,(!t||!n&&!o.length)&&(e.push(s),s=0,t=8)}for(var a=e.length-1;a>0&&e[a]===0;a--)e.pop();return e}compactArray(){return this._sortData(),this._data.map(Ose)}};function xse(r,e){return r+Ix(e)}function Ix(r){let e=r;return e=e-(e>>1&1431655765),e=(e&858993459)+(e>>2&858993459),(e+(e>>4)&252645135)*16843009>>24}function Dse(r,e){return r[0]-e[0]}function Ose(r){return r[1]}const Pse=Ge(Cse);class Fr{constructor(e,t,n=0){this._options=e,this._popCount=0,this._parent=t,this._posAtParent=n,this._children=new Pse,this.key=null}async put(e,t){const n=await this._findNewBucketAndPos(e);await n.bucket._putAt(n,e,t)}async get(e){const t=await this._findChild(e);if(t!=null)return t.value}async del(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);n!=null&&n.key===e&&t.bucket._delAt(t.pos)}leafCount(){return this._children.compactArray().reduce((t,n)=>n instanceof Fr?t+n.leafCount():t+1,0)}childrenCount(){return this._children.length}onlyChild(){return this._children.get(0)}*eachLeafSeries(){const e=this._children.compactArray();for(const t of e)t instanceof Fr?yield*t.eachLeafSeries():yield t}serialize(e,t){const n=[];return t(this._children.reduce((s,i,o)=>(i!=null&&(i instanceof Fr?s.push(i.serialize(e,t)):s.push(e(i,o))),s),n))}async asyncTransform(e,t){return await Cx(this,e,t)}toJSON(){return this.serialize(Nse,Lse)}prettyPrint(){return JSON.stringify(this.toJSON(),null,"  ")}tableSize(){return Math.pow(2,this._options.bits)}async _findChild(e){const t=await this._findPlace(e),n=t.bucket._at(t.pos);if(!(n instanceof Fr)&&n!=null&&n.key===e)return n}async _findPlace(e){const t=this._options.hash(typeof e=="string"?L(e):e),n=await t.take(this._options.bits),s=this._children.get(n);return s instanceof Fr?await s._findPlace(t):{bucket:this,pos:n,hash:t,existingChild:s}}async _findNewBucketAndPos(e){const t=await this._findPlace(e);if(t.existingChild!=null&&t.existingChild.key!==e){const n=new Fr(this._options,t.bucket,t.pos);t.bucket._putObjectAt(t.pos,n);const s=await n._findPlace(t.existingChild.hash);return s.bucket._putAt(s,t.existingChild.key,t.existingChild.value),await n._findNewBucketAndPos(t.hash)}return t}_putAt(e,t,n){this._putObjectAt(e.pos,{key:t,value:n,hash:e.hash})}_putObjectAt(e,t){this._children.get(e)==null&&this._popCount++,this._children.set(e,t)}_delAt(e){if(e===-1)throw new Error("Invalid position");this._children.get(e)!=null&&this._popCount--,this._children.unset(e),this._level()}_level(){if(this._parent!=null&&this._popCount<=1)if(this._popCount===1){const e=this._children.find(kse);if(e!=null&&!(e instanceof Fr)){const t=e.hash;t.untake(this._options.bits);const n={pos:this._posAtParent,hash:t,bucket:this._parent};this._parent._putAt(n,e.key,e.value)}}else this._parent._delAt(this._posAtParent)}_at(e){return this._children.get(e)}}function kse(r){return!!r}function Nse(r,e){return r.key}function Lse(r){return r}async function Cx(r,e,t){const n=[];for(const s of r._children.compactArray())if(s instanceof Fr)await Cx(s,e,t);else{const i=await e(s);n.push({bitField:r._children.bitField(),children:i})}return await t(n)}const Mse=[255,254,252,248,240,224,192,128],Use=[1,3,7,15,31,63,127,255];class Bse{constructor(e){this._value=e,this._currentBytePos=e.length-1,this._currentBitPos=7}availableBits(){return this._currentBitPos+1+this._currentBytePos*8}totalBits(){return this._value.length*8}take(e){let t=e,n=0;for(;t>0&&this._haveBits();){const s=this._value[this._currentBytePos],i=this._currentBitPos+1,o=Math.min(i,t),a=zse(s,i-o,o);n=(n<<o)+a,t-=o,this._currentBitPos-=o,this._currentBitPos<0&&(this._currentBitPos=7,this._currentBytePos--)}return n}untake(e){for(this._currentBitPos+=e;this._currentBitPos>7;)this._currentBitPos-=8,this._currentBytePos+=1}_haveBits(){return this._currentBytePos>=0}}function zse(r,e,t){const n=Fse(e,t);return(r&n)>>>e}function Fse(r,e){return Mse[r]&Use[Math.min(e+r-1,7)]}function Vse(r){function e(t){return t instanceof u9?t:new u9(t,r)}return e}class u9{constructor(e,t){if(!(e instanceof Uint8Array))throw new Error("can only hash Uint8Arrays");this._value=e,this._hashFn=t,this._depth=-1,this._availableBits=0,this._currentBufferIndex=0,this._buffers=[]}async take(e){let t=e;for(;this._availableBits<t;)await this._produceMoreBits();let n=0;for(;t>0;){const s=this._buffers[this._currentBufferIndex],i=Math.min(s.availableBits(),t),o=s.take(i);n=(n<<i)+o,t-=i,this._availableBits-=i,s.availableBits()===0&&this._currentBufferIndex++}return n}untake(e){let t=e;for(;t>0;){const n=this._buffers[this._currentBufferIndex],s=Math.min(n.totalBits()-n.availableBits(),t);n.untake(s),t-=s,this._availableBits+=s,this._currentBufferIndex>0&&n.totalBits()===n.availableBits()&&(this._depth--,this._currentBufferIndex--)}}async _produceMoreBits(){this._depth++;const e=this._depth>0?M([this._value,Uint8Array.from([this._depth])]):this._value,t=await this._hashFn(e),n=new Bse(t);this._buffers.push(n),this._availableBits+=n.availableBits()}}function A2(r){if(r==null||r.hashFn==null)throw new Error("please define an options.hashFn");const e={bits:r.bits??8,hash:Vse(r.hashFn)};return new Fr(e)}let jse=class extends Ld{constructor(e,t){super(e,t),this._bucket=A2({hashFn:t.hamtHashFn,bits:t.hamtBucketBits})}async put(e,t){await this._bucket.put(e,t)}get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}async*flush(e){for await(const t of xx(this._bucket,e,this,this.options))yield{...t,path:this.path}}};async function*xx(r,e,t,n){const s=r._children,i=[];let o=0;for(let g=0;g<s.length;g++){const h=s.get(g);if(!h)continue;const p=g.toString(16).toUpperCase().padStart(2,"0");if(h instanceof Fr){let w;for await(const y of await xx(h,e,null,n))w=y;if(!w)throw new Error("Could not flush sharded directory, no subshard found");i.push({Name:p,Tsize:w.size,Hash:w.cid}),o+=w.size}else if(typeof h.value.flush=="function"){const w=h.value;let y;for await(const m of w.flush(e))y=m,yield y;const E=p+h.key;i.push({Name:E,Tsize:y.size,Hash:y.cid}),o+=y.size}else{const w=h.value;if(!w.cid)continue;const y=p+h.key,E=w.size;i.push({Name:y,Tsize:E,Hash:w.cid}),o+=E}}const a=Uint8Array.from(s.bitField().reverse()),c=new Ze({type:"hamt-sharded-directory",data:a,fanout:r.tableSize(),hashType:n.hamtHashCode,mtime:t&&t.mtime,mode:t&&t.mode}),u={Data:c.marshal(),Links:i},l=Je(Mo(u)),d=await ol(l,e,n),f=l.length+o;yield{cid:d,unixfs:c,size:f}}async function Dx(r,e,t,n){let s=e;e instanceof c4&&e.directChildrenCount()>=t&&(s=await qse(e,n));const i=s.parent;if(i){if(s!==e){if(r&&(r.parent=s),!s.parentKey)throw new Error("No parent key found");await i.put(s.parentKey,s)}return Dx(s,i,t,n)}return s}async function qse(r,e){const t=new jse({root:r.root,dir:!0,parent:r.parent,parentKey:r.parentKey,path:r.path,dirty:r.dirty,flat:!1,mtime:r.mtime,mode:r.mode},e);for await(const{key:n,child:s}of r.eachChildSeries())await t.put(n,s);return t}const Kse=(r="")=>(r.trim().match(/([^\\/]|\\\/)+/g)||[]).filter(Boolean);async function Gse(r,e,t){const n=Kse(r.path||""),s=n.length-1;let i=e,o="";for(let a=0;a<n.length;a++){const c=n[a];o+=`${o?"/":""}${c}`;const u=a===s;if(i.dirty=!0,i.cid=void 0,i.size=void 0,u)await i.put(c,r),e=await Dx(null,i,t.shardSplitThreshold,t);else{let l=await i.get(c);(!l||!(l instanceof Ld))&&(l=new c4({root:!1,dir:!0,parent:i,parentKey:c,path:o,dirty:!0,flat:!0,mtime:l&&l.unixfs&&l.unixfs.mtime,mode:l&&l.unixfs&&l.unixfs.mode},t)),await i.put(c,l),i=l}}return e}async function*d9(r,e){if(!(r instanceof Ld)){r&&r.unixfs&&r.unixfs.isDirectory()&&(yield r);return}yield*r.flush(e)}async function*Hse(r,e,t){let n=new c4({root:!0,dir:!0,path:"",dirty:!0,flat:!0},t);for await(const s of r)s&&(n=await Gse(s,n,t),(!s.unixfs||!s.unixfs.isDirectory())&&(yield s));if(t.wrapWithDirectory)yield*d9(n,e);else for await(const s of n.eachChildSeries())s&&(yield*d9(s.child,e))}async function*l4(r,e,t={}){const n=Cne(t);let s;typeof t.dagBuilder=="function"?s=t.dagBuilder:s=Ise;let i;typeof t.treeBuilder=="function"?i=t.treeBuilder:i=Hse;let o;Symbol.asyncIterator in r||Symbol.iterator in r?o=r:o=[r];for await(const a of i(n4(s(o,e,n),n.fileImportConcurrency),e,n))yield{cid:a.cid,path:a.path,unixfs:a.unixfs,size:a.size}}async function*Ox(r,e){if(typeof r=="string"||r instanceof String||Bo(r)||kd(r)||r._readableState)throw $(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");if(Nd(r)&&(r=Ua(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const t=Th(r),{value:n,done:s}=await t.peek();if(s){yield*[];return}if(t.push(n),Number.isInteger(n))throw $(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT");if(n._readableState){yield*Xr(t,i=>Yg({content:i},e));return}if(Bo(n)){yield Yg({content:t},e);return}if(Eb(n)||n[Symbol.iterator]||n[Symbol.asyncIterator]||Nd(n)||kd(n)){yield*Xr(t,i=>Yg(i,e));return}}throw Eb(r)?$(new Error("Unexpected input: single item passed - if you are using ipfs.addAll, please use ipfs.add instead"),"ERR_UNEXPECTED_INPUT"):$(new Error("Unexpected input: "+typeof r),"ERR_UNEXPECTED_INPUT")}async function Yg(r,e){const{path:t,mode:n,mtime:s,content:i}=r,o={path:t||"",mode:jc(n),mtime:Cd(s)};return i?o.content=await e(i):t||(o.content=await e(r)),o}function Wse(r){return Ox(r,lx)}const Qse=r=>{if(r)if(r.startsWith("size-")){const e=r.split("-")[1],t=parseInt(e);if(isNaN(t))throw new Error("Chunker parameter size must be an integer");return{chunker:"fixed",maxChunkSize:t}}else{if(r.startsWith("rabin"))return{chunker:"rabin",...Yse(r)};throw new Error(`Unrecognized chunker option: ${r}`)}else return{chunker:"fixed"}},Yse=r=>{const e={},t=r.split("-");switch(t.length){case 1:e.avgChunkSize=262144;break;case 2:e.avgChunkSize=wf(t[1],"avg");break;case 4:e.minChunkSize=wf(t[1],"min"),e.avgChunkSize=wf(t[2],"avg"),e.maxChunkSize=wf(t[3],"max");break;default:throw new Error('Incorrect chunker format (expected "rabin" "rabin-[avg]" or "rabin-[min]-[avg]-[max]"')}return e},wf=(r,e)=>{const t=parseInt(r);if(isNaN(t))throw new Error(`Chunker parameter ${e} must be an integer`);return t},Xse=et.bind({ignoreUndefined:!0});function Jse({repo:r,preload:e,hashers:t,options:n}){const s=n&&n.sharding;async function*i(o,a={}){const c=Xse({shardSplitThreshold:s?1e3:1/0,strategy:"balanced"},a,{...Qse(a.chunker)});c.hashAlg&&c.hashAlg!=="sha2-256"&&c.cidVersion!==1&&(c.cidVersion=1),c.trickle&&(c.strategy="trickle"),c.strategy==="trickle"&&(c.leafType="raw",c.reduceSingleLeafToSelf=!1),c.cidVersion>0&&c.rawLeaves===void 0&&(c.rawLeaves=!0),c.hashAlg!==void 0&&c.rawLeaves===void 0&&(c.rawLeaves=!0),delete c.trickle;const u={};if(c.progress){const g=c.progress;c.progress=(h,p)=>{u[p]||(u[p]=0),u[p]+=h,g(u[p],p)}}let l;c.hashAlg!=null&&(l=await t.getHasher(c.hashAlg));const d=Ae(Wse(o),g=>l4(g,r.blocks,{...c,hasher:l,pin:!1}),Zse(c),eie(e,c),tie(r,c)),f=await r.gcLock.readLock();try{for await(const g of d){const h=g.path??g.cid.toString();delete u[h],yield{...g,path:h}}}finally{f()}}return F(i)}function Zse(r){async function*e(t){for await(const n of t){let s=n.cid;r.cidVersion===1&&(s=s.toV1());let i=n.path?n.path:s.toString();r.wrapWithDirectory&&!n.path&&(i=""),yield{path:i,cid:s,size:n.size,mode:n.unixfs&&n.unixfs.mode,mtime:n.unixfs&&n.unixfs.mtime}}}return e}function eie(r,e){async function*t(n){for await(const s of n)(!s.path||e.wrapWithDirectory?s.path==="":!s.path.includes("/"))&&!e.onlyHash&&e.preload!==!1&&r(s.cid),yield s}return t}function tie(r,e){async function*t(n){for await(const s of n){const i=!(s.path&&s.path.includes("/"));(e.pin==null?!0:e.pin)&&i&&!e.onlyHash&&await r.pins.pinRecursively(s.cid),yield s}}return t}var rie=Px,h9=128,nie=127,sie=~nie,iie=Math.pow(2,31);function Px(r,e,t){e=e||[],t=t||0;for(var n=t;r>=iie;)e[t++]=r&255|h9,r/=128;for(;r&sie;)e[t++]=r&255|h9,r>>>=7;return e[t]=r|0,Px.bytes=t-n+1,e}var oie=Cb,aie=128,f9=127;function Cb(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Cb.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&f9)<<s:(o&f9)*Math.pow(2,s),s+=7}while(o>=aie);return Cb.bytes=i-n,t}var cie=Math.pow(2,7),lie=Math.pow(2,14),uie=Math.pow(2,21),die=Math.pow(2,28),hie=Math.pow(2,35),fie=Math.pow(2,42),pie=Math.pow(2,49),gie=Math.pow(2,56),yie=Math.pow(2,63),wie=function(r){return r<cie?1:r<lie?2:r<uie?3:r<die?4:r<hie?5:r<fie?6:r<pie?7:r<gie?8:r<yie?9:10},bie={encode:rie,decode:oie,encodingLength:wie},o1=bie;const xb=(r,e=0)=>[o1.decode(r,e),o1.decode.bytes],a1=(r,e,t=0)=>(o1.encode(r,e,t),e),c1=r=>o1.encodingLength(r),mie=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},$2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},kx=(r,e)=>{const t=e.byteLength,n=c1(r),s=n+c1(t),i=new Uint8Array(s+t);return a1(r,i,0),a1(t,i,n),i.set(e,s),new u4(r,t,e,i)},Nx=r=>{const e=$2(r),[t,n]=xb(e),[s,i]=xb(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new u4(t,s,o,e)},Eie=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&mie(r.bytes,t.bytes)}};let u4=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function vie(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var _ie=vie,Sie=_ie;let Aie=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},$ie=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Lx(this,e)}},Rie=class{constructor(e){this.decoders=e}or(e){return Lx(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Lx=(r,e)=>new Rie({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let Tie=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Aie(e,t,n),this.decoder=new $ie(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const Mx=({name:r,prefix:e,encode:t,decode:n})=>new Tie(r,e,t,n),Ux=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Sie(t,e);return Mx({prefix:r,name:e,encode:n,decode:i=>$2(s(i))})},Iie=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Cie=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Ui=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>Mx({prefix:e,name:r,encode(s){return Cie(s,n,t)},decode(s){return Iie(s,n,t,r)}}),io=Ux({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Ux({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const cp=Ui({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Ui({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Ui({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Ui({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Ui({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Ui({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Ui({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Ui({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Ui({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const p9=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Die(t,Db(r),e||io.encoder);default:return Oie(t,Db(r),e||cp.encoder)}},g9=new WeakMap,Db=r=>{const e=g9.get(r);if(e==null){const t=new Map;return g9.set(r,t),t}return e};let lp=class mr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ou)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Pie)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return mr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=kx(e,t);return mr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return mr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Eie(e.multihash,n.multihash)}toString(e){return p9(this,e)}toJSON(){return{"/":p9(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof mr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new mr(n,s,i,o||y9(n,s,i.bytes))}else if(t[kie]===!0){const{version:n,multihash:s,code:i}=t,o=Nx(s);return mr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ou)throw new Error(`Version 0 CID must use dag-pb (code: ${ou}) block encoding`);return new mr(e,t,n,n.bytes)}case 1:{const s=y9(e,t,n.bytes);return new mr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return mr.create(0,ou,e)}static createV1(e,t){return mr.create(1,e,t)}static decode(e){const[t,n]=mr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=mr.inspectBytes(e),n=t.size-t.multihashSize,s=$2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new u4(t.multihashCode,t.digestSize,i,s);return[t.version===0?mr.createV0(o):mr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=xb(e.subarray(t));return t+=f,d};let s=n(),i=ou;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=xie(e,t),i=mr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Db(i).set(n,e),i}};const xie=(r,e)=>{switch(r[0]){case"Q":{const t=e||io;return[io.prefix,t.decode(`${io.prefix}${r}`)]}case io.prefix:{const t=e||io;return[io.prefix,t.decode(r)]}case cp.prefix:{const t=e||cp;return[cp.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Die=(r,e,t)=>{const{prefix:n}=t;if(n!==io.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Oie=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},ou=112,Pie=18,y9=(r,e,t)=>{const n=c1(r),s=n+c1(e),i=new Uint8Array(s+t.byteLength);return a1(r,i,0),a1(e,i,n),i.set(t,s),i},kie=Symbol.for("@ipld/js-cid/CID"),Bx=85,zx=0,Nie="identity",Fx=$2,Lie=r=>kx(zx,Fx(r)),Mie={code:zx,name:Nie,encode:Fx,digest:Lie},Uie=async function(r){return(await S2.encode(r)).slice(0,8).reverse()},Bie=(r,e,t)=>Promise.all(r.map(n=>{if(n.Name==null)throw new Error("Unexpected Link without a Name");if(n.Name.length===2){const s=parseInt(n.Name,16);return e._putObjectAt(s,new Fr({hash:t._options.hash,bits:t._options.bits},e,s))}return t.put(n.Name.substring(2),!0)})),w9=r=>r.toString(16).toUpperCase().padStart(2,"0").substring(0,2),zie=r=>{let e=r.bucket;const t=[];for(;e._parent;)t.push(e),e=e._parent;return t.push(e),t.reverse()},Vx=async(r,e,t,n,s)=>{if(!n){const l=A2({hashFn:Uie});n={rootBucket:l,hamtDepth:1,lastBucket:l}}await Bie(r.Links,n.lastBucket,n.rootBucket);const i=await n.rootBucket._findNewBucketAndPos(e);let o=w9(i.pos);const a=zie(i);a.length>n.hamtDepth&&(n.lastBucket=a[n.hamtDepth],o=w9(n.lastBucket._posAtParent));const c=r.Links.find(l=>{if(l.Name==null)return!1;const d=l.Name.substring(0,2),f=l.Name.substring(2);return!(d!==o||f&&f!==e)});if(!c)return null;if(c.Name!=null&&c.Name.substring(2)===e)return c.Hash;n.hamtDepth++;const u=await t.get(c.Hash,s);return r=Lt(u),Vx(r,e,t,n,s)};function l1(r,e,t,n){const s=r.length,i=e+s;return t>=i||n<e?new Uint8Array(0):(n>=e&&n<i&&(r=r.subarray(0,n-e)),t>=e&&t<i&&(r=r.subarray(t-e)),r)}const d4=(r,e,t)=>{if(e||(e=0),e<0)throw $(new Error("Offset must be greater than or equal to 0"),"ERR_INVALID_PARAMS");if(e>r)throw $(new Error("Offset must be less than the file size"),"ERR_INVALID_PARAMS");if(!t&&t!==0&&(t=r-e),t<0)throw $(new Error("Length must be greater than or equal to 0"),"ERR_INVALID_PARAMS");return e+t>r&&(t=r-e),{offset:e,length:t}};async function jx(r,e,t,n,s,i,o,a){if(e instanceof Uint8Array){t.push(l1(e,n,s,i));return}if(e.Data==null)throw $(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");let c;try{c=Ze.unmarshal(e.Data)}catch(l){throw $(l,"ERR_NOT_UNIXFS")}if(c.data!=null){const l=c.data,d=l1(l,n,s,i);t.push(d),n+=d.byteLength}const u=[];for(let l=0;l<e.Links.length;l++){const d=e.Links[l],f=n,g=f+c.blockSizes[l];if((s>=f&&s<g||i>=f&&i<=g||s<f&&i>g)&&u.push({link:d,blockStart:n}),n=g,n>i)break}await Ae(u,l=>Xr(l,d=>async()=>{const f=await r.get(d.link.Hash,{signal:a.signal});return{...d,block:f}}),l=>_2(l,{ordered:!0}),async l=>{for await(const{link:d,block:f,blockStart:g}of l){let h;switch(d.Hash.code){case ht:h=Lt(f);break;case Bx:h=f;break;default:t.end($(new Error(`Unsupported codec: ${d.Hash.code}`),"ERR_NOT_UNIXFS"));return}o.add(async()=>{await jx(r,h,t,g,s,i,o,a)})}})}const b9=(r,e,t,n,s,i,o)=>{async function*a(c={}){const u=t.fileSize();if(u===void 0)throw new Error("File was a directory");const{offset:l,length:d}=d4(u,c.offset,c.length);if(d===0)return;const f=new zt({concurrency:1}),g=Mt();f.add(async()=>{await jx(o,e,g,0,l,l+d,f,c)}),f.on("error",p=>{g.end(p)});let h=0;for await(const p of g)p!=null&&(h+=p.byteLength,h===d&&g.end(),yield p)}return a},Fie=(r,e,t,n,s,i,o)=>{async function*a(c={}){const u=c.offset||0,l=c.length||e.Links.length,d=e.Links.slice(u,l);for(const f of d){const g=await s(f.Hash,f.Name||"",`${n}/${f.Name||""}`,[],i+1,o,c);g.entry&&(yield g.entry)}}return a},Vie=(r,e,t,n,s,i,o)=>{function a(c={}){return qx(e,n,s,i,o,c)}return a};async function*qx(r,e,t,n,s,i){const o=r.Links;for(const a of o){const c=a.Name!=null?a.Name.substring(2):null;if(c)yield(await t(a.Hash,c,`${e}/${c}`,[],n+1,s,i)).entry;else{const u=await s.get(a.Hash);r=Lt(u);for await(const l of qx(r,e,t,n,s,i))yield l}}}const jie=(r,e)=>{const t=r.Links.find(n=>n.Name===e);return t&&t.Hash},qie={raw:b9,file:b9,directory:Fie,"hamt-sharded-directory":Vie,metadata:(r,e,t,n,s,i,o)=>()=>[],symlink:(r,e,t,n,s,i,o)=>()=>[]},Kie=async(r,e,t,n,s,i,o,a)=>{const c=await o.get(r,a),u=Lt(c);let l,d;if(e||(e=r.toString()),u.Data==null)throw $(new Error("no data in PBNode"),"ERR_NOT_UNIXFS");try{l=Ze.unmarshal(u.Data)}catch(f){throw $(f,"ERR_NOT_UNIXFS")}if(t||(t=e),n.length){let f;if(l&&l.type==="hamt-sharded-directory"?f=await Vx(u,n[0],o):f=jie(u,n[0]),!f)throw $(new Error("file does not exist"),"ERR_NOT_FOUND");const g=n.shift(),h=`${t}/${g}`;d={cid:f,toResolve:n,name:g||"",path:h}}return{entry:{type:l.isDirectory()?"directory":"file",name:e,path:t,cid:r,content:qie[l.type](r,u,l,t,s,i,o),unixfs:l,depth:i,node:u,size:l.fileSize()},next:d}},Gie=r=>{async function*e(t={}){const{offset:n,length:s}=d4(r.length,t.offset,t.length);yield l1(r,0,n,n+s)}return e},Hie=async(r,e,t,n,s,i,o,a)=>{if(n.length)throw $(new Error(`No link named ${t} found in raw node ${r}`),"ERR_NOT_FOUND");const c=await o.get(r,a);return{entry:{type:"raw",name:e,path:t,cid:r,content:Gie(c),depth:i,size:c.length,node:c}}},Wie=async(r,e,t,n,s,i,o,a)=>{const c=await o.get(r),u=Z6(c);let l=u,d=t;for(;n.length;){const f=n[0];if(f in l){n.shift(),d=`${d}/${f}`;const g=lp.asCID(l[f]);if(g)return{entry:{type:"object",name:e,path:t,cid:r,node:c,depth:i,size:c.length,content:async function*(){yield u}},next:{cid:g,name:f,path:d,toResolve:n}};l=l[f]}else throw $(new Error(`No property named ${f} found in cbor node ${r}`),"ERR_NO_PROP")}return{entry:{type:"object",name:e,path:t,cid:r,node:c,depth:i,size:c.length,content:async function*(){yield u}}}},Qie=r=>{async function*e(t={}){const{offset:n,length:s}=d4(r.length,t.offset,t.length);yield l1(r,0,n,n+s)}return e},Yie=async(r,e,t,n,s,i,o,a)=>{if(n.length)throw $(new Error(`No link named ${t} found in raw node ${r}`),"ERR_NOT_FOUND");const c=await Nx(r.multihash.bytes);return{entry:{type:"identity",name:e,path:t,cid:r,content:Qie(c.digest),depth:i,size:c.digest.length,node:c.digest}}},Xie={[ht]:Kie,[Bx]:Hie,[ST]:Wie,[Mie.code]:Yie};function Kx(r,e,t,n,s,i,o){const a=Xie[r.code];if(!a)throw $(new Error(`No resolver for code ${r.code}`),"ERR_NO_RESOLVER");return a(r,e,t,n,Kx,s,i,o)}const Jie=(r="")=>(r.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean),Zie=r=>{if(r instanceof Uint8Array)return{cid:lp.decode(r),toResolve:[]};const e=lp.asCID(r);if(e)return{cid:e,toResolve:[]};if(typeof r=="string"){r.indexOf("/ipfs/")===0&&(r=r.substring(6));const t=Jie(r);return{cid:lp.parse(t[0]),toResolve:t.slice(1)}}throw $(new Error(`Unknown path type ${r}`),"ERR_BAD_PATH")};async function*Gx(r,e,t={}){let{cid:n,toResolve:s}=Zie(r),i=n.toString(),o=i;const a=s.length;for(;;){const c=await Kx(n,i,o,s,a,e,t);if(!c.entry&&!c.next)throw $(new Error(`Could not resolve ${r}`),"ERR_NOT_FOUND");if(c.entry&&(yield c.entry),!c.next)return;s=c.next.toResolve,n=c.next.cid,i=c.next.name,o=c.next.path}}async function Bi(r,e,t={}){const n=await En(Gx(r,e,t));if(!n)throw $(new Error(`Could not resolve ${r}`),"ERR_NOT_FOUND");return n}async function*Hx(r,e,t={}){const n=await Bi(r,e,t);if(!n)return;if(yield n,n.type==="directory")for await(const i of s(n,t))yield i;async function*s(i,o){for await(const a of i.content(o))yield a,!(a instanceof Uint8Array)&&a.type==="directory"&&(yield*s(a,o))}}function eoe({repo:r,preload:e}){async function*t(n,s={}){if(n=km(n),s.preload!==!1){const o=n.split("/");e(ne.parse(o[0]))}const i=await Bi(n,r.blocks,s);if(i.type==="directory")throw new Error("this dag node is a directory");if(!i.content)throw new Error("this dag node has no content");yield*i.content(s)}return F(t)}L("ustar\0","binary");L("ustar ","binary");L(" \0","binary");function toe(r){const e=async function*(){let t=yield,n=new ue;for await(const s of r){if(t==null){n.append(s),t=yield n,n=new ue;continue}for(n.append(s);n.length>=t;){const i=n.sublist(0,t);if(n.consume(t),t=yield i,t==null){n.length>0&&(t=yield n,n=new ue);break}}}if(t!=null)throw Object.assign(new Error(`stream ended before ${t} bytes became available`),{code:"ERR_UNDER_READ",buffer:n})}();return e.next(),e}var roe={RTLD_LAZY:1,RTLD_NOW:2,RTLD_GLOBAL:256,RTLD_LOCAL:0,RTLD_DEEPBIND:8,E2BIG:7,EACCES:13,EADDRINUSE:98,EADDRNOTAVAIL:99,EAFNOSUPPORT:97,EAGAIN:11,EALREADY:114,EBADF:9,EBADMSG:74,EBUSY:16,ECANCELED:125,ECHILD:10,ECONNABORTED:103,ECONNREFUSED:111,ECONNRESET:104,EDEADLK:35,EDESTADDRREQ:89,EDOM:33,EDQUOT:122,EEXIST:17,EFAULT:14,EFBIG:27,EHOSTUNREACH:113,EIDRM:43,EILSEQ:84,EINPROGRESS:115,EINTR:4,EINVAL:22,EIO:5,EISCONN:106,EISDIR:21,ELOOP:40,EMFILE:24,EMLINK:31,EMSGSIZE:90,EMULTIHOP:72,ENAMETOOLONG:36,ENETDOWN:100,ENETRESET:102,ENETUNREACH:101,ENFILE:23,ENOBUFS:105,ENODATA:61,ENODEV:19,ENOENT:2,ENOEXEC:8,ENOLCK:37,ENOLINK:67,ENOMEM:12,ENOMSG:42,ENOPROTOOPT:92,ENOSPC:28,ENOSR:63,ENOSTR:60,ENOSYS:38,ENOTCONN:107,ENOTDIR:20,ENOTEMPTY:39,ENOTSOCK:88,ENOTSUP:95,ENOTTY:25,ENXIO:6,EOPNOTSUPP:95,EOVERFLOW:75,EPERM:1,EPIPE:32,EPROTO:71,EPROTONOSUPPORT:93,EPROTOTYPE:91,ERANGE:34,EROFS:30,ESPIPE:29,ESRCH:3,ESTALE:116,ETIME:62,ETIMEDOUT:110,ETXTBSY:26,EWOULDBLOCK:11,EXDEV:18,PRIORITY_LOW:19,PRIORITY_BELOW_NORMAL:10,PRIORITY_NORMAL:0,PRIORITY_ABOVE_NORMAL:-7,PRIORITY_HIGH:-14,PRIORITY_HIGHEST:-20,SIGHUP:1,SIGINT:2,SIGQUIT:3,SIGILL:4,SIGTRAP:5,SIGABRT:6,SIGIOT:6,SIGBUS:7,SIGFPE:8,SIGKILL:9,SIGUSR1:10,SIGSEGV:11,SIGUSR2:12,SIGPIPE:13,SIGALRM:14,SIGTERM:15,SIGCHLD:17,SIGSTKFLT:16,SIGCONT:18,SIGSTOP:19,SIGTSTP:20,SIGTTIN:21,SIGTTOU:22,SIGURG:23,SIGXCPU:24,SIGXFSZ:25,SIGVTALRM:26,SIGPROF:27,SIGWINCH:28,SIGIO:29,SIGPOLL:29,SIGPWR:30,SIGSYS:31,SIGUNUSED:31,UV_FS_SYMLINK_DIR:1,UV_FS_SYMLINK_JUNCTION:2,O_RDONLY:0,O_WRONLY:1,O_RDWR:2,UV_DIRENT_UNKNOWN:0,UV_DIRENT_FILE:1,UV_DIRENT_DIR:2,UV_DIRENT_LINK:3,UV_DIRENT_FIFO:4,UV_DIRENT_SOCKET:5,UV_DIRENT_CHAR:6,UV_DIRENT_BLOCK:7,S_IFMT:61440,S_IFREG:32768,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960,S_IFSOCK:49152,O_CREAT:64,O_EXCL:128,UV_FS_O_FILEMAP:0,O_NOCTTY:256,O_TRUNC:512,O_APPEND:1024,O_DIRECTORY:65536,O_NOATIME:262144,O_NOFOLLOW:131072,O_SYNC:1052672,O_DSYNC:4096,O_DIRECT:16384,O_NONBLOCK:2048,S_IRWXU:448,S_IRUSR:256,S_IWUSR:128,S_IXUSR:64,S_IRWXG:56,S_IRGRP:32,S_IWGRP:16,S_IXGRP:8,S_IRWXO:7,S_IROTH:4,S_IWOTH:2,S_IXOTH:1,F_OK:0,R_OK:4,W_OK:2,X_OK:1,UV_FS_COPYFILE_EXCL:1,COPYFILE_EXCL:1,UV_FS_COPYFILE_FICLONE:2,COPYFILE_FICLONE:2,UV_FS_COPYFILE_FICLONE_FORCE:4,COPYFILE_FICLONE_FORCE:4,OPENSSL_VERSION_NUMBER:269488495,SSL_OP_ALL:2147485780,SSL_OP_ALLOW_NO_DHE_KEX:1024,SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION:262144,SSL_OP_CIPHER_SERVER_PREFERENCE:4194304,SSL_OP_CISCO_ANYCONNECT:32768,SSL_OP_COOKIE_EXCHANGE:8192,SSL_OP_CRYPTOPRO_TLSEXT_BUG:2147483648,SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS:2048,SSL_OP_EPHEMERAL_RSA:0,SSL_OP_LEGACY_SERVER_CONNECT:4,SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER:0,SSL_OP_MICROSOFT_SESS_ID_BUG:0,SSL_OP_MSIE_SSLV2_RSA_PADDING:0,SSL_OP_NETSCAPE_CA_DN_BUG:0,SSL_OP_NETSCAPE_CHALLENGE_BUG:0,SSL_OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG:0,SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG:0,SSL_OP_NO_COMPRESSION:131072,SSL_OP_NO_ENCRYPT_THEN_MAC:524288,SSL_OP_NO_QUERY_MTU:4096,SSL_OP_NO_RENEGOTIATION:1073741824,SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION:65536,SSL_OP_NO_SSLv2:0,SSL_OP_NO_SSLv3:33554432,SSL_OP_NO_TICKET:16384,SSL_OP_NO_TLSv1:67108864,SSL_OP_NO_TLSv1_1:268435456,SSL_OP_NO_TLSv1_2:134217728,SSL_OP_NO_TLSv1_3:536870912,SSL_OP_PKCS1_CHECK_1:0,SSL_OP_PKCS1_CHECK_2:0,SSL_OP_PRIORITIZE_CHACHA:2097152,SSL_OP_SINGLE_DH_USE:0,SSL_OP_SINGLE_ECDH_USE:0,SSL_OP_SSLEAY_080_CLIENT_DH_BUG:0,SSL_OP_SSLREF2_REUSE_CERT_TYPE_BUG:0,SSL_OP_TLS_BLOCK_PADDING_BUG:0,SSL_OP_TLS_D5_BUG:0,SSL_OP_TLS_ROLLBACK_BUG:8388608,ENGINE_METHOD_RSA:1,ENGINE_METHOD_DSA:2,ENGINE_METHOD_DH:4,ENGINE_METHOD_RAND:8,ENGINE_METHOD_EC:2048,ENGINE_METHOD_CIPHERS:64,ENGINE_METHOD_DIGESTS:128,ENGINE_METHOD_PKEY_METHS:512,ENGINE_METHOD_PKEY_ASN1_METHS:1024,ENGINE_METHOD_ALL:65535,ENGINE_METHOD_NONE:0,DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,ALPN_ENABLED:1,RSA_PKCS1_PADDING:1,RSA_SSLV23_PADDING:2,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,RSA_PSS_SALTLEN_DIGEST:-1,RSA_PSS_SALTLEN_MAX_SIGN:-2,RSA_PSS_SALTLEN_AUTO:-2,defaultCoreCipherList:"TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA256:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!SRP:!CAMELLIA",TLS1_VERSION:769,TLS1_1_VERSION:770,TLS1_2_VERSION:771,TLS1_3_VERSION:772,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6};const noe=Ge(roe),soe="0000000000000000000",ioe="7777777777777777777",ooe="0".charCodeAt(0),aoe=L("ustar\0","binary"),coe=L("00","binary"),loe=parseInt("7777",8),uoe=257,doe=263,hoe=function(r){switch(r){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72;default:return 0}},foe=function(r){let e=256;for(let t=0;t<148;t++)e+=r[t];for(let t=156;t<512;t++)e+=r[t];return e},Wi=function(r,e){const t=r.toString(8);return t.length>e?L(ioe.slice(0,e)+" "):L(soe.slice(0,e-t.length)+t+" ")},Xg=function(r){const e=L(r).byteLength;let t=Math.floor(Math.log(e)/Math.log(10))+1;return e+t>=Math.pow(10,t)&&t++,`${e+t}${r}`};function poe(r){let e="";r.name!=null&&(e+=Xg(" path="+r.name+`
`)),r.linkname!=null&&(e+=Xg(" linkpath="+r.linkname+`
`));const t=r.pax;if(t!=null)for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e+=Xg(" "+n+"="+t[n]+`
`));return L(e)}function Ob(r){const e=new Uint8Array(512);let t=r.name,n="";if(r.typeflag===5&&t[t.length-1]!=="/"&&(t+="/"),L(t).byteLength!==t.length)return null;for(;L(t).byteLength>100;){const s=t.indexOf("/");if(s===-1)return null;n+=n!==""?"/"+t.slice(0,s):t.slice(0,s),t=t.slice(s+1)}return L(t).byteLength>100||L(n).byteLength>155||r.linkname!=null&&L(r.linkname).byteLength>100?null:(e.set(L(t),0),e.set(Wi(r.mode&loe,6),100),e.set(Wi(r.uid,6),108),e.set(Wi(r.gid,6),116),e.set(Wi(r.size,11),124),e.set(Wi(r.mtime.getTime()/1e3|0,11),136),e[156]=ooe+hoe(r.type),r.linkname!=null&&e.set(L(r.linkname),157),e.set(aoe,uoe),e.set(coe,doe),r.uname!=null&&e.set(L(r.uname),265),r.gname!=null&&e.set(L(r.gname),297),e.set(Wi(r.devmajor??0,6),329),e.set(Wi(r.devminor??0,6),337),n!=null&&e.set(L(n),345),e.set(Wi(foe(e),6),148),e)}const{S_IFMT:goe,S_IFBLK:yoe,S_IFCHR:woe,S_IFDIR:boe,S_IFIFO:moe,S_IFLNK:Eoe}=noe,voe=parseInt("755",8),_oe=parseInt("644",8),Wx=new Uint8Array(1024);function Soe(r=0){switch(r&goe){case yoe:return"block-device";case woe:return"character-device";case boe:return"directory";case moe:return"fifo";case Eoe:return"symlink";default:return"file"}}function Pb(r){return r&=511,r!==0?Wx.subarray(0,512-r):new Uint8Array(0)}function Jg(r){if(r.pax==null){const e=Ob(r);if(e!=null)return e}return Aoe(r)}function Aoe(r){const e=poe(r),t={name:"PaxHeader",mode:r.mode,uid:r.uid,gid:r.gid,size:e.length,mtime:r.mtime,type:"pax-header",linkname:r.linkname,uname:r.uname,gname:r.gname,devmajor:r.devmajor,devminor:r.devminor};return new ue(Ob(t)??new Uint8Array(0),e,Pb(e.length),Ob({...t,size:r.size,type:r.type})??new Uint8Array(0)).subarray()}function m9(){return async function*(r){for await(let{header:e,body:t}of r){const n={...e,size:e.type==="symlink"?0:e.size??0,type:e.type??Soe(e.mode),mode:e.mode??(e.type==="directory"?voe:_oe),uid:e.uid??0,gid:e.gid??0,mtime:e.mtime??new Date};if(typeof t=="string"&&(t=L(t)),t instanceof Uint8Array||ha(t)){n.size=t.length,yield Jg(n),yield ha(t)?t.subarray():t,yield Pb(n.size);continue}if(n.type==="symlink"&&n.linkname==null){if(t==null)throw new Error("type was symlink but no linkname or body specified");n.linkname=C(await _w(t)),yield Jg(n);continue}if(yield Jg(n),n.type!=="file"&&n.type!=="contiguous-file")continue;let s=0;for await(const i of t??[])s+=i.length,yield ha(i)?i.subarray():i;if(s!==n.size)throw new Error(`size mismatch, wrote ${s} of ${n.size} bytes`);yield Pb(n.size)}yield Wx}}/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */const $oe=4,E9=0,v9=1,Roe=2;function Dl(r){let e=r.length;for(;--e>=0;)r[e]=0}const Toe=0,Qx=1,Ioe=2,Coe=3,xoe=258,h4=29,xh=256,Md=xh+1+h4,Kc=30,f4=19,Yx=2*Md+1,pa=15,Zg=16,Doe=7,p4=256,Xx=16,Jx=17,Zx=18,kb=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),up=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Ooe=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),eD=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Poe=512,Ei=new Array((Md+2)*2);Dl(Ei);const gd=new Array(Kc*2);Dl(gd);const Ud=new Array(Poe);Dl(Ud);const Bd=new Array(xoe-Coe+1);Dl(Bd);const g4=new Array(h4);Dl(g4);const u1=new Array(Kc);Dl(u1);function ey(r,e,t,n,s){this.static_tree=r,this.extra_bits=e,this.extra_base=t,this.elems=n,this.max_length=s,this.has_stree=r&&r.length}let tD,rD,nD;function ty(r,e){this.dyn_tree=r,this.max_code=0,this.stat_desc=e}const sD=r=>r<256?Ud[r]:Ud[256+(r>>>7)],zd=(r,e)=>{r.pending_buf[r.pending++]=e&255,r.pending_buf[r.pending++]=e>>>8&255},sn=(r,e,t)=>{r.bi_valid>Zg-t?(r.bi_buf|=e<<r.bi_valid&65535,zd(r,r.bi_buf),r.bi_buf=e>>Zg-r.bi_valid,r.bi_valid+=t-Zg):(r.bi_buf|=e<<r.bi_valid&65535,r.bi_valid+=t)},Ks=(r,e,t)=>{sn(r,t[e*2],t[e*2+1])},iD=(r,e)=>{let t=0;do t|=r&1,r>>>=1,t<<=1;while(--e>0);return t>>>1},koe=r=>{r.bi_valid===16?(zd(r,r.bi_buf),r.bi_buf=0,r.bi_valid=0):r.bi_valid>=8&&(r.pending_buf[r.pending++]=r.bi_buf&255,r.bi_buf>>=8,r.bi_valid-=8)},Noe=(r,e)=>{const t=e.dyn_tree,n=e.max_code,s=e.stat_desc.static_tree,i=e.stat_desc.has_stree,o=e.stat_desc.extra_bits,a=e.stat_desc.extra_base,c=e.stat_desc.max_length;let u,l,d,f,g,h,p=0;for(f=0;f<=pa;f++)r.bl_count[f]=0;for(t[r.heap[r.heap_max]*2+1]=0,u=r.heap_max+1;u<Yx;u++)l=r.heap[u],f=t[t[l*2+1]*2+1]+1,f>c&&(f=c,p++),t[l*2+1]=f,!(l>n)&&(r.bl_count[f]++,g=0,l>=a&&(g=o[l-a]),h=t[l*2],r.opt_len+=h*(f+g),i&&(r.static_len+=h*(s[l*2+1]+g)));if(p!==0){do{for(f=c-1;r.bl_count[f]===0;)f--;r.bl_count[f]--,r.bl_count[f+1]+=2,r.bl_count[c]--,p-=2}while(p>0);for(f=c;f!==0;f--)for(l=r.bl_count[f];l!==0;)d=r.heap[--u],!(d>n)&&(t[d*2+1]!==f&&(r.opt_len+=(f-t[d*2+1])*t[d*2],t[d*2+1]=f),l--)}},oD=(r,e,t)=>{const n=new Array(pa+1);let s=0,i,o;for(i=1;i<=pa;i++)s=s+t[i-1]<<1,n[i]=s;for(o=0;o<=e;o++){let a=r[o*2+1];a!==0&&(r[o*2]=iD(n[a]++,a))}},Loe=()=>{let r,e,t,n,s;const i=new Array(pa+1);for(t=0,n=0;n<h4-1;n++)for(g4[n]=t,r=0;r<1<<kb[n];r++)Bd[t++]=n;for(Bd[t-1]=n,s=0,n=0;n<16;n++)for(u1[n]=s,r=0;r<1<<up[n];r++)Ud[s++]=n;for(s>>=7;n<Kc;n++)for(u1[n]=s<<7,r=0;r<1<<up[n]-7;r++)Ud[256+s++]=n;for(e=0;e<=pa;e++)i[e]=0;for(r=0;r<=143;)Ei[r*2+1]=8,r++,i[8]++;for(;r<=255;)Ei[r*2+1]=9,r++,i[9]++;for(;r<=279;)Ei[r*2+1]=7,r++,i[7]++;for(;r<=287;)Ei[r*2+1]=8,r++,i[8]++;for(oD(Ei,Md+1,i),r=0;r<Kc;r++)gd[r*2+1]=5,gd[r*2]=iD(r,5);tD=new ey(Ei,kb,xh+1,Md,pa),rD=new ey(gd,up,0,Kc,pa),nD=new ey(new Array(0),Ooe,0,f4,Doe)},aD=r=>{let e;for(e=0;e<Md;e++)r.dyn_ltree[e*2]=0;for(e=0;e<Kc;e++)r.dyn_dtree[e*2]=0;for(e=0;e<f4;e++)r.bl_tree[e*2]=0;r.dyn_ltree[p4*2]=1,r.opt_len=r.static_len=0,r.sym_next=r.matches=0},cD=r=>{r.bi_valid>8?zd(r,r.bi_buf):r.bi_valid>0&&(r.pending_buf[r.pending++]=r.bi_buf),r.bi_buf=0,r.bi_valid=0},_9=(r,e,t,n)=>{const s=e*2,i=t*2;return r[s]<r[i]||r[s]===r[i]&&n[e]<=n[t]},ry=(r,e,t)=>{const n=r.heap[t];let s=t<<1;for(;s<=r.heap_len&&(s<r.heap_len&&_9(e,r.heap[s+1],r.heap[s],r.depth)&&s++,!_9(e,n,r.heap[s],r.depth));)r.heap[t]=r.heap[s],t=s,s<<=1;r.heap[t]=n},S9=(r,e,t)=>{let n,s,i=0,o,a;if(r.sym_next!==0)do n=r.pending_buf[r.sym_buf+i++]&255,n+=(r.pending_buf[r.sym_buf+i++]&255)<<8,s=r.pending_buf[r.sym_buf+i++],n===0?Ks(r,s,e):(o=Bd[s],Ks(r,o+xh+1,e),a=kb[o],a!==0&&(s-=g4[o],sn(r,s,a)),n--,o=sD(n),Ks(r,o,t),a=up[o],a!==0&&(n-=u1[o],sn(r,n,a)));while(i<r.sym_next);Ks(r,p4,e)},Nb=(r,e)=>{const t=e.dyn_tree,n=e.stat_desc.static_tree,s=e.stat_desc.has_stree,i=e.stat_desc.elems;let o,a,c=-1,u;for(r.heap_len=0,r.heap_max=Yx,o=0;o<i;o++)t[o*2]!==0?(r.heap[++r.heap_len]=c=o,r.depth[o]=0):t[o*2+1]=0;for(;r.heap_len<2;)u=r.heap[++r.heap_len]=c<2?++c:0,t[u*2]=1,r.depth[u]=0,r.opt_len--,s&&(r.static_len-=n[u*2+1]);for(e.max_code=c,o=r.heap_len>>1;o>=1;o--)ry(r,t,o);u=i;do o=r.heap[1],r.heap[1]=r.heap[r.heap_len--],ry(r,t,1),a=r.heap[1],r.heap[--r.heap_max]=o,r.heap[--r.heap_max]=a,t[u*2]=t[o*2]+t[a*2],r.depth[u]=(r.depth[o]>=r.depth[a]?r.depth[o]:r.depth[a])+1,t[o*2+1]=t[a*2+1]=u,r.heap[1]=u++,ry(r,t,1);while(r.heap_len>=2);r.heap[--r.heap_max]=r.heap[1],Noe(r,e),oD(t,c,r.bl_count)},A9=(r,e,t)=>{let n,s=-1,i,o=e[0*2+1],a=0,c=7,u=4;for(o===0&&(c=138,u=3),e[(t+1)*2+1]=65535,n=0;n<=t;n++)i=o,o=e[(n+1)*2+1],!(++a<c&&i===o)&&(a<u?r.bl_tree[i*2]+=a:i!==0?(i!==s&&r.bl_tree[i*2]++,r.bl_tree[Xx*2]++):a<=10?r.bl_tree[Jx*2]++:r.bl_tree[Zx*2]++,a=0,s=i,o===0?(c=138,u=3):i===o?(c=6,u=3):(c=7,u=4))},$9=(r,e,t)=>{let n,s=-1,i,o=e[0*2+1],a=0,c=7,u=4;for(o===0&&(c=138,u=3),n=0;n<=t;n++)if(i=o,o=e[(n+1)*2+1],!(++a<c&&i===o)){if(a<u)do Ks(r,i,r.bl_tree);while(--a!==0);else i!==0?(i!==s&&(Ks(r,i,r.bl_tree),a--),Ks(r,Xx,r.bl_tree),sn(r,a-3,2)):a<=10?(Ks(r,Jx,r.bl_tree),sn(r,a-3,3)):(Ks(r,Zx,r.bl_tree),sn(r,a-11,7));a=0,s=i,o===0?(c=138,u=3):i===o?(c=6,u=3):(c=7,u=4)}},Moe=r=>{let e;for(A9(r,r.dyn_ltree,r.l_desc.max_code),A9(r,r.dyn_dtree,r.d_desc.max_code),Nb(r,r.bl_desc),e=f4-1;e>=3&&r.bl_tree[eD[e]*2+1]===0;e--);return r.opt_len+=3*(e+1)+5+5+4,e},Uoe=(r,e,t,n)=>{let s;for(sn(r,e-257,5),sn(r,t-1,5),sn(r,n-4,4),s=0;s<n;s++)sn(r,r.bl_tree[eD[s]*2+1],3);$9(r,r.dyn_ltree,e-1),$9(r,r.dyn_dtree,t-1)},Boe=r=>{let e=4093624447,t;for(t=0;t<=31;t++,e>>>=1)if(e&1&&r.dyn_ltree[t*2]!==0)return E9;if(r.dyn_ltree[9*2]!==0||r.dyn_ltree[10*2]!==0||r.dyn_ltree[13*2]!==0)return v9;for(t=32;t<xh;t++)if(r.dyn_ltree[t*2]!==0)return v9;return E9};let R9=!1;const zoe=r=>{R9||(Loe(),R9=!0),r.l_desc=new ty(r.dyn_ltree,tD),r.d_desc=new ty(r.dyn_dtree,rD),r.bl_desc=new ty(r.bl_tree,nD),r.bi_buf=0,r.bi_valid=0,aD(r)},lD=(r,e,t,n)=>{sn(r,(Toe<<1)+(n?1:0),3),cD(r),zd(r,t),zd(r,~t),t&&r.pending_buf.set(r.window.subarray(e,e+t),r.pending),r.pending+=t},Foe=r=>{sn(r,Qx<<1,3),Ks(r,p4,Ei),koe(r)},Voe=(r,e,t,n)=>{let s,i,o=0;r.level>0?(r.strm.data_type===Roe&&(r.strm.data_type=Boe(r)),Nb(r,r.l_desc),Nb(r,r.d_desc),o=Moe(r),s=r.opt_len+3+7>>>3,i=r.static_len+3+7>>>3,i<=s&&(s=i)):s=i=t+5,t+4<=s&&e!==-1?lD(r,e,t,n):r.strategy===$oe||i===s?(sn(r,(Qx<<1)+(n?1:0),3),S9(r,Ei,gd)):(sn(r,(Ioe<<1)+(n?1:0),3),Uoe(r,r.l_desc.max_code+1,r.d_desc.max_code+1,o+1),S9(r,r.dyn_ltree,r.dyn_dtree)),aD(r),n&&cD(r)},joe=(r,e,t)=>(r.pending_buf[r.sym_buf+r.sym_next++]=e,r.pending_buf[r.sym_buf+r.sym_next++]=e>>8,r.pending_buf[r.sym_buf+r.sym_next++]=t,e===0?r.dyn_ltree[t*2]++:(r.matches++,e--,r.dyn_ltree[(Bd[t]+xh+1)*2]++,r.dyn_dtree[sD(e)*2]++),r.sym_next===r.sym_end);var qoe=zoe,Koe=lD,Goe=Voe,Hoe=joe,Woe=Foe,Qoe={_tr_init:qoe,_tr_stored_block:Koe,_tr_flush_block:Goe,_tr_tally:Hoe,_tr_align:Woe};const Yoe=(r,e,t,n)=>{let s=r&65535|0,i=r>>>16&65535|0,o=0;for(;t!==0;){o=t>2e3?2e3:t,t-=o;do s=s+e[n++]|0,i=i+s|0;while(--o);s%=65521,i%=65521}return s|i<<16|0};var Fd=Yoe;const Xoe=()=>{let r,e=[];for(var t=0;t<256;t++){r=t;for(var n=0;n<8;n++)r=r&1?3988292384^r>>>1:r>>>1;e[t]=r}return e},Joe=new Uint32Array(Xoe()),Zoe=(r,e,t,n)=>{const s=Joe,i=n+t;r^=-1;for(let o=n;o<i;o++)r=r>>>8^s[(r^e[o])&255];return r^-1};var Bt=Zoe,Ba={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},ec={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:eae,_tr_stored_block:Lb,_tr_flush_block:tae,_tr_tally:To,_tr_align:rae}=Qoe,{Z_NO_FLUSH:Io,Z_PARTIAL_FLUSH:nae,Z_FULL_FLUSH:sae,Z_FINISH:qn,Z_BLOCK:T9,Z_OK:qt,Z_STREAM_END:I9,Z_STREAM_ERROR:Hs,Z_DATA_ERROR:iae,Z_BUF_ERROR:ny,Z_DEFAULT_COMPRESSION:oae,Z_FILTERED:aae,Z_HUFFMAN_ONLY:bf,Z_RLE:cae,Z_FIXED:lae,Z_DEFAULT_STRATEGY:uae,Z_UNKNOWN:dae,Z_DEFLATED:R2}=ec,hae=9,fae=15,pae=8,gae=29,yae=256,Mb=yae+1+gae,wae=30,bae=19,mae=2*Mb+1,Eae=15,be=3,Eo=258,Ws=Eo+be+1,vae=32,al=42,y4=57,Ub=69,Bb=73,zb=91,Fb=103,ga=113,sd=666,Hr=1,Ol=2,za=3,Pl=4,_ae=3,ya=(r,e)=>(r.msg=Ba[e],e),C9=r=>r*2-(r>4?9:0),fo=r=>{let e=r.length;for(;--e>=0;)r[e]=0},Sae=r=>{let e,t,n,s=r.w_size;e=r.hash_size,n=e;do t=r.head[--n],r.head[n]=t>=s?t-s:0;while(--e);e=s,n=e;do t=r.prev[--n],r.prev[n]=t>=s?t-s:0;while(--e)};let Aae=(r,e,t)=>(e<<r.hash_shift^t)&r.hash_mask,Co=Aae;const hn=r=>{const e=r.state;let t=e.pending;t>r.avail_out&&(t=r.avail_out),t!==0&&(r.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+t),r.next_out),r.next_out+=t,e.pending_out+=t,r.total_out+=t,r.avail_out-=t,e.pending-=t,e.pending===0&&(e.pending_out=0))},pn=(r,e)=>{tae(r,r.block_start>=0?r.block_start:-1,r.strstart-r.block_start,e),r.block_start=r.strstart,hn(r.strm)},xe=(r,e)=>{r.pending_buf[r.pending++]=e},au=(r,e)=>{r.pending_buf[r.pending++]=e>>>8&255,r.pending_buf[r.pending++]=e&255},Vb=(r,e,t,n)=>{let s=r.avail_in;return s>n&&(s=n),s===0?0:(r.avail_in-=s,e.set(r.input.subarray(r.next_in,r.next_in+s),t),r.state.wrap===1?r.adler=Fd(r.adler,e,s,t):r.state.wrap===2&&(r.adler=Bt(r.adler,e,s,t)),r.next_in+=s,r.total_in+=s,s)},uD=(r,e)=>{let t=r.max_chain_length,n=r.strstart,s,i,o=r.prev_length,a=r.nice_match;const c=r.strstart>r.w_size-Ws?r.strstart-(r.w_size-Ws):0,u=r.window,l=r.w_mask,d=r.prev,f=r.strstart+Eo;let g=u[n+o-1],h=u[n+o];r.prev_length>=r.good_match&&(t>>=2),a>r.lookahead&&(a=r.lookahead);do if(s=e,!(u[s+o]!==h||u[s+o-1]!==g||u[s]!==u[n]||u[++s]!==u[n+1])){n+=2,s++;do;while(u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&u[++n]===u[++s]&&n<f);if(i=Eo-(f-n),n=f-Eo,i>o){if(r.match_start=e,o=i,i>=a)break;g=u[n+o-1],h=u[n+o]}}while((e=d[e&l])>c&&--t!==0);return o<=r.lookahead?o:r.lookahead},cl=r=>{const e=r.w_size;let t,n,s;do{if(n=r.window_size-r.lookahead-r.strstart,r.strstart>=e+(e-Ws)&&(r.window.set(r.window.subarray(e,e+e-n),0),r.match_start-=e,r.strstart-=e,r.block_start-=e,r.insert>r.strstart&&(r.insert=r.strstart),Sae(r),n+=e),r.strm.avail_in===0)break;if(t=Vb(r.strm,r.window,r.strstart+r.lookahead,n),r.lookahead+=t,r.lookahead+r.insert>=be)for(s=r.strstart-r.insert,r.ins_h=r.window[s],r.ins_h=Co(r,r.ins_h,r.window[s+1]);r.insert&&(r.ins_h=Co(r,r.ins_h,r.window[s+be-1]),r.prev[s&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=s,s++,r.insert--,!(r.lookahead+r.insert<be)););}while(r.lookahead<Ws&&r.strm.avail_in!==0)},dD=(r,e)=>{let t=r.pending_buf_size-5>r.w_size?r.w_size:r.pending_buf_size-5,n,s,i,o=0,a=r.strm.avail_in;do{if(n=65535,i=r.bi_valid+42>>3,r.strm.avail_out<i||(i=r.strm.avail_out-i,s=r.strstart-r.block_start,n>s+r.strm.avail_in&&(n=s+r.strm.avail_in),n>i&&(n=i),n<t&&(n===0&&e!==qn||e===Io||n!==s+r.strm.avail_in)))break;o=e===qn&&n===s+r.strm.avail_in?1:0,Lb(r,0,0,o),r.pending_buf[r.pending-4]=n,r.pending_buf[r.pending-3]=n>>8,r.pending_buf[r.pending-2]=~n,r.pending_buf[r.pending-1]=~n>>8,hn(r.strm),s&&(s>n&&(s=n),r.strm.output.set(r.window.subarray(r.block_start,r.block_start+s),r.strm.next_out),r.strm.next_out+=s,r.strm.avail_out-=s,r.strm.total_out+=s,r.block_start+=s,n-=s),n&&(Vb(r.strm,r.strm.output,r.strm.next_out,n),r.strm.next_out+=n,r.strm.avail_out-=n,r.strm.total_out+=n)}while(o===0);return a-=r.strm.avail_in,a&&(a>=r.w_size?(r.matches=2,r.window.set(r.strm.input.subarray(r.strm.next_in-r.w_size,r.strm.next_in),0),r.strstart=r.w_size,r.insert=r.strstart):(r.window_size-r.strstart<=a&&(r.strstart-=r.w_size,r.window.set(r.window.subarray(r.w_size,r.w_size+r.strstart),0),r.matches<2&&r.matches++,r.insert>r.strstart&&(r.insert=r.strstart)),r.window.set(r.strm.input.subarray(r.strm.next_in-a,r.strm.next_in),r.strstart),r.strstart+=a,r.insert+=a>r.w_size-r.insert?r.w_size-r.insert:a),r.block_start=r.strstart),r.high_water<r.strstart&&(r.high_water=r.strstart),o?Pl:e!==Io&&e!==qn&&r.strm.avail_in===0&&r.strstart===r.block_start?Ol:(i=r.window_size-r.strstart,r.strm.avail_in>i&&r.block_start>=r.w_size&&(r.block_start-=r.w_size,r.strstart-=r.w_size,r.window.set(r.window.subarray(r.w_size,r.w_size+r.strstart),0),r.matches<2&&r.matches++,i+=r.w_size,r.insert>r.strstart&&(r.insert=r.strstart)),i>r.strm.avail_in&&(i=r.strm.avail_in),i&&(Vb(r.strm,r.window,r.strstart,i),r.strstart+=i,r.insert+=i>r.w_size-r.insert?r.w_size-r.insert:i),r.high_water<r.strstart&&(r.high_water=r.strstart),i=r.bi_valid+42>>3,i=r.pending_buf_size-i>65535?65535:r.pending_buf_size-i,t=i>r.w_size?r.w_size:i,s=r.strstart-r.block_start,(s>=t||(s||e===qn)&&e!==Io&&r.strm.avail_in===0&&s<=i)&&(n=s>i?i:s,o=e===qn&&r.strm.avail_in===0&&n===s?1:0,Lb(r,r.block_start,n,o),r.block_start+=n,hn(r.strm)),o?za:Hr)},sy=(r,e)=>{let t,n;for(;;){if(r.lookahead<Ws){if(cl(r),r.lookahead<Ws&&e===Io)return Hr;if(r.lookahead===0)break}if(t=0,r.lookahead>=be&&(r.ins_h=Co(r,r.ins_h,r.window[r.strstart+be-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart),t!==0&&r.strstart-t<=r.w_size-Ws&&(r.match_length=uD(r,t)),r.match_length>=be)if(n=To(r,r.strstart-r.match_start,r.match_length-be),r.lookahead-=r.match_length,r.match_length<=r.max_lazy_match&&r.lookahead>=be){r.match_length--;do r.strstart++,r.ins_h=Co(r,r.ins_h,r.window[r.strstart+be-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart;while(--r.match_length!==0);r.strstart++}else r.strstart+=r.match_length,r.match_length=0,r.ins_h=r.window[r.strstart],r.ins_h=Co(r,r.ins_h,r.window[r.strstart+1]);else n=To(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++;if(n&&(pn(r,!1),r.strm.avail_out===0))return Hr}return r.insert=r.strstart<be-1?r.strstart:be-1,e===qn?(pn(r,!0),r.strm.avail_out===0?za:Pl):r.sym_next&&(pn(r,!1),r.strm.avail_out===0)?Hr:Ol},uc=(r,e)=>{let t,n,s;for(;;){if(r.lookahead<Ws){if(cl(r),r.lookahead<Ws&&e===Io)return Hr;if(r.lookahead===0)break}if(t=0,r.lookahead>=be&&(r.ins_h=Co(r,r.ins_h,r.window[r.strstart+be-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart),r.prev_length=r.match_length,r.prev_match=r.match_start,r.match_length=be-1,t!==0&&r.prev_length<r.max_lazy_match&&r.strstart-t<=r.w_size-Ws&&(r.match_length=uD(r,t),r.match_length<=5&&(r.strategy===aae||r.match_length===be&&r.strstart-r.match_start>4096)&&(r.match_length=be-1)),r.prev_length>=be&&r.match_length<=r.prev_length){s=r.strstart+r.lookahead-be,n=To(r,r.strstart-1-r.prev_match,r.prev_length-be),r.lookahead-=r.prev_length-1,r.prev_length-=2;do++r.strstart<=s&&(r.ins_h=Co(r,r.ins_h,r.window[r.strstart+be-1]),t=r.prev[r.strstart&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=r.strstart);while(--r.prev_length!==0);if(r.match_available=0,r.match_length=be-1,r.strstart++,n&&(pn(r,!1),r.strm.avail_out===0))return Hr}else if(r.match_available){if(n=To(r,0,r.window[r.strstart-1]),n&&pn(r,!1),r.strstart++,r.lookahead--,r.strm.avail_out===0)return Hr}else r.match_available=1,r.strstart++,r.lookahead--}return r.match_available&&(n=To(r,0,r.window[r.strstart-1]),r.match_available=0),r.insert=r.strstart<be-1?r.strstart:be-1,e===qn?(pn(r,!0),r.strm.avail_out===0?za:Pl):r.sym_next&&(pn(r,!1),r.strm.avail_out===0)?Hr:Ol},$ae=(r,e)=>{let t,n,s,i;const o=r.window;for(;;){if(r.lookahead<=Eo){if(cl(r),r.lookahead<=Eo&&e===Io)return Hr;if(r.lookahead===0)break}if(r.match_length=0,r.lookahead>=be&&r.strstart>0&&(s=r.strstart-1,n=o[s],n===o[++s]&&n===o[++s]&&n===o[++s])){i=r.strstart+Eo;do;while(n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&s<i);r.match_length=Eo-(i-s),r.match_length>r.lookahead&&(r.match_length=r.lookahead)}if(r.match_length>=be?(t=To(r,1,r.match_length-be),r.lookahead-=r.match_length,r.strstart+=r.match_length,r.match_length=0):(t=To(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++),t&&(pn(r,!1),r.strm.avail_out===0))return Hr}return r.insert=0,e===qn?(pn(r,!0),r.strm.avail_out===0?za:Pl):r.sym_next&&(pn(r,!1),r.strm.avail_out===0)?Hr:Ol},Rae=(r,e)=>{let t;for(;;){if(r.lookahead===0&&(cl(r),r.lookahead===0)){if(e===Io)return Hr;break}if(r.match_length=0,t=To(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++,t&&(pn(r,!1),r.strm.avail_out===0))return Hr}return r.insert=0,e===qn?(pn(r,!0),r.strm.avail_out===0?za:Pl):r.sym_next&&(pn(r,!1),r.strm.avail_out===0)?Hr:Ol};function Os(r,e,t,n,s){this.good_length=r,this.max_lazy=e,this.nice_length=t,this.max_chain=n,this.func=s}const id=[new Os(0,0,0,0,dD),new Os(4,4,8,4,sy),new Os(4,5,16,8,sy),new Os(4,6,32,32,sy),new Os(4,4,16,16,uc),new Os(8,16,32,32,uc),new Os(8,16,128,128,uc),new Os(8,32,128,256,uc),new Os(32,128,258,1024,uc),new Os(32,258,258,4096,uc)],Tae=r=>{r.window_size=2*r.w_size,fo(r.head),r.max_lazy_match=id[r.level].max_lazy,r.good_match=id[r.level].good_length,r.nice_match=id[r.level].nice_length,r.max_chain_length=id[r.level].max_chain,r.strstart=0,r.block_start=0,r.lookahead=0,r.insert=0,r.match_length=r.prev_length=be-1,r.match_available=0,r.ins_h=0};function Iae(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=R2,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(mae*2),this.dyn_dtree=new Uint16Array((2*wae+1)*2),this.bl_tree=new Uint16Array((2*bae+1)*2),fo(this.dyn_ltree),fo(this.dyn_dtree),fo(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(Eae+1),this.heap=new Uint16Array(2*Mb+1),fo(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*Mb+1),fo(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Dh=r=>{if(!r)return 1;const e=r.state;return!e||e.strm!==r||e.status!==al&&e.status!==y4&&e.status!==Ub&&e.status!==Bb&&e.status!==zb&&e.status!==Fb&&e.status!==ga&&e.status!==sd?1:0},hD=r=>{if(Dh(r))return ya(r,Hs);r.total_in=r.total_out=0,r.data_type=dae;const e=r.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?y4:e.wrap?al:ga,r.adler=e.wrap===2?0:1,e.last_flush=-2,eae(e),qt},fD=r=>{const e=hD(r);return e===qt&&Tae(r.state),e},Cae=(r,e)=>Dh(r)||r.state.wrap!==2?Hs:(r.state.gzhead=e,qt),pD=(r,e,t,n,s,i)=>{if(!r)return Hs;let o=1;if(e===oae&&(e=6),n<0?(o=0,n=-n):n>15&&(o=2,n-=16),s<1||s>hae||t!==R2||n<8||n>15||e<0||e>9||i<0||i>lae||n===8&&o!==1)return ya(r,Hs);n===8&&(n=9);const a=new Iae;return r.state=a,a.strm=r,a.status=al,a.wrap=o,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+be-1)/be),a.window=new Uint8Array(a.w_size*2),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=a.lit_bufsize*4,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=(a.lit_bufsize-1)*3,a.level=e,a.strategy=i,a.method=t,fD(r)},xae=(r,e)=>pD(r,e,R2,fae,pae,uae),Dae=(r,e)=>{if(Dh(r)||e>T9||e<0)return r?ya(r,Hs):Hs;const t=r.state;if(!r.output||r.avail_in!==0&&!r.input||t.status===sd&&e!==qn)return ya(r,r.avail_out===0?ny:Hs);const n=t.last_flush;if(t.last_flush=e,t.pending!==0){if(hn(r),r.avail_out===0)return t.last_flush=-1,qt}else if(r.avail_in===0&&C9(e)<=C9(n)&&e!==qn)return ya(r,ny);if(t.status===sd&&r.avail_in!==0)return ya(r,ny);if(t.status===al&&t.wrap===0&&(t.status=ga),t.status===al){let s=R2+(t.w_bits-8<<4)<<8,i=-1;if(t.strategy>=bf||t.level<2?i=0:t.level<6?i=1:t.level===6?i=2:i=3,s|=i<<6,t.strstart!==0&&(s|=vae),s+=31-s%31,au(t,s),t.strstart!==0&&(au(t,r.adler>>>16),au(t,r.adler&65535)),r.adler=1,t.status=ga,hn(r),t.pending!==0)return t.last_flush=-1,qt}if(t.status===y4){if(r.adler=0,xe(t,31),xe(t,139),xe(t,8),t.gzhead)xe(t,(t.gzhead.text?1:0)+(t.gzhead.hcrc?2:0)+(t.gzhead.extra?4:0)+(t.gzhead.name?8:0)+(t.gzhead.comment?16:0)),xe(t,t.gzhead.time&255),xe(t,t.gzhead.time>>8&255),xe(t,t.gzhead.time>>16&255),xe(t,t.gzhead.time>>24&255),xe(t,t.level===9?2:t.strategy>=bf||t.level<2?4:0),xe(t,t.gzhead.os&255),t.gzhead.extra&&t.gzhead.extra.length&&(xe(t,t.gzhead.extra.length&255),xe(t,t.gzhead.extra.length>>8&255)),t.gzhead.hcrc&&(r.adler=Bt(r.adler,t.pending_buf,t.pending,0)),t.gzindex=0,t.status=Ub;else if(xe(t,0),xe(t,0),xe(t,0),xe(t,0),xe(t,0),xe(t,t.level===9?2:t.strategy>=bf||t.level<2?4:0),xe(t,_ae),t.status=ga,hn(r),t.pending!==0)return t.last_flush=-1,qt}if(t.status===Ub){if(t.gzhead.extra){let s=t.pending,i=(t.gzhead.extra.length&65535)-t.gzindex;for(;t.pending+i>t.pending_buf_size;){let a=t.pending_buf_size-t.pending;if(t.pending_buf.set(t.gzhead.extra.subarray(t.gzindex,t.gzindex+a),t.pending),t.pending=t.pending_buf_size,t.gzhead.hcrc&&t.pending>s&&(r.adler=Bt(r.adler,t.pending_buf,t.pending-s,s)),t.gzindex+=a,hn(r),t.pending!==0)return t.last_flush=-1,qt;s=0,i-=a}let o=new Uint8Array(t.gzhead.extra);t.pending_buf.set(o.subarray(t.gzindex,t.gzindex+i),t.pending),t.pending+=i,t.gzhead.hcrc&&t.pending>s&&(r.adler=Bt(r.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=Bb}if(t.status===Bb){if(t.gzhead.name){let s=t.pending,i;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(r.adler=Bt(r.adler,t.pending_buf,t.pending-s,s)),hn(r),t.pending!==0)return t.last_flush=-1,qt;s=0}t.gzindex<t.gzhead.name.length?i=t.gzhead.name.charCodeAt(t.gzindex++)&255:i=0,xe(t,i)}while(i!==0);t.gzhead.hcrc&&t.pending>s&&(r.adler=Bt(r.adler,t.pending_buf,t.pending-s,s)),t.gzindex=0}t.status=zb}if(t.status===zb){if(t.gzhead.comment){let s=t.pending,i;do{if(t.pending===t.pending_buf_size){if(t.gzhead.hcrc&&t.pending>s&&(r.adler=Bt(r.adler,t.pending_buf,t.pending-s,s)),hn(r),t.pending!==0)return t.last_flush=-1,qt;s=0}t.gzindex<t.gzhead.comment.length?i=t.gzhead.comment.charCodeAt(t.gzindex++)&255:i=0,xe(t,i)}while(i!==0);t.gzhead.hcrc&&t.pending>s&&(r.adler=Bt(r.adler,t.pending_buf,t.pending-s,s))}t.status=Fb}if(t.status===Fb){if(t.gzhead.hcrc){if(t.pending+2>t.pending_buf_size&&(hn(r),t.pending!==0))return t.last_flush=-1,qt;xe(t,r.adler&255),xe(t,r.adler>>8&255),r.adler=0}if(t.status=ga,hn(r),t.pending!==0)return t.last_flush=-1,qt}if(r.avail_in!==0||t.lookahead!==0||e!==Io&&t.status!==sd){let s=t.level===0?dD(t,e):t.strategy===bf?Rae(t,e):t.strategy===cae?$ae(t,e):id[t.level].func(t,e);if((s===za||s===Pl)&&(t.status=sd),s===Hr||s===za)return r.avail_out===0&&(t.last_flush=-1),qt;if(s===Ol&&(e===nae?rae(t):e!==T9&&(Lb(t,0,0,!1),e===sae&&(fo(t.head),t.lookahead===0&&(t.strstart=0,t.block_start=0,t.insert=0))),hn(r),r.avail_out===0))return t.last_flush=-1,qt}return e!==qn?qt:t.wrap<=0?I9:(t.wrap===2?(xe(t,r.adler&255),xe(t,r.adler>>8&255),xe(t,r.adler>>16&255),xe(t,r.adler>>24&255),xe(t,r.total_in&255),xe(t,r.total_in>>8&255),xe(t,r.total_in>>16&255),xe(t,r.total_in>>24&255)):(au(t,r.adler>>>16),au(t,r.adler&65535)),hn(r),t.wrap>0&&(t.wrap=-t.wrap),t.pending!==0?qt:I9)},Oae=r=>{if(Dh(r))return Hs;const e=r.state.status;return r.state=null,e===ga?ya(r,iae):qt},Pae=(r,e)=>{let t=e.length;if(Dh(r))return Hs;const n=r.state,s=n.wrap;if(s===2||s===1&&n.status!==al||n.lookahead)return Hs;if(s===1&&(r.adler=Fd(r.adler,e,t,0)),n.wrap=0,t>=n.w_size){s===0&&(fo(n.head),n.strstart=0,n.block_start=0,n.insert=0);let c=new Uint8Array(n.w_size);c.set(e.subarray(t-n.w_size,t),0),e=c,t=n.w_size}const i=r.avail_in,o=r.next_in,a=r.input;for(r.avail_in=t,r.next_in=0,r.input=e,cl(n);n.lookahead>=be;){let c=n.strstart,u=n.lookahead-(be-1);do n.ins_h=Co(n,n.ins_h,n.window[c+be-1]),n.prev[c&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=c,c++;while(--u);n.strstart=c,n.lookahead=be-1,cl(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=be-1,n.match_available=0,r.next_in=o,r.input=a,r.avail_in=i,n.wrap=s,qt};var kae=xae,Nae=pD,Lae=fD,Mae=hD,Uae=Cae,Bae=Dae,zae=Oae,Fae=Pae,Vae="pako deflate (from Nodeca project)",yd={deflateInit:kae,deflateInit2:Nae,deflateReset:Lae,deflateResetKeep:Mae,deflateSetHeader:Uae,deflate:Bae,deflateEnd:zae,deflateSetDictionary:Fae,deflateInfo:Vae};const jae=(r,e)=>Object.prototype.hasOwnProperty.call(r,e);var qae=function(r){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const t=e.shift();if(t){if(typeof t!="object")throw new TypeError(t+"must be non-object");for(const n in t)jae(t,n)&&(r[n]=t[n])}}return r},Kae=r=>{let e=0;for(let n=0,s=r.length;n<s;n++)e+=r[n].length;const t=new Uint8Array(e);for(let n=0,s=0,i=r.length;n<i;n++){let o=r[n];t.set(o,s),s+=o.length}return t},T2={assign:qae,flattenChunks:Kae};let gD=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{gD=!1}const Vd=new Uint8Array(256);for(let r=0;r<256;r++)Vd[r]=r>=252?6:r>=248?5:r>=240?4:r>=224?3:r>=192?2:1;Vd[254]=Vd[254]=1;var Gae=r=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(r);let e,t,n,s,i,o=r.length,a=0;for(s=0;s<o;s++)t=r.charCodeAt(s),(t&64512)===55296&&s+1<o&&(n=r.charCodeAt(s+1),(n&64512)===56320&&(t=65536+(t-55296<<10)+(n-56320),s++)),a+=t<128?1:t<2048?2:t<65536?3:4;for(e=new Uint8Array(a),i=0,s=0;i<a;s++)t=r.charCodeAt(s),(t&64512)===55296&&s+1<o&&(n=r.charCodeAt(s+1),(n&64512)===56320&&(t=65536+(t-55296<<10)+(n-56320),s++)),t<128?e[i++]=t:t<2048?(e[i++]=192|t>>>6,e[i++]=128|t&63):t<65536?(e[i++]=224|t>>>12,e[i++]=128|t>>>6&63,e[i++]=128|t&63):(e[i++]=240|t>>>18,e[i++]=128|t>>>12&63,e[i++]=128|t>>>6&63,e[i++]=128|t&63);return e};const Hae=(r,e)=>{if(e<65534&&r.subarray&&gD)return String.fromCharCode.apply(null,r.length===e?r:r.subarray(0,e));let t="";for(let n=0;n<e;n++)t+=String.fromCharCode(r[n]);return t};var Wae=(r,e)=>{const t=e||r.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(r.subarray(0,e));let n,s;const i=new Array(t*2);for(s=0,n=0;n<t;){let o=r[n++];if(o<128){i[s++]=o;continue}let a=Vd[o];if(a>4){i[s++]=65533,n+=a-1;continue}for(o&=a===2?31:a===3?15:7;a>1&&n<t;)o=o<<6|r[n++]&63,a--;if(a>1){i[s++]=65533;continue}o<65536?i[s++]=o:(o-=65536,i[s++]=55296|o>>10&1023,i[s++]=56320|o&1023)}return Hae(i,s)},Qae=(r,e)=>{e=e||r.length,e>r.length&&(e=r.length);let t=e-1;for(;t>=0&&(r[t]&192)===128;)t--;return t<0||t===0?e:t+Vd[r[t]]>e?t:e},jd={string2buf:Gae,buf2string:Wae,utf8border:Qae};function Yae(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var yD=Yae;const wD=Object.prototype.toString,{Z_NO_FLUSH:Xae,Z_SYNC_FLUSH:Jae,Z_FULL_FLUSH:Zae,Z_FINISH:ece,Z_OK:d1,Z_STREAM_END:tce,Z_DEFAULT_COMPRESSION:rce,Z_DEFAULT_STRATEGY:nce,Z_DEFLATED:sce}=ec;function Oh(r){this.options=T2.assign({level:rce,method:sce,chunkSize:16384,windowBits:15,memLevel:8,strategy:nce},r||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new yD,this.strm.avail_out=0;let t=yd.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(t!==d1)throw new Error(Ba[t]);if(e.header&&yd.deflateSetHeader(this.strm,e.header),e.dictionary){let n;if(typeof e.dictionary=="string"?n=jd.string2buf(e.dictionary):wD.call(e.dictionary)==="[object ArrayBuffer]"?n=new Uint8Array(e.dictionary):n=e.dictionary,t=yd.deflateSetDictionary(this.strm,n),t!==d1)throw new Error(Ba[t]);this._dict_set=!0}}Oh.prototype.push=function(r,e){const t=this.strm,n=this.options.chunkSize;let s,i;if(this.ended)return!1;for(e===~~e?i=e:i=e===!0?ece:Xae,typeof r=="string"?t.input=jd.string2buf(r):wD.call(r)==="[object ArrayBuffer]"?t.input=new Uint8Array(r):t.input=r,t.next_in=0,t.avail_in=t.input.length;;){if(t.avail_out===0&&(t.output=new Uint8Array(n),t.next_out=0,t.avail_out=n),(i===Jae||i===Zae)&&t.avail_out<=6){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(s=yd.deflate(t,i),s===tce)return t.next_out>0&&this.onData(t.output.subarray(0,t.next_out)),s=yd.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===d1;if(t.avail_out===0){this.onData(t.output);continue}if(i>0&&t.next_out>0){this.onData(t.output.subarray(0,t.next_out)),t.avail_out=0;continue}if(t.avail_in===0)break}return!0};Oh.prototype.onData=function(r){this.chunks.push(r)};Oh.prototype.onEnd=function(r){r===d1&&(this.result=T2.flattenChunks(this.chunks)),this.chunks=[],this.err=r,this.msg=this.strm.msg};function w4(r,e){const t=new Oh(e);if(t.push(r,!0),t.err)throw t.msg||Ba[t.err];return t.result}function ice(r,e){return e=e||{},e.raw=!0,w4(r,e)}function oce(r,e){return e=e||{},e.gzip=!0,w4(r,e)}var ace=Oh,cce=w4,lce=ice,uce=oce,dce=ec,hce={Deflate:ace,deflate:cce,deflateRaw:lce,gzip:uce,constants:dce};const mf=16209,fce=16191;var pce=function(e,t){let n,s,i,o,a,c,u,l,d,f,g,h,p,w,y,E,m,b,v,S,_,A,T,P;const V=e.state;n=e.next_in,T=e.input,s=n+(e.avail_in-5),i=e.next_out,P=e.output,o=i-(t-e.avail_out),a=i+(e.avail_out-257),c=V.dmax,u=V.wsize,l=V.whave,d=V.wnext,f=V.window,g=V.hold,h=V.bits,p=V.lencode,w=V.distcode,y=(1<<V.lenbits)-1,E=(1<<V.distbits)-1;e:do{h<15&&(g+=T[n++]<<h,h+=8,g+=T[n++]<<h,h+=8),m=p[g&y];t:for(;;){if(b=m>>>24,g>>>=b,h-=b,b=m>>>16&255,b===0)P[i++]=m&65535;else if(b&16){v=m&65535,b&=15,b&&(h<b&&(g+=T[n++]<<h,h+=8),v+=g&(1<<b)-1,g>>>=b,h-=b),h<15&&(g+=T[n++]<<h,h+=8,g+=T[n++]<<h,h+=8),m=w[g&E];r:for(;;){if(b=m>>>24,g>>>=b,h-=b,b=m>>>16&255,b&16){if(S=m&65535,b&=15,h<b&&(g+=T[n++]<<h,h+=8,h<b&&(g+=T[n++]<<h,h+=8)),S+=g&(1<<b)-1,S>c){e.msg="invalid distance too far back",V.mode=mf;break e}if(g>>>=b,h-=b,b=i-o,S>b){if(b=S-b,b>l&&V.sane){e.msg="invalid distance too far back",V.mode=mf;break e}if(_=0,A=f,d===0){if(_+=u-b,b<v){v-=b;do P[i++]=f[_++];while(--b);_=i-S,A=P}}else if(d<b){if(_+=u+d-b,b-=d,b<v){v-=b;do P[i++]=f[_++];while(--b);if(_=0,d<v){b=d,v-=b;do P[i++]=f[_++];while(--b);_=i-S,A=P}}}else if(_+=d-b,b<v){v-=b;do P[i++]=f[_++];while(--b);_=i-S,A=P}for(;v>2;)P[i++]=A[_++],P[i++]=A[_++],P[i++]=A[_++],v-=3;v&&(P[i++]=A[_++],v>1&&(P[i++]=A[_++]))}else{_=i-S;do P[i++]=P[_++],P[i++]=P[_++],P[i++]=P[_++],v-=3;while(v>2);v&&(P[i++]=P[_++],v>1&&(P[i++]=P[_++]))}}else if(b&64){e.msg="invalid distance code",V.mode=mf;break e}else{m=w[(m&65535)+(g&(1<<b)-1)];continue r}break}}else if(b&64)if(b&32){V.mode=fce;break e}else{e.msg="invalid literal/length code",V.mode=mf;break e}else{m=p[(m&65535)+(g&(1<<b)-1)];continue t}break}}while(n<s&&i<a);v=h>>3,n-=v,h-=v<<3,g&=(1<<h)-1,e.next_in=n,e.next_out=i,e.avail_in=n<s?5+(s-n):5-(n-s),e.avail_out=i<a?257+(a-i):257-(i-a),V.hold=g,V.bits=h};const dc=15,x9=852,D9=592,O9=0,iy=1,P9=2,gce=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),yce=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),wce=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),bce=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),mce=(r,e,t,n,s,i,o,a)=>{const c=a.bits;let u=0,l=0,d=0,f=0,g=0,h=0,p=0,w=0,y=0,E=0,m,b,v,S,_,A=null,T;const P=new Uint16Array(dc+1),V=new Uint16Array(dc+1);let Y=null,te,se,Q;for(u=0;u<=dc;u++)P[u]=0;for(l=0;l<n;l++)P[e[t+l]]++;for(g=c,f=dc;f>=1&&P[f]===0;f--);if(g>f&&(g=f),f===0)return s[i++]=1<<24|64<<16|0,s[i++]=1<<24|64<<16|0,a.bits=1,0;for(d=1;d<f&&P[d]===0;d++);for(g<d&&(g=d),w=1,u=1;u<=dc;u++)if(w<<=1,w-=P[u],w<0)return-1;if(w>0&&(r===O9||f!==1))return-1;for(V[1]=0,u=1;u<dc;u++)V[u+1]=V[u]+P[u];for(l=0;l<n;l++)e[t+l]!==0&&(o[V[e[t+l]]++]=l);if(r===O9?(A=Y=o,T=20):r===iy?(A=gce,Y=yce,T=257):(A=wce,Y=bce,T=0),E=0,l=0,u=d,_=i,h=g,p=0,v=-1,y=1<<g,S=y-1,r===iy&&y>x9||r===P9&&y>D9)return 1;for(;;){te=u-p,o[l]+1<T?(se=0,Q=o[l]):o[l]>=T?(se=Y[o[l]-T],Q=A[o[l]-T]):(se=32+64,Q=0),m=1<<u-p,b=1<<h,d=b;do b-=m,s[_+(E>>p)+b]=te<<24|se<<16|Q|0;while(b!==0);for(m=1<<u-1;E&m;)m>>=1;if(m!==0?(E&=m-1,E+=m):E=0,l++,--P[u]===0){if(u===f)break;u=e[t+o[l]]}if(u>g&&(E&S)!==v){for(p===0&&(p=g),_+=d,h=u-p,w=1<<h;h+p<f&&(w-=P[h+p],!(w<=0));)h++,w<<=1;if(y+=1<<h,r===iy&&y>x9||r===P9&&y>D9)return 1;v=E&S,s[v]=g<<24|h<<16|_-i|0}}return E!==0&&(s[_+E]=u-p<<24|64<<16|0),a.bits=g,0};var wd=mce;const Ece=0,bD=1,mD=2,{Z_FINISH:k9,Z_BLOCK:vce,Z_TREES:Ef,Z_OK:Fa,Z_STREAM_END:_ce,Z_NEED_DICT:Sce,Z_STREAM_ERROR:Xn,Z_DATA_ERROR:ED,Z_MEM_ERROR:vD,Z_BUF_ERROR:Ace,Z_DEFLATED:N9}=ec,I2=16180,L9=16181,M9=16182,U9=16183,B9=16184,z9=16185,F9=16186,V9=16187,j9=16188,q9=16189,h1=16190,li=16191,oy=16192,K9=16193,ay=16194,G9=16195,H9=16196,W9=16197,Q9=16198,vf=16199,_f=16200,Y9=16201,X9=16202,J9=16203,Z9=16204,ev=16205,cy=16206,tv=16207,rv=16208,rt=16209,_D=16210,SD=16211,$ce=852,Rce=592,Tce=15,Ice=Tce,nv=r=>(r>>>24&255)+(r>>>8&65280)+((r&65280)<<8)+((r&255)<<24);function Cce(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const tc=r=>{if(!r)return 1;const e=r.state;return!e||e.strm!==r||e.mode<I2||e.mode>SD?1:0},AD=r=>{if(tc(r))return Xn;const e=r.state;return r.total_in=r.total_out=e.total=0,r.msg="",e.wrap&&(r.adler=e.wrap&1),e.mode=I2,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array($ce),e.distcode=e.distdyn=new Int32Array(Rce),e.sane=1,e.back=-1,Fa},$D=r=>{if(tc(r))return Xn;const e=r.state;return e.wsize=0,e.whave=0,e.wnext=0,AD(r)},RD=(r,e)=>{let t;if(tc(r))return Xn;const n=r.state;return e<0?(t=0,e=-e):(t=(e>>4)+5,e<48&&(e&=15)),e&&(e<8||e>15)?Xn:(n.window!==null&&n.wbits!==e&&(n.window=null),n.wrap=t,n.wbits=e,$D(r))},TD=(r,e)=>{if(!r)return Xn;const t=new Cce;r.state=t,t.strm=r,t.window=null,t.mode=I2;const n=RD(r,e);return n!==Fa&&(r.state=null),n},xce=r=>TD(r,Ice);let sv=!0,ly,uy;const Dce=r=>{if(sv){ly=new Int32Array(512),uy=new Int32Array(32);let e=0;for(;e<144;)r.lens[e++]=8;for(;e<256;)r.lens[e++]=9;for(;e<280;)r.lens[e++]=7;for(;e<288;)r.lens[e++]=8;for(wd(bD,r.lens,0,288,ly,0,r.work,{bits:9}),e=0;e<32;)r.lens[e++]=5;wd(mD,r.lens,0,32,uy,0,r.work,{bits:5}),sv=!1}r.lencode=ly,r.lenbits=9,r.distcode=uy,r.distbits=5},ID=(r,e,t,n)=>{let s;const i=r.state;return i.window===null&&(i.wsize=1<<i.wbits,i.wnext=0,i.whave=0,i.window=new Uint8Array(i.wsize)),n>=i.wsize?(i.window.set(e.subarray(t-i.wsize,t),0),i.wnext=0,i.whave=i.wsize):(s=i.wsize-i.wnext,s>n&&(s=n),i.window.set(e.subarray(t-n,t-n+s),i.wnext),n-=s,n?(i.window.set(e.subarray(t-n,t),0),i.wnext=n,i.whave=i.wsize):(i.wnext+=s,i.wnext===i.wsize&&(i.wnext=0),i.whave<i.wsize&&(i.whave+=s))),0},Oce=(r,e)=>{let t,n,s,i,o,a,c,u,l,d,f,g,h,p,w=0,y,E,m,b,v,S,_,A;const T=new Uint8Array(4);let P,V;const Y=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(tc(r)||!r.output||!r.input&&r.avail_in!==0)return Xn;t=r.state,t.mode===li&&(t.mode=oy),o=r.next_out,s=r.output,c=r.avail_out,i=r.next_in,n=r.input,a=r.avail_in,u=t.hold,l=t.bits,d=a,f=c,A=Fa;e:for(;;)switch(t.mode){case I2:if(t.wrap===0){t.mode=oy;break}for(;l<16;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(t.wrap&2&&u===35615){t.wbits===0&&(t.wbits=15),t.check=0,T[0]=u&255,T[1]=u>>>8&255,t.check=Bt(t.check,T,2,0),u=0,l=0,t.mode=L9;break}if(t.head&&(t.head.done=!1),!(t.wrap&1)||(((u&255)<<8)+(u>>8))%31){r.msg="incorrect header check",t.mode=rt;break}if((u&15)!==N9){r.msg="unknown compression method",t.mode=rt;break}if(u>>>=4,l-=4,_=(u&15)+8,t.wbits===0&&(t.wbits=_),_>15||_>t.wbits){r.msg="invalid window size",t.mode=rt;break}t.dmax=1<<t.wbits,t.flags=0,r.adler=t.check=1,t.mode=u&512?q9:li,u=0,l=0;break;case L9:for(;l<16;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(t.flags=u,(t.flags&255)!==N9){r.msg="unknown compression method",t.mode=rt;break}if(t.flags&57344){r.msg="unknown header flags set",t.mode=rt;break}t.head&&(t.head.text=u>>8&1),t.flags&512&&t.wrap&4&&(T[0]=u&255,T[1]=u>>>8&255,t.check=Bt(t.check,T,2,0)),u=0,l=0,t.mode=M9;case M9:for(;l<32;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.head&&(t.head.time=u),t.flags&512&&t.wrap&4&&(T[0]=u&255,T[1]=u>>>8&255,T[2]=u>>>16&255,T[3]=u>>>24&255,t.check=Bt(t.check,T,4,0)),u=0,l=0,t.mode=U9;case U9:for(;l<16;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.head&&(t.head.xflags=u&255,t.head.os=u>>8),t.flags&512&&t.wrap&4&&(T[0]=u&255,T[1]=u>>>8&255,t.check=Bt(t.check,T,2,0)),u=0,l=0,t.mode=B9;case B9:if(t.flags&1024){for(;l<16;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.length=u,t.head&&(t.head.extra_len=u),t.flags&512&&t.wrap&4&&(T[0]=u&255,T[1]=u>>>8&255,t.check=Bt(t.check,T,2,0)),u=0,l=0}else t.head&&(t.head.extra=null);t.mode=z9;case z9:if(t.flags&1024&&(g=t.length,g>a&&(g=a),g&&(t.head&&(_=t.head.extra_len-t.length,t.head.extra||(t.head.extra=new Uint8Array(t.head.extra_len)),t.head.extra.set(n.subarray(i,i+g),_)),t.flags&512&&t.wrap&4&&(t.check=Bt(t.check,n,g,i)),a-=g,i+=g,t.length-=g),t.length))break e;t.length=0,t.mode=F9;case F9:if(t.flags&2048){if(a===0)break e;g=0;do _=n[i+g++],t.head&&_&&t.length<65536&&(t.head.name+=String.fromCharCode(_));while(_&&g<a);if(t.flags&512&&t.wrap&4&&(t.check=Bt(t.check,n,g,i)),a-=g,i+=g,_)break e}else t.head&&(t.head.name=null);t.length=0,t.mode=V9;case V9:if(t.flags&4096){if(a===0)break e;g=0;do _=n[i+g++],t.head&&_&&t.length<65536&&(t.head.comment+=String.fromCharCode(_));while(_&&g<a);if(t.flags&512&&t.wrap&4&&(t.check=Bt(t.check,n,g,i)),a-=g,i+=g,_)break e}else t.head&&(t.head.comment=null);t.mode=j9;case j9:if(t.flags&512){for(;l<16;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(t.wrap&4&&u!==(t.check&65535)){r.msg="header crc mismatch",t.mode=rt;break}u=0,l=0}t.head&&(t.head.hcrc=t.flags>>9&1,t.head.done=!0),r.adler=t.check=0,t.mode=li;break;case q9:for(;l<32;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}r.adler=t.check=nv(u),u=0,l=0,t.mode=h1;case h1:if(t.havedict===0)return r.next_out=o,r.avail_out=c,r.next_in=i,r.avail_in=a,t.hold=u,t.bits=l,Sce;r.adler=t.check=1,t.mode=li;case li:if(e===vce||e===Ef)break e;case oy:if(t.last){u>>>=l&7,l-=l&7,t.mode=cy;break}for(;l<3;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}switch(t.last=u&1,u>>>=1,l-=1,u&3){case 0:t.mode=K9;break;case 1:if(Dce(t),t.mode=vf,e===Ef){u>>>=2,l-=2;break e}break;case 2:t.mode=H9;break;case 3:r.msg="invalid block type",t.mode=rt}u>>>=2,l-=2;break;case K9:for(u>>>=l&7,l-=l&7;l<32;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if((u&65535)!==(u>>>16^65535)){r.msg="invalid stored block lengths",t.mode=rt;break}if(t.length=u&65535,u=0,l=0,t.mode=ay,e===Ef)break e;case ay:t.mode=G9;case G9:if(g=t.length,g){if(g>a&&(g=a),g>c&&(g=c),g===0)break e;s.set(n.subarray(i,i+g),o),a-=g,i+=g,c-=g,o+=g,t.length-=g;break}t.mode=li;break;case H9:for(;l<14;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(t.nlen=(u&31)+257,u>>>=5,l-=5,t.ndist=(u&31)+1,u>>>=5,l-=5,t.ncode=(u&15)+4,u>>>=4,l-=4,t.nlen>286||t.ndist>30){r.msg="too many length or distance symbols",t.mode=rt;break}t.have=0,t.mode=W9;case W9:for(;t.have<t.ncode;){for(;l<3;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.lens[Y[t.have++]]=u&7,u>>>=3,l-=3}for(;t.have<19;)t.lens[Y[t.have++]]=0;if(t.lencode=t.lendyn,t.lenbits=7,P={bits:t.lenbits},A=wd(Ece,t.lens,0,19,t.lencode,0,t.work,P),t.lenbits=P.bits,A){r.msg="invalid code lengths set",t.mode=rt;break}t.have=0,t.mode=Q9;case Q9:for(;t.have<t.nlen+t.ndist;){for(;w=t.lencode[u&(1<<t.lenbits)-1],y=w>>>24,E=w>>>16&255,m=w&65535,!(y<=l);){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(m<16)u>>>=y,l-=y,t.lens[t.have++]=m;else{if(m===16){for(V=y+2;l<V;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(u>>>=y,l-=y,t.have===0){r.msg="invalid bit length repeat",t.mode=rt;break}_=t.lens[t.have-1],g=3+(u&3),u>>>=2,l-=2}else if(m===17){for(V=y+3;l<V;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}u>>>=y,l-=y,_=0,g=3+(u&7),u>>>=3,l-=3}else{for(V=y+7;l<V;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}u>>>=y,l-=y,_=0,g=11+(u&127),u>>>=7,l-=7}if(t.have+g>t.nlen+t.ndist){r.msg="invalid bit length repeat",t.mode=rt;break}for(;g--;)t.lens[t.have++]=_}}if(t.mode===rt)break;if(t.lens[256]===0){r.msg="invalid code -- missing end-of-block",t.mode=rt;break}if(t.lenbits=9,P={bits:t.lenbits},A=wd(bD,t.lens,0,t.nlen,t.lencode,0,t.work,P),t.lenbits=P.bits,A){r.msg="invalid literal/lengths set",t.mode=rt;break}if(t.distbits=6,t.distcode=t.distdyn,P={bits:t.distbits},A=wd(mD,t.lens,t.nlen,t.ndist,t.distcode,0,t.work,P),t.distbits=P.bits,A){r.msg="invalid distances set",t.mode=rt;break}if(t.mode=vf,e===Ef)break e;case vf:t.mode=_f;case _f:if(a>=6&&c>=258){r.next_out=o,r.avail_out=c,r.next_in=i,r.avail_in=a,t.hold=u,t.bits=l,pce(r,f),o=r.next_out,s=r.output,c=r.avail_out,i=r.next_in,n=r.input,a=r.avail_in,u=t.hold,l=t.bits,t.mode===li&&(t.back=-1);break}for(t.back=0;w=t.lencode[u&(1<<t.lenbits)-1],y=w>>>24,E=w>>>16&255,m=w&65535,!(y<=l);){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(E&&!(E&240)){for(b=y,v=E,S=m;w=t.lencode[S+((u&(1<<b+v)-1)>>b)],y=w>>>24,E=w>>>16&255,m=w&65535,!(b+y<=l);){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}u>>>=b,l-=b,t.back+=b}if(u>>>=y,l-=y,t.back+=y,t.length=m,E===0){t.mode=ev;break}if(E&32){t.back=-1,t.mode=li;break}if(E&64){r.msg="invalid literal/length code",t.mode=rt;break}t.extra=E&15,t.mode=Y9;case Y9:if(t.extra){for(V=t.extra;l<V;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.length+=u&(1<<t.extra)-1,u>>>=t.extra,l-=t.extra,t.back+=t.extra}t.was=t.length,t.mode=X9;case X9:for(;w=t.distcode[u&(1<<t.distbits)-1],y=w>>>24,E=w>>>16&255,m=w&65535,!(y<=l);){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(!(E&240)){for(b=y,v=E,S=m;w=t.distcode[S+((u&(1<<b+v)-1)>>b)],y=w>>>24,E=w>>>16&255,m=w&65535,!(b+y<=l);){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}u>>>=b,l-=b,t.back+=b}if(u>>>=y,l-=y,t.back+=y,E&64){r.msg="invalid distance code",t.mode=rt;break}t.offset=m,t.extra=E&15,t.mode=J9;case J9:if(t.extra){for(V=t.extra;l<V;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}t.offset+=u&(1<<t.extra)-1,u>>>=t.extra,l-=t.extra,t.back+=t.extra}if(t.offset>t.dmax){r.msg="invalid distance too far back",t.mode=rt;break}t.mode=Z9;case Z9:if(c===0)break e;if(g=f-c,t.offset>g){if(g=t.offset-g,g>t.whave&&t.sane){r.msg="invalid distance too far back",t.mode=rt;break}g>t.wnext?(g-=t.wnext,h=t.wsize-g):h=t.wnext-g,g>t.length&&(g=t.length),p=t.window}else p=s,h=o-t.offset,g=t.length;g>c&&(g=c),c-=g,t.length-=g;do s[o++]=p[h++];while(--g);t.length===0&&(t.mode=_f);break;case ev:if(c===0)break e;s[o++]=t.length,c--,t.mode=_f;break;case cy:if(t.wrap){for(;l<32;){if(a===0)break e;a--,u|=n[i++]<<l,l+=8}if(f-=c,r.total_out+=f,t.total+=f,t.wrap&4&&f&&(r.adler=t.check=t.flags?Bt(t.check,s,f,o-f):Fd(t.check,s,f,o-f)),f=c,t.wrap&4&&(t.flags?u:nv(u))!==t.check){r.msg="incorrect data check",t.mode=rt;break}u=0,l=0}t.mode=tv;case tv:if(t.wrap&&t.flags){for(;l<32;){if(a===0)break e;a--,u+=n[i++]<<l,l+=8}if(t.wrap&4&&u!==(t.total&4294967295)){r.msg="incorrect length check",t.mode=rt;break}u=0,l=0}t.mode=rv;case rv:A=_ce;break e;case rt:A=ED;break e;case _D:return vD;case SD:default:return Xn}return r.next_out=o,r.avail_out=c,r.next_in=i,r.avail_in=a,t.hold=u,t.bits=l,(t.wsize||f!==r.avail_out&&t.mode<rt&&(t.mode<cy||e!==k9))&&ID(r,r.output,r.next_out,f-r.avail_out),d-=r.avail_in,f-=r.avail_out,r.total_in+=d,r.total_out+=f,t.total+=f,t.wrap&4&&f&&(r.adler=t.check=t.flags?Bt(t.check,s,f,r.next_out-f):Fd(t.check,s,f,r.next_out-f)),r.data_type=t.bits+(t.last?64:0)+(t.mode===li?128:0)+(t.mode===vf||t.mode===ay?256:0),(d===0&&f===0||e===k9)&&A===Fa&&(A=Ace),A},Pce=r=>{if(tc(r))return Xn;let e=r.state;return e.window&&(e.window=null),r.state=null,Fa},kce=(r,e)=>{if(tc(r))return Xn;const t=r.state;return t.wrap&2?(t.head=e,e.done=!1,Fa):Xn},Nce=(r,e)=>{const t=e.length;let n,s,i;return tc(r)||(n=r.state,n.wrap!==0&&n.mode!==h1)?Xn:n.mode===h1&&(s=1,s=Fd(s,e,t,0),s!==n.check)?ED:(i=ID(r,e,t,t),i?(n.mode=_D,vD):(n.havedict=1,Fa))};var Lce=$D,Mce=RD,Uce=AD,Bce=xce,zce=TD,Fce=Oce,Vce=Pce,jce=kce,qce=Nce,Kce="pako inflate (from Nodeca project)",vi={inflateReset:Lce,inflateReset2:Mce,inflateResetKeep:Uce,inflateInit:Bce,inflateInit2:zce,inflate:Fce,inflateEnd:Vce,inflateGetHeader:jce,inflateSetDictionary:qce,inflateInfo:Kce};function Gce(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var Hce=Gce;const CD=Object.prototype.toString,{Z_NO_FLUSH:Wce,Z_FINISH:Qce,Z_OK:qd,Z_STREAM_END:dy,Z_NEED_DICT:hy,Z_STREAM_ERROR:Yce,Z_DATA_ERROR:iv,Z_MEM_ERROR:Xce}=ec;function Ph(r){this.options=T2.assign({chunkSize:1024*64,windowBits:15,to:""},r||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),e.windowBits>=0&&e.windowBits<16&&!(r&&r.windowBits)&&(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(e.windowBits&15||(e.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new yD,this.strm.avail_out=0;let t=vi.inflateInit2(this.strm,e.windowBits);if(t!==qd)throw new Error(Ba[t]);if(this.header=new Hce,vi.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=jd.string2buf(e.dictionary):CD.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(t=vi.inflateSetDictionary(this.strm,e.dictionary),t!==qd)))throw new Error(Ba[t])}Ph.prototype.push=function(r,e){const t=this.strm,n=this.options.chunkSize,s=this.options.dictionary;let i,o,a;if(this.ended)return!1;for(e===~~e?o=e:o=e===!0?Qce:Wce,CD.call(r)==="[object ArrayBuffer]"?t.input=new Uint8Array(r):t.input=r,t.next_in=0,t.avail_in=t.input.length;;){for(t.avail_out===0&&(t.output=new Uint8Array(n),t.next_out=0,t.avail_out=n),i=vi.inflate(t,o),i===hy&&s&&(i=vi.inflateSetDictionary(t,s),i===qd?i=vi.inflate(t,o):i===iv&&(i=hy));t.avail_in>0&&i===dy&&t.state.wrap>0&&r[t.next_in]!==0;)vi.inflateReset(t),i=vi.inflate(t,o);switch(i){case Yce:case iv:case hy:case Xce:return this.onEnd(i),this.ended=!0,!1}if(a=t.avail_out,t.next_out&&(t.avail_out===0||i===dy))if(this.options.to==="string"){let c=jd.utf8border(t.output,t.next_out),u=t.next_out-c,l=jd.buf2string(t.output,c);t.next_out=u,t.avail_out=n-u,u&&t.output.set(t.output.subarray(c,c+u),0),this.onData(l)}else this.onData(t.output.length===t.next_out?t.output:t.output.subarray(0,t.next_out));if(!(i===qd&&a===0)){if(i===dy)return i=vi.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,!0;if(t.avail_in===0)break}}return!0};Ph.prototype.onData=function(r){this.chunks.push(r)};Ph.prototype.onEnd=function(r){r===qd&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=T2.flattenChunks(this.chunks)),this.chunks=[],this.err=r,this.msg=this.strm.msg};function b4(r,e){const t=new Ph(e);if(t.push(r),t.err)throw t.msg||Ba[t.err];return t.result}function Jce(r,e){return e=e||{},e.raw=!0,b4(r,e)}var Zce=Ph,ele=b4,tle=Jce,rle=b4,nle=ec,sle={Inflate:Zce,inflate:ele,inflateRaw:tle,ungzip:rle,constants:nle};const{Deflate:ile,deflate:ole,deflateRaw:ale,gzip:cle}=hce,{Inflate:lle,inflate:ule,inflateRaw:dle,ungzip:hle}=sle;var fle=ile,ple=ole,gle=ale,yle=cle,wle=lle,ble=ule,mle=dle,Ele=hle,vle=ec,ov={Deflate:fle,deflate:ple,deflateRaw:gle,gzip:yle,Inflate:wle,inflate:ble,inflateRaw:mle,ungzip:Ele,constants:vle};const av=6;function _le({repo:r,preload:e}){async function*t(n,s={}){if(s.compressionLevel!=null&&(s.compressionLevel<-1||s.compressionLevel>9))throw $(new Error("Compression level must be between -1 and 9"),"ERR_INVALID_PARAMS");if(s.preload!==!1){let a;try{a=km(n).split("/")}catch(c){throw $(c,"ERR_INVALID_PATH")}e(ne.parse(a[0]))}const i=ne.asCID(n)||n,o=await Bi(i,r.blocks,s);if(o.type==="file"||o.type==="raw"){const a=[];!s.compress||s.archive===!0?a.push([{header:{name:o.path,mode:o.type==="file"&&o.unixfs.mode,mtime:o.type==="file"&&o.unixfs.mtime?new Date(o.unixfs.mtime.secs*1e3):void 0,size:o.size,type:"file"},body:o.content()}],m9()):a.push(o.content),s.compress&&a.push(async function*(c){const u=await _w(c);yield ov.gzip(u,{level:s.compressionLevel||av})}),yield*Ae(...a);return}if(o.type==="directory"){const a=[Hx(i,r.blocks,s),async function*(c){for await(const u of c){const l={header:{name:u.path,size:u.size}};if(u.type==="file")l.header.type="file",l.header.mode=u.unixfs.mode!=null?u.unixfs.mode:void 0,l.header.mtime=u.unixfs.mtime?new Date(u.unixfs.mtime.secs*1e3):void 0,l.body=u.content();else if(u.type==="raw")l.header.type="file",l.body=u.content();else if(u.type==="directory")l.header.type="directory",l.header.mode=u.unixfs.mode!=null?u.unixfs.mode:void 0,l.header.mtime=u.unixfs.mtime?new Date(u.unixfs.mtime.secs*1e3):void 0;else throw $(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS");yield l}},m9()];if(s.compress){if(!s.archive)throw $(new Error("file is not regular"),"ERR_INVALID_PATH");s.compress&&a.push(async function*(c){const u=await _w(c);yield ov.gzip(u,{level:s.compressionLevel||av})})}yield*Ae(...a);return}throw $(new Error("Not a UnixFS node"),"ERR_NOT_UNIXFS")}return F(t)}function Sle({repo:r,preload:e}){async function*t(n,s={}){const i=km(n),o=i.split("/");s.preload!==!1&&e(ne.parse(o[0]));const a=ne.asCID(i)||i,c=await Bi(a,r.blocks,s);if(c.type==="file"){yield tE(c);return}if(c.type==="directory"){for await(const u of c.content())yield tE(u);return}throw $(new Error(`Unknown UnixFS type ${c.type}`),"ERR_UNKNOWN_UNIXFS_TYPE")}return F(t)}class Ale{constructor({preload:e,repo:t,hashers:n,options:s}){const i=Jse({preload:e,repo:t,options:s,hashers:n});this.addAll=i,this.add=_re({addAll:i}),this.cat=eoe({repo:t,preload:e}),this.get=_le({repo:t,preload:e}),this.ls=Sle({repo:t,preload:e})}}const f1="0.18.1",$le="",Rle="^0.158.1";function Tle({repo:r}){async function e(t={}){const n=await r.version.get();return{version:f1,commit:$le,repo:`${n}`,"ipfs-core":f1,"interface-ipfs-core":Rle}}return F(e)}const Ile=N("ipfs:components:id");function Cle({peerId:r,network:e}){async function t(n={}){const s=e.try();if(!s){if(n.peerId)throw new ph;if(r.publicKey==null)throw $(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");return{id:r,publicKey:C(r.publicKey,"base64pad"),addresses:[],agentVersion:`js-ipfs/${f1}`,protocolVersion:"9000",protocols:[]}}const{libp2p:i}=s,o=n.peerId?n.peerId:r,a=await xle(o,i,n),c=C(a.metadata.get("AgentVersion")||new Uint8Array),u=C(a.metadata.get("ProtocolVersion")||new Uint8Array),l=a.id.toString(),d=a.publicKey?C(a.publicKey,"base64pad"):"";return{id:o,publicKey:d,addresses:(a.addresses||[]).map(f=>{const g=f.toString();return g.endsWith(`/p2p/${l}`)?g:`${g}/p2p/${l}`}).sort().map(f=>xl(f)),agentVersion:c,protocolVersion:u,protocols:(a.protocols||[]).sort()}}return F(t)}async function xle(r,e,t){let n=await e.peerStore.get(r);n||(n=await Dle(r,e,t));let s=r.publicKey?r.publicKey:await e.peerStore.keyBook.get(r);if(s==null)try{s=await e.getPublicKey(r,t)}catch(i){Ile.error("Could not load public key for",r.toString(),i)}return{...n,publicKey:s,metadata:n.metadata||new Map,addresses:n.addresses.map(i=>i.multiaddr)}}async function Dle(r,e,t){if(e.dht==null)throw $(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");for await(const s of e.dht.findPeer(r,t))if(s.name==="FINAL_PEER")break;const n=await e.peerStore.get(r);if(!n)throw $(new Error("Could not find peer"),"ERR_NOT_FOUND");return n}var wt=Ole;function Ole(r,e,t){var n,s;if(Array.isArray(e)&&(n=e.slice(0)),typeof e=="string"&&(n=e.split(".")),typeof e=="symbol"&&(n=[e]),!Array.isArray(n))throw new Error("props arg must be an array, a string or a symbol");if(s=n.pop(),!s)return!1;cv(s);for(var i;i=n.shift();)if(cv(i),typeof r[i]>"u"&&(r[i]={}),r=r[i],!r||typeof r!="object")return!1;return r[s]=t,!0}function cv(r){if(r=="__proto__"||r=="constructor"||r=="prototype")throw new Error("setting of prototype values not supported")}const p1={server:{description:"Recommended for nodes with public IPv4 address (servers, VPSes, etc.), disables host and content discovery and UPnP in local networks.",transform:r=>(wt(r,"Discovery.MDNS.Enabled",!1),wt(r,"Discovery.webRTCStar.Enabled",!1),r.Swarm={...r.Swarm||{},DisableNatPortMap:!0},r)},"local-discovery":{description:"Sets default values to fields affected by `server` profile, enables discovery and UPnP in local networks.",transform:r=>(wt(r,"Discovery.MDNS.Enabled",!0),wt(r,"Discovery.webRTCStar.Enabled",!0),wt(r,"Swarm",{...r.Swarm||{},DisableNatPortMap:!1}),r)},test:{description:"Reduces external interference, useful for running ipfs in test environments. Note that with these settings node won't be able to talk to the rest of the network without manual bootstrap.",transform:r=>{const e=qc();return wt(r,"Addresses.API",e.Addresses.API?"/ip4/127.0.0.1/tcp/0":""),wt(r,"Addresses.Gateway",e.Addresses.Gateway?"/ip4/127.0.0.1/tcp/0":""),wt(r,"Addresses.Swarm",e.Addresses.Swarm.length?["/ip4/127.0.0.1/tcp/0"]:[]),wt(r,"Addresses.Delegates",[]),wt(r,"Bootstrap",[]),wt(r,"Discovery.MDNS.Enabled",!1),wt(r,"Discovery.webRTCStar.Enabled",!1),wt(r,"Swarm",{...r.Swarm||{},DisableNatPortMap:!0}),r}},"default-networking":{description:"Restores default network settings. Inverse profile of the `test` profile.",transform:r=>{const e=qc();return wt(r,"Addresses.API",e.Addresses.API),wt(r,"Addresses.Gateway",e.Addresses.Gateway),wt(r,"Addresses.Swarm",e.Addresses.Swarm),wt(r,"Addresses.Delegates",e.Addresses.Delegates),wt(r,"Bootstrap",e.Bootstrap),wt(r,"Discovery.MDNS.Enabled",e.Discovery.MDNS.Enabled),wt(r,"Discovery.webRTCStar.Enabled",e.Discovery.webRTCStar.Enabled),wt(r,"Swarm",{...r.Swarm||{},DisableNatPortMap:!1}),r}},lowpower:{description:"Reduces daemon overhead on the system. May affect node functionality,performance of content discovery and data fetching may be degraded. Recommended for low power systems.",transform:r=>{const e=r.Swarm||{},t=e.ConnMgr||{};return t.LowWater=20,t.HighWater=40,e.ConnMgr=t,r.Swarm=e,r}},"default-power":{description:'Inverse of "lowpower" profile.',transform:r=>{const e=qc();return r.Swarm=e.Swarm,r}}},Ple=N("ipfs:core:config");function kle({repo:r}){return{getAll:F(e),get:F(t),set:F(n),replace:F(s),profiles:{apply:F(i),list:F(Nle)}};async function e(o={}){return r.config.getAll(o)}async function t(o,a){return o?r.config.get(o,a):Promise.reject(new Error("key argument is required"))}async function n(o,a,c){return r.config.set(o,a,c)}async function s(o,a){return r.config.replace(o,a)}async function i(o,a={dryRun:!1}){const{dryRun:c}=a,u=p1[o];if(!u)throw new Error(`No profile with name '${o}' exists`);try{const l=await r.config.getAll(a);let d=JSON.parse(JSON.stringify(l));return d=u.transform(d),c||await r.config.replace(d,a),delete l.Identity.PrivKey,delete d.Identity.PrivKey,{original:l,updated:d}}catch(l){throw Ple(l),new Error(`Could not apply profile '${o}' to config: ${l.message}`)}}}async function Nle(r){return Object.keys(p1).map(e=>({name:e,description:p1[e].description}))}function Sf({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*Lle(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t],i=ne.asCID(n);i?yield[s.join("/"),i]:typeof n=="object"&&(yield*jb(n,s))}else{const t=ne.asCID(e);t?yield[r.join("/"),t]:yield*jb(e,r)}}function*jb(r,e){if(r==null||r instanceof Uint8Array)return;const t=ne.asCID(r);t&&(yield[e.join("/"),t]);for(const[n,s]of Object.entries(r)){const i=[...e,n];yield*Lle(i,s)}}function*Mle(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t];yield s.join("/"),typeof n=="object"&&!ne.asCID(n)&&(yield*qb(n,s))}else yield*qb(e,r)}function*qb(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield s.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&!ne.asCID(n)&&(yield*Mle(s,n))}}function Ule(r,e){let t=r;for(const[n,s]of e.entries()){if(t=t[s],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const i=ne.asCID(t);if(i)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}let Ble=class{constructor({cid:e,bytes:t,value:n}){if(!e||!t||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:Sf(),bytes:Sf(),value:Sf(),asBlock:Sf()})}links(){return jb(this.value,[])}tree(){return qb(this.value,[])}get(e="/"){return Ule(this.value,e.split("/").filter(Boolean))}};function zle({bytes:r,cid:e,value:t,codec:n}){const s=t!==void 0?t:n&&n.decode(r);if(s===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new Ble({cid:e,bytes:r,value:s})}var Fle=xD,lv=128,Vle=127,jle=~Vle,qle=Math.pow(2,31);function xD(r,e,t){e=e||[],t=t||0;for(var n=t;r>=qle;)e[t++]=r&255|lv,r/=128;for(;r&jle;)e[t++]=r&255|lv,r>>>=7;return e[t]=r|0,xD.bytes=t-n+1,e}var Kle=Kb,Gle=128,uv=127;function Kb(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Kb.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&uv)<<s:(o&uv)*Math.pow(2,s),s+=7}while(o>=Gle);return Kb.bytes=i-n,t}var Hle=Math.pow(2,7),Wle=Math.pow(2,14),Qle=Math.pow(2,21),Yle=Math.pow(2,28),Xle=Math.pow(2,35),Jle=Math.pow(2,42),Zle=Math.pow(2,49),eue=Math.pow(2,56),tue=Math.pow(2,63),rue=function(r){return r<Hle?1:r<Wle?2:r<Qle?3:r<Yle?4:r<Xle?5:r<Jle?6:r<Zle?7:r<eue?8:r<tue?9:10},nue={encode:Fle,decode:Kle,encodingLength:rue},g1=nue;const Gb=(r,e=0)=>[g1.decode(r,e),g1.decode.bytes],y1=(r,e,t=0)=>(g1.encode(r,e,t),e),w1=r=>g1.encodingLength(r),sue=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},m4=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},iue=(r,e)=>{const t=e.byteLength,n=w1(r),s=n+w1(t),i=new Uint8Array(s+t);return y1(r,i,0),y1(t,i,n),i.set(e,s),new E4(r,t,e,i)},Hb=r=>{const e=m4(r),[t,n]=Gb(e),[s,i]=Gb(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new E4(t,s,o,e)},oue=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&sue(r.bytes,t.bytes)}};let E4=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function aue(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var cue=aue,lue=cue;let uue=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},due=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return DD(this,e)}},hue=class{constructor(e){this.decoders=e}or(e){return DD(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const DD=(r,e)=>new hue({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let fue=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new uue(e,t,n),this.decoder=new due(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const OD=({name:r,prefix:e,encode:t,decode:n})=>new fue(r,e,t,n),PD=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=lue(t,e);return OD({prefix:r,name:e,encode:n,decode:i=>m4(s(i))})},pue=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},gue=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},zi=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>OD({prefix:e,name:r,encode(s){return gue(s,n,t)},decode(s){return pue(s,n,t,r)}}),oo=PD({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});PD({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const dp=zi({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});zi({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});zi({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});zi({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});zi({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});zi({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});zi({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});zi({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});zi({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const dv=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return wue(t,Wb(r),e||oo.encoder);default:return bue(t,Wb(r),e||dp.encoder)}},hv=new WeakMap,Wb=r=>{const e=hv.get(r);if(e==null){const t=new Map;return hv.set(r,t),t}return e};let Kd=class Er{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==cu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==mue)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Er.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=iue(e,t);return Er.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Er.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&oue(e.multihash,n.multihash)}toString(e){return dv(this,e)}toJSON(){return{"/":dv(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Er)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Er(n,s,i,o||fv(n,s,i.bytes))}else if(t[Eue]===!0){const{version:n,multihash:s,code:i}=t,o=Hb(s);return Er.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==cu)throw new Error(`Version 0 CID must use dag-pb (code: ${cu}) block encoding`);return new Er(e,t,n,n.bytes)}case 1:{const s=fv(e,t,n.bytes);return new Er(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Er.create(0,cu,e)}static createV1(e,t){return Er.create(1,e,t)}static decode(e){const[t,n]=Er.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Er.inspectBytes(e),n=t.size-t.multihashSize,s=m4(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new E4(t.multihashCode,t.digestSize,i,s);return[t.version===0?Er.createV0(o):Er.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Gb(e.subarray(t));return t+=f,d};let s=n(),i=cu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=yue(e,t),i=Er.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Wb(i).set(n,e),i}};const yue=(r,e)=>{switch(r[0]){case"Q":{const t=e||oo;return[oo.prefix,t.decode(`${oo.prefix}${r}`)]}case oo.prefix:{const t=e||oo;return[oo.prefix,t.decode(r)]}case dp.prefix:{const t=e||dp;return[dp.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},wue=(r,e,t)=>{const{prefix:n}=t;if(n!==oo.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},bue=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},cu=112,mue=18,fv=(r,e,t)=>{const n=w1(r),s=n+w1(e),i=new Uint8Array(s+t.byteLength);return y1(r,i,0),y1(e,i,n),i.set(t,s),i},Eue=Symbol.for("@ipld/js-cid/CID");function kD(r){const e=mT({version:1,roots:r}),t=D.encode(e.length),n=new Uint8Array(t.length+e.length);return n.set(t,0),n.set(e,t.length),n}function vue(r){return{async setRoots(e){const t=kD(e);await r.write(t)},async writeBlock(e){const{cid:t,bytes:n}=e;await r.write(new Uint8Array(D.encode(t.bytes.length+n.length))),await r.write(t.bytes),n.length&&await r.write(n)},async close(){await r.end()}}}function Af(){}function _ue(){const r=[];let e=null,t=Af,n=!1,s=null,i=Af;const o=()=>(e||(e=new Promise(u=>{t=()=>{e=null,t=Af,u()}})),e),a={write(u){r.push(u);const l=o();return i(),l},async end(){n=!0;const u=o();i(),await u}},c={async next(){const u=r.shift();return u?(r.length===0&&t(),{done:!1,value:u}):n?(t(),{done:!0,value:void 0}):(s||(s=new Promise(l=>{i=()=>(s=null,i=Af,l(c.next()))})),s)}};return{writer:a,iterator:c}}const vo={Null:r=>r===null,Int:r=>Number.isInteger(r),Float:r=>typeof r=="number"&&Number.isFinite(r),String:r=>typeof r=="string",Bool:r=>typeof r=="boolean",Bytes:r=>r instanceof Uint8Array,Link:r=>!vo.Null(r)&&typeof r=="object"&&r.asCID===r,List:r=>Array.isArray(r),Map:r=>!vo.Null(r)&&typeof r=="object"&&r.asCID!==r&&!vo.List(r)&&!vo.Bytes(r)},Tc={Int:vo.Int,"CarHeader > version":r=>Tc.Int(r),"CarHeader > roots (anon) > valueType (anon)":vo.Link,"CarHeader > roots (anon)":r=>vo.List(r)&&Array.prototype.every.call(r,Tc["CarHeader > roots (anon) > valueType (anon)"]),"CarHeader > roots":r=>Tc["CarHeader > roots (anon)"](r),CarHeader:r=>{const e=r&&Object.keys(r);return vo.Map(r)&&["version"].every(t=>e.includes(t))&&Object.entries(r).every(([t,n])=>Tc["CarHeader > "+t]&&Tc["CarHeader > "+t](n))}},Sue=Tc.CarHeader,fy={SHA2_256:18,LENGTH:32,DAG_PB:112},Aue=16+8+8+8;function b1(r,e){if(!r.length)throw new Error("Unexpected end of data");const t=D.decode(r);return e.seek(D.decode.bytes),t}function $ue(r){const e=new DataView(r.buffer,r.byteOffset,r.byteLength);let t=0;return{version:2,characteristics:[e.getBigUint64(t,!0),e.getBigUint64(t+=8,!0)],dataOffset:Number(e.getBigUint64(t+=8,!0)),dataSize:Number(e.getBigUint64(t+=8,!0)),indexOffset:Number(e.getBigUint64(t+=8,!0))}}function Rue(r){D.decode(r);const e=D.decode.bytes,t=D.decode(r.subarray(D.decode.bytes)),n=D.decode.bytes;return e+n+t}async function v4(r,e){const t=b1(await r.upTo(8),r);if(t===0)throw new Error("Invalid CAR header (zero length)");const n=await r.exactly(t,!0),s=Z6(n);if(!Sue(s))throw new Error("Invalid CAR header format");if(s.version!==1&&s.version!==2||e!==void 0&&s.version!==e)throw new Error(`Invalid CAR version: ${s.version}${e!==void 0?` (expected ${e})`:""}`);const i=Array.isArray(s.roots);if(s.version===1&&!i||s.version===2&&i)throw new Error("Invalid CAR header format");if(s.version===1)return s;const o=$ue(await r.exactly(Aue,!0));r.seek(o.dataOffset-r.pos);const a=await v4(r,1);return Object.assign(a,o)}async function Tue(r){const e=await r.exactly(2,!1);if(e[0]===fy.SHA2_256&&e[1]===fy.LENGTH){const o=await r.exactly(34,!0),a=Hb(o);return Kd.create(0,fy.DAG_PB,a)}const t=b1(await r.upTo(8),r);if(t!==1)throw new Error(`Unexpected CID version (${t})`);const n=b1(await r.upTo(8),r),s=await r.exactly(Rue(await r.upTo(8)),!0),i=Hb(s);return Kd.create(t,n,i)}async function ND(r){const e=r.pos;let t=b1(await r.upTo(8),r);if(t===0)throw new Error("Invalid CAR section (zero length)");t+=r.pos-e;const n=await Tue(r),s=t-Number(r.pos-e);return{cid:n,length:t,blockLength:s}}async function Iue(r){const{cid:e,blockLength:t}=await ND(r);return{bytes:await r.exactly(t,!0),cid:e}}async function Cue(r){const e=r.pos,{cid:t,length:n,blockLength:s}=await ND(r),i={cid:t,length:n,blockLength:s,offset:e,blockOffset:r.pos};return r.seek(i.blockLength),i}function xue(r){const e=(async()=>{const t=await v4(r);if(t.version===2){const n=r.pos-t.dataOffset;r=Pue(r,t.dataSize-n)}return t})();return{header:()=>e,async*blocks(){for(await e;(await r.upTo(8)).length>0;)yield await Iue(r)},async*blocksIndex(){for(await e;(await r.upTo(8)).length>0;)yield await Cue(r)}}}function LD(r){let e=0;return{async upTo(t){return r.subarray(e,e+Math.min(t,r.length-e))},async exactly(t,n=!1){if(t>r.length-e)throw new Error("Unexpected end of data");const s=r.subarray(e,e+t);return n&&(e+=t),s},seek(t){e+=t},get pos(){return e}}}function Due(r){let e=0,t=0,n=0,s=new Uint8Array(0);const i=async o=>{t=s.length-n;const a=[s.subarray(n)];for(;t<o;){const u=await r();if(u==null)break;t<0?u.length>t&&a.push(u.subarray(-t)):a.push(u),t+=u.length}s=new Uint8Array(a.reduce((u,l)=>u+l.length,0));let c=0;for(const u of a)s.set(u,c),c+=u.length;n=0};return{async upTo(o){return s.length-n<o&&await i(o),s.subarray(n,n+Math.min(s.length-n,o))},async exactly(o,a=!1){if(s.length-n<o&&await i(o),s.length-n<o)throw new Error("Unexpected end of data");const c=s.subarray(n,n+o);return a&&(e+=o,n+=o),c},seek(o){e+=o,n+=o},get pos(){return e}}}function Oue(r){const e=r[Symbol.asyncIterator]();async function t(){const n=await e.next();return n.done?null:n.value}return Due(t)}function Pue(r,e){let t=0;return{async upTo(n){let s=await r.upTo(n);return s.length+t>e&&(s=s.subarray(0,e-t)),s},async exactly(n,s=!1){const i=await r.exactly(n,s);if(i.length+t>e)throw new Error("Unexpected end of data");return s&&(t+=n),i},seek(n){t+=n,r.seek(n)},get pos(){return r.pos}}}class m1{constructor(e,t){this._encoder=t,this._mutex=t.setRoots(e),this._ended=!1}async put(e){if(!(e.bytes instanceof Uint8Array)||!e.cid)throw new TypeError("Can only write {cid, bytes} objects");if(this._ended)throw new Error("Already closed");const t=Kd.asCID(e.cid);if(!t)throw new TypeError("Can only write {cid, bytes} objects");return this._mutex=this._mutex.then(()=>this._encoder.writeBlock({cid:t,bytes:e.bytes})),this._mutex}async close(){if(this._ended)throw new Error("Already closed");return await this._mutex,this._ended=!0,this._encoder.close()}static create(e){e=kue(e);const{encoder:t,iterator:n}=gv(),s=new m1(e,t),i=new pv(n);return{writer:s,out:i}}static createAppender(){const{encoder:e,iterator:t}=gv();e.setRoots=()=>Promise.resolve();const n=new m1([],e),s=new pv(t);return{writer:n,out:s}}static async updateRootsInBytes(e,t){const n=LD(e);await v4(n);const s=kD(t);if(Number(n.pos)!==s.length)throw new Error(`updateRoots() can only overwrite a header of the same length (old header is ${n.pos} bytes, new header is ${s.length} bytes)`);return e.set(s,0),e}}class pv{constructor(e){this._iterator=e}[Symbol.asyncIterator](){if(this._iterating)throw new Error("Multiple iterator not supported");return this._iterating=!0,this._iterator}}function gv(){const r=_ue(),{writer:e,iterator:t}=r;return{encoder:vue(e),iterator:t}}function kue(r){if(r===void 0)return[];if(!Array.isArray(r)){const t=Kd.asCID(r);if(!t)throw new TypeError("roots must be a single CID or an array of CIDs");return[t]}const e=[];for(const t of r){const n=Kd.asCID(t);if(!n)throw new TypeError("roots must be a single CID or an array of CIDs");e.push(n)}return e}const MD=async({cid:r,load:e,seen:t})=>{t=t||new Set;const n=r.toString(qr);if(t.has(n))return;const s=await e(r);if(t.add(n),s!==null)for(const[,i]of s.links())await MD({cid:i,load:e,seen:t})},UD=N("ipfs:components:dag:import"),Nue=[$m,xI];function Lue({repo:r,preload:e,codecs:t}){async function*n(s,i={}){i.preload!==!1&&e(s);const o=ne.asCID(s);if(!o)throw new Error(`Unexpected error converting CID type: ${s}`);UD(`Exporting ${o} as car`);const{writer:a,out:c}=await m1.create([o]);let u=null;(async()=>{try{const l=Mue(r,a,{signal:i.signal,timeout:i.timeout},t);await MD({cid:o,load:l})}catch(l){u=l}finally{a.close()}})();for await(const l of c){if(u)break;yield l}if(u)throw u}return F(n)}function Mue(r,e,t,n){return async s=>{const i=await n.getCodec(s.code);if(!i)throw new Error(`Can't decode links in block with codec 0x${s.code.toString(16)} to form complete DAG`);const o=await r.blocks.get(s,t);return UD(`Adding block ${s} to car`),await e.put({cid:s,bytes:o}),Nue.includes(s.code)?null:zle({bytes:o,cid:s,codec:i})}}async function xs(r){for await(const e of r)return e}function Uue({codecs:r,repo:e,preload:t}){return F(async function(i,o={}){if(o.preload!==!1&&t(i),o.path){const d=o.localResolve?await xs(Od(i,o.path,r,e,o)):await En(Od(i,o.path,r,e,o));if(!d)throw $(new Error("Not found"),"ERR_NOT_FOUND");return d}const a=await r.getCodec(i.code),c=await e.blocks.get(i,o);return{value:a.decode(c),remainderPath:""}})}class Bue{constructor(e,t,n){this._version=e,this._roots=t,this._iterable=n,this._decoded=!1}get version(){return this._version}async getRoots(){return this._roots}}class E1 extends Bue{[Symbol.asyncIterator](){if(this._decoded)throw new Error("Cannot decode more than once");if(!this._iterable)throw new Error("Block iterable not found");return this._decoded=!0,this._iterable[Symbol.asyncIterator]()}static async fromBytes(e){const{version:t,roots:n,iterator:s}=await zue(e);return new E1(t,n,s)}static async fromIterable(e){const{version:t,roots:n,iterator:s}=await Fue(e);return new E1(t,n,s)}}async function zue(r){if(!(r instanceof Uint8Array))throw new TypeError("fromBytes() requires a Uint8Array");return BD(LD(r))}async function Fue(r){if(!r||typeof r[Symbol.asyncIterator]!="function")throw new TypeError("fromIterable() requires an async iterable");return BD(Oue(r))}async function BD(r){const e=xue(r),{version:t,roots:n}=await e.header();return{version:t,roots:n,iterator:e.blocks()}}const zD=N("ipfs:components:dag:import");function Vue({repo:r}){async function*e(t,n={}){const s=await r.gcLock.readLock();try{const i={signal:n.signal,timeout:n.timeout},o=Th(t),{value:a,done:c}=await o.peek();if(c)return;a&&o.push(a);let u;a instanceof Uint8Array?u=[o]:u=o;for await(const l of u){const d=await jue(r,i,l);if(n.pinRoots!==!1)for(const f of d){let g="";try{await r.blocks.has(f)?(zD(`Pinning root ${f}`),await r.pins.pinRecursively(f)):g="blockstore: block not found"}catch(h){g=h.message}yield{root:{cid:f,pinErrorMsg:g}}}}}finally{s()}}return F(e)}async function jue(r,e,t){const n=await E1.fromIterable(t),s=await n.getRoots();return await Wt(r.blocks.putMany(Xr(n,({cid:i,bytes:o})=>(zD(`Import block ${i}`),{key:i,value:o})),{signal:e.signal})),s}function que({repo:r,codecs:e,hashers:t,preload:n}){async function s(i,o={}){const a=o.pin?await r.gcLock.readLock():null;try{const c=await e.getCodec(o.storeCodec||"dag-cbor");if(!c)throw new Error(`Unknown storeCodec ${o.storeCodec}, please configure additional BlockCodecs for this IPFS instance`);if(o.inputCodec){if(!(i instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");const h=await e.getCodec(o.inputCodec);if(!h)throw new Error(`Unknown inputCodec ${o.inputCodec}, please configure additional BlockCodecs for this IPFS instance`);i=h.decode(i)}const u=o.version!=null?o.version:1,l=await t.getHasher(o.hashAlg||"sha2-256");if(!l)throw new Error(`Unknown hash algorithm ${o.hashAlg}, please configure additional MultihashHashers for this IPFS instance`);const d=c.encode(i),f=await l.digest(d),g=ne.create(u,c.code,f);return await r.blocks.put(g,d,{signal:o.signal}),o.pin&&await r.pins.pinRecursively(g),o.preload!==!1&&n(g),g}finally{a&&a()}}return F(s)}function Kue({repo:r,codecs:e,preload:t}){async function n(s,i={}){const{cid:o}=bh(s);return i.preload!==!1&&t(o),h2(r,e,s,i)}return F(n)}class Gue{constructor({repo:e,codecs:t,hashers:n,preload:s}){this.export=Lue({repo:e,preload:s,codecs:t}),this.get=Uue({codecs:t,repo:e,preload:s}),this.import=Vue({repo:e}),this.resolve=Kue({repo:e,codecs:t,preload:s}),this.put=que({repo:e,codecs:t,hashers:n,preload:s})}}function Hue(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var Wue=Hue,Que=Wue;const Yue=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},_4=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Xue=r=>new TextEncoder().encode(r),Jue=r=>new TextDecoder().decode(r);let Zue=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},ede=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return FD(this,e)}},tde=class{constructor(e){this.decoders=e}or(e){return FD(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const FD=(r,e)=>new tde({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let rde=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Zue(e,t,n),this.decoder=new ede(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const C2=({name:r,prefix:e,encode:t,decode:n})=>new rde(r,e,t,n),kh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Que(t,e);return C2({prefix:r,name:e,encode:n,decode:i=>_4(s(i))})},nde=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},sde=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},tr=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>C2({prefix:e,name:r,encode(s){return sde(s,n,t)},decode(s){return nde(s,n,t,r)}}),ys=kh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),ide=kh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),ode=Object.freeze(Object.defineProperty({__proto__:null,base58btc:ys,base58flickr:ide},Symbol.toStringTag,{value:"Module"}));var ade=VD,yv=128,cde=127,lde=~cde,ude=Math.pow(2,31);function VD(r,e,t){e=e||[],t=t||0;for(var n=t;r>=ude;)e[t++]=r&255|yv,r/=128;for(;r&lde;)e[t++]=r&255|yv,r>>>=7;return e[t]=r|0,VD.bytes=t-n+1,e}var dde=Qb,hde=128,wv=127;function Qb(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw Qb.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&wv)<<s:(o&wv)*Math.pow(2,s),s+=7}while(o>=hde);return Qb.bytes=i-n,t}var fde=Math.pow(2,7),pde=Math.pow(2,14),gde=Math.pow(2,21),yde=Math.pow(2,28),wde=Math.pow(2,35),bde=Math.pow(2,42),mde=Math.pow(2,49),Ede=Math.pow(2,56),vde=Math.pow(2,63),_de=function(r){return r<fde?1:r<pde?2:r<gde?3:r<yde?4:r<wde?5:r<bde?6:r<mde?7:r<Ede?8:r<vde?9:10},Sde={encode:ade,decode:dde,encodingLength:_de},v1=Sde;const Yb=(r,e=0)=>[v1.decode(r,e),v1.decode.bytes],_1=(r,e,t=0)=>(v1.encode(r,e,t),e),S1=r=>v1.encodingLength(r),Ade=(r,e)=>{const t=e.byteLength,n=S1(r),s=n+S1(t),i=new Uint8Array(s+t);return _1(r,i,0),_1(t,i,n),i.set(e,s),new S4(r,t,e,i)},jD=r=>{const e=_4(r),[t,n]=Yb(e),[s,i]=Yb(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new S4(t,s,o,e)},$de=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Yue(r.bytes,t.bytes)}};let S4=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const Aa=tr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Rde=tr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Tde=tr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Ide=tr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Cde=tr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),xde=tr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Dde=tr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Ode=tr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Pde=tr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),kde=Object.freeze(Object.defineProperty({__proto__:null,base32:Aa,base32hex:Cde,base32hexpad:Dde,base32hexpadupper:Ode,base32hexupper:xde,base32pad:Tde,base32padupper:Ide,base32upper:Rde,base32z:Pde},Symbol.toStringTag,{value:"Module"})),bv=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Lde(t,Xb(r),e||ys.encoder);default:return Mde(t,Xb(r),e||Aa.encoder)}},mv=new WeakMap,Xb=r=>{const e=mv.get(r);if(e==null){const t=new Map;return mv.set(r,t),t}return e};let qD=class vr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==lu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Ude)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return vr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Ade(e,t);return vr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return vr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&$de(e.multihash,n.multihash)}toString(e){return bv(this,e)}toJSON(){return{"/":bv(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof vr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new vr(n,s,i,o||Ev(n,s,i.bytes))}else if(t[Bde]===!0){const{version:n,multihash:s,code:i}=t,o=jD(s);return vr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==lu)throw new Error(`Version 0 CID must use dag-pb (code: ${lu}) block encoding`);return new vr(e,t,n,n.bytes)}case 1:{const s=Ev(e,t,n.bytes);return new vr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return vr.create(0,lu,e)}static createV1(e,t){return vr.create(1,e,t)}static decode(e){const[t,n]=vr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=vr.inspectBytes(e),n=t.size-t.multihashSize,s=_4(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new S4(t.multihashCode,t.digestSize,i,s);return[t.version===0?vr.createV0(o):vr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=Yb(e.subarray(t));return t+=f,d};let s=n(),i=lu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=Nde(e,t),i=vr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Xb(i).set(n,e),i}};const Nde=(r,e)=>{switch(r[0]){case"Q":{const t=e||ys;return[ys.prefix,t.decode(`${ys.prefix}${r}`)]}case ys.prefix:{const t=e||ys;return[ys.prefix,t.decode(r)]}case Aa.prefix:{const t=e||Aa;return[Aa.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Lde=(r,e,t)=>{const{prefix:n}=t;if(n!==ys.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Mde=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},lu=112,Ude=18,Ev=(r,e,t)=>{const n=S1(r),s=n+S1(e),i=new Uint8Array(s+t.byteLength);return _1(r,i,0),_1(e,i,n),i.set(t,s),i},Bde=Symbol.for("@ipld/js-cid/CID"),zde=Math.pow(2,7),Fde=Math.pow(2,14),Vde=Math.pow(2,21),A4=Math.pow(2,28),$4=Math.pow(2,35),R4=Math.pow(2,42),T4=Math.pow(2,49),Me=128,Mr=127;function Ko(r){if(r<zde)return 1;if(r<Fde)return 2;if(r<Vde)return 3;if(r<A4)return 4;if(r<$4)return 5;if(r<R4)return 6;if(r<T4)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function jde(r,e,t=0){switch(Ko(r)){case 8:e[t++]=r&255|Me,r/=128;case 7:e[t++]=r&255|Me,r/=128;case 6:e[t++]=r&255|Me,r/=128;case 5:e[t++]=r&255|Me,r/=128;case 4:e[t++]=r&255|Me,r>>>=7;case 3:e[t++]=r&255|Me,r>>>=7;case 2:e[t++]=r&255|Me,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function qde(r,e,t=0){switch(Ko(r)){case 8:e.set(t++,r&255|Me),r/=128;case 7:e.set(t++,r&255|Me),r/=128;case 6:e.set(t++,r&255|Me),r/=128;case 5:e.set(t++,r&255|Me),r/=128;case 4:e.set(t++,r&255|Me),r>>>=7;case 3:e.set(t++,r&255|Me),r>>>=7;case 2:e.set(t++,r&255|Me),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function Kde(r,e){let t=r[e],n=0;if(n+=t&Mr,t<Me||(t=r[e+1],n+=(t&Mr)<<7,t<Me)||(t=r[e+2],n+=(t&Mr)<<14,t<Me)||(t=r[e+3],n+=(t&Mr)<<21,t<Me)||(t=r[e+4],n+=(t&Mr)*A4,t<Me)||(t=r[e+5],n+=(t&Mr)*$4,t<Me)||(t=r[e+6],n+=(t&Mr)*R4,t<Me)||(t=r[e+7],n+=(t&Mr)*T4,t<Me))return n;throw new RangeError("Could not decode varint")}function Gde(r,e){let t=r.get(e),n=0;if(n+=t&Mr,t<Me||(t=r.get(e+1),n+=(t&Mr)<<7,t<Me)||(t=r.get(e+2),n+=(t&Mr)<<14,t<Me)||(t=r.get(e+3),n+=(t&Mr)<<21,t<Me)||(t=r.get(e+4),n+=(t&Mr)*A4,t<Me)||(t=r.get(e+5),n+=(t&Mr)*$4,t<Me)||(t=r.get(e+6),n+=(t&Mr)*R4,t<Me)||(t=r.get(e+7),n+=(t&Mr)*T4,t<Me))return n;throw new RangeError("Could not decode varint")}function x2(r,e,t=0){return e==null&&(e=Ys(Ko(r))),e instanceof Uint8Array?jde(r,e,t):qde(r,e,t)}function Nh(r,e=0){return r instanceof Uint8Array?Kde(r,e):Gde(r,e)}const Hde=C2({prefix:"\0",name:"identity",encode:r=>Jue(r),decode:r=>Xue(r)}),Wde=Object.freeze(Object.defineProperty({__proto__:null,identity:Hde},Symbol.toStringTag,{value:"Module"})),Qde=tr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Yde=Object.freeze(Object.defineProperty({__proto__:null,base2:Qde},Symbol.toStringTag,{value:"Module"})),Xde=tr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Jde=Object.freeze(Object.defineProperty({__proto__:null,base8:Xde},Symbol.toStringTag,{value:"Module"})),Zde=kh({prefix:"9",name:"base10",alphabet:"0123456789"}),ehe=Object.freeze(Object.defineProperty({__proto__:null,base10:Zde},Symbol.toStringTag,{value:"Module"})),the=tr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),rhe=tr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),nhe=Object.freeze(Object.defineProperty({__proto__:null,base16:the,base16upper:rhe},Symbol.toStringTag,{value:"Module"})),she=kh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),ihe=kh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),ohe=Object.freeze(Object.defineProperty({__proto__:null,base36:she,base36upper:ihe},Symbol.toStringTag,{value:"Module"})),ahe=tr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),che=tr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),lhe=tr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),uhe=tr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),dhe=Object.freeze(Object.defineProperty({__proto__:null,base64:ahe,base64pad:che,base64url:lhe,base64urlpad:uhe},Symbol.toStringTag,{value:"Module"})),KD=Array.from(""),hhe=KD.reduce((r,e,t)=>(r[t]=e,r),[]),fhe=KD.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function phe(r){return r.reduce((e,t)=>(e+=hhe[t],e),"")}function ghe(r){const e=[];for(const t of r){const n=fhe[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const yhe=C2({prefix:"",name:"base256emoji",encode:phe,decode:ghe}),whe=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:yhe},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const bhe={...Wde,...Yde,...Jde,...ehe,...nhe,...kde,...ohe,...ode,...dhe,...whe},vv=es,mhe=ts,GD=function(r){let e=0;if(r=r.toString().trim(),vv(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(mhe(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=vv(t[n]);let o;i&&(o=GD(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},Ehe=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},In=-1,Gd={},Jb={},vhe=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,In,"ip6zone"],[43,8,"ipcidr"],[53,In,"dns",!0],[54,In,"dns4",!0],[55,In,"dns6",!0],[56,In,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,In,"unix",!1,!0],[421,In,"ipfs"],[421,In,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,In,"garlic64"],[448,0,"tls"],[449,In,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,In,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,In,"memory"]];vhe.forEach(r=>{const e=_he(...r);Jb[e.code]=e,Gd[e.name]=e});function _he(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function Ne(r){if(typeof r=="number"){if(Jb[r]!=null)return Jb[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(Gd[r]!=null)return Gd[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}Ne("ip4");Ne("ip6");Ne("ipcidr");function I4(r,e){switch(Ne(r).code){case 4:case 41:return Ahe(e);case 42:return $v(e);case 6:case 273:case 33:case 132:return HD(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return $v(e);case 421:return Ihe(e);case 444:return Rv(e);case 445:return Rv(e);case 466:return The(e);default:return C(e,"base16")}}function _v(r,e){switch(Ne(r).code){case 4:return Sv(e);case 41:return Sv(e);case 42:return Av(e);case 6:case 273:case 33:case 132:return C4(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return Av(e);case 421:return $he(e);case 444:return Che(e);case 445:return xhe(e);case 466:return Rhe(e);default:return L(e,"base16")}}const py=Object.values(bhe).map(r=>r.decoder),She=function(){let r=py[0].or(py[1]);return py.slice(2).forEach(e=>r=r.or(e)),r}();function Sv(r){if(!tt(r))throw new Error("invalid ip address");return GD(r)}function Ahe(r){const e=Ehe(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function C4(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function HD(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function Av(r){const e=L(r),t=Uint8Array.from(x2(e.length));return M([t,e],t.length+e.length)}function $v(r){const e=Nh(r);if(r=r.slice(Ko(e)),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function $he(r){let e;r[0]==="Q"||r[0]==="1"?e=jD(ys.decode(`z${r}`)).bytes:e=qD.parse(r).multihash.bytes;const t=Uint8Array.from(x2(e.length));return M([t,e],t.length+e.length)}function Rhe(r){const e=She.decode(r),t=Uint8Array.from(x2(e.length));return M([t,e],t.length+e.length)}function The(r){const e=Nh(r),t=r.slice(Ko(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function Ihe(r){const e=Nh(r),t=r.slice(Ko(e));if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function Che(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=Aa.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=C4(n);return M([t,s],t.length+s.length)}function xhe(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Aa.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=C4(n);return M([t,s],t.length+s.length)}function Rv(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=HD(t);return`${n}:${s}`}function Dhe(r){r=Zb(r);const e=[],t=[];let n=null;const s=r.split("/").slice(1);if(s.length===1&&s[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let i=0;i<s.length;i++){const o=s[i],a=Ne(o);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(i++,i>=s.length)throw YD("invalid address: "+r);if(a.path===!0){n=Zb(s.slice(i).join("/")),e.push([a.code,_v(a.code,n)]),t.push([a.code,n]);break}const c=_v(a.code,s[i]);e.push([a.code,c]),t.push([a.code,I4(a.code,c)])}return{string:WD(t),bytes:QD(e),tuples:e,stringTuples:t,path:n}}function Tv(r){const e=[],t=[];let n=null,s=0;for(;s<r.length;){const i=Nh(r,s),o=Ko(i),a=Ne(i),c=Ohe(a,r.slice(s+o));if(c===0){e.push([i]),t.push([i]),s+=o;continue}const u=r.slice(s+o,s+o+c);if(s+=c+o,s>r.length)throw YD("Invalid address Uint8Array: "+C(r,"base16"));e.push([i,u]);const l=I4(i,u);if(t.push([i,l]),a.path===!0){n=l;break}}return{bytes:Uint8Array.from(r),string:WD(t),tuples:e,stringTuples:t,path:n}}function WD(r){const e=[];return r.map(t=>{const n=Ne(t[0]);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),Zb(e.join("/"))}function QD(r){return M(r.map(e=>{const t=Ne(e[0]);let n=Uint8Array.from(x2(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n}))}function Ohe(r,e){if(r.size>0)return r.size/8;if(r.size===0)return 0;{const t=Nh(e instanceof Uint8Array?e:Uint8Array.from(e));return t+Ko(t)}}function Zb(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function YD(r){return new Error("Error parsing address: "+r)}const Phe=Symbol.for("nodejs.util.inspect.custom"),khe=[Ne("dns").code,Ne("dns4").code,Ne("dns6").code,Ne("dnsaddr").code],Nhe=new Map,XD=Symbol.for("@multiformats/js-multiaddr/multiaddr");function Cqe(r){return JD(r)?r.protos().some(e=>e.resolvable):!1}function JD(r){return!!r?.[XD]}var Xc,yo,rh,nh,hVe,$i;let Lhe=($i=class{constructor(e){k(this,"bytes");vt(this,Xc,void 0);vt(this,yo,void 0);vt(this,rh,void 0);vt(this,nh,void 0);k(this,hVe,!0);e==null&&(e="");let t;if(e instanceof Uint8Array)t=Tv(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=Dhe(e)}else if(JD(e))t=Tv(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,Xe(this,Xc,t.string),Xe(this,yo,t.tuples),Xe(this,rh,t.stringTuples),Xe(this,nh,t.path)}toString(){return ce(this,Xc)}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=Ne("tcp"),a=Ne("udp"),c=Ne("ip4"),u=Ne("ip6"),l=Ne("dns6"),d=Ne("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),khe.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=Ne(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=Ne(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return ce(this,yo).map(([e])=>Object.assign({},Ne(e)))}protoCodes(){return ce(this,yo).map(([e])=>e)}protoNames(){return ce(this,yo).map(([e])=>Ne(e).name)}tuples(){return ce(this,yo)}stringTuples(){return ce(this,rh)}encapsulate(e){return e=new $i(e),new $i(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new $i(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new $i(QD(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([n,s])=>{n===Gd.p2p.code&&e.push([n,s]),n===Gd["p2p-circuit"].code&&(e=[])});const t=e.pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C(ys.decode(`z${n}`),"base58btc"):C(qD.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return ce(this,nh)}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=Nhe.get(t.name);if(n==null)throw new l2(`no available resolver for ${t.name}`,"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new $i(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(hVe=XD,Phe)](){return`Multiaddr(${ce(this,Xc)})`}},Xc=new WeakMap,yo=new WeakMap,rh=new WeakMap,nh=new WeakMap,$i);function Lh(r){return new Lhe(r)}function Iv(r){let e;try{e=Ne("sni").code}catch{return null}for(const[t,n]of r)if(t===e&&n!==void 0)return n;return null}function Cv(r){return r.some(([e,t])=>e===Ne("tls").code)}function un(r,e,t){const n=ZD[Ne(r).name];if(n===void 0)throw new Error(`Can't interpret protocol ${Ne(r).name}`);const s=n(e,t);return r===Ne("ip6").code?`[${s}]`:s}const ZD={ip4:(r,e)=>r,ip6:(r,e)=>e.length===0?r:`[${r}]`,tcp:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`tcp://${un(t[0],t[1]??"",e)}:${r}`},udp:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`udp://${un(t[0],t[1]??"",e)}:${r}`},dnsaddr:(r,e)=>r,dns4:(r,e)=>r,dns6:(r,e)=>r,dns:(r,e)=>r,ipfs:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${un(t[0],t[1]??"",e)}/ipfs/${r}`},p2p:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${un(t[0],t[1]??"",e)}/p2p/${r}`},http:(r,e)=>{const t=Cv(e),n=Iv(e);if(t&&n!==null)return`https://${n}`;const s=t?"https://":"http://",i=e.pop();if(i===void 0)throw new Error("Unexpected end of multiaddr");let o=un(i[0],i[1]??"",e);return o=o.replace("tcp://",""),`${s}${o}`},tls:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return un(t[0],t[1]??"",e)},sni:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return un(t[0],t[1]??"",e)},https:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");let n=un(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=Cv(e),n=Iv(e);if(t&&n!==null)return`wss://${n}`;const s=t?"wss://":"ws://",i=e.pop();if(i===void 0)throw new Error("Unexpected end of multiaddr");let o=un(i[0],i[1]??"",e);return o=o.replace("tcp://",""),`${s}${o}`},wss:(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");let n=un(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`wss://${n}`},"p2p-websocket-star":(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${un(t[0],t[1]??"",e)}/p2p-websocket-star`},"p2p-webrtc-star":(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${un(t[0],t[1]??"",e)}/p2p-webrtc-star`},"p2p-webrtc-direct":(r,e)=>{const t=e.pop();if(t===void 0)throw new Error("Unexpected end of multiaddr");return`${un(t[0],t[1]??"",e)}/p2p-webrtc-direct`}};function x4(r,e){const n=Lh(r).stringTuples(),s=n.pop();if(s===void 0)throw new Error("Unexpected end of multiaddr");const i=Ne(s[0]),o=ZD[i.name];if(o==null)throw new Error(`No interpreter found for ${i.name}`);let a=o(s[1]??"",n);return e?.assumeHttp!==!1&&s[0]===Ne("tcp").code&&(a=a.replace("tcp://","http://"),(s[1]==="443"||s[1]==="80")&&(s[1]==="443"&&(a=a.replace("http://","https://")),a=a.substring(0,a.lastIndexOf(":")))),a}function Mhe(r){if(!Array.isArray(r))throw new TypeError(`Expected an array, got ${typeof r}`);r=[...r];for(let e=r.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[r[e],r[t]]=[r[t],r[e]]}return r}const Uhe=N("ipfs:preload"),Bhe=zt.default?zt.default:zt,zhe=new Bhe({concurrency:4});function Fhe(r,e={}){return Uhe(r),zhe.add(async()=>{const n=(await Ii.post(r,{signal:e.signal})).body.getReader();try{for(;;){const{done:s}=await n.read();if(s)return}}finally{n.releaseLock()}})}const uu=N("ipfs:preload");function Vhe(r={}){if(r.enabled=!!r.enabled,r.addresses=r.addresses||[],r.cache=r.cache||1e3,!r.enabled||!r.addresses.length)return uu("preload disabled"),Object.assign(()=>{},{start:()=>{},stop:()=>{}});let e=!0,t=[];const n=r.addresses.map(o=>x4(o)),s=f2(r.cache),i=async o=>{try{if(e)throw new Error(`preload ${o} but preloader is not started`);const a=o.toString();if(s.has(a))return;s.set(a,!0);const c=Mhe(n);let u=!1;const l=Date.now();for(const d of c){if(e)throw new Error(`preload aborted for ${a}`);let f;try{f=new AbortController,t=t.concat(f),await Fhe(`${d}/api/v0/refs?r=true&arg=${encodeURIComponent(a)}`,{signal:f.signal}),u=!0}catch(g){g.type!=="aborted"&&uu.error(g)}finally{t=t.filter(g=>g!==f)}if(u)break}uu(`${u?"":"un"}successfully preloaded ${a} in ${Date.now()-l}ms`)}catch(a){uu.error(a)}};return i.start=()=>{e=!1},i.stop=()=>{e=!0,uu(`aborting ${t.length} pending preload request(s)`),t.forEach(o=>o.abort()),t=[]},i}const $f=N("ipfs:mfs-preload");function jhe({preload:r,files:e,options:t={}}){if(t.interval=t.interval||30*1e3,!t.enabled){$f("MFS preload disabled");const o=async()=>{};return{start:o,stop:o}}let n="",s;const i=async()=>{try{const o=await e.stat("/"),a=o.cid.toString();n!==a&&($f(`preloading updated MFS root ${n} -> ${o.cid}`),await r(o.cid),n=a)}catch(o){$f.error("failed to preload MFS root",o)}finally{s=setTimeout(i,t.interval)}};return{async start(){const o=await e.stat("/");n=o.cid.toString(),$f(`monitoring MFS root ${o.cid}`),s=setTimeout(i,t.interval)},stop(){clearTimeout(s)}}}let qhe=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Khe=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const xv=r=>globalThis.DOMException===void 0?new Khe(r):new DOMException(r),Dv=r=>{const e=r.reason===void 0?xv("This operation was aborted."):r.reason;return e instanceof Error?e:xv(e)};function Ghe(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o;const c=new Promise((u,l)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:f}=e;f.aborted&&l(Dv(f)),f.addEventListener("abort",()=>{l(Dv(f))})}if(t===Number.POSITIVE_INFINITY){r.then(u,l);return}const d=new qhe;o=i.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(f){l(f)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?u():s instanceof Error?l(s):(d.message=s??`Promise timed out after ${t} milliseconds`,l(d))},t),(async()=>{try{u(await r)}catch(f){l(f)}})()}).finally(()=>{c.clear()});return c.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},c}const Ov="lock:worker:request-read",Pv="lock:worker:release-read",kv="lock:master:grant-read",Nv="lock:worker:request-write",Lv="lock:worker:release-write",Mv="lock:master:grant-write",xo={},Va=r=>{r.addEventListener("message",e=>{Va.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{Va.dispatchEvent("message",r,e)})};Va.addEventListener=(r,e)=>{xo[r]==null&&(xo[r]=[]),xo[r].push(e)};Va.removeEventListener=(r,e)=>{xo[r]!=null&&(xo[r]=xo[r].filter(t=>t===e))};Va.dispatchEvent=function(r,e,t){xo[r]!=null&&xo[r].forEach(n=>n(e,t))};const Uv=(r,e,t,n,s)=>(i,o)=>{if(o.data.type!==t)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:a.name,handler:async()=>(i.postMessage({type:s,name:a.name,identifier:a.identifier}),await new Promise(c=>{const u=l=>{if(l==null||l.data==null)return;const d={type:l.data.type,name:l.data.name,identifier:l.data.identifier};d.type===n&&d.identifier===a.identifier&&(i.removeEventListener("message",u),c())};i.addEventListener("message",u)}))}}))},Bv=(r,e,t,n)=>async()=>{const s=YI();return globalThis.postMessage({type:e,identifier:s,name:r}),await new Promise(i=>{const o=a=>{if(a==null||a.data==null)return;const c={type:a.data.type,identifier:a.data.identifier};c.type===t&&c.identifier===s&&(globalThis.removeEventListener("message",o),i(()=>{globalThis.postMessage({type:n,identifier:s,name:r})}))};globalThis.addEventListener("message",o)})},Hhe={singleProcess:!1},Whe=r=>{if(r=Object.assign({},Hhe,r),!!globalThis.document||r.singleProcess){const t=new EventTarget;return Va.addEventListener("message",Uv(t,"requestReadLock",Ov,Pv,kv)),Va.addEventListener("message",Uv(t,"requestWriteLock",Nv,Lv,Mv)),t}return{isWorker:!0,readLock:t=>Bv(t,Ov,kv,Pv),writeLock:t=>Bv(t,Nv,Mv,Lv)}},Yo={};let po;async function gy(r,e){let t;const n=new Promise(s=>{t=s});return r.add(async()=>await Ghe((async()=>await new Promise(s=>{t(()=>{s()})}))(),{milliseconds:e.timeout})),await n}const Qhe=(r,e)=>{if(po.isWorker===!0)return{readLock:po.readLock(r,e),writeLock:po.writeLock(r,e)};const t=new zt({concurrency:1});let n;return{async readLock(){if(n!=null)return await gy(n,e);n=new zt({concurrency:e.concurrency,autoStart:!1});const s=n,i=gy(n,e);return t.add(async()=>(s.start(),await s.onIdle().then(()=>{n===s&&(n=null)}))),await i},async writeLock(){return n=null,await gy(t,e)}}},Yhe={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function D4(r){const e=Object.assign({},Yhe,r);return po==null&&(po=Whe(e),po.isWorker!==!0&&(po.addEventListener("requestReadLock",t=>{Yo[t.data.name]!=null&&Yo[t.data.name].readLock().then(async n=>await t.data.handler().finally(()=>n()))}),po.addEventListener("requestWriteLock",async t=>{Yo[t.data.name]!=null&&Yo[t.data.name].writeLock().then(async n=>await t.data.handler().finally(()=>n()))}))),Yo[e.name]==null&&(Yo[e.name]=Qhe(e.name,e)),Yo[e.name]}let Rf;function O4(r=!1){if(Rf)return Rf;const e=D4({singleProcess:r});return Rf={readLock:t=>async(...n)=>{const s=await e.readLock();try{return await t.apply(null,n)}finally{s()}},writeLock:t=>async(...n)=>{const s=await e.writeLock();try{return await t.apply(null,n)}finally{s()}}},Rf}const zv=N("ipfs:mfs:utils:with-mfs-root");async function P4(r,e){if(e&&e.signal&&e.signal.aborted)throw $(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});await r.repo.datastore.open();let t;try{const n=await r.repo.datastore.get(Qw);t=ne.decode(n)}catch(n){if(n.code!=="ERR_NOT_FOUND")throw n;zv("Creating new MFS root");const s=Je({Data:new Ze({type:"directory"}).marshal(),Links:[]}),i=await rl.digest(s);if(t=ne.createV0(i),await r.repo.blocks.put(t,s),e&&e.signal&&e.signal.aborted)throw $(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});await r.repo.datastore.put(Qw,t.bytes)}return zv(`Loaded MFS root /ipfs/${t}`),t}function k4(r=""){return(r.trim().match(/([^\\^/]|\\\/)+/g)||[]).filter(Boolean)}const yy="ipfs",on=async(r,e,t)=>{const n=await P4(r,t);let s={entryType:"file"},i="";if(ne.asCID(e)?i=`/ipfs/${e}`:i=e.toString(),i=i.trim(),i=i.replace(/(\/\/+)/g,"/"),i.endsWith("/")&&i.length>1&&(i=i.substring(0,i.length-1)),!i)throw $(new Error("paths must not be empty"),"ERR_NO_PATH");if(i.substring(0,1)!=="/")throw $(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");i.substring(i.length-1)==="/"&&(i=i.substring(0,i.length-1));const o=k4(i);if(o[0]===yy){let c;o.length===2?c=`/${o.join("/")}`:c=`/${o.slice(0,o.length-1).join("/")}`,s={type:"ipfs",depth:o.length-2,entryType:"file",mfsPath:`/${o.join("/")}`,mfsDirectory:c,parts:o,path:`/${o.join("/")}`,name:o[o.length-1]}}else{const c=`/${yy}/${n}${o.length?"/"+o.join("/"):""}`,u=`/${yy}/${n}/${o.slice(0,o.length-1).join("/")}`;s={type:"mfs",depth:o.length,entryType:"file",mfsDirectory:u,mfsPath:c,parts:o,path:`/${o.join("/")}`,name:o[o.length-1]}}const a=s.type==="mfs"?s.mfsPath:s.path;try{const c=await Bi(a,r.repo.blocks,t);s.cid=c.cid,s.mfsPath=`/ipfs/${c.path}`,s.entryType=c.type,s.content=c.content,(s.entryType==="file"||s.entryType==="directory")&&(c.type==="file"||c.type==="directory")&&(s.unixfs=c.unixfs)}catch(c){if(c.code!=="ERR_NOT_FOUND")throw c}return s.exists=!!s.cid,s},Xhe=et.bind({ignoreUndefined:!0}),Jhe=N("ipfs:mfs:stat"),Zhe={withLocal:!1};function D2(r){async function e(t,n={}){n=Xhe(Zhe,n),Jhe(`Fetching stats for ${t}`);const{type:s,cid:i,mfsPath:o}=await on(r,t,n),a=s==="ipfs"&&i?i:o;let c;try{c=await Bi(a,r.repo.blocks)}catch(u){throw u.code==="ERR_NOT_FOUND"?$(new Error(`${t} does not exist`),"ERR_NOT_FOUND"):u}if(!Fv[c.type])throw new Error(`Cannot stat codec ${c.cid.code}`);return Fv[c.type](c)}return F(e)}const Fv={raw:r=>({cid:r.cid,size:r.node.length,cumulativeSize:r.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1}),file:r=>{const e={cid:r.cid,type:"file",size:r.unixfs.fileSize(),cumulativeSize:Je(r.node).length+(r.node.Links||[]).reduce((t,n)=>t+(n.Tsize||0),0),blocks:r.unixfs.blockSizes.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:r.unixfs.mode};return r.unixfs.mtime&&(e.mtime=r.unixfs.mtime),e},directory:r=>{const e={cid:r.cid,type:"directory",size:0,cumulativeSize:Je(r.node).length+(r.node.Links||[]).reduce((t,n)=>t+(n.Tsize||0),0),blocks:r.node.Links.length,local:void 0,sizeLocal:void 0,withLocality:!1,mode:r.unixfs.mode};return r.unixfs.mtime&&(e.mtime=r.unixfs.mtime),e},object:r=>({cid:r.cid,size:r.node.length,cumulativeSize:r.node.length,type:"file",blocks:0,local:void 0,sizeLocal:void 0,withLocality:!1}),identity:r=>({cid:r.cid,size:r.node.length,cumulativeSize:r.node.length,blocks:0,type:"file",local:void 0,sizeLocal:void 0,withLocality:!1})},efe=N("ipfs:mfs:utils:to-trail");async function Mh(r,e){efe(`Creating trail for path ${e}`);const t=[];for await(const n of Gx(e,r.repo.blocks))t.push({name:n.name,cid:n.cid,size:n.size,type:n.type});return t}const eO=async(r,e,t)=>{t.codec||(t.codec=Lo),t.hasher||(t.hasher=rl),t.cidVersion===void 0&&(t.cidVersion=1),t.codec===Lo&&t.hasher!==rl&&(t.cidVersion=1);const n=await t.hasher.digest(r),s=ne.create(t.cidVersion,t.codec.code,n);return t.onlyHash||await e.put(s,r,{signal:t.signal}),s},tO=S2.code,rO=8;async function nO(r){return(await S2.encode(r)).subarray(0,8).reverse()}class tfe{constructor(e,t){this.options=t||{},this.root=e.root,this.dir=e.dir,this.path=e.path,this.dirty=e.dirty,this.flat=e.flat,this.parent=e.parent,this.parentKey=e.parentKey,this.unixfs=e.unixfs,this.mode=e.mode,this.mtime=e.mtime,this.cid=void 0,this.size=void 0}async put(e,t){}get(e){return Promise.resolve(this)}async*eachChildSeries(){}async*flush(e){}}class sO extends tfe{constructor(e,t){super(e,t),this._bucket=A2({hashFn:nO,bits:rO})}async put(e,t){await this._bucket.put(e,t)}get(e){return this._bucket.get(e)}childCount(){return this._bucket.leafCount()}directChildrenCount(){return this._bucket.childrenCount()}onlyChild(){return this._bucket.onlyChild()}async*eachChildSeries(){for await(const{key:e,value:t}of this._bucket.eachLeafSeries())yield{key:e,child:t}}async*flush(e){yield*iO(this._bucket,e,this,this.options)}}async function*iO(r,e,t,n){const s=r._children,i=[];let o=0;for(let g=0;g<s.length;g++){const h=s.get(g);if(!h)continue;const p=g.toString(16).toUpperCase().padStart(2,"0");if(h instanceof Fr){let w;for await(const y of await iO(h,e,null,n))w=y;if(!w)throw new Error("Could not flush sharded directory, no subshard found");i.push({Name:p,Tsize:w.size,Hash:w.cid}),o+=w.size}else if(typeof h.value.flush=="function"){const w=h.value;let y;for await(const m of w.flush(e))y=m,yield y;const E=p+h.key;i.push({Name:E,Tsize:y.size,Hash:y.cid}),o+=y.size}else{const w=h.value;if(!w.cid)continue;const y=p+h.key,E=w.size;i.push({Name:y,Tsize:E,Hash:w.cid}),o+=E}}const a=Uint8Array.from(s.bitField().reverse()),u={Data:new Ze({type:"hamt-sharded-directory",data:a,fanout:r.tableSize(),hashType:tO,mtime:t&&t.mtime,mode:t&&t.mode}).marshal(),Links:i},l=Je(Mo(u)),d=await eO(l,e,n),f=l.length+o;yield{cid:d,node:u,size:f}}const od=N("ipfs:mfs:core:utils:hamt-utils"),O2=async(r,e,t,n)=>{if(!n.parent.Data)throw new Error("Could not update HAMT directory because parent had no data");const s=Uint8Array.from(t._children.bitField().reverse()),i=Ze.unmarshal(n.parent.Data),o=new Ze({type:"hamt-sharded-directory",data:s,fanout:t.tableSize(),hashType:tO,mode:i.mode,mtime:i.mtime}),a=await r.hashers.getHasher(n.hashAlg),c={Data:o.marshal(),Links:e.sort((f,g)=>(f.Name||"").localeCompare(g.Name||""))},u=Je(c),l=await a.digest(u),d=ne.create(n.cidVersion,ht,l);return n.flush&&await r.repo.blocks.put(d,u),{node:c,cid:d,size:e.reduce((f,g)=>f+(g.Tsize||0),u.length)}},oO=async(r,e,t,n,s)=>{const i=new Fr({hash:t._options.hash,bits:t._options.bits},n,s);return n._putObjectAt(s,i),await P2(r,e,i,t),i},aO=async r=>{const e=A2({hashFn:nO,bits:rO});return await Promise.all(r.map(async t=>{const n=t.Name||"";if(n.length===2){const s=parseInt(n,16),i=new Fr({hash:e._options.hash,bits:e._options.bits},e,s);return e._putObjectAt(s,i),Promise.resolve()}return e.put(n.substring(2),{size:t.Tsize,cid:t.Hash})})),e},P2=async(r,e,t,n)=>{await Promise.all(e.map(async s=>{const i=s.Name||"";if(i.length===2){od("Populating sub bucket",i);const o=parseInt(i,16),a=await r.repo.blocks.get(s.Hash),c=Lt(a),u=new Fr({hash:n._options.hash,bits:n._options.bits},t,o);return t._putObjectAt(o,u),await P2(r,c.Links,u,n),Promise.resolve()}return n.put(i.substring(2),{size:s.Tsize,cid:s.Hash})}))},Gc=r=>r.toString(16).toUpperCase().padStart(2,"0").substring(0,2),rfe=async(r,e,t)=>{const n=await aO(t.Links),s=await n._findNewBucketAndPos(e),i=[{bucket:s.bucket,prefix:Gc(s.pos)}];let o=s.bucket;for(;o!==n;)i.push({bucket:o,prefix:Gc(o._posAtParent)}),o=o._parent;i.reverse(),i[0].node=t;for(let a=0;a<i.length;a++){const c=i[a];if(!c.node)throw new Error("Could not generate HAMT path");const u=c.node.Links.filter(g=>(g.Name||"").substring(0,2)===c.prefix).pop();if(!u){od(`Link ${c.prefix}${e} will be added`);continue}if(u.Name===`${c.prefix}${e}`){od(`Link ${c.prefix}${e} will be replaced`);continue}od(`Found subshard ${c.prefix}`);const l=await r.repo.blocks.get(u.Hash),d=Lt(l);if(!i[a+1]){od(`Loaded new subshard ${c.prefix}`),await oO(r,d.Links,n,c.bucket,parseInt(c.prefix,16));const g=await n._findNewBucketAndPos(e);i.push({bucket:g.bucket,prefix:Gc(g.pos),node:d});continue}const f=i[a+1];await P2(r,d.Links,f.bucket,n),f.node=d}return await n.put(e,!0),i.reverse(),{rootBucket:n,path:i}},nfe=async(r,e,t={})=>{const n=new sO({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mtime:t.mtime,mode:t.mode},t);for(let i=0;i<e.length;i++)await n._bucket.put(e[i].name,{size:e[i].size,cid:e[i].cid});const s=await En(n.flush(r.repo.blocks));if(!s)throw new Error("Flushing shard yielded no result");return s},Gs=N("ipfs:mfs:core:utils:add-link");async function kl(r,e){let t=e.parent;if(e.parentCid){const s=ne.asCID(e.parentCid);if(s===null)throw $(new Error("Invalid CID passed to addLink"),"EINVALIDPARENTCID");if(s.code!==ht)throw $(new Error("Unsupported codec. Only DAG-PB is supported"),"EINVALIDPARENTCID");Gs(`Loading parent node ${s}`);const i=await r.repo.blocks.get(s);t=Lt(i)}if(!t)throw $(new Error("No parent node or CID passed to addLink"),"EINVALIDPARENT");if(!e.cid)throw $(new Error("No child cid passed to addLink"),"EINVALIDCHILDCID");if(!e.name)throw $(new Error("No child name passed to addLink"),"EINVALIDCHILDNAME");if(!e.size&&e.size!==0)throw $(new Error("No child size passed to addLink"),"EINVALIDCHILDSIZE");if(!t.Data)throw $(new Error("Parent node with no data passed to addLink"),"ERR_INVALID_PARENT");const n=Ze.unmarshal(t.Data);return n.type==="hamt-sharded-directory"?(Gs("Adding link to sharded directory"),ofe(r,{...e,parent:t})):t.Links.length>=e.shardSplitThreshold?(Gs("Converting directory to sharded directory"),sfe(r,{...e,parent:t,mtime:n.mtime,mode:n.mode})):(Gs(`Adding ${e.name} (${e.cid}) to regular directory`),ife(r,{...e,parent:t}))}const sfe=async(r,e)=>{const t=await nfe(r,e.parent.Links.map(n=>({name:n.Name||"",size:n.Tsize||0,cid:n.Hash})).concat({name:e.name,size:e.size,cid:e.cid}),e);return Gs(`Converted directory to sharded directory ${t.cid}`),t},ife=async(r,e)=>{const t=e.parent.Links.filter(u=>u.Name!==e.name);if(t.push({Name:e.name,Tsize:e.size,Hash:e.cid}),!e.parent.Data)throw $(new Error("Parent node with no data passed to addToDirectory"),"ERR_INVALID_PARENT");const n=Ze.unmarshal(e.parent.Data);let s;if(n.mtime){const u=Date.now(),l=Math.floor(u/1e3);n.mtime={secs:l,nsecs:(u-l*1e3)*1e3},s=n.marshal()}else s=e.parent.Data;e.parent=Mo({Data:s,Links:t});const i=await r.hashers.getHasher(e.hashAlg),o=Je(e.parent),a=await i.digest(o),c=ne.create(e.cidVersion,ht,a);return e.flush&&await r.repo.blocks.put(c,o),{node:e.parent,cid:c,size:o.length}},ofe=async(r,e)=>{const{shard:t,path:n}=await afe(r,e),s=await En(t.flush(r.repo.blocks));if(!s)throw new Error("No result from flushing shard");const i=await r.repo.blocks.get(s.cid),o=Lt(i),a=e.parent.Links.filter(u=>(u.Name||"").substring(0,2)!==n[0].prefix),c=o.Links.find(u=>(u.Name||"").substring(0,2)===n[0].prefix);if(!c)throw new Error(`No link found with prefix ${n[0].prefix}`);return a.push(c),O2(r,a,n[0].bucket,e)},afe=async(r,e)=>{const t={name:e.name,cid:e.cid,size:e.size};if(!e.parent.Data)throw $(new Error("Parent node with no data passed to addFileToShardedDirectory"),"ERR_INVALID_PARENT");const n=await aO(e.parent.Links),s=Ze.unmarshal(e.parent.Data),i=new sO({root:!0,dir:!0,parent:void 0,parentKey:void 0,path:"",dirty:!0,flat:!1,mode:s.mode},e);i._bucket=n,s.mtime&&(i.mtime={secs:Math.round(Date.now()/1e3)});const o=await n._findNewBucketAndPos(t.name),a=cfe(o);a[0].node=e.parent;let c=0;for(;c<a.length;){const u=a[c];c++;const l=u.node;if(!l)throw new Error("Segment had no node");const d=l.Links.find(p=>(p.Name||"").substring(0,2)===u.prefix);if(!d){Gs(`Link ${u.prefix}${t.name} will be added`),c=a.length;break}if(d.Name===`${u.prefix}${t.name}`){Gs(`Link ${u.prefix}${t.name} will be replaced`),c=a.length;break}if((d.Name||"").length>2){Gs(`Link ${d.Name} ${d.Hash} will be replaced with a subshard`),c=a.length;break}Gs(`Found subshard ${u.prefix}`);const f=await r.repo.blocks.get(d.Hash),g=Lt(f);if(!a[c]){Gs(`Loaded new subshard ${u.prefix}`),await oO(r,g.Links,n,u.bucket,parseInt(u.prefix,16));const p=await n._findNewBucketAndPos(t.name);a.push({bucket:p.bucket,prefix:Gc(p.pos),node:g});break}const h=a[c];await P2(r,g.Links,h.bucket,n),h.node=g}return await i._bucket.put(t.name,{size:t.size,cid:t.cid}),{shard:i,path:a}},cfe=r=>{const e=[{bucket:r.bucket,prefix:Gc(r.pos)}];let t=r.bucket._parent,n=r.bucket._posAtParent;for(;t;)e.push({bucket:t,prefix:Gc(n)}),n=t._posAtParent,t=t._parent;return e.reverse(),e},Vv=N("ipfs:mfs:utils:update-tree"),lfe={shardSplitThreshold:1e3};async function rc(r,e,t){t=Object.assign({},lfe,t),Vv("Trail",e),e=e.slice().reverse();let n=0,s;for await(const o of r.repo.blocks.getMany(e.map(a=>a.cid))){const a=Lt(o),c=e[n].cid,u=e[n].name;if(n++,!s){s={cid:c,name:u,size:o.length};continue}const l=await kl(r,{parent:a,name:s.name,cid:s.cid,size:s.size,flush:t.flush,shardSplitThreshold:t.shardSplitThreshold,hashAlg:t.hashAlg,cidVersion:t.cidVersion});s={cid:l.cid,name:u,size:l.size}}const{cid:i}=s;return Vv(`Final CID ${i}`),i}const ufe=N("ipfs:mfs:utils:update-mfs-root");async function nc(r,e,t){if(t&&t.signal&&t.signal.aborted)throw $(new Error("Request aborted"),"ERR_ABORTED",{name:"Aborted"});return ufe(`New MFS root will be ${e}`),await r.repo.datastore.put(Qw,e.bytes),e}async function dfe(r,e,t){const n=new Ze({type:e,mode:t.mode,mtime:t.mtime}),s=await r.hashers.getHasher(t.hashAlg),i={Data:n.marshal(),Links:[]},o=Je(i),a=await s.digest(o),c=ne.create(t.cidVersion,ht,a);return t.flush&&await r.repo.blocks.put(c,o),{cid:c,node:i}}const hfe=et.bind({ignoreUndefined:!0}),cO=N("ipfs:mfs:mkdir"),ffe={parents:!1,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3,flush:!0};function A1(r){async function e(t,n={}){const s=hfe(ffe,n);if(!t)throw new Error("no path given to Mkdir");if(t=t.trim(),t==="/"){if(s.parents)return;throw $(new Error("cannot create directory '/': Already exists"),"ERR_INVALID_PATH")}if(t.substring(0,1)!=="/")throw $(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");cO(`Creating ${t}`);const i=k4(t);if(i[0]==="ipfs")throw $(new Error("path cannot have the prefix 'ipfs'"),"ERR_INVALID_PATH");const o=await P4(r,s);let a;const c=[],u=await dfe(r,"directory",s);for(let d=0;d<=i.length;d++){const f=i.slice(0,d),g=`/ipfs/${o}/${f.join("/")}`;try{if(a=await Bi(g,r.repo.blocks),a.type!=="file"&&a.type!=="directory")throw $(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(d===i.length){if(s.parents)return;throw $(new Error("file already exists"),"ERR_ALREADY_EXISTS")}c.push({name:a.name,cid:a.cid})}catch(h){if(h.code==="ERR_NOT_FOUND"){if(d<i.length&&!s.parents)throw $(new Error(`Intermediate directory path ${g} does not exist, use the -p flag to create it`),"ERR_NOT_FOUND");await pfe(r,f[f.length-1],u,c[c.length-1],c,s)}else throw h}}const l=await rc(r,c,s);await nc(r,l,s)}return F(e)}const pfe=async(r,e,t,n,s,i)=>{cO(`Adding empty dir called ${e} to ${n.cid}`);const o=await kl(r,{parent:n.node,parentCid:n.cid,size:0,cid:t.cid,name:e,hashAlg:i.hashAlg,cidVersion:i.cidVersion,flush:i.flush,shardSplitThreshold:i.shardSplitThreshold});s[s.length-1].cid=o.cid,s.push({name:e,cid:t.cid})},gfe=et.bind({ignoreUndefined:!0}),Tf=N("ipfs:mfs:cp"),yfe={parents:!1,flush:!0,hashAlg:"sha2-256",cidVersion:0,shardSplitThreshold:1e3};function N4(r){async function e(t,n,s={}){const i=gfe(yfe,s);Array.isArray(t)||(t=[t]);const o=await Promise.all(t.map(f=>on(r,f,i)));let a=await on(r,n,i);if(!o.length||!a)throw $(new Error("Please supply at least one source"),"ERR_INVALID_PARAMS");const c=o.find(f=>!f.exists);if(c)throw $(new Error(`${c.path} does not exist`),"ERR_INVALID_PARAMS");const u=jv(a);if(a.exists){if(Tf("Destination exists"),o.length===1&&!u)throw $(new Error("directory already has entry by that name"),"ERR_ALREADY_EXISTS")}else if(Tf("Destination does not exist"),o.length>1){if(!i.parents)throw $(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await A1(r)(a.path,i),a=await on(r,a.path,i)}else if(a.parts.length>1){const f=`/${a.parts.slice(0,-1).join("/")}`;try{await D2(r)(f,i)}catch(g){if(g.code!=="ERR_NOT_FOUND")throw g;if(!i.parents)throw $(new Error("destination did not exist, pass -p to create intermediate directories"),"ERR_INVALID_PARAMS");await A1(r)(f,i),a=await on(r,a.path,i)}}const l=jv(a)?a.mfsPath:a.mfsDirectory,d=await Mh(r,l);if(o.length===1){const f=o.pop();if(!f)throw $(new Error("could not find source"),"ERR_INVALID_PARAMS");const g=u?f.name:a.name;return Tf(`Only one source, copying to destination ${u?"directory":"file"} ${g}`),wfe(r,f,g,d,i)}return Tf("Multiple sources, wrapping in a directory"),bfe(r,o,a,d,i)}return F(e)}const jv=r=>r.unixfs&&r.unixfs.type&&r.unixfs.type.includes("directory"),wfe=async(r,e,t,n,s)=>{let i=n.pop();if(!i)throw $(new Error("destination had no parent"),"ERR_INVALID_PARAMS");i=await lO(r,e,t,i,s),n.push(i);const o=await rc(r,n,s);await nc(r,o,s)},bfe=async(r,e,t,n,s)=>{for(let o=0;o<e.length;o++){const a=e[o];t=await lO(r,a,a.name,t,s)}n[n.length-1]=t;const i=await rc(r,n,s);await nc(r,i,s)},lO=async(r,e,t,n,s)=>{const i=await r.repo.blocks.get(e.cid),{node:o,cid:a,size:c}=await kl(r,{parentCid:n.cid,size:i.length,cid:e.cid,name:t,hashAlg:s.hashAlg,cidVersion:s.cidVersion,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold});return n.node=o,n.cid=a,n.size=c,n},_o=N("ipfs:mfs:core:utils:remove-link");async function mfe(r,e){let t=e.parent;if(e.parentCid){const s=ne.asCID(e.parentCid);if(s===null)throw $(new Error("Invalid CID passed to removeLink"),"EINVALIDPARENTCID");_o(`Loading parent node ${s}`);const i=await r.repo.blocks.get(s);t=Lt(i)}if(!t)throw $(new Error("No parent node or CID passed to removeLink"),"EINVALIDPARENT");if(!e.name)throw $(new Error("No child name passed to removeLink"),"EINVALIDCHILDNAME");if(!t.Data)throw $(new Error("Parent node had no data"),"ERR_INVALID_NODE");return Ze.unmarshal(t.Data).type==="hamt-sharded-directory"?(_o(`Removing ${e.name} from sharded directory`),vfe(r,{...e,parent:t})):(_o(`Removing link ${e.name} regular directory`),Efe(r,{...e,parent:t}))}const Efe=async(r,e)=>{e.parent.Links=e.parent.Links.filter(o=>o.Name!==e.name);const t=await Je(e.parent),s=await(await r.hashers.getHasher(e.hashAlg)).digest(t),i=ne.create(e.cidVersion,ht,s);return await r.repo.blocks.put(i,t),_o(`Updated regular directory ${i}`),{node:e.parent,cid:i}},vfe=async(r,e)=>{const{rootBucket:t,path:n}=await rfe(r,e.name,e.parent);await t.del(e.name);const{node:s}=await uO(r,n,e.name,e);return O2(r,s.Links,t,e)},uO=async(r,e,t,n)=>{const s=e.pop();if(!s)throw $(new Error("Could not find parent"),"EINVALIDPARENT");const{bucket:i,prefix:o,node:a}=s;if(!a)throw $(new Error("Could not find parent"),"EINVALIDPARENT");const c=a.Links.find(g=>(g.Name||"").substring(0,2)===o);if(!c)throw $(new Error(`No link found with prefix ${o} for file ${t}`),"ERR_NOT_FOUND");if(c.Name===`${o}${t}`){_o(`Removing existing link ${c.Name}`);const g=a.Links.filter(h=>h.Name!==c.Name);return await i.del(t),O2(r,g,i,n)}_o(`Descending into sub-shard ${c.Name} for ${o}${t}`);const u=await uO(r,e,t,n);let l=u.cid,d=u.size,f=o;if(u.node.Links.length===1){_o(`Removing subshard for ${o}`);const g=u.node.Links[0];f=`${o}${(g.Name||"").substring(2)}`,l=g.Hash,d=g.Tsize||0}return _o(`Updating shard ${o} with name ${f}`),_fe(r,i,a,o,f,d,l,n)},_fe=(r,e,t,n,s,i,o,a)=>{const c=t.Links.filter(u=>u.Name!==n);return c.push({Name:s,Tsize:i,Hash:o}),O2(r,c,e,a)},Sfe=et.bind({ignoreUndefined:!0}),Afe={recursive:!1,cidVersion:0,hashAlg:"sha2-256",flush:!0,shardSplitThreshold:1e3};function L4(r){async function e(t,n={}){const s=Sfe(Afe,n);Array.isArray(t)||(t=[t]);const i=await Promise.all(t.map(o=>on(r,o,s)));if(!i.length)throw $(new Error("Please supply at least one path to remove"),"ERR_INVALID_PARAMS");i.forEach(o=>{if(o.path==="/")throw $(new Error("Cannot delete root"),"ERR_INVALID_PARAMS")});for(const o of i)await $fe(r,o.path,s)}return F(e)}const $fe=async(r,e,t)=>{const n=await on(r,e,t),s=await Mh(r,n.mfsPath),i=s[s.length-1];s.pop();const o=s[s.length-1];if(!o)throw $(new Error(`${e} does not exist`),"ERR_NOT_FOUND");if(i.type==="directory"&&!t.recursive)throw $(new Error(`${e} is a directory, use -r to remove directories`),"ERR_WAS_DIR");const{cid:a}=await mfe(r,{parentCid:o.cid,name:i.name,hashAlg:t.hashAlg,cidVersion:t.cidVersion,flush:t.flush,shardSplitThreshold:t.shardSplitThreshold});o.cid=a;const c=await rc(r,s,t);await nc(r,c,t)},Rfe=et.bind({ignoreUndefined:!0}),Tfe=N("ipfs:mfs:touch"),qv={flush:!0,shardSplitThreshold:1e3,hashAlg:"sha2-256",cidVersion:0,recursive:!1};function Ife(r,e,t){let n=0;return(r.includes("x")||r.includes("X")&&(t||e&1||e&8||e&64))&&(n+=1),r.includes("w")&&(n+=2),r.includes("r")&&(n+=4),n}function Cfe(r,e){let t=0;return r.includes("u")&&(t+=e<<6),r.includes("g")&&(t+=e<<3),r.includes("o")&&(t+=e),t}function xfe(r,e,t){return e.includes("t")&&(t+=parseInt("1000",8)),e.includes("s")&&(r.includes("u")&&(t+=parseInt("4000",8)),r.includes("g")&&(t+=parseInt("2000",8))),t}function Dfe(r,e,t){e||(e=0);const n=r.match(/^(u?g?o?a?)(-?\+?=?)?(r?w?x?X?s?t?)$/);if(!n)throw new Error(`Invalid file mode: ${r}`);let[,s,i,o]=n;(s==="a"||!s)&&(s="ugo");let a=Ife(o,e,t);return a=Cfe(s,a),a=xfe(s,o,a),i==="="?(s.includes("u")&&(e=e&parseInt("7077",8),e=e|a),s.includes("g")&&(e=e&parseInt("7707",8),e=e|a),s.includes("o")&&(e=e&parseInt("7770",8),e=e|a),e):i==="+"?a|e:i==="-"?a^e:e}function Kv(r,e){if(r instanceof String||typeof r=="string"){const t=`${r}`;t.match(/^\d+$/g)?r=parseInt(t,8):r=0+t.split(",").reduce((n,s)=>Dfe(s,n,e.isDirectory()),e.mode||0)}return r}function Ofe(r){async function e(t,n,s={}){const i=Rfe(qv,s);Tfe(`Fetching stats for ${t}`);const{cid:o,mfsDirectory:a,name:c}=await on(r,t,i);if(o.code!==ht)throw $(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");if(i.recursive){const A=await Ae(async function*(){for await(const T of Hx(o,r.repo.blocks)){if(T.type!=="file"&&T.type!=="directory")throw $(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");T.unixfs.mode=Kv(n,T.unixfs);const P=Mo({Data:T.unixfs.marshal(),Links:T.node.Links});yield{path:T.path,content:P}}},T=>l4(T,r.repo.blocks,{...i,pin:!1,dagBuilder:async function*(P,V,Y){for await(const te of P)yield async function(){const se=te.content,Q=Je(se),ke=await eO(Q,V,Y);if(!se.Data)throw $(new Error(`${ke} had no data`),"ERR_INVALID_NODE");const Ye=Ze.unmarshal(se.Data);return{cid:ke,size:Q.length,path:te.path,unixfs:Ye}}}}),T=>En(T));if(!A)throw $(new Error(`Could not chmod ${t}`),"ERR_COULD_NOT_CHMOD");await L4(r)(t,i),await N4(r)(`/ipfs/${A.cid}`,t,i);return}const u=await r.repo.blocks.get(o),l=Lt(u);if(!l.Data)throw $(new Error(`${o} had no data`),"ERR_INVALID_NODE");const d=Ze.unmarshal(l.Data);d.mode=Kv(n,d);const f=Je({Data:d.marshal(),Links:l.Links}),g=i.hashAlg||qv.hashAlg,p=await(await r.hashers.getHasher(g)).digest(f),w=ne.create(i.cidVersion,ht,p);i.flush&&await r.repo.blocks.put(w,f);const y=await Mh(r,a),E=y[y.length-1],m=ne.decode(E.cid.bytes),b=await r.repo.blocks.get(m),v=Lt(b),S=await kl(r,{parent:v,name:c,cid:w,size:f.length,flush:i.flush,hashAlg:g,cidVersion:o.version,shardSplitThreshold:1/0});E.cid=S.cid;const _=await rc(r,y,i);await nc(r,_,i)}return F(e)}const Pfe=et.bind({ignoreUndefined:!0}),kfe={};function Nfe(r){async function e(t,n={}){n=Pfe(kfe,n);const{cid:s}=await D2(r)(t,n);return s}return F(e)}const Lfe=et.bind({ignoreUndefined:!0}),Mfe={parents:!1,flush:!0,cidVersion:0,hashAlg:"sha2-256",shardSplitThreshold:1e3};function Ufe(r){async function e(t,n,s={}){const i=Lfe(Mfe,s);await N4(r)(t,n,i),await L4(r)(t,{...i,recursive:!0})}return F(e)}const Bfe=et.bind({ignoreUndefined:!0}),zfe=N("ipfs:mfs:touch"),Gv={flush:!0,shardSplitThreshold:1e3,cidVersion:0,hashAlg:"sha2-256"};function Ffe(r){async function e(t,n={}){const s=Bfe(Gv,n);s.mtime=s.mtime||new Date,zfe(`Touching ${t} mtime: ${s.mtime}`);const{cid:i,mfsDirectory:o,name:a,exists:c}=await on(r,t,s),u=n.hashAlg||Gv.hashAlg,l=await r.hashers.getHasher(u);let d,f,g=s.cidVersion;if(c){if(i.code!==ht)throw $(new Error(`${t} was not a UnixFS node`),"ERR_NOT_UNIXFS");g=i.version;const v=await r.repo.blocks.get(i),S=Lt(v);if(!S.Data)throw $(new Error(`${t} had no data`),"ERR_INVALID_NODE");const _=Ze.unmarshal(S.Data);_.mtime=s.mtime,d=Je({Data:_.marshal(),Links:S.Links});const A=await l.digest(d);f=ne.create(s.cidVersion,ht,A),s.flush&&await r.repo.blocks.put(f,d)}else{const v=new Ze({type:"file",mtime:s.mtime});d=Je({Data:v.marshal(),Links:[]});const S=await l.digest(d);f=ne.create(s.cidVersion,ht,S),s.flush&&await r.repo.blocks.put(f,d)}const h=await Mh(r,o),p=h[h.length-1],w=p.cid,y=await r.repo.blocks.get(w),E=Lt(y),m=await kl(r,{parent:E,name:a,cid:f,size:d.length,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold,hashAlg:s.hashAlg,cidVersion:g});p.cid=m.cid;const b=await rc(r,h,s);await nc(r,b,s)}return F(e)}const Vfe=et.bind({ignoreUndefined:!0}),jfe={offset:0,length:1/0};function qfe(r){function e(t,n={}){return n=Vfe(jfe,n),{[Symbol.asyncIterator]:async function*(){const i=await on(r,t,n),o=await Bi(i.mfsPath,r.repo.blocks);if(o.type!=="file"&&o.type!=="raw")throw $(new Error(`${t} was not a file or raw bytes`),"ERR_NOT_FILE");if(!o.content)throw $(new Error(`Could not load content stream from ${t}`),"ERR_NO_CONTENT");for await(const a of o.content({offset:n.offset,length:n.length}))yield a}}}return F(e)}const du=N("ipfs:mfs:utils:to-async-iterator");function Kfe(r){if(!r)throw $(new Error("paths must start with a leading slash"),"ERR_INVALID_PATH");if((typeof r=="string"||r instanceof String)&&(du("Content was a string"),r=L(r.toString())),r.length)return du("Content was array-like"),{[Symbol.asyncIterator]:function*(){yield r}};if(r[Symbol.asyncIterator])return du("Content was an async iterator"),r;if(r[Symbol.iterator])return du("Content was an iterator"),r;if(j8.Blob&&r instanceof j8.Blob)return du("Content was an HTML5 Blob"),Ua(r.stream());throw $(new Error(`Don't know how to convert ${r} into an async iterator`),"ERR_INVALID_PARAMS")}const Gfe=et.bind({ignoreUndefined:!0}),Us=N("ipfs:mfs:write"),Hfe={offset:0,length:1/0,create:!1,truncate:!1,rawLeaves:!1,reduceSingleLeafToSelf:!1,cidVersion:0,hashAlg:"sha2-256",parents:!1,progress:(r,e)=>{},strategy:"trickle",flush:!0,leafType:"raw",shardSplitThreshold:1e3};function Wfe(r){async function e(t,n,s={}){const i=Gfe(Hfe,s);let o,a,c;if(Us("Reading source, destination and parent"),await O4().readLock(async()=>{o=await Kfe(n),a=await on(r,t,i),c=await on(r,a.mfsDirectory,i)})(),Us("Read source, destination and parent"),!i.parents&&!c.exists)throw $(new Error("directory does not exist"),"ERR_NO_EXIST");if(o==null)throw $(new Error("could not create source"),"ERR_NO_SOURCE");if(a==null)throw $(new Error("could not create destination"),"ERR_NO_DESTINATION");if(!i.create&&!a.exists)throw $(new Error("file does not exist"),"ERR_NO_EXIST");if(a.entryType!=="file")throw $(new Error("not a file"),"ERR_NOT_A_FILE");return Qfe(r,t,o,a,i)}return F(e)}const Qfe=async(r,e,t,n,s)=>{const i=await Yfe(r,t,n,s);await O4().writeLock(async()=>{const o=k4(e),a=o.pop();if(a==null)throw $(new Error("source does not exist"),"ERR_NO_EXIST");let c=!1;try{await D2(r)(`/${o.join("/")}`,s),c=!0}catch(w){if(w.code!=="ERR_NOT_FOUND")throw w}c||await A1(r)(`/${o.join("/")}`,s);const u=await on(r,e,s),l=await Mh(r,u.mfsDirectory),d=l[l.length-1];if(!d)throw $(new Error("directory does not exist"),"ERR_NO_EXIST");if(!d.type||!d.type.includes("directory"))throw $(new Error(`cannot write to ${d.name}: Not a directory`),"ERR_NOT_A_DIRECTORY");const f=await r.repo.blocks.get(d.cid),g=Lt(f),h=await kl(r,{parent:g,name:a,cid:i.cid,size:i.size,flush:s.flush,shardSplitThreshold:s.shardSplitThreshold,hashAlg:s.hashAlg,cidVersion:s.cidVersion});d.cid=h.cid;const p=await rc(r,l,s);await nc(r,p,s)})()},Yfe=async(r,e,t,n)=>{t.exists?Us(`Overwriting file ${t.cid} offset ${n.offset} length ${n.length}`):Us(`Writing file offset ${n.offset} length ${n.length}`);const s=[];if(n.offset>0)if(t.unixfs){if(Us(`Writing first ${n.offset} bytes of original file`),s.push(()=>t.content({offset:0,length:n.offset})),t.unixfs.fileSize()<n.offset){const l=n.offset-t.unixfs.fileSize();Us(`Writing zeros for extra ${l} bytes`),s.push(Hv(l))}}else Us(`Writing zeros for first ${n.offset} bytes`),s.push(Hv(n.offset));s.push(dO(e,n.length));const i=Jfe(Xfe(s),l=>{if(t.unixfs&&!n.truncate){const d=t.unixfs.fileSize();if(d>l)return Us(`Writing last ${d-l} of ${d} bytes from original file starting at offset ${l}`),t.content({offset:l});Us("Not writing last bytes from original file")}return{[Symbol.asyncIterator]:async function*(){}}});let o;n.mode!==void 0&&n.mode!==null?o=jc(n.mode):t&&t.unixfs&&(o=t.unixfs.mode);let a;n.mtime!=null?a=Cd(n.mtime):t&&t.unixfs&&(a=t.unixfs.mtime);const c=await r.hashers.getHasher(n.hashAlg),u=await En(l4([{content:i,mode:o,mtime:a}],r.repo.blocks,{progress:n.progress,hasher:c,cidVersion:n.cidVersion,strategy:n.strategy,rawLeaves:n.rawLeaves,reduceSingleLeafToSelf:n.reduceSingleLeafToSelf,leafType:n.leafType}));if(!u)throw $(new Error(`cannot write to ${parent.name}`),"ERR_COULD_NOT_WRITE");return Us(`Wrote ${u.cid}`),{cid:u.cid,size:u.size}},dO=(r,e)=>async function*(){let n=0;for await(const s of r){if(n+=s.length,n>e){yield s.subarray(0,e-n);return}yield s}},Hv=(r,e=uQ)=>{const t=new Uint8Array(e);async function*n(){for(;;)yield t}return dO(n(),r)},Xfe=async function*(r){for(let e=0;e<r.length;e++)yield*r[e]()},Jfe=async function*(r,e){let t=0;for await(const n of r)t+=n.length,yield n;for await(const n of e(t))t+=n.length,yield n},Wv=r=>{const e={cid:r.cid,name:r.name,type:r.type==="directory"?"directory":"file",size:r.size};return(r.type==="file"||r.type==="directory")&&(e.mode=r.unixfs.mode,e.mtime=r.unixfs.mtime),e};function Zfe(r){async function*e(t,n={}){const s=await on(r,t,n),i=await Bi(s.mfsPath,r.repo.blocks);if(i.type==="directory"){yield*Xr(i.content(n),Wv);return}yield Wv(i)}return F(e)}const epe={stat:D2},tpe={chmod:Ofe,cp:N4,flush:Nfe,mkdir:A1,mv:Ufe,rm:L4,touch:Ffe},Qv={write:Wfe,read:qfe,ls:Zfe},Yv=({options:r,mfs:e,operations:t,lock:n})=>{Object.keys(t).forEach(s=>{e[s]=n(t[s](r))})},rpe={repoOwner:!0,repo:null};function npe(r){const{repoOwner:e}=Object.assign({},rpe||{},r),t=O4(e),n=o=>t.readLock(o),s=o=>t.writeLock(o),i={};return Yv({options:r,mfs:i,operations:epe,lock:n}),Yv({options:r,mfs:i,operations:tpe,lock:s}),Object.keys(Qv).forEach(o=>{i[o]=Qv[o](r)}),i}function spe({repo:r,preload:e,hashers:t,options:n}){const s=npe({repo:r,repoOwner:n.repoOwner!==!1,hashers:t}),i=o=>(...c)=>{const u=c.filter(l=>uW(l)||xm(l));if(u.length){const l=c[c.length-1];l&&l.preload!==!1&&u.forEach(d=>e(d))}return o(...c)};return{...s,chmod:s.chmod,cp:i(s.cp),mkdir:s.mkdir,stat:i(s.stat),rm:s.rm,read:i(s.read),touch:s.touch,write:s.write,mv:i(s.mv),flush:s.flush,ls:i(async function*(...o){for await(const a of s.ls(...o))yield{...a,size:a.size||0}})}}function ipe({keychain:r}){return F((t,n)=>r.exportKey(t,n))}const Xv="Ed25519",Jv=2048;function ope({keychain:r}){return F((t,n={type:Xv,size:Jv})=>r.createKey(t,n.type||Xv,n.size||Jv))}function ape({keychain:r}){return F((t,n,s)=>r.importKey(t,n,s))}function cpe({keychain:r}){return F(t=>r.findKeyByName(t))}function lpe({keychain:r}){return F(()=>r.listKeys())}function upe({keychain:r}){return F(async(t,n)=>{const s=await r.renameKey(t,n);return{was:t,now:s.name,id:s.id,overwrite:!1}})}function dpe({keychain:r}){return F(t=>r.removeKey(t))}class hpe{constructor({keychain:e}){this.gen=ope({keychain:e}),this.list=lpe({keychain:e}),this.rm=dpe({keychain:e}),this.rename=upe({keychain:e}),this.export=ipe({keychain:e}),this.import=ape({keychain:e}),this.info=cpe({keychain:e})}}function sc({repo:r,preload:e}){async function t(n,s={}){s.preload!==!1&&e(n);const i=await r.blocks.get(n,s);return Lt(i)}return F(t)}function fpe({repo:r,preload:e}){const t=sc({repo:r,preload:e});async function n(s,i={}){return(await t(s,i)).Data||new Uint8Array(0)}return F(n)}function e3(r,e=[]){for(const t in r){const n=r[t];if(t==="/"&&Object.keys(r).length===1)try{e.push({Name:"",Tsize:0,Hash:ne.parse(n)});continue}catch{}const s=ne.asCID(n);if(s){e.push({Name:"",Tsize:0,Hash:s});continue}Array.isArray(n)&&e3(n,e),n&&typeof n=="object"&&e3(n,e)}return e}function ppe({repo:r,codecs:e}){async function t(n,s={}){const i=await e.getCodec(n.code),o=await r.blocks.get(n,s),a=i.decode(o);switch(n.code){case $m:return[];case ht:return a.Links;case ST:case uI:return e3(a);default:throw new Error(`Cannot resolve links from codec ${n.code}`)}}return F(t)}function gpe({repo:r,preload:e}){async function t(n={}){let s;if(n.template)if(n.template==="unixfs-dir")s=new Ze({type:"directory"}).marshal();else throw new Error("unknown template");const i=Je({Data:s,Links:[]}),o=await rl.digest(i),a=ne.createV0(o);return await r.blocks.put(a,i,{signal:n.signal}),n.preload!==!1&&e(a),a}return F(t)}function Uh({repo:r,preload:e}){async function t(n,s={}){const i=await r.gcLock.readLock();try{const o=Je(n),a=await rl.digest(o),c=ne.createV1(ht,a);return await r.blocks.put(c,o,{signal:s.signal}),s.preload!==!1&&e(c),s.pin&&await r.pins.pinRecursively(c,{signal:s.signal}),c}finally{i()}}return F(t)}function ype({repo:r,preload:e}){const t=sc({repo:r,preload:e});async function n(s,i={}){const o=await t(s,i),c=Je(o).length,u=o.Links.reduce((l,d)=>l+(d.Tsize||0),0);return{Hash:s,NumLinks:o.Links.length,BlockSize:c,LinksSize:c-(o.Data||[]).length,DataSize:(o.Data||[]).length,CumulativeSize:c+u}}return F(n)}function wpe({repo:r,preload:e}){const t=sc({repo:r,preload:e}),n=Uh({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a);return n({...c,Links:c.Links.concat([o])},a)}return F(s)}function bpe({repo:r,preload:e}){const t=sc({repo:r,preload:e}),n=Uh({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a),u=M([c.Data||[],o]);return n({...c,Data:u},a)}return F(s)}function mpe({repo:r,preload:e}){const t=sc({repo:r,preload:e}),n=Uh({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a),u=(typeof o=="string"?o:o.Name)||"";return c.Links=c.Links.filter(l=>l.Name!==u),n(c,a)}return F(s)}function Epe({repo:r,preload:e}){const t=sc({repo:r,preload:e}),n=Uh({repo:r,preload:e});async function s(i,o,a={}){const c=await t(i,a);return n({...c,Data:o},a)}return F(s)}class vpe{constructor({repo:e,preload:t}){this.addLink=wpe({repo:e,preload:t}),this.appendData=bpe({repo:e,preload:t}),this.rmLink=mpe({repo:e,preload:t}),this.setData=Epe({repo:e,preload:t})}}class _pe{constructor({repo:e,codecs:t,preload:n}){this.data=fpe({repo:e,preload:n}),this.get=sc({repo:e,preload:n}),this.links=ppe({repo:e,codecs:t}),this.new=gpe({repo:e,preload:n}),this.put=Uh({repo:e,preload:n}),this.stat=ype({repo:e,preload:n}),this.patch=new vpe({repo:e,preload:n})}}const Spe=N("ipfs:repo:gc");function Ape({repo:r,hashers:e}){async function*t(n={}){const s=Date.now();let i;try{i=await P4({repo:r,hashers:e},n),await r.pins.pinRecursively(i),yield*r.gc()}finally{i&&await r.pins.unpin(i)}Spe(`Complete (${Date.now()-s}ms)`)}return F(t)}function hO({repo:r}){async function e(t={}){const n=await r.stat();return{numObjects:BigInt(n.numObjects.toString()),repoSize:BigInt(n.repoSize.toString()),repoPath:n.repoPath,version:`${n.version}`,storageMax:BigInt(n.storageMax.toString())}}return F(e)}const hp=12;function $pe({repo:r}){async function e(t={}){try{await r._checkInitialized(t)}catch(n){if([/Key not found in database \[\/version\]/,/ENOENT/,/repo is not initialized yet/].some(i=>i.test(n.message)))return hp;throw n}return r.version.get()}return F(e)}class Rpe{constructor({repo:e,hashers:t}){this.gc=Ape({repo:e,hashers:t}),this.stat=hO({repo:e}),this.version=$pe({repo:e}),this.setApiAddr=n=>e.apiAddr.set(n)}}function Zv(r,e){return{totalIn:BigInt(0),totalOut:BigInt(0),rateIn:0,rateOut:0}}function Tpe({network:r}){return F(async function*(t={}){const{libp2p:n}=await r.use(t);if(!t.poll){yield Zv();return}const s=t.interval||1e3;let i=-1;try{if(i=typeof s=="string"?fe(s)||-1:s,!i||i<0)throw new Error("invalid duration")}catch(a){throw $(a,"ERR_INVALID_POLL_INTERVAL")}let o;try{for(;;)yield Zv(n,t),await new Promise(a=>{o=setTimeout(a,i)})}finally{clearTimeout(o)}})}class Ipe{constructor({repo:e,network:t}){this.repo=hO({repo:e}),this.bw=Tpe({network:t}),this.bitswap=NC({network:t})}}var M4=Cpe;function Cpe(r,e,t){if(!r)return t;var n,s;if(Array.isArray(e)&&(n=e.slice(0)),typeof e=="string"&&(n=e.split(".")),typeof e=="symbol"&&(n=[e]),!Array.isArray(n))throw new Error("props arg must be an array, a string or a symbol");for(;n.length;)if(s=n.shift(),!r||(r=r[s],r===void 0))return t;return r}var xpe=fO,e_=128,Dpe=127,Ope=~Dpe,Ppe=Math.pow(2,31);function fO(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Ppe;)e[t++]=r&255|e_,r/=128;for(;r&Ope;)e[t++]=r&255|e_,r>>>=7;return e[t]=r|0,fO.bytes=t-n+1,e}var kpe=t3,Npe=128,t_=127;function t3(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw t3.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&t_)<<s:(o&t_)*Math.pow(2,s),s+=7}while(o>=Npe);return t3.bytes=i-n,t}var Lpe=Math.pow(2,7),Mpe=Math.pow(2,14),Upe=Math.pow(2,21),Bpe=Math.pow(2,28),zpe=Math.pow(2,35),Fpe=Math.pow(2,42),Vpe=Math.pow(2,49),jpe=Math.pow(2,56),qpe=Math.pow(2,63),Kpe=function(r){return r<Lpe?1:r<Mpe?2:r<Upe?3:r<Bpe?4:r<zpe?5:r<Fpe?6:r<Vpe?7:r<jpe?8:r<qpe?9:10},Gpe={encode:xpe,decode:kpe,encodingLength:Kpe},$1=Gpe;const r3=(r,e=0)=>[$1.decode(r,e),$1.decode.bytes],R1=(r,e,t=0)=>($1.encode(r,e,t),e),T1=r=>$1.encodingLength(r),Hpe=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},U4=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Wpe=r=>new TextEncoder().encode(r),Qpe=r=>new TextDecoder().decode(r),n3=(r,e)=>{const t=e.byteLength,n=T1(r),s=n+T1(t),i=new Uint8Array(s+t);return R1(r,i,0),R1(t,i,n),i.set(e,s),new B4(r,t,e,i)},k2=r=>{const e=U4(r),[t,n]=r3(e),[s,i]=r3(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new B4(t,s,o,e)},Ype=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Hpe(r.bytes,t.bytes)}};let B4=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function Xpe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var Jpe=Xpe,Zpe=Jpe;let e1e=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},t1e=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return pO(this,e)}},r1e=class{constructor(e){this.decoders=e}or(e){return pO(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const pO=(r,e)=>new r1e({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let n1e=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new e1e(e,t,n),this.decoder=new t1e(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const N2=({name:r,prefix:e,encode:t,decode:n})=>new n1e(r,e,t,n),Bh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Zpe(t,e);return N2({prefix:r,name:e,encode:n,decode:i=>U4(s(i))})},s1e=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},i1e=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},rr=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>N2({prefix:e,name:r,encode(s){return i1e(s,n,t)},decode(s){return s1e(s,n,t,r)}}),ws=Bh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),o1e=Bh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),a1e=Object.freeze(Object.defineProperty({__proto__:null,base58btc:ws,base58flickr:o1e},Symbol.toStringTag,{value:"Module"})),yn=rr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),c1e=rr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),l1e=rr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),u1e=rr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),d1e=rr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),h1e=rr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),f1e=rr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),p1e=rr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),g1e=rr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),y1e=Object.freeze(Object.defineProperty({__proto__:null,base32:yn,base32hex:d1e,base32hexpad:f1e,base32hexpadupper:p1e,base32hexupper:h1e,base32pad:l1e,base32padupper:u1e,base32upper:c1e,base32z:g1e},Symbol.toStringTag,{value:"Module"})),r_=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return b1e(t,s3(r),e||ws.encoder);default:return m1e(t,s3(r),e||yn.encoder)}},n_=new WeakMap,s3=r=>{const e=n_.get(r);if(e==null){const t=new Map;return n_.set(r,t),t}return e};let ei=class _r{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==hu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==E1e)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return _r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=n3(e,t);return _r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return _r.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Ype(e.multihash,n.multihash)}toString(e){return r_(this,e)}toJSON(){return{"/":r_(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof _r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new _r(n,s,i,o||s_(n,s,i.bytes))}else if(t[v1e]===!0){const{version:n,multihash:s,code:i}=t,o=k2(s);return _r.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==hu)throw new Error(`Version 0 CID must use dag-pb (code: ${hu}) block encoding`);return new _r(e,t,n,n.bytes)}case 1:{const s=s_(e,t,n.bytes);return new _r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return _r.create(0,hu,e)}static createV1(e,t){return _r.create(1,e,t)}static decode(e){const[t,n]=_r.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=_r.inspectBytes(e),n=t.size-t.multihashSize,s=U4(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new B4(t.multihashCode,t.digestSize,i,s);return[t.version===0?_r.createV0(o):_r.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=r3(e.subarray(t));return t+=f,d};let s=n(),i=hu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=w1e(e,t),i=_r.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return s3(i).set(n,e),i}};const w1e=(r,e)=>{switch(r[0]){case"Q":{const t=e||ws;return[ws.prefix,t.decode(`${ws.prefix}${r}`)]}case ws.prefix:{const t=e||ws;return[ws.prefix,t.decode(r)]}case yn.prefix:{const t=e||yn;return[yn.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},b1e=(r,e,t)=>{const{prefix:n}=t;if(n!==ws.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},m1e=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},hu=112,E1e=18,s_=(r,e,t)=>{const n=T1(r),s=n+T1(e),i=new Uint8Array(s+t.byteLength);return R1(r,i,0),R1(e,i,n),i.set(t,s),i},v1e=Symbol.for("@ipld/js-cid/CID");async function ll(r){let e=0;for await(const t of r)e++;return e}const _1e=85,S1e=le("ipfs:repo:migrator:migration-8");function gO(r){return r.child?gO(r.child):r}function A1e(r){try{const e=yn.decode(`b${r.toString().toLowerCase().slice(1)}`),t=ei.decode(e).multihash.bytes,n=yn.encode(t).slice(1).toUpperCase();return new ie(`/${n}`,!1)}catch{return r}}function $1e(r){try{const e=yn.decode(`b${r.toString().toLowerCase().slice(1)}`),t=k2(e),n=yn.encode(ei.createV1(_1e,t).bytes).slice(1);return new ie(`/${n.toUpperCase()}`,!1)}catch{return r}}async function i_(r,e,t){const n=r.blocks;await n.open();const s=gO(n),i=await ll(s.queryKeys({filters:[o=>t(o).toString()!==o.toString()]}));try{let o=0;for await(const a of s.query({})){const c=t(a.key);c.toString()!==a.key.toString()&&(o+=1,S1e(`Migrating Block from ${a.key} to ${c}`,await s.has(a.key)),await s.delete(a.key),await s.put(c,a.value),e(o/i*100,`Migrated Block from ${a.key} to ${c}`))}}finally{await n.close()}}const R1e={version:8,description:"Transforms key names into base32 encoding and converts Block store to use bare multihashes encoded as base32",migrate:(r,e=()=>{})=>i_(r,e,A1e),revert:(r,e=()=>{})=>i_(r,e,$1e)},o_=X.Reader,T1e=X.Writer;X.util;const If=X.roots.default||(X.roots.default={}),I1e=If.ipfs=(()=>{const r={};return r.pin=function(){const e={};return e.Set=function(){function t(n){if(n)for(var s=Object.keys(n),i=0;i<s.length;++i)n[s[i]]!=null&&(this[s[i]]=n[s[i]])}return t.prototype.version=0,t.prototype.fanout=0,t.prototype.seed=0,t.encode=function(s,i){return i||(i=T1e.create()),s.version!=null&&Object.hasOwnProperty.call(s,"version")&&i.uint32(8).uint32(s.version),s.fanout!=null&&Object.hasOwnProperty.call(s,"fanout")&&i.uint32(16).uint32(s.fanout),s.seed!=null&&Object.hasOwnProperty.call(s,"seed")&&i.uint32(29).fixed32(s.seed),i},t.decode=function(s,i){s instanceof o_||(s=o_.create(s));for(var o=i===void 0?s.len:s.pos+i,a=new If.ipfs.pin.Set;s.pos<o;){var c=s.uint32();switch(c>>>3){case 1:a.version=s.uint32();break;case 2:a.fanout=s.uint32();break;case 3:a.seed=s.fixed32();break;default:s.skipType(c&7);break}}return a},t.fromObject=function(s){if(s instanceof If.ipfs.pin.Set)return s;var i=new If.ipfs.pin.Set;return s.version!=null&&(i.version=s.version>>>0),s.fanout!=null&&(i.fanout=s.fanout>>>0),s.seed!=null&&(i.seed=s.seed>>>0),i},t.toObject=function(s,i){i||(i={});var o={};return i.defaults&&(o.version=0,o.fanout=0,o.seed=0),s.version!=null&&s.hasOwnProperty("version")&&(o.version=s.version),s.fanout!=null&&s.hasOwnProperty("fanout")&&(o.fanout=s.fanout),s.seed!=null&&s.hasOwnProperty("seed")&&(o.seed=s.seed),o},t.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},t}(),e}(),r})();var i3={exports:{}};(function(r,e){Object.defineProperty(e,"__esModule",{value:!0}),t.BASE=2166136261;function t(n,s=t.BASE){const i=n.length;for(let o=0;o<i;o++)s^=n.charCodeAt(o),s+=(s<<1)+(s<<4)+(s<<7)+(s<<8)+(s<<24);return s>>>0}e.default=t,r.exports=t})(i3,i3.exports);var C1e=i3.exports;const x1e=Ge(C1e),fp=new ie("/local/pins"),wy=256,D1e=8192,yO=ei.parse("QmdfTbBqBPQ7VNxZEYEj14VmRuZBkqFbiwReogJgS1zR1n"),Lc={direct:"direct",recursive:"recursive"};function a_(r){return new ie(`/${yn.encode(r.multihash.bytes).toUpperCase().substring(1)}`)}const O1e=({name:r,code:e,encode:t})=>new P1e(r,e,t);let P1e=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?n3(this.code,t):t.then(n=>n3(this.code,n))}else throw Error("Unknown type, must be binary type")}};const k1e=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),z4=O1e({name:"sha2-256",code:18,encode:k1e("SHA-256")}),o3=I1e.pin.Set;function N1e(r){const e=r.Data;if(!e)throw new Error("No data present");const t=D.decode(e),n=D.decode.bytes??0;if(n<=0)throw new Error("Invalid Set header length");if(n+t>e.length)throw new Error("Impossibly large set header length");const s=e.slice(n,t+n),i=o3.toObject(o3.decode(s),{defaults:!1,arrays:!0,longs:Number,objects:!1});if(i.version!==1)throw new Error(`Unsupported Set version: ${i.version}`);if(i.fanout>r.Links.length)throw new Error("Impossibly large fanout");return{header:i,data:e.slice(t+n)}}function L1e(r,e){const t=new Uint8Array(4);new DataView(t.buffer).setUint32(0,r,!0);const s=L(e.toString()),i=M([t,s],t.byteLength+s.byteLength);return x1e(C(i))}async function*wO(r,e){const t=N1e(e);let n=0;for(const s of e.Links){if(n<t.header.fanout){const i=s.Hash;if(!yO.equals(i)){const o=await r.get(i),a=Lt(o);yield*wO(r,a)}}else yield s.Hash;n++}}async function*Cf(r,e,t){const n=e.Links.find(o=>o.Name===t);if(!n)throw new Error("No link found with name "+t);const s=await r.get(n.Hash),i=Lt(s);yield*wO(r,i)}function M1e(r,e){return t(e,0);async function t(n,s){const i=o3.encode({version:1,fanout:wy,seed:s}).finish(),o=D.encode(i.length),a=M([o,i]),c=[];for(let l=0;l<wy;l++)c.push({Name:"",Tsize:1,Hash:yO});if(n.length<=D1e){const l=n.map(g=>({link:{Name:"",Tsize:1,Hash:g.key},data:g.data||new Uint8Array})).sort((g,h)=>Sw(g.link.Hash.bytes,h.link.Hash.bytes)),d=c.concat(l.map(g=>g.link));return{Data:M([a,...l.map(g=>g.data)]),Links:d}}else{const l=n.reduce((f,g)=>{const h=L1e(s,g.key)%wy;return f[h]=h in f?f[h].concat([g]):[g],f},[]);let d=0;for(const f of l){const g=await t(f,s+1);await u(g,d),d++}return{Data:a,Links:c}}async function u(l,d){const f=Je(l),g=await z4.digest(f),h=ei.createV0(g);await r.put(h,f);const p=l.Links.reduce((w,y)=>w+(y.Tsize||0),0)+f.length;c[d]={Name:"",Tsize:p,Hash:h}}}}async function c_(r,e,t){const n=await M1e(r,t.map(c=>({key:c}))),s=Je(n),i=await z4.digest(s),o=ei.createV0(i);await r.put(o,s);const a=n.Links.reduce((c,u)=>c+u.Tsize,0)+s.length;return{Name:e,Tsize:a,Hash:o}}async function U1e(r,e,t,n){if(!await e.has(fp))return;const s=await e.get(fp),i=ei.decode(s),o=await r.get(i),a=Lt(o);let c=0;const u=await ll(Cf(r,a,Lc.recursive))+await ll(Cf(r,a,Lc.direct));for await(const l of Cf(r,a,Lc.recursive)){c++;const d={depth:1/0};l.version!==0&&(d.version=l.version),l.code!==ht&&(d.codec=l.code),await t.put(a_(l),Ad(d)),n(c/u*100,`Migrated recursive pin ${l}`)}for await(const l of Cf(r,a,Lc.direct)){c++;const d={depth:0};l.version!==0&&(d.version=l.version),l.code!==ht&&(d.codec=l.code),await t.put(a_(l),Ad(d)),n(c/u*100,`Migrated direct pin ${l}`)}await r.delete(i),await e.delete(fp)}async function B1e(r,e,t,n){const s=[],i=[];let o=0;const a=await ll(t.queryKeys({}));for await(const{key:f,value:g}of t.query({})){o++;const h=to(g),p=ei.create(h.version||0,h.codec||ht,k2(yn.decode("b"+f.toString().toLowerCase().split("/").pop())));h.depth===0?(n(o/a*100,`Reverted direct pin ${p}`),i.push(p)):(n(o/a*100,`Reverted recursive pin ${p}`),s.push(p))}n(100,"Updating pin root");const c={Links:[await c_(r,Lc.direct,i),await c_(r,Lc.recursive,s)]},u=Je(c),l=await z4.digest(u),d=ei.createV0(l);await r.put(d,u),await e.put(fp,d.bytes)}async function l_(r,e,t){const n=r.blocks,s=r.datastore,i=r.pins;await n.open(),await s.open(),await i.open();try{await t(n,s,i,e)}finally{await i.close(),await s.close(),await n.close()}}const z1e={version:9,description:"Migrates pins to datastore",migrate:(r,e=()=>{})=>l_(r,e,U1e),revert:(r,e=()=>{})=>l_(r,e,B1e)},F1e=new ie("/config"),F4=new ie("/version");function L2(r){let e=r;for(;e.db||e.child;)if(e=e.db||e.child,e.type==="level-js"||e.constructor.name==="Level")return e}async function V1e(r,e,t){const n=await e(r);if(n)return n;const s=L2(t);return s?new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{i(!!a.result)}}):!1}async function j1e(r,e,t,n){if(await t(r))return e(r);const s=L2(n);if(!s)throw Js();return new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{if(a.result)return i(a.result);o(Js())}})}function xf(r){const e=r.get.bind(r),t=r.has.bind(r);return r.get=n=>j1e(n,e,t,r),r.has=n=>V1e(n,t,r),r}function bO(r){return{...r,root:xf(r.root),datastore:xf(r.datastore),pins:xf(r.pins),keys:xf(r.keys)}}async function q1e(r,e,t=()=>{}){const n=L2(e);if(!n){t(`${r} did not need an upgrade`);return}t(`Upgrading ${r}`),await EO(n,(i,o)=>[{type:"del",key:i},{type:"put",key:L(i),value:o}])}async function K1e(r,e,t=()=>{}){const n=L2(e);if(!n){t(`${r} did not need a downgrade`);return}t(`Downgrading ${r}`),await EO(n,(i,o)=>[{type:"del",key:i},{type:"put",key:C(i),value:o}])}function mO(r){return r.child?mO(r.child):r}async function u_(r,e,t){const n=Object.entries(r).map(([o,a])=>({key:o,backend:mO(a)})).filter(({key:o,backend:a})=>a.constructor.name==="LevelDatastore").map(({key:o,backend:a})=>({name:o,store:a}));e(0,`Migrating ${n.length} dbs`);let s=0;const i=o=>{e(Math.round(s/n.length*100),o)};for(const{name:o,store:a}of n){await a.open();try{await t(o,a,i)}finally{s++,await a.close()}}e(100,`Migrated ${n.length} dbs`)}const G1e={version:10,description:"Migrates datastore-level keys to binary",migrate:(r,e=()=>{})=>u_(r,e,q1e),revert:(r,e=()=>{})=>u_(r,e,K1e)};function EO(r,e){function t(n,s){const i=r.store("readwrite"),o=i.transaction;let a=0,c;o.onabort=()=>s(c||o.error||new Error("aborted by user")),o.oncomplete=()=>s();function u(){const l=n[a++],d=l.key;let f;try{f=l.type==="del"?i.delete(d):i.put(l.value,d)}catch(g){c=g,o.abort();return}a<n.length&&(f.onsuccess=u)}u()}return new Promise((n,s)=>{const i=r.iterator(),o=c=>c;i._deserializeKey=i._deserializeValue=o,a();function a(){const c=(u,l,d)=>{if(u||l===void 0){const f=g=>{if(g){s(g);return}n()};i.end(f);return}t(e(l,d),a)};i.next(c)}})}const So=new ie("/local/filesroot");async function H1e(r,e=()=>{}){if(e(100,"Migrating MFS root to repo datastore"),await r.root.open(),await r.datastore.open(),await r.root.has(So)){const t=await r.root.get(So);await r.datastore.put(So,t),await r.root.delete(So)}await r.datastore.close(),await r.root.close(),e(100,"Stored MFS root in repo datastore")}async function W1e(r,e=()=>{}){if(e(100,"Migrating MFS root to repo root datastore"),await r.root.open(),await r.datastore.open(),await r.datastore.has(So)){const t=await r.datastore.get(So);await r.root.put(So,t),await r.datastore.delete(So)}await r.datastore.close(),await r.root.close(),e(100,"Stored MFS root in repo root datastore")}const Q1e={version:11,description:"Store mfs root in the datastore",migrate:H1e,revert:W1e},d_=X.Reader,Y1e=X.Writer,X1e=X.util,Df=X.roots.default||(X.roots.default={}),vO=Df.Protocols=(()=>{function r(e){if(this.protocols=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.protocols=X1e.emptyArray,r.encode=function(t,n){if(n||(n=Y1e.create()),t.protocols!=null&&t.protocols.length)for(var s=0;s<t.protocols.length;++s)n.uint32(10).string(t.protocols[s]);return n},r.decode=function(t,n){t instanceof d_||(t=d_.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new Df.Protocols;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.protocols&&i.protocols.length||(i.protocols=[]),i.protocols.push(t.string());break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof Df.Protocols)return t;var n=new Df.Protocols;if(t.protocols){if(!Array.isArray(t.protocols))throw TypeError(".Protocols.protocols: array expected");n.protocols=[];for(var s=0;s<t.protocols.length;++s)n.protocols[s]=String(t.protocols[s])}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.protocols=[]),t.protocols&&t.protocols.length){s.protocols=[];for(var i=0;i<t.protocols.length;++i)s.protocols[i]=t.protocols[i]}return s},r.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},r})(),hc=X.Reader,by=X.Writer,nt=X.util,Ut=X.roots.default||(X.roots.default={}),_O=Ut.Addresses=(()=>{function r(e){if(this.addrs=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.addrs=nt.emptyArray,r.prototype.certifiedRecord=null,r.encode=function(t,n){if(n||(n=by.create()),t.addrs!=null&&t.addrs.length)for(var s=0;s<t.addrs.length;++s)Ut.Addresses.Address.encode(t.addrs[s],n.uint32(10).fork()).ldelim();return t.certifiedRecord!=null&&Object.hasOwnProperty.call(t,"certifiedRecord")&&Ut.Addresses.CertifiedRecord.encode(t.certifiedRecord,n.uint32(18).fork()).ldelim(),n},r.decode=function(t,n){t instanceof hc||(t=hc.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new Ut.Addresses;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.addrs&&i.addrs.length||(i.addrs=[]),i.addrs.push(Ut.Addresses.Address.decode(t,t.uint32()));break;case 2:i.certifiedRecord=Ut.Addresses.CertifiedRecord.decode(t,t.uint32());break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof Ut.Addresses)return t;var n=new Ut.Addresses;if(t.addrs){if(!Array.isArray(t.addrs))throw TypeError(".Addresses.addrs: array expected");n.addrs=[];for(var s=0;s<t.addrs.length;++s){if(typeof t.addrs[s]!="object")throw TypeError(".Addresses.addrs: object expected");n.addrs[s]=Ut.Addresses.Address.fromObject(t.addrs[s])}}if(t.certifiedRecord!=null){if(typeof t.certifiedRecord!="object")throw TypeError(".Addresses.certifiedRecord: object expected");n.certifiedRecord=Ut.Addresses.CertifiedRecord.fromObject(t.certifiedRecord)}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.addrs=[]),n.defaults&&(s.certifiedRecord=null),t.addrs&&t.addrs.length){s.addrs=[];for(var i=0;i<t.addrs.length;++i)s.addrs[i]=Ut.Addresses.Address.toObject(t.addrs[i],n)}return t.certifiedRecord!=null&&t.hasOwnProperty("certifiedRecord")&&(s.certifiedRecord=Ut.Addresses.CertifiedRecord.toObject(t.certifiedRecord,n)),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},r.Address=function(){function e(n){if(n)for(var s=Object.keys(n),i=0;i<s.length;++i)n[s[i]]!=null&&(this[s[i]]=n[s[i]])}e.prototype.multiaddr=nt.newBuffer([]),e.prototype.isCertified=null;let t;return Object.defineProperty(e.prototype,"_isCertified",{get:nt.oneOfGetter(t=["isCertified"]),set:nt.oneOfSetter(t)}),e.encode=function(s,i){return i||(i=by.create()),s.multiaddr!=null&&Object.hasOwnProperty.call(s,"multiaddr")&&i.uint32(10).bytes(s.multiaddr),s.isCertified!=null&&Object.hasOwnProperty.call(s,"isCertified")&&i.uint32(16).bool(s.isCertified),i},e.decode=function(s,i){s instanceof hc||(s=hc.create(s));for(var o=i===void 0?s.len:s.pos+i,a=new Ut.Addresses.Address;s.pos<o;){var c=s.uint32();switch(c>>>3){case 1:a.multiaddr=s.bytes();break;case 2:a.isCertified=s.bool();break;default:s.skipType(c&7);break}}return a},e.fromObject=function(s){if(s instanceof Ut.Addresses.Address)return s;var i=new Ut.Addresses.Address;return s.multiaddr!=null&&(typeof s.multiaddr=="string"?nt.base64.decode(s.multiaddr,i.multiaddr=nt.newBuffer(nt.base64.length(s.multiaddr)),0):s.multiaddr.length&&(i.multiaddr=s.multiaddr)),s.isCertified!=null&&(i.isCertified=!!s.isCertified),i},e.toObject=function(s,i){i||(i={});var o={};return i.defaults&&(i.bytes===String?o.multiaddr="":(o.multiaddr=[],i.bytes!==Array&&(o.multiaddr=nt.newBuffer(o.multiaddr)))),s.multiaddr!=null&&s.hasOwnProperty("multiaddr")&&(o.multiaddr=i.bytes===String?nt.base64.encode(s.multiaddr,0,s.multiaddr.length):i.bytes===Array?Array.prototype.slice.call(s.multiaddr):s.multiaddr),s.isCertified!=null&&s.hasOwnProperty("isCertified")&&(o.isCertified=s.isCertified,i.oneofs&&(o._isCertified="isCertified")),o},e.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},e}(),r.CertifiedRecord=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.seq=nt.Long?nt.Long.fromBits(0,0,!0):0,e.prototype.raw=nt.newBuffer([]),e.encode=function(n,s){return s||(s=by.create()),n.seq!=null&&Object.hasOwnProperty.call(n,"seq")&&s.uint32(8).uint64(n.seq),n.raw!=null&&Object.hasOwnProperty.call(n,"raw")&&s.uint32(18).bytes(n.raw),s},e.decode=function(n,s){n instanceof hc||(n=hc.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new Ut.Addresses.CertifiedRecord;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.seq=n.uint64();break;case 2:o.raw=n.bytes();break;default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof Ut.Addresses.CertifiedRecord)return n;var s=new Ut.Addresses.CertifiedRecord;return n.seq!=null&&(nt.Long?(s.seq=nt.Long.fromValue(n.seq)).unsigned=!0:typeof n.seq=="string"?s.seq=parseInt(n.seq,10):typeof n.seq=="number"?s.seq=n.seq:typeof n.seq=="object"&&(s.seq=new nt.LongBits(n.seq.low>>>0,n.seq.high>>>0).toNumber(!0))),n.raw!=null&&(typeof n.raw=="string"?nt.base64.decode(n.raw,s.raw=nt.newBuffer(nt.base64.length(n.raw)),0):n.raw.length&&(s.raw=n.raw)),s},e.toObject=function(n,s){s||(s={});var i={};if(s.defaults){if(nt.Long){var o=new nt.Long(0,0,!0);i.seq=s.longs===String?o.toString():s.longs===Number?o.toNumber():o}else i.seq=s.longs===String?"0":0;s.bytes===String?i.raw="":(i.raw=[],s.bytes!==Array&&(i.raw=nt.newBuffer(i.raw)))}return n.seq!=null&&n.hasOwnProperty("seq")&&(typeof n.seq=="number"?i.seq=s.longs===String?String(n.seq):n.seq:i.seq=s.longs===String?nt.Long.prototype.toString.call(n.seq):s.longs===Number?new nt.LongBits(n.seq.low>>>0,n.seq.high>>>0).toNumber(!0):n.seq),n.raw!=null&&n.hasOwnProperty("raw")&&(i.raw=s.bytes===String?nt.base64.encode(n.raw,0,n.raw.length):s.bytes===Array?Array.prototype.slice.call(n.raw):n.raw),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},e}(),r})(),ul=X.Reader,V4=X.Writer,Fe=X.util,It=X.roots.default||(X.roots.default={}),SO=It.Peer=(()=>{function r(t){if(this.addresses=[],this.protocols=[],this.metadata=[],t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}r.prototype.addresses=Fe.emptyArray,r.prototype.protocols=Fe.emptyArray,r.prototype.metadata=Fe.emptyArray,r.prototype.pubKey=null,r.prototype.peerRecordEnvelope=null;let e;return Object.defineProperty(r.prototype,"_pubKey",{get:Fe.oneOfGetter(e=["pubKey"]),set:Fe.oneOfSetter(e)}),Object.defineProperty(r.prototype,"_peerRecordEnvelope",{get:Fe.oneOfGetter(e=["peerRecordEnvelope"]),set:Fe.oneOfSetter(e)}),r.encode=function(n,s){if(s||(s=V4.create()),n.addresses!=null&&n.addresses.length)for(var i=0;i<n.addresses.length;++i)It.Address.encode(n.addresses[i],s.uint32(10).fork()).ldelim();if(n.protocols!=null&&n.protocols.length)for(var i=0;i<n.protocols.length;++i)s.uint32(18).string(n.protocols[i]);if(n.metadata!=null&&n.metadata.length)for(var i=0;i<n.metadata.length;++i)It.Metadata.encode(n.metadata[i],s.uint32(26).fork()).ldelim();return n.pubKey!=null&&Object.hasOwnProperty.call(n,"pubKey")&&s.uint32(34).bytes(n.pubKey),n.peerRecordEnvelope!=null&&Object.hasOwnProperty.call(n,"peerRecordEnvelope")&&s.uint32(42).bytes(n.peerRecordEnvelope),s},r.decode=function(n,s){n instanceof ul||(n=ul.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new It.Peer;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.addresses&&o.addresses.length||(o.addresses=[]),o.addresses.push(It.Address.decode(n,n.uint32()));break;case 2:o.protocols&&o.protocols.length||(o.protocols=[]),o.protocols.push(n.string());break;case 3:o.metadata&&o.metadata.length||(o.metadata=[]),o.metadata.push(It.Metadata.decode(n,n.uint32()));break;case 4:o.pubKey=n.bytes();break;case 5:o.peerRecordEnvelope=n.bytes();break;default:n.skipType(a&7);break}}return o},r.fromObject=function(n){if(n instanceof It.Peer)return n;var s=new It.Peer;if(n.addresses){if(!Array.isArray(n.addresses))throw TypeError(".Peer.addresses: array expected");s.addresses=[];for(var i=0;i<n.addresses.length;++i){if(typeof n.addresses[i]!="object")throw TypeError(".Peer.addresses: object expected");s.addresses[i]=It.Address.fromObject(n.addresses[i])}}if(n.protocols){if(!Array.isArray(n.protocols))throw TypeError(".Peer.protocols: array expected");s.protocols=[];for(var i=0;i<n.protocols.length;++i)s.protocols[i]=String(n.protocols[i])}if(n.metadata){if(!Array.isArray(n.metadata))throw TypeError(".Peer.metadata: array expected");s.metadata=[];for(var i=0;i<n.metadata.length;++i){if(typeof n.metadata[i]!="object")throw TypeError(".Peer.metadata: object expected");s.metadata[i]=It.Metadata.fromObject(n.metadata[i])}}return n.pubKey!=null&&(typeof n.pubKey=="string"?Fe.base64.decode(n.pubKey,s.pubKey=Fe.newBuffer(Fe.base64.length(n.pubKey)),0):n.pubKey.length&&(s.pubKey=n.pubKey)),n.peerRecordEnvelope!=null&&(typeof n.peerRecordEnvelope=="string"?Fe.base64.decode(n.peerRecordEnvelope,s.peerRecordEnvelope=Fe.newBuffer(Fe.base64.length(n.peerRecordEnvelope)),0):n.peerRecordEnvelope.length&&(s.peerRecordEnvelope=n.peerRecordEnvelope)),s},r.toObject=function(n,s){s||(s={});var i={};if((s.arrays||s.defaults)&&(i.addresses=[],i.protocols=[],i.metadata=[]),n.addresses&&n.addresses.length){i.addresses=[];for(var o=0;o<n.addresses.length;++o)i.addresses[o]=It.Address.toObject(n.addresses[o],s)}if(n.protocols&&n.protocols.length){i.protocols=[];for(var o=0;o<n.protocols.length;++o)i.protocols[o]=n.protocols[o]}if(n.metadata&&n.metadata.length){i.metadata=[];for(var o=0;o<n.metadata.length;++o)i.metadata[o]=It.Metadata.toObject(n.metadata[o],s)}return n.pubKey!=null&&n.hasOwnProperty("pubKey")&&(i.pubKey=s.bytes===String?Fe.base64.encode(n.pubKey,0,n.pubKey.length):s.bytes===Array?Array.prototype.slice.call(n.pubKey):n.pubKey,s.oneofs&&(i._pubKey="pubKey")),n.peerRecordEnvelope!=null&&n.hasOwnProperty("peerRecordEnvelope")&&(i.peerRecordEnvelope=s.bytes===String?Fe.base64.encode(n.peerRecordEnvelope,0,n.peerRecordEnvelope.length):s.bytes===Array?Array.prototype.slice.call(n.peerRecordEnvelope):n.peerRecordEnvelope,s.oneofs&&(i._peerRecordEnvelope="peerRecordEnvelope")),i},r.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},r})();It.Address=(()=>{function r(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}r.prototype.multiaddr=Fe.newBuffer([]),r.prototype.isCertified=null;let e;return Object.defineProperty(r.prototype,"_isCertified",{get:Fe.oneOfGetter(e=["isCertified"]),set:Fe.oneOfSetter(e)}),r.encode=function(n,s){return s||(s=V4.create()),n.multiaddr!=null&&Object.hasOwnProperty.call(n,"multiaddr")&&s.uint32(10).bytes(n.multiaddr),n.isCertified!=null&&Object.hasOwnProperty.call(n,"isCertified")&&s.uint32(16).bool(n.isCertified),s},r.decode=function(n,s){n instanceof ul||(n=ul.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new It.Address;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.multiaddr=n.bytes();break;case 2:o.isCertified=n.bool();break;default:n.skipType(a&7);break}}return o},r.fromObject=function(n){if(n instanceof It.Address)return n;var s=new It.Address;return n.multiaddr!=null&&(typeof n.multiaddr=="string"?Fe.base64.decode(n.multiaddr,s.multiaddr=Fe.newBuffer(Fe.base64.length(n.multiaddr)),0):n.multiaddr.length&&(s.multiaddr=n.multiaddr)),n.isCertified!=null&&(s.isCertified=!!n.isCertified),s},r.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.multiaddr="":(i.multiaddr=[],s.bytes!==Array&&(i.multiaddr=Fe.newBuffer(i.multiaddr)))),n.multiaddr!=null&&n.hasOwnProperty("multiaddr")&&(i.multiaddr=s.bytes===String?Fe.base64.encode(n.multiaddr,0,n.multiaddr.length):s.bytes===Array?Array.prototype.slice.call(n.multiaddr):n.multiaddr),n.isCertified!=null&&n.hasOwnProperty("isCertified")&&(i.isCertified=n.isCertified,s.oneofs&&(i._isCertified="isCertified")),i},r.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},r})();It.Metadata=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.key="",r.prototype.value=Fe.newBuffer([]),r.encode=function(t,n){return n||(n=V4.create()),t.key!=null&&Object.hasOwnProperty.call(t,"key")&&n.uint32(10).string(t.key),t.value!=null&&Object.hasOwnProperty.call(t,"value")&&n.uint32(18).bytes(t.value),n},r.decode=function(t,n){t instanceof ul||(t=ul.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new It.Metadata;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.key=t.string();break;case 2:i.value=t.bytes();break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof It.Metadata)return t;var n=new It.Metadata;return t.key!=null&&(n.key=String(t.key)),t.value!=null&&(typeof t.value=="string"?Fe.base64.decode(t.value,n.value=Fe.newBuffer(Fe.base64.length(t.value)),0):t.value.length&&(n.value=t.value)),n},r.toObject=function(t,n){n||(n={});var s={};return n.defaults&&(s.key="",n.bytes===String?s.value="":(s.value=[],n.bytes!==Array&&(s.value=Fe.newBuffer(s.value)))),t.key!=null&&t.hasOwnProperty("key")&&(s.key=t.key),t.value!=null&&t.hasOwnProperty("value")&&(s.value=n.bytes===String?Fe.base64.encode(t.value,0,t.value.length):n.bytes===Array?Array.prototype.slice.call(t.value):t.value),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},r})();const h_=X.Reader,J1e=X.Writer,st=X.util,Of=X.roots.default||(X.roots.default={}),Z1e=Of.Envelope=(()=>{function r(e){if(e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.publicKey=st.newBuffer([]),r.prototype.payloadType=st.newBuffer([]),r.prototype.payload=st.newBuffer([]),r.prototype.signature=st.newBuffer([]),r.encode=function(t,n){return n||(n=J1e.create()),t.publicKey!=null&&Object.hasOwnProperty.call(t,"publicKey")&&n.uint32(10).bytes(t.publicKey),t.payloadType!=null&&Object.hasOwnProperty.call(t,"payloadType")&&n.uint32(18).bytes(t.payloadType),t.payload!=null&&Object.hasOwnProperty.call(t,"payload")&&n.uint32(26).bytes(t.payload),t.signature!=null&&Object.hasOwnProperty.call(t,"signature")&&n.uint32(42).bytes(t.signature),n},r.decode=function(t,n){t instanceof h_||(t=h_.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new Of.Envelope;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.publicKey=t.bytes();break;case 2:i.payloadType=t.bytes();break;case 3:i.payload=t.bytes();break;case 5:i.signature=t.bytes();break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof Of.Envelope)return t;var n=new Of.Envelope;return t.publicKey!=null&&(typeof t.publicKey=="string"?st.base64.decode(t.publicKey,n.publicKey=st.newBuffer(st.base64.length(t.publicKey)),0):t.publicKey.length&&(n.publicKey=t.publicKey)),t.payloadType!=null&&(typeof t.payloadType=="string"?st.base64.decode(t.payloadType,n.payloadType=st.newBuffer(st.base64.length(t.payloadType)),0):t.payloadType.length&&(n.payloadType=t.payloadType)),t.payload!=null&&(typeof t.payload=="string"?st.base64.decode(t.payload,n.payload=st.newBuffer(st.base64.length(t.payload)),0):t.payload.length&&(n.payload=t.payload)),t.signature!=null&&(typeof t.signature=="string"?st.base64.decode(t.signature,n.signature=st.newBuffer(st.base64.length(t.signature)),0):t.signature.length&&(n.signature=t.signature)),n},r.toObject=function(t,n){n||(n={});var s={};return n.defaults&&(n.bytes===String?s.publicKey="":(s.publicKey=[],n.bytes!==Array&&(s.publicKey=st.newBuffer(s.publicKey))),n.bytes===String?s.payloadType="":(s.payloadType=[],n.bytes!==Array&&(s.payloadType=st.newBuffer(s.payloadType))),n.bytes===String?s.payload="":(s.payload=[],n.bytes!==Array&&(s.payload=st.newBuffer(s.payload))),n.bytes===String?s.signature="":(s.signature=[],n.bytes!==Array&&(s.signature=st.newBuffer(s.signature)))),t.publicKey!=null&&t.hasOwnProperty("publicKey")&&(s.publicKey=n.bytes===String?st.base64.encode(t.publicKey,0,t.publicKey.length):n.bytes===Array?Array.prototype.slice.call(t.publicKey):t.publicKey),t.payloadType!=null&&t.hasOwnProperty("payloadType")&&(s.payloadType=n.bytes===String?st.base64.encode(t.payloadType,0,t.payloadType.length):n.bytes===Array?Array.prototype.slice.call(t.payloadType):t.payloadType),t.payload!=null&&t.hasOwnProperty("payload")&&(s.payload=n.bytes===String?st.base64.encode(t.payload,0,t.payload.length):n.bytes===Array?Array.prototype.slice.call(t.payload):t.payload),t.signature!=null&&t.hasOwnProperty("signature")&&(s.signature=n.bytes===String?st.base64.encode(t.signature,0,t.signature.length):n.bytes===Array?Array.prototype.slice.call(t.signature):t.signature),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},r})(),Pf=X.Reader,f_=X.Writer,yt=X.util,is=X.roots.default||(X.roots.default={}),e0e=is.PeerRecord=(()=>{function r(e){if(this.addresses=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.peerId=yt.newBuffer([]),r.prototype.seq=yt.Long?yt.Long.fromBits(0,0,!0):0,r.prototype.addresses=yt.emptyArray,r.encode=function(t,n){if(n||(n=f_.create()),t.peerId!=null&&Object.hasOwnProperty.call(t,"peerId")&&n.uint32(10).bytes(t.peerId),t.seq!=null&&Object.hasOwnProperty.call(t,"seq")&&n.uint32(16).uint64(t.seq),t.addresses!=null&&t.addresses.length)for(var s=0;s<t.addresses.length;++s)is.PeerRecord.AddressInfo.encode(t.addresses[s],n.uint32(26).fork()).ldelim();return n},r.decode=function(t,n){t instanceof Pf||(t=Pf.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new is.PeerRecord;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:i.peerId=t.bytes();break;case 2:i.seq=t.uint64();break;case 3:i.addresses&&i.addresses.length||(i.addresses=[]),i.addresses.push(is.PeerRecord.AddressInfo.decode(t,t.uint32()));break;default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof is.PeerRecord)return t;var n=new is.PeerRecord;if(t.peerId!=null&&(typeof t.peerId=="string"?yt.base64.decode(t.peerId,n.peerId=yt.newBuffer(yt.base64.length(t.peerId)),0):t.peerId.length&&(n.peerId=t.peerId)),t.seq!=null&&(yt.Long?(n.seq=yt.Long.fromValue(t.seq)).unsigned=!0:typeof t.seq=="string"?n.seq=parseInt(t.seq,10):typeof t.seq=="number"?n.seq=t.seq:typeof t.seq=="object"&&(n.seq=new yt.LongBits(t.seq.low>>>0,t.seq.high>>>0).toNumber(!0))),t.addresses){if(!Array.isArray(t.addresses))throw TypeError(".PeerRecord.addresses: array expected");n.addresses=[];for(var s=0;s<t.addresses.length;++s){if(typeof t.addresses[s]!="object")throw TypeError(".PeerRecord.addresses: object expected");n.addresses[s]=is.PeerRecord.AddressInfo.fromObject(t.addresses[s])}}return n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.addresses=[]),n.defaults)if(n.bytes===String?s.peerId="":(s.peerId=[],n.bytes!==Array&&(s.peerId=yt.newBuffer(s.peerId))),yt.Long){var i=new yt.Long(0,0,!0);s.seq=n.longs===String?i.toString():n.longs===Number?i.toNumber():i}else s.seq=n.longs===String?"0":0;if(t.peerId!=null&&t.hasOwnProperty("peerId")&&(s.peerId=n.bytes===String?yt.base64.encode(t.peerId,0,t.peerId.length):n.bytes===Array?Array.prototype.slice.call(t.peerId):t.peerId),t.seq!=null&&t.hasOwnProperty("seq")&&(typeof t.seq=="number"?s.seq=n.longs===String?String(t.seq):t.seq:s.seq=n.longs===String?yt.Long.prototype.toString.call(t.seq):n.longs===Number?new yt.LongBits(t.seq.low>>>0,t.seq.high>>>0).toNumber(!0):t.seq),t.addresses&&t.addresses.length){s.addresses=[];for(var o=0;o<t.addresses.length;++o)s.addresses[o]=is.PeerRecord.AddressInfo.toObject(t.addresses[o],n)}return s},r.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},r.AddressInfo=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.multiaddr=yt.newBuffer([]),e.encode=function(n,s){return s||(s=f_.create()),n.multiaddr!=null&&Object.hasOwnProperty.call(n,"multiaddr")&&s.uint32(10).bytes(n.multiaddr),s},e.decode=function(n,s){n instanceof Pf||(n=Pf.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new is.PeerRecord.AddressInfo;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:o.multiaddr=n.bytes();break;default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof is.PeerRecord.AddressInfo)return n;var s=new is.PeerRecord.AddressInfo;return n.multiaddr!=null&&(typeof n.multiaddr=="string"?yt.base64.decode(n.multiaddr,s.multiaddr=yt.newBuffer(yt.base64.length(n.multiaddr)),0):n.multiaddr.length&&(s.multiaddr=n.multiaddr)),s},e.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.multiaddr="":(i.multiaddr=[],s.bytes!==Array&&(i.multiaddr=yt.newBuffer(i.multiaddr)))),n.multiaddr!=null&&n.hasOwnProperty("multiaddr")&&(i.multiaddr=s.bytes===String?yt.base64.encode(n.multiaddr,0,n.multiaddr.length):s.bytes===Array?Array.prototype.slice.call(n.multiaddr):n.multiaddr),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},e}(),r})(),p_=es,t0e=ts,AO=function(r){let e=0;if(r=r.toString().trim(),p_(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(t0e(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=p_(t[n]);let o;i&&(o=AO(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},r0e=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Cn=-1,I1={},a3={},n0e=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Cn,"ip6zone"],[43,8,"ipcidr"],[53,Cn,"dns",!0],[54,Cn,"dns4",!0],[55,Cn,"dns6",!0],[56,Cn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc"],[281,0,"webrtc-w3c"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Cn,"unix",!1,!0],[421,Cn,"ipfs"],[421,Cn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Cn,"garlic64"],[448,0,"tls"],[449,Cn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Cn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Cn,"memory"]];n0e.forEach(r=>{const e=s0e(...r);a3[e.code]=e,I1[e.name]=e});function s0e(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function xt(r){if(typeof r=="number"){if(a3[r]!=null)return a3[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(I1[r]!=null)return I1[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}const i0e=N2({prefix:"\0",name:"identity",encode:r=>Qpe(r),decode:r=>Wpe(r)}),o0e=Object.freeze(Object.defineProperty({__proto__:null,identity:i0e},Symbol.toStringTag,{value:"Module"})),a0e=rr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),c0e=Object.freeze(Object.defineProperty({__proto__:null,base2:a0e},Symbol.toStringTag,{value:"Module"})),l0e=rr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),u0e=Object.freeze(Object.defineProperty({__proto__:null,base8:l0e},Symbol.toStringTag,{value:"Module"})),d0e=Bh({prefix:"9",name:"base10",alphabet:"0123456789"}),h0e=Object.freeze(Object.defineProperty({__proto__:null,base10:d0e},Symbol.toStringTag,{value:"Module"})),f0e=rr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),p0e=rr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),g0e=Object.freeze(Object.defineProperty({__proto__:null,base16:f0e,base16upper:p0e},Symbol.toStringTag,{value:"Module"})),y0e=Bh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),w0e=Bh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),b0e=Object.freeze(Object.defineProperty({__proto__:null,base36:y0e,base36upper:w0e},Symbol.toStringTag,{value:"Module"})),m0e=rr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),E0e=rr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),v0e=rr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),_0e=rr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),S0e=Object.freeze(Object.defineProperty({__proto__:null,base64:m0e,base64pad:E0e,base64url:v0e,base64urlpad:_0e},Symbol.toStringTag,{value:"Module"})),$O=Array.from(""),A0e=$O.reduce((r,e,t)=>(r[t]=e,r),[]),$0e=$O.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function R0e(r){return r.reduce((e,t)=>(e+=A0e[t],e),"")}function T0e(r){const e=[];for(const t of r){const n=$0e[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const I0e=N2({prefix:"",name:"base256emoji",encode:R0e,decode:T0e}),C0e=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:I0e},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const x0e={...o0e,...c0e,...u0e,...h0e,...g0e,...y1e,...b0e,...a1e,...S0e,...C0e};function D0e(r,e){switch(xt(r).code){case 4:case 41:return k0e(e);case 42:return w_(e);case 6:case 273:case 33:case 132:return RO(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return w_(e);case 421:return U0e(e);case 444:return b_(e);case 445:return b_(e);case 466:return M0e(e);default:return C(e,"base16")}}function O0e(r,e){switch(xt(r).code){case 4:return g_(e);case 41:return g_(e);case 42:return y_(e);case 6:case 273:case 33:case 132:return j4(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return y_(e);case 421:return N0e(e);case 444:return B0e(e);case 445:return z0e(e);case 466:return L0e(e);default:return L(e,"base16")}}const my=Object.values(x0e).map(r=>r.decoder),P0e=function(){let r=my[0].or(my[1]);return my.slice(2).forEach(e=>r=r.or(e)),r}();function g_(r){if(!tt(r))throw new Error("invalid ip address");return AO(r)}function k0e(r){const e=r0e(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function j4(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function RO(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function y_(r){const e=L(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function w_(r){const e=D.decode(r);if(r=r.slice(D.decode.bytes),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function N0e(r){let e;r[0]==="Q"||r[0]==="1"?e=k2(ws.decode(`z${r}`)).bytes:e=ei.parse(r).multihash.bytes;const t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function L0e(r){const e=P0e.decode(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function M0e(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function U0e(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function B0e(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=yn.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=j4(n);return M([t,s],t.length+s.length)}function z0e(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=yn.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=j4(n);return M([t,s],t.length+s.length)}function b_(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=RO(t);return`${n}:${s}`}function F0e(r){const e=[],t=r.split("/").slice(1);if(t.length===1&&t[0]==="")return[];for(let n=0;n<t.length;n++){const s=t[n],i=xt(s);if(i.size===0){e.push([s]);continue}if(n++,n>=t.length)throw xO("invalid address: "+r);if(i.path===!0){e.push([s,K4(t.slice(n).join("/"))]);break}e.push([s,t[n]])}return e}function V0e(r){const e=[];return r.map(t=>{const n=M2(t);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),K4(e.join("/"))}function j0e(r){return r.map(e=>{Array.isArray(e)||(e=[e]);const t=M2(e);return e.length>1?[t.code,O0e(t.code,e[1])]:[t.code]})}function TO(r){return r.map(e=>{const t=M2(e);return e[1]!=null?[t.code,D0e(t.code,e[1])]:[t.code]})}function IO(r){return c3(M(r.map(e=>{const t=M2(e);let n=Uint8Array.from(D.encode(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n})))}function CO(r,e){return r.size>0?r.size/8:r.size===0?0:D.decode(e)+(D.decode.bytes??0)}function q4(r){const e=[];let t=0;for(;t<r.length;){const n=D.decode(r,t),s=D.decode.bytes??0,i=xt(n),o=CO(i,r.slice(t+s));if(o===0){e.push([n]),t+=s;continue}const a=r.slice(t+s,t+s+o);if(t+=o+s,t>r.length)throw xO("Invalid address Uint8Array: "+C(r,"base16"));e.push([n,a])}return e}function m_(r){const e=q4(r),t=TO(e);return V0e(t)}function q0e(r){r=K4(r);const e=F0e(r),t=j0e(e);return IO(t)}function K0e(r){return q0e(r)}function c3(r){const e=G0e(r);if(e!=null)throw e;return Uint8Array.from(r)}function G0e(r){try{q4(r)}catch(e){return e}}function K4(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function xO(r){return new Error("Error parsing address: "+r)}function M2(r){return xt(r[0])}var fc=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Ey=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},fu,pu,gu,E_;const H0e=Symbol.for("nodejs.util.inspect.custom"),W0e=[xt("dns").code,xt("dns4").code,xt("dns6").code,xt("dnsaddr").code],Q0e=new Map,DO=Symbol.for("@multiformats/js-multiaddr/multiaddr");function Y0e(r){return!!r?.[DO]}let X0e=class Ic{constructor(e){if(fu.set(this,void 0),pu.set(this,void 0),gu.set(this,void 0),this[E_]=!0,e==null&&(e=""),e instanceof Uint8Array)this.bytes=c3(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=K0e(e)}else if(Y0e(e))this.bytes=c3(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr")}toString(){return fc(this,fu,"f")==null&&Ey(this,fu,m_(this.bytes),"f"),fc(this,fu,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=xt("tcp"),a=xt("udp"),c=xt("ip4"),u=xt("ip6"),l=xt("dns6"),d=xt("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),W0e.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=xt(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=xt(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map(e=>Object.assign({},xt(e)))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=D.decode(t,n),i=D.decode.bytes??0,o=xt(s),a=CO(o,t.slice(n+i));n+=a+i,e.push(s)}return e}protoNames(){return this.protos().map(e=>e.name)}tuples(){return fc(this,pu,"f")==null&&Ey(this,pu,q4(this.bytes),"f"),fc(this,pu,"f")}stringTuples(){return fc(this,gu,"f")==null&&Ey(this,gu,TO(this.tuples()),"f"),fc(this,gu,"f")}encapsulate(e){return e=new Ic(e),new Ic(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Ic(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new Ic(IO(t.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter(n=>n[0]===I1.ipfs.code).pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C(ws.decode(`z${n}`),"base58btc"):C(ei.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){let e=null;try{e=this.stringTuples().filter(t=>xt(t[0]).path===!0)[0][1],e==null&&(e=null)}catch{e=null}return e}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=Q0e.get(t.name);if(n==null)throw $(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new Ic(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(fu=new WeakMap,pu=new WeakMap,gu=new WeakMap,E_=DO,H0e)](){return`Multiaddr(${m_(this.bytes)})`}};function v_(r){return new X0e(r)}X.util.Long=void 0;X.configure();async function J0e(r,e=()=>{}){e(0,"Storing each peerstore key under a single datastore key"),await r.datastore.open();const t={},n=[];for await(const{key:s,value:i}of r.datastore.query({prefix:"/peers"})){n.push(s);const o=s.toString(),[,a,c,u,l]=o.split("/");if(a==="peers"&&["protos","addrs","metadata","keys"].includes(c)&&u)if(t[u]=t[u]||{addresses:[],protocols:[],metadata:[]},c==="protos"){const d=vO.decode(i);t[u].protocols=d.protocols.sort()}else if(c==="addrs"){const d=_O.decode(i);t[u].addresses=d.addrs.sort((f,g)=>v_(f.multiaddr).toString().localeCompare(v_(g.multiaddr).toString())),d.certifiedRecord&&d.certifiedRecord.raw&&(t[u].peerRecordEnvelope=d.certifiedRecord.raw)}else c==="metadata"?t[u].metadata.push({key:l,value:i}):c==="keys"&&(t[u].pubKey=i)}e(33,"Read peer data from store");for(const s of n)await r.datastore.delete(s);e(66,"Removed existing peer data from store");for(const s of Object.keys(t)){const i=t[s];i.metadata=i.metadata.sort((a,c)=>a.key.localeCompare(c.key));const o=SO.encode(i).finish();await r.datastore.put(new ie(`/peers/${s}`),o)}await r.datastore.close(),e(100,"Stored each peerstore key under a single datastore key")}async function Z0e(r,e=()=>{}){e(0,"Storing each peerstore key under a multiple datastore keys"),await r.datastore.open();const t={},n=[];for await(const{key:s,value:i}of r.datastore.query({prefix:"/peers"})){n.push(s);const o=s.toString(),[,,a]=o.split("/");t[a]=SO.decode(i)}e(33,"Read peer data from store");for(const s of n)await r.datastore.delete(s);e(66,"Removed existing peer data from store");for(const[s,i]of Object.entries(t)){if(i.protocols&&i.protocols.length>0&&await r.datastore.put(new ie(`/peers/protos/${s}`),vO.encode({protocols:i.protocols}).finish()),i.addresses&&i.addresses.length>0){const o=i.peerRecordEnvelope;let a;if(o){const c=Z1e.decode(o),u=e0e.decode(c.payload);a={raw:o,seq:u.seq}}await r.datastore.put(new ie(`/peers/addrs/${s}`),_O.encode({addrs:i.addresses,certifiedRecord:a}).finish())}if(i.metadata&&i.metadata.length>0)for(const{key:o,value:a}of i.metadata)await r.datastore.put(new ie(`/peers/metadata/${s}/${o}`),a);i.pubKey&&await r.datastore.put(new ie(`/peers/keys/${s}`),i.pubKey)}await r.datastore.close(),e(100,"Stored each peerstore key under multiple datastore keys")}const e2e={version:12,description:"Store each peerstore peer under a single datastore key",migrate:J0e,revert:Z0e},Xo={description:"Empty migration.",migrate:()=>{},revert:()=>{},empty:!0},G4=[Object.assign({version:1},Xo),Object.assign({version:2},Xo),Object.assign({version:3},Xo),Object.assign({version:4},Xo),Object.assign({version:5},Xo),Object.assign({version:6},Xo),Object.assign({version:7},Xo),R1e,z1e,G1e,Q1e,e2e];class U2 extends Error{constructor(e){super(e),this.name="NonReversibleMigrationError",this.code=U2.code,this.message=e}}U2.code="ERR_NON_REVERSIBLE_MIGRATION";class zh extends Error{constructor(e){super(e),this.name="NotInitializedRepoError",this.code=zh.code,this.message=e}}zh.code="ERR_NOT_INITIALIZED_REPO";class B2 extends Error{constructor(e){super(e),this.name="RequiredParameterError",this.code=B2.code,this.message=e}}B2.code="ERR_REQUIRED_PARAMETER";class z2 extends Error{constructor(e){super(e),this.name="InvalidValueError",this.code=z2.code,this.message=e}}z2.code="ERR_INVALID_VALUE";class Nl extends Error{constructor(e){super(e),this.name="MissingRepoOptionsError",this.code=Nl.code,this.message=e}}Nl.code="ERR_MISSING_REPO_OPTIONS";const t2e=Object.freeze(Object.defineProperty({__proto__:null,InvalidValueError:z2,MissingRepoOptionsError:Nl,NonReversibleMigrationError:U2,NotInitializedRepoError:zh,RequiredParameterError:B2},Symbol.toStringTag,{value:"Module"})),vy=le("ipfs:repo:migrator:repo:init");async function r2e(r){if(!r)throw new Nl("Please pass repo options when trying to open a repo");const e=r.root;try{await e.open();const t=await e.has(F4),n=await e.has(F1e);return!t||!n?(vy(`Version entry present: ${t}`),vy(`Config entry present: ${n}`),!1):!0}catch(t){return vy("While checking if repo is initialized error was thrown: "+t.message),!1}finally{if(e!==void 0)try{await e.close()}catch{}}}async function OO(r){if(!await r2e(r))throw new zh("Repo is not initialized!");const e=r.root;await e.open();try{return parseInt(C(await e.get(F4)))}finally{await e.close()}}async function C1(r,e){if(!e)throw new Nl("Please pass repo options when trying to open a repo");const t=e.root;await t.open(),await t.put(F4,L(String(r))),await t.close()}const bs=le("ipfs:repo:migrator");function n2e(r){return r=r||G4,!Array.isArray(r)||r.length===0?0:r[r.length-1].version}async function s2e(r,e,t,n,s={}){const i=s.ignoreLock??!1,o=s.onProgress,a=s.isDryRun??!1,c=s.migrations??G4;if(!r)throw new Kn.RequiredParameterError("Path argument is required!");if(!t)throw new Kn.RequiredParameterError("repoOptions argument is required!");if(!n)throw new Kn.RequiredParameterError("toVersion argument is required!");if(!Number.isInteger(n)||n<=0)throw new Kn.InvalidValueError("Version has to be positive integer!");e=bO(e);const u=await OO(e);if(u===n){bs("Nothing to migrate.");return}if(u>n)throw new Kn.InvalidValueError(`Current repo's version (${u}) is higher then toVersion (${n}), you probably wanted to revert it?`);PO(c,u,n);let l;!a&&!i&&(l=await t.repoLock.lock(r));try{for(const d of c){if(n!==void 0&&d.version>n)break;if(!(d.version<=u)){bs(`Migrating version ${d.version}`);try{if(!a){let f=()=>{};o&&(f=(g,h)=>o(d.version,g.toFixed(2),h)),await d.migrate(e,f)}}catch(f){const g=d.version-1;throw bs(`An exception was raised during execution of migration. Setting the repo's version to last successfully migrated version: ${g}`),await C1(g,e),new Error(`During migration to version ${d.version} exception was raised: ${f.stack||f.message||f}`)}bs(`Migrating to version ${d.version} finished`)}}a||await C1(n||n2e(c),e),bs("Repo successfully migrated",n!==void 0?`to version ${n}!`:"to latest version!")}finally{!a&&!i&&l&&await l.close()}}async function i2e(r,e,t,n,s={}){const i=s.ignoreLock??!1,o=s.onProgress,a=s.isDryRun??!1,c=s.migrations??G4;if(!r)throw new Kn.RequiredParameterError("Path argument is required!");if(!t)throw new Kn.RequiredParameterError("repoOptions argument is required!");if(!n)throw new Kn.RequiredParameterError("When reverting migrations, you have to specify to which version to revert!");if(!Number.isInteger(n)||n<=0)throw new Kn.InvalidValueError("Version has to be positive integer!");e=bO(e);const u=await OO(e);if(u===n){bs("Nothing to revert.");return}if(u<n)throw new Kn.InvalidValueError(`Current repo's version (${u}) is lower then toVersion (${n}), you probably wanted to migrate it?`);PO(c,n,u,!0);let l;!a&&!i&&(l=await t.repoLock.lock(r)),bs(`Reverting from version ${u} to ${n}`);try{const d=c.slice().reverse();for(const f of d){if(f.version<=n)break;if(!(f.version>u)){bs(`Reverting migration version ${f.version}`);try{if(!a){let g=()=>{};o&&(g=(h,p)=>o(f.version,h.toFixed(2),p)),await f.revert(e,g)}}catch(g){const h=f.version;throw bs(`An exception was raised during execution of migration. Setting the repo's version to last successfully reverted version: ${h}`),await C1(h,e),g.message=`During reversion to version ${f.version} exception was raised: ${g.message}`,g}bs(`Reverting to version ${f.version} finished`)}}a||await C1(n,e),bs(`All migrations successfully reverted to version ${n}!`)}finally{!a&&!i&&l&&await l.close()}}function PO(r,e,t,n=!1){let s=0;for(const i of r){if(i.version>t)break;if(i.version>e){if(n&&!i.revert)throw new Kn.NonReversibleMigrationError(`It is not possible to revert to version ${e} because migration version ${i.version} is not reversible. Cancelling reversion.`);s++}}if(s!==t-e)throw new Kn.InvalidValueError(`The ipfs-repo-migrations package does not have all migration to migrate from version ${e} to ${t}`)}const Kn=t2e;var F2={exports:{}};/*!
 * bytes
 * Copyright(c) 2012-2014 TJ Holowaychuk
 * Copyright(c) 2015 Jed Watson
 * MIT Licensed
 */F2.exports=l2e;F2.exports.format=kO;F2.exports.parse=NO;var o2e=/\B(?=(\d{3})+(?!\d))/g,a2e=/(?:\.0*|(\.[^0]+)0+)$/,eo={b:1,kb:1024,mb:1<<20,gb:1<<30,tb:Math.pow(1024,4),pb:Math.pow(1024,5)},c2e=/^((-|\+)?(\d+(?:\.\d+)?)) *(kb|mb|gb|tb|pb)$/i;function l2e(r,e){return typeof r=="string"?NO(r):typeof r=="number"?kO(r,e):null}function kO(r,e){if(!Number.isFinite(r))return null;var t=Math.abs(r),n=e&&e.thousandsSeparator||"",s=e&&e.unitSeparator||"",i=e&&e.decimalPlaces!==void 0?e.decimalPlaces:2,o=!!(e&&e.fixedDecimals),a=e&&e.unit||"";(!a||!eo[a.toLowerCase()])&&(t>=eo.pb?a="PB":t>=eo.tb?a="TB":t>=eo.gb?a="GB":t>=eo.mb?a="MB":t>=eo.kb?a="KB":a="B");var c=r/eo[a.toLowerCase()],u=c.toFixed(i);return o||(u=u.replace(a2e,"$1")),n&&(u=u.split(".").map(function(l,d){return d===0?l.replace(o2e,n):l}).join(".")),u+s+a}function NO(r){if(typeof r=="number"&&!isNaN(r))return r;if(typeof r!="string")return null;var e=c2e.exec(r),t,n="b";return e?(t=parseFloat(e[1]),n=e[4].toLowerCase()):(t=parseInt(r,10),n="b"),isNaN(t)?null:Math.floor(eo[n]*t)}var u2e=F2.exports;const d2e=Ge(u2e);class V2 extends Error{constructor(e){super(e),this.name="LockExistsError",this.code=V2.code}}V2.code="ERR_LOCK_EXISTS";class zo extends Error{constructor(e){super(e),this.name="NotFoundError",this.code=zo.code}}zo.code="ERR_NOT_FOUND";class j2 extends Error{constructor(e){super(e),this.name="InvalidRepoVersionError",this.code=j2.code}}j2.code="ERR_INVALID_REPO_VERSION";const ad="ERR_REPO_NOT_INITIALIZED",h2e="ERR_REPO_ALREADY_OPEN",f2e="ERR_REPO_ALREADY_CLOSED";async function LO(r,e,t){const n=await e(r);if(n)return n;const s=UO(t);return s?new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{i(!!a.result)}}):!1}async function MO(r,e,t,n){if(await t(r))return e(r);const s=UO(n);if(!s)throw new zo;return new Promise((i,o)=>{const a=s.store("readonly").get(r.toString());a.transaction.onabort=()=>{o(a.transaction.error)},a.transaction.oncomplete=()=>{if(a.result)return i(a.result);o(new zo)}})}function UO(r){let e=r;for(;e.db||e.child;)if(e=e.db||e.child,e.type==="level-js"||e.constructor.name==="Level")return e}const p2e=le("ipfs:repo:version"),_y=new ie("version");function g2e(r){return{async exists(){return LO(_y,r.has.bind(r),r)},async get(){const e=await MO(_y,r.get.bind(r),r.has.bind(r),r);return parseInt(C(e),10)},set(e){return r.put(_y,L(String(e)))},async check(e){const t=await this.get();return p2e("comparing version: %s and %s",t,e),t===e||(t===6&&e===7||e===6&&t===7)}}}const y2e=zt.default?zt.default:zt,Sy=new ie("config");function w2e(r){const e=new y2e({concurrency:1}),t={async getAll(i={}){const o=await MO(Sy,r.get.bind(r),r.has.bind(r),r);return JSON.parse(C(o))},async get(i,o={}){if(i==null)throw new zo(`Key ${i} does not exist in config`);const a=await this.getAll(o),c=M4(a,i);if(c===void 0)throw new zo(`Key ${i} does not exist in config`);return c},set(i,o,a={}){if(typeof i!="string"&&!(i instanceof String))throw $(new Error("Invalid key type: "+typeof i),"ERR_INVALID_KEY");if(o===void 0||o instanceof Uint8Array)throw $(new Error("Invalid value type: "+typeof o),"ERR_INVALID_VALUE");return e.add(()=>n({key:i,value:o},a.signal))},replace(i,o={}){if(!i||i instanceof Uint8Array)throw $(new Error("Invalid value type: "+typeof i),"ERR_INVALID_VALUE");return e.add(()=>n({key:void 0,value:i},o.signal))},async exists(){return LO(Sy,r.has.bind(r),r)}};return t;async function n(i,o){if(o&&o.aborted)return;const a=i.key,c=i.value;if(a){const u=await t.getAll();return typeof u=="object"&&u!==null&&wt(u,a,c),s(u)}return s(c)}function s(i){const o=L(JSON.stringify(i,null,2));return r.put(Sy,o)}}function Ay(r){if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)}function b2e(r,e={}){if(!Ay(r)&&!Array.isArray(r))throw new TypeError("Expected a plain object or array");const{deep:t,compare:n}=e,s=[],i=[],o=c=>{const u=s.indexOf(c);if(u!==-1)return i[u];const l=[];return s.push(c),i.push(l),l.push(...c.map(d=>Array.isArray(d)?o(d):Ay(d)?a(d):d)),l},a=c=>{const u=s.indexOf(c);if(u!==-1)return i[u];const l={},d=Object.keys(c).sort(n);s.push(c),i.push(l);for(const f of d){const g=c[f];let h;t&&Array.isArray(g)?h=o(g):h=t&&Ay(g)?a(g):g,Object.defineProperty(l,f,{...Object.getOwnPropertyDescriptor(c,f),value:h})}return l};return Array.isArray(r)?t?o(r):r.slice():a(r)}const $y=new ie("datastore_spec");function m2e(r){return{exists(){return r.has($y)},async get(){const e=await r.get($y);return JSON.parse(C(e))},async set(e){return r.put($y,L(JSON.stringify(b2e(e,{deep:!0}))))}}}const Ry=new ie("api");function E2e(r){return{async get(){const e=await r.get(Ry);return e&&e.toString()},set(e){return r.put(Ry,L(e.toString()))},delete(){return r.delete(Ry)}}}var v2e=BO,__=128,_2e=127,S2e=~_2e,A2e=Math.pow(2,31);function BO(r,e,t){e=e||[],t=t||0;for(var n=t;r>=A2e;)e[t++]=r&255|__,r/=128;for(;r&S2e;)e[t++]=r&255|__,r>>>=7;return e[t]=r|0,BO.bytes=t-n+1,e}var $2e=l3,R2e=128,S_=127;function l3(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw l3.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&S_)<<s:(o&S_)*Math.pow(2,s),s+=7}while(o>=R2e);return l3.bytes=i-n,t}var T2e=Math.pow(2,7),I2e=Math.pow(2,14),C2e=Math.pow(2,21),x2e=Math.pow(2,28),D2e=Math.pow(2,35),O2e=Math.pow(2,42),P2e=Math.pow(2,49),k2e=Math.pow(2,56),N2e=Math.pow(2,63),L2e=function(r){return r<T2e?1:r<I2e?2:r<C2e?3:r<x2e?4:r<D2e?5:r<O2e?6:r<P2e?7:r<k2e?8:r<N2e?9:10},M2e={encode:v2e,decode:$2e,encodingLength:L2e},x1=M2e;const u3=(r,e=0)=>[x1.decode(r,e),x1.decode.bytes],D1=(r,e,t=0)=>(x1.encode(r,e,t),e),O1=r=>x1.encodingLength(r),U2e=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},q2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},zO=(r,e)=>{const t=e.byteLength,n=O1(r),s=n+O1(t),i=new Uint8Array(s+t);return D1(r,i,0),D1(t,i,n),i.set(e,s),new H4(r,t,e,i)},FO=r=>{const e=q2(r),[t,n]=u3(e),[s,i]=u3(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new H4(t,s,o,e)},B2e=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&U2e(r.bytes,t.bytes)}};let H4=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function z2e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var F2e=z2e,V2e=F2e;let j2e=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},q2e=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return VO(this,e)}},K2e=class{constructor(e){this.decoders=e}or(e){return VO(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const VO=(r,e)=>new K2e({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let G2e=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new j2e(e,t,n),this.decoder=new q2e(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const jO=({name:r,prefix:e,encode:t,decode:n})=>new G2e(r,e,t,n),qO=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=V2e(t,e);return jO({prefix:r,name:e,encode:n,decode:i=>q2(s(i))})},H2e=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},W2e=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Fi=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>jO({prefix:e,name:r,encode(s){return W2e(s,n,t)},decode(s){return H2e(s,n,t,r)}}),ao=qO({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});qO({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Do=Fi({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Fi({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Fi({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Fi({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Fi({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Fi({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Fi({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Fi({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Fi({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const A_=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return Y2e(t,d3(r),e||ao.encoder);default:return X2e(t,d3(r),e||Do.encoder)}},$_=new WeakMap,d3=r=>{const e=$_.get(r);if(e==null){const t=new Map;return $_.set(r,t),t}return e};let Ds=class Sr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==yu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==J2e)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Sr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=zO(e,t);return Sr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Sr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&B2e(e.multihash,n.multihash)}toString(e){return A_(this,e)}toJSON(){return{"/":A_(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Sr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Sr(n,s,i,o||R_(n,s,i.bytes))}else if(t[Z2e]===!0){const{version:n,multihash:s,code:i}=t,o=FO(s);return Sr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==yu)throw new Error(`Version 0 CID must use dag-pb (code: ${yu}) block encoding`);return new Sr(e,t,n,n.bytes)}case 1:{const s=R_(e,t,n.bytes);return new Sr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Sr.create(0,yu,e)}static createV1(e,t){return Sr.create(1,e,t)}static decode(e){const[t,n]=Sr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Sr.inspectBytes(e),n=t.size-t.multihashSize,s=q2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new H4(t.multihashCode,t.digestSize,i,s);return[t.version===0?Sr.createV0(o):Sr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=u3(e.subarray(t));return t+=f,d};let s=n(),i=yu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=Q2e(e,t),i=Sr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return d3(i).set(n,e),i}};const Q2e=(r,e)=>{switch(r[0]){case"Q":{const t=e||ao;return[ao.prefix,t.decode(`${ao.prefix}${r}`)]}case ao.prefix:{const t=e||ao;return[ao.prefix,t.decode(r)]}case Do.prefix:{const t=e||Do;return[Do.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},Y2e=(r,e,t)=>{const{prefix:n}=t;if(n!==ao.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},X2e=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},yu=112,J2e=18,R_=(r,e,t)=>{const n=O1(r),s=n+O1(e),i=new Uint8Array(s+t.byteLength);return D1(r,i,0),D1(e,i,n),i.set(t,s),i},Z2e=Symbol.for("@ipld/js-cid/CID"),KO=0,ege="identity",GO=q2,tge=r=>zO(KO,GO(r)),rge={code:KO,name:ege,encode:GO,digest:tge};function nge(r){return{open(){return r.open()},close(){return r.close()},query(e,t){return r.query(e,t)},queryKeys(e,t){return r.queryKeys(e,t)},async get(e,t){const n=Qi(e);return n.isIdentity?Promise.resolve(n.digest):r.get(e,t)},async*getMany(e,t){for await(const n of e)yield this.get(n,t)},async put(e,t,n){const{isIdentity:s}=Qi(e);s||await r.put(e,t,n)},async*putMany(e,t){const n=Mt({objectMode:!0});(globalThis.process&&globalThis.process.nextTick?globalThis.process.nextTick:globalThis.setImmediate||globalThis.setTimeout)(async()=>{try{await Wt(r.putMany(async function*(){for await(const{key:i,value:o}of e)Qi(i).isIdentity||(yield{key:i,value:o}),n.push({key:i,value:o})}())),n.end()}catch(i){n.end(i)}}),yield*n},has(e,t){const{isIdentity:n}=Qi(e);return n?Promise.resolve(!0):r.has(e,t)},delete(e,t){const{isIdentity:n}=Qi(e);return n?Promise.resolve():r.delete(e,t)},deleteMany(e,t){return r.deleteMany(dt(e,n=>!Qi(n).isIdentity),t)},batch(){const e=r.batch();return{put(t,n){const{isIdentity:s}=Qi(t);s||e.put(t,n)},delete(t){const{isIdentity:n}=Qi(t);n||e.delete(t)},commit:t=>e.commit(t)}}}}function Qi(r){const e=Ds.asCID(r);if(e==null)throw $(new Error("Not a valid cid"),"ERR_INVALID_CID");return e.multihash.code!==rge.code?{isIdentity:!1}:{isIdentity:!0,digest:e.multihash.digest}}const HO=le("ipfs:repo:lock:memory"),WO="repo.lock",cd={};async function sge(r){const e=r+"/"+WO;if(HO("locking %s",e),cd[e]===!0)throw new V2(`Lock already being held for file: ${e}`);return cd[e]=!0,{async close(){cd[e]&&delete cd[e]}}}async function ige(r){const e=r+"/"+WO;return HO(`checking lock: ${e}`),!!cd[e]}const QO={lock:sge,locked:ige},oge={autoMigrate:!0,onMigrationProgress:()=>{},repoOwner:!0,repoLock:QO},YO={Spec:{type:"mount",mounts:[{mountpoint:"/blocks",type:"measure",prefix:"flatfs.datastore",child:{type:"flatfs",path:"blocks",sync:!0,shardFunc:"/repo/flatfs/shard/v1/next-to-last/2"}},{mountpoint:"/",type:"measure",prefix:"leveldb.datastore",child:{type:"levelds",path:"datastore",compression:"none"}}]}};function kf({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*age(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t],i=Ds.asCID(n);i?yield[s.join("/"),i]:typeof n=="object"&&(yield*h3(n,s))}else{const t=Ds.asCID(e);t?yield[r.join("/"),t]:yield*h3(e,r)}}function*h3(r,e){if(r==null||r instanceof Uint8Array)return;const t=Ds.asCID(r);t&&(yield[e.join("/"),t]);for(const[n,s]of Object.entries(r)){const i=[...e,n];yield*age(i,s)}}function*cge(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const s=[...r,t];yield s.join("/"),typeof n=="object"&&!Ds.asCID(n)&&(yield*f3(n,s))}else yield*f3(e,r)}function*f3(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const s=[...e,t];yield s.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&!Ds.asCID(n)&&(yield*cge(s,n))}}function lge(r,e){let t=r;for(const[n,s]of e.entries()){if(t=t[s],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const i=Ds.asCID(t);if(i)return{value:i,remaining:e.slice(n+1).join("/")}}return{value:t}}class uge{constructor({cid:e,bytes:t,value:n}){if(!e||!t||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:kf(),bytes:kf(),value:kf(),asBlock:kf()})}links(){return h3(this.value,[])}tree(){return f3(this.value,[])}get(e="/"){return lge(this.value,e.split("/").filter(Boolean))}}function XO({bytes:r,cid:e,value:t,codec:n}){const s=t!==void 0?t:n&&n.decode(r);if(s===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new uge({cid:e,bytes:r,value:s})}function Nf(r){const e=Ds.asCID(r);if(e==null)throw $(new Error("Not a valid cid"),"ERR_INVALID_CID");const t=Do.encode(e.multihash.bytes);return new ie("/"+t.slice(1).toUpperCase(),!1)}function T_(r){return FO(Do.decode(`b${r.toString().toLowerCase().substring(1)}`))}const dge=le("ipfs:repo:utils:walk-dag");async function*P1(r,e,t,n){try{const s=await e.get(r,n),i=await t(r.code),o=XO({bytes:s,cid:r,codec:i});for(const[,a]of o.links())yield a,yield*P1(a,e,t,n)}catch(s){throw dge("Could not walk DAG for CID",r.toString(),s),s}}class hge extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,n]of e)this.onEviction(t,n.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const n=t.get(e);return this._getItemValue(e,n)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,n]=e;this.cache.has(t)||this._deleteIfExpired(t,n)===!1&&(yield e)}for(const e of this.cache){const[t,n]=e;this._deleteIfExpired(t,n)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:n=this.maxAge}={}){const s=typeof n=="number"&&n!==Number.POSITIVE_INFINITY?Date.now()+n:void 0;this.cache.has(e)?this.cache.set(e,{value:t,expiry:s}):this._set(e,{value:t,expiry:s})}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],n=t.length-e;n<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(n>0&&this._emitEvictions(t.slice(0,n)),this.oldCache=new Map(t.slice(n)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,n]=e;this._deleteIfExpired(t,n)===!1&&(yield[t,n.value])}for(const e of this.oldCache){const[t,n]=e;this.cache.has(t)||this._deleteIfExpired(t,n)===!1&&(yield[t,n.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const n=e[t],[s,i]=n;this._deleteIfExpired(s,i)===!1&&(yield[s,i.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const n=e[t],[s,i]=n;this.cache.has(s)||this._deleteIfExpired(s,i)===!1&&(yield[s,i.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[n,s]of this.entriesAscending())e.call(t,s,n,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}const fge=2048;function pge(r){const e=`Invalid type '${r}', must be one of {direct, indirect, recursive, all}`;return $(new Error(e),"ERR_INVALID_PIN_TYPE")}class gge{constructor({pinstore:e,blockstore:t,loadCodec:n}){this.pinstore=e,this.blockstore=t,this.loadCodec=n,this.log=le("ipfs:repo:pin"),this.directPins=new Set,this.recursivePins=new Set}async pinDirectly(e,t={}){await this.blockstore.get(e,t);const n={depth:0};return e.version!==0&&(n.version=e.version),e.code!==ht&&(n.codec=e.code),t.metadata&&(n.metadata=t.metadata),this.pinstore.put(Nf(e),Ad(n))}unpin(e,t){return this.pinstore.delete(Nf(e),t)}async pinRecursively(e,t={}){await this.fetchCompleteDag(e,t);const n={depth:1/0};e.version!==0&&(n.version=e.version),e.code!==ht&&(n.codec=e.code),t.metadata&&(n.metadata=t.metadata),await this.pinstore.put(Nf(e),Ad(n))}async*directKeys(e){for await(const t of this.pinstore.query({filters:[n=>to(n.value).depth===0]})){const n=to(t.value),s=n.version||0,i=n.codec!=null?n.codec:ht,o=T_(t.key);yield{cid:Ds.create(s,i,o),metadata:n.metadata}}}async*recursiveKeys(e){for await(const t of this.pinstore.query({filters:[n=>to(n.value).depth===1/0]})){const n=to(t.value),s=n.version||0,i=n.codec!=null?n.codec:ht,o=T_(t.key);yield{cid:Ds.create(s,i,o),metadata:n.metadata}}}async*indirectKeys(e){for await(const{cid:t}of this.recursiveKeys())for await(const n of P1(t,this.blockstore,this.loadCodec,e)){const s=[De.recursive];(await this.isPinnedWithType(n,s)).pinned||(yield n)}}async isPinnedWithType(e,t,n){Array.isArray(t)||(t=[t]);const s=t.includes(De.all),i=t.includes(De.direct),o=t.includes(De.recursive),a=t.includes(De.indirect);if(o||i||s){const l=await xs(this.pinstore.query({prefix:Nf(e).toString(),filters:[d=>{if(s)return!0;const f=to(d.value);return t.includes(f.depth===0?De.direct:De.recursive)}],limit:1}));if(l){const d=to(l.value);return{cid:e,pinned:!0,reason:d.depth===0?De.direct:De.recursive,metadata:d.metadata}}}const c=this;async function*u(l,d){for await(const{cid:f}of d)for await(const g of P1(f,c.blockstore,c.loadCodec))if(g.equals(l)){yield f;return}}if(s||a){const l=await xs(u(e,this.recursiveKeys()));if(l)return{cid:e,pinned:!0,reason:De.indirect,parent:l}}return{cid:e,pinned:!1}}async fetchCompleteDag(e,t={}){const n=new hge({maxSize:t.cidCacheMaxSize??fge}),s=async(i,o)=>{if(n.has(i.toString()))return;n.set(i.toString(),!0);const a=await this.blockstore.get(i,o),c=await this.loadCodec(i.code),u=XO({bytes:a,cid:i,codec:c});await Promise.all([...u.links()].map(([,l])=>s(l,o)))};await s(e,t)}static checkPinType(e){if(typeof e!="string"||!Object.keys(De).includes(e))throw pge(e);return!0}}function yge(r,e){return{open(){return e.open()},close(){return e.close()},query(t,n){return e.query(t,n)},queryKeys(t,n){return e.queryKeys(t,n)},async get(t,n){return e.get(t,n)},async*getMany(t,n){yield*e.getMany(t,n)},async put(t,n,s){await e.put(t,n,s)},async*putMany(t,n){yield*e.putMany(t,n)},has(t,n){return e.has(t,n)},async delete(t,n){return await I_(t,r),e.delete(t,n)},deleteMany(t,n){return e.deleteMany(Xr(t,async s=>(await I_(s,r),s)),n)},batch(){return e.batch()}}}async function I_(r,e){const{pinned:t,reason:n}=await e.isPinnedWithType(r,De.all);if(t)throw $(new Error(`pinned: ${n}`),"ERR_BLOCK_PINNED")}const Hd=le("ipfs:repo:gc"),wge=Js().code,bge=256,mge=new ie("/local/filesroot");function Ege({gcLock:r,pins:e,blockstore:t,root:n,loadCodec:s}){async function*i(){const o=Date.now();Hd("Creating set of marked blocks");const a=await r.writeLock();try{const c=await vge({pins:e,blockstore:t,root:n,loadCodec:s}),u=t.queryKeys({});yield*_ge({blockstore:t},c,u),Hd(`Complete (${Date.now()-o}ms)`)}finally{a()}}return i}async function vge({pins:r,blockstore:e,loadCodec:t,root:n}){const s=async function*(){let a;try{a=await n.get(mge)}catch(u){if(u.code===wge){Hd("No blocks in MFS");return}throw u}const c=Ds.decode(a);yield c,yield*P1(c,e,t)}(),i=nn(Xr(r.recursiveKeys(),({cid:a})=>a),r.indirectKeys(),Xr(r.directKeys(),({cid:a})=>a),s),o=new Set;for await(const a of nn(i,s))o.add(Do.encode(a.multihash.bytes));return o}async function*_ge({blockstore:r},e,t){let n=0,s=0;yield*Ae(n4(Xr(t,async o=>async function(){n++;try{const c=Do.encode(o.multihash.bytes);if(e.has(c))return null;try{await r.delete(o),s++}catch(u){return{err:new Error(`Could not delete block with CID ${o}: ${u.message}`)}}return{cid:o}}catch(c){const u=`Could delete block with CID ${o}`;return Hd(u,c),{err:new Error(u+`: ${c.message}`)}}}),bge),o=>dt(o,Boolean)),Hd(`Marked set has ${e.size} unique blocks. Blockstore has ${n} blocks. Deleted ${s} blocks.`)}const Zr=le("ipfs:repo"),Sge=Number.MAX_SAFE_INTEGER,Age="repoAutoMigrate";class $ge{constructor(e,t,n,s){if(typeof e!="string")throw new Error("missing repo path");if(typeof t!="function")throw new Error("missing codec loader");this.options=et(oge,s),this.closed=!0,this.path=e,this.root=n.root,this.datastore=n.datastore,this.keys=n.keys;const i=n.blocks,o=n.pins;this.pins=new gge({pinstore:o,blockstore:i,loadCodec:t});const a=yge(this.pins,i);this.blocks=nge(a),this.version=g2e(this.root),this.config=w2e(this.root),this.spec=m2e(this.root),this.apiAddr=E2e(this.root),this.gcLock=D4({name:e,singleProcess:this.options.repoOwner!==!1}),this.gc=Ege({gcLock:this.gcLock,pins:this.pins,blockstore:this.blocks,root:this.root,loadCodec:t})}async init(e){Zr("initializing at: %s",this.path),await this._openRoot(),await this.config.replace(Tge(e)),await this.spec.set(Ige(e)),await this.version.set(hp)}async isInitialized(){if(!this.closed)return!0;try{return await this._openRoot(),await this._checkInitialized(),await this.root.close(),!0}catch{return!1}}async open(){if(!this.closed)throw $(new Error("repo is already open"),h2e);Zr("opening at: %s",this.path);try{if(await this._openRoot(),await this._checkInitialized(),this._lockfile=await this._openLock(),Zr("acquired repo.lock"),!await this.version.check(hp))if(await this._isAutoMigrationEnabled())await this._migrate(hp,{root:this.root,datastore:this.datastore,pins:this.pins.pinstore,blocks:this.pins.blockstore,keys:this.keys});else throw new j2("Incompatible repo versions. Automatic migrations disabled. Please migrate the repo manually.");Zr("creating datastore"),await this.datastore.open(),Zr("creating blocks"),await this.blocks.open(),Zr("creating keystore"),await this.keys.open(),Zr("creating pins"),await this.pins.pinstore.open(),this.closed=!1,Zr("all opened")}catch(e){if(this._lockfile)try{await this._closeLock(),this._lockfile=null}catch(t){Zr("error removing lock",t)}throw e}}async _openRoot(){try{await this.root.open()}catch(e){if(e.message!=="Already open")throw e}}async _openLock(){const e=await this.options.repoLock.lock(this.path);if(typeof e.close!="function")throw $(new Error("Locks must have a close method"),"ERR_NO_CLOSE_FUNCTION");return e}_closeLock(){return this._lockfile&&this._lockfile.close()}async _checkInitialized(){Zr("init check");let e;try{[e]=await Promise.all([this.config.exists(),this.spec.exists(),this.version.exists()])}catch(t){throw t.code==="ERR_NOT_FOUND"?$(new Error("repo is not initialized yet"),ad,{path:this.path}):t}if(!e)throw $(new Error("repo is not initialized yet"),ad,{path:this.path})}async close(){if(this.closed)throw $(new Error("repo is already closed"),f2e);Zr("closing at: %s",this.path);try{await this.apiAddr.delete()}catch(e){if(e.code!==ad&&!e.message.startsWith("ENOENT"))throw e}await Promise.all([this.root,this.blocks,this.keys,this.datastore,this.pins.pinstore].map(e=>e&&e.close())),Zr("unlocking"),this.closed=!0,await this._closeLock()}exists(){return this.version.exists()}async stat(){if(this.datastore&&this.keys){const[e,t,n,s,i]=await Promise.all([this._storageMaxStat(),this._blockStat(),this.version.get(),C_(this.datastore),C_(this.keys)]),o=t.size+s+i;return{repoPath:this.path,storageMax:e,version:n,numObjects:t.count,repoSize:o}}throw $(new Error("repo is not initialized yet"),ad,{path:this.path})}async _isAutoMigrationEnabled(){if(this.options.autoMigrate!==void 0)return this.options.autoMigrate;let e;try{e=await this.config.get(Age)}catch(t){if(t.code===zo.code)e=!0;else throw t}return e}async _migrate(e,t){return await this.version.get()>e?(Zr(`reverting to version ${e}`),i2e(this.path,t,this.options,e,{ignoreLock:!0,onProgress:this.options.onMigrationProgress})):(Zr(`migrating to version ${e}`),s2e(this.path,t,this.options,e,{ignoreLock:!0,onProgress:this.options.onMigrationProgress}))}async _storageMaxStat(){try{const e=await this.config.get("Datastore.StorageMax");return BigInt(d2e(e))}catch{return BigInt(Sge)}}async _blockStat(){let e=BigInt(0),t=BigInt(0);if(this.blocks)for await(const{key:n,value:s}of this.blocks.query({}))e+=BigInt(1),t+=BigInt(s.byteLength),t+=BigInt(n.bytes.byteLength);return{count:e,size:t}}}async function C_(r){let e=BigInt(0);for await(const t of r.query({}))e+=BigInt(t.value.byteLength),e+=BigInt(t.key.uint8Array().byteLength);return e}function Rge(r,e,t,n){return new $ge(r,e,t,n)}function Tge(r){return r.Datastore=Object.assign({},YO,M4(r,"datastore")),r}function Ige(r){const e={...YO.Spec,...M4(r,"Datastore.Spec")};return{type:e.type,mounts:e.mounts.map(t=>({mountpoint:t.mountpoint,type:t.child.type,path:t.child.path,shardFunc:t.child.shardFunc}))}}async function*k1(r,e){yield*(await jo(r)).sort(e)}class wu extends w2{constructor(e,t={}){super(),this.db=typeof e=="string"?new YM(e,{...t,keyEncoding:"utf8",valueEncoding:"view"}):e,this.opts={createIfMissing:!0,compression:!1,...t}}async open(){try{await this.db.open(this.opts)}catch(e){throw gC(e)}}async put(e,t){try{await this.db.put(e.toString(),t)}catch(n){throw tb(n)}}async get(e){let t;try{t=await this.db.get(e.toString())}catch(n){throw n.notFound?Js(n):tb(n)}return t}async has(e){try{await this.db.get(e.toString())}catch(t){if(t.notFound)return!1;throw t}return!0}async delete(e){try{await this.db.del(e.toString())}catch(t){throw yC(t)}}close(){return this.db&&this.db.close()}batch(){const e=[];return{put:(t,n)=>{e.push({type:"put",key:t.toString(),value:n})},delete:t=>{e.push({type:"del",key:t.toString()})},commit:()=>this.db.batch(e)}}query(e){let t=this._query({values:!0,prefix:e.prefix});Array.isArray(e.filters)&&(t=e.filters.reduce((i,o)=>dt(i,o),t)),Array.isArray(e.orders)&&(t=e.orders.reduce((i,o)=>k1(i,o),t));const{offset:n,limit:s}=e;if(n){let i=0;t=dt(t,()=>i++>=n)}return s&&(t=La(t,s)),t}queryKeys(e){let t=Xr(this._query({values:!1,prefix:e.prefix}),({key:i})=>i);Array.isArray(e.filters)&&(t=e.filters.reduce((i,o)=>dt(i,o),t)),Array.isArray(e.orders)&&(t=e.orders.reduce((i,o)=>k1(i,o),t));const{offset:n,limit:s}=e;if(n){let i=0;t=dt(t,()=>i++>=n)}return s&&(t=La(t,s)),t}_query(e){const t={keys:!0,keyEncoding:"buffer",values:e.values};if(e.prefix!=null){const s=e.prefix.toString();t.gte=s,t.lt=s+""}const n=this.db.iterator(t);if(n[Symbol.asyncIterator])return Cge(n);if(n.next!=null&&n.end!=null)return xge(n);throw new Error("Level returned incompatible iterator")}}async function*Cge(r){for await(const[e,t]of r)yield{key:new ie(e,!1),value:t};await r.close()}function xge(r){return{[Symbol.asyncIterator](){return{next:()=>new Promise((e,t)=>{r.next((n,s,i)=>{if(n)return t(n);if(s==null)return r.end(o=>{if(o)return t(o);e({done:!0,value:void 0})});e({done:!1,value:{key:new ie(s,!1),value:i}})})}),return:()=>new Promise((e,t)=>{r.end(n=>{if(n)return t(n);e({done:!0,value:void 0})})})}}}}var Dge=JO,x_=128,Oge=127,Pge=~Oge,kge=Math.pow(2,31);function JO(r,e,t){e=e||[],t=t||0;for(var n=t;r>=kge;)e[t++]=r&255|x_,r/=128;for(;r&Pge;)e[t++]=r&255|x_,r>>>=7;return e[t]=r|0,JO.bytes=t-n+1,e}var Nge=p3,Lge=128,D_=127;function p3(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw p3.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&D_)<<s:(o&D_)*Math.pow(2,s),s+=7}while(o>=Lge);return p3.bytes=i-n,t}var Mge=Math.pow(2,7),Uge=Math.pow(2,14),Bge=Math.pow(2,21),zge=Math.pow(2,28),Fge=Math.pow(2,35),Vge=Math.pow(2,42),jge=Math.pow(2,49),qge=Math.pow(2,56),Kge=Math.pow(2,63),Gge=function(r){return r<Mge?1:r<Uge?2:r<Bge?3:r<zge?4:r<Fge?5:r<Vge?6:r<jge?7:r<qge?8:r<Kge?9:10},Hge={encode:Dge,decode:Nge,encodingLength:Gge},N1=Hge;const g3=(r,e=0)=>[N1.decode(r,e),N1.decode.bytes],L1=(r,e,t=0)=>(N1.encode(r,e,t),e),M1=r=>N1.encodingLength(r),Wge=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},W4=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Qge=(r,e)=>{const t=e.byteLength,n=M1(r),s=n+M1(t),i=new Uint8Array(s+t);return L1(r,i,0),L1(t,i,n),i.set(e,s),new Q4(r,t,e,i)},ZO=r=>{const e=W4(r),[t,n]=g3(e),[s,i]=g3(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Q4(t,s,o,e)},Yge=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Wge(r.bytes,t.bytes)}};let Q4=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function Xge(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var Jge=Xge,Zge=Jge;let eye=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},tye=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return eP(this,e)}},rye=class{constructor(e){this.decoders=e}or(e){return eP(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const eP=(r,e)=>new rye({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let nye=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new eye(e,t,n),this.decoder=new tye(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const tP=({name:r,prefix:e,encode:t,decode:n})=>new nye(r,e,t,n),rP=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Zge(t,e);return tP({prefix:r,name:e,encode:n,decode:i=>W4(s(i))})},sye=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},iye=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Vi=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>tP({prefix:e,name:r,encode(s){return iye(s,n,t)},decode(s){return sye(s,n,t,r)}}),js=rP({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});rP({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Di=Vi({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Vi({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});const oye=Vi({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Vi({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Vi({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Vi({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Vi({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Vi({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Vi({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const O_=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return cye(t,y3(r),e||js.encoder);default:return lye(t,y3(r),e||Di.encoder)}},P_=new WeakMap,y3=r=>{const e=P_.get(r);if(e==null){const t=new Map;return P_.set(r,t),t}return e};let nP=class Ar{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==bu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==uye)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Ar.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Qge(e,t);return Ar.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Ar.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Yge(e.multihash,n.multihash)}toString(e){return O_(this,e)}toJSON(){return{"/":O_(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Ar)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Ar(n,s,i,o||k_(n,s,i.bytes))}else if(t[dye]===!0){const{version:n,multihash:s,code:i}=t,o=ZO(s);return Ar.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==bu)throw new Error(`Version 0 CID must use dag-pb (code: ${bu}) block encoding`);return new Ar(e,t,n,n.bytes)}case 1:{const s=k_(e,t,n.bytes);return new Ar(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Ar.create(0,bu,e)}static createV1(e,t){return Ar.create(1,e,t)}static decode(e){const[t,n]=Ar.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Ar.inspectBytes(e),n=t.size-t.multihashSize,s=W4(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Q4(t.multihashCode,t.digestSize,i,s);return[t.version===0?Ar.createV0(o):Ar.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=g3(e.subarray(t));return t+=f,d};let s=n(),i=bu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=aye(e,t),i=Ar.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return y3(i).set(n,e),i}};const aye=(r,e)=>{switch(r[0]){case"Q":{const t=e||js;return[js.prefix,t.decode(`${js.prefix}${r}`)]}case js.prefix:{const t=e||js;return[js.prefix,t.decode(r)]}case Di.prefix:{const t=e||Di;return[Di.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},cye=(r,e,t)=>{const{prefix:n}=t;if(n!==js.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},lye=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},bu=112,uye=18,k_=(r,e,t)=>{const n=M1(r),s=n+M1(e),i=new Uint8Array(s+t.byteLength);return L1(r,i,0),L1(e,i,n),i.set(t,s),i},dye=Symbol.for("@ipld/js-cid/CID"),hye=85,N_=(r,e)=>async function*(){yield*(await jo(r)).sort(e)}();class Y4{open(){return Promise.reject(new Error(".open is not implemented"))}close(){return Promise.reject(new Error(".close is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:s}of e)await this.put(n,s,t),yield{key:n,value:s}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,s){e.push({key:n,value:s})},delete(n){t.push(n)},commit:async n=>{await Wt(this.putMany(e,n)),e=[],await Wt(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null&&(n=dt(n,s=>s.key.toString().startsWith(e.prefix||""))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>dt(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>N_(s,i),n)),e.offset!=null){let s=0;n=dt(n,()=>s++>=(e.offset||0))}return e.limit!=null&&(n=La(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null&&(n=dt(n,s=>s.toString().startsWith(e.prefix||""))),Array.isArray(e.filters)&&(n=e.filters.reduce((s,i)=>dt(s,i),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((s,i)=>N_(s,i),n)),e.offset!=null){let s=0;n=dt(n,()=>s++>=e.offset)}return e.limit!=null&&(n=La(n,e.limit)),n}}function pc(r){const e=nP.asCID(r);if(!e)throw $(new Error("Not a valid cid"),"ERR_INVALID_CID");return new ie("/"+Di.encode(e.multihash.bytes).slice(1).toUpperCase(),!1)}function Oo(r){return nP.createV1(hye,ZO(Di.decode("b"+r.toString().slice(1).toLowerCase())))}function X4(r){const e=r.substring(0,1);if(e==="/")return X4(r.substring(1));let t;e.toLowerCase()==="b"?t=i=>Di.decode(i.toLowerCase()).subarray(2):e.toLowerCase()==="c"?t=i=>oye.decode(i.toLowerCase()).subarray(2):e==="z"?t=i=>js.decode(i).subarray(2):e==="Q"?t=i=>js.decode("z"+i):t=i=>Di.decode("b"+i.toLowerCase()).subarray(2);let n;for(let i=1;i<r.length;i++)try{n=t(r.substring(0,i))}catch(o){if(o.message!=="Unexpected end of data")throw o}let s="/C";return n&&(s=`/${Di.encode(n).slice(1,-1).toUpperCase()||"C"}`),s}function fye(r){return{...r,prefix:r.prefix?X4(r.prefix):void 0,filters:r.filters?r.filters.map(e=>t=>e({key:Oo(t.key),value:t.value})):void 0,orders:r.orders?r.orders.map(e=>(t,n)=>e({key:Oo(t.key),value:t.value},{key:Oo(n.key),value:n.value})):void 0}}function pye(r){return{...r,prefix:r.prefix?X4(r.prefix):void 0,filters:r.filters?r.filters.map(e=>t=>e(Oo(t))):void 0,orders:r.orders?r.orders.map(e=>(t,n)=>e(Oo(t),Oo(n))):void 0}}class gye extends Y4{constructor(e){super(),this.child=e}open(){return this.child.open()}close(){return this.child.close()}async*query(e,t){for await(const{key:n,value:s}of this.child.query(fye(e),t))yield{key:Oo(n),value:s}}async*queryKeys(e,t){for await(const n of this.child.queryKeys(pye(e),t))yield Oo(n)}async get(e,t){return this.child.get(pc(e),t)}async*getMany(e,t){for await(const n of e)yield this.get(n,t)}async put(e,t,n){await this.child.put(pc(e),t,n)}async*putMany(e,t){const n=Mt({objectMode:!0});(globalThis.process&&globalThis.process.nextTick?globalThis.process.nextTick:globalThis.setImmediate||globalThis.setTimeout)(async()=>{try{const i=this.child;await Wt(this.child.putMany(async function*(){for await(const o of e){const a=pc(o.key);await i.has(a,t)||(yield{key:a,value:o.value}),n.push(o)}}())),n.end()}catch(i){n.end(i)}}),yield*n}has(e,t){return this.child.has(pc(e),t)}delete(e,t){return this.child.delete(pc(e),t)}deleteMany(e,t){const n=Mt({objectMode:!0});return Wt(this.child.deleteMany(async function*(){for await(const s of e)yield pc(s),n.push(s);n.end()}(),t)).catch(s=>{n.end(s)}),n}}function yye(r,e,t){const n=t.path||"ipfs";return Rge(n,s=>e.getCodec(s),{root:new wu(n,{prefix:"",version:2}),blocks:new gye(new wu(`${n}/blocks`,{prefix:"",version:2})),datastore:new wu(`${n}/datastore`,{prefix:"",version:2}),keys:new wu(`${n}/keys`,{prefix:"",version:2}),pins:new wu(`${n}/pins`,{prefix:"",version:2})},{autoMigrate:t.autoMigrate,onMigrationProgress:t.onMigrationProgress||r,repoLock:QO})}function L_(r){return r instanceof Uint8Array?{get(e){return r[e]},set(e,t){r[e]=t}}:{get(e){return r.get(e)},set(e,t){r.set(e,t)}}}const M_=4294967296;class zs{constructor(e=0,t=0){this.hi=e,this.lo=t}toBigInt(e){if(e===!0)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toNumber(e){return Number(this.toBigInt(e))}zzDecode(){const e=-(this.lo&1),t=((this.lo>>>1|this.hi<<31)^e)>>>0,n=(this.hi>>>1^e)>>>0;return new zs(n,t)}zzEncode(){const e=this.hi>>31,t=((this.hi<<1|this.lo>>>31)^e)>>>0,n=(this.lo<<1^e)>>>0;return new zs(t,n)}toBytes(e,t=0){const n=L_(e);for(;this.hi>0;)n.set(t++,this.lo&127|128),this.lo=(this.lo>>>7|this.hi<<25)>>>0,this.hi>>>=7;for(;this.lo>127;)n.set(t++,this.lo&127|128),this.lo=this.lo>>>7;n.set(t++,this.lo)}static fromBigInt(e){if(e===0n)return new zs;const t=e<0;t&&(e=-e);let n=Number(e>>32n)|0,s=Number(e-(BigInt(n)<<32n))|0;return t&&(n=~n>>>0,s=~s>>>0,++s>M_&&(s=0,++n>M_&&(n=0))),new zs(n,s)}static fromNumber(e){if(e===0)return new zs;const t=e<0;t&&(e=-e);let n=e>>>0,s=(e-n)/4294967296>>>0;return t&&(s=~s>>>0,n=~n>>>0,++n>4294967295&&(n=0,++s>4294967295&&(s=0))),new zs(s,n)}static fromBytes(e,t=0){const n=L_(e),s=new zs;let i=0;if(e.length-t>4){for(;i<4;++i)if(s.lo=(s.lo|(n.get(t)&127)<<i*7)>>>0,n.get(t++)<128)return s;if(s.lo=(s.lo|(n.get(t)&127)<<28)>>>0,s.hi=(s.hi|(n.get(t)&127)>>4)>>>0,n.get(t++)<128)return s;i=0}else for(;i<4;++i){if(t>=e.length)throw RangeError(`index out of range: ${t} > ${e.length}`);if(s.lo=(s.lo|(n.get(t)&127)<<i*7)>>>0,n.get(t++)<128)return s}if(e.length-t>4){for(;i<5;++i)if(s.hi=(s.hi|(n.get(t)&127)<<i*7+3)>>>0,n.get(t++)<128)return s}else if(t<e.byteLength)for(;i<5;++i){if(t>=e.length)throw RangeError(`index out of range: ${t} > ${e.length}`);if(s.hi=(s.hi|(n.get(t)&127)<<i*7+3)>>>0,n.get(t++)<128)return s}throw RangeError("invalid varint encoding")}}const wye=Math.pow(2,7),bye=Math.pow(2,14),mye=Math.pow(2,21),Eye=Math.pow(2,28),vye=Math.pow(2,35),_ye=Math.pow(2,42),Sye=Math.pow(2,49),Aye=Math.pow(2,56),$ye=Math.pow(2,63),pt={encodingLength(r){return r<wye?1:r<bye?2:r<mye?3:r<Eye?4:r<vye?5:r<_ye?6:r<Sye?7:r<Aye?8:r<$ye?9:10},encode(r,e,t=0){if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return e==null&&(e=Ys(pt.encodingLength(r))),zs.fromNumber(r).toBytes(e,t),e},decode(r,e=0){return zs.fromBytes(r,e).toNumber(!0)}},Rye={ERR_SIGNATURE_NOT_VALID:"ERR_SIGNATURE_NOT_VALID"};var U1;(function(r){let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.publicKey=t.bytes();break;case 2:s.payloadType=t.bytes();break;case 3:s.payload=t.bytes();break;case 5:s.signature=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(U1||(U1={}));const ho=class ho{constructor(e){k(this,"peerId");k(this,"payloadType");k(this,"payload");k(this,"signature");k(this,"marshaled");const{peerId:t,payloadType:n,payload:s,signature:i}=e;this.peerId=t,this.payloadType=n,this.payload=s,this.signature=i}marshal(){if(this.peerId.publicKey==null)throw new Error("Missing public key");return this.marshaled==null&&(this.marshaled=U1.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return me(this.marshal(),e.marshal())}async validate(e){const t=U_(e,this.payloadType,this.payload);if(this.peerId.publicKey==null)throw new Error("Missing public key");return ka(this.peerId.publicKey).verify(t.subarray(),this.signature)}};k(ho,"createFromProtobuf",async e=>{const t=U1.decode(e),n=await rs(t.publicKey);return new ho({peerId:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})}),k(ho,"seal",async(e,t)=>{if(t.privateKey==null)throw new Error("Missing private key");const n=e.domain,s=e.codec,i=e.marshal(),o=U_(n,s,i),c=await(await Vo(t.privateKey)).sign(o.subarray());return new ho({peerId:t,payloadType:s,payload:i,signature:c})}),k(ho,"openAndCertify",async(e,t)=>{const n=await ho.createFromProtobuf(e);if(!await n.validate(t))throw new B("envelope signature is not valid for the given domain",Rye.ERR_SIGNATURE_NOT_VALID);return n});let Oi=ho;const U_=(r,e,t)=>{const n=L(r),s=pt.encode(n.byteLength),i=pt.encode(e.length),o=pt.encode(t.length);return new ue(s,n,i,e,o,t)};function Tye(r,e){const t=(n,s)=>n.toString().localeCompare(s.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,s)=>e[s].equals(n)))}const Iye="libp2p-peer-record",Cye=Uint8Array.from([3,1]);var B1;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=Wr((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={multiaddr:new Uint8Array(0)},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.multiaddr=s.bytes();break;default:s.skipType(c&7);break}}return o})),n),t.encode=s=>Qr(s,t.codec()),t.decode=s=>Yr(s,t.codec())})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.peerId=t.bytes();break;case 2:s.seq=t.uint64();break;case 3:s.addresses.push(r.AddressInfo.codec().decode(t,t.uint32()));break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(B1||(B1={}));const bi=class bi{constructor(e){k(this,"peerId");k(this,"multiaddrs");k(this,"seqNumber");k(this,"domain",bi.DOMAIN);k(this,"codec",bi.CODEC);k(this,"marshaled");const{peerId:t,multiaddrs:n,seqNumber:s}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=B1.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof bi)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!Tye(this.multiaddrs,e.multiaddrs))}};k(bi,"createFromProtobuf",e=>{const t=B1.decode(e),n=ni(t.peerId),s=(t.addresses??[]).map(o=>Lh(o.multiaddr)),i=t.seq;return new bi({peerId:n,multiaddrs:s,seqNumber:i})}),k(bi,"DOMAIN",Iye),k(bi,"CODEC",Cye);let Po=bi;const w3=Symbol.for("@libp2p/topology");function xye(r){return r!=null&&!!r[w3]}const B_=()=>{};var fVe;class Dye{constructor(e){k(this,"min");k(this,"max");k(this,"peers");k(this,"onConnect");k(this,"onDisconnect");k(this,"registrar");k(this,fVe,!0);this.min=e.min??0,this.max=e.max??1/0,this.peers=new Set,this.onConnect=e.onConnect??B_,this.onDisconnect=e.onDisconnect??B_}get[Symbol.toStringTag](){return w3.toString()}async setRegistrar(e){this.registrar=e}disconnect(e){this.onDisconnect(e)}}fVe=w3;function J4(r){return new Dye(r)}var Fs,yT;let gt=(yT=class extends EventTarget{constructor(){super(...arguments);vt(this,Fs,new Map)}listenerCount(t){const n=ce(this,Fs).get(t);return n==null?0:n.length}addEventListener(t,n,s){super.addEventListener(t,n,s);let i=ce(this,Fs).get(t);i==null&&(i=[],ce(this,Fs).set(t,i)),i.push({callback:n,once:(s!==!0&&s!==!1&&s?.once)??!1})}removeEventListener(t,n,s){super.removeEventListener(t.toString(),n??null,s);let i=ce(this,Fs).get(t);i!=null&&(i=i.filter(({callback:o})=>o!==n),ce(this,Fs).set(t,i))}dispatchEvent(t){const n=super.dispatchEvent(t);let s=ce(this,Fs).get(t.type);return s==null||(s=s.filter(({once:i})=>!i),ce(this,Fs).set(t.type,s)),n}safeDispatchEvent(t,n){return this.dispatchEvent(new W(t,n))}},Fs=new WeakMap,yT);class Oye extends Event{constructor(t,n){super(t,n);k(this,"detail");this.detail=n?.detail}}const W=globalThis.CustomEvent??Oye;class Pye{constructor(e,t,n){this.gossip=e,this.msgs=new Map,this.history=[],this.notValidatedCount=0,this.msgIdToStrFn=n;for(let s=0;s<t;s++)this.history[s]=[]}get size(){return this.msgs.size}put(e,t,n=!1){const{msgIdStr:s}=e;return this.msgs.has(s)?!1:(this.msgs.set(s,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){const n=this.msgs.get(e);n&&!n.validated&&n.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){const n=this.msgs.get(e);if(!n)return null;const s=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,s),{msg:n.message,count:s}}getGossipIDs(e){const t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(s=>{const i=this.msgs.get(s.msgIdStr);if(i&&i.validated&&e.has(s.topic)){let o=t.get(s.topic);o||(o=[],t.set(s.topic,o)),o.push(s.msgId)}});return t}validate(e){const t=this.msgs.get(e);if(!t)return null;t.validated||this.notValidatedCount--;const{message:n,originatingPeers:s}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:s}}shift(){this.history[this.history.length-1].forEach(t=>{const n=this.msgs.get(t.msgIdStr);n&&(this.msgs.delete(t.msgIdStr),n.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return t?(this.msgs.delete(e),t):null}}var sP={exports:{}},Ty={},Iy={},Cy,z_;function kye(){if(z_)return Cy;z_=1,Cy=e;var r=ic();function e(i,o){this.lo=i>>>0,this.hi=o>>>0}var t=e.zero=new e(0,0);t.toNumber=function(){return 0},t.zzEncode=t.zzDecode=function(){return this},t.length=function(){return 1};var n=e.zeroHash="\0\0\0\0\0\0\0\0";e.fromNumber=function(o){if(o===0)return t;var a=o<0;a&&(o=-o);var c=o>>>0,u=(o-c)/4294967296>>>0;return a&&(u=~u>>>0,c=~c>>>0,++c>4294967295&&(c=0,++u>4294967295&&(u=0))),new e(c,u)},e.from=function(o){if(typeof o=="number")return e.fromNumber(o);if(r.isString(o))if(r.Long)o=r.Long.fromString(o);else return e.fromNumber(parseInt(o,10));return o.low||o.high?new e(o.low>>>0,o.high>>>0):t},e.prototype.toNumber=function(o){if(!o&&this.hi>>>31){var a=~this.lo+1>>>0,c=~this.hi>>>0;return a||(c=c+1>>>0),-(a+c*4294967296)}return this.lo+this.hi*4294967296},e.prototype.toLong=function(o){return r.Long?new r.Long(this.lo|0,this.hi|0,!!o):{low:this.lo|0,high:this.hi|0,unsigned:!!o}};var s=String.prototype.charCodeAt;return e.fromHash=function(o){return o===n?t:new e((s.call(o,0)|s.call(o,1)<<8|s.call(o,2)<<16|s.call(o,3)<<24)>>>0,(s.call(o,4)|s.call(o,5)<<8|s.call(o,6)<<16|s.call(o,7)<<24)>>>0)},e.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},e.prototype.zzEncode=function(){var o=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^o)>>>0,this.lo=(this.lo<<1^o)>>>0,this},e.prototype.zzDecode=function(){var o=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^o)>>>0,this.hi=(this.hi>>>1^o)>>>0,this},e.prototype.length=function(){var o=this.lo,a=(this.lo>>>28|this.hi<<4)>>>0,c=this.hi>>>24;return c===0?a===0?o<16384?o<128?1:2:o<2097152?3:4:a<16384?a<128?5:6:a<2097152?7:8:c<128?9:10},Cy}var F_;function ic(){return F_||(F_=1,function(r){var e=r;e.asPromise=XM,e.base64=JM,e.EventEmitter=ZM,e.float=eU,e.inquire=tU,e.utf8=rU,e.pool=nU,e.LongBits=kye(),e.isNode=!!(typeof fn<"u"&&fn&&fn.process&&fn.process.versions&&fn.process.versions.node),e.global=e.isNode&&fn||typeof window<"u"&&window||typeof self<"u"&&self||fn,e.emptyArray=Object.freeze?Object.freeze([]):[],e.emptyObject=Object.freeze?Object.freeze({}):{},e.isInteger=Number.isInteger||function(i){return typeof i=="number"&&isFinite(i)&&Math.floor(i)===i},e.isString=function(i){return typeof i=="string"||i instanceof String},e.isObject=function(i){return i&&typeof i=="object"},e.isset=e.isSet=function(i,o){var a=i[o];return a!=null&&i.hasOwnProperty(o)?typeof a!="object"||(Array.isArray(a)?a.length:Object.keys(a).length)>0:!1},e.Buffer=function(){try{var s=e.inquire("buffer").Buffer;return s.prototype.utf8Write?s:null}catch{return null}}(),e._Buffer_from=null,e._Buffer_allocUnsafe=null,e.newBuffer=function(i){return typeof i=="number"?e.Buffer?e._Buffer_allocUnsafe(i):new e.Array(i):e.Buffer?e._Buffer_from(i):typeof Uint8Array>"u"?i:new Uint8Array(i)},e.Array=typeof Uint8Array<"u"?Uint8Array:Array,e.Long=e.global.dcodeIO&&e.global.dcodeIO.Long||e.global.Long||e.inquire("long"),e.key2Re=/^true|false|0|1$/,e.key32Re=/^-?(?:0|[1-9][0-9]*)$/,e.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,e.longToHash=function(i){return i?e.LongBits.from(i).toHash():e.LongBits.zeroHash},e.longFromHash=function(i,o){var a=e.LongBits.fromHash(i);return e.Long?e.Long.fromBits(a.lo,a.hi,o):a.toNumber(!!o)};function t(s,i,o){for(var a=Object.keys(i),c=0;c<a.length;++c)(s[a[c]]===void 0||!o)&&(s[a[c]]=i[a[c]]);return s}e.merge=t,e.lcFirst=function(i){return i.charAt(0).toLowerCase()+i.substring(1)};function n(s){function i(o,a){if(!(this instanceof i))return new i(o,a);Object.defineProperty(this,"message",{get:function(){return o}}),Error.captureStackTrace?Error.captureStackTrace(this,i):Object.defineProperty(this,"stack",{value:new Error().stack||""}),a&&t(this,a)}return(i.prototype=Object.create(Error.prototype)).constructor=i,Object.defineProperty(i.prototype,"name",{get:function(){return s}}),i.prototype.toString=function(){return this.name+": "+this.message},i}e.newError=n,e.ProtocolError=n("ProtocolError"),e.oneOfGetter=function(i){for(var o={},a=0;a<i.length;++a)o[i[a]]=1;return function(){for(var c=Object.keys(this),u=c.length-1;u>-1;--u)if(o[c[u]]===1&&this[c[u]]!==void 0&&this[c[u]]!==null)return c[u]}},e.oneOfSetter=function(i){return function(o){for(var a=0;a<i.length;++a)i[a]!==o&&delete this[i[a]]}},e.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},e._configure=function(){var s=e.Buffer;if(!s){e._Buffer_from=e._Buffer_allocUnsafe=null;return}e._Buffer_from=s.from!==Uint8Array.from&&s.from||function(o,a){return new s(o,a)},e._Buffer_allocUnsafe=s.allocUnsafe||function(o){return new s(o)}}}(Iy)),Iy}var xy,V_;function iP(){if(V_)return xy;V_=1,xy=c;var r=ic(),e,t=r.LongBits,n=r.base64,s=r.utf8;function i(w,y,E){this.fn=w,this.len=y,this.next=void 0,this.val=E}function o(){}function a(w){this.head=w.head,this.tail=w.tail,this.len=w.len,this.next=w.states}function c(){this.len=0,this.head=new i(o,0,0),this.tail=this.head,this.states=null}var u=function(){return r.Buffer?function(){return(c.create=function(){return new e})()}:function(){return new c}};c.create=u(),c.alloc=function(y){return new r.Array(y)},r.Array!==Array&&(c.alloc=r.pool(c.alloc,r.Array.prototype.subarray)),c.prototype._push=function(y,E,m){return this.tail=this.tail.next=new i(y,E,m),this.len+=E,this};function l(w,y,E){y[E]=w&255}function d(w,y,E){for(;w>127;)y[E++]=w&127|128,w>>>=7;y[E]=w}function f(w,y){this.len=w,this.next=void 0,this.val=y}f.prototype=Object.create(i.prototype),f.prototype.fn=d,c.prototype.uint32=function(y){return this.len+=(this.tail=this.tail.next=new f((y=y>>>0)<128?1:y<16384?2:y<2097152?3:y<268435456?4:5,y)).len,this},c.prototype.int32=function(y){return y<0?this._push(g,10,t.fromNumber(y)):this.uint32(y)},c.prototype.sint32=function(y){return this.uint32((y<<1^y>>31)>>>0)};function g(w,y,E){for(;w.hi;)y[E++]=w.lo&127|128,w.lo=(w.lo>>>7|w.hi<<25)>>>0,w.hi>>>=7;for(;w.lo>127;)y[E++]=w.lo&127|128,w.lo=w.lo>>>7;y[E++]=w.lo}c.prototype.uint64=function(y){var E=t.from(y);return this._push(g,E.length(),E)},c.prototype.int64=c.prototype.uint64,c.prototype.sint64=function(y){var E=t.from(y).zzEncode();return this._push(g,E.length(),E)},c.prototype.bool=function(y){return this._push(l,1,y?1:0)};function h(w,y,E){y[E]=w&255,y[E+1]=w>>>8&255,y[E+2]=w>>>16&255,y[E+3]=w>>>24}c.prototype.fixed32=function(y){return this._push(h,4,y>>>0)},c.prototype.sfixed32=c.prototype.fixed32,c.prototype.fixed64=function(y){var E=t.from(y);return this._push(h,4,E.lo)._push(h,4,E.hi)},c.prototype.sfixed64=c.prototype.fixed64,c.prototype.float=function(y){return this._push(r.float.writeFloatLE,4,y)},c.prototype.double=function(y){return this._push(r.float.writeDoubleLE,8,y)};var p=r.Array.prototype.set?function(y,E,m){E.set(y,m)}:function(y,E,m){for(var b=0;b<y.length;++b)E[m+b]=y[b]};return c.prototype.bytes=function(y){var E=y.length>>>0;if(!E)return this._push(l,1,0);if(r.isString(y)){var m=c.alloc(E=n.length(y));n.decode(y,m,0),y=m}return this.uint32(E)._push(p,E,y)},c.prototype.string=function(y){var E=s.length(y);return E?this.uint32(E)._push(s.write,E,y):this._push(l,1,0)},c.prototype.fork=function(){return this.states=new a(this),this.head=this.tail=new i(o,0,0),this.len=0,this},c.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new i(o,0,0),this.len=0),this},c.prototype.ldelim=function(){var y=this.head,E=this.tail,m=this.len;return this.reset().uint32(m),m&&(this.tail.next=y.next,this.tail=E,this.len+=m),this},c.prototype.finish=function(){for(var y=this.head.next,E=this.constructor.alloc(this.len),m=0;y;)y.fn(y.val,E,m),m+=y.len,y=y.next;return E},c._configure=function(w){e=w,c.create=u(),e._configure()},xy}var Dy,j_;function Nye(){if(j_)return Dy;j_=1,Dy=t;var r=iP();(t.prototype=Object.create(r.prototype)).constructor=t;var e=ic();function t(){r.call(this)}t._configure=function(){t.alloc=e._Buffer_allocUnsafe,t.writeBytesBuffer=e.Buffer&&e.Buffer.prototype instanceof Uint8Array&&e.Buffer.prototype.set.name==="set"?function(i,o,a){o.set(i,a)}:function(i,o,a){if(i.copy)i.copy(o,a,0,i.length);else for(var c=0;c<i.length;)o[a++]=i[c++]}},t.prototype.bytes=function(i){e.isString(i)&&(i=e._Buffer_from(i,"base64"));var o=i.length>>>0;return this.uint32(o),o&&this._push(t.writeBytesBuffer,o,i),this};function n(s,i,o){s.length<40?e.utf8.write(s,i,o):i.utf8Write?i.utf8Write(s,o):i.write(s,o)}return t.prototype.string=function(i){var o=e.Buffer.byteLength(i);return this.uint32(o),o&&this._push(n,o,i),this},t._configure(),Dy}var Oy,q_;function oP(){if(q_)return Oy;q_=1,Oy=i;var r=ic(),e,t=r.LongBits,n=r.utf8;function s(d,f){return RangeError("index out of range: "+d.pos+" + "+(f||1)+" > "+d.len)}function i(d){this.buf=d,this.pos=0,this.len=d.length}var o=typeof Uint8Array<"u"?function(f){if(f instanceof Uint8Array||Array.isArray(f))return new i(f);throw Error("illegal buffer")}:function(f){if(Array.isArray(f))return new i(f);throw Error("illegal buffer")},a=function(){return r.Buffer?function(g){return(i.create=function(p){return r.Buffer.isBuffer(p)?new e(p):o(p)})(g)}:o};i.create=a(),i.prototype._slice=r.Array.prototype.subarray||r.Array.prototype.slice,i.prototype.uint32=function(){var f=4294967295;return function(){if(f=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(f=(f|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(f=(f|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(f=(f|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(f=(f|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return f;if((this.pos+=5)>this.len)throw this.pos=this.len,s(this,10);return f}}(),i.prototype.int32=function(){return this.uint32()|0},i.prototype.sint32=function(){var f=this.uint32();return f>>>1^-(f&1)|0};function c(){var d=new t(0,0),f=0;if(this.len-this.pos>4){for(;f<4;++f)if(d.lo=(d.lo|(this.buf[this.pos]&127)<<f*7)>>>0,this.buf[this.pos++]<128)return d;if(d.lo=(d.lo|(this.buf[this.pos]&127)<<28)>>>0,d.hi=(d.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return d;f=0}else{for(;f<3;++f){if(this.pos>=this.len)throw s(this);if(d.lo=(d.lo|(this.buf[this.pos]&127)<<f*7)>>>0,this.buf[this.pos++]<128)return d}return d.lo=(d.lo|(this.buf[this.pos++]&127)<<f*7)>>>0,d}if(this.len-this.pos>4){for(;f<5;++f)if(d.hi=(d.hi|(this.buf[this.pos]&127)<<f*7+3)>>>0,this.buf[this.pos++]<128)return d}else for(;f<5;++f){if(this.pos>=this.len)throw s(this);if(d.hi=(d.hi|(this.buf[this.pos]&127)<<f*7+3)>>>0,this.buf[this.pos++]<128)return d}throw Error("invalid varint encoding")}i.prototype.bool=function(){return this.uint32()!==0};function u(d,f){return(d[f-4]|d[f-3]<<8|d[f-2]<<16|d[f-1]<<24)>>>0}i.prototype.fixed32=function(){if(this.pos+4>this.len)throw s(this,4);return u(this.buf,this.pos+=4)},i.prototype.sfixed32=function(){if(this.pos+4>this.len)throw s(this,4);return u(this.buf,this.pos+=4)|0};function l(){if(this.pos+8>this.len)throw s(this,8);return new t(u(this.buf,this.pos+=4),u(this.buf,this.pos+=4))}return i.prototype.float=function(){if(this.pos+4>this.len)throw s(this,4);var f=r.float.readFloatLE(this.buf,this.pos);return this.pos+=4,f},i.prototype.double=function(){if(this.pos+8>this.len)throw s(this,4);var f=r.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,f},i.prototype.bytes=function(){var f=this.uint32(),g=this.pos,h=this.pos+f;if(h>this.len)throw s(this,f);return this.pos+=f,Array.isArray(this.buf)?this.buf.slice(g,h):g===h?new this.buf.constructor(0):this._slice.call(this.buf,g,h)},i.prototype.string=function(){var f=this.bytes();return n.read(f,0,f.length)},i.prototype.skip=function(f){if(typeof f=="number"){if(this.pos+f>this.len)throw s(this,f);this.pos+=f}else do if(this.pos>=this.len)throw s(this);while(this.buf[this.pos++]&128);return this},i.prototype.skipType=function(d){switch(d){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(d=this.uint32()&7)!==4;)this.skipType(d);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+d+" at offset "+this.pos)}return this},i._configure=function(d){e=d,i.create=a(),e._configure();var f=r.Long?"toLong":"toNumber";r.merge(i.prototype,{int64:function(){return c.call(this)[f](!1)},uint64:function(){return c.call(this)[f](!0)},sint64:function(){return c.call(this).zzDecode()[f](!1)},fixed64:function(){return l.call(this)[f](!0)},sfixed64:function(){return l.call(this)[f](!1)}})},Oy}var Py,K_;function Lye(){if(K_)return Py;K_=1,Py=t;var r=oP();(t.prototype=Object.create(r.prototype)).constructor=t;var e=ic();function t(n){r.call(this,n)}return t._configure=function(){e.Buffer&&(t.prototype._slice=e.Buffer.prototype.slice)},t.prototype.string=function(){var s=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+s,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+s,this.len))},t._configure(),Py}var ky={},Ny,G_;function Mye(){if(G_)return Ny;G_=1,Ny=e;var r=ic();(e.prototype=Object.create(r.EventEmitter.prototype)).constructor=e;function e(t,n,s){if(typeof t!="function")throw TypeError("rpcImpl must be a function");r.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=!!n,this.responseDelimited=!!s}return e.prototype.rpcCall=function t(n,s,i,o,a){if(!o)throw TypeError("request must be specified");var c=this;if(!a)return r.asPromise(t,c,n,s,i,o);if(!c.rpcImpl){setTimeout(function(){a(Error("already ended"))},0);return}try{return c.rpcImpl(n,s[c.requestDelimited?"encodeDelimited":"encode"](o).finish(),function(l,d){if(l)return c.emit("error",l,n),a(l);if(d===null){c.end(!0);return}if(!(d instanceof i))try{d=i[c.responseDelimited?"decodeDelimited":"decode"](d)}catch(f){return c.emit("error",f,n),a(f)}return c.emit("data",d,n),a(null,d)})}catch(u){c.emit("error",u,n),setTimeout(function(){a(u)},0);return}},e.prototype.end=function(n){return this.rpcImpl&&(n||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this},Ny}var H_;function Uye(){return H_||(H_=1,function(r){var e=r;e.Service=Mye()}(ky)),ky}var Ly,W_;function Bye(){return W_||(W_=1,Ly={}),Ly}var Q_;function zye(){return Q_||(Q_=1,function(r){var e=r;e.build="minimal",e.Writer=iP(),e.BufferWriter=Nye(),e.Reader=oP(),e.BufferReader=Lye(),e.util=ic(),e.rpc=Uye(),e.roots=Bye(),e.configure=t;function t(){e.util._configure(),e.Writer._configure(e.BufferWriter),e.Reader._configure(e.BufferReader)}t()}(Ty)),Ty}var My,Y_;function aP(){return Y_||(Y_=1,My=zye()),My}(function(r){(function(e,t){typeof wT=="function"&&r&&r.exports&&(r.exports=t(aP()))})(fn,function(e){var t=e.Reader,n=e.Writer,s=e.util,i=e.roots.default||(e.roots.default={});return i.RPC=function(){function o(c){if(this.subscriptions=[],this.messages=[],c)for(var u=Object.keys(c),l=0;l<u.length;++l)c[u[l]]!=null&&(this[u[l]]=c[u[l]])}o.prototype.subscriptions=s.emptyArray,o.prototype.messages=s.emptyArray,o.prototype.control=null;var a;return Object.defineProperty(o.prototype,"_control",{get:s.oneOfGetter(a=["control"]),set:s.oneOfSetter(a)}),o.encode=function(u,l){if(l||(l=n.create()),u.subscriptions!=null&&u.subscriptions.length)for(var d=0;d<u.subscriptions.length;++d)i.RPC.SubOpts.encode(u.subscriptions[d],l.uint32(10).fork()).ldelim();if(u.messages!=null&&u.messages.length)for(var d=0;d<u.messages.length;++d)i.RPC.Message.encode(u.messages[d],l.uint32(18).fork()).ldelim();return u.control!=null&&Object.hasOwnProperty.call(u,"control")&&i.RPC.ControlMessage.encode(u.control,l.uint32(26).fork()).ldelim(),l},o.decode=function(u,l){u instanceof t||(u=t.create(u));for(var d=l===void 0?u.len:u.pos+l,f=new i.RPC;u.pos<d;){var g=u.uint32();switch(g>>>3){case 1:f.subscriptions&&f.subscriptions.length||(f.subscriptions=[]),f.subscriptions.push(i.RPC.SubOpts.decode(u,u.uint32()));break;case 2:f.messages&&f.messages.length||(f.messages=[]),f.messages.push(i.RPC.Message.decode(u,u.uint32()));break;case 3:f.control=i.RPC.ControlMessage.decode(u,u.uint32());break;default:u.skipType(g&7);break}}return f},o.fromObject=function(u){if(u instanceof i.RPC)return u;var l=new i.RPC;if(u.subscriptions){if(!Array.isArray(u.subscriptions))throw TypeError(".RPC.subscriptions: array expected");l.subscriptions=[];for(var d=0;d<u.subscriptions.length;++d){if(typeof u.subscriptions[d]!="object")throw TypeError(".RPC.subscriptions: object expected");l.subscriptions[d]=i.RPC.SubOpts.fromObject(u.subscriptions[d])}}if(u.messages){if(!Array.isArray(u.messages))throw TypeError(".RPC.messages: array expected");l.messages=[];for(var d=0;d<u.messages.length;++d){if(typeof u.messages[d]!="object")throw TypeError(".RPC.messages: object expected");l.messages[d]=i.RPC.Message.fromObject(u.messages[d])}}if(u.control!=null){if(typeof u.control!="object")throw TypeError(".RPC.control: object expected");l.control=i.RPC.ControlMessage.fromObject(u.control)}return l},o.toObject=function(u,l){l||(l={});var d={};if((l.arrays||l.defaults)&&(d.subscriptions=[],d.messages=[]),u.subscriptions&&u.subscriptions.length){d.subscriptions=[];for(var f=0;f<u.subscriptions.length;++f)d.subscriptions[f]=i.RPC.SubOpts.toObject(u.subscriptions[f],l)}if(u.messages&&u.messages.length){d.messages=[];for(var f=0;f<u.messages.length;++f)d.messages[f]=i.RPC.Message.toObject(u.messages[f],l)}return u.control!=null&&u.hasOwnProperty("control")&&(d.control=i.RPC.ControlMessage.toObject(u.control,l),l.oneofs&&(d._control="control")),d},o.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},o.SubOpts=function(){function c(l){if(l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.subscribe=null,c.prototype.topic=null;var u;return Object.defineProperty(c.prototype,"_subscribe",{get:s.oneOfGetter(u=["subscribe"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_topic",{get:s.oneOfGetter(u=["topic"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){return f||(f=n.create()),d.subscribe!=null&&Object.hasOwnProperty.call(d,"subscribe")&&f.uint32(8).bool(d.subscribe),d.topic!=null&&Object.hasOwnProperty.call(d,"topic")&&f.uint32(18).string(d.topic),f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.SubOpts;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.subscribe=d.bool();break;case 2:h.topic=d.string();break;default:d.skipType(p&7);break}}return h},c.fromObject=function(d){if(d instanceof i.RPC.SubOpts)return d;var f=new i.RPC.SubOpts;return d.subscribe!=null&&(f.subscribe=!!d.subscribe),d.topic!=null&&(f.topic=String(d.topic)),f},c.toObject=function(d,f){f||(f={});var g={};return d.subscribe!=null&&d.hasOwnProperty("subscribe")&&(g.subscribe=d.subscribe,f.oneofs&&(g._subscribe="subscribe")),d.topic!=null&&d.hasOwnProperty("topic")&&(g.topic=d.topic,f.oneofs&&(g._topic="topic")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.Message=function(){function c(l){if(l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.from=null,c.prototype.data=null,c.prototype.seqno=null,c.prototype.topic="",c.prototype.signature=null,c.prototype.key=null;var u;return Object.defineProperty(c.prototype,"_from",{get:s.oneOfGetter(u=["from"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_data",{get:s.oneOfGetter(u=["data"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_seqno",{get:s.oneOfGetter(u=["seqno"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_signature",{get:s.oneOfGetter(u=["signature"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_key",{get:s.oneOfGetter(u=["key"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){return f||(f=n.create()),d.from!=null&&Object.hasOwnProperty.call(d,"from")&&f.uint32(10).bytes(d.from),d.data!=null&&Object.hasOwnProperty.call(d,"data")&&f.uint32(18).bytes(d.data),d.seqno!=null&&Object.hasOwnProperty.call(d,"seqno")&&f.uint32(26).bytes(d.seqno),f.uint32(34).string(d.topic),d.signature!=null&&Object.hasOwnProperty.call(d,"signature")&&f.uint32(42).bytes(d.signature),d.key!=null&&Object.hasOwnProperty.call(d,"key")&&f.uint32(50).bytes(d.key),f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.Message;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.from=d.bytes();break;case 2:h.data=d.bytes();break;case 3:h.seqno=d.bytes();break;case 4:h.topic=d.string();break;case 5:h.signature=d.bytes();break;case 6:h.key=d.bytes();break;default:d.skipType(p&7);break}}if(!h.hasOwnProperty("topic"))throw s.ProtocolError("missing required 'topic'",{instance:h});return h},c.fromObject=function(d){if(d instanceof i.RPC.Message)return d;var f=new i.RPC.Message;return d.from!=null&&(typeof d.from=="string"?s.base64.decode(d.from,f.from=s.newBuffer(s.base64.length(d.from)),0):d.from.length&&(f.from=d.from)),d.data!=null&&(typeof d.data=="string"?s.base64.decode(d.data,f.data=s.newBuffer(s.base64.length(d.data)),0):d.data.length&&(f.data=d.data)),d.seqno!=null&&(typeof d.seqno=="string"?s.base64.decode(d.seqno,f.seqno=s.newBuffer(s.base64.length(d.seqno)),0):d.seqno.length&&(f.seqno=d.seqno)),d.topic!=null&&(f.topic=String(d.topic)),d.signature!=null&&(typeof d.signature=="string"?s.base64.decode(d.signature,f.signature=s.newBuffer(s.base64.length(d.signature)),0):d.signature.length&&(f.signature=d.signature)),d.key!=null&&(typeof d.key=="string"?s.base64.decode(d.key,f.key=s.newBuffer(s.base64.length(d.key)),0):d.key.length&&(f.key=d.key)),f},c.toObject=function(d,f){f||(f={});var g={};return f.defaults&&(g.topic=""),d.from!=null&&d.hasOwnProperty("from")&&(g.from=f.bytes===String?s.base64.encode(d.from,0,d.from.length):f.bytes===Array?Array.prototype.slice.call(d.from):d.from,f.oneofs&&(g._from="from")),d.data!=null&&d.hasOwnProperty("data")&&(g.data=f.bytes===String?s.base64.encode(d.data,0,d.data.length):f.bytes===Array?Array.prototype.slice.call(d.data):d.data,f.oneofs&&(g._data="data")),d.seqno!=null&&d.hasOwnProperty("seqno")&&(g.seqno=f.bytes===String?s.base64.encode(d.seqno,0,d.seqno.length):f.bytes===Array?Array.prototype.slice.call(d.seqno):d.seqno,f.oneofs&&(g._seqno="seqno")),d.topic!=null&&d.hasOwnProperty("topic")&&(g.topic=d.topic),d.signature!=null&&d.hasOwnProperty("signature")&&(g.signature=f.bytes===String?s.base64.encode(d.signature,0,d.signature.length):f.bytes===Array?Array.prototype.slice.call(d.signature):d.signature,f.oneofs&&(g._signature="signature")),d.key!=null&&d.hasOwnProperty("key")&&(g.key=f.bytes===String?s.base64.encode(d.key,0,d.key.length):f.bytes===Array?Array.prototype.slice.call(d.key):d.key,f.oneofs&&(g._key="key")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlMessage=function(){function c(u){if(this.ihave=[],this.iwant=[],this.graft=[],this.prune=[],u)for(var l=Object.keys(u),d=0;d<l.length;++d)u[l[d]]!=null&&(this[l[d]]=u[l[d]])}return c.prototype.ihave=s.emptyArray,c.prototype.iwant=s.emptyArray,c.prototype.graft=s.emptyArray,c.prototype.prune=s.emptyArray,c.encode=function(l,d){if(d||(d=n.create()),l.ihave!=null&&l.ihave.length)for(var f=0;f<l.ihave.length;++f)i.RPC.ControlIHave.encode(l.ihave[f],d.uint32(10).fork()).ldelim();if(l.iwant!=null&&l.iwant.length)for(var f=0;f<l.iwant.length;++f)i.RPC.ControlIWant.encode(l.iwant[f],d.uint32(18).fork()).ldelim();if(l.graft!=null&&l.graft.length)for(var f=0;f<l.graft.length;++f)i.RPC.ControlGraft.encode(l.graft[f],d.uint32(26).fork()).ldelim();if(l.prune!=null&&l.prune.length)for(var f=0;f<l.prune.length;++f)i.RPC.ControlPrune.encode(l.prune[f],d.uint32(34).fork()).ldelim();return d},c.decode=function(l,d){l instanceof t||(l=t.create(l));for(var f=d===void 0?l.len:l.pos+d,g=new i.RPC.ControlMessage;l.pos<f;){var h=l.uint32();switch(h>>>3){case 1:g.ihave&&g.ihave.length||(g.ihave=[]),g.ihave.push(i.RPC.ControlIHave.decode(l,l.uint32()));break;case 2:g.iwant&&g.iwant.length||(g.iwant=[]),g.iwant.push(i.RPC.ControlIWant.decode(l,l.uint32()));break;case 3:g.graft&&g.graft.length||(g.graft=[]),g.graft.push(i.RPC.ControlGraft.decode(l,l.uint32()));break;case 4:g.prune&&g.prune.length||(g.prune=[]),g.prune.push(i.RPC.ControlPrune.decode(l,l.uint32()));break;default:l.skipType(h&7);break}}return g},c.fromObject=function(l){if(l instanceof i.RPC.ControlMessage)return l;var d=new i.RPC.ControlMessage;if(l.ihave){if(!Array.isArray(l.ihave))throw TypeError(".RPC.ControlMessage.ihave: array expected");d.ihave=[];for(var f=0;f<l.ihave.length;++f){if(typeof l.ihave[f]!="object")throw TypeError(".RPC.ControlMessage.ihave: object expected");d.ihave[f]=i.RPC.ControlIHave.fromObject(l.ihave[f])}}if(l.iwant){if(!Array.isArray(l.iwant))throw TypeError(".RPC.ControlMessage.iwant: array expected");d.iwant=[];for(var f=0;f<l.iwant.length;++f){if(typeof l.iwant[f]!="object")throw TypeError(".RPC.ControlMessage.iwant: object expected");d.iwant[f]=i.RPC.ControlIWant.fromObject(l.iwant[f])}}if(l.graft){if(!Array.isArray(l.graft))throw TypeError(".RPC.ControlMessage.graft: array expected");d.graft=[];for(var f=0;f<l.graft.length;++f){if(typeof l.graft[f]!="object")throw TypeError(".RPC.ControlMessage.graft: object expected");d.graft[f]=i.RPC.ControlGraft.fromObject(l.graft[f])}}if(l.prune){if(!Array.isArray(l.prune))throw TypeError(".RPC.ControlMessage.prune: array expected");d.prune=[];for(var f=0;f<l.prune.length;++f){if(typeof l.prune[f]!="object")throw TypeError(".RPC.ControlMessage.prune: object expected");d.prune[f]=i.RPC.ControlPrune.fromObject(l.prune[f])}}return d},c.toObject=function(l,d){d||(d={});var f={};if((d.arrays||d.defaults)&&(f.ihave=[],f.iwant=[],f.graft=[],f.prune=[]),l.ihave&&l.ihave.length){f.ihave=[];for(var g=0;g<l.ihave.length;++g)f.ihave[g]=i.RPC.ControlIHave.toObject(l.ihave[g],d)}if(l.iwant&&l.iwant.length){f.iwant=[];for(var g=0;g<l.iwant.length;++g)f.iwant[g]=i.RPC.ControlIWant.toObject(l.iwant[g],d)}if(l.graft&&l.graft.length){f.graft=[];for(var g=0;g<l.graft.length;++g)f.graft[g]=i.RPC.ControlGraft.toObject(l.graft[g],d)}if(l.prune&&l.prune.length){f.prune=[];for(var g=0;g<l.prune.length;++g)f.prune[g]=i.RPC.ControlPrune.toObject(l.prune[g],d)}return f},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlIHave=function(){function c(l){if(this.messageIDs=[],l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.topicID=null,c.prototype.messageIDs=s.emptyArray;var u;return Object.defineProperty(c.prototype,"_topicID",{get:s.oneOfGetter(u=["topicID"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){if(f||(f=n.create()),d.topicID!=null&&Object.hasOwnProperty.call(d,"topicID")&&f.uint32(10).string(d.topicID),d.messageIDs!=null&&d.messageIDs.length)for(var g=0;g<d.messageIDs.length;++g)f.uint32(18).bytes(d.messageIDs[g]);return f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.ControlIHave;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.topicID=d.string();break;case 2:h.messageIDs&&h.messageIDs.length||(h.messageIDs=[]),h.messageIDs.push(d.bytes());break;default:d.skipType(p&7);break}}return h},c.fromObject=function(d){if(d instanceof i.RPC.ControlIHave)return d;var f=new i.RPC.ControlIHave;if(d.topicID!=null&&(f.topicID=String(d.topicID)),d.messageIDs){if(!Array.isArray(d.messageIDs))throw TypeError(".RPC.ControlIHave.messageIDs: array expected");f.messageIDs=[];for(var g=0;g<d.messageIDs.length;++g)typeof d.messageIDs[g]=="string"?s.base64.decode(d.messageIDs[g],f.messageIDs[g]=s.newBuffer(s.base64.length(d.messageIDs[g])),0):d.messageIDs[g].length&&(f.messageIDs[g]=d.messageIDs[g])}return f},c.toObject=function(d,f){f||(f={});var g={};if((f.arrays||f.defaults)&&(g.messageIDs=[]),d.topicID!=null&&d.hasOwnProperty("topicID")&&(g.topicID=d.topicID,f.oneofs&&(g._topicID="topicID")),d.messageIDs&&d.messageIDs.length){g.messageIDs=[];for(var h=0;h<d.messageIDs.length;++h)g.messageIDs[h]=f.bytes===String?s.base64.encode(d.messageIDs[h],0,d.messageIDs[h].length):f.bytes===Array?Array.prototype.slice.call(d.messageIDs[h]):d.messageIDs[h]}return g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlIWant=function(){function c(u){if(this.messageIDs=[],u)for(var l=Object.keys(u),d=0;d<l.length;++d)u[l[d]]!=null&&(this[l[d]]=u[l[d]])}return c.prototype.messageIDs=s.emptyArray,c.encode=function(l,d){if(d||(d=n.create()),l.messageIDs!=null&&l.messageIDs.length)for(var f=0;f<l.messageIDs.length;++f)d.uint32(10).bytes(l.messageIDs[f]);return d},c.decode=function(l,d){l instanceof t||(l=t.create(l));for(var f=d===void 0?l.len:l.pos+d,g=new i.RPC.ControlIWant;l.pos<f;){var h=l.uint32();switch(h>>>3){case 1:g.messageIDs&&g.messageIDs.length||(g.messageIDs=[]),g.messageIDs.push(l.bytes());break;default:l.skipType(h&7);break}}return g},c.fromObject=function(l){if(l instanceof i.RPC.ControlIWant)return l;var d=new i.RPC.ControlIWant;if(l.messageIDs){if(!Array.isArray(l.messageIDs))throw TypeError(".RPC.ControlIWant.messageIDs: array expected");d.messageIDs=[];for(var f=0;f<l.messageIDs.length;++f)typeof l.messageIDs[f]=="string"?s.base64.decode(l.messageIDs[f],d.messageIDs[f]=s.newBuffer(s.base64.length(l.messageIDs[f])),0):l.messageIDs[f].length&&(d.messageIDs[f]=l.messageIDs[f])}return d},c.toObject=function(l,d){d||(d={});var f={};if((d.arrays||d.defaults)&&(f.messageIDs=[]),l.messageIDs&&l.messageIDs.length){f.messageIDs=[];for(var g=0;g<l.messageIDs.length;++g)f.messageIDs[g]=d.bytes===String?s.base64.encode(l.messageIDs[g],0,l.messageIDs[g].length):d.bytes===Array?Array.prototype.slice.call(l.messageIDs[g]):l.messageIDs[g]}return f},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlGraft=function(){function c(l){if(l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.topicID=null;var u;return Object.defineProperty(c.prototype,"_topicID",{get:s.oneOfGetter(u=["topicID"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){return f||(f=n.create()),d.topicID!=null&&Object.hasOwnProperty.call(d,"topicID")&&f.uint32(10).string(d.topicID),f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.ControlGraft;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.topicID=d.string();break;default:d.skipType(p&7);break}}return h},c.fromObject=function(d){if(d instanceof i.RPC.ControlGraft)return d;var f=new i.RPC.ControlGraft;return d.topicID!=null&&(f.topicID=String(d.topicID)),f},c.toObject=function(d,f){f||(f={});var g={};return d.topicID!=null&&d.hasOwnProperty("topicID")&&(g.topicID=d.topicID,f.oneofs&&(g._topicID="topicID")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.ControlPrune=function(){function c(l){if(this.peers=[],l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.topicID=null,c.prototype.peers=s.emptyArray,c.prototype.backoff=null;var u;return Object.defineProperty(c.prototype,"_topicID",{get:s.oneOfGetter(u=["topicID"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_backoff",{get:s.oneOfGetter(u=["backoff"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){if(f||(f=n.create()),d.topicID!=null&&Object.hasOwnProperty.call(d,"topicID")&&f.uint32(10).string(d.topicID),d.peers!=null&&d.peers.length)for(var g=0;g<d.peers.length;++g)i.RPC.PeerInfo.encode(d.peers[g],f.uint32(18).fork()).ldelim();return d.backoff!=null&&Object.hasOwnProperty.call(d,"backoff")&&f.uint32(24).uint64(d.backoff),f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.ControlPrune;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.topicID=d.string();break;case 2:h.peers&&h.peers.length||(h.peers=[]),h.peers.push(i.RPC.PeerInfo.decode(d,d.uint32()));break;case 3:h.backoff=d.uint64();break;default:d.skipType(p&7);break}}return h},c.fromObject=function(d){if(d instanceof i.RPC.ControlPrune)return d;var f=new i.RPC.ControlPrune;if(d.topicID!=null&&(f.topicID=String(d.topicID)),d.peers){if(!Array.isArray(d.peers))throw TypeError(".RPC.ControlPrune.peers: array expected");f.peers=[];for(var g=0;g<d.peers.length;++g){if(typeof d.peers[g]!="object")throw TypeError(".RPC.ControlPrune.peers: object expected");f.peers[g]=i.RPC.PeerInfo.fromObject(d.peers[g])}}return d.backoff!=null&&(s.Long?(f.backoff=s.Long.fromValue(d.backoff)).unsigned=!0:typeof d.backoff=="string"?f.backoff=parseInt(d.backoff,10):typeof d.backoff=="number"?f.backoff=d.backoff:typeof d.backoff=="object"&&(f.backoff=new s.LongBits(d.backoff.low>>>0,d.backoff.high>>>0).toNumber(!0))),f},c.toObject=function(d,f){f||(f={});var g={};if((f.arrays||f.defaults)&&(g.peers=[]),d.topicID!=null&&d.hasOwnProperty("topicID")&&(g.topicID=d.topicID,f.oneofs&&(g._topicID="topicID")),d.peers&&d.peers.length){g.peers=[];for(var h=0;h<d.peers.length;++h)g.peers[h]=i.RPC.PeerInfo.toObject(d.peers[h],f)}return d.backoff!=null&&d.hasOwnProperty("backoff")&&(typeof d.backoff=="number"?g.backoff=f.longs===String?String(d.backoff):d.backoff:g.backoff=f.longs===String?s.Long.prototype.toString.call(d.backoff):f.longs===Number?new s.LongBits(d.backoff.low>>>0,d.backoff.high>>>0).toNumber(!0):d.backoff,f.oneofs&&(g._backoff="backoff")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o.PeerInfo=function(){function c(l){if(l)for(var d=Object.keys(l),f=0;f<d.length;++f)l[d[f]]!=null&&(this[d[f]]=l[d[f]])}c.prototype.peerID=null,c.prototype.signedPeerRecord=null;var u;return Object.defineProperty(c.prototype,"_peerID",{get:s.oneOfGetter(u=["peerID"]),set:s.oneOfSetter(u)}),Object.defineProperty(c.prototype,"_signedPeerRecord",{get:s.oneOfGetter(u=["signedPeerRecord"]),set:s.oneOfSetter(u)}),c.encode=function(d,f){return f||(f=n.create()),d.peerID!=null&&Object.hasOwnProperty.call(d,"peerID")&&f.uint32(10).bytes(d.peerID),d.signedPeerRecord!=null&&Object.hasOwnProperty.call(d,"signedPeerRecord")&&f.uint32(18).bytes(d.signedPeerRecord),f},c.decode=function(d,f){d instanceof t||(d=t.create(d));for(var g=f===void 0?d.len:d.pos+f,h=new i.RPC.PeerInfo;d.pos<g;){var p=d.uint32();switch(p>>>3){case 1:h.peerID=d.bytes();break;case 2:h.signedPeerRecord=d.bytes();break;default:d.skipType(p&7);break}}return h},c.fromObject=function(d){if(d instanceof i.RPC.PeerInfo)return d;var f=new i.RPC.PeerInfo;return d.peerID!=null&&(typeof d.peerID=="string"?s.base64.decode(d.peerID,f.peerID=s.newBuffer(s.base64.length(d.peerID)),0):d.peerID.length&&(f.peerID=d.peerID)),d.signedPeerRecord!=null&&(typeof d.signedPeerRecord=="string"?s.base64.decode(d.signedPeerRecord,f.signedPeerRecord=s.newBuffer(s.base64.length(d.signedPeerRecord)),0):d.signedPeerRecord.length&&(f.signedPeerRecord=d.signedPeerRecord)),f},c.toObject=function(d,f){f||(f={});var g={};return d.peerID!=null&&d.hasOwnProperty("peerID")&&(g.peerID=f.bytes===String?s.base64.encode(d.peerID,0,d.peerID.length):f.bytes===Array?Array.prototype.slice.call(d.peerID):d.peerID,f.oneofs&&(g._peerID="peerID")),d.signedPeerRecord!=null&&d.hasOwnProperty("signedPeerRecord")&&(g.signedPeerRecord=f.bytes===String?s.base64.encode(d.signedPeerRecord,0,d.signedPeerRecord.length):f.bytes===Array?Array.prototype.slice.call(d.signedPeerRecord):d.signedPeerRecord,f.oneofs&&(g._signedPeerRecord="signedPeerRecord")),g},c.prototype.toJSON=function(){return this.constructor.toObject(this,e.util.toJSONOptions)},c}(),o}(),i})})(sP);var Fye=sP.exports;const Vye=Ge(Fye),{RPC:Z4}=Vye,Fh=1e3,e5=60*Fh,X_="/floodsub/1.0.0",J_="/meshsub/1.0.0",cP="/meshsub/1.1.0",jye=6,qye=4,Kye=12,Gye=4,Hye=2,Wye=5,Qye=3,Yye=6,Xye=.25,Jye=3,Z_=100,Zye=Fh,ewe=e5,twe=16,rwe=e5,nwe=15,swe=300,iwe=Fh,owe=60,awe=2,cwe=10*Fh,gc=5e3,lwe=10,uwe=3*Fh,dwe=2*e5,hwe=120*1e3,fwe="ERR_TOPIC_VALIDATOR_REJECT",pwe="ERR_TOPIC_VALIDATOR_IGNORE",gwe=0,ywe=128,wwe=1e3,bwe=1e3;function ui(r){if(r.length<=1)return r;const e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){const n=e(),s=r[t];r[t]=r[n],r[n]=s}return r}function mwe(r){return C(r,"base64")}const z1="StrictSign",t5="StrictNoSign";var Si;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(Si||(Si={}));var eS;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(eS||(eS={}));var dl;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(dl||(dl={}));var Cs;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(Cs||(Cs={}));var tn;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(tn||(tn={}));var ls;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(ls||(ls={}));function tS(r){switch(r){case Si.Ignore:return Cs.Ignore;case Si.Reject:return Cs.Reject}}async function Ewe(r,e){switch(r){case z1:{if(!e)throw Error("Must provide PeerId");if(e.privateKey==null)throw Error("Cannot sign message, no private key present");if(e.publicKey==null)throw Error("Cannot sign message, no public key present");const t=await Vo(e.privateKey);return{type:dl.Signing,author:e,key:e.publicKey,privateKey:t}}case t5:return{type:dl.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}const Ke="ERR_INVALID_PEER_SCORE_PARAMS",vwe={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},_we={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function Swe(r={}){return{...vwe,...r,topics:r.topics?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=Awe(n),e),{}):{}}}function Awe(r={}){return{..._we,...r}}function $we(r){for(const[e,t]of Object.entries(r.topics))try{Rwe(t)}catch(n){throw new B(`invalid score parameters for topic ${e}: ${n.message}`,Ke)}if(r.topicScoreCap<0)throw new B("invalid topic score cap; must be positive (or 0 for no cap)",Ke);if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw new B("missing application specific score function",Ke);if(r.IPColocationFactorWeight>0)throw new B("invalid IPColocationFactorWeight; must be negative (or 0 to disable)",Ke);if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw new B("invalid IPColocationFactorThreshold; must be at least 1",Ke);if(r.behaviourPenaltyWeight>0)throw new B("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)",Ke);if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw new B("invalid BehaviourPenaltyDecay; must be between 0 and 1",Ke);if(r.decayInterval<1e3)throw new B("invalid DecayInterval; must be at least 1s",Ke);if(r.decayToZero<=0||r.decayToZero>=1)throw new B("invalid DecayToZero; must be between 0 and 1",Ke)}function Rwe(r){if(r.topicWeight<0)throw new B("invalid topic weight; must be >= 0",Ke);if(r.timeInMeshQuantum===0)throw new B("invalid TimeInMeshQuantum; must be non zero",Ke);if(r.timeInMeshWeight<0)throw new B("invalid TimeInMeshWeight; must be positive (or 0 to disable)",Ke);if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw new B("invalid TimeInMeshQuantum; must be positive",Ke);if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw new B("invalid TimeInMeshCap; must be positive",Ke);if(r.firstMessageDeliveriesWeight<0)throw new B("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)",Ke);if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw new B("invalid FirstMessageDeliveriesDecay; must be between 0 and 1",Ke);if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw new B("invalid FirstMessageDeliveriesCap; must be positive",Ke);if(r.meshMessageDeliveriesWeight>0)throw new B("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)",Ke);if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw new B("invalid MeshMessageDeliveriesDecay; must be between 0 and 1",Ke);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw new B("invalid MeshMessageDeliveriesCap; must be positive",Ke);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw new B("invalid MeshMessageDeliveriesThreshold; must be positive",Ke);if(r.meshMessageDeliveriesWindow<0)throw new B("invalid MeshMessageDeliveriesWindow; must be non-negative",Ke);if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw new B("invalid MeshMessageDeliveriesActivation; must be at least 1s",Ke);if(r.meshFailurePenaltyWeight>0)throw new B("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)",Ke);if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw new B("invalid MeshFailurePenaltyDecay; must be between 0 and 1",Ke);if(r.invalidMessageDeliveriesWeight>0)throw new B("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)",Ke);if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw new B("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1",Ke)}const Twe={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function Iwe(r={}){return{...Twe,...r}}function Cwe(r,e,t,n){let s=0;Object.entries(e.topics).forEach(([o,a])=>{const c=t.topics[o];if(c===void 0)return;let u=0;if(a.inMesh){let g=a.meshTime/c.timeInMeshQuantum;g>c.timeInMeshCap&&(g=c.timeInMeshCap),u+=g*c.timeInMeshWeight}let l=a.firstMessageDeliveries;if(l>c.firstMessageDeliveriesCap&&(l=c.firstMessageDeliveriesCap),u+=l*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){const g=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,h=g*g;u+=h*c.meshMessageDeliveriesWeight}const d=a.meshFailurePenalty;u+=d*c.meshFailurePenaltyWeight;const f=a.invalidMessageDeliveries*a.invalidMessageDeliveries;u+=f*c.invalidMessageDeliveriesWeight,s+=u*c.topicWeight}),t.topicScoreCap>0&&s>t.topicScoreCap&&(s=t.topicScoreCap);const i=t.appSpecificScore(r);if(s+=i*t.appSpecificWeight,e.knownIPs.forEach(o=>{if(t.IPColocationFactorWhitelist.has(o))return;const a=n.get(o),c=a?a.size:0;if(c>t.IPColocationFactorThreshold){const u=c-t.IPColocationFactorThreshold,l=u*u;s+=l*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){const o=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=o*o;s+=a*t.behaviourPenaltyWeight}return s}function Et(r,t){var t=t||{};this._head=0,this._tail=0,this._capacity=t.capacity,this._capacityMask=3,this._list=new Array(4),Array.isArray(r)&&this._fromArray(r)}Et.prototype.peekAt=function(e){var t=e;if(t===(t|0)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}};Et.prototype.get=function(e){return this.peekAt(e)};Et.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};Et.prototype.peekFront=function(){return this.peek()};Et.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(Et.prototype,"length",{get:function(){return this.size()}});Et.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Et.prototype.unshift=function(e){if(e===void 0)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Et.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}};Et.prototype.push=function(e){if(e===void 0)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};Et.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}};Et.prototype.removeOne=function(e){var t=e;if(t===(t|0)&&this._head!==this._tail){var n=this.size(),s=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var i=this._list[t],o;if(e<n/2){for(o=e;o>0;o--)this._list[t]=this._list[t=t-1+s&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+s&this._capacityMask}else{for(o=n-1-e;o>0;o--)this._list[t]=this._list[t=t+1+s&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+s&this._capacityMask}return i}}};Et.prototype.remove=function(e,t){var n=e,s,i=t;if(n===(n|0)&&this._head!==this._tail){var o=this.size(),a=this._list.length;if(!(n>=o||n<-o||t<1)){if(n<0&&(n+=o),t===1||!t)return s=new Array(1),s[0]=this.removeOne(n),s;if(n===0&&n+t>=o)return s=this.toArray(),this.clear(),s;n+t>o&&(t=o-n);var c;for(s=new Array(t),c=0;c<t;c++)s[c]=this._list[this._head+n+c&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===o){for(this._tail=this._tail-t+a&this._capacityMask,c=t;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(e===0){for(this._head=this._head+t+a&this._capacityMask,c=t-1;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return s}if(n<o/2){for(this._head=this._head+e+t+a&this._capacityMask,c=e;c>0;c--)this.unshift(this._list[n=n-1+a&this._capacityMask]);for(n=this._head-1+a&this._capacityMask;i>0;)this._list[n=n-1+a&this._capacityMask]=void 0,i--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+a&this._capacityMask,c=o-(t+e);c>0;c--)this.push(this._list[n++]);for(n=this._tail;i>0;)this._list[n=n+1+a&this._capacityMask]=void 0,i--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),s}}};Et.prototype.splice=function(e,t){var n=e;if(n===(n|0)){var s=this.size();if(n<0&&(n+=s),!(n>s))if(arguments.length>2){var i,o,a,c=arguments.length,u=this._list.length,l=2;if(!s||n<s/2){for(o=new Array(n),i=0;i<n;i++)o[i]=this._list[this._head+i&this._capacityMask];for(t===0?(a=[],n>0&&(this._head=this._head+n+u&this._capacityMask)):(a=this.remove(n,t),this._head=this._head+n+u&this._capacityMask);c>l;)this.unshift(arguments[--c]);for(i=n;i>0;i--)this.unshift(o[i-1])}else{o=new Array(s-(n+t));var d=o.length;for(i=0;i<d;i++)o[i]=this._list[this._head+n+t+i&this._capacityMask];for(t===0?(a=[],n!=s&&(this._tail=this._head+n+u&this._capacityMask)):(a=this.remove(n,t),this._tail=this._tail-d+u&this._capacityMask);l<c;)this.push(arguments[l++]);for(i=0;i<d;i++)this.push(o[i])}return a}else return this.remove(n,t)}};Et.prototype.clear=function(){this._head=0,this._tail=0};Et.prototype.isEmpty=function(){return this._head===this._tail};Et.prototype.toArray=function(){return this._copyArray(!1)};Et.prototype._fromArray=function(e){for(var t=0;t<e.length;t++)this.push(e[t])};Et.prototype._copyArray=function(e){var t=[],n=this._list,s=n.length,i;if(e||this._head>this._tail){for(i=this._head;i<s;i++)t.push(n[i]);for(i=0;i<this._tail;i++)t.push(n[i])}else for(i=this._head;i<this._tail;i++)t.push(n[i]);return t};Et.prototype._growArray=function(){this._head&&(this._list=this._copyArray(!0),this._head=0),this._tail=this._list.length,this._list.length<<=1,this._capacityMask=this._capacityMask<<1|1};Et.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};var xwe=Et;const Dwe=Ge(xwe);var rn;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(rn||(rn={}));class Owe{constructor(){this.records=new Map,this.queue=new Dwe}ensureRecord(e){let t=this.records.get(e);if(t)return t;t={status:rn.unknown,firstSeen:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const n={msgId:e,expire:Date.now()+hwe};return this.queue.push(n),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;t&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}function b3(r,e,t=()=>!0){const n=new Set;if(e<=0)return n;for(const s of r){if(n.size>=e)break;t(s)&&(n.add(s),r.delete(s))}return n}function Pwe(r,e){return b3(r,e,()=>!0)}class kwe extends Map{constructor(e){super(),this.getDefault=e}getOrDefault(e){let t=super.get(e);return t===void 0&&(t=this.getDefault(),this.set(e,t)),t}}const yc=N("libp2p:gossipsub:score");class Nwe{constructor(e,t,n){this.params=e,this.metrics=t,this.peerStats=new Map,this.peerIPs=new kwe(()=>new Set),this.scoreCache=new Map,this.deliveryRecords=new Owe,$we(e),this.scoreCacheValidityMs=n.scoreCacheValidityMs,this.computeScore=n.computeScore??Cwe}get size(){return this.peerStats.size}start(){if(this._backgroundInterval){yc("Peer score already running");return}this._backgroundInterval=setInterval(()=>this.background(),this.params.decayInterval),yc("started")}stop(){if(!this._backgroundInterval){yc("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),yc("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,s)=>{if(!n.connected){e>n.expire&&(this.removeIPsForPeer(s,n.knownIPs),this.peerStats.delete(s),this.scoreCache.delete(s));return}Object.entries(n.topics).forEach(([i,o])=>{const a=this.params.topics[i];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<t&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<t&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<t&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<t&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=e-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){this.metrics?.scoreFnCalls.inc();const t=this.peerStats.get(e);if(!t)return 0;const n=Date.now(),s=this.scoreCache.get(e);if(s&&s.cacheUntil>n)return s.score;this.metrics?.scoreFnRuns.inc();const i=this.computeScore(e,t,this.params,this.peerIPs),o=n+this.scoreCacheValidityMs;return s?(this.metrics?.scoreCachedDelta.observe(Math.abs(i-s.score)),s.score=i,s.cacheUntil=o):this.scoreCache.set(e,{score:i,cacheUntil:o}),i}addPenalty(e,t,n){const s=this.peerStats.get(e);s&&(s.behaviourPenalty+=t,this.metrics?.onScorePenalty(n))}addPeer(e){const t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){const n=this.peerStats.get(e);n&&n.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){const n=this.peerStats.get(e);n&&n.knownIPs.delete(t);const s=this.peerIPs.get(t);s&&(s.delete(e),s.size===0&&this.peerIPs.delete(t))}removePeer(e){const t=this.peerStats.get(e);if(t){if(this.score(e)>0){this.removeIPsForPeer(e,t.knownIPs),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,s])=>{s.firstMessageDeliveries=0;const i=this.params.topics[n].meshMessageDeliveriesThreshold;if(s.inMesh&&s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.inMesh=!1,s.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);s&&(s.inMesh=!0,s.graftTime=Date.now(),s.meshTime=0,s.meshMessageDeliveriesActive=!1)}}prune(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);if(s){const i=this.params.topics[t].meshMessageDeliveriesThreshold;if(s.meshMessageDeliveriesActive&&s.meshMessageDeliveries<i){const o=i-s.meshMessageDeliveries;s.meshFailurePenalty+=o*o}s.meshMessageDeliveriesActive=!1,s.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);const s=this.deliveryRecords.ensureRecord(t),i=Date.now();if(s.status!==rn.unknown){yc("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,i-s.firstSeen,rn[s.status]);return}s.status=rn.valid,s.validated=i,s.peers.forEach(o=>{o!==e.toString()&&this.markDuplicateMessageDelivery(o,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,s){switch(s){case Cs.Error:this.markInvalidMessageDelivery(e,n);return;case Cs.Blacklisted:return}const i=this.deliveryRecords.ensureRecord(t);if(i.status!==rn.unknown){yc("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-i.firstSeen,rn[i.status]);return}if(s===Cs.Ignore){i.status=rn.ignored,i.peers.clear();return}i.status=rn.invalid,this.markInvalidMessageDelivery(e,n),i.peers.forEach(o=>{this.markInvalidMessageDelivery(o,n)}),i.peers.clear()}duplicateMessage(e,t,n){const s=this.deliveryRecords.ensureRecord(t);if(!s.peers.has(e))switch(s.status){case rn.unknown:s.peers.add(e);break;case rn.valid:s.peers.add(e),this.markDuplicateMessageDelivery(e,n,s.validated);break;case rn.invalid:this.markInvalidMessageDelivery(e,n);break;case rn.ignored:break}}markInvalidMessageDelivery(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);s&&(s.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const n=this.peerStats.get(e);if(n){const s=this.getPtopicStats(n,t);if(s){let i=this.params.topics[t].firstMessageDeliveriesCap;s.firstMessageDeliveries=Math.min(i,s.firstMessageDeliveries+1),s.inMesh&&(i=this.params.topics[t].meshMessageDeliveriesCap,s.meshMessageDeliveries=Math.min(i,s.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){const s=this.peerStats.get(e);if(s){const i=n!==void 0?Date.now():0,o=this.getPtopicStats(s,t);if(o&&o.inMesh){const a=this.params.topics[t];if(n!==void 0){const u=i-n,l=u>a.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,u,l),l)return}const c=a.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(c,o.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(const n of t){const s=this.peerIPs.get(n);s&&(s.delete(e),s.size===0&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}class Lwe{constructor(e,t,n){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.promises=new Map,this.requestMsByMsg=new Map,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const n=Math.floor(Math.random()*t.length),s=t[n],i=this.msgIdToStrFn(s);let o=this.promises.get(i);o||(o=new Map,this.promises.set(i,o));const a=Date.now();o.has(e)||(o.set(e,a+this.gossipsubIWantFollowupMs),this.metrics&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(i)||this.requestMsByMsg.set(i,a)))}getBrokenPromises(){const e=Date.now(),t=new Map;let n=0;return this.promises.forEach((s,i)=>{s.forEach((o,a)=>{o<e&&(t.set(a,(t.get(a)??0)+1),s.delete(a),n++)}),s.size||this.promises.delete(i)}),this.metrics?.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);const n=this.promises.get(e);n&&(this.promises.delete(e),this.metrics&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){switch(this.trackMessage(e),t){case Cs.Error:return}this.promises.delete(e)}clear(){this.promises.clear()}prune(){const e=Date.now()-this.requestMsByMsgExpire;let t=0;for(const[n,s]of this.requestMsByMsg.entries())if(s<e)this.requestMsByMsg.delete(n),t++;else break;this.metrics?.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics){const t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}class Uy{constructor(e){this.entries=new Map,this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return this.entries.has(e)?!0:(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const e=Date.now();for(const[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var rS;(function(r){r.forward="forward",r.publish="publish"})(rS||(rS={}));var co;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(co||(co={}));var Mc;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Unsub="unsubscribed",r.Excess="excess"})(Mc||(Mc={}));var bd;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(bd||(bd={}));var md;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(md||(md={}));var Uc;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(Uc||(Uc={}));function Mwe(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEvents:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_total",help:"Number of times we include peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),meshPeerChurnEvents:r.gauge({name:"gossipsub_peer_churn_events_total",help:"Number of times we remove peers in a topic mesh for different reasons",labelNames:["topic","reason"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),asyncValidationResult:r.gauge({name:"gossipsub_async_validation_result_total",help:"Message validation result for each topic",labelNames:["topic","acceptance"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),peerReadStreamError:r.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:r.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:r.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeers:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),msgPublishPeersByGroup:r.gauge({name:"gossipsub_msg_publish_peers_by_group",help:"Total count of peers (by group) that we publish a msg to",labelNames:["topic","peerGroup"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:r.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),msgReceivedStatus:r.gauge({name:"gossipsub_msg_received_status_total",help:"Tracks distribution of recv msgs by duplicate, invalid, valid",labelNames:["topic","status"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["topic","error"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,1*t.maxMeshMessageDeliveriesWindowSec,2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:r.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores",labelNames:["topic","p"]}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,1*t.behaviourPenaltyThreshold,2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:r.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:r.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,1*t.gossipPromiseExpireSec,2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),iwantPromiseUntracked:r.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:r.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:r.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:r.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,s,i){const o=this.toTopic(n);this.meshPeerInclusionEvents.inc({topic:o,reason:s},i)},onRemoveFromMesh(n,s,i){const o=this.toTopic(n);this.meshPeerChurnEvents.inc({topic:o,reason:s},i)},onReportValidationMcacheHit(n){this.asyncValidationMcacheHit.inc({hit:n?"hit":"miss"})},onReportValidation(n,s){const i=this.toTopic(n);this.asyncValidationResult.inc({topic:i,acceptance:s})},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,s,i){const o=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:o},s),this.ihaveRcvNotSeenMsgids.inc({topic:o},i)},onIwantRcv(n,s){for(const[i,o]of n){const a=this.toTopic(i);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(s)},onForwardMsg(n,s){const i=this.toTopic(n);this.msgForwardCount.inc({topic:i},1),this.msgForwardPeers.inc({topic:i},s)},onPublishMsg(n,s,i,o){const a=this.toTopic(n);this.msgPublishCount.inc({topic:a},1),this.msgPublishBytes.inc({topic:a},i*o),this.msgPublishPeers.inc({topic:a},i),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"direct"},s.direct),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"floodsub"},s.floodsub),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"mesh"},s.mesh),this.msgPublishPeersByGroup.inc({topic:a,peerGroup:"fanout"},s.fanout)},onMsgRecvPreValidation(n){const s=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:s},1)},onMsgRecvError(n){const s=this.toTopic(n);this.msgReceivedError.inc({topic:s},1)},onMsgRecvResult(n,s){const i=this.toTopic(n);this.msgReceivedStatus.inc({topic:i,status:s})},onMsgRecvInvalid(n,s){const i=this.toTopic(n),o=s.reason===Cs.Error?s.error:s.reason;this.msgReceivedInvalid.inc({topic:i,error:o},1)},onDuplicateMsgDelivery(n,s,i){if(this.duplicateMsgDeliveryDelay.observe(s/1e3),i){const o=this.toTopic(n);this.duplicateMsgLateDelivery.inc({topic:o},1)}},onPublishDuplicateMsg(n){const s=this.toTopic(n);this.duplicateMsgIgnored.inc({topic:s},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(n,s){this.rpcRecvBytes.inc(s),this.rpcRecvCount.inc(1),n.subscriptions&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages&&this.rpcRecvMessage.inc(n.messages.length),n.control&&(this.rpcRecvControl.inc(1),n.control.ihave&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,s){if(this.rpcSentBytes.inc(s),this.rpcSentCount.inc(1),n.subscriptions&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages&&this.rpcSentMessage.inc(n.messages.length),n.control){const i=n.control.ihave?.length??0,o=n.control.iwant?.length??0,a=n.control.graft?.length??0,c=n.control.prune?.length??0;i>0&&this.rpcSentIHave.inc(i),o>0&&this.rpcSentIWant.inc(o),a>0&&this.rpcSentGraft.inc(a),c>0&&this.rpcSentPrune.inc(c),(i>0||o>0||a>0||c>0)&&this.rpcSentControl.inc(1)}},registerScores(n,s){let i=0,o=0,a=0,c=0;for(const u of n)u>=s.graylistThreshold&&i++,u>=s.publishThreshold&&o++,u>=s.gossipThreshold&&a++,u>=0&&c++;this.peersByScoreThreshold.set({threshold:Uc.graylist},i),this.peersByScoreThreshold.set({threshold:Uc.publish},o),this.peersByScoreThreshold.set({threshold:Uc.gossip},a),this.peersByScoreThreshold.set({threshold:Uc.mesh},c),this.score.set(n)},registerScoreWeights(n){for(const[s,i]of n.byTopic)this.scoreWeights.set({topic:s,p:"p1"},i.p1w),this.scoreWeights.set({topic:s,p:"p2"},i.p2w),this.scoreWeights.set({topic:s,p:"p3"},i.p3w),this.scoreWeights.set({topic:s,p:"p3b"},i.p3bw),this.scoreWeights.set({topic:s,p:"p4"},i.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,s){const i=new Map;n.forEach((o,a)=>{const c=this.topicStrToLabel.get(a)??"unknown";let u=i.get(c);u||(u=new Set,i.set(c,u)),o.forEach(l=>u?.add(l))});for(const[o,a]of i){const c=[];a.forEach(u=>{c.push(s.get(u)??0)}),this.scorePerMesh.set({topic:o},c)}}}}const lP=L("libp2p-pubsub:");async function Uwe(r,e,t,n){switch(r.type){case dl.Signing:{const s={from:r.author.toBytes(),data:n,seqno:J0(8),topic:e,signature:void 0,key:void 0},i=M([lP,Z4.Message.encode(s).finish()]);s.signature=await r.privateKey.sign(i),s.key=r.key;const o={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${C(s.seqno,"base16")}`),topic:e,signature:s.signature,key:s.key};return{raw:s,msg:o}}case dl.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}}}}async function Bwe(r,e){switch(r){case t5:return e.signature!=null?{valid:!1,error:tn.SignaturePresent}:e.seqno!=null?{valid:!1,error:tn.SeqnoPresent}:e.key!=null?{valid:!1,error:tn.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case z1:{if(e.seqno==null)return{valid:!1,error:tn.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:tn.InvalidSeqno};if(e.signature==null)return{valid:!1,error:tn.InvalidSignature};if(e.from==null)return{valid:!1,error:tn.InvalidPeerId};let t;try{t=ni(e.from)}catch{return{valid:!1,error:tn.InvalidPeerId}}let n;if(e.key){if(n=ka(e.key),t.publicKey!==void 0&&!me(n.bytes,t.publicKey))return{valid:!1,error:tn.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:tn.InvalidPeerId};n=ka(t.publicKey)}const s={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},i=M([lP,Z4.Message.encode(s).finish()]);return await n.verify(i,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${C(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:e.key??em(n)}}:{valid:!1,error:tn.InvalidSignature}}}}const zwe=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},r5=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Fwe=r=>new TextEncoder().encode(r),Vwe=r=>new TextDecoder().decode(r);var jwe=uP,nS=128,qwe=127,Kwe=~qwe,Gwe=Math.pow(2,31);function uP(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Gwe;)e[t++]=r&255|nS,r/=128;for(;r&Kwe;)e[t++]=r&255|nS,r>>>=7;return e[t]=r|0,uP.bytes=t-n+1,e}var Hwe=m3,Wwe=128,sS=127;function m3(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw m3.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&sS)<<s:(o&sS)*Math.pow(2,s),s+=7}while(o>=Wwe);return m3.bytes=i-n,t}var Qwe=Math.pow(2,7),Ywe=Math.pow(2,14),Xwe=Math.pow(2,21),Jwe=Math.pow(2,28),Zwe=Math.pow(2,35),ebe=Math.pow(2,42),tbe=Math.pow(2,49),rbe=Math.pow(2,56),nbe=Math.pow(2,63),sbe=function(r){return r<Qwe?1:r<Ywe?2:r<Xwe?3:r<Jwe?4:r<Zwe?5:r<ebe?6:r<tbe?7:r<rbe?8:r<nbe?9:10},ibe={encode:jwe,decode:Hwe,encodingLength:sbe},F1=ibe;const E3=(r,e=0)=>[F1.decode(r,e),F1.decode.bytes],V1=(r,e,t=0)=>(F1.encode(r,e,t),e),j1=r=>F1.encodingLength(r),v3=(r,e)=>{const t=e.byteLength,n=j1(r),s=n+j1(t),i=new Uint8Array(s+t);return V1(r,i,0),V1(t,i,n),i.set(e,s),new n5(r,t,e,i)},dP=r=>{const e=r5(r),[t,n]=E3(e),[s,i]=E3(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new n5(t,s,o,e)},obe=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&zwe(r.bytes,t.bytes)}};let n5=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const abe=({name:r,code:e,encode:t})=>new cbe(r,e,t);let cbe=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?v3(this.code,t):t.then(n=>v3(this.code,n))}else throw Error("Unknown type, must be binary type")}};const lbe=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),ube=abe({name:"sha2-256",code:18,encode:lbe("SHA-256")}),dbe=(r,e)=>{const t=L(e.toString(16).padStart(16,"0"),"base16"),n=new Uint8Array(r.length+t.length);return n.set(r,0),n.set(t,r.length),n};function hbe(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return dbe(r.from.toBytes(),r.sequenceNumber)}async function fbe(r){return await ube.encode(r.data)}function pbe(r,e,t,n,s){let i=0;const o=new Map;if(Object.entries(e.topics).forEach(([f,g])=>{const h=s.get(f)??"unknown",p=t.topics[f];if(p===void 0)return;let w=o.get(h);w||(w={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(h,w));let y=0,E=0,m=0,b=0,v=0;if(g.inMesh){const T=Math.max(g.meshTime/p.timeInMeshQuantum,p.timeInMeshCap);y+=T*p.timeInMeshWeight}let S=g.firstMessageDeliveries;if(S>p.firstMessageDeliveriesCap&&(S=p.firstMessageDeliveriesCap),E+=S*p.firstMessageDeliveriesWeight,g.meshMessageDeliveriesActive&&g.meshMessageDeliveries<p.meshMessageDeliveriesThreshold){const T=p.meshMessageDeliveriesThreshold-g.meshMessageDeliveries,P=T*T;m+=P*p.meshMessageDeliveriesWeight}const _=g.meshFailurePenalty;b+=_*p.meshFailurePenaltyWeight;const A=g.invalidMessageDeliveries*g.invalidMessageDeliveries;v+=A*p.invalidMessageDeliveriesWeight,i+=(y+E+m+b+v)*p.topicWeight,w.p1w+=y,w.p2w+=E,w.p3w+=m,w.p3bw+=b,w.p4w+=v}),t.topicScoreCap>0&&i>t.topicScoreCap){i=t.topicScoreCap;const f=t.topicScoreCap/i;for(const g of o.values())g.p1w*=f,g.p2w*=f,g.p3w*=f,g.p3bw*=f,g.p4w*=f}let a=0,c=0,u=0;const l=t.appSpecificScore(r);a+=l*t.appSpecificWeight,e.knownIPs.forEach(f=>{if(t.IPColocationFactorWhitelist.has(f))return;const g=n.get(f),h=g?g.size:0;if(h>t.IPColocationFactorThreshold){const p=h-t.IPColocationFactorThreshold,w=p*p;c+=w*t.IPColocationFactorWeight}});const d=e.behaviourPenalty*e.behaviourPenalty;return u+=d*t.behaviourPenaltyWeight,i+=a+c+u,{byTopic:o,p5w:a,p6w:c,p7w:u,score:i}}function gbe(r,e,t,n,s){const i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of r){const a=e.get(o);if(a){const c=pbe(o,a,t,n,s);for(const[u,l]of c.byTopic){let d=i.byTopic.get(u);d||(d={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(u,d)),d.p1w.push(l.p1w),d.p2w.push(l.p2w),d.p3w.push(l.p3w),d.p3bw.push(l.p3bw),d.p4w.push(l.p4w)}i.p5w.push(c.p5w),i.p6w.push(c.p6w),i.p7w.push(c.p7w),i.score.push(c.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}let q1=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function K1(r,e,t){const n=t??{},s=Wa(r);async function*i(){let o;const a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){const{abortMessage:l,abortCode:d}=n;throw new q1(l,d)}const u=new Promise((l,d)=>{o=()=>{const{abortMessage:f,abortCode:g}=n;d(new q1(f,g))}});c=await Promise.race([u,s.next()]),o=null}catch(u){e.removeEventListener("abort",a);const l=u.type==="aborted"&&e.aborted;if(l&&n.onAbort!=null&&await n.onAbort(r),typeof s.return=="function")try{const d=s.return();d instanceof Promise&&d.catch(f=>{n.onReturnError!=null&&n.onReturnError(f)})}catch(d){n.onReturnError!=null&&n.onReturnError(d)}if(l&&n.returnOnAbort===!0)return;throw u}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return i()}function ybe(r){return globalThis?.Buffer?.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r)}const K2=r=>{const e=pt.encodingLength(r),t=ybe(e);return pt.encode(r,t),K2.bytes=e,t};K2.bytes=0;function hP(r){r=r??{};const e=r.lengthEncoder??K2;return async function*(n){for await(const s of n){const i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}}}hP.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??K2;return new ue(t(r.byteLength),r)};const wbe=8,bbe=1024*1024*4;var sa;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(sa||(sa={}));const s5=r=>{const e=pt.decode(r);return s5.bytes=pt.encodingLength(e),e};s5.bytes=0;function _3(r){return async function*(t){const n=new ue;let s=sa.LENGTH,i=-1;const o=r?.lengthDecoder??s5,a=r?.maxLengthLength??wbe,c=r?.maxDataLength??bbe;for await(const u of t)for(n.append(u);n.byteLength>0;){if(s===sa.LENGTH)try{if(i=o(n),i<0)throw $(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(i>c)throw $(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const l=o.bytes;n.consume(l),r?.onLength!=null&&r.onLength(i),s=sa.DATA}catch(l){if(l instanceof RangeError){if(n.byteLength>a)throw $(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw l}if(s===sa.DATA){if(n.byteLength<i)break;const l=n.sublist(0,i);n.consume(i),r?.onData!=null&&r.onData(l),yield l,s=sa.LENGTH}}if(n.byteLength>0)throw $(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}}_3.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return _3({...e??{},onLength:i=>{t=i}})(n)};class mbe{constructor(e,t,n){this.rawStream=e,this.pushable=Mt({objectMode:!1}),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,Ae(K1(this.pushable,this.closeController.signal,{returnOnAbort:!0}),hP(),this.rawStream).catch(t)}get protocol(){return this.rawStream.stat.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}close(){this.closeController.abort(),this.pushable.return(),this.rawStream.close()}}class Ebe{constructor(e,t={}){this.rawStream=e,this.closeController=new AbortController,this.source=K1(Ae(this.rawStream,_3(t)),this.closeController.signal,{returnOnAbort:!0})}close(){this.closeController.abort(),this.rawStream.close()}}var vbe=aP();const _be=Ge(vbe),Sbe={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};function Abe(r,e){e={...e};const t=_be.Reader.create(r),n=r.length,s=n===void 0?t.len:t.pos+n,i={};for(;t.pos<s;){const o=t.uint32();switch(o>>>3){case 1:i.subscriptions&&i.subscriptions.length||(i.subscriptions=[]),i.subscriptions.length<e.maxSubscriptions?i.subscriptions.push($be(t,t.uint32())):t.skipType(o&7);break;case 2:i.messages&&i.messages.length||(i.messages=[]),i.messages.length<e.maxMessages?i.messages.push(Rbe(t,t.uint32())):t.skipType(o&7);break;case 3:i.control=Tbe(t,t.uint32(),e);break;default:t.skipType(o&7);break}}return i}function $be(r,e){const t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){const s=r.uint32();switch(s>>>3){case 1:n.subscribe=r.bool();break;case 2:n.topic=r.string();break;default:r.skipType(s&7);break}}return n}function Rbe(r,e){const t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){const s=r.uint32();switch(s>>>3){case 1:n.from=r.bytes();break;case 2:n.data=r.bytes();break;case 3:n.seqno=r.bytes();break;case 4:n.topic=r.string();break;case 5:n.signature=r.bytes();break;case 6:n.key=r.bytes();break;default:r.skipType(s&7);break}}if(!n.topic)throw Error("missing required 'topic'");return n}function Tbe(r,e,t){const n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){const i=r.uint32();switch(i>>>3){case 1:s.ihave&&s.ihave.length||(s.ihave=[]),s.ihave.length<t.maxControlMessages?s.ihave.push(Ibe(r,r.uint32(),t)):r.skipType(i&7);break;case 2:s.iwant&&s.iwant.length||(s.iwant=[]),s.iwant.length<t.maxControlMessages?s.iwant.push(Cbe(r,r.uint32(),t)):r.skipType(i&7);break;case 3:s.graft&&s.graft.length||(s.graft=[]),s.graft.length<t.maxControlMessages?s.graft.push(xbe(r,r.uint32())):r.skipType(i&7);break;case 4:s.prune&&s.prune.length||(s.prune=[]),s.prune.length<t.maxControlMessages?s.prune.push(Dbe(r,r.uint32(),t)):r.skipType(i&7);break;default:r.skipType(i&7);break}}return s}function Ibe(r,e,t){const n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){const i=r.uint32();switch(i>>>3){case 1:s.topicID=r.string();break;case 2:s.messageIDs&&s.messageIDs.length||(s.messageIDs=[]),t.maxIhaveMessageIDs-- >0?s.messageIDs.push(r.bytes()):r.skipType(i&7);break;default:r.skipType(i&7);break}}return s}function Cbe(r,e,t){const n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){const i=r.uint32();switch(i>>>3){case 1:s.messageIDs&&s.messageIDs.length||(s.messageIDs=[]),t.maxIwantMessageIDs-- >0?s.messageIDs.push(r.bytes()):r.skipType(i&7);break;default:r.skipType(i&7);break}}return s}function xbe(r,e){const t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){const s=r.uint32();switch(s>>>3){case 1:n.topicID=r.string();break;default:r.skipType(s&7);break}}return n}function Dbe(r,e,t){const n=e===void 0?r.len:r.pos+e,s={};for(;r.pos<n;){const i=r.uint32();switch(i>>>3){case 1:s.topicID=r.string();break;case 2:s.peers&&s.peers.length||(s.peers=[]),t.maxPeerInfos-- >0?s.peers.push(Obe(r,r.uint32())):r.skipType(i&7);break;case 3:s.backoff=r.uint64();break;default:r.skipType(i&7);break}}return s}function Obe(r,e){const t=e===void 0?r.len:r.pos+e,n={};for(;r.pos<t;){const s=r.uint32();switch(s>>>3){case 1:n.peerID=r.bytes();break;case 2:n.signedPeerRecord=r.bytes();break;default:r.skipType(s&7);break}}return n}var G1;(function(r){r[r.ip4=4]="ip4",r[r.ip6=41]="ip6"})(G1||(G1={}));function Pbe(r){for(const e of r.tuples())switch(e[0]){case G1.ip4:case G1.ip6:return I4(e[0],e[1])}return null}var dn;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(dn||(dn={}));class fP extends gt{constructor(e,t={}){super(),this.multicodecs=[cP,J_],this.peers=new Set,this.streamsInbound=new Map,this.streamsOutbound=new Map,this.outboundInflightQueue=Mt({objectMode:!0}),this.direct=new Set,this.floodsubPeers=new Set,this.acceptFromWhitelist=new Map,this.topics=new Map,this.subscriptions=new Set,this.mesh=new Map,this.fanout=new Map,this.fanoutLastpub=new Map,this.gossip=new Map,this.control=new Map,this.peerhave=new Map,this.iasked=new Map,this.backoff=new Map,this.outbound=new Map,this.topicValidators=new Map,this.heartbeatTicks=0,this.directPeerInitial=null,this.status={code:dn.stopped},this.heartbeatTimer=null,this.runHeartbeat=()=>{const s=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(i=>{this.log("Error running heartbeat",i)}).finally(()=>{if(s?.(),this.status.code===dn.started){clearTimeout(this.status.heartbeatTimeout);let i=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;i<this.opts.heartbeatInterval*.25&&(i+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,i)}})};const n={fallbackToFloodsub:!0,floodPublish:!0,doPX:!1,directPeers:[],D:jye,Dlo:qye,Dhi:Kye,Dscore:Gye,Dout:Hye,Dlazy:Yye,heartbeatInterval:Zye,fanoutTTL:ewe,mcacheLength:Wye,mcacheGossip:Qye,seenTTL:dwe,gossipsubIWantFollowupMs:uwe,prunePeers:twe,pruneBackoff:rwe,graftFloodThreshold:cwe,opportunisticGraftPeers:awe,opportunisticGraftTicks:owe,directConnectTicks:swe,...t,scoreParams:Swe(t.scoreParams),scoreThresholds:Iwe(t.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=n.decodeRpcLimits??Sbe,this.globalSignaturePolicy=n.globalSignaturePolicy??z1,n.fallbackToFloodsub&&this.multicodecs.push(X_),this.log=N(n.debugName??"libp2p:gossipsub"),this.opts=n,this.direct=new Set(n.directPeers.map(s=>s.id.toString())),this.seenCache=new Uy({validityMs:n.seenTTL}),this.publishedMessageIds=new Uy({validityMs:n.seenTTL}),t.msgIdFn)this.msgIdFn=t.msgIdFn;else switch(this.globalSignaturePolicy){case z1:this.msgIdFn=hbe;break;case t5:this.msgIdFn=fbe;break}if(t.fastMsgIdFn&&(this.fastMsgIdFn=t.fastMsgIdFn,this.fastMsgIdCache=new Uy({validityMs:n.seenTTL})),this.msgIdToStrFn=t.msgIdToStrFn??mwe,this.mcache=t.messageCache||new Pye(n.mcacheGossip,n.mcacheLength,this.msgIdToStrFn),t.dataTransform&&(this.dataTransform=t.dataTransform),t.metricsRegister){if(!t.metricsTopicStrToLabel)throw Error("Must set metricsTopicStrToLabel with metrics");const s=Math.max(...Object.values(n.scoreParams.topics).map(o=>o.meshMessageDeliveriesWindow),bwe),i=Mwe(t.metricsRegister,t.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:n.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:s/1e3});i.mcacheSize.addCollect(()=>this.onScrapeMetrics(i));for(const o of this.multicodecs)i.protocolsEnabled.set({protocol:o},1);this.metrics=i}else this.metrics=null;this.gossipTracer=new Lwe(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new Nwe(this.opts.scoreParams,this.metrics,{scoreCacheValidityMs:n.heartbeatInterval}),this.maxInboundStreams=t.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams,this.allowedTopics=n.allowedTopics?new Set(n.allowedTopics):null}getPeers(){return[...this.peers.keys()].map(e=>de(e))}isStarted(){return this.status.code===dn.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await Ewe(this.globalSignaturePolicy,this.components.peerId),this.outboundInflightQueue=Mt({objectMode:!0}),Ae(this.outboundInflightQueue,async i=>{for await(const{peerId:o,connection:a}of i)await this.createOutboundStream(o,a)}).catch(i=>this.log.error("outbound inflight queue error",i)),await Promise.all(this.opts.directPeers.map(async i=>{await this.components.peerStore.addressBook.add(i.id,i.addrs)}));const e=this.components.registrar;await Promise.all(this.multicodecs.map(i=>e.handle(i,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams})));const t=J4({onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this)}),n=await Promise.all(this.multicodecs.map(i=>e.register(i,t))),s=setTimeout(this.runHeartbeat,Z_);this.status={code:dn.started,registrarTopologyIds:n,heartbeatTimeout:s,hearbeatStartMs:Date.now()+Z_},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async i=>await this.connect(i)))}).catch(i=>{this.log(i)})},iwe),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==dn.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:dn.stopped};const t=this.components.registrar;e.forEach(n=>t.unregister(n)),this.outboundInflightQueue.end();for(const n of this.streamsOutbound.values())n.close();this.streamsOutbound.clear();for(const n of this.streamsInbound.values())n.close();this.streamsInbound.clear(),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache&&this.fastMsgIdCache.clear(),this.directPeerInitial&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:e,connection:t}){if(!this.isStarted())return;const n=t.remotePeer;this.addPeer(n,t.stat.direction,t.remoteAddr),this.createInboundStream(n,e),this.outboundInflightQueue.push({peerId:n,connection:t})}onPeerConnected(e,t){this.metrics?.newConnectionCount.inc({status:t.stat.status}),!(!this.isStarted()||t.stat.status!=="OPEN")&&(this.addPeer(e,t.stat.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{const s=new mbe(await t.newStream(this.multicodecs),o=>this.log.error("outbound pipe error",o),{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,s);const i=s.protocol;i===X_&&this.floodsubPeers.add(n),this.metrics?.peersPerProtocol.inc({protocol:i},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(s){this.log.error("createOutboundStream error",s)}}async createInboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(!this.peers.has(n))return;const s=this.streamsInbound.get(n);s!==void 0&&(this.log("replacing existing inbound steam %s",n),s.close()),this.log("create inbound stream %s",n);const i=new Ebe(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(n,i),this.pipePeerReadStream(e,i.source).catch(o=>this.log(o))}addPeer(e,t,n){const s=e.toString();if(!this.peers.has(s)){this.log("new peer %p",e),this.peers.add(s),this.score.addPeer(s);const i=Pbe(n);i!==null?this.score.addIP(s,i):this.log("Added peer has no IP in current address %s %s",s,n.toString()),this.outbound.has(s)||this.outbound.set(s,t==="outbound")}}removePeer(e){const t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);const n=this.streamsOutbound.get(t),s=this.streamsInbound.get(t);n&&this.metrics?.peersPerProtocol.inc({protocol:n.protocol},-1),n?.close(),s?.close(),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(const i of this.topics.values())i.delete(t);for(const[i,o]of this.mesh)o.delete(t)===!0&&this.metrics?.onRemoveFromMesh(i,Mc.Dc,1);for(const i of this.fanout.values())i.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===dn.started}getMeshPeers(e){const t=this.mesh.get(e);return t?Array.from(t):[]}getSubscribers(e){const t=this.topics.get(e);return(t?Array.from(t):[]).map(n=>de(n))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await Ae(t,async n=>{for await(const s of n)try{const i=s.subarray(),o=Abe(i,this.decodeRpcLimits);if(this.metrics?.onRpcRecv(o,i.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,o)}catch(a){this.metrics?.onRpcRecvError(),this.log(a)}else this.handleReceivedRpc(e,o).catch(a=>{this.metrics?.onRpcRecvError(),this.log(a)})}catch(i){this.metrics?.onRpcDataError(),this.log(i)}})}catch(n){this.metrics?.onPeerReadStreamError(),this.handlePeerReadStreamError(n,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString())){this.log("received message from unacceptable peer %p",e),this.metrics?.rpcRecvNotAccepted.inc();return}const n=t.subscriptions?t.subscriptions.length:0,s=t.messages?t.messages.length:0;let i=0,o=0,a=0,c=0;if(t.control&&(t.control.ihave&&(i=t.control.ihave.length),t.control.iwant&&(o=t.control.iwant.length),t.control.graft&&(a=t.control.graft.length),t.control.prune&&(c=t.control.prune.length)),this.log(`rpc.from ${e.toString()} subscriptions ${n} messages ${s} ihave ${i} iwant ${o} graft ${a} prune ${c}`),t.subscriptions&&t.subscriptions.length>0){const u=[];t.subscriptions.forEach(l=>{const d=l.topic,f=l.subscribe===!0;if(d!=null){if(this.allowedTopics&&!this.allowedTopics.has(d))return;this.handleReceivedSubscription(e,d,f),u.push({topic:d,subscribe:f})}}),this.dispatchEvent(new W("subscription-change",{detail:{peerId:e,subscriptions:u}}))}if(t.messages)for(const u of t.messages){if(this.allowedTopics&&!this.allowedTopics.has(u.topic))continue;const l=this.handleReceivedMessage(e,u).catch(d=>{this.metrics?.onMsgRecvError(u.topic),this.log(d)});this.opts.awaitRpcMessageHandler&&await l}t.control&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,n){this.log("subscription update from %p topic %s",e,t);let s=this.topics.get(t);s==null&&(s=new Set,this.topics.set(t,s)),n?s.add(e.toString()):s.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);const n=await this.validateReceivedMessage(e,t);switch(this.metrics?.onMsgRecvResult(t.topic,n.code),n.code){case ls.duplicate:this.score.duplicateMessage(e.toString(),n.msgIdStr,t.topic),this.gossipTracer.deliverMessage(n.msgIdStr,!0),this.mcache.observeDuplicate(n.msgIdStr,e.toString());return;case ls.invalid:if(n.msgIdStr){const s=n.msgIdStr;this.score.rejectMessage(e.toString(),s,t.topic,n.reason),this.gossipTracer.rejectMessage(s,n.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);this.metrics?.onMsgRecvInvalid(t.topic,n);return;case ls.valid:this.score.validateMessage(n.messageId.msgIdStr),this.gossipTracer.deliverMessage(n.messageId.msgIdStr),this.mcache.put(n.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)&&(!this.components.peerId.equals(e)||this.opts.emitSelf)&&(super.dispatchEvent(new W("gossipsub:message",{detail:{propagationSource:e,msgId:n.messageId.msgIdStr,msg:n.msg}})),super.dispatchEvent(new W("message",{detail:n.msg}))),this.opts.asyncValidation||this.forwardMessage(n.messageId.msgIdStr,t,e.toString())}}async validateReceivedMessage(e,t){const n=this.fastMsgIdFn?.(t),s=n!==void 0?this.fastMsgIdCache?.get(n):void 0;if(s)return{code:ls.duplicate,msgIdStr:s};const i=await Bwe(this.globalSignaturePolicy,t);if(!i.valid)return{code:ls.invalid,reason:Cs.Error,error:i.error};const o=i.message;try{this.dataTransform&&(o.data=this.dataTransform.inboundTransform(t.topic,o.data))}catch(d){return this.log("Invalid message, transform failed",d),{code:ls.invalid,reason:Cs.Error,error:tn.TransformFailed}}const a=await this.msgIdFn(o),c=this.msgIdToStrFn(a),u={msgId:a,msgIdStr:c};if(n!==void 0&&this.fastMsgIdCache&&this.fastMsgIdCache.put(n,c)&&this.metrics?.fastMsgIdCacheCollision.inc(),this.seenCache.has(c))return{code:ls.duplicate,msgIdStr:c};this.seenCache.put(c);const l=this.topicValidators.get(t.topic);if(l!=null){let d;try{d=await l(e,o)}catch(f){const g=f.code;g===pwe&&(d=Si.Ignore),g===fwe?d=Si.Reject:d=Si.Ignore}if(d!==Si.Accept)return{code:ls.invalid,reason:tS(d),msgIdStr:c}}return{code:ls.valid,messageId:u,msg:o}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map(s=>({topic:s,subscribe:n}))})}async handleControlMessage(e,t){if(t===void 0)return;const n=t.ihave?this.handleIHave(e,t.ihave):[],s=t.iwant?this.handleIWant(e,t.iwant):[],i=t.graft?await this.handleGraft(e,t.graft):[];if(t.prune&&await this.handlePrune(e,t.prune),!n.length&&!s.length&&!i.length)return;const o=this.sendRpc(e,{messages:s,control:{iwant:n,prune:i}}),a=n[0]?.messageIDs;a&&(o?this.gossipTracer.addPromise(e,a):this.metrics?.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;const t=Date.now(),n=this.acceptFromWhitelist.get(e);if(n&&n.messagesAccepted<ywe&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;const s=this.score.score(e);return s>=gwe?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+wwe}):this.acceptFromWhitelist.delete(e),s>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(!t.length)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:md.LowScore}),[];const s=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,s),s>lwe)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:md.MaxIhave}),[];const i=this.iasked.get(e)??0;if(i>=gc)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,i),this.metrics?.ihaveRcvIgnored.inc({reason:md.MaxIasked}),[];const o=new Map;if(t.forEach(({topicID:u,messageIDs:l})=>{if(!u||!l||!this.mesh.has(u))return;let d=0;l.forEach(f=>{const g=this.msgIdToStrFn(f);this.seenCache.has(g)||(o.set(g,f),d++)}),this.metrics?.onIhaveRcv(u,l.length,d)}),!o.size)return[];let a=o.size;a+i>gc&&(a=gc-i),this.log("IHAVE: Asking for %d out of %d messages from %s",a,o.size,e);let c=Array.from(o.values());return ui(c),c=c.slice(0,a),this.iasked.set(e,i+a),[{messageIDs:c}]}handleIWant(e,t){if(!t.length)return[];const n=this.score.score(e);if(n<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,n),[];const s=new Map,i=new Map;let o=0;return t.forEach(({messageIDs:a})=>{a&&a.forEach(c=>{const u=this.msgIdToStrFn(c),l=this.mcache.getWithIWantCount(u,e);if(l==null){o++;return}if(i.set(l.msg.topic,1+(i.get(l.msg.topic)??0)),l.count>Jye){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,c);return}s.set(u,l.msg)})}),this.metrics?.onIwantRcv(i,o),s.size?(this.log("IWANT: Sending %d messages to %s",s.size,e),Array.from(s.values())):(this.log("IWANT: Could not provide any wanted messages to %s",e),[])}async handleGraft(e,t){const n=[],s=this.score.score(e),i=Date.now();let o=this.opts.doPX;return t.forEach(({topicID:a})=>{if(!a)return;const c=this.mesh.get(a);if(!c){o=!1;return}if(c.has(e))return;if(this.direct.has(e)){this.log("GRAFT: ignoring request from direct peer %s",e),n.push(a),o=!1;return}const u=this.backoff.get(a)?.get(e);if(typeof u=="number"&&i<u){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,bd.GraftBackoff),o=!1;const l=u+this.opts.graftFloodThreshold-this.opts.pruneBackoff;i<l&&this.score.addPenalty(e,1,bd.GraftBackoff),this.addBackoff(e,a),n.push(a);return}if(s<0){this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,s,a),n.push(a),o=!1,this.addBackoff(e,a);return}if(c.size>=this.opts.Dhi&&!this.outbound.get(e)){n.push(a),this.addBackoff(e,a);return}this.log("GRAFT: Add mesh link from %s in %s",e,a),this.score.graft(e,a),c.add(e),this.metrics?.onAddToMesh(a,co.Subscribed,1)}),n.length?await Promise.all(n.map(a=>this.makePrune(e,a,o))):[]}async handlePrune(e,t){const n=this.score.score(e);for(const{topicID:s,backoff:i,peers:o}of t){if(s==null)continue;const a=this.mesh.get(s);if(!a)return;if(this.log("PRUNE: Remove mesh link to %s in %s",e,s),this.score.prune(e,s),a.has(e)&&(a.delete(e),this.metrics?.onRemoveFromMesh(s,Mc.Unsub,1)),typeof i=="number"&&i>0?this.doAddBackoff(e,s,i*1e3):this.addBackoff(e,s),o&&o.length){if(n<this.opts.scoreThresholds.acceptPXThreshold){this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,s);continue}await this.pxConnect(o)}}}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){let s=this.backoff.get(t);s||(s=new Map,this.backoff.set(t,s));const i=Date.now()+n;(s.get(e)??0)<i&&s.set(e,i)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,bd.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%nwe!==0)return;const e=Date.now();this.backoff.forEach((t,n)=>{t.forEach((s,i)=>{s<e&&t.delete(i)}),t.size===0&&this.backoff.delete(n)})}async directConnect(){const e=[];this.direct.forEach(t=>{this.streamsOutbound.has(t)||e.push(t)}),await Promise.all(e.map(async t=>await this.connect(t)))}async pxConnect(e){e.length>this.opts.prunePeers&&(ui(e),e=e.slice(0,this.opts.prunePeers));const t=[];await Promise.all(e.map(async n=>{if(!n.peerID)return;const s=ni(n.peerID).toString();if(!this.peers.has(s)){if(!n.signedPeerRecord){t.push(s);return}try{const i=await Oi.openAndCertify(n.signedPeerRecord,"libp2p-peer-record"),o=i.peerId;if(!i.peerId.equals(s)){this.log("bogus peer record obtained through px: peer ID %p doesn't match expected peer %p",o,s);return}if(!await this.components.peerStore.addressBook.consumePeerRecord(i)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}t.push(s)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),t.length&&await Promise.all(t.map(async n=>await this.connect(n)))}async connect(e){this.log("Initiating connection with %s",e);const t=de(e),n=await this.components.connectionManager.openConnection(t);for(const s of this.multicodecs)for(const i of this.components.registrar.getTopologies(s))i.onConnect(t,n)}subscribe(e){if(this.status.code!==dn.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==dn.started)throw new Error("Pubsub is not started");const t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(const n of this.peers.keys())this.sendSubscriptions(n,[e],!1);this.leave(e)}join(e){if(this.status.code!==dn.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);const t=new Set,n=this.fanout.get(e);if(n&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),n.forEach(s=>{!this.direct.has(s)&&this.score.score(s)>=0&&t.add(s)}),this.metrics?.onAddToMesh(e,co.Fanout,t.size)),t.size<this.opts.D){const s=t.size;this.getRandomGossipPeers(e,this.opts.D,o=>!t.has(o)&&!this.direct.has(o)&&this.score.score(o)>=0).forEach(o=>{t.add(o)}),this.metrics?.onAddToMesh(e,co.Random,t.size-s)}this.mesh.set(e,t),t.forEach(s=>{this.log("JOIN: Add mesh link to %s in %s",s,e),this.sendGraft(s,e)})}leave(e){if(this.status.code!==dn.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);const t=this.mesh.get(e);t&&(Promise.all(Array.from(t).map(async n=>(this.log("LEAVE: Remove mesh link to %s in %s",n,e),await this.sendPrune(n,e)))).catch(n=>{this.log("Error sending prunes to mesh peers",n)}),this.mesh.delete(e))}selectPeersToForward(e,t,n){const s=new Set,i=this.topics.get(e);i&&(this.direct.forEach(a=>{i.has(a)&&t!==a&&!n?.has(a)&&s.add(a)}),this.floodsubPeers.forEach(a=>{i.has(a)&&t!==a&&!n?.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&s.add(a)}));const o=this.mesh.get(e);return o&&o.size>0&&o.forEach(a=>{t!==a&&!n?.has(a)&&s.add(a)}),s}selectPeersToPublish(e){const t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},s=this.topics.get(e);if(s)if(this.opts.floodPublish)s.forEach(i=>{this.direct.has(i)?(t.add(i),n.direct++):this.score.score(i)>=this.opts.scoreThresholds.publishThreshold&&(t.add(i),n.floodsub++)});else{this.direct.forEach(o=>{s.has(o)&&(t.add(o),n.direct++)}),this.floodsubPeers.forEach(o=>{s.has(o)&&this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(t.add(o),n.floodsub++)});const i=this.mesh.get(e);if(i&&i.size>0)i.forEach(o=>{t.add(o),n.mesh++});else{const o=this.fanout.get(e);if(o&&o.size>0)o.forEach(a=>{t.add(a),n.fanout++});else{const a=this.getRandomGossipPeers(e,this.opts.D,c=>this.score.score(c)>=this.opts.scoreThresholds.publishThreshold);a.size>0&&(this.fanout.set(e,a),a.forEach(c=>{t.add(c),n.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,s){n&&this.score.deliverMessage(n,e,t.topic);const i=this.selectPeersToForward(t.topic,n,s);i.forEach(o=>{this.sendRpc(o,{messages:[t]})}),this.metrics?.onForwardMsg(t.topic,i.size)}async publish(e,t,n){const s=this.dataTransform?this.dataTransform.outboundTransform(e,t):t;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");const{raw:i,msg:o}=await Uwe(this.publishConfig,e,t,s),a=await this.msgIdFn(o),c=this.msgIdToStrFn(a),u=n?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(c)){if(u)return this.metrics?.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:l,tosendCount:d}=this.selectPeersToPublish(e),f=this.opts.emitSelf===!0&&this.subscriptions.has(e),g=n?.allowPublishToZeroPeers??this.opts.allowPublishToZeroPeers;if(l.size===0&&!g&&!f)throw Error("PublishError.InsufficientPeers");this.seenCache.put(c),this.mcache.put({msgId:a,msgIdStr:c},i,!0),this.publishedMessageIds.put(c);for(const h of l)this.sendRpc(h,{messages:[i]})||l.delete(h);return this.metrics?.onPublishMsg(e,d,l.size,i.data!=null?i.data.length:0),f&&(l.add(this.components.peerId.toString()),super.dispatchEvent(new W("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:c,msg:o}})),super.dispatchEvent(new W("message",{detail:o}))),{recipients:Array.from(l.values()).map(h=>de(h))}}reportMessageValidationResult(e,t,n){if(n===Si.Accept){const s=this.mcache.validate(e);if(this.metrics?.onReportValidationMcacheHit(s!==null),s!=null){const{message:i,originatingPeers:o}=s;this.score.deliverMessage(t.toString(),e,i.topic),this.forwardMessage(e,s.message,t.toString(),o),this.metrics?.onReportValidation(i.topic,n)}}else{const s=this.mcache.remove(e);if(this.metrics?.onReportValidationMcacheHit(s!==null),s){const i=tS(n),{message:o,originatingPeers:a}=s;this.score.rejectMessage(t.toString(),e,o.topic,i);for(const c of a)this.score.rejectMessage(c,e,o.topic,i);this.metrics?.onReportValidation(o.topic,n)}}}sendGraft(e,t){const n=[{topicID:t}];this.sendRpc(e,{control:{graft:n}})}async sendPrune(e,t){const n=[await this.makePrune(e,t,this.opts.doPX)];this.sendRpc(e,{control:{prune:n}})}sendRpc(e,t){const n=this.streamsOutbound.get(e);if(!n)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const s=this.control.get(e);s&&(this.piggybackControl(e,t,s),this.control.delete(e));const i=this.gossip.get(e);i&&(this.piggybackGossip(e,t,i),this.gossip.delete(e));const o=Z4.encode(t).finish();try{n.push(o)}catch(a){return this.log.error(`Cannot send rpc to ${e}`,a),s&&this.control.set(e,s),i&&this.gossip.set(e,i),!1}return this.metrics?.onRpcSent(t,o.length),!0}piggybackControl(e,t,n){if(n.graft){t.control||(t.control={}),t.control.graft||(t.control.graft=[]);for(const s of n.graft)s.topicID&&this.mesh.get(s.topicID)?.has(e)&&t.control.graft.push(s)}if(n.prune){t.control||(t.control={}),t.control.prune||(t.control.prune=[]);for(const s of n.prune)s.topicID&&!this.mesh.get(s.topicID)?.has(e)&&t.control.prune.push(s)}}piggybackGossip(e,t,n){t.control||(t.control={}),t.control.ihave=n}async sendGraftPrune(e,t,n){const s=this.opts.doPX;for(const[i,o]of e){const a=o.map(l=>({topicID:l}));let c=[];const u=t.get(i);u&&(c=await Promise.all(u.map(async l=>await this.makePrune(i,l,s&&!(n.get(i)??!1)))),t.delete(i)),this.sendRpc(i,{control:{graft:a,prune:c}})}for(const[i,o]of t){const a=await Promise.all(o.map(async c=>await this.makePrune(i,c,s&&!(n.get(i)??!1))));this.sendRpc(i,{control:{prune:a}})}}emitGossip(e){const t=this.mcache.getGossipIDs(new Set(e.keys()));for(const[n,s]of e)this.doEmitGossip(n,s,t.get(n)??[])}doEmitGossip(e,t,n){if(!n.length||(ui(n),n.length>gc&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",n.length),!t.size))return;let s=this.opts.Dlazy;const i=Xye*t.size;let o=t;i>s&&(s=i),s>o.size?s=o.size:o=ui(Array.from(o)).slice(0,s),o.forEach(a=>{let c=n;n.length>gc&&(c=ui(c.slice()).slice(0,gc)),this.pushGossip(a,{topicID:e,messageIDs:c})})}flush(){for(const[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,{control:{ihave:t}});for(const[e,t]of this.control.entries())this.control.delete(e),this.sendRpc(e,{control:{graft:t.graft,prune:t.prune}})}pushGossip(e,t){this.log("Add gossip to %s",e);const n=this.gossip.get(e)||[];this.gossip.set(e,n.concat(t))}async makePrune(e,t,n){if(this.score.prune(e,t),this.streamsOutbound.get(e).protocol===J_)return{topicID:t,peers:[]};const s=this.opts.pruneBackoff/1e3;if(!n)return{topicID:t,peers:[],backoff:s};const i=this.getRandomGossipPeers(t,this.opts.prunePeers,a=>a!==e&&this.score.score(a)>=0),o=await Promise.all(Array.from(i).map(async a=>{const c=de(a);return{peerID:c.toBytes(),signedPeerRecord:await this.components.peerStore.addressBook.getRawEnvelope(c)}}));return{topicID:t,peers:o,backoff:s}}async heartbeat(){const{D:e,Dlo:t,Dhi:n,Dscore:s,Dout:i,fanoutTTL:o}=this.opts;this.heartbeatTicks++;const a=new Map,c=h=>{let p=a.get(h);return p===void 0&&(p=this.score.score(h),a.set(h,p)),p},u=new Map,l=new Map,d=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const f=new Map;this.mesh.forEach((h,p)=>{const w=this.topics.get(p),y=new Set,E=new Set;if(f.set(p,E),w){const v=ui(Array.from(w)),S=this.backoff.get(p);for(const _ of v){const A=this.streamsOutbound.get(_);if(A&&this.multicodecs.includes(A.protocol)&&!h.has(_)&&!this.direct.has(_)){const T=c(_);(!S||!S.has(_))&&T>=0&&y.add(_),T>=this.opts.scoreThresholds.gossipThreshold&&E.add(_)}}}const m=(v,S)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",v,p),this.addBackoff(v,p),h.delete(v),c(v)>=this.opts.scoreThresholds.gossipThreshold&&E.add(v),this.metrics?.onRemoveFromMesh(p,S,1);const _=l.get(v);_?_.push(p):l.set(v,[p])},b=(v,S)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",v,p),this.score.graft(v,p),h.add(v),E.delete(v),this.metrics?.onAddToMesh(p,S,1);const _=u.get(v);_?_.push(p):u.set(v,[p])};if(h.forEach(v=>{const S=c(v);S<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",v,S,p),m(v,Mc.BadScore),d.set(v,!0))}),h.size<t){const v=e-h.size;Pwe(y,v).forEach(_=>{b(_,co.NotEnough)})}if(h.size>n){let v=Array.from(h);v.sort((_,A)=>c(A)-c(_)),v=v.slice(0,s).concat(ui(v.slice(s)));let S=0;if(v.slice(0,e).forEach(_=>{this.outbound.get(_)&&S++}),S<i){const _=T=>{const P=v[T];for(let V=T;V>0;V--)v[V]=v[V-1];v[0]=P};if(S>0){let T=S;for(let P=1;P<e&&T>0;P++)this.outbound.get(v[P])&&(_(P),T--)}let A=e-S;for(let T=e;T<v.length&&A>0;T++)this.outbound.get(v[T])&&(_(T),A--)}v.slice(e).forEach(_=>{m(_,Mc.Excess)})}if(h.size>=t){let v=0;if(h.forEach(S=>{this.outbound.get(S)&&v++}),v<i){const S=i-v;b3(y,S,A=>this.outbound.get(A)===!0).forEach(A=>{b(A,co.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&h.size>1){const v=Array.from(h).sort((A,T)=>c(A)-c(T)),S=Math.floor(h.size/2),_=c(v[S]);if(_<this.opts.scoreThresholds.opportunisticGraftThreshold){const A=this.opts.opportunisticGraftPeers,T=b3(y,A,P=>c(P)>_);for(const P of T)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",P,p),b(P,co.Opportunistic)}}});const g=Date.now();this.fanoutLastpub.forEach((h,p)=>{h+o<g&&(this.fanout.delete(p),this.fanoutLastpub.delete(p))}),this.fanout.forEach((h,p)=>{const w=this.topics.get(p);h.forEach(b=>{(!w.has(b)||c(b)<this.opts.scoreThresholds.publishThreshold)&&h.delete(b)});const y=this.topics.get(p),E=[],m=new Set;if(f.set(p,m),y){const b=ui(Array.from(y));for(const v of b){const S=this.streamsOutbound.get(v);if(S&&this.multicodecs.includes(S.protocol)&&!h.has(v)&&!this.direct.has(v)){const _=c(v);_>=this.opts.scoreThresholds.publishThreshold&&E.push(v),_>=this.opts.scoreThresholds.gossipThreshold&&m.add(v)}}}if(h.size<e){const b=e-h.size;E.slice(0,b).forEach(v=>{h.add(v),m?.delete(v)})}}),this.emitGossip(f),await this.sendGraftPrune(u,l,d),this.flush(),this.mcache.shift(),this.dispatchEvent(new W("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,n=()=>!0){const s=this.topics.get(e);if(!s)return new Set;let i=[];return s.forEach(o=>{const a=this.streamsOutbound.get(o);a&&this.multicodecs.includes(a.protocol)&&n(o)&&i.push(o)}),i=ui(i),t>0&&i.length>t&&(i=i.slice(0,t)),new Set(i)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0;for(const o of this.backoff.values())t+=o.size;e.cacheSize.set({cache:"backoff"},t);for(const[o,a]of this.topics)e.topicPeersCount.set({topicStr:o},a.size);for(const[o,a]of this.mesh)e.meshPeerCounts.set({topicStr:o},a.size);const n=[],s=new Map;e.behaviourPenalty.reset();for(const o of this.peers.keys()){const a=this.score.score(o);n.push(a),s.set(o,a),e.behaviourPenalty.observe(this.score.peerStats.get(o)?.behaviourPenalty??0)}e.registerScores(n,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,s);const i=gbe(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(i)}}fP.multicodec=cP;function kbe(r={}){return e=>new fP(e,r)}const Nbe=()=>({gossipsub:kbe({fallbackToFloodsub:!0,emitSelf:!0,maxInboundStreams:64,maxOutboundStreams:128})});function Lbe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var Mbe=Lbe,Ube=Mbe;const Bbe=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let zbe=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Fbe=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return pP(this,e)}},Vbe=class{constructor(e){this.decoders=e}or(e){return pP(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const pP=(r,e)=>new Vbe({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let jbe=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new zbe(e,t,n),this.decoder=new Fbe(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const gP=({name:r,prefix:e,encode:t,decode:n})=>new jbe(r,e,t,n),yP=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Ube(t,e);return gP({prefix:r,name:e,encode:n,decode:i=>Bbe(s(i))})},qbe=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Kbe=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},vn=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>gP({prefix:e,name:r,encode(s){return Kbe(s,n,t)},decode(s){return qbe(s,n,t,r)}}),Gbe=vn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});vn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});vn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});vn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});vn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});vn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});vn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});vn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});vn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Hbe=yP({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});yP({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Wbe=vn({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});vn({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});vn({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});vn({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});le.formatters.b=r=>r==null?"undefined":Hbe.baseEncode(r);le.formatters.t=r=>r==null?"undefined":Gbe.baseEncode(r);le.formatters.m=r=>r==null?"undefined":Wbe.baseEncode(r);le.formatters.p=r=>r==null?"undefined":r.toString();le.formatters.c=r=>r==null?"undefined":r.toString();le.formatters.k=r=>r==null?"undefined":r.toString();le.formatters.a=r=>r==null?"undefined":r.toString();function Qbe(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Ybe(r){let e=Qbe(`${r}:trace`);return le.enabled(`${r}:trace`)&&le.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=le(`${r}:trace`)),Object.assign(le(r),{error:le(`${r}:error`),trace:e})}const Xbe=Symbol.for("@libp2p/peer-id");function Jbe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var Zbe=Jbe,e3e=Zbe;const t3e=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},G2=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},r3e=r=>new TextEncoder().encode(r),n3e=r=>new TextDecoder().decode(r);let s3e=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},i3e=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return wP(this,e)}},o3e=class{constructor(e){this.decoders=e}or(e){return wP(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const wP=(r,e)=>new o3e({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let a3e=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new s3e(e,t,n),this.decoder=new i3e(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const H2=({name:r,prefix:e,encode:t,decode:n})=>new a3e(r,e,t,n),Vh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=e3e(t,e);return H2({prefix:r,name:e,encode:n,decode:i=>G2(s(i))})},c3e=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},l3e=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},nr=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>H2({prefix:e,name:r,encode(s){return l3e(s,n,t)},decode(s){return c3e(s,n,t,r)}}),ms=Vh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),u3e=Vh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),d3e=Object.freeze(Object.defineProperty({__proto__:null,base58btc:ms,base58flickr:u3e},Symbol.toStringTag,{value:"Module"})),h3e=H2({prefix:"\0",name:"identity",encode:r=>n3e(r),decode:r=>r3e(r)}),f3e=Object.freeze(Object.defineProperty({__proto__:null,identity:h3e},Symbol.toStringTag,{value:"Module"})),p3e=nr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),g3e=Object.freeze(Object.defineProperty({__proto__:null,base2:p3e},Symbol.toStringTag,{value:"Module"})),y3e=nr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),w3e=Object.freeze(Object.defineProperty({__proto__:null,base8:y3e},Symbol.toStringTag,{value:"Module"})),b3e=Vh({prefix:"9",name:"base10",alphabet:"0123456789"}),m3e=Object.freeze(Object.defineProperty({__proto__:null,base10:b3e},Symbol.toStringTag,{value:"Module"})),E3e=nr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),v3e=nr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),_3e=Object.freeze(Object.defineProperty({__proto__:null,base16:E3e,base16upper:v3e},Symbol.toStringTag,{value:"Module"})),Ed=nr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),S3e=nr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),A3e=nr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),$3e=nr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),R3e=nr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),T3e=nr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),I3e=nr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),C3e=nr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),x3e=nr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),D3e=Object.freeze(Object.defineProperty({__proto__:null,base32:Ed,base32hex:R3e,base32hexpad:I3e,base32hexpadupper:C3e,base32hexupper:T3e,base32pad:A3e,base32padupper:$3e,base32upper:S3e,base32z:x3e},Symbol.toStringTag,{value:"Module"})),O3e=Vh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),P3e=Vh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),k3e=Object.freeze(Object.defineProperty({__proto__:null,base36:O3e,base36upper:P3e},Symbol.toStringTag,{value:"Module"})),N3e=nr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),L3e=nr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),M3e=nr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),U3e=nr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),B3e=Object.freeze(Object.defineProperty({__proto__:null,base64:N3e,base64pad:L3e,base64url:M3e,base64urlpad:U3e},Symbol.toStringTag,{value:"Module"})),bP=Array.from(""),z3e=bP.reduce((r,e,t)=>(r[t]=e,r),[]),F3e=bP.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function V3e(r){return r.reduce((e,t)=>(e+=z3e[t],e),"")}function j3e(r){const e=[];for(const t of r){const n=F3e[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const q3e=H2({prefix:"",name:"base256emoji",encode:V3e,decode:j3e}),K3e=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:q3e},Symbol.toStringTag,{value:"Module"}));var G3e=mP,iS=128,H3e=127,W3e=~H3e,Q3e=Math.pow(2,31);function mP(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Q3e;)e[t++]=r&255|iS,r/=128;for(;r&W3e;)e[t++]=r&255|iS,r>>>=7;return e[t]=r|0,mP.bytes=t-n+1,e}var Y3e=S3,X3e=128,oS=127;function S3(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw S3.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&oS)<<s:(o&oS)*Math.pow(2,s),s+=7}while(o>=X3e);return S3.bytes=i-n,t}var J3e=Math.pow(2,7),Z3e=Math.pow(2,14),e6e=Math.pow(2,21),t6e=Math.pow(2,28),r6e=Math.pow(2,35),n6e=Math.pow(2,42),s6e=Math.pow(2,49),i6e=Math.pow(2,56),o6e=Math.pow(2,63),a6e=function(r){return r<J3e?1:r<Z3e?2:r<e6e?3:r<t6e?4:r<r6e?5:r<n6e?6:r<s6e?7:r<i6e?8:r<o6e?9:10},c6e={encode:G3e,decode:Y3e,encodingLength:a6e},H1=c6e;const A3=(r,e=0)=>[H1.decode(r,e),H1.decode.bytes],W1=(r,e,t=0)=>(H1.encode(r,e,t),e),Q1=r=>H1.encodingLength(r),Y1=(r,e)=>{const t=e.byteLength,n=Q1(r),s=n+Q1(t),i=new Uint8Array(s+t);return W1(r,i,0),W1(t,i,n),i.set(e,s),new o5(r,t,e,i)},i5=r=>{const e=G2(r),[t,n]=A3(e),[s,i]=A3(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new o5(t,s,o,e)},l6e=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&t3e(r.bytes,t.bytes)}};let o5=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const u6e=({name:r,code:e,encode:t})=>new d6e(r,e,t);let d6e=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Y1(this.code,t):t.then(n=>Y1(this.code,n))}else throw Error("Unknown type, must be binary type")}};const h6e=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),EP=u6e({name:"sha2-256",code:18,encode:h6e("SHA-256")}),vP=0,f6e="identity",_P=G2,p6e=r=>Y1(vP,_P(r)),SP={code:vP,name:f6e,encode:_P,digest:p6e};new TextEncoder;new TextDecoder;const aS=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return y6e(t,$3(r),e||ms.encoder);default:return w6e(t,$3(r),e||Ed.encoder)}},cS=new WeakMap,$3=r=>{const e=cS.get(r);if(e==null){const t=new Map;return cS.set(r,t),t}return e};let AP=class $r{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==mu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==b6e)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return $r.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Y1(e,t);return $r.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return $r.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&l6e(e.multihash,n.multihash)}toString(e){return aS(this,e)}toJSON(){return{"/":aS(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof $r)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new $r(n,s,i,o||lS(n,s,i.bytes))}else if(t[m6e]===!0){const{version:n,multihash:s,code:i}=t,o=i5(s);return $r.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==mu)throw new Error(`Version 0 CID must use dag-pb (code: ${mu}) block encoding`);return new $r(e,t,n,n.bytes)}case 1:{const s=lS(e,t,n.bytes);return new $r(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return $r.create(0,mu,e)}static createV1(e,t){return $r.create(1,e,t)}static decode(e){const[t,n]=$r.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=$r.inspectBytes(e),n=t.size-t.multihashSize,s=G2(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new o5(t.multihashCode,t.digestSize,i,s);return[t.version===0?$r.createV0(o):$r.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=A3(e.subarray(t));return t+=f,d};let s=n(),i=mu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=g6e(e,t),i=$r.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return $3(i).set(n,e),i}};const g6e=(r,e)=>{switch(r[0]){case"Q":{const t=e||ms;return[ms.prefix,t.decode(`${ms.prefix}${r}`)]}case ms.prefix:{const t=e||ms;return[ms.prefix,t.decode(r)]}case Ed.prefix:{const t=e||Ed;return[Ed.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},y6e=(r,e,t)=>{const{prefix:n}=t;if(n!==ms.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},w6e=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},mu=112,b6e=18,lS=(r,e,t)=>{const n=Q1(r),s=n+Q1(e),i=new Uint8Array(s+t.byteLength);return W1(r,i,0),W1(e,i,n),i.set(t,s),i},m6e=Symbol.for("@ipld/js-cid/CID"),uS={...f3e,...g3e,...w3e,...m3e,..._3e,...D3e,...k3e,...d3e,...B3e,...K3e},E6e=Symbol.for("nodejs.util.inspect.custom"),v6e=Object.values(uS).map(r=>r.decoder).reduce((r,e)=>r.or(e),uS.identity.decoder),$P=114,RP=36,TP=37;var pVe;class a5{constructor(e){k(this,"type");k(this,"multihash");k(this,"privateKey");k(this,"publicKey");k(this,"string");k(this,pVe,!0);this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=ms.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return AP.createV1($P,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(e instanceof Uint8Array)return me(this.multihash.bytes,e);if(typeof e=="string")return _6e(e).equals(this);if(e?.multihash?.bytes!=null)return me(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[(pVe=Xbe,E6e)](){return`PeerId(${this.toString()})`}}class c5 extends a5{constructor(t){super({...t,type:"RSA"});k(this,"type","RSA");k(this,"publicKey");this.publicKey=t.publicKey}}class l5 extends a5{constructor(t){super({...t,type:"Ed25519"});k(this,"type","Ed25519");k(this,"publicKey");this.publicKey=t.multihash.digest}}class u5 extends a5{constructor(t){super({...t,type:"secp256k1"});k(this,"type","secp256k1");k(this,"publicKey");this.publicKey=t.multihash.digest}}function _6e(r,e){if(r.charAt(0)==="1"||r.charAt(0)==="Q"){const t=i5(ms.decode(`z${r}`));return r.startsWith("12D")?new l5({multihash:t}):r.startsWith("16U")?new u5({multihash:t}):new c5({multihash:t})}return IP(v6e.decode(r))}function IP(r){try{const e=i5(r);if(e.code===SP.code){if(e.digest.length===RP)return new l5({multihash:e});if(e.digest.length===TP)return new u5({multihash:e})}if(e.code===EP.code)return new c5({multihash:e})}catch{return S6e(AP.decode(r))}throw new Error("Supplied PeerID CID is invalid")}function S6e(r){if(r==null||r.multihash==null||r.version==null||r.version===1&&r.code!==$P)throw new Error("Supplied PeerID CID is invalid");const e=r.multihash;if(e.code===EP.code)return new c5({multihash:r.multihash});if(e.code===SP.code){if(e.digest.length===RP)return new l5({multihash:r.multihash});if(e.digest.length===TP)return new u5({multihash:r.multihash})}throw new Error("Supplied PeerID CID is invalid")}function dS(r){const e=new globalThis.AbortController;function t(){e.abort();for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(const i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=n,s}var A6e=CP,hS=128,$6e=127,R6e=~$6e,T6e=Math.pow(2,31);function CP(r,e,t){e=e||[],t=t||0;for(var n=t;r>=T6e;)e[t++]=r&255|hS,r/=128;for(;r&R6e;)e[t++]=r&255|hS,r>>>=7;return e[t]=r|0,CP.bytes=t-n+1,e}var I6e=R3,C6e=128,fS=127;function R3(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw R3.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&fS)<<s:(o&fS)*Math.pow(2,s),s+=7}while(o>=C6e);return R3.bytes=i-n,t}var x6e=Math.pow(2,7),D6e=Math.pow(2,14),O6e=Math.pow(2,21),P6e=Math.pow(2,28),k6e=Math.pow(2,35),N6e=Math.pow(2,42),L6e=Math.pow(2,49),M6e=Math.pow(2,56),U6e=Math.pow(2,63),B6e=function(r){return r<x6e?1:r<D6e?2:r<O6e?3:r<P6e?4:r<k6e?5:r<N6e?6:r<L6e?7:r<M6e?8:r<U6e?9:10},z6e={encode:A6e,decode:I6e,encodingLength:B6e},X1=z6e;const T3=(r,e=0)=>[X1.decode(r,e),X1.decode.bytes],J1=(r,e,t=0)=>(X1.encode(r,e,t),e),Z1=r=>X1.encodingLength(r),F6e=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},d5=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},V6e=(r,e)=>{const t=e.byteLength,n=Z1(r),s=n+Z1(t),i=new Uint8Array(s+t);return J1(r,i,0),J1(t,i,n),i.set(e,s),new h5(r,t,e,i)},j6e=r=>{const e=d5(r),[t,n]=T3(e),[s,i]=T3(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new h5(t,s,o,e)},q6e=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&F6e(r.bytes,t.bytes)}};let h5=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function K6e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var G6e=K6e,H6e=G6e;let W6e=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Q6e=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return xP(this,e)}},Y6e=class{constructor(e){this.decoders=e}or(e){return xP(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const xP=(r,e)=>new Y6e({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let X6e=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new W6e(e,t,n),this.decoder=new Q6e(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const DP=({name:r,prefix:e,encode:t,decode:n})=>new X6e(r,e,t,n),OP=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=H6e(t,e);return DP({prefix:r,name:e,encode:n,decode:i=>d5(s(i))})},J6e=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Z6e=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},ji=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>DP({prefix:e,name:r,encode(s){return Z6e(s,n,t)},decode(s){return J6e(s,n,t,r)}}),lo=OP({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});OP({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const pp=ji({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ji({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});ji({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});ji({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});ji({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});ji({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});ji({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});ji({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});ji({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const pS=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return rme(t,I3(r),e||lo.encoder);default:return nme(t,I3(r),e||pp.encoder)}},gS=new WeakMap,I3=r=>{const e=gS.get(r);if(e==null){const t=new Map;return gS.set(r,t),t}return e};let eme=class Rr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Eu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==sme)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Rr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=V6e(e,t);return Rr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Rr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&q6e(e.multihash,n.multihash)}toString(e){return pS(this,e)}toJSON(){return{"/":pS(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Rr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Rr(n,s,i,o||yS(n,s,i.bytes))}else if(t[ime]===!0){const{version:n,multihash:s,code:i}=t,o=j6e(s);return Rr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Eu)throw new Error(`Version 0 CID must use dag-pb (code: ${Eu}) block encoding`);return new Rr(e,t,n,n.bytes)}case 1:{const s=yS(e,t,n.bytes);return new Rr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Rr.create(0,Eu,e)}static createV1(e,t){return Rr.create(1,e,t)}static decode(e){const[t,n]=Rr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Rr.inspectBytes(e),n=t.size-t.multihashSize,s=d5(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new h5(t.multihashCode,t.digestSize,i,s);return[t.version===0?Rr.createV0(o):Rr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=T3(e.subarray(t));return t+=f,d};let s=n(),i=Eu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=tme(e,t),i=Rr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return I3(i).set(n,e),i}};const tme=(r,e)=>{switch(r[0]){case"Q":{const t=e||lo;return[lo.prefix,t.decode(`${lo.prefix}${r}`)]}case lo.prefix:{const t=e||lo;return[lo.prefix,t.decode(r)]}case pp.prefix:{const t=e||pp;return[pp.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},rme=(r,e,t)=>{const{prefix:n}=t;if(n!==lo.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},nme=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Eu=112,sme=18,yS=(r,e,t)=>{const n=Z1(r),s=n+Z1(e),i=new Uint8Array(s+t.byteLength);return J1(r,i,0),J1(e,i,n),i.set(t,s),i},ime=Symbol.for("@ipld/js-cid/CID"),Jo=Ybe("libp2p:delegated-peer-routing"),wS=3e4,ome=4;var bS;(function(r){r[r.SENDING_QUERY=0]="SENDING_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADDING_PEER=6]="ADDING_PEER",r[r.DIALING_PEER=7]="DIALING_PEER"})(bS||(bS={}));var mS;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(mS||(mS={}));class ame{constructor(e){k(this,"client");k(this,"httpQueue");k(this,"started");k(this,"abortController");if(e==null)throw new Error("missing ipfs http client");this.client=e,this.started=!1,this.abortController=new AbortController,this.httpQueue=new zt({concurrency:ome});const{protocol:t,host:n,port:s}=e.getEndpointConfig();Jo(`enabled DelegatedPeerRouting via ${t}://${n}:${s}`)}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.abortController.abort(),this.abortController=new AbortController,this.started=!1}async findPeer(e,t={}){Jo("findPeer starts: %p",e),t.timeout=t.timeout??wS;const n=dS([this.abortController.signal,t.signal]),s=Pe(),i=Pe();this.httpQueue.add(async()=>(s.resolve(),i.promise));try{await s.promise;for await(const o of this.client.dht.findPeer(e,{...t,signal:n}))if(o.name==="FINAL_PEER"&&o.peer.multiaddrs.length>0)return{id:o.peer.id,multiaddrs:o.peer.multiaddrs,protocols:[]};throw new B("Not found","ERR_NOT_FOUND")}catch(o){throw Jo.error("findPeer errored: %o",o),o}finally{n.clear(),i.resolve(),Jo("findPeer finished: %p",e)}}async*getClosestPeers(e,t={}){let n;const s=eme.asCID(e);s!=null?n=s:n=IP(e),Jo("getClosestPeers starts: %s",n),t.timeout=t.timeout??wS;const i=dS([this.abortController.signal,t.signal]),o=Pe(),a=Pe();this.httpQueue.add(async()=>(o.resolve(),a.promise));try{await o.promise;for await(const c of this.client.dht.query(n,{...t,signal:i}))c.name==="PEER_RESPONSE"&&(yield*c.closer.map(u=>({id:u.id,multiaddrs:u.multiaddrs,protocols:[]})))}catch(c){throw Jo.error("getClosestPeers errored:",c),c}finally{i.clear(),a.resolve(),Jo("getClosestPeers finished: %b",e)}}}function cme(r){return()=>new ame(r)}function lme(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var ume=lme,dme=ume;const hme=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};let fme=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},pme=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return PP(this,e)}},gme=class{constructor(e){this.decoders=e}or(e){return PP(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const PP=(r,e)=>new gme({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let yme=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new fme(e,t,n),this.decoder=new pme(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const kP=({name:r,prefix:e,encode:t,decode:n})=>new yme(r,e,t,n),NP=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=dme(t,e);return kP({prefix:r,name:e,encode:n,decode:i=>hme(s(i))})},wme=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},bme=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},_n=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>kP({prefix:e,name:r,encode(s){return bme(s,n,t)},decode(s){return wme(s,n,t,r)}}),mme=_n({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});_n({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});_n({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});_n({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});_n({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});_n({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});_n({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});_n({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});_n({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Eme=NP({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});NP({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const vme=_n({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});_n({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});_n({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});_n({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});le.formatters.b=r=>r==null?"undefined":Eme.baseEncode(r);le.formatters.t=r=>r==null?"undefined":mme.baseEncode(r);le.formatters.m=r=>r==null?"undefined":vme.baseEncode(r);le.formatters.p=r=>r==null?"undefined":r.toString();le.formatters.c=r=>r==null?"undefined":r.toString();le.formatters.k=r=>r==null?"undefined":r.toString();le.formatters.a=r=>r==null?"undefined":r.toString();function _me(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Sme(r){let e=_me(`${r}:trace`);return le.enabled(`${r}:trace`)&&le.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=le(`${r}:trace`)),Object.assign(le(r),{error:le(`${r}:error`),trace:e})}function Lf(r){const e=new globalThis.AbortController;function t(){e.abort();for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(const i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=n,s}function Ame(r){return r[Symbol.asyncIterator]!=null}function ES(r){if(Ame(r))return(async()=>{for await(const e of r);})();for(const e of r);}const en=Sme("libp2p:delegated-content-routing"),Mf=3e4,$me=4,Rme=2;var vS;(function(r){r[r.SENDING_QUERY=0]="SENDING_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADDING_PEER=6]="ADDING_PEER",r[r.DIALING_PEER=7]="DIALING_PEER"})(vS||(vS={}));var _S;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(_S||(_S={}));class Tme{constructor(e){k(this,"client");k(this,"httpQueue");k(this,"httpQueueRefs");k(this,"started");k(this,"abortController");if(e==null)throw new Error("missing ipfs http client");this.client=e,this.started=!1,this.abortController=new AbortController,this.httpQueue=new zt({concurrency:$me}),this.httpQueueRefs=new zt({concurrency:Rme});const{protocol:t,host:n,port:s}=e.getEndpointConfig();en(`enabled DelegatedContentRouting via ${t}://${n}:${s}`)}isStarted(){return this.started}start(){this.started=!0}stop(){this.httpQueue.clear(),this.httpQueueRefs.clear(),this.abortController.abort(),this.abortController=new AbortController,this.started=!1}async*findProviders(e,t={}){en("findProviders starts: %c",e),t.timeout=t.timeout??Mf;const n=Lf([this.abortController.signal,t.signal]),s=Pe(),i=Pe();this.httpQueue.add(async()=>(s.resolve(),i.promise));try{await s.promise;for await(const o of this.client.dht.findProvs(e,{...t,signal:n}))o.name==="PROVIDER"&&(yield*o.providers.map(a=>({id:a.id,protocols:[],multiaddrs:a.multiaddrs})))}catch(o){throw en.error("findProviders errored:",o),o}finally{n.clear(),i.resolve(),en("findProviders finished: %c",e)}}async provide(e,t={}){en("provide starts: %c",e),t.timeout=t.timeout??Mf;const n=Lf([this.abortController.signal,t.signal]),s=Pe(),i=Pe();this.httpQueue.add(async()=>(s.resolve(),i.promise));try{await s.promise,await this.client.block.stat(e,{...t,signal:n}),await ES(this.client.dht.provide(e,{...t,signal:n}))}catch(o){throw en.error("provide errored:",o),o}finally{n.clear(),i.resolve(),en("provide finished: %c",e)}}async put(e,t,n={}){en("put value start: %b",e),n.timeout=n.timeout??Mf;const s=Lf([this.abortController.signal,n.signal]),i=Pe(),o=Pe();this.httpQueue.add(async()=>(i.resolve(),o.promise));try{await i.promise,await ES(this.client.dht.put(e,t,{...n,signal:s}))}catch(a){throw en.error("put errored:",a),a}finally{s.clear(),o.resolve(),en("put finished: %b",e)}}async get(e,t={}){en("get value start: %b",e),t.timeout=t.timeout??Mf;const n=Lf([this.abortController.signal,t.signal]),s=Pe(),i=Pe();this.httpQueue.add(async()=>(s.resolve(),i.promise));try{await s.promise;for await(const o of this.client.dht.get(e,{...t,signal:n}))if(o.name==="VALUE")return en("get value finished: %b",e),o.value;throw $(new Error("Not found"),"ERR_NOT_FOUND")}catch(o){throw en.error("put errored:",o),o}finally{n.clear(),i.resolve(),en("put finished: %b",e)}}}function Ime(r){return()=>new Tme(r)}const Cme=r=>Promise.reject(new Error(`No base found for "${r}"`));class LP{constructor(e){this._basesByName={},this._basesByPrefix={},this._loadBase=e.loadBase||Cme;for(const t of e.bases)this.addBase(t)}addBase(e){if(this._basesByName[e.name]||this._basesByPrefix[e.prefix])throw new Error(`Codec already exists for codec "${e.name}"`);this._basesByName[e.name]=e,this._basesByPrefix[e.prefix]=e}removeBase(e){delete this._basesByName[e.name],delete this._basesByPrefix[e.prefix]}async getBase(e){if(this._basesByName[e])return this._basesByName[e];if(this._basesByPrefix[e])return this._basesByPrefix[e];const t=await this._loadBase(e);return this._basesByName[t.name]==null&&this._basesByPrefix[t.prefix]==null&&this.addBase(t),t}listBases(){return Object.values(this._basesByName)}}const xme=r=>Promise.reject(new Error(`No codec found for "${r}"`));class MP{constructor(e){this._codecsByName={},this._codecsByCode={},this._loadCodec=e.loadCodec||xme;for(const t of e.codecs)this.addCodec(t)}addCodec(e){if(this._codecsByName[e.name]||this._codecsByCode[e.code])throw new Error(`Resolver already exists for codec "${e.name}"`);this._codecsByName[e.name]=e,this._codecsByCode[e.code]=e}removeCodec(e){delete this._codecsByName[e.name],delete this._codecsByCode[e.code]}async getCodec(e){const t=typeof e=="string"?this._codecsByName:this._codecsByCode;if(t[e])return t[e];const n=await this._loadCodec(e);return t[e]==null&&this.addCodec(n),n}listCodecs(){return Object.values(this._codecsByName)}}const Dme=r=>Promise.reject(new Error(`No hasher found for "${r}"`));class UP{constructor(e){this._hashersByName={},this._hashersByCode={},this._loadHasher=e.loadHasher||Dme;for(const t of e.hashers)this.addHasher(t)}addHasher(e){if(this._hashersByName[e.name]||this._hashersByCode[e.code])throw new Error(`Resolver already exists for codec "${e.name}"`);this._hashersByName[e.name]=e,this._hashersByCode[e.code]=e}removeHasher(e){delete this._hashersByName[e.name],delete this._hashersByCode[e.code]}async getHasher(e){const t=typeof e=="string"?this._hashersByName:this._hashersByCode;if(t[e])return t[e];const n=await this._loadHasher(e);return t[e]==null&&this.addHasher(n),n}listHashers(){return Object.values(this._hashersByName)}}const Ome=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},Ll=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Pme=r=>new TextEncoder().encode(r),kme=r=>new TextDecoder().decode(r);var Nme=BP,SS=128,Lme=127,Mme=~Lme,Ume=Math.pow(2,31);function BP(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Ume;)e[t++]=r&255|SS,r/=128;for(;r&Mme;)e[t++]=r&255|SS,r>>>=7;return e[t]=r|0,BP.bytes=t-n+1,e}var Bme=C3,zme=128,AS=127;function C3(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw C3.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&AS)<<s:(o&AS)*Math.pow(2,s),s+=7}while(o>=zme);return C3.bytes=i-n,t}var Fme=Math.pow(2,7),Vme=Math.pow(2,14),jme=Math.pow(2,21),qme=Math.pow(2,28),Kme=Math.pow(2,35),Gme=Math.pow(2,42),Hme=Math.pow(2,49),Wme=Math.pow(2,56),Qme=Math.pow(2,63),Yme=function(r){return r<Fme?1:r<Vme?2:r<jme?3:r<qme?4:r<Kme?5:r<Gme?6:r<Hme?7:r<Wme?8:r<Qme?9:10},Xme={encode:Nme,decode:Bme,encodingLength:Yme},e0=Xme;const x3=(r,e=0)=>[e0.decode(r,e),e0.decode.bytes],t0=(r,e,t=0)=>(e0.encode(r,e,t),e),r0=r=>e0.encodingLength(r),n0=(r,e)=>{const t=e.byteLength,n=r0(r),s=n+r0(t),i=new Uint8Array(s+t);return t0(r,i,0),t0(t,i,n),i.set(e,s),new f5(r,t,e,i)},zP=r=>{const e=Ll(r),[t,n]=x3(e),[s,i]=x3(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new f5(t,s,o,e)},Jme=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Ome(r.bytes,t.bytes)}};let f5=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const FP=0,Zme="identity",VP=Ll,e4e=r=>n0(FP,VP(r)),D3={code:FP,name:Zme,encode:VP,digest:e4e},t4e=Object.freeze(Object.defineProperty({__proto__:null,identity:D3},Symbol.toStringTag,{value:"Module"}));function r4e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var n4e=r4e,s4e=n4e;let i4e=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},o4e=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return jP(this,e)}},a4e=class{constructor(e){this.decoders=e}or(e){return jP(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const jP=(r,e)=>new a4e({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let c4e=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new i4e(e,t,n),this.decoder=new o4e(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const W2=({name:r,prefix:e,encode:t,decode:n})=>new c4e(r,e,t,n),jh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=s4e(t,e);return W2({prefix:r,name:e,encode:n,decode:i=>Ll(s(i))})},l4e=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},u4e=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},sr=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>W2({prefix:e,name:r,encode(s){return u4e(s,n,t)},decode(s){return l4e(s,n,t,r)}}),d4e=W2({prefix:"\0",name:"identity",encode:r=>kme(r),decode:r=>Pme(r)}),h4e=Object.freeze(Object.defineProperty({__proto__:null,identity:d4e},Symbol.toStringTag,{value:"Module"})),f4e=sr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),p4e=Object.freeze(Object.defineProperty({__proto__:null,base2:f4e},Symbol.toStringTag,{value:"Module"})),g4e=sr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),y4e=Object.freeze(Object.defineProperty({__proto__:null,base8:g4e},Symbol.toStringTag,{value:"Module"})),w4e=jh({prefix:"9",name:"base10",alphabet:"0123456789"}),b4e=Object.freeze(Object.defineProperty({__proto__:null,base10:w4e},Symbol.toStringTag,{value:"Module"})),m4e=sr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),E4e=sr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),v4e=Object.freeze(Object.defineProperty({__proto__:null,base16:m4e,base16upper:E4e},Symbol.toStringTag,{value:"Module"})),$a=sr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),_4e=sr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),S4e=sr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),A4e=sr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),$4e=sr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),R4e=sr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),T4e=sr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),I4e=sr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),C4e=sr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),x4e=Object.freeze(Object.defineProperty({__proto__:null,base32:$a,base32hex:$4e,base32hexpad:T4e,base32hexpadupper:I4e,base32hexupper:R4e,base32pad:S4e,base32padupper:A4e,base32upper:_4e,base32z:C4e},Symbol.toStringTag,{value:"Module"})),D4e=jh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),O4e=jh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),P4e=Object.freeze(Object.defineProperty({__proto__:null,base36:D4e,base36upper:O4e},Symbol.toStringTag,{value:"Module"})),Es=jh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),k4e=jh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),N4e=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Es,base58flickr:k4e},Symbol.toStringTag,{value:"Module"})),L4e=sr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),M4e=sr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Q2=sr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),U4e=sr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),B4e=Object.freeze(Object.defineProperty({__proto__:null,base64:L4e,base64pad:M4e,base64url:Q2,base64urlpad:U4e},Symbol.toStringTag,{value:"Module"})),qP=Array.from(""),z4e=qP.reduce((r,e,t)=>(r[t]=e,r),[]),F4e=qP.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function V4e(r){return r.reduce((e,t)=>(e+=z4e[t],e),"")}function j4e(r){const e=[];for(const t of r){const n=F4e[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const q4e=W2({prefix:"",name:"base256emoji",encode:V4e,decode:j4e}),K4e=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:q4e},Symbol.toStringTag,{value:"Module"})),KP=({name:r,code:e,encode:t})=>new G4e(r,e,t);let G4e=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?n0(this.code,t):t.then(n=>n0(this.code,n))}else throw Error("Unknown type, must be binary type")}};const GP=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),H4e=KP({name:"sha2-256",code:18,encode:GP("SHA-256")}),W4e=KP({name:"sha2-512",code:19,encode:GP("SHA-512")}),Q4e=Object.freeze(Object.defineProperty({__proto__:null,sha256:H4e,sha512:W4e},Symbol.toStringTag,{value:"Module"})),Y4e="raw",X4e=85,J4e=r=>Ll(r),Z4e=r=>Ll(r),e5e=Object.freeze(Object.defineProperty({__proto__:null,code:X4e,decode:Z4e,encode:J4e,name:Y4e},Symbol.toStringTag,{value:"Module"})),t5e=new TextEncoder,r5e=new TextDecoder,n5e="json",s5e=512,i5e=r=>t5e.encode(JSON.stringify(r)),o5e=r=>JSON.parse(r5e.decode(r)),a5e=Object.freeze(Object.defineProperty({__proto__:null,code:s5e,decode:o5e,encode:i5e,name:n5e},Symbol.toStringTag,{value:"Module"})),$S=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return l5e(t,O3(r),e||Es.encoder);default:return u5e(t,O3(r),e||$a.encoder)}},RS=new WeakMap,O3=r=>{const e=RS.get(r);if(e==null){const t=new Map;return RS.set(r,t),t}return e};let pe=class Tr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==vu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==d5e)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Tr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=n0(e,t);return Tr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Tr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Jme(e.multihash,n.multihash)}toString(e){return $S(this,e)}toJSON(){return{"/":$S(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Tr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Tr(n,s,i,o||TS(n,s,i.bytes))}else if(t[h5e]===!0){const{version:n,multihash:s,code:i}=t,o=zP(s);return Tr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==vu)throw new Error(`Version 0 CID must use dag-pb (code: ${vu}) block encoding`);return new Tr(e,t,n,n.bytes)}case 1:{const s=TS(e,t,n.bytes);return new Tr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Tr.create(0,vu,e)}static createV1(e,t){return Tr.create(1,e,t)}static decode(e){const[t,n]=Tr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Tr.inspectBytes(e),n=t.size-t.multihashSize,s=Ll(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new f5(t.multihashCode,t.digestSize,i,s);return[t.version===0?Tr.createV0(o):Tr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=x3(e.subarray(t));return t+=f,d};let s=n(),i=vu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=c5e(e,t),i=Tr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return O3(i).set(n,e),i}};const c5e=(r,e)=>{switch(r[0]){case"Q":{const t=e||Es;return[Es.prefix,t.decode(`${Es.prefix}${r}`)]}case Es.prefix:{const t=e||Es;return[Es.prefix,t.decode(r)]}case $a.prefix:{const t=e||$a;return[$a.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},l5e=(r,e,t)=>{const{prefix:n}=t;if(n!==Es.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},u5e=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},vu=112,d5e=18,TS=(r,e,t)=>{const n=r0(r),s=n+r0(e),i=new Uint8Array(s+t.byteLength);return t0(r,i,0),t0(e,i,n),i.set(t,s),i},h5e=Symbol.for("@ipld/js-cid/CID"),HP={...h4e,...p4e,...y4e,...b4e,...v4e,...x4e,...P4e,...N4e,...B4e,...K4e},f5e={...Q4e,...t4e},p5e={raw:e5e,json:a5e},IS=es,g5e=ts,WP=function(r){let e=0;if(r=r.toString().trim(),IS(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(g5e(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=IS(t[n]);let o;i&&(o=WP(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},y5e=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},xn=-1,s0={},P3={},w5e=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,xn,"ip6zone"],[43,8,"ipcidr"],[53,xn,"dns",!0],[54,xn,"dns4",!0],[55,xn,"dns6",!0],[56,xn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc"],[281,0,"webrtc-w3c"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,xn,"unix",!1,!0],[421,xn,"ipfs"],[421,xn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,xn,"garlic64"],[448,0,"tls"],[449,xn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,xn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,xn,"memory"]];w5e.forEach(r=>{const e=b5e(...r);P3[e.code]=e,s0[e.name]=e});function b5e(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function Dt(r){if(typeof r=="number"){if(P3[r]!=null)return P3[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(s0[r]!=null)return s0[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}function m5e(r,e){switch(Dt(r).code){case 4:case 41:return _5e(e);case 42:return DS(e);case 6:case 273:case 33:case 132:return QP(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return DS(e);case 421:return R5e(e);case 444:return OS(e);case 445:return OS(e);case 466:return $5e(e);default:return C(e,"base16")}}function E5e(r,e){switch(Dt(r).code){case 4:return CS(e);case 41:return CS(e);case 42:return xS(e);case 6:case 273:case 33:case 132:return p5(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return xS(e);case 421:return S5e(e);case 444:return T5e(e);case 445:return I5e(e);case 466:return A5e(e);default:return L(e,"base16")}}const By=Object.values(HP).map(r=>r.decoder),v5e=function(){let r=By[0].or(By[1]);return By.slice(2).forEach(e=>r=r.or(e)),r}();function CS(r){if(!tt(r))throw new Error("invalid ip address");return WP(r)}function _5e(r){const e=y5e(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function p5(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function QP(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function xS(r){const e=L(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function DS(r){const e=D.decode(r);if(r=r.slice(D.decode.bytes),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function S5e(r){let e;r[0]==="Q"||r[0]==="1"?e=zP(Es.decode(`z${r}`)).bytes:e=pe.parse(r).multihash.bytes;const t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function A5e(r){const e=v5e.decode(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function $5e(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function R5e(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function T5e(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=$a.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=p5(n);return M([t,s],t.length+s.length)}function I5e(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=$a.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=p5(n);return M([t,s],t.length+s.length)}function OS(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=QP(t);return`${n}:${s}`}function C5e(r){const e=[],t=r.split("/").slice(1);if(t.length===1&&t[0]==="")return[];for(let n=0;n<t.length;n++){const s=t[n],i=Dt(s);if(i.size===0){e.push([s]);continue}if(n++,n>=t.length)throw ZP("invalid address: "+r);if(i.path===!0){e.push([s,y5(t.slice(n).join("/"))]);break}e.push([s,t[n]])}return e}function x5e(r){const e=[];return r.map(t=>{const n=Y2(t);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),y5(e.join("/"))}function D5e(r){return r.map(e=>{Array.isArray(e)||(e=[e]);const t=Y2(e);return e.length>1?[t.code,E5e(t.code,e[1])]:[t.code]})}function YP(r){return r.map(e=>{const t=Y2(e);return e[1]!=null?[t.code,m5e(t.code,e[1])]:[t.code]})}function XP(r){return k3(M(r.map(e=>{const t=Y2(e);let n=Uint8Array.from(D.encode(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n})))}function JP(r,e){return r.size>0?r.size/8:r.size===0?0:D.decode(e)+(D.decode.bytes??0)}function g5(r){const e=[];let t=0;for(;t<r.length;){const n=D.decode(r,t),s=D.decode.bytes??0,i=Dt(n),o=JP(i,r.slice(t+s));if(o===0){e.push([n]),t+=s;continue}const a=r.slice(t+s,t+s+o);if(t+=o+s,t>r.length)throw ZP("Invalid address Uint8Array: "+C(r,"base16"));e.push([n,a])}return e}function PS(r){const e=g5(r),t=YP(e);return x5e(t)}function O5e(r){r=y5(r);const e=C5e(r),t=D5e(e);return XP(t)}function P5e(r){return O5e(r)}function k3(r){const e=k5e(r);if(e!=null)throw e;return Uint8Array.from(r)}function k5e(r){try{g5(r)}catch(e){return e}}function y5(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function ZP(r){return new Error("Error parsing address: "+r)}function Y2(r){return Dt(r[0])}var wc=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},zy=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},_u,Su,Au,kS;const N5e=Symbol.for("nodejs.util.inspect.custom"),L5e=[Dt("dns").code,Dt("dns4").code,Dt("dns6").code,Dt("dnsaddr").code],M5e=new Map,ek=Symbol.for("@multiformats/js-multiaddr/multiaddr");function N3(r){return!!r?.[ek]}let U5e=class Cc{constructor(e){if(_u.set(this,void 0),Su.set(this,void 0),Au.set(this,void 0),this[kS]=!0,e==null&&(e=""),e instanceof Uint8Array)this.bytes=k3(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=P5e(e)}else if(N3(e))this.bytes=k3(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr")}toString(){return wc(this,_u,"f")==null&&zy(this,_u,PS(this.bytes),"f"),wc(this,_u,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=Dt("tcp"),a=Dt("udp"),c=Dt("ip4"),u=Dt("ip6"),l=Dt("dns6"),d=Dt("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),L5e.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=Dt(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=Dt(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map(e=>Object.assign({},Dt(e)))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=D.decode(t,n),i=D.decode.bytes??0,o=Dt(s),a=JP(o,t.slice(n+i));n+=a+i,e.push(s)}return e}protoNames(){return this.protos().map(e=>e.name)}tuples(){return wc(this,Su,"f")==null&&zy(this,Su,g5(this.bytes),"f"),wc(this,Su,"f")}stringTuples(){return wc(this,Au,"f")==null&&zy(this,Au,YP(this.tuples()),"f"),wc(this,Au,"f")}encapsulate(e){return e=new Cc(e),new Cc(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Cc(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new Cc(XP(t.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter(n=>n[0]===s0.ipfs.code).pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C(Es.decode(`z${n}`),"base58btc"):C(pe.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){let e=null;try{e=this.stringTuples().filter(t=>Dt(t[0]).path===!0)[0][1],e==null&&(e=null)}catch{e=null}return e}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=M5e.get(t.name);if(n==null)throw $(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new Cc(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(_u=new WeakMap,Su=new WeakMap,Au=new WeakMap,kS=ek,N5e)](){return`Multiaddr(${PS(this.bytes)})`}};function gn(r){return new U5e(r)}const NS=es,B5e=ts,tk=function(r){let e=0;if(r=r.toString().trim(),NS(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(B5e(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=NS(t[n]);let o;i&&(o=tk(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},z5e=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Dn=-1,i0={},L3={},F5e=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Dn,"ip6zone"],[43,8,"ipcidr"],[53,Dn,"dns",!0],[54,Dn,"dns4",!0],[55,Dn,"dns6",!0],[56,Dn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc"],[281,0,"webrtc-w3c"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Dn,"unix",!1,!0],[421,Dn,"ipfs"],[421,Dn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Dn,"garlic64"],[448,0,"tls"],[449,Dn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Dn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Dn,"memory"]];F5e.forEach(r=>{const e=V5e(...r);L3[e.code]=e,i0[e.name]=e});function V5e(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function Ot(r){if(typeof r=="number"){if(L3[r]!=null)return L3[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(i0[r]!=null)return i0[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}const j5e=d2({prefix:"\0",name:"identity",encode:r=>NW(r),decode:r=>kW(r)}),q5e=Object.freeze(Object.defineProperty({__proto__:null,identity:j5e},Symbol.toStringTag,{value:"Module"})),K5e=Jt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),G5e=Object.freeze(Object.defineProperty({__proto__:null,base2:K5e},Symbol.toStringTag,{value:"Module"})),H5e=Jt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),W5e=Object.freeze(Object.defineProperty({__proto__:null,base8:H5e},Symbol.toStringTag,{value:"Module"})),Q5e=wh({prefix:"9",name:"base10",alphabet:"0123456789"}),Y5e=Object.freeze(Object.defineProperty({__proto__:null,base10:Q5e},Symbol.toStringTag,{value:"Module"})),X5e=Jt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),J5e=Jt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Z5e=Object.freeze(Object.defineProperty({__proto__:null,base16:X5e,base16upper:J5e},Symbol.toStringTag,{value:"Module"})),e8e=wh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),t8e=wh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),r8e=Object.freeze(Object.defineProperty({__proto__:null,base36:e8e,base36upper:t8e},Symbol.toStringTag,{value:"Module"})),n8e=Jt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),s8e=Jt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),i8e=Jt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),o8e=Jt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),a8e=Object.freeze(Object.defineProperty({__proto__:null,base64:n8e,base64pad:s8e,base64url:i8e,base64urlpad:o8e},Symbol.toStringTag,{value:"Module"})),rk=Array.from(""),c8e=rk.reduce((r,e,t)=>(r[t]=e,r),[]),l8e=rk.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function u8e(r){return r.reduce((e,t)=>(e+=c8e[t],e),"")}function d8e(r){const e=[];for(const t of r){const n=l8e[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const h8e=d2({prefix:"",name:"base256emoji",encode:u8e,decode:d8e}),f8e=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:h8e},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const p8e={...q5e,...G5e,...W5e,...Y5e,...Z5e,...nQ,...r8e,...WW,...a8e,...f8e};function g8e(r,e){switch(Ot(r).code){case 4:case 41:return b8e(e);case 42:return US(e);case 6:case 273:case 33:case 132:return nk(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return US(e);case 421:return _8e(e);case 444:return BS(e);case 445:return BS(e);case 466:return v8e(e);default:return C(e,"base16")}}function y8e(r,e){switch(Ot(r).code){case 4:return LS(e);case 41:return LS(e);case 42:return MS(e);case 6:case 273:case 33:case 132:return w5(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return MS(e);case 421:return m8e(e);case 444:return S8e(e);case 445:return A8e(e);case 466:return E8e(e);default:return L(e,"base16")}}const Fy=Object.values(p8e).map(r=>r.decoder),w8e=function(){let r=Fy[0].or(Fy[1]);return Fy.slice(2).forEach(e=>r=r.or(e)),r}();function LS(r){if(!tt(r))throw new Error("invalid ip address");return tk(r)}function b8e(r){const e=z5e(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function w5(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function nk(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function MS(r){const e=L(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function US(r){const e=D.decode(r);if(r=r.slice(D.decode.bytes),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function m8e(r){let e;r[0]==="Q"||r[0]==="1"?e=tC(fs.decode(`z${r}`)).bytes:e=_a.parse(r).multihash.bytes;const t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function E8e(r){const e=w8e.decode(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function v8e(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function _8e(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function S8e(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=va.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=w5(n);return M([t,s],t.length+s.length)}function A8e(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=va.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=w5(n);return M([t,s],t.length+s.length)}function BS(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=nk(t);return`${n}:${s}`}function $8e(r){const e=[],t=r.split("/").slice(1);if(t.length===1&&t[0]==="")return[];for(let n=0;n<t.length;n++){const s=t[n],i=Ot(s);if(i.size===0){e.push([s]);continue}if(n++,n>=t.length)throw ak("invalid address: "+r);if(i.path===!0){e.push([s,m5(t.slice(n).join("/"))]);break}e.push([s,t[n]])}return e}function R8e(r){const e=[];return r.map(t=>{const n=X2(t);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),m5(e.join("/"))}function T8e(r){return r.map(e=>{Array.isArray(e)||(e=[e]);const t=X2(e);return e.length>1?[t.code,y8e(t.code,e[1])]:[t.code]})}function sk(r){return r.map(e=>{const t=X2(e);return e[1]!=null?[t.code,g8e(t.code,e[1])]:[t.code]})}function ik(r){return M3(M(r.map(e=>{const t=X2(e);let n=Uint8Array.from(D.encode(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n})))}function ok(r,e){return r.size>0?r.size/8:r.size===0?0:D.decode(e)+(D.decode.bytes??0)}function b5(r){const e=[];let t=0;for(;t<r.length;){const n=D.decode(r,t),s=D.decode.bytes??0,i=Ot(n),o=ok(i,r.slice(t+s));if(o===0){e.push([n]),t+=s;continue}const a=r.slice(t+s,t+s+o);if(t+=o+s,t>r.length)throw ak("Invalid address Uint8Array: "+C(r,"base16"));e.push([n,a])}return e}function zS(r){const e=b5(r),t=sk(e);return R8e(t)}function I8e(r){r=m5(r);const e=$8e(r),t=T8e(e);return ik(t)}function C8e(r){return I8e(r)}function M3(r){const e=x8e(r);if(e!=null)throw e;return Uint8Array.from(r)}function x8e(r){try{b5(r)}catch(e){return e}}function m5(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function ak(r){return new Error("Error parsing address: "+r)}function X2(r){return Ot(r[0])}var bc=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Vy=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},$u,Ru,Tu,FS;const D8e=Symbol.for("nodejs.util.inspect.custom"),O8e=[Ot("dns").code,Ot("dns4").code,Ot("dns6").code,Ot("dnsaddr").code],P8e=new Map,ck=Symbol.for("@multiformats/js-multiaddr/multiaddr");function k8e(r){return!!r?.[ck]}let N8e=class xc{constructor(e){if($u.set(this,void 0),Ru.set(this,void 0),Tu.set(this,void 0),this[FS]=!0,e==null&&(e=""),e instanceof Uint8Array)this.bytes=M3(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=C8e(e)}else if(k8e(e))this.bytes=M3(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr")}toString(){return bc(this,$u,"f")==null&&Vy(this,$u,zS(this.bytes),"f"),bc(this,$u,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=Ot("tcp"),a=Ot("udp"),c=Ot("ip4"),u=Ot("ip6"),l=Ot("dns6"),d=Ot("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),O8e.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=Ot(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=Ot(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map(e=>Object.assign({},Ot(e)))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=D.decode(t,n),i=D.decode.bytes??0,o=Ot(s),a=ok(o,t.slice(n+i));n+=a+i,e.push(s)}return e}protoNames(){return this.protos().map(e=>e.name)}tuples(){return bc(this,Ru,"f")==null&&Vy(this,Ru,b5(this.bytes),"f"),bc(this,Ru,"f")}stringTuples(){return bc(this,Tu,"f")==null&&Vy(this,Tu,sk(this.tuples()),"f"),bc(this,Tu,"f")}encapsulate(e){return e=new xc(e),new xc(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new xc(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new xc(ik(t.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter(n=>n[0]===i0.ipfs.code).pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C(fs.decode(`z${n}`),"base58btc"):C(_a.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){let e=null;try{e=this.stringTuples().filter(t=>Ot(t[0]).path===!0)[0][1],e==null&&(e=null)}catch{e=null}return e}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=P8e.get(t.name);if(n==null)throw $(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new xc(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[($u=new WeakMap,Ru=new WeakMap,Tu=new WeakMap,FS=ck,D8e)](){return`Multiaddr(${zS(this.bytes)})`}};function L8e(r){return new N8e(r)}function VS(r){try{r=x4(L8e(r))}catch{}return r=r.toString(),r}const M8e=()=>{},jS=N("ipfs-http-client:lib:error-handler"),U8e=et.bind({ignoreUndefined:!0}),B8e=Pi.isBrowser||Pi.isWebWorker?location.protocol:"http",z8e=Pi.isBrowser||Pi.isWebWorker?location.hostname:"localhost",F8e=Pi.isBrowser||Pi.isWebWorker?location.port:"5001",V8e=(r={})=>{let e,t={},n;if(typeof r=="string"||N3(r))e=new URL(VS(r));else if(r instanceof URL)e=r;else if(typeof r.url=="string"||N3(r.url))e=new URL(VS(r.url)),t=r;else if(r.url instanceof URL)e=r.url,t=r;else{t=r||{};const s=(t.protocol||B8e).replace(":",""),i=(t.host||z8e).split(":")[0],o=t.port||F8e;e=new URL(`${s}://${i}:${o}`)}if(t.apiPath?e.pathname=t.apiPath:(e.pathname==="/"||e.pathname===void 0)&&(e.pathname="api/v0"),Pi.isNode){const s=M8e();n=t.agent||new s({keepAlive:!0,maxSockets:6})}return{...t,host:e.host,protocol:e.protocol.replace(":",""),port:Number(e.port),apiPath:e.pathname,url:e,agent:n}},j8e=async r=>{let e;try{if((r.headers.get("Content-Type")||"").startsWith("application/json")){const n=await r.json();jS(n),e=n.Message||n.message}else e=await r.text()}catch(n){jS("Failed to parse error response",n),e=n.message}let t=new Ii.HTTPError(r);throw e&&(e.includes("deadline has elapsed")&&(t=new Ii.TimeoutError),e&&e.includes("context deadline exceeded")&&(t=new Ii.TimeoutError)),e&&e.includes("request timed out")&&(t=new Ii.TimeoutError),e&&(t.message=e),t},q8e=/[A-Z\u00C0-\u00D6\u00D8-\u00DE]/g,qS=r=>r.replace(q8e,function(e){return"-"+e.toLowerCase()}),K8e=r=>typeof r=="string"?fe(r):r;class E5 extends Ii{constructor(e={}){const t=V8e(e);super({timeout:K8e(t.timeout||0)||void 0,headers:t.headers,base:`${t.url}`,handleError:j8e,transformSearchParams:s=>{const i=new URLSearchParams;for(const[o,a]of s)a!=="undefined"&&a!=="null"&&o!=="signal"&&i.append(qS(o),a),o==="timeout"&&!isNaN(a)&&i.append(qS(o),a);return i},agent:t.agent}),delete this.get,delete this.put,delete this.delete,delete this.options;const n=this.fetch;this.fetch=(s,i={})=>(typeof s=="string"&&!s.startsWith("/")&&(s=`${t.url}/${s}`),n.call(this,s,U8e(i,{method:"POST"})))}}Ii.HTTPError;const U=r=>e=>r(new E5(e),e);function lk(r){if(r!=null)return typeof r=="string"?r:r.toString(8).padStart(4,"0")}function uk(r){if(r==null)return;let e;if(r.secs!=null&&(e={secs:r.secs,nsecs:r.nsecs}),r.Seconds!=null&&(e={secs:r.Seconds,nsecs:r.FractionalNanoseconds}),Array.isArray(r)&&(e={secs:r[0],nsecs:r[1]}),r instanceof Date){const t=r.getTime(),n=Math.floor(t/1e3);e={secs:n,nsecs:(t-n*1e3)*1e3}}if(Object.prototype.hasOwnProperty.call(e,"secs")){if(e!=null&&e.nsecs!=null&&(e.nsecs<0||e.nsecs>999999999))throw $(new Error("mtime-nsecs must be within the range [0,999999999]"),"ERR_INVALID_MTIME_NSECS");return e}}function z({arg:r,searchParams:e,hashAlg:t,mtime:n,mode:s,...i}={}){e&&(i={...i,...e}),t&&(i.hash=t),n!=null&&(n=uk(n),i.mtime=n.secs,i.mtimeNsecs=n.nsecs),s!=null&&(i.mode=lk(s)),i.timeout&&!isNaN(i.timeout)&&(i.timeout=`${i.timeout}ms`),r==null?r=[]:Array.isArray(r)||(r=[r]);const o=new URLSearchParams(i);return r.forEach(a=>o.append("arg",a)),o}const G8e=U(r=>{async function e(t={}){return((await(await r.post("bitswap/wantlist",{signal:t.signal,searchParams:z(t),headers:t.headers})).json()).Keys||[]).map(s=>pe.parse(s["/"]))}return e}),H8e=U(r=>{async function e(t,n={}){return((await(await r.post("bitswap/wantlist",{signal:n.signal,searchParams:z({...n,peer:t.toString()}),headers:n.headers})).json()).Keys||[]).map(i=>pe.parse(i["/"]))}return e}),dk=U(r=>{async function e(t={}){const n=await r.post("bitswap/stat",{searchParams:z(t),signal:t.signal,headers:t.headers});return W8e(await n.json())}return e});function W8e(r){return{provideBufLen:r.ProvideBufLen,wantlist:(r.Wantlist||[]).map(e=>pe.parse(e["/"])),peers:(r.Peers||[]).map(e=>de(e)),blocksReceived:BigInt(r.BlocksReceived),dataReceived:BigInt(r.DataReceived),blocksSent:BigInt(r.BlocksSent),dataSent:BigInt(r.DataSent),dupBlksReceived:BigInt(r.DupBlksReceived),dupDataReceived:BigInt(r.DupDataReceived)}}const Q8e=U(r=>{async function e(t,n={}){return(await r.post("bitswap/unwant",{signal:n.signal,searchParams:z({arg:t.toString(),...n}),headers:n.headers})).json()}return e});function Y8e(r){return{wantlist:G8e(r),wantlistForPeer:H8e(r),unwant:Q8e(r),stat:dk(r)}}const hk=U(r=>{async function e(t,n={}){const s=await r.post("block/get",{signal:n.signal,searchParams:z({arg:t.toString(),...n}),headers:n.headers});return new Uint8Array(await s.arrayBuffer())}return e});async function X8e(r){if(Bo(r))return new Blob([r]);if(typeof r=="string"||r instanceof String)return new Blob([r.toString()]);if(kd(r))return r;if(Nd(r)&&(r=Ua(r)),Symbol.iterator in r||Symbol.asyncIterator in r){const e=Th(r),{value:t,done:n}=await e.peek();if(n)return KS(e);if(e.push(t),Number.isInteger(t))return new Blob([Uint8Array.from(await jo(e))]);if(Bo(t)||typeof t=="string"||t instanceof String)return KS(e)}throw $(new Error(`Unexpected input: ${r}`),"ERR_UNEXPECTED_INPUT")}async function KS(r){const e=[];for await(const t of r)e.push(t);return new Blob(e)}function J8e(r){return Ox(r,X8e)}function Z8e(r){if(r!=null)return typeof r=="string"?r:r.toString(8).padStart(4,"0")}async function si(r,e,t={}){const n=[],s=new FormData;let i=0,o=0;for await(const{content:a,path:c,mode:u,mtime:l}of J8e(r)){let d="";const f=a?"file":"dir";i>0&&(d=`-${i}`);let g=f+d;const h=[];if(u!=null&&h.push(`mode=${Z8e(u)}`),l!=null){const{secs:p,nsecs:w}=l;h.push(`mtime=${p}`),w!=null&&h.push(`mtime-nsecs=${w}`)}if(h.length&&(g=`${g}?${h.join("&")}`),a){s.set(g,a,c!=null?encodeURIComponent(c):void 0);const p=o+a.size;n.push({name:c,start:o,end:p}),o=p}else if(c!=null)s.set(g,new File([""],encodeURIComponent(c),{type:"application/x-directory"}));else throw new Error("path or content or both must be set");i++}return{total:o,parts:n,headers:t,body:s}}function e7e(r){return r.filter(Boolean)}function ii(...r){return Xs(e7e(r))}const t7e=U(r=>{async function e(t,n={}){const s=new AbortController,i=ii(s.signal,n.signal);let o;try{o=await(await r.post("block/put",{signal:i,searchParams:z(n),...await si([t],s,n.headers)})).json()}catch(a){if(n.format==="dag-pb")return e(t,{...n,format:"protobuf"});if(n.format==="dag-cbor")return e(t,{...n,format:"cbor"});throw a}return pe.parse(o.Key)}return e}),r7e=U(r=>{async function*e(t,n={}){Array.isArray(t)||(t=[t]);const s=await r.post("block/rm",{signal:n.signal,searchParams:z({arg:t.map(i=>i.toString()),"stream-channels":!0,...n}),headers:n.headers});for await(const i of s.ndjson())yield n7e(i)}return e});function n7e(r){const e={cid:pe.parse(r.Hash)};return r.Error&&(e.error=new Error(r.Error)),e}const s7e=U(r=>{async function e(t,n={}){const i=await(await r.post("block/stat",{signal:n.signal,searchParams:z({arg:t.toString(),...n}),headers:n.headers})).json();return{cid:pe.parse(i.Key),size:i.Size}}return e});function i7e(r){return{get:hk(r),put:t7e(r),rm:r7e(r),stat:s7e(r)}}const o7e=U(r=>{async function e(t,n={}){const s=await r.post("bootstrap/add",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers}),{Peers:i}=await s.json();return{Peers:i.map(o=>gn(o))}}return e}),a7e=U(r=>{async function e(t={}){const n=await r.post("bootstrap/rm",{signal:t.signal,searchParams:z({...t,all:!0}),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map(i=>gn(i))}}return e}),c7e=U(r=>{async function e(t={}){const n=await r.post("bootstrap/list",{signal:t.signal,searchParams:z(t),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map(i=>gn(i))}}return e}),l7e=U(r=>{async function e(t={}){const n=await r.post("bootstrap/add",{signal:t.signal,searchParams:z({...t,default:!0}),headers:t.headers}),{Peers:s}=await n.json();return{Peers:s.map(i=>gn(i))}}return e}),u7e=U(r=>{async function e(t,n={}){const s=await r.post("bootstrap/rm",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers}),{Peers:i}=await s.json();return{Peers:i.map(o=>gn(o))}}return e});function d7e(r){return{add:o7e(r),clear:a7e(r),list:c7e(r),reset:l7e(r),rm:u7e(r)}}const h7e=U(r=>{async function e(t,n={}){const i=await(await r.post("config/profile/apply",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers})).json();return{original:i.OldCfg,updated:i.NewCfg}}return e});function Ft(r){if(r==null)return r;const e=/^[A-Z]+$/,t={};return Object.keys(r).reduce((n,s)=>(e.test(s)?n[s.toLowerCase()]=r[s]:e.test(s[0])?n[s[0].toLowerCase()+s.slice(1)]=r[s]:n[s]=r[s],n),t)}const f7e=U(r=>{async function e(t={}){return(await(await r.post("config/profile/list",{signal:t.signal,searchParams:z(t),headers:t.headers})).json()).map(i=>Ft(i))}return e});function p7e(r){return{apply:h7e(r),list:f7e(r)}}const g7e=U(r=>async(t,n={})=>{if(!t)throw new Error("key argument is required");return(await(await r.post("config",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers})).json()).Value}),y7e=U(r=>async(t={})=>await(await r.post("config/show",{signal:t.signal,searchParams:z({...t}),headers:t.headers})).json()),w7e=U(r=>async(t,n={})=>{const s=new AbortController,i=ii(s.signal,n.signal);await(await r.post("config/replace",{signal:i,searchParams:z(n),...await si([L(JSON.stringify(t))],s,n.headers)})).text()}),b7e=U(r=>async(t,n,s={})=>{if(typeof t!="string")throw new Error("Invalid key type");const i={...s,...m7e(t,n)};await(await r.post("config",{signal:s.signal,searchParams:z(i),headers:s.headers})).text()}),m7e=(r,e)=>{switch(typeof e){case"boolean":return{arg:[r,e.toString()],bool:!0};case"string":return{arg:[r,e]};default:return{arg:[r,JSON.stringify(e)],json:!0}}};function E7e(r){return{getAll:y7e(r),get:g7e(r),set:b7e(r),replace:w7e(r),profiles:p7e(r)}}const v7e=U(r=>{async function*e(t,n={}){yield*(await r.post("dag/export",{signal:n.signal,searchParams:z({arg:t.toString()}),headers:n.headers})).iterator()}return e});async function*GS(r,e,t,n,s){const i=async u=>{const l=await t.getCodec(u.code),d=await n(u,s);return l.decode(d)},o=e.split("/").filter(Boolean);let a=await i(r),c=r;for(;o.length;){const u=o.shift();if(!u)throw $(new Error(`Could not resolve path "${e}"`),"ERR_INVALID_PATH");if(Object.prototype.hasOwnProperty.call(a,u))a=a[u],yield{value:a,remainderPath:o.join("/")};else throw $(new Error(`no link named "${u}" under ${c}`),"ERR_NO_LINK");const l=pe.asCID(a);l&&(c=l,a=await i(a))}yield{value:a,remainderPath:""}}const _7e=(r,e)=>U((n,s)=>{const i=hk(s);return async(a,c={})=>{if(c.path){const g=c.localResolve?await xs(GS(a,c.path,r,i,c)):await En(GS(a,c.path,r,i,c));if(!g)throw $(new Error("Not found"),"ERR_NOT_FOUND");return g}const u=await r.getCodec(a.code),l=await i(a,c);return{value:u.decode(l),remainderPath:""}}})(e),S7e=U(r=>{async function*e(t,n={}){const s=new AbortController,i=ii(s.signal,n.signal),{headers:o,body:a}=await si(t,s,n.headers),c=await r.post("dag/import",{signal:i,headers:o,body:a,searchParams:z({"pin-roots":n.pinRoots})});for await(const{Root:u}of c.ndjson())if(u!==void 0){const{Cid:{"/":l},PinErrorMsg:d}=u;yield{root:{cid:pe.parse(l),pinErrorMsg:d}}}}return e}),fk=(r,e)=>U(n=>async(i,o={})=>{const a={storeCodec:"dag-cbor",hashAlg:"sha2-256",...o};let c;if(a.inputCodec){if(!(i instanceof Uint8Array))throw new Error("Can only inputCodec on raw bytes that can be decoded");c=i}else c=(await r.getCodec(a.storeCodec)).encode(i),a.inputCodec=a.storeCodec;const u=new AbortController,l=ii(u.signal,a.signal),f=await(await n.post("dag/put",{timeout:a.timeout,signal:l,searchParams:z(a),...await si([c],u,a.headers)})).json();return pe.parse(f.Cid["/"])})(e),A7e=U(r=>async(t,n={})=>{const i=await(await r.post("dag/resolve",{signal:n.signal,searchParams:z({arg:`${t}${n.path?`/${n.path}`.replace(/\/[/]+/g,"/"):""}`,...n}),headers:n.headers})).json();return{cid:pe.parse(i.Cid["/"]),remainderPath:i.RemPath}});function $7e(r,e){return{export:v7e(e),get:_7e(r,e),import:S7e(e),put:fk(r,e),resolve:A7e(e)}}const R7e=0,T7e=1,I7e=2,C7e=3,x7e=4,D7e=5,O7e=6,P7e=7,Ml=r=>{if(r.Type===R7e)return{name:"SENDING_QUERY",type:r.Type};if(r.Type===T7e)return{from:de(r.ID),name:"PEER_RESPONSE",type:r.Type,messageType:0,messageName:"PUT_VALUE",closer:(r.Responses||[]).map(({ID:e,Addrs:t})=>({id:de(e),multiaddrs:t.map(n=>gn(n)),protocols:[]})),providers:(r.Responses||[]).map(({ID:e,Addrs:t})=>({id:de(e),multiaddrs:t.map(n=>gn(n)),protocols:[]}))};if(r.Type===I7e){let e={id:r.ID??de(r.ID),multiaddrs:[],protocols:[]};return r.Responses&&r.Responses.length&&(e={id:de(r.Responses[0].ID),multiaddrs:r.Responses[0].Addrs.map(t=>gn(t)),protocols:[]}),{name:"FINAL_PEER",type:r.Type,peer:e}}if(r.Type===C7e)return{name:"QUERY_ERROR",type:r.Type,error:new Error(r.Extra)};if(r.Type===x7e)return{name:"PROVIDER",type:r.Type,providers:r.Responses.map(({ID:e,Addrs:t})=>({id:de(e),multiaddrs:t.map(n=>gn(n)),protocols:[]}))};if(r.Type===D7e)return{name:"VALUE",type:r.Type,value:L(r.Extra,"base64pad")};if(r.Type===O7e){const e=r.Responses.map(({ID:t})=>de(t));if(!e.length)throw new Error("No peer found");return{name:"ADDING_PEER",type:r.Type,peer:e[0]}}if(r.Type===P7e)return{name:"DIALING_PEER",type:r.Type,peer:de(r.ID)};throw new Error("Unknown DHT event type")},k7e=U(r=>{async function*e(t,n={}){const s=await r.post("dht/findpeer",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers});for await(const i of s.ndjson())yield Ml(i)}return e}),N7e=U(r=>{async function*e(t,n={}){const s=await r.post("dht/findprovs",{signal:n.signal,searchParams:z({arg:t.toString(),...n}),headers:n.headers});for await(const i of s.ndjson())yield Ml(i)}return e}),L7e=U(r=>{async function*e(t,n={}){const s=await r.post("dht/get",{signal:n.signal,searchParams:z({arg:t instanceof Uint8Array?C(t):t.toString(),...n}),headers:n.headers});for await(const i of s.ndjson())yield Ml(i)}return e}),M7e=U(r=>{async function*e(t,n={recursive:!1}){const s=Array.isArray(t)?t:[t],i=await r.post("dht/provide",{signal:n.signal,searchParams:z({arg:s.map(o=>o.toString()),...n}),headers:n.headers});for await(const o of i.ndjson())yield Ml(o)}return e}),U7e=U(r=>{async function*e(t,n,s={}){const i=new AbortController,o=ii(i.signal,s.signal),a=await r.post("dht/put",{signal:o,searchParams:z({arg:t instanceof Uint8Array?C(t):t.toString(),...s}),...await si([n],i,s.headers)});for await(const c of a.ndjson())yield Ml(c)}return e}),B7e=U(r=>{async function*e(t,n={}){const s=await r.post("dht/query",{signal:n.signal,searchParams:z({arg:t.toString(),...n}),headers:n.headers});for await(const i of s.ndjson())yield Ml(i)}return e});function z7e(r){return{findPeer:k7e(r),findProvs:N7e(r),get:L7e(r),provide:M7e(r),put:U7e(r),query:B7e(r)}}const F7e=U(r=>{async function e(t={}){return(await r.post("diag/cmds",{signal:t.signal,searchParams:z(t),headers:t.headers})).json()}return e}),V7e=U(r=>{async function e(t={}){return(await r.post("diag/net",{signal:t.signal,searchParams:z(t),headers:t.headers})).json()}return e}),j7e=U(r=>{async function e(t={}){return(await r.post("diag/sys",{signal:t.signal,searchParams:z(t),headers:t.headers})).json()}return e});function q7e(r){return{cmds:F7e(r),net:V7e(r),sys:j7e(r)}}const K7e=U(r=>{async function e(t,n,s={}){await(await r.post("files/chmod",{signal:s.signal,searchParams:z({arg:t,mode:n,...s}),headers:s.headers})).text()}return e}),G7e=U(r=>{async function e(t,n,s={}){const i=Array.isArray(t)?t:[t];await(await r.post("files/cp",{signal:s.signal,searchParams:z({arg:i.concat(n).map(a=>pe.asCID(a)?`/ipfs/${a}`:a),...s}),headers:s.headers})).text()}return e}),H7e=U(r=>{async function e(t,n={}){if(!t||typeof t!="string")throw new Error("ipfs.files.flush requires a path");const i=await(await r.post("files/flush",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers})).json();return pe.parse(i.Cid)}return e});function U3(r){const e=Ft(r);return Object.prototype.hasOwnProperty.call(e,"mode")&&(e.mode=parseInt(e.mode,8)),Object.prototype.hasOwnProperty.call(e,"mtime")&&(e.mtime={secs:e.mtime,nsecs:e.mtimeNsecs||0},delete e.mtimeNsecs),e}const W7e=U(r=>{async function*e(t,n={}){if(!t)throw new Error("ipfs.files.ls requires a path");const s=await r.post("files/ls",{signal:n.signal,searchParams:z({arg:pe.asCID(t)?`/ipfs/${t}`:t,long:!0,...n,stream:!0}),headers:n.headers});for await(const i of s.ndjson())if("Entries"in i)for(const o of i.Entries||[])yield HS(U3(o));else yield HS(U3(i))}return e});function HS(r){return r.hash&&(r.cid=pe.parse(r.hash)),delete r.hash,r.type=r.type===1?"directory":"file",r}const Q7e=U(r=>{async function e(t,n={}){await(await r.post("files/mkdir",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers})).text()}return e}),Y7e=U(r=>{async function e(t,n,s={}){Array.isArray(t)||(t=[t]),await(await r.post("files/mv",{signal:s.signal,searchParams:z({arg:t.concat(n),...s}),headers:s.headers})).text()}return e});var X7e=r=>{if(r[Symbol.asyncIterator])return r;if(r.getReader)return async function*(){const e=r.getReader();try{for(;;){const{done:t,value:n}=await e.read();if(t)return;yield n}}finally{e.releaseLock()}}();throw new Error("unknown stream")};const J7e=Ge(X7e),Z7e=U(r=>{async function*e(t,n={}){const s=await r.post("files/read",{signal:n.signal,searchParams:z({arg:t,count:n.length,...n}),headers:n.headers});yield*J7e(s.body)}return e}),eEe=U(r=>{async function e(t,n={}){const s=await r.post("files/rm",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers}),i=await s.text();if(i!==""){const o=new Ii.HTTPError(s);throw o.message=i,o}}return e}),pk=U(r=>{async function e(t,n={}){const i=await(await r.post("files/stat",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers})).json();return i.WithLocality=i.WithLocality||!1,tEe(U3(i))}return e});function tEe(r){return r.cid=pe.parse(r.hash),delete r.hash,r}const rEe=U(r=>{async function e(t,n={}){await(await r.post("files/touch",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers})).text()}return e}),nEe=U(r=>{async function e(t,n,s={}){const i=new AbortController,o=ii(i.signal,s.signal);await(await r.post("files/write",{signal:o,searchParams:z({arg:t,streamChannels:!0,count:s.length,...s}),...await si([{content:n,path:"arg",mode:lk(s.mode),mtime:uk(s.mtime)}],i,s.headers)})).text()}return e});function sEe(r){return{chmod:K7e(r),cp:G7e(r),flush:H7e(r),ls:W7e(r),mkdir:Q7e(r),mv:Y7e(r),read:Z7e(r),rm:eEe(r),stat:pk(r),touch:rEe(r),write:nEe(r)}}const iEe=U(r=>async(t,n,s={})=>{throw $(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}),oEe=U(r=>{async function e(t,n){const s=n??{type:"Ed25519"},o=await(await r.post("key/gen",{signal:s.signal,searchParams:z({arg:t,...s}),headers:s.headers})).json();return Ft(o)}return e}),aEe=U(r=>{async function e(t,n,s,i={}){const a=await(await r.post("key/import",{signal:i.signal,searchParams:z({arg:t,pem:n,password:s,...i}),headers:i.headers})).json();return Ft(a)}return e}),cEe=U(r=>async(t,n={})=>{throw $(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}),lEe=U(r=>{async function e(t={}){return((await(await r.post("key/list",{signal:t.signal,searchParams:z(t),headers:t.headers})).json()).Keys||[]).map(i=>Ft(i))}return e}),uEe=U(r=>{async function e(t,n,s={}){const i=await r.post("key/rename",{signal:s.signal,searchParams:z({arg:[t,n],...s}),headers:s.headers});return Ft(await i.json())}return e}),dEe=U(r=>{async function e(t,n={}){const i=await(await r.post("key/rm",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers})).json();return Ft(i.Keys[0])}return e});function hEe(r){return{export:iEe(r),gen:oEe(r),import:aEe(r),info:cEe(r),list:lEe(r),rename:uEe(r),rm:dEe(r)}}const fEe=U(r=>{async function e(t,n,s={}){const i=await r.post("log/level",{signal:s.signal,searchParams:z({arg:[t,n],...s}),headers:s.headers});return Ft(await i.json())}return e}),pEe=U(r=>{async function e(t={}){return(await(await r.post("log/ls",{signal:t.signal,searchParams:z(t),headers:t.headers})).json()).Strings}return e}),gEe=U(r=>{async function*e(t={}){yield*(await r.post("log/tail",{signal:t.signal,searchParams:z(t),headers:t.headers})).ndjson()}return e});function yEe(r){return{level:fEe(r),ls:pEe(r),tail:gEe(r)}}const wEe=U(r=>{async function e(t,n={}){const s=await r.post("name/publish",{signal:n.signal,searchParams:z({arg:`${t}`,...n}),headers:n.headers});return Ft(await s.json())}return e}),bEe=U(r=>{async function*e(t,n={}){const s=await r.post("name/resolve",{signal:n.signal,searchParams:z({arg:t,stream:!0,...n}),headers:n.headers});for await(const i of s.ndjson())yield i.Path}return e}),mEe=U(r=>{async function e(t,n={}){const s=await r.post("name/pubsub/cancel",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers});return Ft(await s.json())}return e}),EEe=U(r=>{async function e(t={}){const n=await r.post("name/pubsub/state",{signal:t.signal,searchParams:z(t),headers:t.headers});return Ft(await n.json())}return e}),vEe=U(r=>{async function e(t={}){return(await(await r.post("name/pubsub/subs",{signal:t.signal,searchParams:z(t),headers:t.headers})).json()).Strings||[]}return e});function _Ee(r){return{cancel:mEe(r),state:EEe(r),subs:vEe(r)}}function SEe(r){return{publish:wEe(r),resolve:bEe(r),pubsub:_Ee(r)}}const AEe=U(r=>{async function e(t,n={}){const i=await(await r.post("object/data",{signal:n.signal,searchParams:z({arg:`${t instanceof Uint8Array?pe.decode(t):t}`,...n}),headers:n.headers})).arrayBuffer();return new Uint8Array(i,0,i.byteLength)}return e}),$Ee=U(r=>{async function e(t,n={}){const i=await(await r.post("object/get",{signal:n.signal,searchParams:z({arg:`${t instanceof Uint8Array?pe.decode(t):t}`,dataEncoding:"base64",...n}),headers:n.headers})).json();return{Data:L(i.Data,"base64pad"),Links:(i.Links||[]).map(o=>({Name:o.Name,Hash:pe.parse(o.Hash),Tsize:o.Size}))}}return e}),REe=U(r=>{async function e(t,n={}){return((await(await r.post("object/links",{signal:n.signal,searchParams:z({arg:`${t instanceof Uint8Array?pe.decode(t):t}`,...n}),headers:n.headers})).json()).Links||[]).map(o=>({Name:o.Name,Tsize:o.Size,Hash:pe.parse(o.Hash)}))}return e}),TEe=U(r=>{async function e(t={}){const n=await r.post("object/new",{signal:t.signal,searchParams:z({arg:t.template,...t}),headers:t.headers}),{Hash:s}=await n.json();return pe.parse(s)}return e}),IEe=(r,e)=>U(n=>{const s=fk(r,e);async function i(o,a={}){return s(o,{...a,storeCodec:"dag-pb",hashAlg:"sha2-256",version:1})}return i})(e),CEe=U(r=>{async function e(t,n={}){const i=await(await r.post("object/stat",{signal:n.signal,searchParams:z({arg:`${t}`,...n}),headers:n.headers})).json();return{...i,Hash:pe.parse(i.Hash)}}return e}),xEe=U(r=>{async function e(t,n,s={}){const i=await r.post("object/patch/add-link",{signal:s.signal,searchParams:z({arg:[`${t}`,n.Name||n.name||"",(n.Hash||n.cid||"").toString()||null],...s}),headers:s.headers}),{Hash:o}=await i.json();return pe.parse(o)}return e}),DEe=U(r=>{async function e(t,n,s={}){const i=new AbortController,o=ii(i.signal,s.signal),a=await r.post("object/patch/append-data",{signal:o,searchParams:z({arg:`${t}`,...s}),...await si([n],i,s.headers)}),{Hash:c}=await a.json();return pe.parse(c)}return e}),OEe=U(r=>{async function e(t,n,s={}){const i=await r.post("object/patch/rm-link",{signal:s.signal,searchParams:z({arg:[`${t}`,n.Name||n.name||null],...s}),headers:s.headers}),{Hash:o}=await i.json();return pe.parse(o)}return e}),PEe=U(r=>{async function e(t,n,s={}){const i=new AbortController,o=ii(i.signal,s.signal),a=await r.post("object/patch/set-data",{signal:o,searchParams:z({arg:[`${t}`],...s}),...await si([n],i,s.headers)}),{Hash:c}=await a.json();return pe.parse(c)}return e});function kEe(r){return{addLink:xEe(r),appendData:DEe(r),rmLink:OEe(r),setData:PEe(r)}}function NEe(r,e){return{data:AEe(e),get:$Ee(e),links:REe(e),new:TEe(e),put:IEe(r,e),stat:CEe(e),patch:kEe(e)}}const gk=U(r=>{async function*e(t,n={}){for await(const{path:s,recursive:i,metadata:o}of Ah(t)){const a=await r.post("pin/add",{signal:n.signal,searchParams:z({...n,arg:s,recursive:i,metadata:o?JSON.stringify(o):void 0,stream:!0}),headers:n.headers});for await(const c of a.ndjson()){if(c.Pins){for(const u of c.Pins)yield pe.parse(u);continue}yield pe.parse(c)}}}return e});function LEe(r){const e=gk(r);return U(()=>{async function t(n,s={}){return En(e([{path:n,...s}],s))}return t})(r)}function WS(r,e,t){const n={type:r,cid:pe.parse(e)};return t&&(n.metadata=t),n}const MEe=U(r=>{async function*e(t={}){let n=[];t.paths&&(n=Array.isArray(t.paths)?t.paths:[t.paths]);const s=await r.post("pin/ls",{signal:t.signal,searchParams:z({...t,arg:n.map(i=>`${i}`),stream:!0}),headers:t.headers});for await(const i of s.ndjson()){if(i.Keys){for(const o of Object.keys(i.Keys))yield WS(i.Keys[o].Type,o,i.Keys[o].Metadata);return}yield WS(i.Type,i.Cid,i.Metadata)}}return e}),yk=U(r=>{async function*e(t,n={}){for await(const{path:s,recursive:i}of Ah(t)){const o=new URLSearchParams(n.searchParams);o.append("arg",`${s}`),i!=null&&o.set("recursive",String(i));const a=await r.post("pin/rm",{signal:n.signal,headers:n.headers,searchParams:z({...n,arg:`${s}`,recursive:i})});for await(const c of a.ndjson()){if(c.Pins){yield*c.Pins.map(u=>pe.parse(u));continue}yield pe.parse(c)}}}return e}),UEe=r=>{const e=yk(r);return U(()=>{async function t(n,s={}){return En(e([{path:n,...s}],s))}return t})(r)},wk=({Name:r,Status:e,Cid:t})=>({cid:pe.parse(t),name:r,status:e}),bk=r=>{if(typeof r=="string"&&r!=="")return r;throw new TypeError("service name must be passed")},mk=r=>{if(pe.asCID(r))return r.toString();throw new TypeError(`CID instance expected instead of ${typeof r}`)},v5=({service:r,cid:e,name:t,status:n,all:s})=>{const i=z({service:bk(r),name:t,force:s?!0:void 0});if(e)for(const o of e)i.append("cid",mk(o));if(n)for(const o of n)i.append("status",o);return i},BEe=({cid:r,service:e,background:t,name:n,origins:s})=>{const i=z({arg:mk(r),service:bk(e),name:n,background:t?!0:void 0});if(s)for(const o of s)i.append("origin",o.toString());return i};function zEe(r){async function e(t,{timeout:n,signal:s,headers:i,...o}){const a=await r.post("pin/remote/add",{timeout:n,signal:s,headers:i,searchParams:BEe({cid:t,...o})});return wk(await a.json())}return e}function FEe(r){async function*e({timeout:t,signal:n,headers:s,...i}){const o=await r.post("pin/remote/ls",{timeout:t,signal:n,headers:s,searchParams:v5(i)});for await(const a of o.ndjson())yield wk(a)}return e}function VEe(r){async function e({timeout:t,signal:n,headers:s,...i}){await r.post("pin/remote/rm",{timeout:t,signal:n,headers:s,searchParams:v5({...i,all:!1})})}return e}function jEe(r){async function e({timeout:t,signal:n,headers:s,...i}){await r.post("pin/remote/rm",{timeout:t,signal:n,headers:s,searchParams:v5({...i,all:!0})})}return e}function qEe(r){const e=String(r);if(e==="undefined")throw Error("endpoint is required");return e[e.length-1]==="/"?e.slice(0,-1):e}function KEe(r){return{service:r.Service,endpoint:new URL(r.ApiEndpoint),...r.Stat&&{stat:GEe(r.Stat)}}}function GEe(r){switch(r.Status){case"valid":{const{Pinning:e,Pinned:t,Queued:n,Failed:s}=r.PinCount;return{status:"valid",pinCount:{queued:n,pinning:e,pinned:t,failed:s}}}case"invalid":return{status:"invalid"};default:return{status:r.Status}}}function HEe(r){async function e(t,n){const{endpoint:s,key:i,headers:o,timeout:a,signal:c}=n;await r.post("pin/remote/service/add",{timeout:a,signal:c,searchParams:z({arg:[t,qEe(s),i]}),headers:o})}return e}function WEe(r){async function e(t={}){const{stat:n,headers:s,timeout:i,signal:o}=t,a=await r.post("pin/remote/service/ls",{timeout:i,signal:o,headers:s,searchParams:n===!0?z({stat:n}):void 0}),{RemoteServices:c}=await a.json();return c.map(KEe)}return e}function QEe(r){async function e(t,n={}){await r.post("pin/remote/service/rm",{signal:n.signal,headers:n.headers,searchParams:z({arg:t})})}return e}function YEe(r){const e=new E5(r);return{add:HEe(e),ls:WEe(e),rm:QEe(e)}}function XEe(r){const e=new E5(r);return{add:zEe(e),ls:FEe(e),rm:VEe(e),rmAll:jEe(e),service:YEe(r)}}function JEe(r){return{addAll:gk(r),add:LEe(r),ls:MEe(r),rmAll:yk(r),rm:UEe(r),remote:XEe(r)}}const ZEe=r=>Array.isArray(r)?r.map(B3):r,B3=r=>C(ld(r)),ld=r=>Q2.decode(r),e9e=r=>BigInt(`0x${C(Q2.decode(r),"base16")}`),_5=r=>Q2.encode(L(r)),t9e=U(r=>{async function e(t={}){const{Strings:n}=await(await r.post("pubsub/ls",{signal:t.signal,searchParams:z(t),headers:t.headers})).json();return ZEe(n)||[]}return e}),r9e=U(r=>{async function e(t,n={}){const s=await r.post("pubsub/peers",{signal:n.signal,searchParams:z({arg:_5(t),...n}),headers:n.headers}),{Strings:i}=await s.json();return i||[]}return e}),n9e=U(r=>{async function e(t,n,s={}){const i=z({arg:_5(t),...s}),o=new AbortController,a=ii(o.signal,s.signal);await(await r.post("pubsub/pub",{signal:a,searchParams:i,...await si([n],o,s.headers)})).text()}return e}),s9e=N("ipfs-http-client:pubsub:subscribe"),i9e=(r,e)=>U(t=>{async function n(s,i,o={}){o.signal=e.subscribe(s,i,o.signal);let a,c;const u=new Promise((d,f)=>{a=d,c=f}),l=setTimeout(()=>a(),1e3);return t.post("pubsub/sub",{signal:o.signal,searchParams:z({arg:_5(s),...o}),headers:o.headers}).catch(d=>{e.unsubscribe(s,i),c(d)}).then(d=>{clearTimeout(l),d&&(o9e(d,{onMessage:f=>{if(i){if(typeof i=="function"){i(f);return}typeof i.handleEvent=="function"&&i.handleEvent(f)}},onEnd:()=>e.unsubscribe(s,i),onError:o.onError}),a())}),u}return n})(r);async function o9e(r,{onMessage:e,onEnd:t,onError:n}){n=n||s9e;try{for await(const s of r.ndjson())try{if(!s.from)continue;s.from!=null&&s.seqno!=null?e({type:"signed",from:de(s.from),data:ld(s.data),sequenceNumber:e9e(s.seqno),topic:B3(s.topicIDs[0]),key:ld(s.key??"u"),signature:ld(s.signature??"u")}):e({type:"unsigned",data:ld(s.data),topic:B3(s.topicIDs[0])})}catch(i){i.message=`Failed to parse pubsub message: ${i.message}`,n(i,!1,s)}}catch(s){a9e(s)||n(s,!0)}finally{t()}}const a9e=r=>{switch(r.type){case"aborted":return!0;case"abort":return!0;default:return r.name==="AbortError"}},c9e=(r,e)=>{async function t(n,s){e.unsubscribe(n,s)}return t};class l9e{constructor(){this._subs=new Map}subscribe(e,t,n){const s=this._subs.get(e)||[];if(s.find(o=>o.handler===t))throw new Error(`Already subscribed to ${e} with this handler`);const i=new AbortController;return this._subs.set(e,[{handler:t,controller:i}].concat(s)),n&&n.addEventListener("abort",()=>this.unsubscribe(e,t)),i.signal}unsubscribe(e,t){const n=this._subs.get(e)||[];let s;t?(this._subs.set(e,n.filter(i=>i.handler!==t)),s=n.filter(i=>i.handler===t)):(this._subs.set(e,[]),s=n),(this._subs.get(e)||[]).length||this._subs.delete(e),s.forEach(i=>i.controller.abort())}}function u9e(r){const e=new l9e;return{ls:t9e(r),peers:r9e(r),publish:n9e(r),subscribe:i9e(r,e),unsubscribe:c9e(r,e)}}const d9e=U(r=>{async function*e(t={}){yield*(await r.post("refs/local",{signal:t.signal,transform:Ft,searchParams:z(t),headers:t.headers})).ndjson()}return e}),h9e=U((r,e)=>Object.assign(async function*(n,s={}){const i=Array.isArray(n)?n:[n];yield*(await r.post("refs",{signal:s.signal,searchParams:z({arg:i.map(a=>`${a instanceof Uint8Array?pe.decode(a):a}`),...s}),headers:s.headers,transform:Ft})).ndjson()},{local:d9e(e)})),f9e=U(r=>{async function*e(t={}){yield*(await r.post("repo/gc",{signal:t.signal,searchParams:z(t),headers:t.headers,transform:s=>({err:s.Error?new Error(s.Error):null,cid:(s.Key||{})["/"]?pe.parse(s.Key["/"]):null})})).ndjson()}return e}),Ek=U(r=>{async function e(t={}){const s=await(await r.post("repo/stat",{signal:t.signal,searchParams:z(t),headers:t.headers})).json();return{numObjects:BigInt(s.NumObjects),repoSize:BigInt(s.RepoSize),repoPath:s.RepoPath,version:s.Version,storageMax:BigInt(s.StorageMax)}}return e}),p9e=U(r=>{async function e(t={}){return(await(await r.post("repo/version",{signal:t.signal,searchParams:z(t),headers:t.headers})).json()).Version}return e});function g9e(r){return{gc:f9e(r),stat:Ek(r),version:p9e(r)}}const y9e=U(r=>{async function*e(t={}){yield*(await r.post("stats/bw",{signal:t.signal,searchParams:z(t),headers:t.headers,transform:s=>({totalIn:BigInt(s.TotalIn),totalOut:BigInt(s.TotalOut),rateIn:parseFloat(s.RateIn),rateOut:parseFloat(s.RateOut)})})).ndjson()}return e});function w9e(r){return{bitswap:dk(r),repo:Ek(r),bw:y9e(r)}}const b9e=U(r=>{async function e(t={}){const n=await r.post("swarm/addrs",{signal:t.signal,searchParams:z(t),headers:t.headers}),{Addrs:s}=await n.json();return Object.keys(s).map(i=>({id:de(i),addrs:(s[i]||[]).map(o=>gn(o))}))}return e}),m9e=U(r=>{async function e(t,n={}){const s=await r.post("swarm/connect",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers}),{Strings:i}=await s.json();return i||[]}return e}),E9e=U(r=>{async function e(t,n={}){const s=await r.post("swarm/disconnect",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers}),{Strings:i}=await s.json();return i||[]}return e}),v9e=U(r=>{async function e(t={}){const n=await r.post("swarm/addrs/local",{signal:t.signal,searchParams:z(t),headers:t.headers}),{Strings:s}=await n.json();return(s||[]).map(i=>gn(i))}return e}),_9e=U(r=>{async function e(t={}){const n=await r.post("swarm/peers",{signal:t.signal,searchParams:z(t),headers:t.headers}),{Peers:s}=await n.json();return(s||[]).map(i=>({addr:gn(i.Addr),peer:de(i.Peer),muxer:i.Muxer,latency:i.Latency,streams:i.Streams,direction:i.Direction==null?void 0:i.Direction===0?"inbound":"outbound"}))}return e});function S9e(r){return{addrs:b9e(r),connect:m9e(r),disconnect:E9e(r),localAddrs:v9e(r),peers:_9e(r)}}const vk=U(r=>{async function*e(t,n={}){const s=new AbortController,i=ii(s.signal,n.signal),{headers:o,body:a,total:c,parts:u}=await si(t,s,n.headers),[l,d]=typeof n.progress=="function"?A9e(c,u,n.progress):[void 0,void 0],f=await r.post("add",{searchParams:z({"stream-channels":!0,...n,progress:!!l}),onUploadProgress:d,signal:i,headers:o,body:a});for await(let g of f.ndjson())g=Ft(g),g.hash!==void 0?yield R9e(g):l&&l(g.bytes||0,g.name)}return e}),A9e=(r,e,t)=>e?[void 0,$9e(r,e,t)]:[t,void 0],$9e=(r,e,t)=>{let n=0;const s=e.length;return({loaded:i,total:o})=>{const a=Math.floor(i/o*r);for(;n<s;){const{start:c,end:u,name:l}=e[n];if(a<u){t(a-c,l);break}else t(u-c,l),n+=1}}};function R9e({name:r,hash:e,size:t,mode:n,mtime:s,mtimeNsecs:i}){const o={path:r,cid:pe.parse(e),size:parseInt(t)};return n!=null&&(o.mode=parseInt(n,8)),s!=null&&(o.mtime={secs:s,nsecs:i||0}),o}function T9e(r){const e=vk(r);return U(()=>{async function t(n,s={}){return await En(e(ux(n),s))}return t})(r)}const I9e=U(r=>{async function*e(t,n={}){yield*(await r.post("cat",{signal:n.signal,searchParams:z({arg:t.toString(),...n}),headers:n.headers})).iterator()}return e}),C9e=U(r=>async(t={})=>(await r.post("commands",{signal:t.signal,searchParams:z(t),headers:t.headers})).json()),x9e=U(r=>async(t,n={})=>(await(await r.post("dns",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers})).json()).Path),D9e=U(r=>()=>{const e=new URL(r.opts.base||"");return{host:e.hostname,port:e.port,protocol:e.protocol,pathname:e.pathname,"api-path":e.pathname}}),O9e=U(r=>{async function*e(t,n={}){const s={arg:`${t instanceof Uint8Array?pe.decode(t):t}`,...n};s.compressionLevel&&(s["compression-level"]=s.compressionLevel,delete s.compressionLevel),yield*(await r.post("get",{signal:n.signal,searchParams:z(s),headers:n.headers})).iterator()}return e}),_k=U(r=>{async function e(t={}){const s=await(await r.post("id",{signal:t.signal,searchParams:z({arg:t.peerId?t.peerId.toString():void 0,...t}),headers:t.headers})).json(),i={...Ft(s)};return i.id=de(i.id),i.addresses&&(i.addresses=i.addresses.map(o=>gn(o))),i}return e}),P9e=r=>{const e=_k(r);async function t(n={}){const s=await e(n);return!!(s&&s.addresses&&s.addresses.length)}return t},k9e=U((r,e)=>{async function*t(n,s={}){const i=`${n instanceof Uint8Array?pe.decode(n):n}`;async function o(c){let u=c.Hash;if(u.includes("/")){const d=u.startsWith("/ipfs/")?u:`/ipfs/${u}`;u=(await pk(e)(d)).cid}else u=pe.parse(u);const l={name:c.Name,path:i+(c.Name?`/${c.Name}`:""),size:c.Size,cid:u,type:N9e(c)};return c.Mode&&(l.mode=parseInt(c.Mode,8)),c.Mtime!==void 0&&c.Mtime!==null&&(l.mtime={secs:c.Mtime},c.MtimeNsecs!==void 0&&c.MtimeNsecs!==null&&(l.mtime.nsecs=c.MtimeNsecs)),l}const a=await r.post("ls",{signal:s.signal,searchParams:z({arg:i,...s}),headers:s.headers});for await(let c of a.ndjson()){if(c=c.Objects,!c)throw new Error("expected .Objects in results");if(c=c[0],!c)throw new Error("expected one array in results.Objects");const u=c.Links;if(!Array.isArray(u))throw new Error("expected one array in results.Objects[0].Links");if(!u.length){yield o(c);return}yield*u.map(o)}}return t});function N9e(r){switch(r.Type){case 1:case 5:return"dir";case 2:return"file";default:return"file"}}const L9e=U(r=>{async function e(t={}){const n=await r.post("dns",{signal:t.signal,searchParams:z(t),headers:t.headers});return Ft(await n.json())}return e}),M9e=U(r=>{async function*e(t,n={}){yield*(await r.post("ping",{signal:n.signal,searchParams:z({arg:`${t}`,...n}),headers:n.headers,transform:Ft})).ndjson()}return e}),U9e=U(r=>{async function e(t,n={}){const s=await r.post("resolve",{signal:n.signal,searchParams:z({arg:t,...n}),headers:n.headers}),{Path:i}=await s.json();return i}return e}),B9e=U(r=>async(t={})=>{throw $(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")}),z9e=U(r=>{async function e(t={}){await(await r.post("shutdown",{signal:t.signal,searchParams:z(t),headers:t.headers})).text()}return e}),F9e=U(r=>{async function e(t={}){const n=await r.post("version",{signal:t.signal,searchParams:z(t),headers:t.headers});return{...Ft(await n.json()),"ipfs-http-client":"1.0.0"}}return e});function V9e(r={}){const e={name:D3.name,code:D3.code,encode:u=>u,decode:u=>u},t=Object.values(HP);(r.ipld&&r.ipld.bases?r.ipld.bases:[]).forEach(u=>t.push(u));const n=new LP({bases:t,loadBase:r.ipld&&r.ipld.loadBase}),s=Object.values(p5e);[Lo,AT,fI,_I,e].concat(r.ipld&&r.ipld.codecs||[]).forEach(u=>s.push(u));const i=new MP({codecs:s,loadCodec:r.ipld&&r.ipld.loadCodec}),o=Object.values(f5e);(r.ipld&&r.ipld.hashers?r.ipld.hashers:[]).forEach(u=>o.push(u));const a=new UP({hashers:o,loadHasher:r.ipld&&r.ipld.loadHasher});return{add:T9e(r),addAll:vk(r),bitswap:Y8e(r),block:i7e(r),bootstrap:d7e(r),cat:I9e(r),commands:C9e(r),config:E7e(r),dag:$7e(i,r),dht:z7e(r),diag:q7e(r),dns:x9e(r),files:sEe(r),get:O9e(r),getEndpointConfig:D9e(r),id:_k(r),isOnline:P9e(r),key:hEe(r),log:yEe(r),ls:k9e(r),mount:L9e(r),name:SEe(r),object:NEe(i,r),pin:JEe(r),ping:M9e(r),pubsub:u9e(r),refs:h9e(r),repo:g9e(r),resolve:U9e(r),start:B9e(r),stats:w9e(r),stop:z9e(r),swarm:S9e(r),version:F9e(r),bases:n,codecs:i,hashers:a}}const QS=es,j9e=ts,Sk=function(r){let e=0;if(r=r.toString().trim(),QS(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(j9e(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=QS(t[n]);let o;i&&(o=Sk(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},q9e=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},On=-1,o0={},z3={},K9e=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,On,"ip6zone"],[43,8,"ipcidr"],[53,On,"dns",!0],[54,On,"dns4",!0],[55,On,"dns6",!0],[56,On,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc"],[281,0,"webrtc-w3c"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,On,"unix",!1,!0],[421,On,"ipfs"],[421,On,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,On,"garlic64"],[448,0,"tls"],[449,On,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,On,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,On,"memory"]];K9e.forEach(r=>{const e=G9e(...r);z3[e.code]=e,o0[e.name]=e});function G9e(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function Pt(r){if(typeof r=="number"){if(z3[r]!=null)return z3[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(o0[r]!=null)return o0[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}function H9e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var W9e=H9e,Q9e=W9e;let Y9e=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},X9e=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Ak(this,e)}},J9e=class{constructor(e){this.decoders=e}or(e){return Ak(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Ak=(r,e)=>new J9e({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let Z9e=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new Y9e(e,t,n),this.decoder=new X9e(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const J2=({name:r,prefix:e,encode:t,decode:n})=>new Z9e(r,e,t,n),qh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Q9e(t,e);return J2({prefix:r,name:e,encode:n,decode:i=>r5(s(i))})},eve=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},tve=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},ir=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>J2({prefix:e,name:r,encode(s){return tve(s,n,t)},decode(s){return eve(s,n,t,r)}}),vs=qh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),rve=qh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),nve=Object.freeze(Object.defineProperty({__proto__:null,base58btc:vs,base58flickr:rve},Symbol.toStringTag,{value:"Module"})),Ra=ir({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),sve=ir({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),ive=ir({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),ove=ir({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ave=ir({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),cve=ir({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),lve=ir({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),uve=ir({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),dve=ir({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),hve=Object.freeze(Object.defineProperty({__proto__:null,base32:Ra,base32hex:ave,base32hexpad:lve,base32hexpadupper:uve,base32hexupper:cve,base32pad:ive,base32padupper:ove,base32upper:sve,base32z:dve},Symbol.toStringTag,{value:"Module"})),YS=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return pve(t,F3(r),e||vs.encoder);default:return gve(t,F3(r),e||Ra.encoder)}},XS=new WeakMap,F3=r=>{const e=XS.get(r);if(e==null){const t=new Map;return XS.set(r,t),t}return e};let $k=class Ir{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Iu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==yve)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Ir.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=v3(e,t);return Ir.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Ir.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&obe(e.multihash,n.multihash)}toString(e){return YS(this,e)}toJSON(){return{"/":YS(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Ir)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Ir(n,s,i,o||JS(n,s,i.bytes))}else if(t[wve]===!0){const{version:n,multihash:s,code:i}=t,o=dP(s);return Ir.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Iu)throw new Error(`Version 0 CID must use dag-pb (code: ${Iu}) block encoding`);return new Ir(e,t,n,n.bytes)}case 1:{const s=JS(e,t,n.bytes);return new Ir(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Ir.create(0,Iu,e)}static createV1(e,t){return Ir.create(1,e,t)}static decode(e){const[t,n]=Ir.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Ir.inspectBytes(e),n=t.size-t.multihashSize,s=r5(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new n5(t.multihashCode,t.digestSize,i,s);return[t.version===0?Ir.createV0(o):Ir.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=E3(e.subarray(t));return t+=f,d};let s=n(),i=Iu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=fve(e,t),i=Ir.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return F3(i).set(n,e),i}};const fve=(r,e)=>{switch(r[0]){case"Q":{const t=e||vs;return[vs.prefix,t.decode(`${vs.prefix}${r}`)]}case vs.prefix:{const t=e||vs;return[vs.prefix,t.decode(r)]}case Ra.prefix:{const t=e||Ra;return[Ra.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},pve=(r,e,t)=>{const{prefix:n}=t;if(n!==vs.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},gve=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Iu=112,yve=18,JS=(r,e,t)=>{const n=j1(r),s=n+j1(e),i=new Uint8Array(s+t.byteLength);return V1(r,i,0),V1(e,i,n),i.set(t,s),i},wve=Symbol.for("@ipld/js-cid/CID"),bve=J2({prefix:"\0",name:"identity",encode:r=>Vwe(r),decode:r=>Fwe(r)}),mve=Object.freeze(Object.defineProperty({__proto__:null,identity:bve},Symbol.toStringTag,{value:"Module"})),Eve=ir({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),vve=Object.freeze(Object.defineProperty({__proto__:null,base2:Eve},Symbol.toStringTag,{value:"Module"})),_ve=ir({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Sve=Object.freeze(Object.defineProperty({__proto__:null,base8:_ve},Symbol.toStringTag,{value:"Module"})),Ave=qh({prefix:"9",name:"base10",alphabet:"0123456789"}),$ve=Object.freeze(Object.defineProperty({__proto__:null,base10:Ave},Symbol.toStringTag,{value:"Module"})),Rve=ir({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Tve=ir({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Ive=Object.freeze(Object.defineProperty({__proto__:null,base16:Rve,base16upper:Tve},Symbol.toStringTag,{value:"Module"})),Cve=qh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),xve=qh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Dve=Object.freeze(Object.defineProperty({__proto__:null,base36:Cve,base36upper:xve},Symbol.toStringTag,{value:"Module"})),Ove=ir({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Pve=ir({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),kve=ir({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Nve=ir({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Lve=Object.freeze(Object.defineProperty({__proto__:null,base64:Ove,base64pad:Pve,base64url:kve,base64urlpad:Nve},Symbol.toStringTag,{value:"Module"})),Rk=Array.from(""),Mve=Rk.reduce((r,e,t)=>(r[t]=e,r),[]),Uve=Rk.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function Bve(r){return r.reduce((e,t)=>(e+=Mve[t],e),"")}function zve(r){const e=[];for(const t of r){const n=Uve[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const Fve=J2({prefix:"",name:"base256emoji",encode:Bve,decode:zve}),Vve=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:Fve},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const jve={...mve,...vve,...Sve,...$ve,...Ive,...hve,...Dve,...nve,...Lve,...Vve};function qve(r,e){switch(Pt(r).code){case 4:case 41:return Hve(e);case 42:return tA(e);case 6:case 273:case 33:case 132:return Tk(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return tA(e);case 421:return Xve(e);case 444:return rA(e);case 445:return rA(e);case 466:return Yve(e);default:return C(e,"base16")}}function Kve(r,e){switch(Pt(r).code){case 4:return ZS(e);case 41:return ZS(e);case 42:return eA(e);case 6:case 273:case 33:case 132:return S5(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return eA(e);case 421:return Wve(e);case 444:return Jve(e);case 445:return Zve(e);case 466:return Qve(e);default:return L(e,"base16")}}const jy=Object.values(jve).map(r=>r.decoder),Gve=function(){let r=jy[0].or(jy[1]);return jy.slice(2).forEach(e=>r=r.or(e)),r}();function ZS(r){if(!tt(r))throw new Error("invalid ip address");return Sk(r)}function Hve(r){const e=q9e(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function S5(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function Tk(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function eA(r){const e=L(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function tA(r){const e=D.decode(r);if(r=r.slice(D.decode.bytes),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function Wve(r){let e;r[0]==="Q"||r[0]==="1"?e=dP(vs.decode(`z${r}`)).bytes:e=$k.parse(r).multihash.bytes;const t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function Qve(r){const e=Gve.decode(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function Yve(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function Xve(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function Jve(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=Ra.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=S5(n);return M([t,s],t.length+s.length)}function Zve(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Ra.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=S5(n);return M([t,s],t.length+s.length)}function rA(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=Tk(t);return`${n}:${s}`}function e_e(r){const e=[],t=r.split("/").slice(1);if(t.length===1&&t[0]==="")return[];for(let n=0;n<t.length;n++){const s=t[n],i=Pt(s);if(i.size===0){e.push([s]);continue}if(n++,n>=t.length)throw Dk("invalid address: "+r);if(i.path===!0){e.push([s,$5(t.slice(n).join("/"))]);break}e.push([s,t[n]])}return e}function t_e(r){const e=[];return r.map(t=>{const n=Z2(t);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),$5(e.join("/"))}function r_e(r){return r.map(e=>{Array.isArray(e)||(e=[e]);const t=Z2(e);return e.length>1?[t.code,Kve(t.code,e[1])]:[t.code]})}function Ik(r){return r.map(e=>{const t=Z2(e);return e[1]!=null?[t.code,qve(t.code,e[1])]:[t.code]})}function Ck(r){return V3(M(r.map(e=>{const t=Z2(e);let n=Uint8Array.from(D.encode(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n})))}function xk(r,e){return r.size>0?r.size/8:r.size===0?0:D.decode(e)+(D.decode.bytes??0)}function A5(r){const e=[];let t=0;for(;t<r.length;){const n=D.decode(r,t),s=D.decode.bytes??0,i=Pt(n),o=xk(i,r.slice(t+s));if(o===0){e.push([n]),t+=s;continue}const a=r.slice(t+s,t+s+o);if(t+=o+s,t>r.length)throw Dk("Invalid address Uint8Array: "+C(r,"base16"));e.push([n,a])}return e}function nA(r){const e=A5(r),t=Ik(e);return t_e(t)}function n_e(r){r=$5(r);const e=e_e(r),t=r_e(e);return Ck(t)}function s_e(r){return n_e(r)}function V3(r){const e=i_e(r);if(e!=null)throw e;return Uint8Array.from(r)}function i_e(r){try{A5(r)}catch(e){return e}}function $5(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function Dk(r){return new Error("Error parsing address: "+r)}function Z2(r){return Pt(r[0])}var mc=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},qy=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},Cu,xu,Du,sA;const o_e=Symbol.for("nodejs.util.inspect.custom"),a_e=[Pt("dns").code,Pt("dns4").code,Pt("dns6").code,Pt("dnsaddr").code],c_e=new Map,Ok=Symbol.for("@multiformats/js-multiaddr/multiaddr");function l_e(r){return Pk(r)?r.protos().some(e=>e.resolvable):!1}function Pk(r){return!!r?.[Ok]}let u_e=class Dc{constructor(e){if(Cu.set(this,void 0),xu.set(this,void 0),Du.set(this,void 0),this[sA]=!0,e==null&&(e=""),e instanceof Uint8Array)this.bytes=V3(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=s_e(e)}else if(Pk(e))this.bytes=V3(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr")}toString(){return mc(this,Cu,"f")==null&&qy(this,Cu,nA(this.bytes),"f"),mc(this,Cu,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=Pt("tcp"),a=Pt("udp"),c=Pt("ip4"),u=Pt("ip6"),l=Pt("dns6"),d=Pt("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),a_e.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=Pt(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=Pt(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map(e=>Object.assign({},Pt(e)))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=D.decode(t,n),i=D.decode.bytes??0,o=Pt(s),a=xk(o,t.slice(n+i));n+=a+i,e.push(s)}return e}protoNames(){return this.protos().map(e=>e.name)}tuples(){return mc(this,xu,"f")==null&&qy(this,xu,A5(this.bytes),"f"),mc(this,xu,"f")}stringTuples(){return mc(this,Du,"f")==null&&qy(this,Du,Ik(this.tuples()),"f"),mc(this,Du,"f")}encapsulate(e){return e=new Dc(e),new Dc(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Dc(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new Dc(Ck(t.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter(n=>n[0]===o0.ipfs.code).pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C(vs.decode(`z${n}`),"base58btc"):C($k.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){let e=null;try{e=this.stringTuples().filter(t=>Pt(t[0]).path===!0)[0][1],e==null&&(e=null)}catch{e=null}return e}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=c_e.get(t.name);if(n==null)throw $(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new Dc(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(Cu=new WeakMap,xu=new WeakMap,Du=new WeakMap,sA=Ok,o_e)](){return`Multiaddr(${nA(this.bytes)})`}};function kk(r){return new u_e(r)}function d_e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var h_e=d_e,f_e=h_e;const p_e=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},R5=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},g_e=r=>new TextEncoder().encode(r),y_e=r=>new TextDecoder().decode(r);let w_e=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},b_e=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Nk(this,e)}},m_e=class{constructor(e){this.decoders=e}or(e){return Nk(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const Nk=(r,e)=>new m_e({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let E_e=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new w_e(e,t,n),this.decoder=new b_e(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const eg=({name:r,prefix:e,encode:t,decode:n})=>new E_e(r,e,t,n),Kh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=f_e(t,e);return eg({prefix:r,name:e,encode:n,decode:i=>R5(s(i))})},v_e=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},__e=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},or=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>eg({prefix:e,name:r,encode(s){return __e(s,n,t)},decode(s){return v_e(s,n,t,r)}}),_s=Kh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),S_e=Kh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),A_e=Object.freeze(Object.defineProperty({__proto__:null,base58btc:_s,base58flickr:S_e},Symbol.toStringTag,{value:"Module"}));var $_e=Lk,iA=128,R_e=127,T_e=~R_e,I_e=Math.pow(2,31);function Lk(r,e,t){e=e||[],t=t||0;for(var n=t;r>=I_e;)e[t++]=r&255|iA,r/=128;for(;r&T_e;)e[t++]=r&255|iA,r>>>=7;return e[t]=r|0,Lk.bytes=t-n+1,e}var C_e=j3,x_e=128,oA=127;function j3(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw j3.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&oA)<<s:(o&oA)*Math.pow(2,s),s+=7}while(o>=x_e);return j3.bytes=i-n,t}var D_e=Math.pow(2,7),O_e=Math.pow(2,14),P_e=Math.pow(2,21),k_e=Math.pow(2,28),N_e=Math.pow(2,35),L_e=Math.pow(2,42),M_e=Math.pow(2,49),U_e=Math.pow(2,56),B_e=Math.pow(2,63),z_e=function(r){return r<D_e?1:r<O_e?2:r<P_e?3:r<k_e?4:r<N_e?5:r<L_e?6:r<M_e?7:r<U_e?8:r<B_e?9:10},F_e={encode:$_e,decode:C_e,encodingLength:z_e},a0=F_e;const q3=(r,e=0)=>[a0.decode(r,e),a0.decode.bytes],c0=(r,e,t=0)=>(a0.encode(r,e,t),e),l0=r=>a0.encodingLength(r),V_e=(r,e)=>{const t=e.byteLength,n=l0(r),s=n+l0(t),i=new Uint8Array(s+t);return c0(r,i,0),c0(t,i,n),i.set(e,s),new T5(r,t,e,i)},Mk=r=>{const e=R5(r),[t,n]=q3(e),[s,i]=q3(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new T5(t,s,o,e)},j_e=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&p_e(r.bytes,t.bytes)}};let T5=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const Ta=or({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),q_e=or({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),K_e=or({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),G_e=or({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),H_e=or({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),W_e=or({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Q_e=or({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Y_e=or({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),X_e=or({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),J_e=Object.freeze(Object.defineProperty({__proto__:null,base32:Ta,base32hex:H_e,base32hexpad:Q_e,base32hexpadupper:Y_e,base32hexupper:W_e,base32pad:K_e,base32padupper:G_e,base32upper:q_e,base32z:X_e},Symbol.toStringTag,{value:"Module"})),aA=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return eSe(t,K3(r),e||_s.encoder);default:return tSe(t,K3(r),e||Ta.encoder)}},cA=new WeakMap,K3=r=>{const e=cA.get(r);if(e==null){const t=new Map;return cA.set(r,t),t}return e};let Uk=class Cr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ou)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==rSe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Cr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=V_e(e,t);return Cr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Cr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&j_e(e.multihash,n.multihash)}toString(e){return aA(this,e)}toJSON(){return{"/":aA(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Cr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Cr(n,s,i,o||lA(n,s,i.bytes))}else if(t[nSe]===!0){const{version:n,multihash:s,code:i}=t,o=Mk(s);return Cr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ou)throw new Error(`Version 0 CID must use dag-pb (code: ${Ou}) block encoding`);return new Cr(e,t,n,n.bytes)}case 1:{const s=lA(e,t,n.bytes);return new Cr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Cr.create(0,Ou,e)}static createV1(e,t){return Cr.create(1,e,t)}static decode(e){const[t,n]=Cr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Cr.inspectBytes(e),n=t.size-t.multihashSize,s=R5(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new T5(t.multihashCode,t.digestSize,i,s);return[t.version===0?Cr.createV0(o):Cr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=q3(e.subarray(t));return t+=f,d};let s=n(),i=Ou;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=Z_e(e,t),i=Cr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return K3(i).set(n,e),i}};const Z_e=(r,e)=>{switch(r[0]){case"Q":{const t=e||_s;return[_s.prefix,t.decode(`${_s.prefix}${r}`)]}case _s.prefix:{const t=e||_s;return[_s.prefix,t.decode(r)]}case Ta.prefix:{const t=e||Ta;return[Ta.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},eSe=(r,e,t)=>{const{prefix:n}=t;if(n!==_s.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},tSe=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Ou=112,rSe=18,lA=(r,e,t)=>{const n=l0(r),s=n+l0(e),i=new Uint8Array(s+t.byteLength);return c0(r,i,0),c0(e,i,n),i.set(t,s),i},nSe=Symbol.for("@ipld/js-cid/CID"),sSe=Math.pow(2,7),iSe=Math.pow(2,14),oSe=Math.pow(2,21),I5=Math.pow(2,28),C5=Math.pow(2,35),x5=Math.pow(2,42),D5=Math.pow(2,49),Ue=128,Ur=127;function Go(r){if(r<sSe)return 1;if(r<iSe)return 2;if(r<oSe)return 3;if(r<I5)return 4;if(r<C5)return 5;if(r<x5)return 6;if(r<D5)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function aSe(r,e,t=0){switch(Go(r)){case 8:e[t++]=r&255|Ue,r/=128;case 7:e[t++]=r&255|Ue,r/=128;case 6:e[t++]=r&255|Ue,r/=128;case 5:e[t++]=r&255|Ue,r/=128;case 4:e[t++]=r&255|Ue,r>>>=7;case 3:e[t++]=r&255|Ue,r>>>=7;case 2:e[t++]=r&255|Ue,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function cSe(r,e,t=0){switch(Go(r)){case 8:e.set(t++,r&255|Ue),r/=128;case 7:e.set(t++,r&255|Ue),r/=128;case 6:e.set(t++,r&255|Ue),r/=128;case 5:e.set(t++,r&255|Ue),r/=128;case 4:e.set(t++,r&255|Ue),r>>>=7;case 3:e.set(t++,r&255|Ue),r>>>=7;case 2:e.set(t++,r&255|Ue),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function lSe(r,e){let t=r[e],n=0;if(n+=t&Ur,t<Ue||(t=r[e+1],n+=(t&Ur)<<7,t<Ue)||(t=r[e+2],n+=(t&Ur)<<14,t<Ue)||(t=r[e+3],n+=(t&Ur)<<21,t<Ue)||(t=r[e+4],n+=(t&Ur)*I5,t<Ue)||(t=r[e+5],n+=(t&Ur)*C5,t<Ue)||(t=r[e+6],n+=(t&Ur)*x5,t<Ue)||(t=r[e+7],n+=(t&Ur)*D5,t<Ue))return n;throw new RangeError("Could not decode varint")}function uSe(r,e){let t=r.get(e),n=0;if(n+=t&Ur,t<Ue||(t=r.get(e+1),n+=(t&Ur)<<7,t<Ue)||(t=r.get(e+2),n+=(t&Ur)<<14,t<Ue)||(t=r.get(e+3),n+=(t&Ur)<<21,t<Ue)||(t=r.get(e+4),n+=(t&Ur)*I5,t<Ue)||(t=r.get(e+5),n+=(t&Ur)*C5,t<Ue)||(t=r.get(e+6),n+=(t&Ur)*x5,t<Ue)||(t=r.get(e+7),n+=(t&Ur)*D5,t<Ue))return n;throw new RangeError("Could not decode varint")}function tg(r,e,t=0){return e==null&&(e=Ys(Go(r))),e instanceof Uint8Array?aSe(r,e,t):cSe(r,e,t)}function Gh(r,e=0){return r instanceof Uint8Array?lSe(r,e):uSe(r,e)}const dSe=eg({prefix:"\0",name:"identity",encode:r=>y_e(r),decode:r=>g_e(r)}),hSe=Object.freeze(Object.defineProperty({__proto__:null,identity:dSe},Symbol.toStringTag,{value:"Module"})),fSe=or({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),pSe=Object.freeze(Object.defineProperty({__proto__:null,base2:fSe},Symbol.toStringTag,{value:"Module"})),gSe=or({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),ySe=Object.freeze(Object.defineProperty({__proto__:null,base8:gSe},Symbol.toStringTag,{value:"Module"})),wSe=Kh({prefix:"9",name:"base10",alphabet:"0123456789"}),bSe=Object.freeze(Object.defineProperty({__proto__:null,base10:wSe},Symbol.toStringTag,{value:"Module"})),mSe=or({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),ESe=or({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),vSe=Object.freeze(Object.defineProperty({__proto__:null,base16:mSe,base16upper:ESe},Symbol.toStringTag,{value:"Module"})),_Se=Kh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),SSe=Kh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),ASe=Object.freeze(Object.defineProperty({__proto__:null,base36:_Se,base36upper:SSe},Symbol.toStringTag,{value:"Module"})),$Se=or({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),RSe=or({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),TSe=or({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),ISe=or({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),CSe=Object.freeze(Object.defineProperty({__proto__:null,base64:$Se,base64pad:RSe,base64url:TSe,base64urlpad:ISe},Symbol.toStringTag,{value:"Module"})),Bk=Array.from(""),xSe=Bk.reduce((r,e,t)=>(r[t]=e,r),[]),DSe=Bk.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function OSe(r){return r.reduce((e,t)=>(e+=xSe[t],e),"")}function PSe(r){const e=[];for(const t of r){const n=DSe[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const kSe=eg({prefix:"",name:"base256emoji",encode:OSe,decode:PSe}),NSe=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:kSe},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const LSe={...hSe,...pSe,...ySe,...bSe,...vSe,...J_e,...ASe,...A_e,...CSe,...NSe},uA=es,MSe=ts,zk=function(r){let e=0;if(r=r.toString().trim(),uA(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(MSe(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=uA(t[n]);let o;i&&(o=zk(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},USe=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Pn=-1,Wd={},G3={},BSe=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Pn,"ip6zone"],[43,8,"ipcidr"],[53,Pn,"dns",!0],[54,Pn,"dns4",!0],[55,Pn,"dns6",!0],[56,Pn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Pn,"unix",!1,!0],[421,Pn,"ipfs"],[421,Pn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Pn,"garlic64"],[448,0,"tls"],[449,Pn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Pn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Pn,"memory"]];BSe.forEach(r=>{const e=zSe(...r);G3[e.code]=e,Wd[e.name]=e});function zSe(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function lt(r){if(typeof r=="number"){if(G3[r]!=null)return G3[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(Wd[r]!=null)return Wd[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}lt("ip4");lt("ip6");lt("ipcidr");function Fk(r,e){switch(lt(r).code){case 4:case 41:return VSe(e);case 42:return pA(e);case 6:case 273:case 33:case 132:return Vk(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return pA(e);case 421:return GSe(e);case 444:return gA(e);case 445:return gA(e);case 466:return KSe(e);default:return C(e,"base16")}}function dA(r,e){switch(lt(r).code){case 4:return hA(e);case 41:return hA(e);case 42:return fA(e);case 6:case 273:case 33:case 132:return O5(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return fA(e);case 421:return jSe(e);case 444:return HSe(e);case 445:return WSe(e);case 466:return qSe(e);default:return L(e,"base16")}}const Ky=Object.values(LSe).map(r=>r.decoder),FSe=function(){let r=Ky[0].or(Ky[1]);return Ky.slice(2).forEach(e=>r=r.or(e)),r}();function hA(r){if(!tt(r))throw new Error("invalid ip address");return zk(r)}function VSe(r){const e=USe(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function O5(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function Vk(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function fA(r){const e=L(r),t=Uint8Array.from(tg(e.length));return M([t,e],t.length+e.length)}function pA(r){const e=Gh(r);if(r=r.slice(Go(e)),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function jSe(r){let e;r[0]==="Q"||r[0]==="1"?e=Mk(_s.decode(`z${r}`)).bytes:e=Uk.parse(r).multihash.bytes;const t=Uint8Array.from(tg(e.length));return M([t,e],t.length+e.length)}function qSe(r){const e=FSe.decode(r),t=Uint8Array.from(tg(e.length));return M([t,e],t.length+e.length)}function KSe(r){const e=Gh(r),t=r.slice(Go(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function GSe(r){const e=Gh(r),t=r.slice(Go(e));if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function HSe(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=Ta.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=O5(n);return M([t,s],t.length+s.length)}function WSe(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Ta.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=O5(n);return M([t,s],t.length+s.length)}function gA(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=Vk(t);return`${n}:${s}`}function QSe(r){r=H3(r);const e=[],t=[];let n=null;const s=r.split("/").slice(1);if(s.length===1&&s[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let i=0;i<s.length;i++){const o=s[i],a=lt(o);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(i++,i>=s.length)throw Kk("invalid address: "+r);if(a.path===!0){n=H3(s.slice(i).join("/")),e.push([a.code,dA(a.code,n)]),t.push([a.code,n]);break}const c=dA(a.code,s[i]);e.push([a.code,c]),t.push([a.code,Fk(a.code,c)])}return{string:jk(t),bytes:qk(e),tuples:e,stringTuples:t,path:n}}function yA(r){const e=[],t=[];let n=null,s=0;for(;s<r.length;){const i=Gh(r,s),o=Go(i),a=lt(i),c=YSe(a,r.slice(s+o));if(c===0){e.push([i]),t.push([i]),s+=o;continue}const u=r.slice(s+o,s+o+c);if(s+=c+o,s>r.length)throw Kk("Invalid address Uint8Array: "+C(r,"base16"));e.push([i,u]);const l=Fk(i,u);if(t.push([i,l]),a.path===!0){n=l;break}}return{bytes:Uint8Array.from(r),string:jk(t),tuples:e,stringTuples:t,path:n}}function jk(r){const e=[];return r.map(t=>{const n=lt(t[0]);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),H3(e.join("/"))}function qk(r){return M(r.map(e=>{const t=lt(e[0]);let n=Uint8Array.from(tg(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n}))}function YSe(r,e){if(r.size>0)return r.size/8;if(r.size===0)return 0;{const t=Gh(e instanceof Uint8Array?e:Uint8Array.from(e));return t+Go(t)}}function H3(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function Kk(r){return new Error("Error parsing address: "+r)}const XSe=Symbol.for("nodejs.util.inspect.custom"),JSe=[lt("dns").code,lt("dns4").code,lt("dns6").code,lt("dnsaddr").code],ZSe=new Map,Gk=Symbol.for("@multiformats/js-multiaddr/multiaddr");function eAe(r){return!!r?.[Gk]}var Jc,wo,sh,ih,gVe,Ri;let tAe=(Ri=class{constructor(e){k(this,"bytes");vt(this,Jc,void 0);vt(this,wo,void 0);vt(this,sh,void 0);vt(this,ih,void 0);k(this,gVe,!0);e==null&&(e="");let t;if(e instanceof Uint8Array)t=yA(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=QSe(e)}else if(eAe(e))t=yA(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,Xe(this,Jc,t.string),Xe(this,wo,t.tuples),Xe(this,sh,t.stringTuples),Xe(this,ih,t.path)}toString(){return ce(this,Jc)}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=lt("tcp"),a=lt("udp"),c=lt("ip4"),u=lt("ip6"),l=lt("dns6"),d=lt("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),JSe.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=lt(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=lt(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return ce(this,wo).map(([e])=>Object.assign({},lt(e)))}protoCodes(){return ce(this,wo).map(([e])=>e)}protoNames(){return ce(this,wo).map(([e])=>lt(e).name)}tuples(){return ce(this,wo)}stringTuples(){return ce(this,sh)}encapsulate(e){return e=new Ri(e),new Ri(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Ri(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new Ri(qk(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([n,s])=>{n===Wd.p2p.code&&e.push([n,s]),n===Wd["p2p-circuit"].code&&(e=[])});const t=e.pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C(_s.decode(`z${n}`),"base58btc"):C(Uk.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return ce(this,ih)}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=ZSe.get(t.name);if(n==null)throw new l2(`no available resolver for ${t.name}`,"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new Ri(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(gVe=Gk,XSe)](){return`Multiaddr(${ce(this,Jc)})`}},Jc=new WeakMap,wo=new WeakMap,sh=new WeakMap,ih=new WeakMap,Ri);function Hk(r){return new tAe(r)}const rAe=bt("dns4"),nAe=bt("dns6"),sAe=bt("dnsaddr"),u0=Ul(bt("dns"),sAe,rAe,nAe),iAe=Ul(bt("ip4"),bt("ip6")),W3=Ul(Hn(iAe,bt("tcp")),Hn(u0,bt("tcp"))),wA=Ul(Hn(W3,bt("ws")),Hn(u0,bt("ws"))),bA=Ul(Hn(W3,bt("wss")),Hn(u0,bt("wss")),Hn(W3,bt("tls"),bt("ws")),Hn(u0,bt("tls"),bt("ws"))),oAe=Ul(Hn(wA,bt("p2p-webrtc-star"),bt("p2p")),Hn(bA,bt("p2p-webrtc-star"),bt("p2p")),Hn(wA,bt("p2p-webrtc-star")),Hn(bA,bt("p2p-webrtc-star")));function Wk(r){function e(t){let n;try{n=Hk(t)}catch{return!1}const s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function Hn(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:Wk(e),partialMatch:e}}function Ul(...r){function e(n){let s=null;return r.some(i=>{const o=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:Wk(e),partialMatch:e}}function bt(r){const e=r;function t(s){let i;try{i=Hk(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}const mA=421,aAe=290,cAe=2e3,ti=Object.create(null);ti.open="0";ti.close="1";ti.ping="2";ti.pong="3";ti.message="4";ti.upgrade="5";ti.noop="6";const gp=Object.create(null);Object.keys(ti).forEach(r=>{gp[ti[r]]=r});const Q3={type:"error",data:"parser error"},Qk=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",Yk=typeof ArrayBuffer=="function",Xk=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r&&r.buffer instanceof ArrayBuffer,P5=({type:r,data:e},t,n)=>Qk&&e instanceof Blob?t?n(e):EA(e,n):Yk&&(e instanceof ArrayBuffer||Xk(e))?t?n(e):EA(new Blob([e]),n):n(ti[r]+(e||"")),EA=(r,e)=>{const t=new FileReader;return t.onload=function(){const n=t.result.split(",")[1];e("b"+(n||""))},t.readAsDataURL(r)};function vA(r){return r instanceof Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}let Gy;function lAe(r,e){if(Qk&&r.data instanceof Blob)return r.data.arrayBuffer().then(vA).then(e);if(Yk&&(r.data instanceof ArrayBuffer||Xk(r.data)))return e(vA(r.data));P5(r,!1,t=>{Gy||(Gy=new TextEncoder),e(Gy.encode(t))})}const _A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ud=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let r=0;r<_A.length;r++)ud[_A.charCodeAt(r)]=r;const uAe=r=>{let e=r.length*.75,t=r.length,n,s=0,i,o,a,c;r[r.length-1]==="="&&(e--,r[r.length-2]==="="&&e--);const u=new ArrayBuffer(e),l=new Uint8Array(u);for(n=0;n<t;n+=4)i=ud[r.charCodeAt(n)],o=ud[r.charCodeAt(n+1)],a=ud[r.charCodeAt(n+2)],c=ud[r.charCodeAt(n+3)],l[s++]=i<<2|o>>4,l[s++]=(o&15)<<4|a>>2,l[s++]=(a&3)<<6|c&63;return u},dAe=typeof ArrayBuffer=="function",k5=(r,e)=>{if(typeof r!="string")return{type:"message",data:Jk(r,e)};const t=r.charAt(0);return t==="b"?{type:"message",data:hAe(r.substring(1),e)}:gp[t]?r.length>1?{type:gp[t],data:r.substring(1)}:{type:gp[t]}:Q3},hAe=(r,e)=>{if(dAe){const t=uAe(r);return Jk(t,e)}else return{base64:!0,data:r}},Jk=(r,e)=>{switch(e){case"blob":return r instanceof Blob?r:new Blob([r]);case"arraybuffer":default:return r instanceof ArrayBuffer?r:r.buffer}},Zk=String.fromCharCode(30),fAe=(r,e)=>{const t=r.length,n=new Array(t);let s=0;r.forEach((i,o)=>{P5(i,!1,a=>{n[o]=a,++s===t&&e(n.join(Zk))})})},pAe=(r,e)=>{const t=r.split(Zk),n=[];for(let s=0;s<t.length;s++){const i=k5(t[s],e);if(n.push(i),i.type==="error")break}return n};function gAe(){return new TransformStream({transform(r,e){lAe(r,t=>{const n=t.length;let s;if(n<126)s=new Uint8Array(1),new DataView(s.buffer).setUint8(0,n);else if(n<65536){s=new Uint8Array(3);const i=new DataView(s.buffer);i.setUint8(0,126),i.setUint16(1,n)}else{s=new Uint8Array(9);const i=new DataView(s.buffer);i.setUint8(0,127),i.setBigUint64(1,BigInt(n))}r.data&&typeof r.data!="string"&&(s[0]|=128),e.enqueue(s),e.enqueue(t)})}})}let Hy;function Uf(r){return r.reduce((e,t)=>e+t.length,0)}function Bf(r,e){if(r[0].length===e)return r.shift();const t=new Uint8Array(e);let n=0;for(let s=0;s<e;s++)t[s]=r[0][n++],n===r[0].length&&(r.shift(),n=0);return r.length&&n<r[0].length&&(r[0]=r[0].slice(n)),t}function yAe(r,e){Hy||(Hy=new TextDecoder);const t=[];let n=0,s=-1,i=!1;return new TransformStream({transform(o,a){for(t.push(o);;){if(n===0){if(Uf(t)<1)break;const c=Bf(t,1);i=(c[0]&128)===128,s=c[0]&127,s<126?n=3:s===126?n=1:n=2}else if(n===1){if(Uf(t)<2)break;const c=Bf(t,2);s=new DataView(c.buffer,c.byteOffset,c.length).getUint16(0),n=3}else if(n===2){if(Uf(t)<8)break;const c=Bf(t,8),u=new DataView(c.buffer,c.byteOffset,c.length),l=u.getUint32(0);if(l>Math.pow(2,53-32)-1){a.enqueue(Q3);break}s=l*Math.pow(2,32)+u.getUint32(4),n=3}else{if(Uf(t)<s)break;const c=Bf(t,s);a.enqueue(k5(i?c:Hy.decode(c),e)),n=0}if(s===0||s>r){a.enqueue(Q3);break}}}})}const eN=4;function Nt(r){if(r)return wAe(r)}function wAe(r){for(var e in Nt.prototype)r[e]=Nt.prototype[e];return r}Nt.prototype.on=Nt.prototype.addEventListener=function(r,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+r]=this._callbacks["$"+r]||[]).push(e),this};Nt.prototype.once=function(r,e){function t(){this.off(r,t),e.apply(this,arguments)}return t.fn=e,this.on(r,t),this};Nt.prototype.off=Nt.prototype.removeListener=Nt.prototype.removeAllListeners=Nt.prototype.removeEventListener=function(r,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+r];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+r],this;for(var n,s=0;s<t.length;s++)if(n=t[s],n===e||n.fn===e){t.splice(s,1);break}return t.length===0&&delete this._callbacks["$"+r],this};Nt.prototype.emit=function(r){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+r],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(t){t=t.slice(0);for(var n=0,s=t.length;n<s;++n)t[n].apply(this,e)}return this};Nt.prototype.emitReserved=Nt.prototype.emit;Nt.prototype.listeners=function(r){return this._callbacks=this._callbacks||{},this._callbacks["$"+r]||[]};Nt.prototype.hasListeners=function(r){return!!this.listeners(r).length};const jn=(()=>typeof self<"u"?self:typeof window<"u"?window:Function("return this")())();function tN(r,...e){return e.reduce((t,n)=>(r.hasOwnProperty(n)&&(t[n]=r[n]),t),{})}const bAe=jn.setTimeout,mAe=jn.clearTimeout;function rg(r,e){e.useNativeTimers?(r.setTimeoutFn=bAe.bind(jn),r.clearTimeoutFn=mAe.bind(jn)):(r.setTimeoutFn=jn.setTimeout.bind(jn),r.clearTimeoutFn=jn.clearTimeout.bind(jn))}const EAe=1.33;function vAe(r){return typeof r=="string"?_Ae(r):Math.ceil((r.byteLength||r.size)*EAe)}function _Ae(r){let e=0,t=0;for(let n=0,s=r.length;n<s;n++)e=r.charCodeAt(n),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(n++,t+=4);return t}function SAe(r){let e="";for(let t in r)r.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(r[t]));return e}function AAe(r){let e={},t=r.split("&");for(let n=0,s=t.length;n<s;n++){let i=t[n].split("=");e[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return e}class $Ae extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class N5 extends Nt{constructor(e){super(),this.writable=!1,rg(this,e),this.opts=e,this.query=e.query,this.socket=e.socket}onError(e,t,n){return super.emitReserved("error",new $Ae(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=k5(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=SAe(e);return t.length?"?"+t:""}}const rN="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),Y3=64,RAe={};let SA=0,zf=0,AA;function $A(r){let e="";do e=rN[r%Y3]+e,r=Math.floor(r/Y3);while(r>0);return e}function nN(){const r=$A(+new Date);return r!==AA?(SA=0,AA=r):r+"."+$A(SA++)}for(;zf<Y3;zf++)RAe[rN[zf]]=zf;let sN=!1;try{sN=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const TAe=sN;function iN(r){const e=r.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||TAe))return new XMLHttpRequest}catch{}if(!e)try{return new jn[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}function IAe(){}const CAe=function(){return new iN({xdomain:!1}).responseType!=null}();class xAe extends N5{constructor(e){if(super(e),this.polling=!1,typeof location<"u"){const n=location.protocol==="https:";let s=location.port;s||(s=n?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||s!==e.port}const t=e&&e.forceBase64;this.supportsBinary=CAe&&!t,this.opts.withCredentials&&(this.cookieJar=void 0)}get name(){return"polling"}doOpen(){this.poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this.polling||!this.writable){let n=0;this.polling&&(n++,this.once("pollComplete",function(){--n||t()})),this.writable||(n++,this.once("drain",function(){--n||t()}))}else t()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=n=>{if(this.readyState==="opening"&&n.type==="open"&&this.onOpen(),n.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(n)};pAe(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this.polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this.poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,fAe(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=nN()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}request(e={}){return Object.assign(e,{xd:this.xd,cookieJar:this.cookieJar},this.opts),new Qs(this.uri(),e)}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",(s,i)=>{this.onError("xhr post error",s,i)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,n)=>{this.onError("xhr poll error",t,n)}),this.pollXhr=e}}class Qs extends Nt{constructor(e,t){super(),rg(this,t),this.opts=t,this.method=t.method||"GET",this.uri=e,this.data=t.data!==void 0?t.data:null,this.create()}create(){var e;const t=tN(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this.opts.xd;const n=this.xhr=new iN(t);try{n.open(this.method,this.uri,!0);try{if(this.opts.extraHeaders){n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0);for(let s in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(s)&&n.setRequestHeader(s,this.opts.extraHeaders[s])}}catch{}if(this.method==="POST")try{n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{n.setRequestHeader("Accept","*/*")}catch{}(e=this.opts.cookieJar)===null||e===void 0||e.addCookies(n),"withCredentials"in n&&(n.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(n.timeout=this.opts.requestTimeout),n.onreadystatechange=()=>{var s;n.readyState===3&&((s=this.opts.cookieJar)===null||s===void 0||s.parseCookies(n)),n.readyState===4&&(n.status===200||n.status===1223?this.onLoad():this.setTimeoutFn(()=>{this.onError(typeof n.status=="number"?n.status:0)},0))},n.send(this.data)}catch(s){this.setTimeoutFn(()=>{this.onError(s)},0);return}typeof document<"u"&&(this.index=Qs.requestsCount++,Qs.requests[this.index]=this)}onError(e){this.emitReserved("error",e,this.xhr),this.cleanup(!0)}cleanup(e){if(!(typeof this.xhr>"u"||this.xhr===null)){if(this.xhr.onreadystatechange=IAe,e)try{this.xhr.abort()}catch{}typeof document<"u"&&delete Qs.requests[this.index],this.xhr=null}}onLoad(){const e=this.xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}}Qs.requestsCount=0;Qs.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",RA);else if(typeof addEventListener=="function"){const r="onpagehide"in jn?"pagehide":"unload";addEventListener(r,RA,!1)}}function RA(){for(let r in Qs.requests)Qs.requests.hasOwnProperty(r)&&Qs.requests[r].abort()}const L5=(()=>typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0))(),Ff=jn.WebSocket||jn.MozWebSocket,TA=!0,DAe="arraybuffer",IA=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class OAe extends N5{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const e=this.uri(),t=this.opts.protocols,n=IA?{}:tN(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=TA&&!IA?t?new Ff(e,t):new Ff(e):new Ff(e,t,n)}catch(s){return this.emitReserved("error",s)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],s=t===e.length-1;P5(n,this.supportsBinary,i=>{const o={};try{TA&&this.ws.send(i)}catch{}s&&L5(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=nN()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}check(){return!!Ff}}class PAe extends N5{get name(){return"webtransport"}doOpen(){typeof WebTransport=="function"&&(this.transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name]),this.transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this.transport.ready.then(()=>{this.transport.createBidirectionalStream().then(e=>{const t=yAe(Number.MAX_SAFE_INTEGER,this.socket.binaryType),n=e.readable.pipeThrough(t).getReader(),s=gAe();s.readable.pipeTo(e.writable),this.writer=s.writable.getWriter();const i=()=>{n.read().then(({done:a,value:c})=>{a||(this.onPacket(c),i())}).catch(a=>{})};i();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this.writer.write(o).then(()=>this.onOpen())})}))}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],s=t===e.length-1;this.writer.write(n).then(()=>{s&&L5(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this.transport)===null||e===void 0||e.close()}}const kAe={websocket:OAe,webtransport:PAe,polling:xAe},NAe=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,LAe=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function X3(r){const e=r,t=r.indexOf("["),n=r.indexOf("]");t!=-1&&n!=-1&&(r=r.substring(0,t)+r.substring(t,n).replace(/:/g,";")+r.substring(n,r.length));let s=NAe.exec(r||""),i={},o=14;for(;o--;)i[LAe[o]]=s[o]||"";return t!=-1&&n!=-1&&(i.source=e,i.host=i.host.substring(1,i.host.length-1).replace(/;/g,":"),i.authority=i.authority.replace("[","").replace("]","").replace(/;/g,":"),i.ipv6uri=!0),i.pathNames=MAe(i,i.path),i.queryKey=UAe(i,i.query),i}function MAe(r,e){const t=/\/{2,9}/g,n=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&n.splice(0,1),e.slice(-1)=="/"&&n.splice(n.length-1,1),n}function UAe(r,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(n,s,i){s&&(t[s]=i)}),t}let oN=class Oc extends Nt{constructor(e,t={}){super(),this.binaryType=DAe,this.writeBuffer=[],e&&typeof e=="object"&&(t=e,e=null),e?(e=X3(e),t.hostname=e.host,t.secure=e.protocol==="https"||e.protocol==="wss",t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=X3(t.host).host),rg(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=t.transports||["polling","websocket","webtransport"],this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=AAe(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,typeof addEventListener=="function"&&(this.opts.closeOnBeforeunload&&(this.beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this.beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=eN,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new kAe[e](n)}open(){let e;if(this.opts.rememberUpgrade&&Oc.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1)e="websocket";else if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}else e=this.transports[0];this.readyState="opening";try{e=this.createTransport(e)}catch{this.transports.shift(),this.open();return}e.open(),this.setTransport(e)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",t=>this.onClose("transport close",t))}probe(e){let t=this.createTransport(e),n=!1;Oc.priorWebsocketSuccess=!1;const s=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",d=>{if(!n)if(d.type==="pong"&&d.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;Oc.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{n||this.readyState!=="closed"&&(l(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const f=new Error("probe error");f.transport=t.name,this.emitReserved("upgradeError",f)}}))};function i(){n||(n=!0,l(),t.close(),t=null)}const o=d=>{const f=new Error("probe error: "+d);f.transport=t.name,i(),this.emitReserved("upgradeError",f)};function a(){o("transport closed")}function c(){o("socket closed")}function u(d){t&&d.name!==t.name&&i()}const l=()=>{t.removeListener("open",s),t.removeListener("error",o),t.removeListener("close",a),this.off("close",c),this.off("upgrading",u)};t.once("open",s),t.once("error",o),t.once("close",a),this.once("close",c),this.once("upgrading",u),this.upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{n||t.open()},200):t.open()}onOpen(){if(this.readyState="open",Oc.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush(),this.readyState==="open"&&this.opts.upgrade){let e=0;const t=this.upgrades.length;for(;e<t;e++)this.probe(this.upgrades[e])}}onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),this.resetPingTimeout(),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this.getWritablePackets();this.transport.send(e),this.prevBufferLen=e.length,this.emitReserved("flush")}}getWritablePackets(){if(!(this.maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let n=0;n<this.writeBuffer.length;n++){const s=this.writeBuffer[n].data;if(s&&(t+=vAe(s)),n>0&&t>this.maxPayload)return this.writeBuffer.slice(0,n);t+=2}return this.writeBuffer}write(e,t,n){return this.sendPacket("message",e,t,n),this}send(e,t,n){return this.sendPacket("message",e,t,n),this}sendPacket(e,t,n,s){if(typeof t=="function"&&(s=t,t=void 0),typeof n=="function"&&(s=n,n=null),this.readyState==="closing"||this.readyState==="closed")return;n=n||{},n.compress=n.compress!==!1;const i={type:e,data:t,options:n};this.emitReserved("packetCreate",i),this.writeBuffer.push(i),s&&this.once("flush",s),this.flush()}close(){const e=()=>{this.onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?n():e()}):this.upgrading?n():e()),this}onError(e){Oc.priorWebsocketSuccess=!1,this.emitReserved("error",e),this.onClose("transport error",e)}onClose(e,t){(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")&&(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),typeof removeEventListener=="function"&&(removeEventListener("beforeunload",this.beforeunloadEventListener,!1),removeEventListener("offline",this.offlineEventListener,!1)),this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(e){const t=[];let n=0;const s=e.length;for(;n<s;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}};oN.protocol=eN;function BAe(r,e="",t){let n=r;t=t||typeof location<"u"&&location,r==null&&(r=t.protocol+"//"+t.host),typeof r=="string"&&(r.charAt(0)==="/"&&(r.charAt(1)==="/"?r=t.protocol+r:r=t.host+r),/^(https?|wss?):\/\//.test(r)||(typeof t<"u"?r=t.protocol+"//"+r:r="https://"+r),n=X3(r)),n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443")),n.path=n.path||"/";const i=n.host.indexOf(":")!==-1?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+i+":"+n.port+e,n.href=n.protocol+"://"+i+(t&&t.port===n.port?"":":"+n.port),n}const zAe=typeof ArrayBuffer=="function",FAe=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r.buffer instanceof ArrayBuffer,aN=Object.prototype.toString,VAe=typeof Blob=="function"||typeof Blob<"u"&&aN.call(Blob)==="[object BlobConstructor]",jAe=typeof File=="function"||typeof File<"u"&&aN.call(File)==="[object FileConstructor]";function M5(r){return zAe&&(r instanceof ArrayBuffer||FAe(r))||VAe&&r instanceof Blob||jAe&&r instanceof File}function yp(r,e){if(!r||typeof r!="object")return!1;if(Array.isArray(r)){for(let t=0,n=r.length;t<n;t++)if(yp(r[t]))return!0;return!1}if(M5(r))return!0;if(r.toJSON&&typeof r.toJSON=="function"&&arguments.length===1)return yp(r.toJSON(),!0);for(const t in r)if(Object.prototype.hasOwnProperty.call(r,t)&&yp(r[t]))return!0;return!1}function qAe(r){const e=[],t=r.data,n=r;return n.data=J3(t,e),n.attachments=e.length,{packet:n,buffers:e}}function J3(r,e){if(!r)return r;if(M5(r)){const t={_placeholder:!0,num:e.length};return e.push(r),t}else if(Array.isArray(r)){const t=new Array(r.length);for(let n=0;n<r.length;n++)t[n]=J3(r[n],e);return t}else if(typeof r=="object"&&!(r instanceof Date)){const t={};for(const n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=J3(r[n],e));return t}return r}function KAe(r,e){return r.data=Z3(r.data,e),delete r.attachments,r}function Z3(r,e){if(!r)return r;if(r&&r._placeholder===!0){if(typeof r.num=="number"&&r.num>=0&&r.num<e.length)return e[r.num];throw new Error("illegal attachments")}else if(Array.isArray(r))for(let t=0;t<r.length;t++)r[t]=Z3(r[t],e);else if(typeof r=="object")for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&(r[t]=Z3(r[t],e));return r}const GAe=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],HAe=5;var we;(function(r){r[r.CONNECT=0]="CONNECT",r[r.DISCONNECT=1]="DISCONNECT",r[r.EVENT=2]="EVENT",r[r.ACK=3]="ACK",r[r.CONNECT_ERROR=4]="CONNECT_ERROR",r[r.BINARY_EVENT=5]="BINARY_EVENT",r[r.BINARY_ACK=6]="BINARY_ACK"})(we||(we={}));let WAe=class{constructor(e){this.replacer=e}encode(e){return(e.type===we.EVENT||e.type===we.ACK)&&yp(e)?this.encodeAsBinary({type:e.type===we.EVENT?we.BINARY_EVENT:we.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===we.BINARY_EVENT||e.type===we.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=qAe(e),n=this.encodeAsString(t.packet),s=t.buffers;return s.unshift(n),s}};function CA(r){return Object.prototype.toString.call(r)==="[object Object]"}let QAe=class cN extends Nt{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===we.BINARY_EVENT;n||t.type===we.BINARY_ACK?(t.type=n?we.EVENT:we.ACK,this.reconstructor=new YAe(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(M5(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(we[n.type]===void 0)throw new Error("unknown packet type "+n.type);if(n.type===we.BINARY_EVENT||n.type===we.BINARY_ACK){const i=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const o=e.substring(i,t);if(o!=Number(o)||e.charAt(t)!=="-")throw new Error("Illegal attachments");n.attachments=Number(o)}if(e.charAt(t+1)==="/"){const i=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););n.nsp=e.substring(i,t)}else n.nsp="/";const s=e.charAt(t+1);if(s!==""&&Number(s)==s){const i=t+1;for(;++t;){const o=e.charAt(t);if(o==null||Number(o)!=o){--t;break}if(t===e.length)break}n.id=Number(e.substring(i,t+1))}if(e.charAt(++t)){const i=this.tryParse(e.substr(t));if(cN.isPayloadValid(n.type,i))n.data=i;else throw new Error("invalid payload")}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case we.CONNECT:return CA(t);case we.DISCONNECT:return t===void 0;case we.CONNECT_ERROR:return typeof t=="string"||CA(t);case we.EVENT:case we.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&GAe.indexOf(t[0])===-1);case we.ACK:case we.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}};class YAe{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=KAe(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const XAe=Object.freeze(Object.defineProperty({__proto__:null,Decoder:QAe,Encoder:WAe,get PacketType(){return we},protocol:HAe},Symbol.toStringTag,{value:"Module"}));function ds(r,e,t){return r.on(e,t),function(){r.off(e,t)}}const JAe=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class lN extends Nt{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[ds(e,"open",this.onopen.bind(this)),ds(e,"packet",this.onpacket.bind(this)),ds(e,"error",this.onerror.bind(this)),ds(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){if(JAe.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const n={type:we.EVENT,data:t};if(n.options={},n.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const o=this.ids++,a=t.pop();this._registerAckCallback(o,a),n.id=o}const s=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!s||!this.connected)||(this.connected?(this.notifyOutgoingListeners(n),this.packet(n)):this.sendBuffer.push(n)),this.flags={},this}_registerAckCallback(e,t){var n;const s=(n=this.flags.timeout)!==null&&n!==void 0?n:this._opts.ackTimeout;if(s===void 0){this.acks[e]=t;return}const i=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let o=0;o<this.sendBuffer.length;o++)this.sendBuffer[o].id===e&&this.sendBuffer.splice(o,1);t.call(this,new Error("operation has timed out"))},s);this.acks[e]=(...o)=>{this.io.clearTimeoutFn(i),t.apply(this,[null,...o])}}emitWithAck(e,...t){const n=this.flags.timeout!==void 0||this._opts.ackTimeout!==void 0;return new Promise((s,i)=>{t.push((o,a)=>n?o?i(o):s(a):s(o)),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const n={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((s,...i)=>n!==this._queue[0]?void 0:(s!==null?n.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(s)):(this._queue.shift(),t&&t(null,...i)),n.pending=!1,this._drainQueue())),this._queue.push(n),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:we.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t)}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case we.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case we.EVENT:case we.BINARY_EVENT:this.onevent(e);break;case we.ACK:case we.BINARY_ACK:this.onack(e);break;case we.DISCONNECT:this.ondisconnect();break;case we.CONNECT_ERROR:this.destroy();const n=new Error(e.data.message);n.data=e.data.data,this.emitReserved("connect_error",n);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(...s){n||(n=!0,t.packet({type:we.ACK,id:e,data:s}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(t.apply(this,e.data),delete this.acks[e.id])}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:we.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}function Bl(r){r=r||{},this.ms=r.min||100,this.max=r.max||1e4,this.factor=r.factor||2,this.jitter=r.jitter>0&&r.jitter<=1?r.jitter:0,this.attempts=0}Bl.prototype.duration=function(){var r=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*r);r=Math.floor(e*10)&1?r+t:r-t}return Math.min(r,this.max)|0};Bl.prototype.reset=function(){this.attempts=0};Bl.prototype.setMin=function(r){this.ms=r};Bl.prototype.setMax=function(r){this.max=r};Bl.prototype.setJitter=function(r){this.jitter=r};class e6 extends Nt{constructor(e,t){var n;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,rg(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((n=t.randomizationFactor)!==null&&n!==void 0?n:.5),this.backoff=new Bl({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const s=t.parser||XAe;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new oN(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const s=ds(t,"open",function(){n.onopen(),e&&e()}),i=a=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",a),e?e(a):this.maybeReconnectOnOpen()},o=ds(t,"error",i);if(this._timeout!==!1){const a=this._timeout,c=this.setTimeoutFn(()=>{s(),i(new Error("timeout")),t.close()},a);this.opts.autoUnref&&c.unref(),this.subs.push(()=>{this.clearTimeoutFn(c)})}return this.subs.push(s),this.subs.push(o),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(ds(e,"ping",this.onping.bind(this)),ds(e,"data",this.ondata.bind(this)),ds(e,"error",this.onerror.bind(this)),ds(e,"close",this.onclose.bind(this)),ds(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){L5(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new lN(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const n of t)if(this.nsps[n].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e,t){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(s=>{s?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",s)):e.onreconnect()}))},t);this.opts.autoUnref&&n.unref(),this.subs.push(()=>{this.clearTimeoutFn(n)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const Pu={};function wp(r,e){typeof r=="object"&&(e=r,r=void 0),e=e||{};const t=BAe(r,e.path||"/socket.io"),n=t.source,s=t.id,i=t.path,o=Pu[s]&&i in Pu[s].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||o;let c;return a?c=new e6(n,e):(Pu[s]||(Pu[s]=new e6(n,e)),c=Pu[s]),t.query&&!e.query&&(e.query=t.queryKey),c.socket(t.path,e)}Object.assign(wp,{Manager:e6,Socket:lN,io:wp,connect:wp});const Vf=65536;function ZAe(r){const e=new Uint8Array(r);let t=0;if(r>0)if(r>Vf)for(;t<r;)t+Vf>r?(crypto.getRandomValues(e.subarray(t,t+(r-t))),t+=r-t):(crypto.getRandomValues(e.subarray(t,t+Vf)),t+=Vf);else crypto.getRandomValues(e);return e}var e$e=ZAe;const U5=Ge(e$e),xA=64*1024,t$e=5*1e3;class r$e{constructor(e,t){this.label=e.label,this.open=Pe(),this.channel=e,this.channel.binaryType="arraybuffer",this.log=t.log,typeof this.channel.bufferedAmountLowThreshold=="number"&&(this.channel.bufferedAmountLowThreshold=xA),e.addEventListener("message",s=>{t.onMessage(s)}),e.addEventListener("bufferedamountlow",()=>{this.log("stop backpressure: bufferedAmount %d",this.channel.bufferedAmount),this.open.resolve()}),e.addEventListener("open",()=>{this.open.resolve(),t.onOpen()}),e.addEventListener("close",()=>{t.onClose()}),e.addEventListener("error",s=>{if(s.error?.message==="Transport channel closed")return this.close();t.log.error('channel encounter an error in state "%s" message: "%s" detail: "%s',e.readyState,s.error?.message,s.error?.errorDetail);const i=s.error instanceof Error?s.error:new Error(`datachannel error: ${s.error?.message} ${s.error?.errorDetail}`);t.onError($(i,"ERR_DATA_CHANNEL"))});let n=!1;this.closingInterval=setInterval(()=>{e.readyState==="closing"?(n&&t.onClose(),n=!0):n=!1},t$e)}async send(e){await this.open.promise,this.channel.send(e),this.channel.bufferedAmount>xA&&(this.log("start backpressure: bufferedAmount %d",this.channel.bufferedAmount),this.open=Pe())}close(){clearInterval(this.closingInterval),this.channel.close()}get bufferedAmount(){return this.channel.bufferedAmount}}var B5={exports:{}};const n$e=(r,e)=>Math.floor(Math.random()*(e-r+1)+r),DA=()=>{const r=new Error("Delay aborted");return r.name="AbortError",r},OA=({clearTimeout:r,setTimeout:e,willResolve:t})=>(n,{value:s,signal:i}={})=>{if(i&&i.aborted)return Promise.reject(DA());let o,a,c;const u=r||clearTimeout,l=()=>{u(o),c(DA())},d=()=>{i&&i.removeEventListener("abort",l)},f=new Promise((g,h)=>{a=()=>{d(),t?g(s):h(s)},c=h,o=(e||setTimeout)(a,n)});return i&&i.addEventListener("abort",l,{once:!0}),f.clear=()=>{u(o),o=null,a()},f},uN=r=>{const e=OA({...r,willResolve:!0});return e.reject=OA({...r,willResolve:!1}),e.range=(t,n,s)=>e(n$e(t,n),s),e},z5=uN();z5.createWithTimers=uN;B5.exports=z5;B5.exports.default=z5;var s$e=B5.exports;const dN=Ge(s$e),i$e={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}]};function o$e(){if(typeof globalThis>"u")throw $(new Error("No WebRTC support detected"),"ERR_WEBRTC_SUPPORT");const r={RTCPeerConnection:globalThis.RTCPeerConnection??globalThis.mozRTCPeerConnection??globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription??globalThis.mozRTCSessionDescription??globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate??globalThis.mozRTCIceCandidate??globalThis.webkitRTCIceCandidate};if(r.RTCPeerConnection==null)throw $(new Error("No WebRTC support detected"),"ERR_WEBRTC_SUPPORT");return r}class hN extends gt{constructor(e){super(),this.id=e.id??C(U5(4),"hex").slice(0,7),this.log=N(`libp2p:webrtc-peer:${e.logPrefix}:${this.id}`),this.wrtc=e.wrtc??o$e(),this.peerConnection=new this.wrtc.RTCPeerConnection(Object.assign({},i$e,e.peerConnectionConfig)),this.closed=!1,this.connected=Pe(),this.source=Mt(),this.sink=async t=>{if(await this.connected.promise,this.channel==null)throw $(new Error("Connected but no channel?!"),"ERR_DATA_CHANNEL");for await(const n of t)await this.channel.send(n);await this.close()}}handleDataChannelEvent(e){const t=e.channel;if(t==null){this.close($(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL")).catch(n=>{this.log("Error closing after event channel was found to be null",n)});return}this.channel=new r$e(t,{log:this.log,onMessage:n=>{this.source.push(new Uint8Array(n.data))},onOpen:()=>{this.connected.resolve(),this.dispatchEvent(new W("ready"))},onClose:()=>{this.close().catch(n=>{this.log("error closing connection after channel close",n)})},onError:n=>{this.close(n).catch(s=>{this.log("error closing connection after channel error",s)})}})}async close(e){if(this.closed=!0,e==null&&this.channel!=null)for(;this.channel.bufferedAmount>0;)await dN(100);this.channel?.close(),this.peerConnection.close(),this.source.end(e),this.dispatchEvent(new W("close"))}}class fN extends gt{constructor(e){super(),this.log=e.log,this.peerConnection=e.peerConnection,this.wrtc=e.wrtc,this.status="idle",this.peerConnection.addEventListener("negotiationneeded",()=>{this.log("peer connection negotiation needed"),this.handleRenegotiate({type:"renegotiate"}).catch(t=>{this.log.error("could not renegotiate %o",t)})})}async handleSignal(e){if(this.log('incoming signal "%s"',e.type),e.type==="offer")return await this.handleOffer(e);if(e.type==="answer")return await this.handleAnswer(e);if(e.type==="candidate")return await this.handleCandidate(e);if(e.type==="renegotiate")return await this.handleRenegotiate(e);if(e.type==="goodbye")return await this.handleGoodye(e);this.log(`Unknown signal type ${e.type}`)}async handleOffer(e){}async handleAnswer(e){}async handleRenegotiate(e){}async handleGoodye(e){this.peerConnection.close()}async handleCandidate(e){const t=new this.wrtc.RTCIceCandidate(e.candidate);try{await this.peerConnection.addIceCandidate(t)}catch(n){if(t.address==null||t.address.endsWith(".local"))this.log("ignoring unsupported ICE candidate.");else throw $(n,"ERR_ADD_ICE_CANDIDATE")}}}const PA=N("libp2p:webrtc-peer:receiver");class a$e extends hN{constructor(e={}){super({...e,logPrefix:"receiver"}),this.handshake=new c$e({log:this.log,peerConnection:this.peerConnection,wrtc:this.wrtc,answerOptions:e.answerOptions}),this.handshake.addEventListener("signal",t=>this.dispatchEvent(new W("signal",{detail:t.detail}))),this.peerConnection.addEventListener("datachannel",t=>{this.handleDataChannelEvent(t)})}handleSignal(e){this.handshake.handleSignal(e).catch(t=>{this.log("error handling signal %o %o",e,t)})}}class c$e extends fN{constructor(e){super(e),this.options=e,this.status="idle",this.iceCandidates=[]}async handleRenegotiate(){PA.trace("renegotiate"),this.dispatchEvent(new W("signal",{detail:{type:"renegotiate"}}))}async handleOffer(e){await this.peerConnection.setRemoteDescription(new this.wrtc.RTCSessionDescription(e));for(const n of this.iceCandidates)await this.handleCandidate(n);this.iceCandidates=[];const t=await this.peerConnection.createAnswer(this.options.answerOptions);await this.peerConnection.setLocalDescription(t),PA.trace("handle offer",this.peerConnection.localDescription),this.dispatchEvent(new W("signal",{detail:this.peerConnection.localDescription??t}))}async handleCandidate(e){if(this.peerConnection.remoteDescription==null||this.peerConnection.remoteDescription.type==null){this.iceCandidates.push(e);return}await super.handleCandidate(e)}}const l$e=r=>{const e=r.on||r.addListener||r.addEventListener,t=r.off||r.removeListener||r.removeEventListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function u$e(r,e,t){let n;const s=new Promise((i,o)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");const a=[e].flat(),c=[],{addListener:u,removeListener:l}=l$e(r),d=(...g)=>{const h=t.multiArgs?g:g[0];t.filter&&!t.filter(h)||(c.push(h),t.count===c.length&&(n(),i(c)))},f=g=>{n(),o(g)};n=()=>{for(const g of a)l(g,d);for(const g of t.rejectionEvents)l(g,f)};for(const g of a)u(g,d);for(const g of t.rejectionEvents)u(g,f);t.resolveImmediately&&i(c)});if(s.cancel=n,typeof t.timeout=="number"){const i=sU(s,t.timeout);return i.cancel=n,i}return s}function d$e(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=u$e(r,e,t),s=n.then(i=>i[0]);return s.cancel=n.cancel,s}const Wy=N("libp2p:webrtc-peer:initator"),h$e=1e3;class f$e extends hN{constructor(e={}){super({...e,logPrefix:"initiator"}),this.handleDataChannelEvent({channel:this.peerConnection.createDataChannel(e.dataChannelLabel??C(U5(20),"hex").slice(0,7),e.dataChannelInit)}),this.handshake=new p$e({log:this.log,peerConnection:this.peerConnection,wrtc:this.wrtc,offerOptions:e.offerOptions}),this.handshake.addEventListener("signal",t=>{this.dispatchEvent(new W("signal",{detail:t.detail}))})}handleSignal(e){this.handshake.handleSignal(e).catch(t=>{this.log("error handling signal %o %o",e,t)})}}class p$e extends fN{constructor(e){super(e),this.options=e,this.status="idle",this.peerConnection.addEventListener("icecandidate",t=>{if(t.candidate==null)return;const n={type:"candidate",candidate:{candidate:t.candidate.candidate,sdpMLineIndex:t.candidate.sdpMLineIndex,sdpMid:t.candidate.sdpMid}};Wy.trace("create candidate",n),this.dispatchEvent(new W("signal",{detail:n})),this.dispatchEvent(new W("ice-candidate"))})}async handleRenegotiate(){if(this.status==="negotiating"){this.log("already negotiating, queueing");return}this.status="negotiating";const e=await this.peerConnection.createOffer(this.options.offerOptions);await this.peerConnection.setLocalDescription(e),await d$e(this,"ice-candidate"),await dN(h$e),Wy.trace("renegotiate",this.peerConnection.localDescription),this.dispatchEvent(new W("signal",{detail:this.peerConnection.localDescription??e}))}async handleAnswer(e){Wy.trace("handle answer",e),await this.peerConnection.setRemoteDescription(new this.wrtc.RTCSessionDescription(e)),this.status="idle"}}const Qy=N("libp2p:webrtc-star:socket");function pN(r,e){const{sink:t,source:n}=r,s={remoteAddr:e.remoteAddr,async sink(i){e.signal!=null&&(i=K1(i,e.signal));try{await t(i)}catch(o){o.type!=="aborted"&&Qy.error(o)}},source:e.signal!=null?K1(n,e.signal):n,timeline:{open:Date.now()},async close(){if(r.closed)return;const i=Date.now(),o=setTimeout(()=>{if(s.remoteAddr!=null){const{host:a,port:c}=s.remoteAddr.toOptions();Qy("timeout closing socket to %s:%s after %dms, destroying it manually",a,c,Date.now()-i)}r.closed||r.close().catch(a=>{Qy.error("could not close socket",a)})},cAe);try{await r.close()}finally{clearTimeout(o)}}};return r.addEventListener("close",()=>{s.timeline.close==null&&(s.timeline.close=Date.now())},{once:!0}),s}function gN(r){const e=r.toString().split("/"),t=r.protos()[1].name,n=r.protos()[2].name,s=r.stringTuples()[1][1];if(t!=="tcp"||n!=="ws"&&n!=="wss")throw new Error(`invalid multiaddr: ${r.toString()}`);if(!l_e(r))return`http://${e[2]}:${e[4]}`;if(n==="ws")return`http://${e[2]}${s==null||s==="80"?"":`:${s}`}`;if(n==="wss")return`https://${e[2]}${s==null||s==="443"?"":`:${s}`}`;throw new Error("invalid multiaddr: "+r.toString())}function g$e(r){const e="/libp2p-webrtc-star";if(r.startsWith(e)){r=r.substring(e.length,r.length);let t=kk(r);const n=t.stringTuples().filter(s=>s[0]===421)[0];if(n[1]==null)throw new Error("invalid multiaddr: "+r);t=t.decapsulate("p2p"),t=t.encapsulate("/p2p-webrtc-star"),t=t.encapsulate(`/p2p/${n[1]}`),r=t.toString()}return r}const Nr=N("libp2p:webrtc-star:listener"),y$e={transports:["websocket"],path:"/socket.io-next/"};class w$e extends gt{constructor(e,t,n,s,i){super(),this.signallingAddr=t,this.socket=wp(e,y$e),this.connections=[],this.channels=new Map,this.pendingSignals=new Map,this.upgrader=n,this.handler=s,this.channelOptions=i,this.handleWsHandshake=this.handleWsHandshake.bind(this);let o=!1;this.socket.on("connect_error",a=>{o&&a.type==="TransportError"||this.dispatchEvent(new W("error",{detail:a}))}),this.socket.on("error",a=>{this.dispatchEvent(new W("error",{detail:a}))}),this.socket.on("ws-handshake",this.handleWsHandshake),this.socket.on("ws-peer",a=>{this.dispatchEvent(new W("peer",{detail:a}))}),this.socket.on("connect",()=>{this.socket.emit("ss-join",this.signallingAddr.toString()),o&&this.dispatchEvent(new W("reconnect"))}),this.socket.once("connect",()=>{o=!0,this.dispatchEvent(new W("listening"))}),this.socket.on("disconnect",()=>{this.dispatchEvent(new W("disconnect"))})}_createChannel(e,t,n){const s={...this.channelOptions},i=new a$e(s),o=a=>{const c=a.detail;Nr.error("incoming connection errored",c)};return i.addEventListener("error",o),i.addEventListener("close",()=>{i.removeEventListener("error",o)},{once:!0}),i.addEventListener("signal",a=>{const c=a.detail;this.socket.emit("ss-handshake",{intentId:e,srcMultiaddr:t,dstMultiaddr:n,answer:!0,signal:c})}),i.addEventListener("ready",()=>{const a=pN(i,{remoteAddr:this.signallingAddr});Nr("new inbound connection %s",a.remoteAddr);try{this.upgrader.upgradeInbound(a).then(c=>{Nr("inbound connection %s upgraded",a.remoteAddr),this.connections.push(a);const u=()=>{this.connections=this.connections.filter(l=>l!==a),this.channels.delete(e),this.pendingSignals.delete(e)};i.addEventListener("close",u,{once:!0}),this.dispatchEvent(new W("connection",{detail:c})),this.handler(c)}).catch(c=>{Nr.error("inbound connection failed to upgrade",c),a.close().catch(u=>{Nr.error("inbound connection failed to close after failing to upgrade",u)})})}catch(c){Nr.error("inbound connection failed to upgrade",c),a.close().catch(u=>{Nr.error("inbound connection failed to close after failing to upgrade",u)})}},{once:!0}),i}handleWsHandshake(e){if(Nr('incoming handshake. signal type "%s" is answer %s',e.signal.type,e.answer),e.answer===!0||e.err!=null||e.intentId==null)return;const t=e.intentId;let n=this.pendingSignals.get(t);n==null&&(n=[],this.pendingSignals.set(t,n)),n.push(e);let s=this.channels.get(t);if(s==null){if(e.signal.type!=="offer"){Nr("handshake is not an offer and channel does not exist, buffering until we receive an offer");return}Nr("creating new channel to handle offer handshake"),s=this._createChannel(e.intentId,e.srcMultiaddr,e.dstMultiaddr),this.channels.set(t,s)}else Nr("channel already exists, using it to handle handshake");for(;n.length>0;){const i=n.shift();i?.signal!=null&&s.handleSignal(i.signal)}}async close(){this.socket.emit("ss-leave",this.signallingAddr.toString()),this.socket.removeAllListeners(),this.socket.close(),await Promise.all([...this.connections.map(async e=>await e.close()),...Array.from(this.channels.values()).map(async e=>await e.close())]),this.dispatchEvent(new W("close"))}}class b$e extends gt{constructor(e,t,n,s,i){super(),this.upgrader=e,this.handler=t,this.peerId=n,this.transport=s,this.options=i}async listen(e){if(this.listeningAddr!=null)throw $(new Error("listener already in use"),"ERR_ALREADY_LISTENING");const t=Pe();this.listeningAddr=e;let n;e.protoCodes().includes(mA)?n=e:n=e.encapsulate(`/p2p/${this.peerId.toString()}`);const s=this.signallingUrl=gN(e);Nr("connecting to signalling server on: %s",this.signallingUrl);const i=new w$e(this.signallingUrl,n,this.upgrader,this.handler,this.options.channelOptions);return i.addEventListener("error",o=>{const a=o.detail;Nr("error connecting to signalling server %o",a),i.close().catch(c=>{Nr.error("error closing server after error",c)}),t.reject(a)}),i.addEventListener("listening",()=>{Nr("connected to signalling server"),this.dispatchEvent(new W("listening")),t.resolve()}),i.addEventListener("peer",o=>{this.transport.peerDiscovered(o.detail)}),i.addEventListener("connection",o=>{const a=o.detail;if(a.remoteAddr==null)try{a.remoteAddr=e.decapsulateCode(mA).encapsulate(`/p2p/${a.remotePeer.toString()}`)}catch(c){Nr.error("could not determine remote address",c)}this.dispatchEvent(new W("connection",{detail:a}))}),i.addEventListener("disconnect",()=>{this.transport.sigServers.delete(s)}),i.addEventListener("reconnect",()=>{this.transport.sigServers.set(s,i)}),this.transport.sigServers.set(this.signallingUrl,i),await t.promise}async close(){if(this.signallingUrl!=null){const e=this.transport.sigServers.get(this.signallingUrl);e!=null&&(await e.close(),this.transport.sigServers.delete(this.signallingUrl))}this.dispatchEvent(new W("close")),this.listeningAddr=void 0}getAddrs(){return this.listeningAddr!=null?[this.listeningAddr]:[]}}function m$e(r,e,t,n,s){return new b$e(r,e,t,n,s)}const F5=Symbol.for("@libp2p/transport");var Hc;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(Hc||(Hc={}));const Hh=Symbol.for("@libp2p/peer-discovery"),E$e="RTCPeerConnection"in globalThis,Zo=N("libp2p:webrtc-star"),v$e=()=>{};class _$e extends gt{constructor(){super(...arguments),this.started=!1}get[Hh](){return!0}get[Symbol.toStringTag](){return"@libp2p/webrtc-star-discovery"}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}dispatchEvent(e){return this.isStarted()?super.dispatchEvent(e):!1}}let S$e=class{constructor(e){e?.wrtc!=null&&(this.wrtc=e.wrtc),this.sigServers=new Map,this._discovery=new _$e,this.discovery=()=>this._discovery,this.peerDiscovered=this.peerDiscovered.bind(this)}get[F5](){return!0}get[Symbol.toStringTag](){return"@libp2p/webrtc-star"}async dial(e,t){const n=await this._connect(e,t),s=pN(n,{remoteAddr:e,signal:t.signal});Zo("new outbound connection %s",s.remoteAddr);const i=await t.upgrader.upgradeOutbound(s);return Zo("outbound connection %s upgraded",s.remoteAddr),i}async _connect(e,t){if(t.signal?.aborted===!0)throw new q1;const n={...t.channelOptions??{}};this.wrtc!=null&&(n.wrtc=this.wrtc);const s=e.toOptions(),i=C(U5(36),"hex");return await new Promise((o,a)=>{const c=this.sigServers.get(gN(e));if(c?.socket==null)return a($(new Error("unknown signal server to use"),"ERR_UNKNOWN_SIGNAL_SERVER"));let u=!1;Zo("dialing %s:%s",s.host,s.port);const l=new f$e(n),d=p=>{const w=p.detail;if(!u){const y=`connection error ${s.host}:${s.port}: ${w.message}`;Zo.error(y),h(w)}},f=()=>{u=!0,Zo("connection opened %s:%s",s.host,s.port),h()},g=()=>{Zo.error("connection aborted %s:%s",s.host,s.port),l.close().finally(()=>{h(new q1)})},h=p=>{l.removeEventListener("ready",f),t.signal?.removeEventListener("abort",g),p==null?o(l):a(p)};l.addEventListener("ready",f,{once:!0}),l.addEventListener("close",()=>{l.removeEventListener("error",d)}),t.signal?.addEventListener("abort",g),l.addEventListener("signal",p=>{const w=p.detail;c.socket.emit("ss-handshake",{intentId:i,srcMultiaddr:c.signallingAddr.toString(),dstMultiaddr:e.toString(),signal:w})}),c.socket.on("ws-handshake",p=>{p.intentId===i&&p.err!=null&&l.close().finally(()=>{a($(new Error(p.err),"ERR_SIGNALLING_FAILED"))}),!(p.intentId!==i||p.answer==null||l.closed)&&l.handleSignal(p.signal)})})}createListener(e){if(!E$e&&this.wrtc==null)throw $(new Error("no WebRTC support"),"ERR_NO_WEBRTC_SUPPORT");if(e.channelOptions=e.channelOptions??{},this.wrtc!=null&&(e.channelOptions.wrtc=this.wrtc),this.peerId==null)throw $(new Error("PeerId not set"),"ERR_MISSING_PEER_ID");return m$e(e.upgrader,e.handler??v$e,this.peerId,this,e)}filter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>t.protoCodes().includes(aAe)?!1:oAe.matches(t))}peerDiscovered(e){Zo("peer discovered: %s",e),e=g$e(e);const t=kk(e),n=t.getPeerId();if(n==null)return;const s=de(n);this._discovery.dispatchEvent(new W("peer",{detail:{id:s,multiaddrs:[t],protocols:[]}}))}};function A$e(r={}){const e=new S$e(r);return{transport:t=>(e.peerId=t.peerId,e),discovery:e.discovery}}function $$e(){const r=A$e();return{transports:[r.transport],peerDiscovery:[r.discovery],connectionManager:{maxParallelDials:150,maxDialsPerPeer:4,dialTimeout:1e4,autoDial:!0},nat:{enabled:!1}}}function ra(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}const kA=es,R$e=ts,yN=function(r){let e=0;if(r=r.toString().trim(),kA(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(R$e(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=kA(t[n]);let o;i&&(o=yN(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},T$e=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},kn=-1,d0={},t6={},I$e=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,kn,"ip6zone"],[43,8,"ipcidr"],[53,kn,"dns",!0],[54,kn,"dns4",!0],[55,kn,"dns6",!0],[56,kn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc"],[281,0,"webrtc-w3c"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,kn,"unix",!1,!0],[421,kn,"ipfs"],[421,kn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,kn,"garlic64"],[448,0,"tls"],[449,kn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,kn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,kn,"memory"]];I$e.forEach(r=>{const e=C$e(...r);t6[e.code]=e,d0[e.name]=e});function C$e(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function at(r){if(typeof r=="number"){if(t6[r]!=null)return t6[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(d0[r]!=null)return d0[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}var x$e=wN,NA=128,D$e=127,O$e=~D$e,P$e=Math.pow(2,31);function wN(r,e,t){e=e||[],t=t||0;for(var n=t;r>=P$e;)e[t++]=r&255|NA,r/=128;for(;r&O$e;)e[t++]=r&255|NA,r>>>=7;return e[t]=r|0,wN.bytes=t-n+1,e}var k$e=r6,N$e=128,LA=127;function r6(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw r6.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&LA)<<s:(o&LA)*Math.pow(2,s),s+=7}while(o>=N$e);return r6.bytes=i-n,t}var L$e=Math.pow(2,7),M$e=Math.pow(2,14),U$e=Math.pow(2,21),B$e=Math.pow(2,28),z$e=Math.pow(2,35),F$e=Math.pow(2,42),V$e=Math.pow(2,49),j$e=Math.pow(2,56),q$e=Math.pow(2,63),K$e=function(r){return r<L$e?1:r<M$e?2:r<U$e?3:r<B$e?4:r<z$e?5:r<F$e?6:r<V$e?7:r<j$e?8:r<q$e?9:10},G$e={encode:x$e,decode:k$e,encodingLength:K$e},h0=G$e;const n6=(r,e=0)=>[h0.decode(r,e),h0.decode.bytes],f0=(r,e,t=0)=>(h0.encode(r,e,t),e),p0=r=>h0.encodingLength(r),H$e=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},V5=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},W$e=r=>new TextEncoder().encode(r),Q$e=r=>new TextDecoder().decode(r),s6=(r,e)=>{const t=e.byteLength,n=p0(r),s=n+p0(t),i=new Uint8Array(s+t);return f0(r,i,0),f0(t,i,n),i.set(e,s),new j5(r,t,e,i)},bN=r=>{const e=V5(r),[t,n]=n6(e),[s,i]=n6(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new j5(t,s,o,e)},Y$e=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&H$e(r.bytes,t.bytes)}};let j5=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function X$e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var J$e=X$e,Z$e=J$e;let eRe=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},tRe=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return mN(this,e)}},rRe=class{constructor(e){this.decoders=e}or(e){return mN(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const mN=(r,e)=>new rRe({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let nRe=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new eRe(e,t,n),this.decoder=new tRe(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const ng=({name:r,prefix:e,encode:t,decode:n})=>new nRe(r,e,t,n),Wh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=Z$e(t,e);return ng({prefix:r,name:e,encode:n,decode:i=>V5(s(i))})},sRe=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},iRe=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},ar=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>ng({prefix:e,name:r,encode(s){return iRe(s,n,t)},decode(s){return sRe(s,n,t,r)}}),Ss=Wh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),oRe=Wh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),aRe=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Ss,base58flickr:oRe},Symbol.toStringTag,{value:"Module"})),Ia=ar({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),cRe=ar({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),lRe=ar({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),uRe=ar({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),dRe=ar({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),hRe=ar({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),fRe=ar({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),pRe=ar({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),gRe=ar({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),yRe=Object.freeze(Object.defineProperty({__proto__:null,base32:Ia,base32hex:dRe,base32hexpad:fRe,base32hexpadupper:pRe,base32hexupper:hRe,base32pad:lRe,base32padupper:uRe,base32upper:cRe,base32z:gRe},Symbol.toStringTag,{value:"Module"})),MA=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return bRe(t,i6(r),e||Ss.encoder);default:return mRe(t,i6(r),e||Ia.encoder)}},UA=new WeakMap,i6=r=>{const e=UA.get(r);if(e==null){const t=new Map;return UA.set(r,t),t}return e};let q5=class xr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ku)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==ERe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return xr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=s6(e,t);return xr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return xr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&Y$e(e.multihash,n.multihash)}toString(e){return MA(this,e)}toJSON(){return{"/":MA(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof xr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new xr(n,s,i,o||BA(n,s,i.bytes))}else if(t[vRe]===!0){const{version:n,multihash:s,code:i}=t,o=bN(s);return xr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ku)throw new Error(`Version 0 CID must use dag-pb (code: ${ku}) block encoding`);return new xr(e,t,n,n.bytes)}case 1:{const s=BA(e,t,n.bytes);return new xr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return xr.create(0,ku,e)}static createV1(e,t){return xr.create(1,e,t)}static decode(e){const[t,n]=xr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=xr.inspectBytes(e),n=t.size-t.multihashSize,s=V5(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new j5(t.multihashCode,t.digestSize,i,s);return[t.version===0?xr.createV0(o):xr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=n6(e.subarray(t));return t+=f,d};let s=n(),i=ku;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=wRe(e,t),i=xr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return i6(i).set(n,e),i}};const wRe=(r,e)=>{switch(r[0]){case"Q":{const t=e||Ss;return[Ss.prefix,t.decode(`${Ss.prefix}${r}`)]}case Ss.prefix:{const t=e||Ss;return[Ss.prefix,t.decode(r)]}case Ia.prefix:{const t=e||Ia;return[Ia.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},bRe=(r,e,t)=>{const{prefix:n}=t;if(n!==Ss.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},mRe=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},ku=112,ERe=18,BA=(r,e,t)=>{const n=p0(r),s=n+p0(e),i=new Uint8Array(s+t.byteLength);return f0(r,i,0),f0(e,i,n),i.set(t,s),i},vRe=Symbol.for("@ipld/js-cid/CID"),_Re=ng({prefix:"\0",name:"identity",encode:r=>Q$e(r),decode:r=>W$e(r)}),SRe=Object.freeze(Object.defineProperty({__proto__:null,identity:_Re},Symbol.toStringTag,{value:"Module"})),ARe=ar({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),$Re=Object.freeze(Object.defineProperty({__proto__:null,base2:ARe},Symbol.toStringTag,{value:"Module"})),RRe=ar({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),TRe=Object.freeze(Object.defineProperty({__proto__:null,base8:RRe},Symbol.toStringTag,{value:"Module"})),IRe=Wh({prefix:"9",name:"base10",alphabet:"0123456789"}),CRe=Object.freeze(Object.defineProperty({__proto__:null,base10:IRe},Symbol.toStringTag,{value:"Module"})),xRe=ar({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),DRe=ar({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),ORe=Object.freeze(Object.defineProperty({__proto__:null,base16:xRe,base16upper:DRe},Symbol.toStringTag,{value:"Module"})),PRe=Wh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),kRe=Wh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),NRe=Object.freeze(Object.defineProperty({__proto__:null,base36:PRe,base36upper:kRe},Symbol.toStringTag,{value:"Module"})),LRe=ar({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),MRe=ar({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),URe=ar({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),BRe=ar({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),zRe=Object.freeze(Object.defineProperty({__proto__:null,base64:LRe,base64pad:MRe,base64url:URe,base64urlpad:BRe},Symbol.toStringTag,{value:"Module"})),EN=Array.from(""),FRe=EN.reduce((r,e,t)=>(r[t]=e,r),[]),VRe=EN.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function jRe(r){return r.reduce((e,t)=>(e+=FRe[t],e),"")}function qRe(r){const e=[];for(const t of r){const n=VRe[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const KRe=ng({prefix:"",name:"base256emoji",encode:jRe,decode:qRe}),GRe=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:KRe},Symbol.toStringTag,{value:"Module"})),HRe=({name:r,code:e,encode:t})=>new WRe(r,e,t);let WRe=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?s6(this.code,t):t.then(n=>s6(this.code,n))}else throw Error("Unknown type, must be binary type")}};const QRe=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),YRe=HRe({name:"sha2-256",code:18,encode:QRe("SHA-256")});new TextEncoder;new TextDecoder;const XRe={...SRe,...$Re,...TRe,...CRe,...ORe,...yRe,...NRe,...aRe,...zRe,...GRe};function JRe(r,e){switch(at(r).code){case 4:case 41:return tTe(e);case 42:return VA(e);case 6:case 273:case 33:case 132:return vN(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return VA(e);case 421:return iTe(e);case 444:return jA(e);case 445:return jA(e);case 466:return sTe(e);default:return C(e,"base16")}}function ZRe(r,e){switch(at(r).code){case 4:return zA(e);case 41:return zA(e);case 42:return FA(e);case 6:case 273:case 33:case 132:return K5(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return FA(e);case 421:return rTe(e);case 444:return oTe(e);case 445:return aTe(e);case 466:return nTe(e);default:return L(e,"base16")}}const Yy=Object.values(XRe).map(r=>r.decoder),eTe=function(){let r=Yy[0].or(Yy[1]);return Yy.slice(2).forEach(e=>r=r.or(e)),r}();function zA(r){if(!tt(r))throw new Error("invalid ip address");return yN(r)}function tTe(r){const e=T$e(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function K5(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function vN(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function FA(r){const e=L(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function VA(r){const e=D.decode(r);if(r=r.slice(D.decode.bytes),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function rTe(r){let e;r[0]==="Q"||r[0]==="1"?e=bN(Ss.decode(`z${r}`)).bytes:e=q5.parse(r).multihash.bytes;const t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function nTe(r){const e=eTe.decode(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function sTe(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function iTe(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function oTe(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=Ia.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=K5(n);return M([t,s],t.length+s.length)}function aTe(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Ia.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=K5(n);return M([t,s],t.length+s.length)}function jA(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=vN(t);return`${n}:${s}`}function cTe(r){const e=[],t=r.split("/").slice(1);if(t.length===1&&t[0]==="")return[];for(let n=0;n<t.length;n++){const s=t[n],i=at(s);if(i.size===0){e.push([s]);continue}if(n++,n>=t.length)throw $N("invalid address: "+r);if(i.path===!0){e.push([s,H5(t.slice(n).join("/"))]);break}e.push([s,t[n]])}return e}function lTe(r){const e=[];return r.map(t=>{const n=sg(t);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),H5(e.join("/"))}function uTe(r){return r.map(e=>{Array.isArray(e)||(e=[e]);const t=sg(e);return e.length>1?[t.code,ZRe(t.code,e[1])]:[t.code]})}function _N(r){return r.map(e=>{const t=sg(e);return e[1]!=null?[t.code,JRe(t.code,e[1])]:[t.code]})}function SN(r){return o6(M(r.map(e=>{const t=sg(e);let n=Uint8Array.from(D.encode(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n})))}function AN(r,e){return r.size>0?r.size/8:r.size===0?0:D.decode(e)+(D.decode.bytes??0)}function G5(r){const e=[];let t=0;for(;t<r.length;){const n=D.decode(r,t),s=D.decode.bytes??0,i=at(n),o=AN(i,r.slice(t+s));if(o===0){e.push([n]),t+=s;continue}const a=r.slice(t+s,t+s+o);if(t+=o+s,t>r.length)throw $N("Invalid address Uint8Array: "+C(r,"base16"));e.push([n,a])}return e}function qA(r){const e=G5(r),t=_N(e);return lTe(t)}function dTe(r){r=H5(r);const e=cTe(r),t=uTe(e);return SN(t)}function hTe(r){return dTe(r)}function o6(r){const e=fTe(r);if(e!=null)throw e;return Uint8Array.from(r)}function fTe(r){try{G5(r)}catch(e){return e}}function H5(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function $N(r){return new Error("Error parsing address: "+r)}function sg(r){return at(r[0])}var Ec=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Xy=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},Nu,Lu,Mu,KA;const pTe=Symbol.for("nodejs.util.inspect.custom"),gTe=[at("dns").code,at("dns4").code,at("dns6").code,at("dnsaddr").code],RN=new Map,TN=Symbol.for("@multiformats/js-multiaddr/multiaddr");function yTe(r,e){if(r==null)throw new Error("requires node address object");if(e==null)throw new Error("requires transport protocol");let t,n=r.address;switch(r.family){case 4:t="ip4";break;case 6:if(t="ip6",n.includes("%")){const s=n.split("%");if(s.length!==2)throw Error("Multiple ip6 zones in multiaddr");n=s[0],t=`/ip6zone/${s[1]}/ip6`}break;default:throw Error("Invalid addr family, should be 4 or 6.")}return new IN("/"+[t,n,e,r.port].join("/"))}function Ca(r){return!!r?.[TN]}let IN=class Pc{constructor(e){if(Nu.set(this,void 0),Lu.set(this,void 0),Mu.set(this,void 0),this[KA]=!0,e==null&&(e=""),e instanceof Uint8Array)this.bytes=o6(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=hTe(e)}else if(Ca(e))this.bytes=o6(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr")}toString(){return Ec(this,Nu,"f")==null&&Xy(this,Nu,qA(this.bytes),"f"),Ec(this,Nu,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=at("tcp"),a=at("udp"),c=at("ip4"),u=at("ip6"),l=at("dns6"),d=at("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),gTe.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=at(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=at(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map(e=>Object.assign({},at(e)))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=D.decode(t,n),i=D.decode.bytes??0,o=at(s),a=AN(o,t.slice(n+i));n+=a+i,e.push(s)}return e}protoNames(){return this.protos().map(e=>e.name)}tuples(){return Ec(this,Lu,"f")==null&&Xy(this,Lu,G5(this.bytes),"f"),Ec(this,Lu,"f")}stringTuples(){return Ec(this,Mu,"f")==null&&Xy(this,Mu,_N(this.tuples()),"f"),Ec(this,Mu,"f")}encapsulate(e){return e=new Pc(e),new Pc(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Pc(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new Pc(SN(t.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter(n=>n[0]===d0.ipfs.code).pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C(Ss.decode(`z${n}`),"base58btc"):C(q5.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){let e=null;try{e=this.stringTuples().filter(t=>at(t[0]).path===!0)[0][1],e==null&&(e=null)}catch{e=null}return e}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=RN.get(t.name);if(n==null)throw $(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new Pc(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(Nu=new WeakMap,Lu=new WeakMap,Mu=new WeakMap,KA=TN,pTe)](){return`Multiaddr(${qA(this.bytes)})`}};function St(r){return new IN(r)}var Oe;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.DHT_DISABLED="DHT is not available",r.PUBSUB_DISABLED="PubSub is not available",r.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",r.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",r.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",r.NOT_FOUND="Not found"})(Oe||(Oe={}));var O;(function(r){r.DHT_DISABLED="ERR_DHT_DISABLED",r.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",r.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",r.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",r.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",r.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",r.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",r.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",r.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",r.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",r.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",r.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",r.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",r.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",r.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",r.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",r.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",r.ERR_DIALED_SELF="ERR_DIALED_SELF",r.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",r.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",r.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",r.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",r.ERR_INVALID_KEY="ERR_INVALID_KEY",r.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",r.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",r.ERR_INVALID_PEER="ERR_INVALID_PEER",r.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",r.ERR_NOT_FOUND="ERR_NOT_FOUND",r.ERR_TIMEOUT="ERR_TIMEOUT",r.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",r.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",r.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",r.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",r.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",r.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",r.ERR_FIND_SELF="ERR_FIND_SELF",r.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",r.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",r.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",r.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",r.ERR_INVALID_CMS="ERR_INVALID_CMS",r.ERR_MISSING_KEYS="ERR_MISSING_KEYS",r.ERR_NO_KEY="ERR_NO_KEY",r.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",r.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",r.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",r.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",r.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",r.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",r.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",r.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",r.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",r.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",r.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",r.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",r.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",r.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",r.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",r.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",r.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",r.ERR_INVALID_RECORD="ERR_INVALID_RECORD",r.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",r.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",r.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",r.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",r.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED"})(O||(O={}));async function*a6(r,e){yield*Xr(r,async t=>(await e.addressBook.add(t.id,t.multiaddrs),t))}function CN(r){const e=new Set;return dt(r,t=>e.has(t.id.toString())?!1:(e.add(t.id.toString()),!0))}async function*xN(r,e=1){let t=0;for await(const n of r)t++,yield n;if(t<e)throw $(new Error("not found"),"NOT_FOUND")}const Wc=new Map,wTe=()=>`${Date.now()}:${Math.floor(Math.random()*1e6)}`;async function bTe(r,e,t){for(;Wc.get(t);){try{await r()}catch(n){setTimeout(()=>{throw n},1);break}if(!Wc.get(t))break;await new Promise(n=>{const s=setTimeout(n,e);Wc.set(t,s)})}}function mTe(r,e,t){t=t||e;const n=wTe(),s=setTimeout(()=>{bTe(r,e,n)},t);return Wc.set(n,s),n}function ETe(r){const e=Wc.get(r);e&&(clearTimeout(e),Wc.delete(r))}var g0={setDelayedInterval:mTe,clearDelayedInterval:ETe};const GA=N("libp2p:peer-routing");class vTe{constructor(e,t){this.components=e,this.routers=t.routers??[],this.refreshManagerInit=t.refreshManager??{},this.started=!1,this._findClosestPeersTask=this._findClosestPeersTask.bind(this)}isStarted(){return this.started}async start(){this.started||this.routers.length===0||this.timeoutId!=null||this.refreshManagerInit.enabled===!1||(this.timeoutId=g0.setDelayedInterval(this._findClosestPeersTask,this.refreshManagerInit.interval,this.refreshManagerInit.bootDelay),this.started=!0)}async _findClosestPeersTask(){if(this.abortController==null)try{this.abortController=new ft.TimeoutController(this.refreshManagerInit.timeout??1e4);try{Qe.setMaxListeners?.(1/0,this.abortController.signal)}catch{}await Wt(this.getClosestPeers(this.components.peerId.toBytes(),{signal:this.abortController.signal}))}catch(e){GA.error(e)}finally{this.abortController?.clear(),this.abortController=void 0}}async stop(){g0.clearDelayedInterval(this.timeoutId),this.abortController?.abort(),this.started=!1}async findPeer(e,t){if(this.routers.length===0)throw $(new Error("No peer routers available"),O.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.components.peerId.toString())throw $(new Error("Should not try to find self"),O.ERR_FIND_SELF);const n=await Ae(nn(...this.routers.map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(i){GA.error(i)}}())),s=>dt(s,Boolean),s=>a6(s,this.components.peerStore),async s=>await xs(s));if(n!=null)return n;throw $(new Error(Oe.NOT_FOUND),O.ERR_NOT_FOUND)}async*getClosestPeers(e,t){if(this.routers.length===0)throw $(new Error("No peer routers available"),O.ERR_NO_ROUTERS_AVAILABLE);yield*Ae(nn(...this.routers.map(n=>n.getClosestPeers(e,t))),n=>a6(n,this.components.peerStore),n=>CN(n),n=>xN(n))}}class _Te{constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw $(new Error("No content this.routers available"),O.ERR_NO_ROUTERS_AVAILABLE);yield*Ae(nn(...this.routers.map(n=>n.findProviders(e,t))),n=>a6(n,this.components.peerStore),n=>CN(n),n=>xN(n))}async provide(e,t={}){if(this.routers.length===0)throw $(new Error("No content routers available"),O.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map(async n=>await n.provide(e,t)))}async put(e,t,n){if(!this.isStarted())throw $(new Error(Oe.NOT_STARTED_YET),O.DHT_NOT_STARTED);const s=this.components.dht;s!=null&&await Wt(s.put(e,t,n))}async get(e,t){if(!this.isStarted())throw $(new Error(Oe.NOT_STARTED_YET),O.DHT_NOT_STARTED);const n=this.components.dht;if(n!=null){for await(const s of n.get(e,t))if(s.name==="VALUE")return s.value}throw $(new Error(Oe.NOT_FOUND),O.ERR_NOT_FOUND)}async*getMany(e,t,n){if(!this.isStarted())throw $(new Error(Oe.NOT_STARTED_YET),O.DHT_NOT_STARTED);if(t==null||t===0)return;let s=0;const i=this.components.dht;if(i!=null){for await(const o of i.get(e,n))if(o.name==="VALUE"&&(yield{from:o.from,val:o.value},s++,s===t))break}if(s===0)throw $(new Error(Oe.NOT_FOUND),O.ERR_NOT_FOUND)}}const STe=r=>r;class ATe extends gt{constructor(e,t){super();const{listen:n=[],announce:s=[]}=t;this.components=e,this.listen=n.map(i=>i.toString()),this.announce=new Set(s.map(i=>i.toString())),this.observed=new Set,this.announceFilter=t.announceFilter??STe}getListenAddrs(){return Array.from(this.listen).map(e=>St(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>St(e))}getObservedAddrs(){return Array.from(this.observed).map(e=>St(e))}confirmObservedAddr(e){}removeObservedAddr(e){}addObservedAddr(e){let t=St(e);const n=t.getPeerId();n!=null&&de(n).equals(this.components.peerId)&&(t=t.decapsulate(St(`/p2p/${this.components.peerId.toString()}`)));const s=t.toString();this.observed.has(s)||(this.observed.add(s),this.dispatchEvent(new W("change:addresses")))}getAddresses(){let e=this.getAnnounceAddrs().map(n=>n.toString());e.length===0&&(e=this.components.transportManager.getAddrs().map(n=>n.toString())),e=e.concat(this.getObservedAddrs().map(n=>n.toString()));const t=new Set(e);return this.announceFilter(Array.from(t).map(n=>St(n))).map(n=>n.protos().pop()?.path===!0||n.getPeerId()===this.components.peerId.toString()?n:n.encapsulate(`/p2p/${this.components.peerId.toString()}`))}}const HA=N("libp2p:connection-manager:latency-monitor:visibility-change-emitter");class $Te extends gt{constructor(){super(),this.hidden="hidden",this.visibilityChange="visibilityChange",globalThis.document!=null&&(this._initializeVisibilityVarNames(),this._addVisibilityChangeListener())}_initializeVisibilityVarNames(){let e="hidden",t="visibilitychange";typeof globalThis.document.hidden<"u"?(e="hidden",t="visibilitychange"):typeof globalThis.document.mozHidden<"u"?(e="mozHidden",t="mozvisibilitychange"):typeof globalThis.document.msHidden<"u"?(e="msHidden",t="msvisibilitychange"):typeof globalThis.document.webkitHidden<"u"&&(e="webkitHidden",t="webkitvisibilitychange"),this.hidden=e,this.visibilityChange=t}_addVisibilityChangeListener(){typeof globalThis.document.addEventListener>"u"||typeof document[this.hidden]>"u"?HA("Checking page visibility requires a browser that supports the Page Visibility API."):globalThis.document.addEventListener(this.visibilityChange,this._handleVisibilityChange.bind(this),!1)}isVisible(){if(!(this.hidden===void 0||document[this.hidden]===void 0))return document[this.hidden]==null}_handleVisibilityChange(){const e=globalThis.document[this.hidden]===!1;HA(e?"Page Visible":"Page Hidden"),this.dispatchEvent(new W("visibilityChange",{detail:e}))}}const di=N("libp2p:connection-manager:latency-monitor");class RTe extends gt{constructor(e={}){super();const{latencyCheckIntervalMs:t,dataEmitIntervalMs:n,asyncTestFn:s,latencyRandomPercentage:i}=e;this.latencyCheckIntervalMs=t??500,this.latencyRandomPercentage=i??10,this.latencyCheckMultiply=2*(this.latencyRandomPercentage/100)*this.latencyCheckIntervalMs,this.latencyCheckSubtract=this.latencyCheckMultiply/2,this.dataEmitIntervalMs=n===null||n===0?void 0:n??5*1e3,di("latencyCheckIntervalMs: %s dataEmitIntervalMs: %s",this.latencyCheckIntervalMs,this.dataEmitIntervalMs),this.dataEmitIntervalMs!=null?di("Expecting ~%s events per summary",this.latencyCheckIntervalMs/this.dataEmitIntervalMs):di("Not emitting summaries"),this.asyncTestFn=s,globalThis.process?.hrtime!=null?(di("Using process.hrtime for timing"),this.now=globalThis.process.hrtime,this.getDeltaMS=o=>{const a=this.now(o);return a[0]*1e3+a[1]/1e6}):typeof window<"u"&&window.performance?.now!=null?(di("Using performance.now for timing"),this.now=window.performance.now.bind(window.performance),this.getDeltaMS=o=>Math.round(this.now()-o)):(di("Using Date.now for timing"),this.now=Date.now,this.getDeltaMS=o=>this.now()-o),this.latencyData=this.initLatencyData()}start(){TTe()&&(this.visibilityChangeEmitter=new $Te,this.visibilityChangeEmitter.addEventListener("visibilityChange",e=>{const{detail:t}=e;t?this._startTimers():(this._emitSummary(),this._stopTimers())})),this.visibilityChangeEmitter?.isVisible()===!0&&this._startTimers()}stop(){this._stopTimers()}_startTimers(){this.checkLatencyID==null&&(this.checkLatency(),this.dataEmitIntervalMs!=null&&(this.emitIntervalID=setInterval(()=>this._emitSummary(),this.dataEmitIntervalMs),typeof this.emitIntervalID.unref=="function"&&this.emitIntervalID.unref()))}_stopTimers(){this.checkLatencyID!=null&&(clearTimeout(this.checkLatencyID),this.checkLatencyID=void 0),this.emitIntervalID!=null&&(clearInterval(this.emitIntervalID),this.emitIntervalID=void 0)}_emitSummary(){const e=this.getSummary();e.events>0&&this.dispatchEvent(new W("data",{detail:e}))}getSummary(){const e={events:this.latencyData.events,minMs:this.latencyData.minMs,maxMs:this.latencyData.maxMs,avgMs:this.latencyData.events>0?this.latencyData.totalMs/this.latencyData.events:Number.POSITIVE_INFINITY,lengthMs:this.getDeltaMS(this.latencyData.startTime)};return this.latencyData=this.initLatencyData(),di.trace("Summary: %O",e),e}checkLatency(){const e=Math.random()*this.latencyCheckMultiply-this.latencyCheckSubtract,t={deltaOffset:Math.ceil(this.latencyCheckIntervalMs+e),startTime:this.now()},n=()=>{if(this.checkLatencyID==null)return;const s=this.getDeltaMS(t.startTime)-t.deltaOffset;this.checkLatency(),this.latencyData.events++,this.latencyData.minMs=Math.min(this.latencyData.minMs,s),this.latencyData.maxMs=Math.max(this.latencyData.maxMs,s),this.latencyData.totalMs+=s,di.trace("MS: %s Data: %O",s,this.latencyData)};di.trace("localData: %O",t),this.checkLatencyID=setTimeout(()=>{this.asyncTestFn!=null?(t.deltaOffset=0,t.startTime=this.now(),this.asyncTestFn(n)):(t.deltaOffset-=1,n())},t.deltaOffset),typeof this.checkLatencyID.unref=="function"&&this.checkLatencyID.unref()}initLatencyData(){return{startTime:this.now(),minMs:Number.POSITIVE_INFINITY,maxMs:Number.NEGATIVE_INFINITY,events:0,totalMs:0}}}function TTe(){return typeof globalThis.window<"u"}const DN="OPEN",WA="CLOSING",Jy="CLOSED";function y0(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),s=n.value;return n.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}class ITe{constructor(e){k(this,"map");if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){this.map.delete(e.toString())}entries(){return y0(this.map.entries(),e=>[de(e[0]),e[1]])}forEach(e){this.map.forEach((t,n)=>{e(t,de(n),this)})}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return y0(this.map.keys(),e=>de(e))}values(){return this.map.values()}get size(){return this.map.size}}class ko{constructor(e){k(this,"set");if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return y0(this.set.entries(),e=>{const t=de(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=de(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return y0(this.set.values(),e=>de(e))}intersection(e){const t=new ko;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new ko;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new ko;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}const CTe="keep-alive";function ON(r){if(xi(r))return{peerId:r};if(Ca(r)){const e=r.getPeerId();return{multiaddr:r,peerId:e==null?void 0:de(e)}}throw $(new Error(`${r} is not a PeerId or a Multiaddr`),O.ERR_INVALID_MULTIADDR)}const At=N("libp2p:connection-manager"),xTe={maxConnections:1/0,minConnections:0,maxEventLoopDelay:1/0,pollInterval:2e3,autoDialInterval:1e4,inboundConnectionThreshold:5,maxIncomingPendingConnections:10},DTe=6e4;class OTe extends gt{constructor(e,t){if(super(),this.opts=et.call({ignoreUndefined:!0},xTe,t),this.opts.maxConnections<this.opts.minConnections)throw $(new Error("Connection Manager maxConnections must be greater than minConnections"),O.ERR_INVALID_PARAMETERS);At("options: %o",this.opts),this.components=e,this.connections=new Map,this.started=!1,t.maxEventLoopDelay!=null&&t.maxEventLoopDelay>0&&t.maxEventLoopDelay!==1/0&&(this.latencyMonitor=new RTe({latencyCheckIntervalMs:t.pollInterval,dataEmitIntervalMs:t.pollInterval}));try{Qe.setMaxListeners?.(1/0,this)}catch{}this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.startupReconnectTimeout=t.startupReconnectTimeout??DTe,this.dialTimeout=t.dialTimeout??3e4,this.allow=(t.allow??[]).map(n=>St(n)),this.deny=(t.deny??[]).map(n=>St(n)),this.inboundConnectionRateLimiter=new nm.RateLimiterMemory({points:this.opts.inboundConnectionThreshold,duration:1}),this.incomingPendingConnections=0}isStarted(){return this.started}async start(){this.components.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,outbound:0};for(const t of this.connections.values())for(const n of t)n.stat.direction==="inbound"?e.inbound++:e.outbound++;return e}}),this.components.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const n of t)for(const s of n.streams){const i=`${s.stat.direction} ${s.stat.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.components.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const n of this.connections.values())for(const s of n){const i={};for(const o of s.streams){const a=`${o.stat.direction} ${o.stat.protocol??"unnegotiated"}`;i[a]=(i[a]??0)+1}for(const[o,a]of Object.entries(i))e[o]=e[o]??[],e[o].push(a)}const t={};for(let[n,s]of Object.entries(e)){s=s.sort((o,a)=>o-a);const i=Math.floor(s.length*.9);t[n]=s[i]}return t}}),this.latencyMonitor?.start(),this._onLatencyMeasure=this._onLatencyMeasure.bind(this),this.latencyMonitor?.addEventListener("data",this._onLatencyMeasure),this.started=!0,At("started")}async afterStart(){this.components.upgrader.addEventListener("connection",this.onConnect),this.components.upgrader.addEventListener("connectionEnd",this.onDisconnect),Promise.resolve().then(async()=>{const e=[];for(const t of await this.components.peerStore.all())(await this.components.peerStore.getTags(t.id)).filter(i=>i.name===CTe).length>0&&e.push(t.id);this.connectOnStartupController?.clear(),this.connectOnStartupController=new ft.TimeoutController(this.startupReconnectTimeout);try{Qe.setMaxListeners?.(1/0,this.connectOnStartupController.signal)}catch{}await Promise.all(e.map(async t=>{await this.openConnection(t,{signal:this.connectOnStartupController?.signal}).catch(n=>{At.error(n)})}))}).catch(e=>{At.error(e)}).finally(()=>{this.connectOnStartupController?.clear()})}async beforeStop(){this.connectOnStartupController?.abort(),this.components.upgrader.removeEventListener("connection",this.onConnect),this.components.upgrader.removeEventListener("connectionEnd",this.onDisconnect)}async stop(){this.latencyMonitor?.removeEventListener("data",this._onLatencyMeasure),this.latencyMonitor?.stop(),this.started=!1,await this._close(),At("stopped")}async _close(){const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(s){At.error(s)}})());At("closing %d connections",e.length),await Promise.all(e),this.connections.clear()}onConnect(e){this._onConnect(e).catch(t=>{At.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}const n=t.remotePeer,s=n.toString(),i=this.connections.get(s);i!=null?i.push(t):this.connections.set(s,[t]),n.publicKey!=null&&await this.components.peerStore.keyBook.set(n,n.publicKey);const o=this.getConnections().length,a=o-this.opts.maxConnections;await this._checkMaxLimit("maxConnections",o,a),this.dispatchEvent(new W("peer:connect",{detail:t}))}onDisconnect(e){const{detail:t}=e;if(!this.started)return;const n=t.remotePeer.toString();let s=this.connections.get(n);s!=null&&s.length>1?(s=s.filter(i=>i.id!==t.id),this.connections.set(n,s)):s!=null&&(this.connections.delete(n),this.dispatchEvent(new W("peer:disconnect",{detail:t})))}getConnections(e){if(e!=null)return this.connections.get(e.toString())??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}async openConnection(e,t={}){const{peerId:n,multiaddr:s}=ON(e);if(n==null&&s==null)throw $(new TypeError("Can only open connections to PeerIds or Multiaddrs"),O.ERR_INVALID_PARAMETERS);if(n!=null){At("dial to",n);const o=this.getConnections(n);if(o.length>0)return At("had an existing connection to %p",n),o[0]}let i;if(t?.signal==null){i=new ft.TimeoutController(this.dialTimeout),t.signal=i.signal;try{Qe.setMaxListeners?.(1/0,i.signal)}catch{}}try{const o=await this.components.dialer.dial(e,t);let a=this.connections.get(o.remotePeer.toString());a==null&&(a=[],this.connections.set(o.remotePeer.toString(),a));let c=!1;for(const u of a)u.id===o.id&&(c=!0);return c||a.push(o),o}finally{i?.clear()}}async closeConnections(e){const t=this.connections.get(e.toString())??[];await Promise.all(t.map(async n=>await n.close()))}getAll(e){if(!xi(e))throw $(new Error("peerId must be an instance of peer-id"),O.ERR_INVALID_PARAMETERS);const t=e.toString(),n=this.connections.get(t);return n!=null?n.filter(s=>s.stat.status===DN):[]}_onLatencyMeasure(e){const{detail:t}=e;this._checkMaxLimit("maxEventLoopDelay",t.avgMs,1).catch(n=>{At.error(n)})}async _checkMaxLimit(e,t,n=1){const s=this.opts[e];if(s==null){At.trace("limit %s was not set so it cannot be applied",e);return}At.trace("checking limit of %s. current value: %d of %d",e,t,s),t>s&&(At("%s: limit exceeded: %p, %d/%d, pruning %d connection(s)",this.components.peerId,e,t,s,n),await this._pruneConnections(n))}async _pruneConnections(e){const t=this.getConnections(),n=new ITe;for(const o of t){const a=o.remotePeer;if(n.has(a))continue;const c=await this.components.peerStore.getTags(a);n.set(a,c.reduce((u,l)=>u+l.value,0))}const s=t.sort((o,a)=>{const c=n.get(o.remotePeer)??0,u=n.get(a.remotePeer)??0;if(c>u)return 1;if(c<u)return-1;const l=o.stat.timeline.open,d=a.stat.timeline.open;return l<d?1:l>d?-1:0}),i=[];for(const o of s)if(At("too many connections open - closing a connection to %p",o.remotePeer),i.push(o),i.length===e)break;await Promise.all(i.map(async o=>{try{await o.close()}catch(a){At.error(a)}this.onDisconnect(new W("connectionEnd",{detail:o}))}))}async acceptIncomingConnection(e){if(this.deny.some(s=>e.remoteAddr.toString().startsWith(s.toString())))return At("connection from %s refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>e.remoteAddr.toString().startsWith(s.toString())))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.opts.maxIncomingPendingConnections)return At("connection from %s refused - incomingPendingConnections exceeded by peer %s",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const s=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return At("connection from %s refused - inboundConnectionThreshold exceeded by host %s",s,e.remoteAddr),!1}}return this.getConnections().length<this.opts.maxConnections?(this.incomingPendingConnections++,!0):(At("connection from %s refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}}const Yi=N("libp2p:connection-manager:auto-dialler"),PTe={enabled:!0,minConnections:0,autoDialInterval:1e4};class kTe{constructor(e,t){this.components=e,this.options=et.call({ignoreUndefined:!0},PTe,t),this.running=!1,this._autoDial=this._autoDial.bind(this),Yi("options: %j",this.options)}isStarted(){return this.running}async start(){if(!this.options.enabled){Yi("not enabled");return}this.running=!0,this._autoDial().catch(e=>{Yi.error("could start autodial",e)}),Yi("started")}async stop(){if(!this.options.enabled){Yi("not enabled");return}this.running=!1,this.autoDialTimeout!=null&&this.autoDialTimeout.clear(),Yi("stopped")}async _autoDial(){this.autoDialTimeout!=null&&this.autoDialTimeout.clear();const e=this.options.minConnections;if(this.components.connectionManager.getConnections().length>=e){this.autoDialTimeout=z7(this._autoDial,this.options.autoDialInterval);return}const t=await this.components.peerStore.all(),n=await Ae(t.sort(()=>Math.random()>.5?1:-1),s=>dt(s,i=>!i.id.equals(this.components.peerId)),s=>k1(s,(i,o)=>o.protocols.length>i.protocols.length||o.id.publicKey!=null&&i.id.publicKey==null?1:-1),async s=>await jo(s));for(let s=0;this.running&&s<n.length&&this.components.connectionManager.getConnections().length<e;s++){if(!this.running)return;const i=n[s];if(this.components.connectionManager.getConnections(i.id).length===0){Yi("connecting to a peerStore stored peer %p",i.id);try{await this.components.connectionManager.openConnection(i.id)}catch(o){Yi.error("could not connect to peerStore stored peer",o)}}}this.running&&(this.autoDialTimeout=z7(this._autoDial,this.options.autoDialInterval))}}function NTe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var LTe=NTe,MTe=LTe;const UTe=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},W5=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},BTe=r=>new TextEncoder().encode(r),zTe=r=>new TextDecoder().decode(r);let FTe=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},VTe=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return PN(this,e)}},jTe=class{constructor(e){this.decoders=e}or(e){return PN(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const PN=(r,e)=>new jTe({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let qTe=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new FTe(e,t,n),this.decoder=new VTe(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const ig=({name:r,prefix:e,encode:t,decode:n})=>new qTe(r,e,t,n),Qh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=MTe(t,e);return ig({prefix:r,name:e,encode:n,decode:i=>W5(s(i))})},KTe=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},GTe=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},cr=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>ig({prefix:e,name:r,encode(s){return GTe(s,n,t)},decode(s){return KTe(s,n,t,r)}}),As=Qh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),HTe=Qh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),WTe=Object.freeze(Object.defineProperty({__proto__:null,base58btc:As,base58flickr:HTe},Symbol.toStringTag,{value:"Module"}));var QTe=kN,QA=128,YTe=127,XTe=~YTe,JTe=Math.pow(2,31);function kN(r,e,t){e=e||[],t=t||0;for(var n=t;r>=JTe;)e[t++]=r&255|QA,r/=128;for(;r&XTe;)e[t++]=r&255|QA,r>>>=7;return e[t]=r|0,kN.bytes=t-n+1,e}var ZTe=c6,eIe=128,YA=127;function c6(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw c6.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&YA)<<s:(o&YA)*Math.pow(2,s),s+=7}while(o>=eIe);return c6.bytes=i-n,t}var tIe=Math.pow(2,7),rIe=Math.pow(2,14),nIe=Math.pow(2,21),sIe=Math.pow(2,28),iIe=Math.pow(2,35),oIe=Math.pow(2,42),aIe=Math.pow(2,49),cIe=Math.pow(2,56),lIe=Math.pow(2,63),uIe=function(r){return r<tIe?1:r<rIe?2:r<nIe?3:r<sIe?4:r<iIe?5:r<oIe?6:r<aIe?7:r<cIe?8:r<lIe?9:10},dIe={encode:QTe,decode:ZTe,encodingLength:uIe},w0=dIe;const l6=(r,e=0)=>[w0.decode(r,e),w0.decode.bytes],b0=(r,e,t=0)=>(w0.encode(r,e,t),e),m0=r=>w0.encodingLength(r),hIe=(r,e)=>{const t=e.byteLength,n=m0(r),s=n+m0(t),i=new Uint8Array(s+t);return b0(r,i,0),b0(t,i,n),i.set(e,s),new Q5(r,t,e,i)},NN=r=>{const e=W5(r),[t,n]=l6(e),[s,i]=l6(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new Q5(t,s,o,e)},fIe=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&UTe(r.bytes,t.bytes)}};let Q5=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const xa=cr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),pIe=cr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),gIe=cr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),yIe=cr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),wIe=cr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),bIe=cr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),mIe=cr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),EIe=cr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),vIe=cr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),_Ie=Object.freeze(Object.defineProperty({__proto__:null,base32:xa,base32hex:wIe,base32hexpad:mIe,base32hexpadupper:EIe,base32hexupper:bIe,base32pad:gIe,base32padupper:yIe,base32upper:pIe,base32z:vIe},Symbol.toStringTag,{value:"Module"})),XA=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return AIe(t,u6(r),e||As.encoder);default:return $Ie(t,u6(r),e||xa.encoder)}},JA=new WeakMap,u6=r=>{const e=JA.get(r);if(e==null){const t=new Map;return JA.set(r,t),t}return e};let LN=class Dr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Uu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==RIe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Dr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=hIe(e,t);return Dr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Dr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&fIe(e.multihash,n.multihash)}toString(e){return XA(this,e)}toJSON(){return{"/":XA(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Dr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Dr(n,s,i,o||ZA(n,s,i.bytes))}else if(t[TIe]===!0){const{version:n,multihash:s,code:i}=t,o=NN(s);return Dr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Uu)throw new Error(`Version 0 CID must use dag-pb (code: ${Uu}) block encoding`);return new Dr(e,t,n,n.bytes)}case 1:{const s=ZA(e,t,n.bytes);return new Dr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Dr.create(0,Uu,e)}static createV1(e,t){return Dr.create(1,e,t)}static decode(e){const[t,n]=Dr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Dr.inspectBytes(e),n=t.size-t.multihashSize,s=W5(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new Q5(t.multihashCode,t.digestSize,i,s);return[t.version===0?Dr.createV0(o):Dr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=l6(e.subarray(t));return t+=f,d};let s=n(),i=Uu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=SIe(e,t),i=Dr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return u6(i).set(n,e),i}};const SIe=(r,e)=>{switch(r[0]){case"Q":{const t=e||As;return[As.prefix,t.decode(`${As.prefix}${r}`)]}case As.prefix:{const t=e||As;return[As.prefix,t.decode(r)]}case xa.prefix:{const t=e||xa;return[xa.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},AIe=(r,e,t)=>{const{prefix:n}=t;if(n!==As.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},$Ie=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Uu=112,RIe=18,ZA=(r,e,t)=>{const n=m0(r),s=n+m0(e),i=new Uint8Array(s+t.byteLength);return b0(r,i,0),b0(e,i,n),i.set(t,s),i},TIe=Symbol.for("@ipld/js-cid/CID"),IIe=Math.pow(2,7),CIe=Math.pow(2,14),xIe=Math.pow(2,21),Y5=Math.pow(2,28),X5=Math.pow(2,35),J5=Math.pow(2,42),Z5=Math.pow(2,49),Be=128,Br=127;function Ho(r){if(r<IIe)return 1;if(r<CIe)return 2;if(r<xIe)return 3;if(r<Y5)return 4;if(r<X5)return 5;if(r<J5)return 6;if(r<Z5)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function DIe(r,e,t=0){switch(Ho(r)){case 8:e[t++]=r&255|Be,r/=128;case 7:e[t++]=r&255|Be,r/=128;case 6:e[t++]=r&255|Be,r/=128;case 5:e[t++]=r&255|Be,r/=128;case 4:e[t++]=r&255|Be,r>>>=7;case 3:e[t++]=r&255|Be,r>>>=7;case 2:e[t++]=r&255|Be,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function OIe(r,e,t=0){switch(Ho(r)){case 8:e.set(t++,r&255|Be),r/=128;case 7:e.set(t++,r&255|Be),r/=128;case 6:e.set(t++,r&255|Be),r/=128;case 5:e.set(t++,r&255|Be),r/=128;case 4:e.set(t++,r&255|Be),r>>>=7;case 3:e.set(t++,r&255|Be),r>>>=7;case 2:e.set(t++,r&255|Be),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function PIe(r,e){let t=r[e],n=0;if(n+=t&Br,t<Be||(t=r[e+1],n+=(t&Br)<<7,t<Be)||(t=r[e+2],n+=(t&Br)<<14,t<Be)||(t=r[e+3],n+=(t&Br)<<21,t<Be)||(t=r[e+4],n+=(t&Br)*Y5,t<Be)||(t=r[e+5],n+=(t&Br)*X5,t<Be)||(t=r[e+6],n+=(t&Br)*J5,t<Be)||(t=r[e+7],n+=(t&Br)*Z5,t<Be))return n;throw new RangeError("Could not decode varint")}function kIe(r,e){let t=r.get(e),n=0;if(n+=t&Br,t<Be||(t=r.get(e+1),n+=(t&Br)<<7,t<Be)||(t=r.get(e+2),n+=(t&Br)<<14,t<Be)||(t=r.get(e+3),n+=(t&Br)<<21,t<Be)||(t=r.get(e+4),n+=(t&Br)*Y5,t<Be)||(t=r.get(e+5),n+=(t&Br)*X5,t<Be)||(t=r.get(e+6),n+=(t&Br)*J5,t<Be)||(t=r.get(e+7),n+=(t&Br)*Z5,t<Be))return n;throw new RangeError("Could not decode varint")}function og(r,e,t=0){return e==null&&(e=Ys(Ho(r))),e instanceof Uint8Array?DIe(r,e,t):OIe(r,e,t)}function Yh(r,e=0){return r instanceof Uint8Array?PIe(r,e):kIe(r,e)}const NIe=ig({prefix:"\0",name:"identity",encode:r=>zTe(r),decode:r=>BTe(r)}),LIe=Object.freeze(Object.defineProperty({__proto__:null,identity:NIe},Symbol.toStringTag,{value:"Module"})),MIe=cr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),UIe=Object.freeze(Object.defineProperty({__proto__:null,base2:MIe},Symbol.toStringTag,{value:"Module"})),BIe=cr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),zIe=Object.freeze(Object.defineProperty({__proto__:null,base8:BIe},Symbol.toStringTag,{value:"Module"})),FIe=Qh({prefix:"9",name:"base10",alphabet:"0123456789"}),VIe=Object.freeze(Object.defineProperty({__proto__:null,base10:FIe},Symbol.toStringTag,{value:"Module"})),jIe=cr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),qIe=cr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),KIe=Object.freeze(Object.defineProperty({__proto__:null,base16:jIe,base16upper:qIe},Symbol.toStringTag,{value:"Module"})),GIe=Qh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),HIe=Qh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),WIe=Object.freeze(Object.defineProperty({__proto__:null,base36:GIe,base36upper:HIe},Symbol.toStringTag,{value:"Module"})),QIe=cr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),YIe=cr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),XIe=cr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),JIe=cr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),ZIe=Object.freeze(Object.defineProperty({__proto__:null,base64:QIe,base64pad:YIe,base64url:XIe,base64urlpad:JIe},Symbol.toStringTag,{value:"Module"})),MN=Array.from(""),eCe=MN.reduce((r,e,t)=>(r[t]=e,r),[]),tCe=MN.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function rCe(r){return r.reduce((e,t)=>(e+=eCe[t],e),"")}function nCe(r){const e=[];for(const t of r){const n=tCe[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const sCe=ig({prefix:"",name:"base256emoji",encode:rCe,decode:nCe}),iCe=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:sCe},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const oCe={...LIe,...UIe,...zIe,...VIe,...KIe,..._Ie,...WIe,...WTe,...ZIe,...iCe},e$=es,aCe=ts,UN=function(r){let e=0;if(r=r.toString().trim(),e$(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(aCe(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=e$(t[n]);let o;i&&(o=UN(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},cCe=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Nn=-1,Qd={},d6={},lCe=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Nn,"ip6zone"],[43,8,"ipcidr"],[53,Nn,"dns",!0],[54,Nn,"dns4",!0],[55,Nn,"dns6",!0],[56,Nn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Nn,"unix",!1,!0],[421,Nn,"ipfs"],[421,Nn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Nn,"garlic64"],[448,0,"tls"],[449,Nn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Nn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Nn,"memory"]];lCe.forEach(r=>{const e=uCe(...r);d6[e.code]=e,Qd[e.name]=e});function uCe(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function ut(r){if(typeof r=="number"){if(d6[r]!=null)return d6[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(Qd[r]!=null)return Qd[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}ut("ip4");ut("ip6");ut("ipcidr");function BN(r,e){switch(ut(r).code){case 4:case 41:return hCe(e);case 42:return s$(e);case 6:case 273:case 33:case 132:return zN(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return s$(e);case 421:return yCe(e);case 444:return i$(e);case 445:return i$(e);case 466:return gCe(e);default:return C(e,"base16")}}function t$(r,e){switch(ut(r).code){case 4:return r$(e);case 41:return r$(e);case 42:return n$(e);case 6:case 273:case 33:case 132:return e8(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return n$(e);case 421:return fCe(e);case 444:return wCe(e);case 445:return bCe(e);case 466:return pCe(e);default:return L(e,"base16")}}const Zy=Object.values(oCe).map(r=>r.decoder),dCe=function(){let r=Zy[0].or(Zy[1]);return Zy.slice(2).forEach(e=>r=r.or(e)),r}();function r$(r){if(!tt(r))throw new Error("invalid ip address");return UN(r)}function hCe(r){const e=cCe(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function e8(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function zN(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function n$(r){const e=L(r),t=Uint8Array.from(og(e.length));return M([t,e],t.length+e.length)}function s$(r){const e=Yh(r);if(r=r.slice(Ho(e)),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function fCe(r){let e;r[0]==="Q"||r[0]==="1"?e=NN(As.decode(`z${r}`)).bytes:e=LN.parse(r).multihash.bytes;const t=Uint8Array.from(og(e.length));return M([t,e],t.length+e.length)}function pCe(r){const e=dCe.decode(r),t=Uint8Array.from(og(e.length));return M([t,e],t.length+e.length)}function gCe(r){const e=Yh(r),t=r.slice(Ho(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function yCe(r){const e=Yh(r),t=r.slice(Ho(e));if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function wCe(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=xa.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=e8(n);return M([t,s],t.length+s.length)}function bCe(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=xa.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=e8(n);return M([t,s],t.length+s.length)}function i$(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=zN(t);return`${n}:${s}`}function mCe(r){r=h6(r);const e=[],t=[];let n=null;const s=r.split("/").slice(1);if(s.length===1&&s[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let i=0;i<s.length;i++){const o=s[i],a=ut(o);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(i++,i>=s.length)throw jN("invalid address: "+r);if(a.path===!0){n=h6(s.slice(i).join("/")),e.push([a.code,t$(a.code,n)]),t.push([a.code,n]);break}const c=t$(a.code,s[i]);e.push([a.code,c]),t.push([a.code,BN(a.code,c)])}return{string:FN(t),bytes:VN(e),tuples:e,stringTuples:t,path:n}}function o$(r){const e=[],t=[];let n=null,s=0;for(;s<r.length;){const i=Yh(r,s),o=Ho(i),a=ut(i),c=ECe(a,r.slice(s+o));if(c===0){e.push([i]),t.push([i]),s+=o;continue}const u=r.slice(s+o,s+o+c);if(s+=c+o,s>r.length)throw jN("Invalid address Uint8Array: "+C(r,"base16"));e.push([i,u]);const l=BN(i,u);if(t.push([i,l]),a.path===!0){n=l;break}}return{bytes:Uint8Array.from(r),string:FN(t),tuples:e,stringTuples:t,path:n}}function FN(r){const e=[];return r.map(t=>{const n=ut(t[0]);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),h6(e.join("/"))}function VN(r){return M(r.map(e=>{const t=ut(e[0]);let n=Uint8Array.from(og(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n}))}function ECe(r,e){if(r.size>0)return r.size/8;if(r.size===0)return 0;{const t=Yh(e instanceof Uint8Array?e:Uint8Array.from(e));return t+Ho(t)}}function h6(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function jN(r){return new Error("Error parsing address: "+r)}const vCe=Symbol.for("nodejs.util.inspect.custom"),_Ce=[ut("dns").code,ut("dns4").code,ut("dns6").code,ut("dnsaddr").code],SCe=new Map,qN=Symbol.for("@multiformats/js-multiaddr/multiaddr");function ACe(r){return!!r?.[qN]}var Zc,bo,oh,ah,yVe,Ti;let $Ce=(Ti=class{constructor(e){k(this,"bytes");vt(this,Zc,void 0);vt(this,bo,void 0);vt(this,oh,void 0);vt(this,ah,void 0);k(this,yVe,!0);e==null&&(e="");let t;if(e instanceof Uint8Array)t=o$(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=mCe(e)}else if(ACe(e))t=o$(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,Xe(this,Zc,t.string),Xe(this,bo,t.tuples),Xe(this,oh,t.stringTuples),Xe(this,ah,t.path)}toString(){return ce(this,Zc)}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=ut("tcp"),a=ut("udp"),c=ut("ip4"),u=ut("ip6"),l=ut("dns6"),d=ut("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),_Ce.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=ut(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=ut(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return ce(this,bo).map(([e])=>Object.assign({},ut(e)))}protoCodes(){return ce(this,bo).map(([e])=>e)}protoNames(){return ce(this,bo).map(([e])=>ut(e).name)}tuples(){return ce(this,bo)}stringTuples(){return ce(this,oh)}encapsulate(e){return e=new Ti(e),new Ti(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Ti(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new Ti(VN(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([n,s])=>{n===Qd.p2p.code&&e.push([n,s]),n===Qd["p2p-circuit"].code&&(e=[])});const t=e.pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C(As.decode(`z${n}`),"base58btc"):C(LN.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return ce(this,ah)}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=SCe.get(t.name);if(n==null)throw new l2(`no available resolver for ${t.name}`,"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new Ti(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(yVe=qN,vCe)](){return`Multiaddr(${ce(this,Zc)})`}},Zc=new WeakMap,bo=new WeakMap,oh=new WeakMap,ah=new WeakMap,Ti);function KN(r){return new $Ce(r)}const RCe=ae("dns4"),TCe=ae("dns6"),ICe=ae("dnsaddr"),ja=cn(ae("dns"),ICe,RCe,TCe),ag=cn(ae("ip4"),ae("ip6")),hl=cn(Se(ag,ae("tcp")),Se(ja,ae("tcp"))),t8=Se(ag,ae("udp")),CCe=Se(t8,ae("utp")),xCe=Se(t8,ae("quic")),f6=cn(Se(hl,ae("ws")),Se(ja,ae("ws"))),p6=cn(Se(hl,ae("wss")),Se(ja,ae("wss")),Se(hl,ae("tls"),ae("ws")),Se(ja,ae("tls"),ae("ws"))),g6=cn(Se(hl,ae("http")),Se(ag,ae("http")),Se(ja,ae("http"))),y6=cn(Se(hl,ae("https")),Se(ag,ae("https")),Se(ja,ae("https"))),a$=Se(t8,ae("webrtc"),ae("certhash")),GN=cn(Se(a$,ae("p2p")),a$),HN=cn(Se(f6,ae("p2p-webrtc-star"),ae("p2p")),Se(p6,ae("p2p-webrtc-star"),ae("p2p")),Se(f6,ae("p2p-webrtc-star")),Se(p6,ae("p2p-webrtc-star"))),WN=cn(Se(g6,ae("p2p-webrtc-direct"),ae("p2p")),Se(y6,ae("p2p-webrtc-direct"),ae("p2p")),Se(g6,ae("p2p-webrtc-direct")),Se(y6,ae("p2p-webrtc-direct"))),w6=cn(f6,p6,g6,y6,HN,WN,hl,CCe,xCe,ja,GN),jf=cn(Se(w6,ae("p2p")),HN,WN,GN,ae("p2p")),c$=cn(Se(jf,ae("p2p-circuit"),jf),Se(jf,ae("p2p-circuit")),Se(ae("p2p-circuit"),jf),Se(w6,ae("p2p-circuit")),Se(ae("p2p-circuit"),w6),ae("p2p-circuit")),QN=()=>cn(Se(c$,QN),c$),DCe=QN();function YN(r){function e(t){let n;try{n=KN(t)}catch{return!1}const s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function Se(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:YN(e),partialMatch:e}}function cn(...r){function e(n){let s=null;return r.some(i=>{const o=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:YN(e),partialMatch:e}}function ae(r){const e=r;function t(s){let i;try{i=KN(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}function OCe(){ET._configure(),Y0._configure(vT),X0._configure(_T)}OCe();const XN=["uint64","int64","sint64","fixed64","sfixed64"];function PCe(r){for(const e of XN){if(r[e]==null)continue;const t=r[e];r[e]=function(){return BigInt(t.call(this).toString())}}return r}function kCe(r){return PCe(new Y0(r))}function NCe(r){for(const e of XN){if(r[e]==null)continue;const t=r[e];r[e]=function(n){return t.call(this,n.toString())}}return r}function LCe(){return NCe(X0.create())}function Yd(r,e){const t=kCe(r instanceof Uint8Array?r:r.subarray());return e.decode(t)}function Xd(r,e){const t=LCe();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var E0;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(E0||(E0={}));function JN(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function b6(r){function e(s){if(r[s.toString()]==null)throw new Error("Invalid enum value");return r[s]}const t=function(i,o){const a=e(i);o.int32(a)},n=function(i){const o=i.int32();return e(o)};return JN("enum",E0.VARINT,t,n)}function Jd(r,e){return JN("message",E0.LENGTH_DELIMITED,r,e)}var ge;(function(r){(function(s){s.SUCCESS="SUCCESS",s.HOP_SRC_ADDR_TOO_LONG="HOP_SRC_ADDR_TOO_LONG",s.HOP_DST_ADDR_TOO_LONG="HOP_DST_ADDR_TOO_LONG",s.HOP_SRC_MULTIADDR_INVALID="HOP_SRC_MULTIADDR_INVALID",s.HOP_DST_MULTIADDR_INVALID="HOP_DST_MULTIADDR_INVALID",s.HOP_NO_CONN_TO_DST="HOP_NO_CONN_TO_DST",s.HOP_CANT_DIAL_DST="HOP_CANT_DIAL_DST",s.HOP_CANT_OPEN_DST_STREAM="HOP_CANT_OPEN_DST_STREAM",s.HOP_CANT_SPEAK_RELAY="HOP_CANT_SPEAK_RELAY",s.HOP_CANT_RELAY_TO_SELF="HOP_CANT_RELAY_TO_SELF",s.STOP_SRC_ADDR_TOO_LONG="STOP_SRC_ADDR_TOO_LONG",s.STOP_DST_ADDR_TOO_LONG="STOP_DST_ADDR_TOO_LONG",s.STOP_SRC_MULTIADDR_INVALID="STOP_SRC_MULTIADDR_INVALID",s.STOP_DST_MULTIADDR_INVALID="STOP_DST_MULTIADDR_INVALID",s.STOP_RELAY_REFUSED="STOP_RELAY_REFUSED",s.MALFORMED_MESSAGE="MALFORMED_MESSAGE"})(r.Status||(r.Status={}));let e;(function(s){s[s.SUCCESS=100]="SUCCESS",s[s.HOP_SRC_ADDR_TOO_LONG=220]="HOP_SRC_ADDR_TOO_LONG",s[s.HOP_DST_ADDR_TOO_LONG=221]="HOP_DST_ADDR_TOO_LONG",s[s.HOP_SRC_MULTIADDR_INVALID=250]="HOP_SRC_MULTIADDR_INVALID",s[s.HOP_DST_MULTIADDR_INVALID=251]="HOP_DST_MULTIADDR_INVALID",s[s.HOP_NO_CONN_TO_DST=260]="HOP_NO_CONN_TO_DST",s[s.HOP_CANT_DIAL_DST=261]="HOP_CANT_DIAL_DST",s[s.HOP_CANT_OPEN_DST_STREAM=262]="HOP_CANT_OPEN_DST_STREAM",s[s.HOP_CANT_SPEAK_RELAY=270]="HOP_CANT_SPEAK_RELAY",s[s.HOP_CANT_RELAY_TO_SELF=280]="HOP_CANT_RELAY_TO_SELF",s[s.STOP_SRC_ADDR_TOO_LONG=320]="STOP_SRC_ADDR_TOO_LONG",s[s.STOP_DST_ADDR_TOO_LONG=321]="STOP_DST_ADDR_TOO_LONG",s[s.STOP_SRC_MULTIADDR_INVALID=350]="STOP_SRC_MULTIADDR_INVALID",s[s.STOP_DST_MULTIADDR_INVALID=351]="STOP_DST_MULTIADDR_INVALID",s[s.STOP_RELAY_REFUSED=390]="STOP_RELAY_REFUSED",s[s.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE"})(e||(e={})),function(s){s.codec=()=>b6(e)}(r.Status||(r.Status={})),function(s){s.HOP="HOP",s.STOP="STOP",s.STATUS="STATUS",s.CAN_HOP="CAN_HOP"}(r.Type||(r.Type={}));let t;(function(s){s[s.HOP=1]="HOP",s[s.STOP=2]="STOP",s[s.STATUS=3]="STATUS",s[s.CAN_HOP=4]="CAN_HOP"})(t||(t={})),function(s){s.codec=()=>b6(t)}(r.Type||(r.Type={})),function(s){let i;s.codec=()=>(i==null&&(i=Jd((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),(c.writeDefaults===!0||o.id!=null&&o.id.byteLength>0)&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const u of o.addrs)a.uint32(18),a.bytes(u);c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const c={id:new Uint8Array(0),addrs:[]},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const l=o.uint32();switch(l>>>3){case 1:c.id=o.bytes();break;case 2:c.addrs.push(o.bytes());break;default:o.skipType(l&7);break}}return c})),i),s.encode=o=>Xd(o,s.codec()),s.decode=o=>Yd(o,s.codec())}(r.Peer||(r.Peer={}));let n;r.codec=()=>(n==null&&(n=Jd((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.Type.codec().encode(s.type,i)),s.srcPeer!=null&&(i.uint32(18),r.Peer.codec().encode(s.srcPeer,i,{writeDefaults:!1})),s.dstPeer!=null&&(i.uint32(26),r.Peer.codec().encode(s.dstPeer,i,{writeDefaults:!1})),s.code!=null&&(i.uint32(32),r.Status.codec().encode(s.code,i)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.type=r.Type.codec().decode(s);break;case 2:o.srcPeer=r.Peer.codec().decode(s,s.uint32());break;case 3:o.dstPeer=r.Peer.codec().decode(s,s.uint32());break;case 4:o.code=r.Status.codec().decode(s);break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>Xd(s,r.codec()),r.decode=s=>Yd(s,r.codec())})(ge||(ge={}));const MCe=N("libp2p:stream:converter");function l$(r,e={}){const{stream:t,remoteAddr:n}=r,{sink:s,source:i}=t,o=async function*(){for await(const u of i)u instanceof Uint8Array?yield u:yield*u}(),a={async sink(u){e.signal!=null&&(u=Td(u,e.signal));try{await s(u),await c()}catch(l){l.type!=="aborted"&&MCe(l)}},source:e.signal!=null?Td(o,e.signal):o,remoteAddr:n,timeline:{open:Date.now(),close:void 0},async close(){await s(async function*(){yield new Uint8Array(0)}()),await c()}};async function c(){a.timeline.close==null&&(a.timeline.close=Date.now()),await Promise.resolve()}return a}const fl="/libp2p/circuit/relay/0.1.0";function UCe(r){const e=new Map;async function t(i){const o=i.toString().split("/p2p-circuit").find(f=>f!==""),a=St(o),c=a.getPeerId();if(c==null)throw new Error("Could not determine relay peer from multiaddr");const u=de(c);await r.peerStore.addressBook.add(u,[a]);const l=await r.connectionManager.openConnection(u),d=l.remoteAddr.encapsulate("/p2p-circuit");e.set(l.remotePeer.toString(),d),s.dispatchEvent(new W("listening"))}function n(){const i=[];for(const o of e.values())i.push(o);return i}const s=Object.assign(new gt,{close:async()=>await Promise.resolve(),listen:t,getAddrs:n});return r.connectionManager.addEventListener("peer:disconnect",i=>{const{detail:o}=i;e.delete(o.remotePeer.toString())&&s.dispatchEvent(new W("close"))}),s}function u$(r,e){r.write({type:ge.Type.STATUS,code:e})}function ZN(r,e){try{r.dstPeer?.addrs!=null&&r.dstPeer.addrs.forEach(t=>St(t))}catch(t){throw u$(e,r.type===ge.Type.HOP?ge.Status.HOP_DST_MULTIADDR_INVALID:ge.Status.STOP_DST_MULTIADDR_INVALID),t}try{r.srcPeer?.addrs!=null&&r.srcPeer.addrs.forEach(t=>St(t))}catch(t){throw u$(e,r.type===ge.Type.HOP?ge.Status.HOP_SRC_MULTIADDR_INVALID:ge.Status.STOP_SRC_MULTIADDR_INVALID),t}}function BCe(r){return globalThis?.Buffer?.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r)}const cg=r=>{const e=pt.encodingLength(r),t=BCe(e);return pt.encode(r,t),cg.bytes=e,t};cg.bytes=0;function pl(r){r=r??{};const e=r.lengthEncoder??cg;return async function*(n){for await(const s of n){const i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}}}pl.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??cg;return new ue(t(r.byteLength),r)};const zCe=8,FCe=1024*1024*4;var ia;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(ia||(ia={}));const r8=r=>{const e=pt.decode(r);return r8.bytes=pt.encodingLength(e),e};r8.bytes=0;function qa(r){return async function*(t){const n=new ue;let s=ia.LENGTH,i=-1;const o=r?.lengthDecoder??r8,a=r?.maxLengthLength??zCe,c=r?.maxDataLength??FCe;for await(const u of t)for(n.append(u);n.byteLength>0;){if(s===ia.LENGTH)try{if(i=o(n),i<0)throw $(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(i>c)throw $(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const l=o.bytes;n.consume(l),r?.onLength!=null&&r.onLength(i),s=ia.DATA}catch(l){if(l instanceof RangeError){if(n.byteLength>a)throw $(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw l}if(s===ia.DATA){if(n.byteLength<i)break;const l=n.sublist(0,i);n.consume(i),r?.onData!=null&&r.onData(l),yield l,s=ia.LENGTH}}if(n.byteLength>0)throw $(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}}qa.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return qa({...e??{},onLength:i=>{t=i}})(n)};function n8(r){const e=Mt(),t=toe(r.source),n=Pe();let s;const i=r.sink(async function*(){yield*e,yield*await n.promise}());return i.catch(a=>{s=a}),{reader:t,writer:e,stream:{sink:async a=>{if(s!=null){await Promise.reject(s);return}n.resolve(a),await i},source:t},rest:()=>e.end(),write:e.push,read:async()=>{const a=await t.next();if(a.value!=null)return a.value}}}const Bu=N("libp2p:circuit:stream-handler");class lg{constructor(e){const{stream:t,maxLength:n=4096}=e;this.stream=t,this.shake=n8(this.stream),this.decoder=qa.fromReader(this.shake.reader,{maxDataLength:n})}async read(){const e=await this.decoder.next();if(e.value!=null){const t=ge.decode(e.value);return Bu("read message type",t.type),t}Bu("read received no value, closing stream"),this.close()}write(e){Bu("write message type %s",e.type),this.shake.write(pl.single(ge.encode(e)))}rest(){return this.shake.rest(),this.shake.stream}end(e){this.write(e),this.close()}close(){Bu("closing the stream"),this.rest().sink([]).catch(e=>{Bu.error(e)})}}const vd=N("libp2p:circuit:stop");function VCe(r){const{connection:e,request:t,streamHandler:n}=r;try{ZN(t,n)}catch(s){vd.error("invalid stop request via peer %p %o",e.remotePeer,s);return}return vd("stop request is valid"),n.write({type:ge.Type.STATUS,code:ge.Status.SUCCESS}),n.rest()}async function jCe(r){const{connection:e,request:t,signal:n}=r,s=await e.newStream(fl,{signal:n});vd("starting stop request to %p",e.remotePeer);const i=new lg({stream:s});i.write(t);const o=await i.read();if(o==null){i.close();return}if(o.code===ge.Status.SUCCESS)return vd("stop request to %p was successful",e.remotePeer),i.rest();vd("stop request failed with code %d",o.code),i.close()}const Vn=N("libp2p:circuit:hop");async function qCe(r){const{connection:e,request:t,streamHandler:n,circuit:s,connectionManager:i}=r;if(!s.hopEnabled())return Vn("HOP request received but we are not acting as a relay"),n.end({type:ge.Type.STATUS,code:ge.Status.HOP_CANT_SPEAK_RELAY});try{ZN(t,n)}catch(d){Vn.error("invalid hop request via peer %p %o",e.remotePeer,d);return}if(t.dstPeer==null){Vn("HOP request received but we do not receive a dstPeer");return}const o=ni(t.dstPeer.id),a=i.getConnections(o);if(a.length===0&&!s.hopActive())return Vn("HOP request received but we are not connected to the destination peer"),n.end({type:ge.Type.STATUS,code:ge.Status.HOP_NO_CONN_TO_DST});if(a.length===0)return Vn("did not have connection to remote peer"),n.end({type:ge.Type.STATUS,code:ge.Status.HOP_NO_CONN_TO_DST});const c={type:ge.Type.STOP,dstPeer:t.dstPeer,srcPeer:t.srcPeer};let u;try{Vn("performing STOP request");const d=await jCe({connection:a[0],request:c});if(d==null)throw new Error("Could not stop");u=d}catch(d){Vn.error(d);return}Vn("hop request from %p is valid",e.remotePeer),n.write({type:ge.Type.STATUS,code:ge.Status.SUCCESS});const l=n.rest();return Vn("creating related connections"),await Ae(l,u,l)}async function KCe(r){const{connection:e,request:t,signal:n}=r,s=await e.newStream(fl,{signal:n}),i=new lg({stream:s});i.write(t);const o=await i.read();if(o==null)throw $(new Error("HOP request had no response"),O.ERR_HOP_REQUEST_FAILED);if(o.code===ge.Status.SUCCESS)return Vn("hop request was successful"),i.rest();throw Vn("hop request failed with code %d, closing stream",o.code),i.close(),$(new Error(`HOP request failed with code "${o.code??"unknown"}"`),O.ERR_HOP_REQUEST_FAILED)}async function GCe(r){const{connection:e,signal:t}=r,n=await e.newStream(fl,{signal:t}),s=new lg({stream:n});s.write({type:ge.Type.CAN_HOP});const i=await s.read();return await s.close(),!(i==null||i.code!==ge.Status.SUCCESS)}function HCe(r){const{connection:e,streamHandler:t,circuit:n}=r,s=n.hopEnabled();Vn("can hop (%s) request from %p",s,e.remotePeer),t.end({type:ge.Type.STATUS,code:s?ge.Status.SUCCESS:ge.Status.HOP_CANT_SPEAK_RELAY})}let d$=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function eL(r,e,t){const n=t??{},s=Wa(r);async function*i(){let o;const a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){const{abortMessage:l,abortCode:d}=n;throw new d$(l,d)}const u=new Promise((l,d)=>{o=()=>{const{abortMessage:f,abortCode:g}=n;d(new d$(f,g))}});c=await Promise.race([u,s.next()]),o=null}catch(u){e.removeEventListener("abort",a);const l=u.type==="aborted"&&e.aborted;if(l&&n.onAbort!=null&&await n.onAbort(r),typeof s.return=="function")try{const d=s.return();d instanceof Promise&&d.catch(f=>{n.onReturnError!=null&&n.onReturnError(f)})}catch(d){n.onReturnError!=null&&n.onReturnError(d)}if(l&&n.returnOnAbort===!0)return;throw u}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return i()}function WCe(r,e,t){return n=>r(eL(n,e,t))}function Ao(r,e,t){return{sink:WCe(r.sink,e,{...t,onAbort:void 0}),source:eL(r.source,e,t)}}const Ln=N("libp2p:circuit");let QCe=class{constructor(e,t){this._init=t,this.components=e,this._started=!1}isStarted(){return this._started}async start(){this._started||(this._started=!0,await this.components.registrar.handle(fl,e=>{this._onProtocol(e).catch(t=>{Ln.error(t)})},{...this._init}).catch(e=>{Ln.error(e)}))}async stop(){await this.components.registrar.unhandle(fl)}hopEnabled(){return!0}hopActive(){return!0}get[F5](){return!0}get[Symbol.toStringTag](){return"libp2p/circuit-relay-v1"}async _onProtocol(e){const{connection:t,stream:n}=e,s=new ft.TimeoutController(this._init.hop.timeout);try{Qe.setMaxListeners?.(1/0,s.signal)}catch{}try{const i=Ao(n,s.signal),o=new lg({stream:{...n,...i}}),a=await o.read();if(a==null){Ln("request was invalid, could not read from stream"),o.write({type:ge.Type.STATUS,code:ge.Status.MALFORMED_MESSAGE}),o.close();return}let c;switch(a.type){case ge.Type.CAN_HOP:{Ln("received CAN_HOP request from %p",t.remotePeer),await HCe({circuit:this,connection:t,streamHandler:o});break}case ge.Type.HOP:{Ln("received HOP request from %p",t.remotePeer),await qCe({connection:t,request:a,streamHandler:o,circuit:this,connectionManager:this.components.connectionManager});break}case ge.Type.STOP:{Ln("received STOP request from %p",t.remotePeer),c=await VCe({connection:t,request:a,streamHandler:o});break}default:{Ln("Request of type %s not supported",a.type),o.write({type:ge.Type.STATUS,code:ge.Status.MALFORMED_MESSAGE}),o.close();return}}if(c!=null){const u=t.remoteAddr.encapsulate("/p2p-circuit").encapsulate(St(a.dstPeer?.addrs[0])),l=St(a.srcPeer?.addrs[0]),d=l$({stream:c,remoteAddr:u,localAddr:l}),f=a.type===ge.Type.HOP?"relay":"inbound";Ln("new %s connection %s",f,d.remoteAddr);const g=await this.components.upgrader.upgradeInbound(d);Ln("%s connection %s upgraded",f,d.remoteAddr),this.handler!=null&&this.handler(g)}}finally{s.clear()}}async dial(e,t={}){const n=e.toString().split("/p2p-circuit"),s=St(n[0]),i=St(n[n.length-1]),o=s.getPeerId(),a=i.getPeerId();if(o==null||a==null){const g="Circuit relay dial failed as addresses did not have peer id";throw Ln.error(g),$(new Error(g),O.ERR_RELAYED_DIAL)}const c=de(o),u=de(a);let l=!1,f=this.components.connectionManager.getConnections(c)[0];f==null&&(await this.components.peerStore.addressBook.add(c,[s]),f=await this.components.connectionManager.openConnection(c,t),l=!0);try{const g=await KCe({...t,connection:f,request:{type:ge.Type.HOP,srcPeer:{id:this.components.peerId.toBytes(),addrs:this.components.addressManager.getAddresses().map(w=>w.bytes)},dstPeer:{id:u.toBytes(),addrs:[St(i).bytes]}}}),h=s.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),p=l$({stream:g,remoteAddr:e,localAddr:h});return Ln("new outbound connection %s",p.remoteAddr),await this.components.upgrader.upgradeOutbound(p)}catch(g){throw Ln.error("Circuit relay dial failed",g),l&&await f.close(),g}}createListener(e){return this.handler=e.handler,UCe({connectionManager:this.components.connectionManager,peerStore:this.components.peerStore})}filter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>DCe.matches(t))}};async function tL(r){const e=new TextEncoder().encode(r),t=await YRe.digest(e);return q5.createV0(t)}const rL=60*1e3,YCe=15*rL,XCe=30*rL,JCe=290,h$="hop_relay",f$="true",nL="/libp2p/relay";var sL;(function(){var r,e,t,n,s,i,o,a;a=function(c){var u,l,d,f;return u=(c&255<<24)>>>24,l=(c&255<<16)>>>16,d=(c&65280)>>>8,f=c&255,[u,l,d,f].join(".")},o=function(c){var u,l,d,f,g,h;for(u=[],d=f=0;f<=3&&c.length!==0;d=++f){if(d>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}h=e(c),g=h[0],l=h[1],c=c.substring(l),u.push(g)}if(c.length!==0)throw new Error("Invalid IP");switch(u.length){case 1:if(u[0]>4294967295)throw new Error("Invalid IP");return u[0]>>>0;case 2:if(u[0]>255||u[1]>16777215)throw new Error("Invalid IP");return(u[0]<<24|u[1])>>>0;case 3:if(u[0]>255||u[1]>255||u[2]>65535)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2])>>>0;case 4:if(u[0]>255||u[1]>255||u[2]>255||u[3]>255)throw new Error("Invalid IP");return(u[0]<<24|u[1]<<16|u[2]<<8|u[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),i=t("a"),s=t("A"),e=function(c){var u,l,d,f,g;for(f=0,u=10,l="9",d=0,c.length>1&&c[d]==="0"&&(c[d+1]==="x"||c[d+1]==="X"?(d+=2,u=16):"0"<=c[d+1]&&c[d+1]<="9"&&(d++,u=8,l="7")),g=d;d<c.length;){if("0"<=c[d]&&c[d]<=l)f=f*u+(t(c[d])-n)>>>0;else if(u===16)if("a"<=c[d]&&c[d]<="f")f=f*u+(10+t(c[d])-i)>>>0;else if("A"<=c[d]&&c[d]<="F")f=f*u+(10+t(c[d])-s)>>>0;else break;else break;if(f>4294967295)throw new Error("too large");d++}if(d===g)throw new Error("empty octet");return[f,d]},r=function(){function c(u,l){var d,f,g;if(typeof u!="string")throw new Error("Missing `net' parameter");if(l||(g=u.split("/",2),u=g[0],l=g[1]),l||(l=32),typeof l=="string"&&l.indexOf(".")>-1){try{this.maskLong=o(l)}catch{throw new Error("Invalid mask: "+l)}for(d=f=32;f>=0;d=--f)if(this.maskLong===4294967295<<32-d>>>0){this.bitmask=d;break}}else if(l||l===0)this.bitmask=parseInt(l,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(u)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+u)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+l);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(u){return typeof u=="string"&&(u.indexOf("/")>0||u.split(".").length!==4)&&(u=new c(u)),u instanceof c?this.contains(u.base)&&this.contains(u.broadcast||u.last):(o(u)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(u){return u==null&&(u=1),new c(a(this.netLong+this.size*u),this.mask)},c.prototype.forEach=function(u){var l,d,f;for(f=o(this.first),d=o(this.last),l=0;f<=d;)u(a(f),f,l),l++,f++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),sL=r}).call(fn);const p$="[a-fA-F\\d:]",$o=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${p$})|(?<=${p$})(?=\\s|$))`:"",hs="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",$t="[a-fA-F\\d]{1,4}",ug=`
(?:
(?:${$t}:){7}(?:${$t}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${$t}:){6}(?:${hs}|:${$t}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${$t}:){5}(?::${hs}|(?::${$t}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${$t}:){4}(?:(?::${$t}){0,1}:${hs}|(?::${$t}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${$t}:){3}(?:(?::${$t}){0,2}:${hs}|(?::${$t}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${$t}:){2}(?:(?::${$t}){0,3}:${hs}|(?::${$t}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${$t}:){1}(?:(?::${$t}){0,4}:${hs}|(?::${$t}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${$t}){0,5}:${hs}|(?::${$t}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),ZCe=new RegExp(`(?:^${hs}$)|(?:^${ug}$)`),exe=new RegExp(`^${hs}$`),txe=new RegExp(`^${ug}$`),s8=r=>r&&r.exact?ZCe:new RegExp(`(?:${$o(r)}${hs}${$o(r)})|(?:${$o(r)}${ug}${$o(r)})`,"g");s8.v4=r=>r&&r.exact?exe:new RegExp(`${$o(r)}${hs}${$o(r)}`,"g");s8.v6=r=>r&&r.exact?txe:new RegExp(`${$o(r)}${ug}${$o(r)}`,"g");var iL={exports:{}};(function(r){(function(e){const t="(0?\\d+|0x[a-f0-9]+)",n={fourOctet:new RegExp(`^${t}\\.${t}\\.${t}\\.${t}$`,"i"),threeOctet:new RegExp(`^${t}\\.${t}\\.${t}$`,"i"),twoOctet:new RegExp(`^${t}\\.${t}$`,"i"),longValue:new RegExp(`^${t}$`,"i")},s=new RegExp("^0[0-7]+$","i"),i=new RegExp("^0x[a-f0-9]+$","i"),o="%[0-9a-z]{1,}",a="(?:[0-9a-f]+::?)+",c={zoneIndex:new RegExp(o,"i"),native:new RegExp(`^(::)?(${a})?([0-9a-f]+)?(::)?(${o})?$`,"i"),deprecatedTransitional:new RegExp(`^(?:::)(${t}\\.${t}\\.${t}\\.${t}(${o})?)$`,"i"),transitional:new RegExp(`^((?:${a})|(?:::)(?:${a})?)${t}\\.${t}\\.${t}\\.${t}(${o})?$`,"i")};function u(h,p){if(h.indexOf("::")!==h.lastIndexOf("::"))return null;let w=0,y=-1,E=(h.match(c.zoneIndex)||[])[0],m,b;for(E&&(E=E.substring(1),h=h.replace(/%.+$/,""));(y=h.indexOf(":",y+1))>=0;)w++;if(h.substr(0,2)==="::"&&w--,h.substr(-2,2)==="::"&&w--,w>p)return null;for(b=p-w,m=":";b--;)m+="0:";return h=h.replace("::",m),h[0]===":"&&(h=h.slice(1)),h[h.length-1]===":"&&(h=h.slice(0,-1)),p=function(){const v=h.split(":"),S=[];for(let _=0;_<v.length;_++)S.push(parseInt(v[_],16));return S}(),{parts:p,zoneId:E}}function l(h,p,w,y){if(h.length!==p.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");let E=0,m;for(;y>0;){if(m=w-y,m<0&&(m=0),h[E]>>m!==p[E]>>m)return!1;y-=w,E+=1}return!0}function d(h){if(i.test(h))return parseInt(h,16);if(h[0]==="0"&&!isNaN(parseInt(h[1],10))){if(s.test(h))return parseInt(h,8);throw new Error(`ipaddr: cannot parse ${h} as octal`)}return parseInt(h,10)}function f(h,p){for(;h.length<p;)h=`0${h}`;return h}const g={};g.IPv4=function(){function h(p){if(p.length!==4)throw new Error("ipaddr: ipv4 octet count should be 4");let w,y;for(w=0;w<p.length;w++)if(y=p[w],!(0<=y&&y<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=p}return h.prototype.SpecialRanges={unspecified:[[new h([0,0,0,0]),8]],broadcast:[[new h([255,255,255,255]),32]],multicast:[[new h([224,0,0,0]),4]],linkLocal:[[new h([169,254,0,0]),16]],loopback:[[new h([127,0,0,0]),8]],carrierGradeNat:[[new h([100,64,0,0]),10]],private:[[new h([10,0,0,0]),8],[new h([172,16,0,0]),12],[new h([192,168,0,0]),16]],reserved:[[new h([192,0,0,0]),24],[new h([192,0,2,0]),24],[new h([192,88,99,0]),24],[new h([198,18,0,0]),15],[new h([198,51,100,0]),24],[new h([203,0,113,0]),24],[new h([240,0,0,0]),4]]},h.prototype.kind=function(){return"ipv4"},h.prototype.match=function(p,w){let y;if(w===void 0&&(y=p,p=y[0],w=y[1]),p.kind()!=="ipv4")throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return l(this.octets,p.octets,8,w)},h.prototype.prefixLengthFromSubnetMask=function(){let p=0,w=!1;const y={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0};let E,m,b;for(E=3;E>=0;E-=1)if(m=this.octets[E],m in y){if(b=y[m],w&&b!==0)return null;b!==8&&(w=!0),p+=b}else return null;return 32-p},h.prototype.range=function(){return g.subnetMatch(this,this.SpecialRanges)},h.prototype.toByteArray=function(){return this.octets.slice(0)},h.prototype.toIPv4MappedAddress=function(){return g.IPv6.parse(`::ffff:${this.toString()}`)},h.prototype.toNormalizedString=function(){return this.toString()},h.prototype.toString=function(){return this.octets.join(".")},h}(),g.IPv4.broadcastAddressFromCIDR=function(h){try{const p=this.parseCIDR(h),w=p[0].toByteArray(),y=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),E=[];let m=0;for(;m<4;)E.push(parseInt(w[m],10)|parseInt(y[m],10)^255),m++;return new this(E)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},g.IPv4.isIPv4=function(h){return this.parser(h)!==null},g.IPv4.isValid=function(h){try{return new this(this.parser(h)),!0}catch{return!1}},g.IPv4.isValidFourPartDecimal=function(h){return!!(g.IPv4.isValid(h)&&h.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},g.IPv4.networkAddressFromCIDR=function(h){let p,w,y,E,m;try{for(p=this.parseCIDR(h),y=p[0].toByteArray(),m=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),E=[],w=0;w<4;)E.push(parseInt(y[w],10)&parseInt(m[w],10)),w++;return new this(E)}catch{throw new Error("ipaddr: the address does not have IPv4 CIDR format")}},g.IPv4.parse=function(h){const p=this.parser(h);if(p===null)throw new Error("ipaddr: string is not formatted like an IPv4 Address");return new this(p)},g.IPv4.parseCIDR=function(h){let p;if(p=h.match(/^(.+)\/(\d+)$/)){const w=parseInt(p[2]);if(w>=0&&w<=32){const y=[this.parse(p[1]),w];return Object.defineProperty(y,"toString",{value:function(){return this.join("/")}}),y}}throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},g.IPv4.parser=function(h){let p,w,y;if(p=h.match(n.fourOctet))return function(){const E=p.slice(1,6),m=[];for(let b=0;b<E.length;b++)w=E[b],m.push(d(w));return m}();if(p=h.match(n.longValue)){if(y=d(p[1]),y>4294967295||y<0)throw new Error("ipaddr: address outside defined range");return function(){const E=[];let m;for(m=0;m<=24;m+=8)E.push(y>>m&255);return E}().reverse()}else return(p=h.match(n.twoOctet))?function(){const E=p.slice(1,4),m=[];if(y=d(E[1]),y>16777215||y<0)throw new Error("ipaddr: address outside defined range");return m.push(d(E[0])),m.push(y>>16&255),m.push(y>>8&255),m.push(y&255),m}():(p=h.match(n.threeOctet))?function(){const E=p.slice(1,5),m=[];if(y=d(E[2]),y>65535||y<0)throw new Error("ipaddr: address outside defined range");return m.push(d(E[0])),m.push(d(E[1])),m.push(y>>8&255),m.push(y&255),m}():null},g.IPv4.subnetMaskFromPrefixLength=function(h){if(h=parseInt(h),h<0||h>32)throw new Error("ipaddr: invalid IPv4 prefix length");const p=[0,0,0,0];let w=0;const y=Math.floor(h/8);for(;w<y;)p[w]=255,w++;return y<4&&(p[y]=Math.pow(2,h%8)-1<<8-h%8),new this(p)},g.IPv6=function(){function h(p,w){let y,E;if(p.length===16)for(this.parts=[],y=0;y<=14;y+=2)this.parts.push(p[y]<<8|p[y+1]);else if(p.length===8)this.parts=p;else throw new Error("ipaddr: ipv6 part count should be 8 or 16");for(y=0;y<this.parts.length;y++)if(E=this.parts[y],!(0<=E&&E<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");w&&(this.zoneId=w)}return h.prototype.SpecialRanges={unspecified:[new h([0,0,0,0,0,0,0,0]),128],linkLocal:[new h([65152,0,0,0,0,0,0,0]),10],multicast:[new h([65280,0,0,0,0,0,0,0]),8],loopback:[new h([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new h([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new h([0,0,0,0,0,65535,0,0]),96],rfc6145:[new h([0,0,0,0,65535,0,0,0]),96],rfc6052:[new h([100,65435,0,0,0,0,0,0]),96],"6to4":[new h([8194,0,0,0,0,0,0,0]),16],teredo:[new h([8193,0,0,0,0,0,0,0]),32],reserved:[[new h([8193,3512,0,0,0,0,0,0]),32]],benchmarking:[new h([8193,2,0,0,0,0,0,0]),48],amt:[new h([8193,3,0,0,0,0,0,0]),32],as112v6:[new h([8193,4,274,0,0,0,0,0]),48],deprecated:[new h([8193,16,0,0,0,0,0,0]),28],orchid2:[new h([8193,32,0,0,0,0,0,0]),28]},h.prototype.isIPv4MappedAddress=function(){return this.range()==="ipv4Mapped"},h.prototype.kind=function(){return"ipv6"},h.prototype.match=function(p,w){let y;if(w===void 0&&(y=p,p=y[0],w=y[1]),p.kind()!=="ipv6")throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return l(this.parts,p.parts,16,w)},h.prototype.prefixLengthFromSubnetMask=function(){let p=0,w=!1;const y={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0};let E,m;for(let b=7;b>=0;b-=1)if(E=this.parts[b],E in y){if(m=y[E],w&&m!==0)return null;m!==16&&(w=!0),p+=m}else return null;return 128-p},h.prototype.range=function(){return g.subnetMatch(this,this.SpecialRanges)},h.prototype.toByteArray=function(){let p;const w=[],y=this.parts;for(let E=0;E<y.length;E++)p=y[E],w.push(p>>8),w.push(p&255);return w},h.prototype.toFixedLengthString=function(){const p=function(){const y=[];for(let E=0;E<this.parts.length;E++)y.push(f(this.parts[E].toString(16),4));return y}.call(this).join(":");let w="";return this.zoneId&&(w=`%${this.zoneId}`),p+w},h.prototype.toIPv4Address=function(){if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");const p=this.parts.slice(-2),w=p[0],y=p[1];return new g.IPv4([w>>8,w&255,y>>8,y&255])},h.prototype.toNormalizedString=function(){const p=function(){const y=[];for(let E=0;E<this.parts.length;E++)y.push(this.parts[E].toString(16));return y}.call(this).join(":");let w="";return this.zoneId&&(w=`%${this.zoneId}`),p+w},h.prototype.toRFC5952String=function(){const p=/((^|:)(0(:|$)){2,})/g,w=this.toNormalizedString();let y=0,E=-1,m;for(;m=p.exec(w);)m[0].length>E&&(y=m.index,E=m[0].length);return E<0?w:`${w.substring(0,y)}::${w.substring(y+E)}`},h.prototype.toString=function(){return this.toRFC5952String()},h}(),g.IPv6.broadcastAddressFromCIDR=function(h){try{const p=this.parseCIDR(h),w=p[0].toByteArray(),y=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),E=[];let m=0;for(;m<16;)E.push(parseInt(w[m],10)|parseInt(y[m],10)^255),m++;return new this(E)}catch(p){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${p})`)}},g.IPv6.isIPv6=function(h){return this.parser(h)!==null},g.IPv6.isValid=function(h){if(typeof h=="string"&&h.indexOf(":")===-1)return!1;try{const p=this.parser(h);return new this(p.parts,p.zoneId),!0}catch{return!1}},g.IPv6.networkAddressFromCIDR=function(h){let p,w,y,E,m;try{for(p=this.parseCIDR(h),y=p[0].toByteArray(),m=this.subnetMaskFromPrefixLength(p[1]).toByteArray(),E=[],w=0;w<16;)E.push(parseInt(y[w],10)&parseInt(m[w],10)),w++;return new this(E)}catch(b){throw new Error(`ipaddr: the address does not have IPv6 CIDR format (${b})`)}},g.IPv6.parse=function(h){const p=this.parser(h);if(p.parts===null)throw new Error("ipaddr: string is not formatted like an IPv6 Address");return new this(p.parts,p.zoneId)},g.IPv6.parseCIDR=function(h){let p,w,y;if((w=h.match(/^(.+)\/(\d+)$/))&&(p=parseInt(w[2]),p>=0&&p<=128))return y=[this.parse(w[1]),p],Object.defineProperty(y,"toString",{value:function(){return this.join("/")}}),y;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},g.IPv6.parser=function(h){let p,w,y,E,m,b;if(y=h.match(c.deprecatedTransitional))return this.parser(`::ffff:${y[1]}`);if(c.native.test(h))return u(h,8);if((y=h.match(c.transitional))&&(b=y[6]||"",p=u(y[1].slice(0,-1)+b,6),p.parts)){for(m=[parseInt(y[2]),parseInt(y[3]),parseInt(y[4]),parseInt(y[5])],w=0;w<m.length;w++)if(E=m[w],!(0<=E&&E<=255))return null;return p.parts.push(m[0]<<8|m[1]),p.parts.push(m[2]<<8|m[3]),{parts:p.parts,zoneId:p.zoneId}}return null},g.IPv6.subnetMaskFromPrefixLength=function(h){if(h=parseInt(h),h<0||h>128)throw new Error("ipaddr: invalid IPv6 prefix length");const p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];let w=0;const y=Math.floor(h/8);for(;w<y;)p[w]=255,w++;return y<16&&(p[y]=Math.pow(2,h%8)-1<<8-h%8),new this(p)},g.fromByteArray=function(h){const p=h.length;if(p===4)return new g.IPv4(h);if(p===16)return new g.IPv6(h);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},g.isValid=function(h){return g.IPv6.isValid(h)||g.IPv4.isValid(h)},g.parse=function(h){if(g.IPv6.isValid(h))return g.IPv6.parse(h);if(g.IPv4.isValid(h))return g.IPv4.parse(h);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},g.parseCIDR=function(h){try{return g.IPv6.parseCIDR(h)}catch{try{return g.IPv4.parseCIDR(h)}catch{throw new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},g.process=function(h){const p=this.parse(h);return p.kind()==="ipv6"&&p.isIPv4MappedAddress()?p.toIPv4Address():p},g.subnetMatch=function(h,p,w){let y,E,m,b;w==null&&(w="unicast");for(E in p)if(Object.prototype.hasOwnProperty.call(p,E)){for(m=p[E],m[0]&&!(m[0]instanceof Array)&&(m=[m]),y=0;y<m.length;y++)if(b=m[y],h.kind()===b[0].kind()&&h.match.apply(h,b))return E}return w},r.exports?r.exports=g:e.ipaddr=g})(fn)})(iL);var rxe=iL.exports;const nxe=Ge(rxe),{isValid:sxe,parse:ixe}=nxe,oxe=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],axe=oxe.map(r=>new sL(r));function cxe(r){for(let e of axe)if(e.contains(r))return!0;return!1}function g$(r){return/^::$/.test(r)||/^::1$/.test(r)||/^::f{4}:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^::f{4}:0.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}const dg=r=>{if(sxe(r)){const e=ixe(r);if(e.kind()==="ipv4")return cxe(e.toNormalizedString());if(e.kind()==="ipv6")return g$(r)}else if(tt(r)&&s8.v6().test(r))return g$(r)};function y$(r){try{const{address:e}=r.nodeAddress();return!!dg(e)}catch{return!0}}function i8(r,e){const t=y$(r.multiaddr),n=y$(e.multiaddr);return t&&!n?1:!t&&n||r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}const zu=N("libp2p:auto-relay"),lxe=()=>{};class uxe{constructor(e,t){this.components=e,this.addressSorter=t.addressSorter??i8,this.maxListeners=t.maxListeners??1,this.listenRelays=new Set,this.onError=t.onError??lxe,this._onProtocolChange=this._onProtocolChange.bind(this),this._onPeerDisconnected=this._onPeerDisconnected.bind(this),this.components.peerStore.addEventListener("change:protocols",n=>{this._onProtocolChange(n).catch(s=>{zu.error(s)})}),this.components.connectionManager.addEventListener("peer:disconnect",this._onPeerDisconnected)}async _onProtocolChange(e){const{peerId:t,protocols:n}=e.detail,s=t.toString();if(n.find(o=>o===fl)==null){this.listenRelays.has(s)&&await this._removeListenRelay(s);return}if(!this.listenRelays.has(s))try{const o=this.components.connectionManager.getConnections(t);if(o.length===0)return;const a=o[0];if(a.remoteAddr.protoCodes().includes(JCe)){zu(`relayed connection to ${s} will not be used to hop on`);return}await GCe({connection:a})&&(await this.components.peerStore.metadataBook.setValue(t,h$,L(f$)),await this._addListenRelay(a,s))}catch(o){this.onError(o)}}_onPeerDisconnected(e){const s=e.detail.remotePeer.toString();this.listenRelays.has(s)&&this._removeListenRelay(s).catch(i=>{zu.error(i)})}async _addListenRelay(e,t){try{if(this.listenRelays.size>=this.maxListeners)return;const n=await Ae(await this.components.peerStore.addressBook.get(e.remotePeer),i=>k1(i,this.addressSorter),async i=>await jo(i));(await Promise.all(n.map(async i=>{try{let o=i.multiaddr;return o.getPeerId()==null&&(o=o.encapsulate(`/p2p/${e.remotePeer.toString()}`)),o=o.encapsulate("/p2p-circuit"),await this.components.transportManager.listen([o]),!0}catch(o){zu.error("error listening on circuit address",o),this.onError(o)}return!1}))).includes(!0)&&this.listenRelays.add(t)}catch(n){this.onError(n),this.listenRelays.delete(t)}}async _removeListenRelay(e){this.listenRelays.delete(e)&&await this._listenOnAvailableHopRelays([e])}async _listenOnAvailableHopRelays(e=[]){if(this.listenRelays.size>=this.maxListeners)return;const t=[],n=await this.components.peerStore.all();for(const{id:s,metadata:i}of n){const o=s.toString();if(this.listenRelays.has(o)||e.includes(o))continue;const a=i.get(h$);if(a==null||C(a)!==f$)continue;const c=this.components.connectionManager.getConnections(s);if(c.length===0){t.push(s);continue}if(await this._addListenRelay(c[0],o),this.listenRelays.size>=this.maxListeners)return}for(const s of t)if(await this._tryToListenOnRelay(s),this.listenRelays.size>=this.maxListeners)return;try{const s=await tL(nL);for await(const i of this.components.contentRouting.findProviders(s)){if(i.multiaddrs.length===0)continue;const o=i.id;if(!o.equals(this.components.peerId)&&(await this.components.peerStore.addressBook.add(o,i.multiaddrs),await this._tryToListenOnRelay(o),this.listenRelays.size>=this.maxListeners))return}}catch(s){this.onError(s)}}async _tryToListenOnRelay(e){try{const t=await this.components.connectionManager.openConnection(e);await this._addListenRelay(t,e.toString())}catch(t){zu.error("Could not use %p as relay",e,t),this.onError(t,`could not connect and listen on known hop relay ${e.toString()}`)}}}const w$=N("libp2p:relay");class dxe{constructor(e,t){this.components=e,this.autoRelay=t.autoRelay?.enabled!==!1?new uxe(e,{addressSorter:t.addressSorter,...t.autoRelay}):void 0,this.started=!1,this.init=t,this._advertiseService=this._advertiseService.bind(this)}isStarted(){return this.started}async start(){this.init.hop.enabled!==!1&&this.init.advertise.enabled!==!1&&(this.timeout=g0.setDelayedInterval(this._advertiseService,this.init.advertise.ttl,this.init.advertise.bootDelay)),this.started=!0}async stop(){this.timeout!=null&&g0.clearDelayedInterval(this.timeout),this.started=!1}async _advertiseService(){try{const e=await tL(nL);await this.components.contentRouting.provide(e)}catch(e){e.code===O.ERR_NO_ROUTERS_AVAILABLE?(w$.error("a content router, such as a DHT, must be provided in order to advertise the relay service",e),await this.stop()):w$.error(e)}}}function hxe(r){return r>=55296&&r<=56319}function fxe(r){return r>=56320&&r<=57343}var pxe=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var s=t.length,i=0,o,a,c=0;c<s;c+=1){if(o=t.charCodeAt(c),a=t[c],hxe(o)&&fxe(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),i+=e(a),i===n)return t.slice(0,c+1);if(i>n)return t.slice(0,c-a.length+1)}return t};function gxe(r){return r>=55296&&r<=56319}function yxe(r){return r>=56320&&r<=57343}var wxe=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,s=null,i=null,o=0;o<t;o++)s=e.charCodeAt(o),yxe(s)?i!=null&&gxe(i)?n+=1:n+=3:s<=127?n+=1:s>=128&&s<=2047?n+=2:s>=2048&&s<=65535&&(n+=3),i=s;return n},bxe=pxe,mxe=wxe,Exe=bxe.bind(null,mxe),vxe=Exe,_xe=/[\/\?<>\\:\*\|"]/g,Sxe=/[\x00-\x1f\x80-\x9f]/g,Axe=/^\.+$/,$xe=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,Rxe=/[\. ]+$/;function b$(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(_xe,e).replace(Sxe,e).replace(Axe,e).replace($xe,e).replace(Rxe,e);return vxe(t,255)}var Txe=function(r,e){var t=e&&e.replacement||"",n=b$(r,t);return t===""?n:b$(n,"")};const Ixe=Ge(Txe);var gl=_l,H=gl.asn1,zl=gl.pkcs7asn1=gl.pkcs7asn1||{};gl.pkcs7=gl.pkcs7||{};gl.pkcs7.asn1=zl;var oL={name:"ContentInfo",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"ContentInfo.ContentType",tagClass:H.Class.UNIVERSAL,type:H.Type.OID,constructed:!1,capture:"contentType"},{name:"ContentInfo.content",tagClass:H.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,captureAsn1:"content"}]};zl.contentInfoValidator=oL;var aL={name:"EncryptedContentInfo",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedContentInfo.contentType",tagClass:H.Class.UNIVERSAL,type:H.Type.OID,constructed:!1,capture:"contentType"},{name:"EncryptedContentInfo.contentEncryptionAlgorithm",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedContentInfo.contentEncryptionAlgorithm.algorithm",tagClass:H.Class.UNIVERSAL,type:H.Type.OID,constructed:!1,capture:"encAlgorithm"},{name:"EncryptedContentInfo.contentEncryptionAlgorithm.parameter",tagClass:H.Class.UNIVERSAL,captureAsn1:"encParameter"}]},{name:"EncryptedContentInfo.encryptedContent",tagClass:H.Class.CONTEXT_SPECIFIC,type:0,capture:"encryptedContent",captureAsn1:"encryptedContentAsn1"}]};zl.envelopedDataValidator={name:"EnvelopedData",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"EnvelopedData.Version",tagClass:H.Class.UNIVERSAL,type:H.Type.INTEGER,constructed:!1,capture:"version"},{name:"EnvelopedData.RecipientInfos",tagClass:H.Class.UNIVERSAL,type:H.Type.SET,constructed:!0,captureAsn1:"recipientInfos"}].concat(aL)};zl.encryptedDataValidator={name:"EncryptedData",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"EncryptedData.Version",tagClass:H.Class.UNIVERSAL,type:H.Type.INTEGER,constructed:!1,capture:"version"}].concat(aL)};var Cxe={name:"SignerInfo",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"SignerInfo.version",tagClass:H.Class.UNIVERSAL,type:H.Type.INTEGER,constructed:!1},{name:"SignerInfo.issuerAndSerialNumber",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"SignerInfo.issuerAndSerialNumber.issuer",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,captureAsn1:"issuer"},{name:"SignerInfo.issuerAndSerialNumber.serialNumber",tagClass:H.Class.UNIVERSAL,type:H.Type.INTEGER,constructed:!1,capture:"serial"}]},{name:"SignerInfo.digestAlgorithm",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"SignerInfo.digestAlgorithm.algorithm",tagClass:H.Class.UNIVERSAL,type:H.Type.OID,constructed:!1,capture:"digestAlgorithm"},{name:"SignerInfo.digestAlgorithm.parameter",tagClass:H.Class.UNIVERSAL,constructed:!1,captureAsn1:"digestParameter",optional:!0}]},{name:"SignerInfo.authenticatedAttributes",tagClass:H.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,capture:"authenticatedAttributes"},{name:"SignerInfo.digestEncryptionAlgorithm",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,capture:"signatureAlgorithm"},{name:"SignerInfo.encryptedDigest",tagClass:H.Class.UNIVERSAL,type:H.Type.OCTETSTRING,constructed:!1,capture:"signature"},{name:"SignerInfo.unauthenticatedAttributes",tagClass:H.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,optional:!0,capture:"unauthenticatedAttributes"}]};zl.signedDataValidator={name:"SignedData",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"SignedData.Version",tagClass:H.Class.UNIVERSAL,type:H.Type.INTEGER,constructed:!1,capture:"version"},{name:"SignedData.DigestAlgorithms",tagClass:H.Class.UNIVERSAL,type:H.Type.SET,constructed:!0,captureAsn1:"digestAlgorithms"},oL,{name:"SignedData.Certificates",tagClass:H.Class.CONTEXT_SPECIFIC,type:0,optional:!0,captureAsn1:"certificates"},{name:"SignedData.CertificateRevocationLists",tagClass:H.Class.CONTEXT_SPECIFIC,type:1,optional:!0,captureAsn1:"crls"},{name:"SignedData.SignerInfos",tagClass:H.Class.UNIVERSAL,type:H.Type.SET,capture:"signerInfos",optional:!0,value:[Cxe]}]};zl.recipientInfoValidator={name:"RecipientInfo",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.version",tagClass:H.Class.UNIVERSAL,type:H.Type.INTEGER,constructed:!1,capture:"version"},{name:"RecipientInfo.issuerAndSerial",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.issuerAndSerial.issuer",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,captureAsn1:"issuer"},{name:"RecipientInfo.issuerAndSerial.serialNumber",tagClass:H.Class.UNIVERSAL,type:H.Type.INTEGER,constructed:!1,capture:"serial"}]},{name:"RecipientInfo.keyEncryptionAlgorithm",tagClass:H.Class.UNIVERSAL,type:H.Type.SEQUENCE,constructed:!0,value:[{name:"RecipientInfo.keyEncryptionAlgorithm.algorithm",tagClass:H.Class.UNIVERSAL,type:H.Type.OID,constructed:!1,capture:"encAlgorithm"},{name:"RecipientInfo.keyEncryptionAlgorithm.parameter",tagClass:H.Class.UNIVERSAL,constructed:!1,captureAsn1:"encParameter",optional:!0}]},{name:"RecipientInfo.encryptedKey",tagClass:H.Class.UNIVERSAL,type:H.Type.OCTETSTRING,constructed:!1,capture:"encKey"}]};var Da=_l;Da.mgf=Da.mgf||{};var xxe=Da.mgf.mgf1=Da.mgf1=Da.mgf1||{};xxe.create=function(r){var e={generate:function(t,n){for(var s=new Da.util.ByteBuffer,i=Math.ceil(n/r.digestLength),o=0;o<i;o++){var a=new Da.util.ByteBuffer;a.putInt32(o),r.start(),r.update(t+a.getBytes()),s.putBuffer(r.digest())}return s.truncate(s.length()-n),s.getBytes()}};return e};var v0=_l;v0.mgf=v0.mgf||{};v0.mgf.mgf1=v0.mgf1;var oa=_l,Dxe=oa.pss=oa.pss||{};Dxe.create=function(r){arguments.length===3&&(r={md:arguments[0],mgf:arguments[1],saltLength:arguments[2]});var e=r.md,t=r.mgf,n=e.digestLength,s=r.salt||null;typeof s=="string"&&(s=oa.util.createBuffer(s));var i;if("saltLength"in r)i=r.saltLength;else if(s!==null)i=s.length();else throw new Error("Salt length not specified or specific salt not given.");if(s!==null&&s.length()!==i)throw new Error("Given salt length does not match length of given salt.");var o=r.prng||oa.random,a={};return a.encode=function(c,u){var l,d=u-1,f=Math.ceil(d/8),g=c.digest().getBytes();if(f<n+i+2)throw new Error("Message is too long to encrypt.");var h;s===null?h=o.getBytesSync(i):h=s.bytes();var p=new oa.util.ByteBuffer;p.fillWithByte(0,8),p.putBytes(g),p.putBytes(h),e.start(),e.update(p.getBytes());var w=e.digest().getBytes(),y=new oa.util.ByteBuffer;y.fillWithByte(0,f-i-n-2),y.putByte(1),y.putBytes(h);var E=y.getBytes(),m=f-n-1,b=t.generate(w,m),v="";for(l=0;l<m;l++)v+=String.fromCharCode(E.charCodeAt(l)^b.charCodeAt(l));var S=65280>>8*f-d&255;return v=String.fromCharCode(v.charCodeAt(0)&~S)+v.substr(1),v+w+String.fromCharCode(188)},a.verify=function(c,u,l){var d,f=l-1,g=Math.ceil(f/8);if(u=u.substr(-g),g<n+i+2)throw new Error("Inconsistent parameters to PSS signature verification.");if(u.charCodeAt(g-1)!==188)throw new Error("Encoded message does not end in 0xBC.");var h=g-n-1,p=u.substr(0,h),w=u.substr(h,n),y=65280>>8*g-f&255;if(p.charCodeAt(0)&y)throw new Error("Bits beyond keysize not zero as expected.");var E=t.generate(w,h),m="";for(d=0;d<h;d++)m+=String.fromCharCode(p.charCodeAt(d)^E.charCodeAt(d));m=String.fromCharCode(m.charCodeAt(0)&~y)+m.substr(1);var b=g-n-i-2;for(d=0;d<b;d++)if(m.charCodeAt(d)!==0)throw new Error("Leftmost octets not zero as expected");if(m.charCodeAt(b)!==1)throw new Error("Inconsistent PSS signature, 0x01 marker not found");var v=m.substr(-i),S=new oa.util.ByteBuffer;S.fillWithByte(0,8),S.putBytes(c),S.putBytes(v),e.start(),e.update(S.getBytes());var _=e.digest().getBytes();return w===_},a};var Z=_l,R=Z.asn1,j=Z.pki=Z.pki||{},_e=j.oids,mt={};mt.CN=_e.commonName;mt.commonName="CN";mt.C=_e.countryName;mt.countryName="C";mt.L=_e.localityName;mt.localityName="L";mt.ST=_e.stateOrProvinceName;mt.stateOrProvinceName="ST";mt.O=_e.organizationName;mt.organizationName="O";mt.OU=_e.organizationalUnitName;mt.organizationalUnitName="OU";mt.E=_e.emailAddress;mt.emailAddress="E";var cL=Z.pki.rsa.publicKeyValidator,Oxe={name:"Certificate",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"tbsCertificate",value:[{name:"Certificate.TBSCertificate.version",tagClass:R.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.version.integer",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"certVersion"}]},{name:"Certificate.TBSCertificate.serialNumber",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"certSerialNumber"},{name:"Certificate.TBSCertificate.signature",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate.signature.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"certinfoSignatureOid"},{name:"Certificate.TBSCertificate.signature.parameters",tagClass:R.Class.UNIVERSAL,optional:!0,captureAsn1:"certinfoSignatureParams"}]},{name:"Certificate.TBSCertificate.issuer",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"certIssuer"},{name:"Certificate.TBSCertificate.validity",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.TBSCertificate.validity.notBefore (utc)",tagClass:R.Class.UNIVERSAL,type:R.Type.UTCTIME,constructed:!1,optional:!0,capture:"certValidity1UTCTime"},{name:"Certificate.TBSCertificate.validity.notBefore (generalized)",tagClass:R.Class.UNIVERSAL,type:R.Type.GENERALIZEDTIME,constructed:!1,optional:!0,capture:"certValidity2GeneralizedTime"},{name:"Certificate.TBSCertificate.validity.notAfter (utc)",tagClass:R.Class.UNIVERSAL,type:R.Type.UTCTIME,constructed:!1,optional:!0,capture:"certValidity3UTCTime"},{name:"Certificate.TBSCertificate.validity.notAfter (generalized)",tagClass:R.Class.UNIVERSAL,type:R.Type.GENERALIZEDTIME,constructed:!1,optional:!0,capture:"certValidity4GeneralizedTime"}]},{name:"Certificate.TBSCertificate.subject",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"certSubject"},cL,{name:"Certificate.TBSCertificate.issuerUniqueID",tagClass:R.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.issuerUniqueID.id",tagClass:R.Class.UNIVERSAL,type:R.Type.BITSTRING,constructed:!1,captureBitStringValue:"certIssuerUniqueId"}]},{name:"Certificate.TBSCertificate.subjectUniqueID",tagClass:R.Class.CONTEXT_SPECIFIC,type:2,constructed:!0,optional:!0,value:[{name:"Certificate.TBSCertificate.subjectUniqueID.id",tagClass:R.Class.UNIVERSAL,type:R.Type.BITSTRING,constructed:!1,captureBitStringValue:"certSubjectUniqueId"}]},{name:"Certificate.TBSCertificate.extensions",tagClass:R.Class.CONTEXT_SPECIFIC,type:3,constructed:!0,captureAsn1:"certExtensions",optional:!0}]},{name:"Certificate.signatureAlgorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"Certificate.signatureAlgorithm.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"certSignatureOid"},{name:"Certificate.TBSCertificate.signature.parameters",tagClass:R.Class.UNIVERSAL,optional:!0,captureAsn1:"certSignatureParams"}]},{name:"Certificate.signatureValue",tagClass:R.Class.UNIVERSAL,type:R.Type.BITSTRING,constructed:!1,captureBitStringValue:"certSignature"}]},Pxe={name:"rsapss",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"rsapss.hashAlgorithm",tagClass:R.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,value:[{name:"rsapss.hashAlgorithm.AlgorithmIdentifier",tagClass:R.Class.UNIVERSAL,type:R.Class.SEQUENCE,constructed:!0,optional:!0,value:[{name:"rsapss.hashAlgorithm.AlgorithmIdentifier.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"hashOid"}]}]},{name:"rsapss.maskGenAlgorithm",tagClass:R.Class.CONTEXT_SPECIFIC,type:1,constructed:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier",tagClass:R.Class.UNIVERSAL,type:R.Class.SEQUENCE,constructed:!0,optional:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"maskGenOid"},{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.params",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"rsapss.maskGenAlgorithm.AlgorithmIdentifier.params.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"maskGenHashOid"}]}]}]},{name:"rsapss.saltLength",tagClass:R.Class.CONTEXT_SPECIFIC,type:2,optional:!0,value:[{name:"rsapss.saltLength.saltLength",tagClass:R.Class.UNIVERSAL,type:R.Class.INTEGER,constructed:!1,capture:"saltLength"}]},{name:"rsapss.trailerField",tagClass:R.Class.CONTEXT_SPECIFIC,type:3,optional:!0,value:[{name:"rsapss.trailer.trailer",tagClass:R.Class.UNIVERSAL,type:R.Class.INTEGER,constructed:!1,capture:"trailer"}]}]},kxe={name:"CertificationRequestInfo",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"certificationRequestInfo",value:[{name:"CertificationRequestInfo.integer",tagClass:R.Class.UNIVERSAL,type:R.Type.INTEGER,constructed:!1,capture:"certificationRequestInfoVersion"},{name:"CertificationRequestInfo.subject",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"certificationRequestInfoSubject"},cL,{name:"CertificationRequestInfo.attributes",tagClass:R.Class.CONTEXT_SPECIFIC,type:0,constructed:!0,optional:!0,capture:"certificationRequestInfoAttributes",value:[{name:"CertificationRequestInfo.attributes",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"CertificationRequestInfo.attributes.type",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1},{name:"CertificationRequestInfo.attributes.value",tagClass:R.Class.UNIVERSAL,type:R.Type.SET,constructed:!0}]}]}]},Nxe={name:"CertificationRequest",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,captureAsn1:"csr",value:[kxe,{name:"CertificationRequest.signatureAlgorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.SEQUENCE,constructed:!0,value:[{name:"CertificationRequest.signatureAlgorithm.algorithm",tagClass:R.Class.UNIVERSAL,type:R.Type.OID,constructed:!1,capture:"csrSignatureOid"},{name:"CertificationRequest.signatureAlgorithm.parameters",tagClass:R.Class.UNIVERSAL,optional:!0,captureAsn1:"csrSignatureParams"}]},{name:"CertificationRequest.signature",tagClass:R.Class.UNIVERSAL,type:R.Type.BITSTRING,constructed:!1,captureBitStringValue:"csrSignature"}]};j.RDNAttributesAsArray=function(r,e){for(var t=[],n,s,i,o=0;o<r.value.length;++o){n=r.value[o];for(var a=0;a<n.value.length;++a)i={},s=n.value[a],i.type=R.derToOid(s.value[0].value),i.value=s.value[1].value,i.valueTagClass=s.value[1].type,i.type in _e&&(i.name=_e[i.type],i.name in mt&&(i.shortName=mt[i.name])),e&&(e.update(i.type),e.update(i.value)),t.push(i)}return t};j.CRIAttributesAsArray=function(r){for(var e=[],t=0;t<r.length;++t)for(var n=r[t],s=R.derToOid(n.value[0].value),i=n.value[1].value,o=0;o<i.length;++o){var a={};if(a.type=s,a.value=i[o].value,a.valueTagClass=i[o].type,a.type in _e&&(a.name=_e[a.type],a.name in mt&&(a.shortName=mt[a.name])),a.type===_e.extensionRequest){a.extensions=[];for(var c=0;c<a.value.length;++c)a.extensions.push(j.certificateExtensionFromAsn1(a.value[c]))}e.push(a)}return e};function Fo(r,e){typeof e=="string"&&(e={shortName:e});for(var t=null,n,s=0;t===null&&s<r.attributes.length;++s)n=r.attributes[s],(e.type&&e.type===n.type||e.name&&e.name===n.name||e.shortName&&e.shortName===n.shortName)&&(t=n);return t}var _0=function(r,e,t){var n={};if(r!==_e["RSASSA-PSS"])return n;t&&(n={hash:{algorithmOid:_e.sha1},mgf:{algorithmOid:_e.mgf1,hash:{algorithmOid:_e.sha1}},saltLength:20});var s={},i=[];if(!R.validate(e,Pxe,s,i)){var o=new Error("Cannot read RSASSA-PSS parameter block.");throw o.errors=i,o}return s.hashOid!==void 0&&(n.hash=n.hash||{},n.hash.algorithmOid=R.derToOid(s.hashOid)),s.maskGenOid!==void 0&&(n.mgf=n.mgf||{},n.mgf.algorithmOid=R.derToOid(s.maskGenOid),n.mgf.hash=n.mgf.hash||{},n.mgf.hash.algorithmOid=R.derToOid(s.maskGenHashOid)),s.saltLength!==void 0&&(n.saltLength=s.saltLength.charCodeAt(0)),n},hg=function(r){switch(_e[r.signatureOid]){case"sha1WithRSAEncryption":case"sha1WithRSASignature":return Z.md.sha1.create();case"md5WithRSAEncryption":return Z.md.md5.create();case"sha256WithRSAEncryption":return Z.md.sha256.create();case"sha384WithRSAEncryption":return Z.md.sha384.create();case"sha512WithRSAEncryption":return Z.md.sha512.create();case"RSASSA-PSS":return Z.md.sha256.create();default:var e=new Error("Could not compute "+r.type+" digest. Unknown signature OID.");throw e.signatureOid=r.signatureOid,e}},lL=function(r){var e=r.certificate,t;switch(e.signatureOid){case _e.sha1WithRSAEncryption:case _e.sha1WithRSASignature:break;case _e["RSASSA-PSS"]:var n,s;if(n=_e[e.signatureParameters.mgf.hash.algorithmOid],n===void 0||Z.md[n]===void 0){var i=new Error("Unsupported MGF hash function.");throw i.oid=e.signatureParameters.mgf.hash.algorithmOid,i.name=n,i}if(s=_e[e.signatureParameters.mgf.algorithmOid],s===void 0||Z.mgf[s]===void 0){var i=new Error("Unsupported MGF function.");throw i.oid=e.signatureParameters.mgf.algorithmOid,i.name=s,i}if(s=Z.mgf[s].create(Z.md[n].create()),n=_e[e.signatureParameters.hash.algorithmOid],n===void 0||Z.md[n]===void 0){var i=new Error("Unsupported RSASSA-PSS hash function.");throw i.oid=e.signatureParameters.hash.algorithmOid,i.name=n,i}t=Z.pss.create(Z.md[n].create(),s,e.signatureParameters.saltLength);break}return e.publicKey.verify(r.md.digest().getBytes(),r.signature,t)};j.certificateFromPem=function(r,e,t){var n=Z.pem.decode(r)[0];if(n.type!=="CERTIFICATE"&&n.type!=="X509 CERTIFICATE"&&n.type!=="TRUSTED CERTIFICATE"){var s=new Error('Could not convert certificate from PEM; PEM header type is not "CERTIFICATE", "X509 CERTIFICATE", or "TRUSTED CERTIFICATE".');throw s.headerType=n.type,s}if(n.procType&&n.procType.type==="ENCRYPTED")throw new Error("Could not convert certificate from PEM; PEM is encrypted.");var i=R.fromDer(n.body,t);return j.certificateFromAsn1(i,e)};j.certificateToPem=function(r,e){var t={type:"CERTIFICATE",body:R.toDer(j.certificateToAsn1(r)).getBytes()};return Z.pem.encode(t,{maxline:e})};j.publicKeyFromPem=function(r){var e=Z.pem.decode(r)[0];if(e.type!=="PUBLIC KEY"&&e.type!=="RSA PUBLIC KEY"){var t=new Error('Could not convert public key from PEM; PEM header type is not "PUBLIC KEY" or "RSA PUBLIC KEY".');throw t.headerType=e.type,t}if(e.procType&&e.procType.type==="ENCRYPTED")throw new Error("Could not convert public key from PEM; PEM is encrypted.");var n=R.fromDer(e.body);return j.publicKeyFromAsn1(n)};j.publicKeyToPem=function(r,e){var t={type:"PUBLIC KEY",body:R.toDer(j.publicKeyToAsn1(r)).getBytes()};return Z.pem.encode(t,{maxline:e})};j.publicKeyToRSAPublicKeyPem=function(r,e){var t={type:"RSA PUBLIC KEY",body:R.toDer(j.publicKeyToRSAPublicKey(r)).getBytes()};return Z.pem.encode(t,{maxline:e})};j.getPublicKeyFingerprint=function(r,e){e=e||{};var t=e.md||Z.md.sha1.create(),n=e.type||"RSAPublicKey",s;switch(n){case"RSAPublicKey":s=R.toDer(j.publicKeyToRSAPublicKey(r)).getBytes();break;case"SubjectPublicKeyInfo":s=R.toDer(j.publicKeyToAsn1(r)).getBytes();break;default:throw new Error('Unknown fingerprint type "'+e.type+'".')}t.start(),t.update(s);var i=t.digest();if(e.encoding==="hex"){var o=i.toHex();return e.delimiter?o.match(/.{2}/g).join(e.delimiter):o}else{if(e.encoding==="binary")return i.getBytes();if(e.encoding)throw new Error('Unknown encoding "'+e.encoding+'".')}return i};j.certificationRequestFromPem=function(r,e,t){var n=Z.pem.decode(r)[0];if(n.type!=="CERTIFICATE REQUEST"){var s=new Error('Could not convert certification request from PEM; PEM header type is not "CERTIFICATE REQUEST".');throw s.headerType=n.type,s}if(n.procType&&n.procType.type==="ENCRYPTED")throw new Error("Could not convert certification request from PEM; PEM is encrypted.");var i=R.fromDer(n.body,t);return j.certificationRequestFromAsn1(i,e)};j.certificationRequestToPem=function(r,e){var t={type:"CERTIFICATE REQUEST",body:R.toDer(j.certificationRequestToAsn1(r)).getBytes()};return Z.pem.encode(t,{maxline:e})};j.createCertificate=function(){var r={};return r.version=2,r.serialNumber="00",r.signatureOid=null,r.signature=null,r.siginfo={},r.siginfo.algorithmOid=null,r.validity={},r.validity.notBefore=new Date,r.validity.notAfter=new Date,r.issuer={},r.issuer.getField=function(e){return Fo(r.issuer,e)},r.issuer.addField=function(e){Wn([e]),r.issuer.attributes.push(e)},r.issuer.attributes=[],r.issuer.hash=null,r.subject={},r.subject.getField=function(e){return Fo(r.subject,e)},r.subject.addField=function(e){Wn([e]),r.subject.attributes.push(e)},r.subject.attributes=[],r.subject.hash=null,r.extensions=[],r.publicKey=null,r.md=null,r.setSubject=function(e,t){Wn(e),r.subject.attributes=e,delete r.subject.uniqueId,t&&(r.subject.uniqueId=t),r.subject.hash=null},r.setIssuer=function(e,t){Wn(e),r.issuer.attributes=e,delete r.issuer.uniqueId,t&&(r.issuer.uniqueId=t),r.issuer.hash=null},r.setExtensions=function(e){for(var t=0;t<e.length;++t)uL(e[t],{cert:r});r.extensions=e},r.getExtension=function(e){typeof e=="string"&&(e={name:e});for(var t=null,n,s=0;t===null&&s<r.extensions.length;++s)n=r.extensions[s],(e.id&&n.id===e.id||e.name&&n.name===e.name)&&(t=n);return t},r.sign=function(e,t){r.md=t||Z.md.sha1.create();var n=_e[r.md.algorithm+"WithRSAEncryption"];if(!n){var s=new Error("Could not compute certificate digest. Unknown message digest algorithm OID.");throw s.algorithm=r.md.algorithm,s}r.signatureOid=r.siginfo.algorithmOid=n,r.tbsCertificate=j.getTBSCertificate(r);var i=R.toDer(r.tbsCertificate);r.md.update(i.getBytes()),r.signature=e.sign(r.md)},r.verify=function(e){var t=!1;if(!r.issued(e)){var n=e.issuer,s=r.subject,i=new Error("The parent certificate did not issue the given child certificate; the child certificate's issuer does not match the parent's subject.");throw i.expectedIssuer=s.attributes,i.actualIssuer=n.attributes,i}var o=e.md;if(o===null){o=hg({signatureOid:e.signatureOid,type:"certificate"});var a=e.tbsCertificate||j.getTBSCertificate(e),c=R.toDer(a);o.update(c.getBytes())}return o!==null&&(t=lL({certificate:r,md:o,signature:e.signature})),t},r.isIssuer=function(e){var t=!1,n=r.issuer,s=e.subject;if(n.hash&&s.hash)t=n.hash===s.hash;else if(n.attributes.length===s.attributes.length){t=!0;for(var i,o,a=0;t&&a<n.attributes.length;++a)i=n.attributes[a],o=s.attributes[a],(i.type!==o.type||i.value!==o.value)&&(t=!1)}return t},r.issued=function(e){return e.isIssuer(r)},r.generateSubjectKeyIdentifier=function(){return j.getPublicKeyFingerprint(r.publicKey,{type:"RSAPublicKey"})},r.verifySubjectKeyIdentifier=function(){for(var e=_e.subjectKeyIdentifier,t=0;t<r.extensions.length;++t){var n=r.extensions[t];if(n.id===e){var s=r.generateSubjectKeyIdentifier().getBytes();return Z.util.hexToBytes(n.subjectKeyIdentifier)===s}}return!1},r};j.certificateFromAsn1=function(r,e){var t={},n=[];if(!R.validate(r,Oxe,t,n)){var s=new Error("Cannot read X.509 certificate. ASN.1 object is not an X509v3 Certificate.");throw s.errors=n,s}var i=R.derToOid(t.publicKeyOid);if(i!==j.oids.rsaEncryption)throw new Error("Cannot read public key. OID is not RSA.");var o=j.createCertificate();o.version=t.certVersion?t.certVersion.charCodeAt(0):0;var a=Z.util.createBuffer(t.certSerialNumber);o.serialNumber=a.toHex(),o.signatureOid=Z.asn1.derToOid(t.certSignatureOid),o.signatureParameters=_0(o.signatureOid,t.certSignatureParams,!0),o.siginfo.algorithmOid=Z.asn1.derToOid(t.certinfoSignatureOid),o.siginfo.parameters=_0(o.siginfo.algorithmOid,t.certinfoSignatureParams,!1),o.signature=t.certSignature;var c=[];if(t.certValidity1UTCTime!==void 0&&c.push(R.utcTimeToDate(t.certValidity1UTCTime)),t.certValidity2GeneralizedTime!==void 0&&c.push(R.generalizedTimeToDate(t.certValidity2GeneralizedTime)),t.certValidity3UTCTime!==void 0&&c.push(R.utcTimeToDate(t.certValidity3UTCTime)),t.certValidity4GeneralizedTime!==void 0&&c.push(R.generalizedTimeToDate(t.certValidity4GeneralizedTime)),c.length>2)throw new Error("Cannot read notBefore/notAfter validity times; more than two times were provided in the certificate.");if(c.length<2)throw new Error("Cannot read notBefore/notAfter validity times; they were not provided as either UTCTime or GeneralizedTime.");if(o.validity.notBefore=c[0],o.validity.notAfter=c[1],o.tbsCertificate=t.tbsCertificate,e){o.md=hg({signatureOid:o.signatureOid,type:"certificate"});var u=R.toDer(o.tbsCertificate);o.md.update(u.getBytes())}var l=Z.md.sha1.create(),d=R.toDer(t.certIssuer);l.update(d.getBytes()),o.issuer.getField=function(h){return Fo(o.issuer,h)},o.issuer.addField=function(h){Wn([h]),o.issuer.attributes.push(h)},o.issuer.attributes=j.RDNAttributesAsArray(t.certIssuer),t.certIssuerUniqueId&&(o.issuer.uniqueId=t.certIssuerUniqueId),o.issuer.hash=l.digest().toHex();var f=Z.md.sha1.create(),g=R.toDer(t.certSubject);return f.update(g.getBytes()),o.subject.getField=function(h){return Fo(o.subject,h)},o.subject.addField=function(h){Wn([h]),o.subject.attributes.push(h)},o.subject.attributes=j.RDNAttributesAsArray(t.certSubject),t.certSubjectUniqueId&&(o.subject.uniqueId=t.certSubjectUniqueId),o.subject.hash=f.digest().toHex(),t.certExtensions?o.extensions=j.certificateExtensionsFromAsn1(t.certExtensions):o.extensions=[],o.publicKey=j.publicKeyFromAsn1(t.subjectPublicKeyInfo),o};j.certificateExtensionsFromAsn1=function(r){for(var e=[],t=0;t<r.value.length;++t)for(var n=r.value[t],s=0;s<n.value.length;++s)e.push(j.certificateExtensionFromAsn1(n.value[s]));return e};j.certificateExtensionFromAsn1=function(r){var e={};if(e.id=R.derToOid(r.value[0].value),e.critical=!1,r.value[1].type===R.Type.BOOLEAN?(e.critical=r.value[1].value.charCodeAt(0)!==0,e.value=r.value[2].value):e.value=r.value[1].value,e.id in _e){if(e.name=_e[e.id],e.name==="keyUsage"){var t=R.fromDer(e.value),n=0,s=0;t.value.length>1&&(n=t.value.charCodeAt(1),s=t.value.length>2?t.value.charCodeAt(2):0),e.digitalSignature=(n&128)===128,e.nonRepudiation=(n&64)===64,e.keyEncipherment=(n&32)===32,e.dataEncipherment=(n&16)===16,e.keyAgreement=(n&8)===8,e.keyCertSign=(n&4)===4,e.cRLSign=(n&2)===2,e.encipherOnly=(n&1)===1,e.decipherOnly=(s&128)===128}else if(e.name==="basicConstraints"){var t=R.fromDer(e.value);t.value.length>0&&t.value[0].type===R.Type.BOOLEAN?e.cA=t.value[0].value.charCodeAt(0)!==0:e.cA=!1;var i=null;t.value.length>0&&t.value[0].type===R.Type.INTEGER?i=t.value[0].value:t.value.length>1&&(i=t.value[1].value),i!==null&&(e.pathLenConstraint=R.derToInteger(i))}else if(e.name==="extKeyUsage")for(var t=R.fromDer(e.value),o=0;o<t.value.length;++o){var a=R.derToOid(t.value[o].value);a in _e?e[_e[a]]=!0:e[a]=!0}else if(e.name==="nsCertType"){var t=R.fromDer(e.value),n=0;t.value.length>1&&(n=t.value.charCodeAt(1)),e.client=(n&128)===128,e.server=(n&64)===64,e.email=(n&32)===32,e.objsign=(n&16)===16,e.reserved=(n&8)===8,e.sslCA=(n&4)===4,e.emailCA=(n&2)===2,e.objCA=(n&1)===1}else if(e.name==="subjectAltName"||e.name==="issuerAltName"){e.altNames=[];for(var c,t=R.fromDer(e.value),u=0;u<t.value.length;++u){c=t.value[u];var l={type:c.type,value:c.value};switch(e.altNames.push(l),c.type){case 1:case 2:case 6:break;case 7:l.ip=Z.util.bytesToIP(c.value);break;case 8:l.oid=R.derToOid(c.value);break}}}else if(e.name==="subjectKeyIdentifier"){var t=R.fromDer(e.value);e.subjectKeyIdentifier=Z.util.bytesToHex(t.value)}}return e};j.certificationRequestFromAsn1=function(r,e){var t={},n=[];if(!R.validate(r,Nxe,t,n)){var s=new Error("Cannot read PKCS#10 certificate request. ASN.1 object is not a PKCS#10 CertificationRequest.");throw s.errors=n,s}var i=R.derToOid(t.publicKeyOid);if(i!==j.oids.rsaEncryption)throw new Error("Cannot read public key. OID is not RSA.");var o=j.createCertificationRequest();if(o.version=t.csrVersion?t.csrVersion.charCodeAt(0):0,o.signatureOid=Z.asn1.derToOid(t.csrSignatureOid),o.signatureParameters=_0(o.signatureOid,t.csrSignatureParams,!0),o.siginfo.algorithmOid=Z.asn1.derToOid(t.csrSignatureOid),o.siginfo.parameters=_0(o.siginfo.algorithmOid,t.csrSignatureParams,!1),o.signature=t.csrSignature,o.certificationRequestInfo=t.certificationRequestInfo,e){o.md=hg({signatureOid:o.signatureOid,type:"certification request"});var a=R.toDer(o.certificationRequestInfo);o.md.update(a.getBytes())}var c=Z.md.sha1.create();return o.subject.getField=function(u){return Fo(o.subject,u)},o.subject.addField=function(u){Wn([u]),o.subject.attributes.push(u)},o.subject.attributes=j.RDNAttributesAsArray(t.certificationRequestInfoSubject,c),o.subject.hash=c.digest().toHex(),o.publicKey=j.publicKeyFromAsn1(t.subjectPublicKeyInfo),o.getAttribute=function(u){return Fo(o,u)},o.addAttribute=function(u){Wn([u]),o.attributes.push(u)},o.attributes=j.CRIAttributesAsArray(t.certificationRequestInfoAttributes||[]),o};j.createCertificationRequest=function(){var r={};return r.version=0,r.signatureOid=null,r.signature=null,r.siginfo={},r.siginfo.algorithmOid=null,r.subject={},r.subject.getField=function(e){return Fo(r.subject,e)},r.subject.addField=function(e){Wn([e]),r.subject.attributes.push(e)},r.subject.attributes=[],r.subject.hash=null,r.publicKey=null,r.attributes=[],r.getAttribute=function(e){return Fo(r,e)},r.addAttribute=function(e){Wn([e]),r.attributes.push(e)},r.md=null,r.setSubject=function(e){Wn(e),r.subject.attributes=e,r.subject.hash=null},r.setAttributes=function(e){Wn(e),r.attributes=e},r.sign=function(e,t){r.md=t||Z.md.sha1.create();var n=_e[r.md.algorithm+"WithRSAEncryption"];if(!n){var s=new Error("Could not compute certification request digest. Unknown message digest algorithm OID.");throw s.algorithm=r.md.algorithm,s}r.signatureOid=r.siginfo.algorithmOid=n,r.certificationRequestInfo=j.getCertificationRequestInfo(r);var i=R.toDer(r.certificationRequestInfo);r.md.update(i.getBytes()),r.signature=e.sign(r.md)},r.verify=function(){var e=!1,t=r.md;if(t===null){t=hg({signatureOid:r.signatureOid,type:"certification request"});var n=r.certificationRequestInfo||j.getCertificationRequestInfo(r),s=R.toDer(n);t.update(s.getBytes())}return t!==null&&(e=lL({certificate:r,md:t,signature:r.signature})),e},r};function yl(r){for(var e=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]),t,n,s=r.attributes,i=0;i<s.length;++i){t=s[i];var o=t.value,a=R.Type.PRINTABLESTRING;"valueTagClass"in t&&(a=t.valueTagClass,a===R.Type.UTF8&&(o=Z.util.encodeUtf8(o))),n=R.create(R.Class.UNIVERSAL,R.Type.SET,!0,[R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(t.type).getBytes()),R.create(R.Class.UNIVERSAL,a,!1,o)])]),e.value.push(n)}return e}function Wn(r){for(var e,t=0;t<r.length;++t){if(e=r[t],typeof e.name>"u"&&(e.type&&e.type in j.oids?e.name=j.oids[e.type]:e.shortName&&e.shortName in mt&&(e.name=j.oids[mt[e.shortName]])),typeof e.type>"u")if(e.name&&e.name in j.oids)e.type=j.oids[e.name];else{var n=new Error("Attribute type not specified.");throw n.attribute=e,n}if(typeof e.shortName>"u"&&e.name&&e.name in mt&&(e.shortName=mt[e.name]),e.type===_e.extensionRequest&&(e.valueConstructed=!0,e.valueTagClass=R.Type.SEQUENCE,!e.value&&e.extensions)){e.value=[];for(var s=0;s<e.extensions.length;++s)e.value.push(j.certificateExtensionToAsn1(uL(e.extensions[s])))}if(typeof e.value>"u"){var n=new Error("Attribute value not specified.");throw n.attribute=e,n}}}function uL(r,e){if(e=e||{},typeof r.name>"u"&&r.id&&r.id in j.oids&&(r.name=j.oids[r.id]),typeof r.id>"u")if(r.name&&r.name in j.oids)r.id=j.oids[r.name];else{var t=new Error("Extension ID not specified.");throw t.extension=r,t}if(typeof r.value<"u")return r;if(r.name==="keyUsage"){var n=0,s=0,i=0;r.digitalSignature&&(s|=128,n=7),r.nonRepudiation&&(s|=64,n=6),r.keyEncipherment&&(s|=32,n=5),r.dataEncipherment&&(s|=16,n=4),r.keyAgreement&&(s|=8,n=3),r.keyCertSign&&(s|=4,n=2),r.cRLSign&&(s|=2,n=1),r.encipherOnly&&(s|=1,n=0),r.decipherOnly&&(i|=128,n=7);var o=String.fromCharCode(n);i!==0?o+=String.fromCharCode(s)+String.fromCharCode(i):s!==0&&(o+=String.fromCharCode(s)),r.value=R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,o)}else if(r.name==="basicConstraints")r.value=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]),r.cA&&r.value.value.push(R.create(R.Class.UNIVERSAL,R.Type.BOOLEAN,!1,String.fromCharCode(255))),"pathLenConstraint"in r&&r.value.value.push(R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,R.integerToDer(r.pathLenConstraint).getBytes()));else if(r.name==="extKeyUsage"){r.value=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);var a=r.value.value;for(var c in r)r[c]===!0&&(c in _e?a.push(R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(_e[c]).getBytes())):c.indexOf(".")!==-1&&a.push(R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(c).getBytes())))}else if(r.name==="nsCertType"){var n=0,s=0;r.client&&(s|=128,n=7),r.server&&(s|=64,n=6),r.email&&(s|=32,n=5),r.objsign&&(s|=16,n=4),r.reserved&&(s|=8,n=3),r.sslCA&&(s|=4,n=2),r.emailCA&&(s|=2,n=1),r.objCA&&(s|=1,n=0);var o=String.fromCharCode(n);s!==0&&(o+=String.fromCharCode(s)),r.value=R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,o)}else if(r.name==="subjectAltName"||r.name==="issuerAltName"){r.value=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);for(var u,l=0;l<r.altNames.length;++l){u=r.altNames[l];var o=u.value;if(u.type===7&&u.ip){if(o=Z.util.bytesFromIP(u.ip),o===null){var t=new Error('Extension "ip" value is not a valid IPv4 or IPv6 address.');throw t.extension=r,t}}else u.type===8&&(u.oid?o=R.oidToDer(R.oidToDer(u.oid)):o=R.oidToDer(o));r.value.value.push(R.create(R.Class.CONTEXT_SPECIFIC,u.type,!1,o))}}else if(r.name==="nsComment"&&e.cert){if(!/^[\x00-\x7F]*$/.test(r.comment)||r.comment.length<1||r.comment.length>128)throw new Error('Invalid "nsComment" content.');r.value=R.create(R.Class.UNIVERSAL,R.Type.IA5STRING,!1,r.comment)}else if(r.name==="subjectKeyIdentifier"&&e.cert){var d=e.cert.generateSubjectKeyIdentifier();r.subjectKeyIdentifier=d.toHex(),r.value=R.create(R.Class.UNIVERSAL,R.Type.OCTETSTRING,!1,d.getBytes())}else if(r.name==="authorityKeyIdentifier"&&e.cert){r.value=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);var a=r.value.value;if(r.keyIdentifier){var f=r.keyIdentifier===!0?e.cert.generateSubjectKeyIdentifier().getBytes():r.keyIdentifier;a.push(R.create(R.Class.CONTEXT_SPECIFIC,0,!1,f))}if(r.authorityCertIssuer){var g=[R.create(R.Class.CONTEXT_SPECIFIC,4,!0,[yl(r.authorityCertIssuer===!0?e.cert.issuer:r.authorityCertIssuer)])];a.push(R.create(R.Class.CONTEXT_SPECIFIC,1,!0,g))}if(r.serialNumber){var h=Z.util.hexToBytes(r.serialNumber===!0?e.cert.serialNumber:r.serialNumber);a.push(R.create(R.Class.CONTEXT_SPECIFIC,2,!1,h))}}else if(r.name==="cRLDistributionPoints"){r.value=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);for(var a=r.value.value,p=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]),w=R.create(R.Class.CONTEXT_SPECIFIC,0,!0,[]),u,l=0;l<r.altNames.length;++l){u=r.altNames[l];var o=u.value;if(u.type===7&&u.ip){if(o=Z.util.bytesFromIP(u.ip),o===null){var t=new Error('Extension "ip" value is not a valid IPv4 or IPv6 address.');throw t.extension=r,t}}else u.type===8&&(u.oid?o=R.oidToDer(R.oidToDer(u.oid)):o=R.oidToDer(o));w.value.push(R.create(R.Class.CONTEXT_SPECIFIC,u.type,!1,o))}p.value.push(R.create(R.Class.CONTEXT_SPECIFIC,0,!0,[w])),a.push(p)}if(typeof r.value>"u"){var t=new Error("Extension value not specified.");throw t.extension=r,t}return r}function o8(r,e){switch(r){case _e["RSASSA-PSS"]:var t=[];return e.hash.algorithmOid!==void 0&&t.push(R.create(R.Class.CONTEXT_SPECIFIC,0,!0,[R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(e.hash.algorithmOid).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.NULL,!1,"")])])),e.mgf.algorithmOid!==void 0&&t.push(R.create(R.Class.CONTEXT_SPECIFIC,1,!0,[R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(e.mgf.algorithmOid).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(e.mgf.hash.algorithmOid).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.NULL,!1,"")])])])),e.saltLength!==void 0&&t.push(R.create(R.Class.CONTEXT_SPECIFIC,2,!0,[R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,R.integerToDer(e.saltLength).getBytes())])),R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,t);default:return R.create(R.Class.UNIVERSAL,R.Type.NULL,!1,"")}}function Lxe(r){var e=R.create(R.Class.CONTEXT_SPECIFIC,0,!0,[]);if(r.attributes.length===0)return e;for(var t=r.attributes,n=0;n<t.length;++n){var s=t[n],i=s.value,o=R.Type.UTF8;"valueTagClass"in s&&(o=s.valueTagClass),o===R.Type.UTF8&&(i=Z.util.encodeUtf8(i));var a=!1;"valueConstructed"in s&&(a=s.valueConstructed);var c=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(s.type).getBytes()),R.create(R.Class.UNIVERSAL,R.Type.SET,!0,[R.create(R.Class.UNIVERSAL,o,a,i)])]);e.value.push(c)}return e}var Mxe=new Date("1950-01-01T00:00:00Z"),Uxe=new Date("2050-01-01T00:00:00Z");function m$(r){return r>=Mxe&&r<Uxe?R.create(R.Class.UNIVERSAL,R.Type.UTCTIME,!1,R.dateToUtcTime(r)):R.create(R.Class.UNIVERSAL,R.Type.GENERALIZEDTIME,!1,R.dateToGeneralizedTime(r))}j.getTBSCertificate=function(r){var e=m$(r.validity.notBefore),t=m$(r.validity.notAfter),n=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.CONTEXT_SPECIFIC,0,!0,[R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,R.integerToDer(r.version).getBytes())]),R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,Z.util.hexToBytes(r.serialNumber)),R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(r.siginfo.algorithmOid).getBytes()),o8(r.siginfo.algorithmOid,r.siginfo.parameters)]),yl(r.issuer),R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[e,t]),yl(r.subject),j.publicKeyToAsn1(r.publicKey)]);return r.issuer.uniqueId&&n.value.push(R.create(R.Class.CONTEXT_SPECIFIC,1,!0,[R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,String.fromCharCode(0)+r.issuer.uniqueId)])),r.subject.uniqueId&&n.value.push(R.create(R.Class.CONTEXT_SPECIFIC,2,!0,[R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,String.fromCharCode(0)+r.subject.uniqueId)])),r.extensions.length>0&&n.value.push(j.certificateExtensionsToAsn1(r.extensions)),n};j.getCertificationRequestInfo=function(r){var e=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.INTEGER,!1,R.integerToDer(r.version).getBytes()),yl(r.subject),j.publicKeyToAsn1(r.publicKey),Lxe(r)]);return e};j.distinguishedNameToAsn1=function(r){return yl(r)};j.certificateToAsn1=function(r){var e=r.tbsCertificate||j.getTBSCertificate(r);return R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[e,R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(r.signatureOid).getBytes()),o8(r.signatureOid,r.signatureParameters)]),R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,String.fromCharCode(0)+r.signature)])};j.certificateExtensionsToAsn1=function(r){var e=R.create(R.Class.CONTEXT_SPECIFIC,3,!0,[]),t=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);e.value.push(t);for(var n=0;n<r.length;++n)t.value.push(j.certificateExtensionToAsn1(r[n]));return e};j.certificateExtensionToAsn1=function(r){var e=R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[]);e.value.push(R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(r.id).getBytes())),r.critical&&e.value.push(R.create(R.Class.UNIVERSAL,R.Type.BOOLEAN,!1,String.fromCharCode(255)));var t=r.value;return typeof r.value!="string"&&(t=R.toDer(t).getBytes()),e.value.push(R.create(R.Class.UNIVERSAL,R.Type.OCTETSTRING,!1,t)),e};j.certificationRequestToAsn1=function(r){var e=r.certificationRequestInfo||j.getCertificationRequestInfo(r);return R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[e,R.create(R.Class.UNIVERSAL,R.Type.SEQUENCE,!0,[R.create(R.Class.UNIVERSAL,R.Type.OID,!1,R.oidToDer(r.signatureOid).getBytes()),o8(r.signatureOid,r.signatureParameters)]),R.create(R.Class.UNIVERSAL,R.Type.BITSTRING,!1,String.fromCharCode(0)+r.signature)])};j.createCaStore=function(r){var e={certs:{}};e.getIssuer=function(o){var a=t(o.issuer);return a},e.addCertificate=function(o){if(typeof o=="string"&&(o=Z.pki.certificateFromPem(o)),n(o.subject),!e.hasCertificate(o))if(o.subject.hash in e.certs){var a=e.certs[o.subject.hash];Z.util.isArray(a)||(a=[a]),a.push(o),e.certs[o.subject.hash]=a}else e.certs[o.subject.hash]=o},e.hasCertificate=function(o){typeof o=="string"&&(o=Z.pki.certificateFromPem(o));var a=t(o.subject);if(!a)return!1;Z.util.isArray(a)||(a=[a]);for(var c=R.toDer(j.certificateToAsn1(o)).getBytes(),u=0;u<a.length;++u){var l=R.toDer(j.certificateToAsn1(a[u])).getBytes();if(c===l)return!0}return!1},e.listAllCertificates=function(){var o=[];for(var a in e.certs)if(e.certs.hasOwnProperty(a)){var c=e.certs[a];if(!Z.util.isArray(c))o.push(c);else for(var u=0;u<c.length;++u)o.push(c[u])}return o},e.removeCertificate=function(o){var a;if(typeof o=="string"&&(o=Z.pki.certificateFromPem(o)),n(o.subject),!e.hasCertificate(o))return null;var c=t(o.subject);if(!Z.util.isArray(c))return a=e.certs[o.subject.hash],delete e.certs[o.subject.hash],a;for(var u=R.toDer(j.certificateToAsn1(o)).getBytes(),l=0;l<c.length;++l){var d=R.toDer(j.certificateToAsn1(c[l])).getBytes();u===d&&(a=c[l],c.splice(l,1))}return c.length===0&&delete e.certs[o.subject.hash],a};function t(o){return n(o),e.certs[o.hash]||null}function n(o){if(!o.hash){var a=Z.md.sha1.create();o.attributes=j.RDNAttributesAsArray(yl(o),a),o.hash=a.digest().toHex()}}if(r)for(var s=0;s<r.length;++s){var i=r[s];e.addCertificate(i)}return e};j.certificateError={bad_certificate:"forge.pki.BadCertificate",unsupported_certificate:"forge.pki.UnsupportedCertificate",certificate_revoked:"forge.pki.CertificateRevoked",certificate_expired:"forge.pki.CertificateExpired",certificate_unknown:"forge.pki.CertificateUnknown",unknown_ca:"forge.pki.UnknownCertificateAuthority"};j.verifyCertificateChain=function(r,e,t){typeof t=="function"&&(t={verify:t}),t=t||{},e=e.slice(0);var n=e.slice(0),s=t.validityCheckDate;typeof s>"u"&&(s=new Date);var i=!0,o=null,a=0;do{var c=e.shift(),u=null,l=!1;if(s&&(s<c.validity.notBefore||s>c.validity.notAfter)&&(o={message:"Certificate is not valid yet or has expired.",error:j.certificateError.certificate_expired,notBefore:c.validity.notBefore,notAfter:c.validity.notAfter,now:s}),o===null){if(u=e[0]||r.getIssuer(c),u===null&&c.isIssuer(c)&&(l=!0,u=c),u){var d=u;Z.util.isArray(d)||(d=[d]);for(var f=!1;!f&&d.length>0;){u=d.shift();try{f=u.verify(c)}catch{}}f||(o={message:"Certificate signature is invalid.",error:j.certificateError.bad_certificate})}o===null&&(!u||l)&&!r.hasCertificate(c)&&(o={message:"Certificate is not trusted.",error:j.certificateError.unknown_ca})}if(o===null&&u&&!c.isIssuer(u)&&(o={message:"Certificate issuer is invalid.",error:j.certificateError.bad_certificate}),o===null)for(var g={keyUsage:!0,basicConstraints:!0},h=0;o===null&&h<c.extensions.length;++h){var p=c.extensions[h];p.critical&&!(p.name in g)&&(o={message:"Certificate has an unsupported critical extension.",error:j.certificateError.unsupported_certificate})}if(o===null&&(!i||e.length===0&&(!u||l))){var w=c.getExtension("basicConstraints"),y=c.getExtension("keyUsage");if(y!==null&&(!y.keyCertSign||w===null)&&(o={message:"Certificate keyUsage or basicConstraints conflict or indicate that the certificate is not a CA. If the certificate is the only one in the chain or isn't the first then the certificate must be a valid CA.",error:j.certificateError.bad_certificate}),o===null&&w!==null&&!w.cA&&(o={message:"Certificate basicConstraints indicates the certificate is not a CA.",error:j.certificateError.bad_certificate}),o===null&&y!==null&&"pathLenConstraint"in w){var E=a-1;E>w.pathLenConstraint&&(o={message:"Certificate basicConstraints pathLenConstraint violated.",error:j.certificateError.bad_certificate})}}var m=o===null?!0:o.error,b=t.verify?t.verify(m,a,n):m;if(b===!0)o=null;else throw m===!0&&(o={message:"The application rejected the certificate.",error:j.certificateError.bad_certificate}),(b||b===0)&&(typeof b=="object"&&!Z.util.isArray(b)?(b.message&&(o.message=b.message),b.error&&(o.error=b.error)):typeof b=="string"&&(o.error=b)),o;i=!1,++a}while(e.length>0);return!0};var K=_l,I=K.asn1,Gr=K.pkcs7=K.pkcs7||{};Gr.messageFromPem=function(r){var e=K.pem.decode(r)[0];if(e.type!=="PKCS7"){var t=new Error('Could not convert PKCS#7 message from PEM; PEM header type is not "PKCS#7".');throw t.headerType=e.type,t}if(e.procType&&e.procType.type==="ENCRYPTED")throw new Error("Could not convert PKCS#7 message from PEM; PEM is encrypted.");var n=I.fromDer(e.body);return Gr.messageFromAsn1(n)};Gr.messageToPem=function(r,e){var t={type:"PKCS7",body:I.toDer(r.toAsn1()).getBytes()};return K.pem.encode(t,{maxline:e})};Gr.messageFromAsn1=function(r){var e={},t=[];if(!I.validate(r,Gr.asn1.contentInfoValidator,e,t)){var n=new Error("Cannot read PKCS#7 message. ASN.1 object is not an PKCS#7 ContentInfo.");throw n.errors=t,n}var s=I.derToOid(e.contentType),i;switch(s){case K.pki.oids.envelopedData:i=Gr.createEnvelopedData();break;case K.pki.oids.encryptedData:i=Gr.createEncryptedData();break;case K.pki.oids.signedData:i=Gr.createSignedData();break;default:throw new Error("Cannot read PKCS#7 message. ContentType with OID "+s+" is not (yet) supported.")}return i.fromAsn1(e.content.value[0]),i};Gr.createSignedData=function(){var r=null;return r={type:K.pki.oids.signedData,version:1,certificates:[],crls:[],signers:[],digestAlgorithmIdentifiers:[],contentInfo:null,signerInfos:[],fromAsn1:function(n){if(a8(r,n,Gr.asn1.signedDataValidator),r.certificates=[],r.crls=[],r.digestAlgorithmIdentifiers=[],r.contentInfo=null,r.signerInfos=[],r.rawCapture.certificates)for(var s=r.rawCapture.certificates.value,i=0;i<s.length;++i)r.certificates.push(K.pki.certificateFromAsn1(s[i]))},toAsn1:function(){r.contentInfo||r.sign();for(var n=[],s=0;s<r.certificates.length;++s)n.push(K.pki.certificateToAsn1(r.certificates[s]));var i=[],o=I.create(I.Class.CONTEXT_SPECIFIC,0,!0,[I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.INTEGER,!1,I.integerToDer(r.version).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.SET,!0,r.digestAlgorithmIdentifiers),r.contentInfo])]);return n.length>0&&o.value[0].value.push(I.create(I.Class.CONTEXT_SPECIFIC,0,!0,n)),i.length>0&&o.value[0].value.push(I.create(I.Class.CONTEXT_SPECIFIC,1,!0,i)),o.value[0].value.push(I.create(I.Class.UNIVERSAL,I.Type.SET,!0,r.signerInfos)),I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.type).getBytes()),o])},addSigner:function(n){var s=n.issuer,i=n.serialNumber;if(n.certificate){var o=n.certificate;typeof o=="string"&&(o=K.pki.certificateFromPem(o)),s=o.issuer.attributes,i=o.serialNumber}var a=n.key;if(!a)throw new Error("Could not add PKCS#7 signer; no private key specified.");typeof a=="string"&&(a=K.pki.privateKeyFromPem(a));var c=n.digestAlgorithm||K.pki.oids.sha1;switch(c){case K.pki.oids.sha1:case K.pki.oids.sha256:case K.pki.oids.sha384:case K.pki.oids.sha512:case K.pki.oids.md5:break;default:throw new Error("Could not add PKCS#7 signer; unknown message digest algorithm: "+c)}var u=n.authenticatedAttributes||[];if(u.length>0){for(var l=!1,d=!1,f=0;f<u.length;++f){var g=u[f];if(!l&&g.type===K.pki.oids.contentType){if(l=!0,d)break;continue}if(!d&&g.type===K.pki.oids.messageDigest){if(d=!0,l)break;continue}}if(!l||!d)throw new Error("Invalid signer.authenticatedAttributes. If signer.authenticatedAttributes is specified, then it must contain at least two attributes, PKCS #9 content-type and PKCS #9 message-digest.")}r.signers.push({key:a,version:1,issuer:s,serialNumber:i,digestAlgorithm:c,signatureAlgorithm:K.pki.oids.rsaEncryption,signature:null,authenticatedAttributes:u,unauthenticatedAttributes:[]})},sign:function(n){if(n=n||{},(typeof r.content!="object"||r.contentInfo===null)&&(r.contentInfo=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(K.pki.oids.data).getBytes())]),"content"in r)){var s;r.content instanceof K.util.ByteBuffer?s=r.content.bytes():typeof r.content=="string"&&(s=K.util.encodeUtf8(r.content)),n.detached?r.detachedContent=I.create(I.Class.UNIVERSAL,I.Type.OCTETSTRING,!1,s):r.contentInfo.value.push(I.create(I.Class.CONTEXT_SPECIFIC,0,!0,[I.create(I.Class.UNIVERSAL,I.Type.OCTETSTRING,!1,s)]))}if(r.signers.length!==0){var i=e();t(i)}},verify:function(){throw new Error("PKCS#7 signature verification not yet implemented.")},addCertificate:function(n){typeof n=="string"&&(n=K.pki.certificateFromPem(n)),r.certificates.push(n)},addCertificateRevokationList:function(n){throw new Error("PKCS#7 CRL support not yet implemented.")}},r;function e(){for(var n={},s=0;s<r.signers.length;++s){var i=r.signers[s],o=i.digestAlgorithm;o in n||(n[o]=K.md[K.pki.oids[o]].create()),i.authenticatedAttributes.length===0?i.md=n[o]:i.md=K.md[K.pki.oids[o]].create()}r.digestAlgorithmIdentifiers=[];for(var o in n)r.digestAlgorithmIdentifiers.push(I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(o).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.NULL,!1,"")]));return n}function t(n){var s;if(r.detachedContent?s=r.detachedContent:(s=r.contentInfo.value[1],s=s.value[0]),!s)throw new Error("Could not sign PKCS#7 message; there is no content to sign.");var i=I.derToOid(r.contentInfo.value[0].value),o=I.toDer(s);o.getByte(),I.getBerValueLength(o),o=o.getBytes();for(var a in n)n[a].start().update(o);for(var c=new Date,u=0;u<r.signers.length;++u){var l=r.signers[u];if(l.authenticatedAttributes.length===0){if(i!==K.pki.oids.data)throw new Error("Invalid signer; authenticatedAttributes must be present when the ContentInfo content type is not PKCS#7 Data.")}else{l.authenticatedAttributesAsn1=I.create(I.Class.CONTEXT_SPECIFIC,0,!0,[]);for(var d=I.create(I.Class.UNIVERSAL,I.Type.SET,!0,[]),f=0;f<l.authenticatedAttributes.length;++f){var g=l.authenticatedAttributes[f];g.type===K.pki.oids.messageDigest?g.value=n[l.digestAlgorithm].digest():g.type===K.pki.oids.signingTime&&(g.value||(g.value=c)),d.value.push(m6(g)),l.authenticatedAttributesAsn1.value.push(m6(g))}o=I.toDer(d).getBytes(),l.md.start().update(o)}l.signature=l.key.sign(l.md,"RSASSA-PKCS1-V1_5")}r.signerInfos=qxe(r.signers)}};Gr.createEncryptedData=function(){var r=null;return r={type:K.pki.oids.encryptedData,version:0,encryptedContent:{algorithm:K.pki.oids["aes256-CBC"]},fromAsn1:function(e){a8(r,e,Gr.asn1.encryptedDataValidator)},decrypt:function(e){e!==void 0&&(r.encryptedContent.key=e),dL(r)}},r};Gr.createEnvelopedData=function(){var r=null;return r={type:K.pki.oids.envelopedData,version:0,recipients:[],encryptedContent:{algorithm:K.pki.oids["aes256-CBC"]},fromAsn1:function(e){var t=a8(r,e,Gr.asn1.envelopedDataValidator);r.recipients=Fxe(t.recipientInfos.value)},toAsn1:function(){return I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.type).getBytes()),I.create(I.Class.CONTEXT_SPECIFIC,0,!0,[I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.INTEGER,!1,I.integerToDer(r.version).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.SET,!0,Vxe(r.recipients)),I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,Kxe(r.encryptedContent))])])])},findRecipient:function(e){for(var t=e.issuer.attributes,n=0;n<r.recipients.length;++n){var s=r.recipients[n],i=s.issuer;if(s.serialNumber===e.serialNumber&&i.length===t.length){for(var o=!0,a=0;a<t.length;++a)if(i[a].type!==t[a].type||i[a].value!==t[a].value){o=!1;break}if(o)return s}}return null},decrypt:function(e,t){if(r.encryptedContent.key===void 0&&e!==void 0&&t!==void 0)switch(e.encryptedContent.algorithm){case K.pki.oids.rsaEncryption:case K.pki.oids.desCBC:var n=t.decrypt(e.encryptedContent.content);r.encryptedContent.key=K.util.createBuffer(n);break;default:throw new Error("Unsupported asymmetric cipher, OID "+e.encryptedContent.algorithm)}dL(r)},addRecipient:function(e){r.recipients.push({version:0,issuer:e.issuer.attributes,serialNumber:e.serialNumber,encryptedContent:{algorithm:K.pki.oids.rsaEncryption,key:e.publicKey}})},encrypt:function(e,t){if(r.encryptedContent.content===void 0){t=t||r.encryptedContent.algorithm,e=e||r.encryptedContent.key;var n,s,i;switch(t){case K.pki.oids["aes128-CBC"]:n=16,s=16,i=K.aes.createEncryptionCipher;break;case K.pki.oids["aes192-CBC"]:n=24,s=16,i=K.aes.createEncryptionCipher;break;case K.pki.oids["aes256-CBC"]:n=32,s=16,i=K.aes.createEncryptionCipher;break;case K.pki.oids["des-EDE3-CBC"]:n=24,s=8,i=K.des.createEncryptionCipher;break;default:throw new Error("Unsupported symmetric cipher, OID "+t)}if(e===void 0)e=K.util.createBuffer(K.random.getBytes(n));else if(e.length()!=n)throw new Error("Symmetric key has wrong length; got "+e.length()+" bytes, expected "+n+".");r.encryptedContent.algorithm=t,r.encryptedContent.key=e,r.encryptedContent.parameter=K.util.createBuffer(K.random.getBytes(s));var o=i(e);if(o.start(r.encryptedContent.parameter.copy()),o.update(r.content),!o.finish())throw new Error("Symmetric encryption failed.");r.encryptedContent.content=o.output}for(var a=0;a<r.recipients.length;++a){var c=r.recipients[a];if(c.encryptedContent.content===void 0)switch(c.encryptedContent.algorithm){case K.pki.oids.rsaEncryption:c.encryptedContent.content=c.encryptedContent.key.encrypt(r.encryptedContent.key.data);break;default:throw new Error("Unsupported asymmetric cipher, OID "+c.encryptedContent.algorithm)}}}},r};function Bxe(r){var e={},t=[];if(!I.validate(r,Gr.asn1.recipientInfoValidator,e,t)){var n=new Error("Cannot read PKCS#7 RecipientInfo. ASN.1 object is not an PKCS#7 RecipientInfo.");throw n.errors=t,n}return{version:e.version.charCodeAt(0),issuer:K.pki.RDNAttributesAsArray(e.issuer),serialNumber:K.util.createBuffer(e.serial).toHex(),encryptedContent:{algorithm:I.derToOid(e.encAlgorithm),parameter:e.encParameter?e.encParameter.value:void 0,content:e.encKey}}}function zxe(r){return I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.INTEGER,!1,I.integerToDer(r.version).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[K.pki.distinguishedNameToAsn1({attributes:r.issuer}),I.create(I.Class.UNIVERSAL,I.Type.INTEGER,!1,K.util.hexToBytes(r.serialNumber))]),I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.encryptedContent.algorithm).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.NULL,!1,"")]),I.create(I.Class.UNIVERSAL,I.Type.OCTETSTRING,!1,r.encryptedContent.content)])}function Fxe(r){for(var e=[],t=0;t<r.length;++t)e.push(Bxe(r[t]));return e}function Vxe(r){for(var e=[],t=0;t<r.length;++t)e.push(zxe(r[t]));return e}function jxe(r){var e=I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.INTEGER,!1,I.integerToDer(r.version).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[K.pki.distinguishedNameToAsn1({attributes:r.issuer}),I.create(I.Class.UNIVERSAL,I.Type.INTEGER,!1,K.util.hexToBytes(r.serialNumber))]),I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.digestAlgorithm).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.NULL,!1,"")])]);if(r.authenticatedAttributesAsn1&&e.value.push(r.authenticatedAttributesAsn1),e.value.push(I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.signatureAlgorithm).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.NULL,!1,"")])),e.value.push(I.create(I.Class.UNIVERSAL,I.Type.OCTETSTRING,!1,r.signature)),r.unauthenticatedAttributes.length>0){for(var t=I.create(I.Class.CONTEXT_SPECIFIC,1,!0,[]),n=0;n<r.unauthenticatedAttributes.length;++n){var s=r.unauthenticatedAttributes[n];t.values.push(m6(s))}e.value.push(t)}return e}function qxe(r){for(var e=[],t=0;t<r.length;++t)e.push(jxe(r[t]));return e}function m6(r){var e;if(r.type===K.pki.oids.contentType)e=I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.value).getBytes());else if(r.type===K.pki.oids.messageDigest)e=I.create(I.Class.UNIVERSAL,I.Type.OCTETSTRING,!1,r.value.bytes());else if(r.type===K.pki.oids.signingTime){var t=new Date("1950-01-01T00:00:00Z"),n=new Date("2050-01-01T00:00:00Z"),s=r.value;if(typeof s=="string"){var i=Date.parse(s);isNaN(i)?s.length===13?s=I.utcTimeToDate(s):s=I.generalizedTimeToDate(s):s=new Date(i)}s>=t&&s<n?e=I.create(I.Class.UNIVERSAL,I.Type.UTCTIME,!1,I.dateToUtcTime(s)):e=I.create(I.Class.UNIVERSAL,I.Type.GENERALIZEDTIME,!1,I.dateToGeneralizedTime(s))}return I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.type).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.SET,!0,[e])])}function Kxe(r){return[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(K.pki.oids.data).getBytes()),I.create(I.Class.UNIVERSAL,I.Type.SEQUENCE,!0,[I.create(I.Class.UNIVERSAL,I.Type.OID,!1,I.oidToDer(r.algorithm).getBytes()),r.parameter?I.create(I.Class.UNIVERSAL,I.Type.OCTETSTRING,!1,r.parameter.getBytes()):void 0]),I.create(I.Class.CONTEXT_SPECIFIC,0,!0,[I.create(I.Class.UNIVERSAL,I.Type.OCTETSTRING,!1,r.content.getBytes())])]}function a8(r,e,t){var n={},s=[];if(!I.validate(e,t,n,s)){var i=new Error("Cannot read PKCS#7 message. ASN.1 object is not a supported PKCS#7 message.");throw i.errors=i,i}var o=I.derToOid(n.contentType);if(o!==K.pki.oids.data)throw new Error("Unsupported PKCS#7 message. Only wrapped ContentType Data supported.");if(n.encryptedContent){var a="";if(K.util.isArray(n.encryptedContent))for(var c=0;c<n.encryptedContent.length;++c){if(n.encryptedContent[c].type!==I.Type.OCTETSTRING)throw new Error("Malformed PKCS#7 message, expecting encrypted content constructed of only OCTET STRING objects.");a+=n.encryptedContent[c].value}else a=n.encryptedContent;r.encryptedContent={algorithm:I.derToOid(n.encAlgorithm),parameter:K.util.createBuffer(n.encParameter.value),content:K.util.createBuffer(a)}}if(n.content){var a="";if(K.util.isArray(n.content))for(var c=0;c<n.content.length;++c){if(n.content[c].type!==I.Type.OCTETSTRING)throw new Error("Malformed PKCS#7 message, expecting content constructed of only OCTET STRING objects.");a+=n.content[c].value}else a=n.content;r.content=K.util.createBuffer(a)}return r.version=n.version.charCodeAt(0),r.rawCapture=n,n}function dL(r){if(r.encryptedContent.key===void 0)throw new Error("Symmetric key not available.");if(r.content===void 0){var e;switch(r.encryptedContent.algorithm){case K.pki.oids["aes128-CBC"]:case K.pki.oids["aes192-CBC"]:case K.pki.oids["aes256-CBC"]:e=K.aes.createDecryptionCipher(r.encryptedContent.key);break;case K.pki.oids.desCBC:case K.pki.oids["des-EDE3-CBC"]:e=K.des.createDecryptionCipher(r.encryptedContent.key);break;default:throw new Error("Unsupported symmetric cipher, OID "+r.encryptedContent.algorithm)}if(e.start(r.encryptedContent.parameter),e.update(r.encryptedContent.content),!e.finish())throw new Error("Symmetric decryption failed.");r.content=e.output}}const E$=yi.pki,Gxe=(r,e)=>{const t=E$.rsa.setPublicKey(e.n,e.e),n=E$.createCertificate();n.publicKey=t,n.serialNumber="01",n.validity.notBefore=new Date,n.validity.notAfter=new Date,n.validity.notAfter.setFullYear(n.validity.notBefore.getFullYear()+10);const s=[{name:"organizationName",value:"ipfs"},{shortName:"OU",value:"keystore"},{name:"commonName",value:r.id}];return n.setSubject(s),n.setIssuer(s),n.setExtensions([{name:"basicConstraints",cA:!0},{name:"keyUsage",keyCertSign:!0,digitalSignature:!0,nonRepudiation:!0,keyEncipherment:!0,dataEncipherment:!0},{name:"extKeyUsage",serverAuth:!0,clientAuth:!0,codeSigning:!0,emailProtection:!0,timeStamping:!0},{name:"nsCertType",client:!0,server:!0,email:!0,objsign:!0,sslCA:!0,emailCA:!0,objCA:!0}]),n.sign(e),n};async function Hxe(r,e){const t=r.map(e),s=(await Promise.all(t)).findIndex(i=>i);return r[s]}const Wxe=N("libp2p:keychain:cms"),ew=new WeakMap;class Qxe{constructor(e,t){if(e==null)throw $(new Error("keychain is required"),O.ERR_KEYCHAIN_REQUIRED);this.keychain=e,ew.set(this,{dek:t})}async encrypt(e,t){if(!(t instanceof Uint8Array))throw $(new Error("Plain data must be a Uint8Array"),O.ERR_INVALID_PARAMETERS);const n=await this.keychain.findKeyByName(e),s=await this.keychain.getPrivateKey(e),i=ew.get(this);if(i==null)throw $(new Error("dek missing"),O.ERR_INVALID_PARAMETERS);const o=i.dek,a=yi.pki.decryptRsaPrivateKey(s,o),c=await Gxe(n,a),u=yi.pkcs7.createEnvelopedData();u.addRecipient(c),u.content=yi.util.createBuffer(t),u.encrypt();const l=yi.asn1.toDer(u.toAsn1()).getBytes();return L(l,"ascii")}async decrypt(e){if(!(e instanceof Uint8Array))throw $(new Error("CMS data is required"),O.ERR_INVALID_PARAMETERS);let t;try{const l=yi.util.createBuffer(C(e,"ascii")),d=yi.asn1.fromDer(l);t=yi.pkcs7.messageFromAsn1(d)}catch(l){throw Wxe.error(l),$(new Error("Invalid CMS"),O.ERR_INVALID_CMS)}const n=t.recipients.filter(l=>l.issuer.find(d=>d.shortName==="O"&&d.value==="ipfs")).filter(l=>l.issuer.find(d=>d.shortName==="CN")).map(l=>({recipient:l,keyId:l.issuer.find(d=>d.shortName==="CN").value})),s=await Hxe(n,async l=>{try{if(await this.keychain.findKeyById(l.keyId)!=null)return!0}catch{return!1}return!1});if(s==null){const l=n.map(d=>d.keyId);throw $(new Error(`Decryption needs one of the key(s): ${l.join(", ")}`),O.ERR_MISSING_KEYS,{missingKeys:l})}const i=await this.keychain.findKeyById(s.keyId);if(i==null)throw $(new Error("No key available to decrypto"),O.ERR_NO_KEY);const o=await this.keychain.getPrivateKey(i.name),a=ew.get(this);if(a==null)throw $(new Error("dek missing"),O.ERR_INVALID_PARAMETERS);const c=a.dek,u=yi.pki.decryptRsaPrivateKey(o,c);return t.decrypt(s.recipient,u),L(t.content.getBytes(),"ascii")}}const qf=N("libp2p:keychain"),Yxe="/pkcs8/",hL="/info/",Xi=new WeakMap,ea={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},tw={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function hi(r){return r==null||typeof r!="string"?!1:r===Ixe(r.trim())&&r.length>0}async function Ve(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function Ps(r){return new ie(Yxe+r)}function fi(r){return new ie(hL+r)}class S0{constructor(e,t){if(this.components=e,this.init=et(tw,t),this.init.pass!=null&&this.init.pass?.length<20)throw new Error("pass must be least 20 characters");if(this.init.dek?.keyLength!=null&&this.init.dek.keyLength<ea.minKeyLength)throw new Error(`dek.keyLength must be least ${ea.minKeyLength} bytes`);if(this.init.dek?.salt?.length!=null&&this.init.dek.salt.length<ea.minSaltLength)throw new Error(`dek.saltLength must be least ${ea.minSaltLength} bytes`);if(this.init.dek?.iterationCount!=null&&this.init.dek.iterationCount<ea.minIterationCount)throw new Error(`dek.iterationCount must be least ${ea.minIterationCount}`);const n=this.init.pass!=null&&this.init.dek?.salt!=null?W8(this.init.pass,this.init.dek?.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Xi.set(this,{dek:n}),this.started=!1}isStarted(){return this.started}async start(){const e=fi("self");await this.components.datastore.has(e)||await this.importPeer("self",this.components.peerId),this.started=!0}stop(){this.started=!1}get cms(){const e=Xi.get(this);if(e==null)throw $(new Error("dek missing"),O.ERR_INVALID_PARAMETERS);const t=e.dek;return new Qxe(this,t)}static generateOptions(){const e=Object.assign({},tw),t=Math.ceil(ea.minSaltLength/3)*3;return e.dek.salt=C(J0(t),"base64"),e}static get options(){return tw}async createKey(e,t,n=2048){if(!hi(e)||e==="self")throw await Ve(),$(new Error("Invalid key name"),O.ERR_INVALID_KEY_NAME);if(typeof t!="string")throw await Ve(),$(new Error("Invalid key type"),O.ERR_INVALID_KEY_TYPE);const s=Ps(e);if(await this.components.datastore.has(s))throw await Ve(),$(new Error("Key name already exists"),O.ERR_KEY_ALREADY_EXISTS);switch(t.toLowerCase()){case"rsa":if(!Number.isSafeInteger(n)||n<2048)throw await Ve(),$(new Error("Invalid RSA key size"),O.ERR_INVALID_KEY_SIZE);break}let o;try{const a=await tm(t,n),c=await a.id(),u=Xi.get(this);if(u==null)throw $(new Error("dek missing"),O.ERR_INVALID_PARAMETERS);const l=u.dek,d=await a.export(l);o={name:e,id:c};const f=this.components.datastore.batch();f.put(s,L(d)),f.put(fi(e),L(JSON.stringify(o))),await f.commit()}catch(a){throw await Ve(),a}return o}async listKeys(){const e={prefix:hL},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(C(n.value)));return t}async findKeyById(e){try{return(await this.listKeys()).find(n=>n.id===e)}catch(t){throw await Ve(),t}}async findKeyByName(e){if(!hi(e))throw await Ve(),$(new Error(`Invalid key name '${e}'`),O.ERR_INVALID_KEY_NAME);const t=fi(e);try{const n=await this.components.datastore.get(t);return JSON.parse(C(n))}catch(n){throw await Ve(),qf.error(n),$(new Error(`Key '${e}' does not exist.`),O.ERR_KEY_NOT_FOUND)}}async removeKey(e){if(!hi(e)||e==="self")throw await Ve(),$(new Error(`Invalid key name '${e}'`),O.ERR_INVALID_KEY_NAME);const t=Ps(e),n=await this.findKeyByName(e),s=this.components.datastore.batch();return s.delete(t),s.delete(fi(e)),await s.commit(),n}async renameKey(e,t){if(!hi(e)||e==="self")throw await Ve(),$(new Error(`Invalid old key name '${e}'`),O.ERR_OLD_KEY_NAME_INVALID);if(!hi(t)||t==="self")throw await Ve(),$(new Error(`Invalid new key name '${t}'`),O.ERR_NEW_KEY_NAME_INVALID);const n=Ps(e),s=Ps(t),i=fi(e),o=fi(t);if(await this.components.datastore.has(s))throw await Ve(),$(new Error(`Key '${t}' already exists`),O.ERR_KEY_ALREADY_EXISTS);try{const c=await this.components.datastore.get(n),u=await this.components.datastore.get(i),l=JSON.parse(C(u));l.name=t;const d=this.components.datastore.batch();return d.put(s,c),d.put(o,L(JSON.stringify(l))),d.delete(n),d.delete(i),await d.commit(),l}catch(c){throw await Ve(),c}}async exportKey(e,t){if(!hi(e))throw await Ve(),$(new Error(`Invalid key name '${e}'`),O.ERR_INVALID_KEY_NAME);if(t==null)throw await Ve(),$(new Error("Password is required"),O.ERR_PASSWORD_REQUIRED);const n=Ps(e);try{const s=await this.components.datastore.get(n),i=C(s),o=Xi.get(this);if(o==null)throw $(new Error("dek missing"),O.ERR_INVALID_PARAMETERS);const a=o.dek;return await(await Nc(i,a)).export(t)}catch(s){throw await Ve(),s}}async exportPeerId(e){const t="temporary-password",n=await this.exportKey(e,t),s=await Nc(n,t);return await rs(s.public.bytes,s.bytes)}async importKey(e,t,n){if(!hi(e)||e==="self")throw await Ve(),$(new Error(`Invalid key name '${e}'`),O.ERR_INVALID_KEY_NAME);if(t==null)throw await Ve(),$(new Error("PEM encoded key is required"),O.ERR_PEM_REQUIRED);const s=Ps(e);if(await this.components.datastore.has(s))throw await Ve(),$(new Error(`Key '${e}' already exists`),O.ERR_KEY_ALREADY_EXISTS);let o;try{o=await Nc(t,n)}catch{throw await Ve(),$(new Error("Cannot read the key, most likely the password is wrong"),O.ERR_CANNOT_READ_KEY)}let a;try{a=await o.id();const l=Xi.get(this);if(l==null)throw $(new Error("dek missing"),O.ERR_INVALID_PARAMETERS);const d=l.dek;t=await o.export(d)}catch(l){throw await Ve(),l}const c={name:e,id:a},u=this.components.datastore.batch();return u.put(s,L(t)),u.put(fi(e),L(JSON.stringify(c))),await u.commit(),c}async importPeer(e,t){try{if(!hi(e))throw $(new Error(`Invalid key name '${e}'`),O.ERR_INVALID_KEY_NAME);if(t==null)throw $(new Error("PeerId is required"),O.ERR_MISSING_PRIVATE_KEY);if(t.privateKey==null)throw $(new Error("PeerId.privKey is required"),O.ERR_MISSING_PRIVATE_KEY);const n=await Vo(t.privateKey),s=Ps(e);if(await this.components.datastore.has(s))throw await Ve(),$(new Error(`Key '${e}' already exists`),O.ERR_KEY_ALREADY_EXISTS);const o=Xi.get(this);if(o==null)throw $(new Error("dek missing"),O.ERR_INVALID_PARAMETERS);const a=o.dek,c=await n.export(a),u={name:e,id:t.toString()},l=this.components.datastore.batch();return l.put(s,L(c)),l.put(fi(e),L(JSON.stringify(u))),await l.commit(),u}catch(n){throw await Ve(),n}}async getPrivateKey(e){if(!hi(e))throw await Ve(),$(new Error(`Invalid key name '${e}'`),O.ERR_INVALID_KEY_NAME);try{const t=Ps(e),n=await this.components.datastore.get(t);return C(n)}catch(t){throw await Ve(),qf.error(t),$(new Error(`Key '${e}' does not exist.`),O.ERR_KEY_NOT_FOUND)}}async rotateKeychainPass(e,t){if(typeof e!="string")throw await Ve(),$(new Error(`Invalid old pass type '${typeof e}'`),O.ERR_INVALID_OLD_PASS_TYPE);if(typeof t!="string")throw await Ve(),$(new Error(`Invalid new pass type '${typeof t}'`),O.ERR_INVALID_NEW_PASS_TYPE);if(t.length<20)throw await Ve(),$(new Error(`Invalid pass length ${t.length}`),O.ERR_INVALID_PASS_LENGTH);qf("recreating keychain");const n=Xi.get(this);if(n==null)throw $(new Error("dek missing"),O.ERR_INVALID_PARAMETERS);const s=n.dek;this.init.pass=t;const i=t!=null&&this.init.dek?.salt!=null?W8(t,this.init.dek.salt,this.init.dek?.iterationCount,this.init.dek?.keyLength,this.init.dek?.hash):"";Xi.set(this,{dek:i});const o=await this.listKeys();for(const a of o){const c=await this.components.datastore.get(Ps(a.name)),u=C(c),l=await Nc(u,s),d=i.toString(),f=await l.export(d),g=this.components.datastore.batch(),h={name:a.name,id:a.id};g.put(Ps(a.name),L(f)),g.put(fi(a.name),L(JSON.stringify(h))),await g.commit()}qf("keychain reconstructed")}}async function rw(r){try{return{status:"fulfilled",value:await r,isFulfilled:!0,isRejected:!1}}catch(e){return{status:"rejected",reason:e,isFulfilled:!1,isRejected:!0}}}class Xxe{constructor(e){k(this,"value");k(this,"next");this.value=e}}var Vs,wa,ba;class Jxe{constructor(){vt(this,Vs,void 0);vt(this,wa,void 0);vt(this,ba,void 0);this.clear()}enqueue(e){const t=new Xxe(e);ce(this,Vs)?(ce(this,wa).next=t,Xe(this,wa,t)):(Xe(this,Vs,t),Xe(this,wa,t)),Rg(this,ba)._++}dequeue(){const e=ce(this,Vs);if(e)return Xe(this,Vs,ce(this,Vs).next),Rg(this,ba)._--,e.value}clear(){Xe(this,Vs,void 0),Xe(this,wa,void 0),Xe(this,ba,0)}get size(){return ce(this,ba)}*[Symbol.iterator](){let e=ce(this,Vs);for(;e;)yield e.value,e=e.next}}Vs=new WeakMap,wa=new WeakMap,ba=new WeakMap;function Zxe(r){if(!((Number.isInteger(r)||r===Number.POSITIVE_INFINITY)&&r>0))throw new TypeError("Expected `concurrency` to be a number from 1 and up");const e=new Jxe;let t=0;const n=()=>{t--,e.size>0&&e.dequeue()()},s=async(a,c,u)=>{t++;const l=(async()=>a(...u))();c(l);try{await l}catch{}n()},i=(a,c,u)=>{e.enqueue(s.bind(void 0,a,c,u)),(async()=>(await Promise.resolve(),t<r&&e.size>0&&e.dequeue()()))()},o=(a,...c)=>new Promise(u=>{i(a,u,c)});return Object.defineProperties(o,{activeCount:{get:()=>t},pendingCount:{get:()=>e.size},clearQueue:{value:()=>{e.clear()}}}),o}async function eDe(r,e={}){const{concurrency:t=Number.POSITIVE_INFINITY}=e,n=Zxe(t);return Promise.all(r.map(s=>s&&typeof s.then=="function"?rw(s):rw(typeof s=="function"?n(()=>s()):Promise.resolve(s))))}class tDe extends Map{constructor(t){super();k(this,"metric");const{name:n,metrics:s}=t;this.metric=s.registerMetric(n),this.updateComponentMetric()}set(t,n){return super.set(t,n),this.updateComponentMetric(),this}delete(t){const n=super.delete(t);return this.updateComponentMetric(),n}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Ka(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new tDe({name:e,metrics:t}):n=new Map,n}const ta=N("libp2p:transports");class rDe extends gt{constructor(e,t={}){super(),this.components=e,this.started=!1,this.transports=new Map,this.listeners=Ka({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Hc.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(t==null)throw $(new Error("Transport must have a valid tag"),O.ERR_INVALID_KEY);if(this.transports.has(t))throw $(new Error("There is already a transport with this tag"),O.ERR_DUPLICATE_TRANSPORT);ta("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}async start(){const e=this.components.addressManager.getListenAddrs();await this.listen(e),this.started=!0}async stop(){const e=[];for(const[t,n]of this.listeners)for(ta("closing listeners for %s",t);n.length>0;){const s=n.pop();s!=null&&e.push(s.close())}await Promise.all(e),ta("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.transportForMultiaddr(e);if(n==null)throw $(new Error(`No transport available for address ${String(e)}`),O.ERR_TRANSPORT_UNAVAILABLE);try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(s){throw s.code==null&&(s.code=O.ERR_TRANSPORT_DIAL_FAILED),s}}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}transportForMultiaddr(e){for(const t of this.transports.values())if(t.filter([e]).length>0)return t}async listen(e){if(e==null||e.length===0){ta("no addresses were provided for listening, this node is dial only");return}const t=[];for(const[n,s]of this.transports.entries()){const i=s.filter(e),o=[];for(const u of i){ta("creating listener for %s on %s",n,u);const l=s.createListener({upgrader:this.components.upgrader});let d=this.listeners.get(n);d==null&&(d=[],this.listeners.set(n,d)),d.push(l),l.addEventListener("listening",()=>{this.dispatchEvent(new W("listener:listening",{detail:l}))}),l.addEventListener("close",()=>{this.dispatchEvent(new W("listener:close",{detail:l}))}),o.push(l.listen(u))}if(o.length===0){t.push(n);continue}if((await eDe(o)).find(u=>u.isFulfilled)==null&&this.faultTolerance!==Hc.NO_FATAL)throw $(new Error(`Transport (${n}) could not listen on any available address`),O.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){const n=`no valid addresses were provided for transports [${t.join(", ")}]`;if(this.faultTolerance===Hc.FATAL_ALL)throw $(new Error(n),O.ERR_NO_VALID_ADDRESSES);ta(`libp2p in dial mode only: ${n}`)}}async remove(e){ta("removing %s",e);for(const t of this.listeners.get(e)??[])await t.close();this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const Qc="/multistream/1.0.0",nDe=1024;function sDe(r){return r[Symbol.asyncIterator]!=null}function iDe(...r){const e=[];for(const t of r)sDe(t)||e.push(t);return e.length===r.length?function*(){for(const t of e)yield*t}():async function*(){const t=Mt({objectMode:!0});Promise.resolve().then(async()=>{try{await Promise.all(r.map(async n=>{for await(const s of n)t.push(s)})),t.end()}catch(n){t.end(n)}}),yield*t}()}function oDe(r){return r[Symbol.asyncIterator]!=null}function aDe(r){if(oDe(r))return(async()=>{for await(const e of r)return e})();for(const e of r)return e}const cDe=Math.pow(2,7),lDe=Math.pow(2,14),uDe=Math.pow(2,21),c8=Math.pow(2,28),l8=Math.pow(2,35),u8=Math.pow(2,42),d8=Math.pow(2,49),ze=128,zr=127;function Xh(r){if(r<cDe)return 1;if(r<lDe)return 2;if(r<uDe)return 3;if(r<c8)return 4;if(r<l8)return 5;if(r<u8)return 6;if(r<d8)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function dDe(r,e,t=0){switch(Xh(r)){case 8:e[t++]=r&255|ze,r/=128;case 7:e[t++]=r&255|ze,r/=128;case 6:e[t++]=r&255|ze,r/=128;case 5:e[t++]=r&255|ze,r/=128;case 4:e[t++]=r&255|ze,r>>>=7;case 3:e[t++]=r&255|ze,r>>>=7;case 2:e[t++]=r&255|ze,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function hDe(r,e,t=0){switch(Xh(r)){case 8:e.set(t++,r&255|ze),r/=128;case 7:e.set(t++,r&255|ze),r/=128;case 6:e.set(t++,r&255|ze),r/=128;case 5:e.set(t++,r&255|ze),r/=128;case 4:e.set(t++,r&255|ze),r>>>=7;case 3:e.set(t++,r&255|ze),r>>>=7;case 2:e.set(t++,r&255|ze),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function fDe(r,e){let t=r[e],n=0;if(n+=t&zr,t<ze||(t=r[e+1],n+=(t&zr)<<7,t<ze)||(t=r[e+2],n+=(t&zr)<<14,t<ze)||(t=r[e+3],n+=(t&zr)<<21,t<ze)||(t=r[e+4],n+=(t&zr)*c8,t<ze)||(t=r[e+5],n+=(t&zr)*l8,t<ze)||(t=r[e+6],n+=(t&zr)*u8,t<ze)||(t=r[e+7],n+=(t&zr)*d8,t<ze))return n;throw new RangeError("Could not decode varint")}function pDe(r,e){let t=r.get(e),n=0;if(n+=t&zr,t<ze||(t=r.get(e+1),n+=(t&zr)<<7,t<ze)||(t=r.get(e+2),n+=(t&zr)<<14,t<ze)||(t=r.get(e+3),n+=(t&zr)<<21,t<ze)||(t=r.get(e+4),n+=(t&zr)*c8,t<ze)||(t=r.get(e+5),n+=(t&zr)*l8,t<ze)||(t=r.get(e+6),n+=(t&zr)*u8,t<ze)||(t=r.get(e+7),n+=(t&zr)*d8,t<ze))return n;throw new RangeError("Could not decode varint")}function gDe(r,e,t=0){return e==null&&(e=Ys(Xh(r))),e instanceof Uint8Array?dDe(r,e,t):hDe(r,e,t)}function yDe(r,e=0){return r instanceof Uint8Array?fDe(r,e):pDe(r,e)}function fL(r){return r[Symbol.asyncIterator]!=null}const fg=r=>{const e=Xh(r),t=Ys(e);return gDe(r,t),fg.bytes=e,t};fg.bytes=0;function h8(r,e){e=e??{};const t=e.lengthEncoder??fg;function*n(s){const i=t(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}return fL(r)?async function*(){for await(const s of r)yield*n(s)}():function*(){for(const s of r)yield*n(s)}()}h8.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??fg;return new ue(t(r.byteLength),r)};const wDe=8,bDe=1024*1024*4;var aa;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(aa||(aa={}));const f8=r=>{const e=yDe(r);return f8.bytes=Xh(e),e};f8.bytes=0;function E6(r,e){const t=new ue;let n=aa.LENGTH,s=-1;const i=e?.lengthDecoder??f8,o=e?.maxLengthLength??wDe,a=e?.maxDataLength??bDe;function*c(){for(;t.byteLength>0;){if(n===aa.LENGTH)try{if(s=i(t),s<0)throw $(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(s>a)throw $(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const u=i.bytes;t.consume(u),e?.onLength!=null&&e.onLength(s),n=aa.DATA}catch(u){if(u instanceof RangeError){if(t.byteLength>o)throw $(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw u}if(n===aa.DATA){if(t.byteLength<s)break;const u=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(u),yield u,n=aa.LENGTH}}}return fL(r)?async function*(){for await(const u of r)t.append(u),yield*c();if(t.byteLength>0)throw $(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const u of r)t.append(u),yield*c();if(t.byteLength>0)throw $(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}E6.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return E6(n,{...e??{},onLength:i=>{t=i}})};function mDe(r,...e){if(r==null)throw new Error("Empty pipeline");if(nw(r)){const n=r;r=()=>n.source}else if(gL(r)||pL(r)){const n=r;r=()=>n}const t=[r,...e];if(t.length>1&&nw(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)nw(t[n])&&(t[n]=vDe(t[n]));return EDe(...t)}const EDe=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},pL=r=>r?.[Symbol.asyncIterator]!=null,gL=r=>r?.[Symbol.iterator]!=null,nw=r=>r==null?!1:r.sink!=null&&r.source!=null,vDe=r=>e=>{const t=r.sink(e);if(t?.then!=null){const n=Mt({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let s;const i=r.source;if(pL(i))s=async function*(){yield*i,n.end()};else if(gL(i))s=function*(){yield*i,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return iDe(n,s())}return r.source},_De=N("libp2p:mss"),yL=L(`
`);function p8(r){const e=new ue(r,yL);return h8.single(e)}function dd(r,e,t={}){const n=p8(e);t.writeBytes===!0?r.push(n.subarray()):r.push(n)}function SDe(r,e,t={}){const n=new ue;for(const s of e)n.append(p8(s));t.writeBytes===!0?r.push(n.subarray()):r.push(n)}async function ADe(r,e){let t=1;const n={[Symbol.asyncIterator]:()=>n,next:async()=>r.next(t)};let s=n;e?.signal!=null&&(s=Td(n,e.signal));const i=a=>{t=a},o=await mDe(s,a=>E6(a,{onLength:i,maxDataLength:nDe}),async a=>aDe(a));if(o==null||o.length===0)throw new B("no buffer returned","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");if(o.get(o.byteLength-1)!==yL[0])throw _De.error("Invalid mss message - missing newline - %s",o.subarray()),new B("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return o.sublist(0,-1)}async function bp(r,e){const t=await ADe(r,e);return C(t.subarray())}const Fu=N("libp2p:mss:select");async function sw(r,e,t={}){e=Array.isArray(e)?[...e]:[e];const{reader:n,writer:s,rest:i,stream:o}=n8(r),a=e.shift();if(a==null)throw new Error("At least one protocol must be specified");Fu.trace('select: write ["%s", "%s"]',Qc,a);const c=L(Qc),u=L(a);SDe(s,[c,u],t);let l=await bp(n,t);if(Fu.trace('select: read "%s"',l),l===Qc&&(l=await bp(n,t),Fu.trace('select: read "%s"',l)),l===a)return i(),{stream:o,protocol:a};for(const d of e){Fu.trace('select: write "%s"',d),dd(s,L(d),t);const f=await bp(n,t);if(Fu.trace('select: read "%s" for "%s"',f,d),f===d)return i(),{stream:o,protocol:d}}throw i(),new B("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}const Vu=N("libp2p:mss:handle");async function iw(r,e,t){e=Array.isArray(e)?e:[e];const{writer:n,reader:s,rest:i,stream:o}=n8(r);for(;;){const a=await bp(s,t);if(Vu.trace('read "%s"',a),a===Qc){Vu.trace('respond with "%s" for "%s"',Qc,a),dd(n,L(Qc),t);continue}if(e.includes(a))return dd(n,L(a),t),Vu.trace('respond with "%s" for "%s"',a,a),i(),{stream:o,protocol:a};if(a==="ls"){dd(n,new ue(...e.map(c=>p8(L(c)))),t),Vu.trace('respond with "%s" for %s',e,a);continue}dd(n,L("na"),t),Vu('respond with "na" for "%s"',a)}}const $De=Symbol.for("@libp2p/connection"),RDe=N("libp2p:connection");class TDe{constructor(e){const{remoteAddr:t,remotePeer:n,newStream:s,close:i,getStreams:o,stat:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.stat={...a,status:DN},this._newStream=s,this._close=i,this._getStreams=o,this.tags=[],this._closing=!1}get[Symbol.toStringTag](){return"Connection"}get[$De](){return!0}get streams(){return this._getStreams()}async newStream(e,t){if(this.stat.status===WA)throw $(new Error("the connection is being closed"),"ERR_CONNECTION_BEING_CLOSED");if(this.stat.status===Jy)throw $(new Error("the connection is closed"),"ERR_CONNECTION_CLOSED");Array.isArray(e)||(e=[e]);const n=await this._newStream(e,t);return n.stat.direction="outbound",n}addStream(e){e.stat.direction="inbound"}removeStream(e){}async close(){if(!(this.stat.status===Jy||this._closing)){this.stat.status=WA;try{this.streams.forEach(e=>e.close())}catch(e){RDe.error(e)}this._closing=!0,await this._close(),this._closing=!1,this.stat.timeline.close=Date.now(),this.stat.status=Jy}}}function IDe(r){return new TDe(r)}const ow=N("libp2p:registrar"),wL=32,bL=64;class CDe{constructor(e){this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onProtocolChange=this._onProtocolChange.bind(this),this._onConnect=this._onConnect.bind(this),this.components.connectionManager.addEventListener("peer:disconnect",this._onDisconnect),this.components.connectionManager.addEventListener("peer:connect",this._onConnect),this.components.peerStore.addEventListener("change:protocols",this._onProtocolChange)}getProtocols(){return Array.from(new Set([...this.topologies.keys(),...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw $(new Error(`No handler registered for protocol ${e}`),O.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw $(new Error(`Handler already registered for protocol ${e}`),O.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const s=et.bind({ignoreUndefined:!0})({maxInboundStreams:wL,maxOutboundStreams:bL},n);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.protoBook.add(this.components.peerId,[e])}async unhandle(e){const t=Array.isArray(e)?e:[e];t.forEach(n=>{this.handlers.delete(n)}),await this.components.peerStore.protoBook.remove(this.components.peerId,t)}async register(e,t){if(!xye(t))throw ow.error("topology must be an instance of interfaces/topology"),$(new Error("topology must be an instance of interfaces/topology"),O.ERR_INVALID_PARAMETERS);const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(n,t),await t.setRegistrar(this),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.protoBook.get(t.remotePeer).then(n=>{for(const s of n){const i=this.topologies.get(s);if(i!=null)for(const o of i.values())o.onDisconnect(t.remotePeer)}}).catch(n=>{ow.error(n)})}_onConnect(e){const t=e.detail;this.components.peerStore.protoBook.get(t.remotePeer).then(n=>{for(const s of n){const i=this.topologies.get(s);if(i!=null)for(const o of i.values())o.onConnect(t.remotePeer,t)}}).catch(n=>{ow.error(n)})}_onProtocolChange(e){const{peerId:t,protocols:n,oldProtocols:s}=e.detail,i=s.filter(a=>!n.includes(a)),o=n.filter(a=>!s.includes(a));for(const a of i){const c=this.topologies.get(a);if(c!=null)for(const u of c.values())u.onDisconnect(t)}for(const a of o){const c=this.topologies.get(a);if(c!=null)for(const u of c.values()){const l=this.components.connectionManager.getConnections(t)[0];l!=null&&u.onConnect(t,l)}}}}const He=N("libp2p:upgrader");function xDe(r,e){try{const{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.code!==O.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return wL}function DDe(r,e){try{const{options:t}=e.getHandler(r);return t.maxOutboundStreams}catch(t){if(t.code!==O.ERR_NO_HANDLER_FOR_PROTOCOL)throw t}return bL}function v$(r,e,t){let n=0;return t.streams.forEach(s=>{s.stat.direction===e&&s.stat.protocol===r&&n++}),n}class ODe extends gt{constructor(e,t){super(),this.components=e,this.connectionEncryption=new Map,t.connectionEncryption.forEach(n=>{this.connectionEncryption.set(n.protocol,n)}),this.muxers=new Map,t.muxers.forEach(n=>{this.muxers.set(n.protocol,n)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw $(new Error("connection denied"),O.ERR_CONNECTION_DENIED);let s,i,o,a,c;const u=new ft.TimeoutController(this.inboundUpgradeTimeout);try{Qe.setMaxListeners?.(1/0,u.signal)}catch{}try{const l=Ao(e,u.signal);if(e.source=l.source,e.sink=l.sink,await this.components.connectionGater.denyInboundConnection(e))throw $(new Error("The multiaddr connection is blocked by gater.acceptConnection"),O.ERR_CONNECTION_INTERCEPTED);this.components.metrics?.trackMultiaddrConnection(e),He("starting the inbound connection upgrade");let d=e;if(t?.skipProtection!==!0){const f=this.components.connectionProtector;f!=null&&(He("protecting the inbound connection"),d=await f.protect(e))}try{if(s=d,t?.skipEncryption!==!0){if({conn:s,remotePeer:i,protocol:c}=await this._encryptInbound(d),await this.components.connectionGater.denyInboundEncryptedConnection(i,{...d,...s}))throw $(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),O.ERR_CONNECTION_INTERCEPTED)}else{const f=e.remoteAddr.getPeerId();if(f==null)throw $(new Error("inbound connection that skipped encryption must have a peer id"),O.ERR_INVALID_MULTIADDR);const g=de(f);c="native",i=g}if(o=s,t?.muxerFactory!=null)a=t.muxerFactory;else if(this.muxers.size>0){const f=await this._multiplexInbound({...d,...s},this.muxers);a=f.muxerFactory,o=f.stream}}catch(f){throw He.error("Failed to upgrade inbound connection",f),f}if(await this.components.connectionGater.denyInboundUpgradedConnection(i,{...d,...s}))throw $(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),O.ERR_CONNECTION_INTERCEPTED);return He("Successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:c,direction:"inbound",maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:i})}finally{this.components.connectionManager.afterUpgradeInbound(),u.clear()}}async upgradeOutbound(e,t){const n=e.remoteAddr.getPeerId();let s;if(n!=null&&(s=de(n),await this.components.connectionGater.denyOutboundConnection(s,e)))throw $(new Error("The multiaddr connection is blocked by connectionGater.denyOutboundConnection"),O.ERR_CONNECTION_INTERCEPTED);let i,o,a,c,u;this.components.metrics?.trackMultiaddrConnection(e),He("Starting the outbound connection upgrade");let l=e;if(t?.skipProtection!==!0){const d=this.components.connectionProtector;d!=null&&(l=await d.protect(e))}try{if(i=l,t?.skipEncryption!==!0){if({conn:i,remotePeer:o,protocol:c}=await this._encryptOutbound(l,s),await this.components.connectionGater.denyOutboundEncryptedConnection(o,{...l,...i}))throw $(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),O.ERR_CONNECTION_INTERCEPTED)}else{if(s==null)throw $(new Error("Encryption was skipped but no peer id was passed"),O.ERR_INVALID_PEER);c="native",o=s}if(a=i,t?.muxerFactory!=null)u=t.muxerFactory;else if(this.muxers.size>0){const d=await this._multiplexOutbound({...l,...i},this.muxers);u=d.muxerFactory,a=d.stream}}catch(d){throw He.error("Failed to upgrade outbound connection",d),await e.close(d),d}if(await this.components.connectionGater.denyOutboundUpgradedConnection(o,{...l,...i}))throw $(new Error("The multiaddr connection is blocked by gater.acceptEncryptedConnection"),O.ERR_CONNECTION_INTERCEPTED);return He("Successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:e,upgradedConn:a,muxerFactory:u,remotePeer:o})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:s,upgradedConn:i,remotePeer:o,muxerFactory:a}=e;let c,u,l;a!=null&&(c=a.createStreamMuxer({direction:n,onIncomingStream:g=>{l!=null&&Promise.resolve().then(async()=>{const h=this.components.registrar.getProtocols(),{stream:p,protocol:w}=await iw(g,h);if(He("%s: incoming stream opened on %s",n,w),l==null)return;const y=xDe(w,this.components.registrar);if(v$(w,"inbound",l)===y){g.abort($(new Error(`Too many inbound protocol streams for protocol "${w}" - limit ${y}`),O.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS));return}g.source=p.source,g.sink=p.sink,g.stat.protocol=w,this.components.peerStore.protoBook.add(o,[w]).catch(m=>He.error(m)),l.addStream(g),this.components.metrics?.trackProtocolStream(g,l),this._onStream({connection:l,stream:g,protocol:w})}).catch(h=>{He.error(h),g.stat.timeline.close==null&&g.close()})},onStreamEnd:g=>{l?.removeStream(g.id)}}),u=async(g,h={})=>{if(c==null)throw $(new Error("Stream is not multiplexed"),O.ERR_MUXER_UNAVAILABLE);He("%s: starting new stream on %s",n,g);const p=await c.newStream();let w;try{if(h.signal==null){He("No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",g),w=new ft.TimeoutController(3e4),h.signal=w.signal;try{Qe.setMaxListeners?.(1/0,w.signal)}catch{}}const{stream:y,protocol:E}=await sw(p,g,h),m=DDe(E,this.components.registrar);if(v$(E,"outbound",l)===m){const v=$(new Error(`Too many outbound protocol streams for protocol "${E}" - limit ${m}`),O.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw p.abort(v),v}return this.components.peerStore.protoBook.add(o,[E]).catch(v=>He.error(v)),p.source=y.source,p.sink=y.sink,p.stat.protocol=E,this.components.metrics?.trackProtocolStream(p,l),p}catch(y){throw He.error("could not create new stream",y),p.stat.timeline.close==null&&p.close(),y.code!=null?y:$(y,O.ERR_UNSUPPORTED_PROTOCOL)}finally{w?.clear()}},Promise.all([c.sink(i.source),i.sink(c.source)]).catch(g=>{He.error(g)}));const d=s.timeline;s.timeline=new Proxy(d,{set:(...g)=>(l!=null&&g[1]==="close"&&g[2]!=null&&d.close==null&&(async()=>{try{l.stat.status==="OPEN"&&await l.close()}catch(h){He.error(h)}finally{this.dispatchEvent(new W("connectionEnd",{detail:l}))}})().catch(h=>{He.error(h)}),Reflect.set(...g))}),s.timeline.upgraded=Date.now();const f=()=>{throw $(new Error("connection is not multiplexed"),O.ERR_CONNECTION_NOT_MULTIPLEXED)};return l=IDe({remoteAddr:s.remoteAddr,remotePeer:o,stat:{status:"OPEN",direction:n,timeline:s.timeline,multiplexer:c?.protocol,encryption:t},newStream:u??f,getStreams:()=>c!=null?c.streams:f(),close:async()=>{await s.close(),c?.close()}}),this.dispatchEvent(new W("connection",{detail:l})),l}_onStream(e){const{connection:t,stream:n,protocol:s}=e,{handler:i}=this.components.registrar.getHandler(s);i({connection:t,stream:n})}async _encryptInbound(e){const t=Array.from(this.connectionEncryption.keys());He("handling inbound crypto protocol selection",t);try{const{stream:n,protocol:s}=await iw(e,t,{writeBytes:!0}),i=this.connectionEncryption.get(s);if(i==null)throw new Error(`no crypto module found for ${s}`);return He("encrypting inbound connection..."),{...await i.secureInbound(this.components.peerId,n),protocol:s}}catch(n){throw $(n,O.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncryption.keys());He("selecting outbound crypto protocol",n);try{const{stream:s,protocol:i}=await sw(e,n,{writeBytes:!0}),o=this.connectionEncryption.get(i);if(o==null)throw new Error(`no crypto module found for ${i}`);return He("encrypting outbound connection to %p",t),{...await o.secureOutbound(this.components.peerId,s,t),protocol:i}}catch(s){throw $(s,O.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){const n=Array.from(t.keys());He("outbound selecting muxer %s",n);try{const{stream:s,protocol:i}=await sw(e,n,{writeBytes:!0});He("%s selected as muxer protocol",i);const o=t.get(i);return{stream:s,muxerFactory:o}}catch(s){throw He.error("error multiplexing outbound stream",s),$(s,O.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){const n=Array.from(t.keys());He("inbound handling muxers %s",n);try{const{stream:s,protocol:i}=await iw(e,n,{writeBytes:!0}),o=t.get(i);return{stream:s,muxerFactory:o}}catch(s){throw He.error("error multiplexing inbound stream",s),$(s,O.ERR_MUXER_UNAVAILABLE)}}}var Bc;(function(r){let e;r.codec=()=>(e==null&&(e=Jd((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)n.uint32(18),n.bytes(i);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)n.uint32(26),n.string(i);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={listenAddrs:[],protocols:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 5:s.protocolVersion=t.string();break;case 6:s.agentVersion=t.string();break;case 1:s.publicKey=t.bytes();break;case 2:s.listenAddrs.push(t.bytes());break;case 4:s.observedAddr=t.bytes();break;case 3:s.protocols.push(t.string());break;case 8:s.signedPeerRecord=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xd(t,r.codec()),r.decode=t=>Yd(t,r.codec())})(Bc||(Bc={}));const mL="0.0.0",PDe="libp2p",EL=`js-libp2p/${mL}`,kDe="0.1.0",NDe="id",LDe="id/push",MDe="1.0.0",UDe="1.0.0",qe=N("libp2p:identify"),_$=1024*8;class g8{constructor(e,t){this.components=e,this.started=!1,this.init=t,this.identifyProtocolStr=`/${t.protocolPrefix}/${NDe}/${MDe}`,this.identifyPushProtocolStr=`/${t.protocolPrefix}/${LDe}/${UDe}`,this.host={protocolVersion:`${t.protocolPrefix}/${kDe}`,...t.host},this.components.connectionManager.addEventListener("peer:connect",n=>{const s=n.detail;this.identify(s).catch(qe.error)}),this.components.peerStore.addEventListener("change:multiaddrs",n=>{const{peerId:s}=n.detail;this.components.peerId.equals(s)&&this.pushToPeerStore().catch(i=>qe.error(i))}),this.components.peerStore.addEventListener("change:protocols",n=>{const{peerId:s}=n.detail;this.components.peerId.equals(s)&&this.pushToPeerStore().catch(i=>qe.error(i))})}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.metadataBook.setValue(this.components.peerId,"AgentVersion",L(this.host.agentVersion)),await this.components.peerStore.metadataBook.setValue(this.components.peerId,"ProtocolVersion",L(this.host.protocolVersion)),await this.components.registrar.handle(this.identifyProtocolStr,e=>{this._handleIdentify(e).catch(t=>{qe.error(t)})},{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),await this.components.registrar.handle(this.identifyPushProtocolStr,e=>{this._handlePush(e).catch(t=>{qe.error(t)})},{maxInboundStreams:this.init.maxPushIncomingStreams,maxOutboundStreams:this.init.maxPushOutgoingStreams}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.identifyProtocolStr),await this.components.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async push(e){const t=await this.components.peerStore.addressBook.getRawEnvelope(this.components.peerId),n=this.components.addressManager.getAddresses().map(o=>o.bytes),s=await this.components.peerStore.protoBook.get(this.components.peerId),i=e.map(async o=>{let a;const c=new ft.TimeoutController(this.init.timeout);try{Qe.setMaxListeners?.(1/0,c.signal)}catch{}try{a=await o.newStream([this.identifyPushProtocolStr],{signal:c.signal}),await Ao(a,c.signal).sink(Ae([Bc.encode({listenAddrs:n,signedPeerRecord:t,protocols:s})],pl()))}catch(u){qe.error("could not push identify update to peer",u)}finally{a?.close(),c.clear()}});await Promise.all(i)}async pushToPeerStore(){if(!this.isStarted())return;const e=[];for(const t of this.components.connectionManager.getConnections()){const n=t.remotePeer;(await this.components.peerStore.get(n)).protocols.includes(this.identifyPushProtocolStr)&&e.push(t)}await this.push(e)}async _identify(e,t={}){let n,s=t.signal,i;if(s==null){n=new ft.TimeoutController(this.init.timeout),s=n.signal;try{Qe.setMaxListeners?.(1/0,n.signal)}catch{}}try{i=await e.newStream([this.identifyProtocolStr],{signal:s});const o=Ao(i,s),a=await Ae([],o,qa({maxDataLength:this.init.maxIdentifyMessageSize??_$}),async c=>await xs(c));if(a==null)throw $(new Error("No data could be retrieved"),O.ERR_CONNECTION_ENDED);try{return Bc.decode(a)}catch(c){throw $(c,O.ERR_INVALID_MESSAGE)}}finally{n?.clear(),i?.close()}}async identify(e,t={}){const n=await this._identify(e,t),{publicKey:s,listenAddrs:i,protocols:o,observedAddr:a,signedPeerRecord:c,agentVersion:u,protocolVersion:l}=n;if(s==null)throw $(new Error("public key was missing from identify message"),O.ERR_MISSING_PUBLIC_KEY);const d=await rs(s);if(!e.remotePeer.equals(d))throw $(new Error("identified peer does not match the expected peer"),O.ERR_INVALID_PEER);if(this.components.peerId.equals(d))throw $(new Error("identified peer is our own peer id?"),O.ERR_INVALID_PEER);const f=g8.getCleanMultiaddr(a);if(c!=null){qe("received signed peer record from %p",d);try{const g=await Oi.openAndCertify(c,Po.DOMAIN);if(!g.peerId.equals(d))throw $(new Error("identified peer does not match the expected peer"),O.ERR_INVALID_PEER);if(await this.components.peerStore.addressBook.consumePeerRecord(g)){await this.components.peerStore.protoBook.set(d,o),u!=null&&await this.components.peerStore.metadataBook.setValue(d,"AgentVersion",L(u)),l!=null&&await this.components.peerStore.metadataBook.setValue(d,"ProtocolVersion",L(l)),qe("identify completed for peer %p and protocols %o",d,o);return}}catch(g){qe("received invalid envelope, discard it and fallback to listenAddrs is available",g)}}else qe("no signed peer record received from %p",d);qe("falling back to legacy addresses from %p",d);try{await this.components.peerStore.addressBook.set(d,i.map(g=>St(g)))}catch(g){qe.error("received invalid addrs",g)}await this.components.peerStore.protoBook.set(d,o),u!=null&&await this.components.peerStore.metadataBook.setValue(d,"AgentVersion",L(u)),l!=null&&await this.components.peerStore.metadataBook.setValue(d,"ProtocolVersion",L(l)),qe("identify completed for peer %p and protocols %o",d,o),qe("received observed address of %s",f?.toString())}async _handleIdentify(e){const{connection:t,stream:n}=e,s=new ft.TimeoutController(this.init.timeout);try{Qe.setMaxListeners?.(1/0,s.signal)}catch{}try{const i=this.components.peerId.publicKey??new Uint8Array(0),o=await this.components.peerStore.get(this.components.peerId),a=this.components.addressManager.getAddresses().map(f=>f.decapsulateCode(at("p2p").code));let c=o.peerRecordEnvelope;if(a.length>0&&c==null){const f=new Po({peerId:this.components.peerId,multiaddrs:a}),g=await Oi.seal(f,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(g),c=g.marshal().subarray()}const u=Bc.encode({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:i,listenAddrs:a.map(f=>f.bytes),signedPeerRecord:c,observedAddr:t.remoteAddr.bytes,protocols:o.protocols}),l=Ao(n,s.signal),d=Ae([u],pl());await l.sink(d)}catch(i){qe.error("could not respond to identify request",i)}finally{n.close(),s.clear()}}async _handlePush(e){const{connection:t,stream:n}=e,s=new ft.TimeoutController(this.init.timeout);try{Qe.setMaxListeners?.(1/0,s.signal)}catch{}let i;try{const a=Ao(n,s.signal),c=await Ae([],a,qa({maxDataLength:this.init.maxIdentifyMessageSize??_$}),async u=>await xs(u));c!=null&&(i=Bc.decode(c))}catch(a){return qe.error("received invalid message",a)}finally{n.close(),s.clear()}if(i==null)return qe.error("received invalid message");const o=t.remotePeer;if(this.components.peerId.equals(o)){qe("received push from ourselves?");return}if(qe("received push from %p",o),i.signedPeerRecord!=null){qe("received signedPeerRecord in push");try{const a=await Oi.openAndCertify(i.signedPeerRecord,Po.DOMAIN);if(await this.components.peerStore.addressBook.consumePeerRecord(a)){qe("consumed signedPeerRecord sent in push"),await this.components.peerStore.protoBook.set(o,i.protocols);return}else qe("failed to consume signedPeerRecord sent in push")}catch(a){qe("received invalid envelope, discard it and fallback to listenAddrs is available",a)}}else qe("did not receive signedPeerRecord in push");try{await this.components.peerStore.addressBook.set(o,i.listenAddrs.map(a=>St(a)))}catch(a){qe.error("received invalid addrs",a)}try{await this.components.peerStore.protoBook.set(o,i.protocols)}catch(a){qe.error("received invalid protocols",a)}qe("handled push from %p",o)}static getCleanMultiaddr(e){if(e!=null&&e.length>0)try{return St(e)}catch{}}}var A0;(function(r){let e;r.codec=()=>(e==null&&(e=Jd((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.identifier!=="")&&(n.uint32(10),n.string(t.identifier)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={identifier:""},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.identifier=t.string();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Xd(t,r.codec()),r.decode=t=>Yd(t,r.codec())})(A0||(A0={}));var Bs;(function(r){let e;(function(s){s.OK="OK",s.NOT_FOUND="NOT_FOUND",s.ERROR="ERROR"})(e=r.StatusCode||(r.StatusCode={}));let t;(function(s){s[s.OK=0]="OK",s[s.NOT_FOUND=1]="NOT_FOUND",s[s.ERROR=2]="ERROR"})(t||(t={})),function(s){s.codec=()=>b6(t)}(e=r.StatusCode||(r.StatusCode={}));let n;r.codec=()=>(n==null&&(n=Jd((s,i,o={})=>{o.lengthDelimited!==!1&&i.fork(),(o.writeDefaults===!0||s.status!=null&&t[s.status]!==0)&&(i.uint32(8),r.StatusCode.codec().encode(s.status,i)),(o.writeDefaults===!0||s.data!=null&&s.data.byteLength>0)&&(i.uint32(18),i.bytes(s.data)),o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={status:e.OK,data:new Uint8Array(0)},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.status=r.StatusCode.codec().decode(s);break;case 2:o.data=s.bytes();break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>Xd(s,r.codec()),r.decode=s=>Yd(s,r.codec())})(Bs||(Bs={}));const BDe="0.0.1",zDe="fetch",Mn=N("libp2p:fetch");class FDe{constructor(e,t){this.started=!1,this.components=e,this.protocol=`/${t.protocolPrefix??"libp2p"}/${zDe}/${BDe}`,this.lookupFunctions=new Map,this.handleMessage=this.handleMessage.bind(this),this.init=t}async start(){await this.components.registrar.handle(this.protocol,e=>{this.handleMessage(e).catch(t=>{Mn.error(t)}).finally(()=>{e.stream.close()})},{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async fetch(e,t,n={}){Mn("dialing %s to %p",this.protocol,e);const s=await this.components.connectionManager.openConnection(e,n);let i,o=n.signal,a;if(o==null){Mn("using default timeout of %d ms",this.init.timeout),i=new ft.TimeoutController(this.init.timeout),o=i.signal;try{Qe.setMaxListeners?.(1/0,i.signal)}catch{}}try{a=await s.newStream(this.protocol,{signal:o});const c=Ao(a,o);return Mn("fetch %s",t),await Ae([A0.encode({identifier:t})],pl(),c,qa(),async function(l){const d=await xs(l);if(d==null)throw $(new Error("No data received"),O.ERR_INVALID_MESSAGE);const f=Bs.decode(d);switch(f.status){case Bs.StatusCode.OK:return Mn("received status for %s ok",t),f.data;case Bs.StatusCode.NOT_FOUND:return Mn("received status for %s not found",t),null;case Bs.StatusCode.ERROR:{Mn("received status for %s error",t);const g=C(f.data);throw $(new Error("Error in fetch protocol response: "+g),O.ERR_INVALID_PARAMETERS)}default:throw Mn("received status for %s unknown",t),$(new Error("Unknown response status"),O.ERR_INVALID_MESSAGE)}})??null}finally{i?.clear(),a?.close()}}async handleMessage(e){const{stream:t}=e,n=this;await Ae(t,qa(),async function*(s){const i=await xs(s);if(i==null)throw $(new Error("No data received"),O.ERR_INVALID_MESSAGE);const o=A0.decode(i);let a;const c=n._getLookupFunction(o.identifier);if(c!=null){Mn("look up data with identifier %s",o.identifier);const u=await c(o.identifier);u!=null?(Mn("sending status for %s ok",o.identifier),a={status:Bs.StatusCode.OK,data:u}):(Mn("sending status for %s not found",o.identifier),a={status:Bs.StatusCode.NOT_FOUND,data:new Uint8Array(0)})}else{Mn("sending status for %s error",o.identifier);const u=L(`No lookup function registered for key: ${o.identifier}`);a={status:Bs.StatusCode.ERROR,data:u}}yield Bs.encode(a)},pl(),t)}_getLookupFunction(e){for(const t of this.lookupFunctions.keys())if(e.startsWith(t))return this.lookupFunctions.get(t)}registerLookupFunction(e,t){if(this.lookupFunctions.has(e))throw $(new Error("Fetch protocol handler for key prefix '"+e+"' already registered"),O.ERR_KEY_ALREADY_EXISTS);this.lookupFunctions.set(e,t)}unregisterLookupFunction(e,t){t!=null&&this.lookupFunctions.get(e)!==t||this.lookupFunctions.delete(e)}}const VDe=32,jDe="1.0.0",qDe="ping",S$=N("libp2p:ping");class KDe{constructor(e,t){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix}/${qDe}/${jDe}`,this.init=t}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.init.maxInboundStreams,maxOutboundStreams:this.init.maxOutboundStreams}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){const{stream:t}=e;Ae(t,t).catch(n=>{S$.error(n)})}async ping(e,t={}){S$("dialing %s to %p",this.protocol,e);const n=Date.now(),s=J0(VDe),i=await this.components.connectionManager.openConnection(e,t);let o,a=t.signal,c;if(a==null){o=new ft.TimeoutController(this.init.timeout),a=o.signal;try{Qe.setMaxListeners?.(1/0,o.signal)}catch{}}try{c=await i.newStream([this.protocol],{signal:a});const u=Ao(c,a),l=await Ae([s],u,async f=>await xs(f)),d=Date.now();if(l==null||!me(s,l.subarray()))throw $(new Error("Received wrong ping ack"),O.ERR_WRONG_PING_ACK);return d-n}finally{o?.clear(),c?.close()}}}async function GDe(){throw new Error("Not supported in browsers")}function HDe(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function WDe(r){const{address:e}=r.nodeAddress();return HDe(e)}const aw=N("libp2p:nat"),cw=7200;function QDe(r=1024,e=65535){return Math.floor(Math.random()*(e-r+1)+r)}class YDe{constructor(e,t){if(this.components=e,this.started=!1,this.enabled=t.enabled,this.externalAddress=t.externalAddress,this.localAddress=t.localAddress,this.description=t.description??`${PDe}@${mL} ${this.components.peerId.toString()}`,this.ttl=t.ttl??cw,this.keepAlive=t.keepAlive??!0,this.gateway=t.gateway,this.ttl<cw)throw $(new Error(`NatManager ttl should be at least ${cw} seconds`),O.ERR_INVALID_PARAMETERS)}isStarted(){return this.started}start(){}afterStart(){$d||!this.enabled||this.started||(this.started=!0,this._start().catch(e=>{aw.error(e)}))}async _start(){const e=this.components.transportManager.getAddrs();for(const t of e){const{family:n,host:s,port:i,transport:o}=t.toOptions();if(!t.isThinWaistAddress()||o!=="tcp"||WDe(t)||n!==4)continue;const a=await this._getClient(),c=this.externalAddress??await a.externalIp(),u=dg(c);if(u===!0)throw new Error(`${c} is private - please set config.nat.externalIp to an externally routable IP or ensure you are not behind a double NAT`);if(u==null)throw new Error(`${c} is not an IP address`);const l=QDe();aw(`opening uPnP connection from ${c}:${l} to ${s}:${i}`),await a.map({publicPort:l,localPort:i,localAddress:this.localAddress,protocol:o.toUpperCase()==="TCP"?"TCP":"UDP"}),this.components.addressManager.addObservedAddr(yTe({family:4,address:c,port:l},o))}}async _getClient(){return this.client!=null?this.client:(this.client=await GDe({description:this.description,ttl:this.ttl,keepAlive:this.keepAlive,gateway:this.gateway}),this.client)}async stop(){if(!($d||this.client==null))try{await this.client.close(),this.client=void 0}catch(e){aw.error(e)}}}const XDe=N("libp2p:peer-record-updater");class JDe{constructor(e){this.components=e,this.started=!1,this.update=this.update.bind(this)}isStarted(){return this.started}async start(){this.started=!0,this.components.transportManager.addEventListener("listener:listening",this.update),this.components.transportManager.addEventListener("listener:close",this.update),this.components.addressManager.addEventListener("change:addresses",this.update)}async stop(){this.started=!1,this.components.transportManager.removeEventListener("listener:listening",this.update),this.components.transportManager.removeEventListener("listener:close",this.update),this.components.addressManager.removeEventListener("change:addresses",this.update)}update(){Promise.resolve().then(async()=>{const e=new Po({peerId:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map(n=>n.decapsulateCode(at("p2p").code))}),t=await Oi.seal(e,this.components.peerId);await this.components.peerStore.addressBook.consumePeerRecord(t)}).catch(e=>{XDe.error("Could not update self peer record: %o",e)})}}class ZDe{constructor(e){this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw $(new Error(Oe.NOT_FOUND),O.ERR_NOT_FOUND)}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}}const A$=es,eOe=ts,vL=function(r){let e=0;if(r=r.toString().trim(),A$(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(eOe(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=A$(t[n]);let o;i&&(o=vL(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},tOe=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},Un=-1,$0={},v6={},rOe=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Un,"ip6zone"],[43,8,"ipcidr"],[53,Un,"dns",!0],[54,Un,"dns4",!0],[55,Un,"dns6",!0],[56,Un,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc"],[281,0,"webrtc-w3c"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Un,"unix",!1,!0],[421,Un,"ipfs"],[421,Un,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Un,"garlic64"],[448,0,"tls"],[449,Un,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Un,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,Un,"memory"]];rOe.forEach(r=>{const e=nOe(...r);v6[e.code]=e,$0[e.name]=e});function nOe(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function kt(r){if(typeof r=="number"){if(v6[r]!=null)return v6[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if($0[r]!=null)return $0[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}var sOe=_L,$$=128,iOe=127,oOe=~iOe,aOe=Math.pow(2,31);function _L(r,e,t){e=e||[],t=t||0;for(var n=t;r>=aOe;)e[t++]=r&255|$$,r/=128;for(;r&oOe;)e[t++]=r&255|$$,r>>>=7;return e[t]=r|0,_L.bytes=t-n+1,e}var cOe=_6,lOe=128,R$=127;function _6(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw _6.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&R$)<<s:(o&R$)*Math.pow(2,s),s+=7}while(o>=lOe);return _6.bytes=i-n,t}var uOe=Math.pow(2,7),dOe=Math.pow(2,14),hOe=Math.pow(2,21),fOe=Math.pow(2,28),pOe=Math.pow(2,35),gOe=Math.pow(2,42),yOe=Math.pow(2,49),wOe=Math.pow(2,56),bOe=Math.pow(2,63),mOe=function(r){return r<uOe?1:r<dOe?2:r<hOe?3:r<fOe?4:r<pOe?5:r<gOe?6:r<yOe?7:r<wOe?8:r<bOe?9:10},EOe={encode:sOe,decode:cOe,encodingLength:mOe},R0=EOe;const S6=(r,e=0)=>[R0.decode(r,e),R0.decode.bytes],T0=(r,e,t=0)=>(R0.encode(r,e,t),e),I0=r=>R0.encodingLength(r),vOe=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},y8=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},_Oe=r=>new TextEncoder().encode(r),SOe=r=>new TextDecoder().decode(r),AOe=(r,e)=>{const t=e.byteLength,n=I0(r),s=n+I0(t),i=new Uint8Array(s+t);return T0(r,i,0),T0(t,i,n),i.set(e,s),new w8(r,t,e,i)},SL=r=>{const e=y8(r),[t,n]=S6(e),[s,i]=S6(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new w8(t,s,o,e)},$Oe=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&vOe(r.bytes,t.bytes)}};let w8=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};function ROe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var TOe=ROe,IOe=TOe;let COe=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},xOe=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return AL(this,e)}},DOe=class{constructor(e){this.decoders=e}or(e){return AL(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const AL=(r,e)=>new DOe({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let OOe=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new COe(e,t,n),this.decoder=new xOe(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const pg=({name:r,prefix:e,encode:t,decode:n})=>new OOe(r,e,t,n),Jh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=IOe(t,e);return pg({prefix:r,name:e,encode:n,decode:i=>y8(s(i))})},POe=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},kOe=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},lr=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>pg({prefix:e,name:r,encode(s){return kOe(s,n,t)},decode(s){return POe(s,n,t,r)}}),$s=Jh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),NOe=Jh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),LOe=Object.freeze(Object.defineProperty({__proto__:null,base58btc:$s,base58flickr:NOe},Symbol.toStringTag,{value:"Module"})),No=lr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),MOe=lr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),UOe=lr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),BOe=lr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),zOe=lr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),FOe=lr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),VOe=lr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),jOe=lr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),qOe=lr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),KOe=Object.freeze(Object.defineProperty({__proto__:null,base32:No,base32hex:zOe,base32hexpad:VOe,base32hexpadupper:jOe,base32hexupper:FOe,base32pad:UOe,base32padupper:BOe,base32upper:MOe,base32z:qOe},Symbol.toStringTag,{value:"Module"})),T$=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return HOe(t,A6(r),e||$s.encoder);default:return WOe(t,A6(r),e||No.encoder)}},I$=new WeakMap,A6=r=>{const e=I$.get(r);if(e==null){const t=new Map;return I$.set(r,t),t}return e};let $L=class Or{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ju)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==QOe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Or.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=AOe(e,t);return Or.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Or.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&$Oe(e.multihash,n.multihash)}toString(e){return T$(this,e)}toJSON(){return{"/":T$(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Or)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Or(n,s,i,o||C$(n,s,i.bytes))}else if(t[YOe]===!0){const{version:n,multihash:s,code:i}=t,o=SL(s);return Or.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ju)throw new Error(`Version 0 CID must use dag-pb (code: ${ju}) block encoding`);return new Or(e,t,n,n.bytes)}case 1:{const s=C$(e,t,n.bytes);return new Or(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Or.create(0,ju,e)}static createV1(e,t){return Or.create(1,e,t)}static decode(e){const[t,n]=Or.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Or.inspectBytes(e),n=t.size-t.multihashSize,s=y8(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new w8(t.multihashCode,t.digestSize,i,s);return[t.version===0?Or.createV0(o):Or.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=S6(e.subarray(t));return t+=f,d};let s=n(),i=ju;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=GOe(e,t),i=Or.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return A6(i).set(n,e),i}};const GOe=(r,e)=>{switch(r[0]){case"Q":{const t=e||$s;return[$s.prefix,t.decode(`${$s.prefix}${r}`)]}case $s.prefix:{const t=e||$s;return[$s.prefix,t.decode(r)]}case No.prefix:{const t=e||No;return[No.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},HOe=(r,e,t)=>{const{prefix:n}=t;if(n!==$s.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},WOe=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},ju=112,QOe=18,C$=(r,e,t)=>{const n=I0(r),s=n+I0(e),i=new Uint8Array(s+t.byteLength);return T0(r,i,0),T0(e,i,n),i.set(t,s),i},YOe=Symbol.for("@ipld/js-cid/CID"),XOe=pg({prefix:"\0",name:"identity",encode:r=>SOe(r),decode:r=>_Oe(r)}),JOe=Object.freeze(Object.defineProperty({__proto__:null,identity:XOe},Symbol.toStringTag,{value:"Module"})),ZOe=lr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),ePe=Object.freeze(Object.defineProperty({__proto__:null,base2:ZOe},Symbol.toStringTag,{value:"Module"})),tPe=lr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),rPe=Object.freeze(Object.defineProperty({__proto__:null,base8:tPe},Symbol.toStringTag,{value:"Module"})),nPe=Jh({prefix:"9",name:"base10",alphabet:"0123456789"}),sPe=Object.freeze(Object.defineProperty({__proto__:null,base10:nPe},Symbol.toStringTag,{value:"Module"})),iPe=lr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),oPe=lr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),aPe=Object.freeze(Object.defineProperty({__proto__:null,base16:iPe,base16upper:oPe},Symbol.toStringTag,{value:"Module"})),cPe=Jh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),lPe=Jh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),uPe=Object.freeze(Object.defineProperty({__proto__:null,base36:cPe,base36upper:lPe},Symbol.toStringTag,{value:"Module"})),dPe=lr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),hPe=lr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),fPe=lr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),pPe=lr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),gPe=Object.freeze(Object.defineProperty({__proto__:null,base64:dPe,base64pad:hPe,base64url:fPe,base64urlpad:pPe},Symbol.toStringTag,{value:"Module"})),RL=Array.from(""),yPe=RL.reduce((r,e,t)=>(r[t]=e,r),[]),wPe=RL.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function bPe(r){return r.reduce((e,t)=>(e+=yPe[t],e),"")}function mPe(r){const e=[];for(const t of r){const n=wPe[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const EPe=pg({prefix:"",name:"base256emoji",encode:bPe,decode:mPe}),vPe=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:EPe},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const _Pe={...JOe,...ePe,...rPe,...sPe,...aPe,...KOe,...uPe,...LOe,...gPe,...vPe};function SPe(r,e){switch(kt(r).code){case 4:case 41:return RPe(e);case 42:return O$(e);case 6:case 273:case 33:case 132:return TL(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return O$(e);case 421:return xPe(e);case 444:return P$(e);case 445:return P$(e);case 466:return CPe(e);default:return C(e,"base16")}}function APe(r,e){switch(kt(r).code){case 4:return x$(e);case 41:return x$(e);case 42:return D$(e);case 6:case 273:case 33:case 132:return b8(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return D$(e);case 421:return TPe(e);case 444:return DPe(e);case 445:return OPe(e);case 466:return IPe(e);default:return L(e,"base16")}}const lw=Object.values(_Pe).map(r=>r.decoder),$Pe=function(){let r=lw[0].or(lw[1]);return lw.slice(2).forEach(e=>r=r.or(e)),r}();function x$(r){if(!tt(r))throw new Error("invalid ip address");return vL(r)}function RPe(r){const e=tOe(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function b8(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function TL(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function D$(r){const e=L(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function O$(r){const e=D.decode(r);if(r=r.slice(D.decode.bytes),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function TPe(r){let e;r[0]==="Q"||r[0]==="1"?e=SL($s.decode(`z${r}`)).bytes:e=$L.parse(r).multihash.bytes;const t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function IPe(r){const e=$Pe.decode(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function CPe(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function xPe(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function DPe(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=No.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=b8(n);return M([t,s],t.length+s.length)}function OPe(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=No.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=b8(n);return M([t,s],t.length+s.length)}function P$(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=TL(t);return`${n}:${s}`}function PPe(r){const e=[],t=r.split("/").slice(1);if(t.length===1&&t[0]==="")return[];for(let n=0;n<t.length;n++){const s=t[n],i=kt(s);if(i.size===0){e.push([s]);continue}if(n++,n>=t.length)throw DL("invalid address: "+r);if(i.path===!0){e.push([s,E8(t.slice(n).join("/"))]);break}e.push([s,t[n]])}return e}function kPe(r){const e=[];return r.map(t=>{const n=gg(t);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),E8(e.join("/"))}function NPe(r){return r.map(e=>{Array.isArray(e)||(e=[e]);const t=gg(e);return e.length>1?[t.code,APe(t.code,e[1])]:[t.code]})}function IL(r){return r.map(e=>{const t=gg(e);return e[1]!=null?[t.code,SPe(t.code,e[1])]:[t.code]})}function CL(r){return $6(M(r.map(e=>{const t=gg(e);let n=Uint8Array.from(D.encode(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n})))}function xL(r,e){return r.size>0?r.size/8:r.size===0?0:D.decode(e)+(D.decode.bytes??0)}function m8(r){const e=[];let t=0;for(;t<r.length;){const n=D.decode(r,t),s=D.decode.bytes??0,i=kt(n),o=xL(i,r.slice(t+s));if(o===0){e.push([n]),t+=s;continue}const a=r.slice(t+s,t+s+o);if(t+=o+s,t>r.length)throw DL("Invalid address Uint8Array: "+C(r,"base16"));e.push([n,a])}return e}function k$(r){const e=m8(r),t=IL(e);return kPe(t)}function LPe(r){r=E8(r);const e=PPe(r),t=NPe(e);return CL(t)}function MPe(r){return LPe(r)}function $6(r){const e=UPe(r);if(e!=null)throw e;return Uint8Array.from(r)}function UPe(r){try{m8(r)}catch(e){return e}}function E8(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function DL(r){return new Error("Error parsing address: "+r)}function gg(r){return kt(r[0])}var vc=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},uw=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},qu,Ku,Gu,N$;const BPe=Symbol.for("nodejs.util.inspect.custom"),zPe=[kt("dns").code,kt("dns4").code,kt("dns6").code,kt("dnsaddr").code],FPe=new Map,OL=Symbol.for("@multiformats/js-multiaddr/multiaddr");function PL(r){return!!r?.[OL]}let VPe=class kc{constructor(e){if(qu.set(this,void 0),Ku.set(this,void 0),Gu.set(this,void 0),this[N$]=!0,e==null&&(e=""),e instanceof Uint8Array)this.bytes=$6(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=MPe(e)}else if(PL(e))this.bytes=$6(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr")}toString(){return vc(this,qu,"f")==null&&uw(this,qu,k$(this.bytes),"f"),vc(this,qu,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=kt("tcp"),a=kt("udp"),c=kt("ip4"),u=kt("ip6"),l=kt("dns6"),d=kt("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),zPe.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=kt(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=kt(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map(e=>Object.assign({},kt(e)))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=D.decode(t,n),i=D.decode.bytes??0,o=kt(s),a=xL(o,t.slice(n+i));n+=a+i,e.push(s)}return e}protoNames(){return this.protos().map(e=>e.name)}tuples(){return vc(this,Ku,"f")==null&&uw(this,Ku,m8(this.bytes),"f"),vc(this,Ku,"f")}stringTuples(){return vc(this,Gu,"f")==null&&uw(this,Gu,IL(this.tuples()),"f"),vc(this,Gu,"f")}encapsulate(e){return e=new kc(e),new kc(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new kc(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new kc(CL(t.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter(n=>n[0]===$0.ipfs.code).pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C($s.decode(`z${n}`),"base58btc"):C($L.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){let e=null;try{e=this.stringTuples().filter(t=>kt(t[0]).path===!0)[0][1],e==null&&(e=null)}catch{e=null}return e}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=FPe.get(t.name);if(n==null)throw $(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new kc(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(qu=new WeakMap,Ku=new WeakMap,Gu=new WeakMap,N$=OL,BPe)](){return`Multiaddr(${k$(this.bytes)})`}};function L$(r){return new VPe(r)}const $e={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS",ERR_NOT_FOUND:"ERR_NOT_FOUND"},je=N("libp2p:peer-store:address-book"),Kf="change:multiaddrs";async function jPe(){return!0}class qPe{constructor(e,t,n){this.dispatchEvent=e,this.store=t,this.addressFilter=n??jPe}async consumePeerRecord(e){je.trace("consumePeerRecord await write lock");const t=await this.store.lock.writeLock();je.trace("consumePeerRecord got write lock");let n,s,i;try{let o;try{o=Po.createFromProtobuf(e.payload)}catch{return je.error("invalid peer record received"),!1}n=o.peerId;const a=o.multiaddrs;if(!n.equals(e.peerId))return je("signing key does not match PeerId in the PeerRecord"),!1;if(a==null||a.length===0)return!1;if(await this.store.has(n)&&(s=await this.store.load(n),s.peerRecordEnvelope!=null)){const u=await Oi.createFromProtobuf(s.peerRecordEnvelope),l=Po.createFromProtobuf(u.payload);if(l.seqNumber>=o.seqNumber)return je("sequence number was lower or equal to existing sequence number - stored: %d received: %d",l.seqNumber,o.seqNumber),!1}const c=await dw(n,a,this.addressFilter,!0);i=await this.store.patchOrCreate(n,{addresses:c,peerRecordEnvelope:e.marshal().subarray()}),je("stored provided peer record for %p",o.peerId)}finally{je.trace("consumePeerRecord release write lock"),t()}return this.dispatchEvent(new W(Kf,{detail:{peerId:n,multiaddrs:i.addresses.map(({multiaddr:o})=>o),oldMultiaddrs:s==null?[]:s.addresses.map(({multiaddr:o})=>o)}})),!0}async getRawEnvelope(e){je.trace("getRawEnvelope await read lock");const t=await this.store.lock.readLock();je.trace("getRawEnvelope got read lock");try{return(await this.store.load(e)).peerRecordEnvelope}catch(n){if(n.code!==$e.ERR_NOT_FOUND)throw n}finally{je.trace("getRawEnvelope release read lock"),t()}}async getPeerRecord(e){const t=await this.getRawEnvelope(e);if(t!=null)return await Oi.createFromProtobuf(t)}async get(e){e=Gt(e),je.trace("get wait for read lock");const t=await this.store.lock.readLock();je.trace("get got read lock");try{return(await this.store.load(e)).addresses}catch(n){if(n.code!==$e.ERR_NOT_FOUND)throw n}finally{je.trace("get release read lock"),t()}return[]}async set(e,t){if(e=Gt(e),!Array.isArray(t))throw je.error("multiaddrs must be an array of Multiaddrs"),new B("multiaddrs must be an array of Multiaddrs",$e.ERR_INVALID_PARAMETERS);je.trace("set await write lock");const n=await this.store.lock.writeLock();je.trace("set got write lock");let s=!1,i,o;try{const a=await dw(e,t,this.addressFilter);if(a.length===0)return;try{if(i=await this.store.load(e),s=!0,new Set([...a.map(({multiaddr:c})=>c.toString()),...i.addresses.map(({multiaddr:c})=>c.toString())]).size===i.addresses.length&&a.length===i.addresses.length)return}catch(c){if(c.code!==$e.ERR_NOT_FOUND)throw c}o=await this.store.patchOrCreate(e,{addresses:a}),je("set multiaddrs for %p",e)}finally{je.trace("set multiaddrs for %p",e),je("set release write lock"),n()}this.dispatchEvent(new W(Kf,{detail:{peerId:e,multiaddrs:o.addresses.map(a=>a.multiaddr),oldMultiaddrs:i==null?[]:i.addresses.map(({multiaddr:a})=>a)}})),s||this.dispatchEvent(new W("peer",{detail:{id:e,multiaddrs:o.addresses.map(a=>a.multiaddr),protocols:o.protocols}}))}async add(e,t){if(e=Gt(e),!Array.isArray(t))throw je.error("multiaddrs must be an array of Multiaddrs"),new B("multiaddrs must be an array of Multiaddrs",$e.ERR_INVALID_PARAMETERS);je.trace("add await write lock");const n=await this.store.lock.writeLock();je.trace("add got write lock");let s,i,o;try{const a=await dw(e,t,this.addressFilter);if(a.length===0)return;try{if(i=await this.store.load(e),s=!0,new Set([...a.map(({multiaddr:c})=>c.toString()),...i.addresses.map(({multiaddr:c})=>c.toString())]).size===i.addresses.length)return}catch(c){if(c.code!==$e.ERR_NOT_FOUND)throw c}o=await this.store.mergeOrCreate(e,{addresses:a}),je("added multiaddrs for %p",e)}finally{je.trace("set release write lock"),n()}this.dispatchEvent(new W(Kf,{detail:{peerId:e,multiaddrs:o.addresses.map(a=>a.multiaddr),oldMultiaddrs:i==null?[]:i.addresses.map(({multiaddr:a})=>a)}})),s===!0&&this.dispatchEvent(new W("peer",{detail:{id:e,multiaddrs:o.addresses.map(a=>a.multiaddr),protocols:o.protocols}}))}async delete(e){e=Gt(e),je.trace("delete await write lock");const t=await this.store.lock.writeLock();je.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==$e.ERR_NOT_FOUND)throw s}await this.store.patchOrCreate(e,{addresses:[]})}finally{je.trace("delete release write lock"),t()}n!=null&&this.dispatchEvent(new W(Kf,{detail:{peerId:e,multiaddrs:[],oldMultiaddrs:n==null?[]:n.addresses.map(({multiaddr:s})=>s)}}))}}async function dw(r,e,t,n=!1){const s=[];return await Promise.all(e.map(async i=>{if(!PL(i))throw je.error("multiaddr must be an instance of Multiaddr"),new B("multiaddr must be an instance of Multiaddr",$e.ERR_INVALID_PARAMETERS);await t(r,i)&&s.push({multiaddr:i,isCertified:n})})),s}const ks=N("libp2p:peer-store:key-book"),M$="change:pubkey";class KPe{constructor(e,t){this.dispatchEvent=e,this.store=t}async set(e,t){if(e=Gt(e),!(t instanceof Uint8Array))throw ks.error("publicKey must be an instance of Uint8Array to store data"),new B("publicKey must be an instance of PublicKey",$e.ERR_INVALID_PARAMETERS);ks.trace("set await write lock");const n=await this.store.lock.writeLock();ks.trace("set got write lock");let s=!1,i;try{try{if(i=await this.store.load(e),i.pubKey!=null&&me(i.pubKey,t))return}catch(o){if(o.code!==$e.ERR_NOT_FOUND)throw o}await this.store.patchOrCreate(e,{pubKey:t}),s=!0}finally{ks.trace("set release write lock"),n()}s&&this.dispatchEvent(new W(M$,{detail:{peerId:e,publicKey:t,oldPublicKey:i?.pubKey}}))}async get(e){e=Gt(e),ks.trace("get await write lock");const t=await this.store.lock.readLock();ks.trace("get got write lock");try{return(await this.store.load(e)).pubKey}catch(n){if(n.code!==$e.ERR_NOT_FOUND)throw n}finally{ks("get release write lock"),t()}}async delete(e){e=Gt(e),ks.trace("delete await write lock");const t=await this.store.lock.writeLock();ks.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==$e.ERR_NOT_FOUND)throw s}await this.store.patchOrCreate(e,{pubKey:void 0})}catch(s){if(s.code!==$e.ERR_NOT_FOUND)throw s}finally{ks.trace("delete release write lock"),t()}this.dispatchEvent(new W(M$,{detail:{peerId:e,publicKey:void 0,oldPublicKey:n?.pubKey}}))}}const Rt=N("libp2p:peer-store:metadata-book"),Gf="change:metadata";class GPe{constructor(e,t){this.dispatchEvent=e,this.store=t}async get(e){e=Gt(e),Rt.trace("get await read lock");const t=await this.store.lock.readLock();Rt.trace("get got read lock");try{return(await this.store.load(e)).metadata}catch(n){if(n.code!==$e.ERR_NOT_FOUND)throw n}finally{Rt.trace("get release read lock"),t()}return new Map}async getValue(e,t){e=Gt(e),Rt.trace("getValue await read lock");const n=await this.store.lock.readLock();Rt.trace("getValue got read lock");try{return(await this.store.load(e)).metadata.get(t)}catch(s){if(s.code!==$e.ERR_NOT_FOUND)throw s}finally{Rt.trace("getValue release write lock"),n()}}async set(e,t){if(e=Gt(e),!(t instanceof Map))throw Rt.error("valid metadata must be provided to store data"),new B("valid metadata must be provided",$e.ERR_INVALID_PARAMETERS);Rt.trace("set await write lock");const n=await this.store.lock.writeLock();Rt.trace("set got write lock");let s;try{try{s=await this.store.load(e)}catch(i){if(i.code!==$e.ERR_NOT_FOUND)throw i}await this.store.mergeOrCreate(e,{metadata:t})}finally{Rt.trace("set release write lock"),n()}this.dispatchEvent(new W(Gf,{detail:{peerId:e,metadata:t,oldMetadata:s==null?new Map:s.metadata}}))}async setValue(e,t,n){if(e=Gt(e),typeof t!="string"||!(n instanceof Uint8Array))throw Rt.error("valid key and value must be provided to store data"),new B("valid key and value must be provided",$e.ERR_INVALID_PARAMETERS);Rt.trace("setValue await write lock");const s=await this.store.lock.writeLock();Rt.trace("setValue got write lock");let i,o;try{try{i=await this.store.load(e);const a=i.metadata.get(t);if(a!=null&&me(n,a))return}catch(a){if(a.code!==$e.ERR_NOT_FOUND)throw a}o=await this.store.mergeOrCreate(e,{metadata:new Map([[t,n]])})}finally{Rt.trace("setValue release write lock"),s()}this.dispatchEvent(new W(Gf,{detail:{peerId:e,metadata:o.metadata,oldMetadata:i==null?new Map:i.metadata}}))}async delete(e){e=Gt(e),Rt.trace("delete await write lock");const t=await this.store.lock.writeLock();Rt.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==$e.ERR_NOT_FOUND)throw s}n!=null&&await this.store.patch(e,{metadata:new Map})}finally{Rt.trace("delete release write lock"),t()}n!=null&&this.dispatchEvent(new W(Gf,{detail:{peerId:e,metadata:new Map,oldMetadata:n.metadata}}))}async deleteValue(e,t){e=Gt(e),Rt.trace("deleteValue await write lock");const n=await this.store.lock.writeLock();Rt.trace("deleteValue got write lock");let s,i;try{i=await this.store.load(e),s=i.metadata,s.delete(t),await this.store.patch(e,{metadata:s})}catch(o){if(o.code!==$e.ERR_NOT_FOUND)throw o}finally{Rt.trace("deleteValue release write lock"),n()}s!=null&&this.dispatchEvent(new W(Gf,{detail:{peerId:e,metadata:s,oldMetadata:i==null?new Map:i.metadata}}))}}const Tt=N("libp2p:peer-store:proto-book"),Hf="change:protocols";class HPe{constructor(e,t){this.dispatchEvent=e,this.store=t}async get(e){Tt.trace("get wait for read lock");const t=await this.store.lock.readLock();Tt.trace("get got read lock");try{return(await this.store.load(e)).protocols}catch(n){if(n.code!==$e.ERR_NOT_FOUND)throw n}finally{Tt.trace("get release read lock"),t()}return[]}async set(e,t){if(e=Gt(e),!Array.isArray(t))throw Tt.error("protocols must be provided to store data"),new B("protocols must be provided",$e.ERR_INVALID_PARAMETERS);Tt.trace("set await write lock");const n=await this.store.lock.writeLock();Tt.trace("set got write lock");let s,i;try{try{if(s=await this.store.load(e),new Set([...t]).size===s.protocols.length)return}catch(o){if(o.code!==$e.ERR_NOT_FOUND)throw o}i=await this.store.patchOrCreate(e,{protocols:t}),Tt("stored provided protocols for %p",e)}finally{Tt.trace("set release write lock"),n()}this.dispatchEvent(new W(Hf,{detail:{peerId:e,protocols:i.protocols,oldProtocols:s==null?[]:s.protocols}}))}async add(e,t){if(e=Gt(e),!Array.isArray(t))throw Tt.error("protocols must be provided to store data"),new B("protocols must be provided",$e.ERR_INVALID_PARAMETERS);Tt.trace("add await write lock");const n=await this.store.lock.writeLock();Tt.trace("add got write lock");let s,i;try{try{if(s=await this.store.load(e),new Set([...s.protocols,...t]).size===s.protocols.length)return}catch(o){if(o.code!==$e.ERR_NOT_FOUND)throw o}i=await this.store.mergeOrCreate(e,{protocols:t}),Tt("added provided protocols for %p",e)}finally{Tt.trace("add release write lock"),n()}this.dispatchEvent(new W(Hf,{detail:{peerId:e,protocols:i.protocols,oldProtocols:s==null?[]:s.protocols}}))}async remove(e,t){if(e=Gt(e),!Array.isArray(t))throw Tt.error("protocols must be provided to store data"),new B("protocols must be provided",$e.ERR_INVALID_PARAMETERS);Tt.trace("remove await write lock");const n=await this.store.lock.writeLock();Tt.trace("remove got write lock");let s,i;try{try{s=await this.store.load(e);const o=new Set(s.protocols);for(const a of t)o.delete(a);if(s.protocols.length===o.size)return;t=Array.from(o)}catch(o){if(o.code!==$e.ERR_NOT_FOUND)throw o}i=await this.store.patchOrCreate(e,{protocols:t})}finally{Tt.trace("remove release write lock"),n()}this.dispatchEvent(new W(Hf,{detail:{peerId:e,protocols:i.protocols,oldProtocols:s==null?[]:s.protocols}}))}async delete(e){e=Gt(e),Tt.trace("delete await write lock");const t=await this.store.lock.writeLock();Tt.trace("delete got write lock");let n;try{try{n=await this.store.load(e)}catch(s){if(s.code!==$e.ERR_NOT_FOUND)throw s}await this.store.patchOrCreate(e,{protocols:[]})}finally{Tt.trace("delete release write lock"),t()}n!=null&&this.dispatchEvent(new W(Hf,{detail:{peerId:e,protocols:[],oldProtocols:n.protocols}}))}}var C0;(function(r){let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const i of t.addresses)n.uint32(10),x0.codec().encode(i,n);if(t.protocols!=null)for(const i of t.protocols)n.uint32(18),n.string(i);if(t.metadata!=null)for(const i of t.metadata)n.uint32(26),D0.codec().encode(i,n);t.pubKey!=null&&(n.uint32(34),n.bytes(t.pubKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={addresses:[],protocols:[],metadata:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.addresses.push(x0.codec().decode(t,t.uint32()));break;case 2:s.protocols.push(t.string());break;case 3:s.metadata.push(D0.codec().decode(t,t.uint32()));break;case 4:s.pubKey=t.bytes();break;case 5:s.peerRecordEnvelope=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(C0||(C0={}));var x0;(function(r){let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={multiaddr:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.multiaddr=t.bytes();break;case 2:s.isCertified=t.bool();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(x0||(x0={}));var D0;(function(r){let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key!==""&&(n.uint32(10),n.string(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={key:"",value:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.key=t.string();break;case 2:s.value=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(D0||(D0={}));const U$=N("libp2p:peer-store:store"),B$="/peers/";class WPe{constructor(e){this.components=e,this.lock=D4({name:"peer-store",singleProcess:!0})}_peerIdToDatastoreKey(e){if(e.type==null)throw U$.error("peerId must be an instance of peer-id to store data"),new B("peerId must be an instance of peer-id",$e.ERR_INVALID_PARAMETERS);const t=e.toCID().toString();return new ie(`${B$}${t}`)}async has(e){return await this.components.datastore.has(this._peerIdToDatastoreKey(e))}async delete(e){await this.components.datastore.delete(this._peerIdToDatastoreKey(e))}async load(e){const t=await this.components.datastore.get(this._peerIdToDatastoreKey(e)),n=C0.decode(t),s=new Map;for(const i of n.metadata)s.set(i.key,i.value);return{...n,id:e,addresses:n.addresses.map(({multiaddr:i,isCertified:o})=>({multiaddr:L$(i),isCertified:o??!1})),metadata:s,pubKey:n.pubKey??void 0,peerRecordEnvelope:n.peerRecordEnvelope??void 0}}async save(e){if(e.pubKey!=null&&e.id.publicKey!=null&&!me(e.pubKey,e.id.publicKey))throw U$.error("peer publicKey bytes do not match peer id publicKey bytes"),new B("publicKey bytes do not match peer id publicKey bytes",$e.ERR_INVALID_PARAMETERS);const t=new Set,n=e.addresses.filter(o=>t.has(o.multiaddr.toString())?!1:(t.add(o.multiaddr.toString()),!0)).sort((o,a)=>o.multiaddr.toString().localeCompare(a.multiaddr.toString())).map(({multiaddr:o,isCertified:a})=>({multiaddr:o.bytes,isCertified:a})),s=[];[...e.metadata.keys()].sort().forEach(o=>{const a=e.metadata.get(o);a!=null&&s.push({key:o,value:a})});const i=C0.encode({addresses:n,protocols:e.protocols.sort(),pubKey:e.pubKey,metadata:s,peerRecordEnvelope:e.peerRecordEnvelope});return await this.components.datastore.put(this._peerIdToDatastoreKey(e.id),i.subarray()),await this.load(e.id)}async patch(e,t){const n=await this.load(e);return await this._patch(e,t,n)}async patchOrCreate(e,t){let n;try{n=await this.load(e)}catch(s){if(s.code!==$e.ERR_NOT_FOUND)throw s;n={id:e,addresses:[],protocols:[],metadata:new Map}}return await this._patch(e,t,n)}async _patch(e,t,n){return await this.save({...n,...t,id:e})}async merge(e,t){const n=await this.load(e);return await this._merge(e,t,n)}async mergeOrCreate(e,t){let n;try{n=await this.load(e)}catch(s){if(s.code!==$e.ERR_NOT_FOUND)throw s;n={id:e,addresses:[],protocols:[],metadata:new Map}}return await this._merge(e,t,n)}async _merge(e,t,n){const s=new Map;return n.addresses.forEach(i=>{s.set(i.multiaddr.toString(),i.isCertified)}),(t.addresses??[]).forEach(i=>{const o=i.multiaddr.toString(),c=!!s.get(o)||i.isCertified;s.set(o,c)}),await this.save({id:e,addresses:Array.from(s.entries()).map(([i,o])=>({multiaddr:L$(i),isCertified:o})),protocols:Array.from(new Set([...n.protocols??[],...t.protocols??[]])),metadata:new Map([...n.metadata?.entries()??[],...t.metadata?.entries()??[]]),pubKey:t.pubKey??n?.pubKey,peerRecordEnvelope:t.peerRecordEnvelope??n?.peerRecordEnvelope})}async*all(){for await(const e of this.components.datastore.queryKeys({prefix:B$})){const t=e.toString().split("/")[2],n=No.decode(t);yield this.load(ni(n))}}}var uo;(function(r){let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.tags!=null)for(const i of t.tags)n.uint32(10),O0.codec().encode(i,n);s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={tags:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.tags.push(O0.codec().decode(t,t.uint32()));break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(uo||(uo={}));var O0;(function(r){let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.name!=null&&t.name!==""&&(n.uint32(10),n.string(t.name)),t.value!=null&&(n.uint32(16),n.uint32(t.value)),t.expiry!=null&&(n.uint32(24),n.uint64(t.expiry)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={name:""},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.name=t.string();break;case 2:s.value=t.uint32();break;case 3:s.expiry=t.uint64();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(O0||(O0={}));const Bn=N("libp2p:peer-store");class QPe extends gt{constructor(e,t={}){super(),this.components=e,this.store=new WPe(e),this.addressBook=new qPe(this.dispatchEvent.bind(this),this.store,t.addressFilter),this.keyBook=new KPe(this.dispatchEvent.bind(this),this.store),this.metadataBook=new GPe(this.dispatchEvent.bind(this),this.store),this.protoBook=new HPe(this.dispatchEvent.bind(this),this.store)}async forEach(e){Bn.trace("getPeers await read lock");const t=await this.store.lock.readLock();Bn.trace("getPeers got read lock");try{for await(const n of this.store.all())n.id.equals(this.components.peerId)||e(n)}finally{Bn.trace("getPeers release read lock"),t()}}async all(){const e=[];return await this.forEach(t=>{e.push(t)}),e}async delete(e){Bn.trace("delete await write lock");const t=await this.store.lock.writeLock();Bn.trace("delete got write lock");try{await this.store.delete(e)}finally{Bn.trace("delete release write lock"),t()}}async get(e){Bn.trace("get await read lock");const t=await this.store.lock.readLock();Bn.trace("get got read lock");try{return await this.store.load(e)}finally{Bn.trace("get release read lock"),t()}}async has(e){Bn.trace("has await read lock");const t=await this.store.lock.readLock();Bn.trace("has got read lock");try{return await this.store.has(e)}finally{Bn.trace("has release read lock"),t()}}async tagPeer(e,t,n={}){const s=n.value??0,i=Math.round(s),o=n.ttl??void 0;if(i!==s||i<0||i>100)throw new B("Tag value must be between 0-100","ERR_TAG_VALUE_OUT_OF_BOUNDS");const a=await this.metadataBook.getValue(e,"tags");let c=[];a!=null&&(c=uo.decode(a).tags),c=c.filter(u=>u.name!==t),c.push({name:t,value:i,expiry:o==null?void 0:BigInt(Date.now()+o)}),await this.metadataBook.setValue(e,"tags",uo.encode({tags:c}).subarray())}async unTagPeer(e,t){const n=await this.metadataBook.getValue(e,"tags");let s=[];n!=null&&(s=uo.decode(n).tags),s=s.filter(i=>i.name!==t),await this.metadataBook.setValue(e,"tags",uo.encode({tags:s}).subarray())}async getTags(e){const t=await this.metadataBook.getValue(e,"tags");let n=[];t!=null&&(n=uo.decode(t).tags);const s=BigInt(Date.now()),i=n.filter(o=>o.expiry==null||o.expiry>s);return i.length!==n.length&&await this.metadataBook.setValue(e,"tags",uo.encode({tags:i}).subarray()),i.map(o=>({name:o.name,value:o.value??0}))}}class YPe{constructor(e){this.dht=e}async provide(e){await Wt(this.dht.provide(e))}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await Wt(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw $(new Error("Not found"),"ERR_NOT_FOUND")}}class XPe{constructor(e={}){this._started=!1,this._peerId=e.peerId,this._addressManager=e.addressManager,this._peerStore=e.peerStore,this._upgrader=e.upgrader,this._metrics=e.metrics,this._registrar=e.registrar,this._connectionManager=e.connectionManager,this._transportManager=e.transportManager,this._connectionGater=e.connectionGater,this._contentRouting=e.contentRouting,this._peerRouting=e.peerRouting,this._datastore=e.datastore,this._connectionProtector=e.connectionProtector,this._dht=e.dht,this._pubsub=e.pubsub,this._dialer=e.dialer}isStarted(){return this._started}async beforeStart(){await Promise.all(Object.values(this).filter(e=>ra(e)).map(async e=>{e.beforeStart!=null&&await e.beforeStart()}))}async start(){await Promise.all(Object.values(this).filter(e=>ra(e)).map(async e=>{await e.start()})),this._started=!0}async afterStart(){await Promise.all(Object.values(this).filter(e=>ra(e)).map(async e=>{e.afterStart!=null&&await e.afterStart()}))}async beforeStop(){await Promise.all(Object.values(this).filter(e=>ra(e)).map(async e=>{e.beforeStop!=null&&await e.beforeStop()}))}async stop(){await Promise.all(Object.values(this).filter(e=>ra(e)).map(async e=>{await e.stop()})),this._started=!1}async afterStop(){await Promise.all(Object.values(this).filter(e=>ra(e)).map(async e=>{e.afterStop!=null&&await e.afterStop()}))}get peerId(){if(this._peerId==null)throw $(new Error("peerId not set"),"ERR_SERVICE_MISSING");return this._peerId}set peerId(e){this._peerId=e}get addressManager(){if(this._addressManager==null)throw $(new Error("addressManager not set"),"ERR_SERVICE_MISSING");return this._addressManager}set addressManager(e){this._addressManager=e}get peerStore(){if(this._peerStore==null)throw $(new Error("peerStore not set"),"ERR_SERVICE_MISSING");return this._peerStore}set peerStore(e){this._peerStore=e}get upgrader(){if(this._upgrader==null)throw $(new Error("upgrader not set"),"ERR_SERVICE_MISSING");return this._upgrader}set upgrader(e){this._upgrader=e}get registrar(){if(this._registrar==null)throw $(new Error("registrar not set"),"ERR_SERVICE_MISSING");return this._registrar}set registrar(e){this._registrar=e}get connectionManager(){if(this._connectionManager==null)throw $(new Error("connectionManager not set"),"ERR_SERVICE_MISSING");return this._connectionManager}set connectionManager(e){this._connectionManager=e}get transportManager(){if(this._transportManager==null)throw $(new Error("transportManager not set"),"ERR_SERVICE_MISSING");return this._transportManager}set transportManager(e){this._transportManager=e}get connectionGater(){if(this._connectionGater==null)throw $(new Error("connectionGater not set"),"ERR_SERVICE_MISSING");return this._connectionGater}set connectionGater(e){this._connectionGater=e}get contentRouting(){if(this._contentRouting==null)throw $(new Error("contentRouting not set"),"ERR_SERVICE_MISSING");return this._contentRouting}set contentRouting(e){this._contentRouting=e}get peerRouting(){if(this._peerRouting==null)throw $(new Error("peerRouting not set"),"ERR_SERVICE_MISSING");return this._peerRouting}set peerRouting(e){this._peerRouting=e}get datastore(){if(this._datastore==null)throw $(new Error("datastore not set"),"ERR_SERVICE_MISSING");return this._datastore}set datastore(e){this._datastore=e}get connectionProtector(){return this._connectionProtector}set connectionProtector(e){this._connectionProtector=e}get dialer(){if(this._dialer==null)throw $(new Error("dialer not set"),"ERR_SERVICE_MISSING");return this._dialer}set dialer(e){this._dialer=e}get metrics(){return this._metrics}set metrics(e){this._metrics=e}get dht(){return this._dht}set dht(e){this._dht=e}get pubsub(){return this._pubsub}set pubsub(e){this._pubsub=e}}var wl=1e3,bl=wl*60,ml=bl*60,Ga=ml*24,JPe=Ga*7,ZPe=Ga*365.25,eke=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return tke(r);if(t==="number"&&isFinite(r))return e.long?nke(r):rke(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function tke(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*ZPe;case"weeks":case"week":case"w":return t*JPe;case"days":case"day":case"d":return t*Ga;case"hours":case"hour":case"hrs":case"hr":case"h":return t*ml;case"minutes":case"minute":case"mins":case"min":case"m":return t*bl;case"seconds":case"second":case"secs":case"sec":case"s":return t*wl;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function rke(r){var e=Math.abs(r);return e>=Ga?Math.round(r/Ga)+"d":e>=ml?Math.round(r/ml)+"h":e>=bl?Math.round(r/bl)+"m":e>=wl?Math.round(r/wl)+"s":r+"ms"}function nke(r){var e=Math.abs(r);return e>=Ga?Wf(r,e,Ga,"day"):e>=ml?Wf(r,e,ml,"hour"):e>=bl?Wf(r,e,bl,"minute"):e>=wl?Wf(r,e,wl,"second"):r+" ms"}function Wf(r,e,t,n){var s=e>=t*1.5;return Math.round(r/t)+" "+n+(s?"s":"")}var ske=kL,ike=eke,Wo=kL.prototype,oke=new Date%1e9;function ake(){return(Math.random()*1e9>>>0)+oke++}function kL(r){r=r||{},this.id=r.id||ake(),this.max=r.max||1/0,this.items=r.items||[],this._lookup={},this.size=this.items.length,this.lastModified=new Date(r.lastModified||new Date);for(var e,t,n=this.items.length;n--;)e=this.items[n],t=new Date(e.expires)-new Date,this._lookup[e.key]=e,t>0?this.expire(e.key,t):t<=0&&this.delete(e.key)}Wo.has=function(r){return r in this._lookup};Wo.get=function(r){if(!this.has(r))return null;var e=this._lookup[r];return e.refresh&&this.expire(r,e.refresh),this.items.splice(this.items.indexOf(e),1),this.items.push(e),e.value};Wo.meta=function(r){if(!this.has(r))return null;var e=this._lookup[r];return"meta"in e?e.meta:null};Wo.set=function(r,e,t){var n=this._lookup[r],s=this._lookup[r]={key:r,value:e};return this.lastModified=new Date,n?(clearTimeout(n.timeout),this.items.splice(this.items.indexOf(n),1,s)):(this.size>=this.max&&this.delete(this.items[0].key),this.items.push(s),this.size++),t&&("ttl"in t&&this.expire(r,t.ttl),"meta"in t&&(s.meta=t.meta),t.refresh&&(s.refresh=t.ttl)),this};Wo.delete=function(r){var e=this._lookup[r];return e?(this.lastModified=new Date,this.items.splice(this.items.indexOf(e),1),clearTimeout(e.timeout),delete this._lookup[r],this.size--,this):!1};Wo.expire=function(r,e){var t=e||0,n=this._lookup[r];if(!n)return this;if(typeof t=="string"&&(t=ike(e)),typeof t!="number")throw new TypeError("Expiration time must be a string or number.");return clearTimeout(n.timeout),n.timeout=setTimeout(this.delete.bind(this,n.key),t),n.expires=Number(new Date)+t,this};Wo.clear=function(){for(var r=this.items.length;r--;)this.delete(this.items[r].key);return this};Wo.toJSON=function(){for(var r=new Array(this.items.length),e,t=r.length;t--;)e=this.items[t],r[t]={key:e.key,meta:e.meta,value:e.value,expires:e.expires,refresh:e.refresh};return{id:this.id,max:isFinite(this.max)?this.max:void 0,lastModified:this.lastModified,items:r}};const z$=Ge(ske),cke=globalThis.fetch,lke=globalThis.Headers;function hw(r,e,t){return`${r}?name=${e}&type=${t}`}async function uke(r,e){return await(await cke(r,{headers:new lke({accept:"application/dns-json"}),signal:e})).json()}function _c(r,e){return`${e}_${r}`}const fw=Object.assign(le("dns-over-http-resolver"),{error:le("dns-over-http-resolver:error")});class dke{constructor(e={}){this._cache=new z$({max:e?.maxCache??100}),this._TXTcache=new z$({max:e?.maxCache??100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=e.request??uke,this._abortControllers=[]}cancel(){this._abortControllers.forEach(e=>e.abort())}getServers(){return this._servers}_getShuffledServers(){const e=[...this._servers];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*t),s=e[t];e[t]=e[n],e[n]=s}return e}setServers(e){this._servers=e}async resolve(e,t="A"){switch(t){case"A":return await this.resolve4(e);case"AAAA":return await this.resolve6(e);case"TXT":return await this.resolveTxt(e);default:throw new Error(`${t} is not supported`)}}async resolve4(e){const t="A",n=this._cache.get(_c(e,t));if(n!=null)return n;let s=!1;for(const i of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(hw(i,e,t),o.signal),c=a.Answer.map(l=>l.data),u=Math.min(...a.Answer.map(l=>l.TTL));return this._cache.set(_c(e,t),c,{ttl:u}),c}catch{o.signal.aborted&&(s=!0),fw.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryA ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolve6(e){const t="AAAA",n=this._cache.get(_c(e,t));if(n!=null)return n;let s=!1;for(const i of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(hw(i,e,t),o.signal),c=a.Answer.map(l=>l.data),u=Math.min(...a.Answer.map(l=>l.TTL));return this._cache.set(_c(e,t),c,{ttl:u}),c}catch{o.signal.aborted&&(s=!0),fw.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}async resolveTxt(e){const t="TXT",n=this._TXTcache.get(_c(e,t));if(n!=null)return n;let s=!1;for(const i of this._getShuffledServers()){const o=new AbortController;this._abortControllers.push(o);try{const a=await this._request(hw(i,e,t),o.signal),c=a.Answer.map(l=>[l.data.replace(/['"]+/g,"")]),u=Math.min(...a.Answer.map(l=>l.TTL));return this._TXTcache.set(_c(e,t),c,{ttl:u}),c}catch{o.signal.aborted&&(s=!0),fw.error(`${i} could not resolve ${e} record ${t}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==o)}}throw s?Object.assign(new Error("queryTxt ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${e} record ${t}`)}clearCache(){this._cache.clear(),this._TXTcache.clear()}}const{code:hke}=at("dnsaddr");async function fke(r,e={}){const t=new dke;e.signal!=null&&e.signal.addEventListener("abort",()=>{t.cancel()});const n=r.getPeerId(),[,s]=r.stringTuples().find(([a])=>a===hke)??[];if(s==null)throw new Error("No hostname found in multiaddr");let o=(await t.resolveTxt(`_dnsaddr.${s}`)).flat().map(a=>a.split("=")[1]).filter(Boolean);return n!=null&&(o=o.filter(a=>a.includes(n))),o}const NL=3e4,pke=3e4,LL=100,ML=4,gke=25,yke={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{maxConnections:300,minConnections:50,autoDial:!0,autoDialInterval:1e4,maxParallelDials:LL,maxDialsPerPeer:ML,dialTimeout:NL,inboundUpgradeTimeout:pke,resolvers:{dnsaddr:fke},addressSorter:i8},connectionGater:{},transportManager:{faultTolerance:Hc.FATAL_ALL},peerRouting:{refreshManager:{enabled:!0,interval:6e5,bootDelay:1e4}},nat:{enabled:!0,ttl:7200,keepAlive:!0},relay:{enabled:!0,advertise:{bootDelay:YCe,enabled:!1,ttl:XCe},hop:{enabled:!1,active:!1,timeout:3e4},autoRelay:{enabled:!1,maxListeners:2}},identify:{protocolPrefix:"ipfs",host:{agentVersion:EL},timeout:6e4,maxInboundStreams:1,maxOutboundStreams:1,maxPushIncomingStreams:1,maxPushOutgoingStreams:1},ping:{protocolPrefix:"ipfs",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4},fetch:{protocolPrefix:"libp2p",maxInboundStreams:1,maxOutboundStreams:1,timeout:1e4}};function wke(r){const e=et(yke,r);if(e.transports==null||e.transports.length<1)throw $(new Error(Oe.ERR_TRANSPORTS_REQUIRED),O.ERR_TRANSPORTS_REQUIRED);if(e.connectionEncryption==null||e.connectionEncryption.length===0)throw $(new Error(Oe.CONN_ENCRYPTION_REQUIRED),O.CONN_ENCRYPTION_REQUIRED);if(e.connectionProtector===null&&globalThis.process?.env?.LIBP2P_FORCE_PNET!=null)throw $(new Error(Oe.ERR_PROTECTOR_REQUIRED),O.ERR_PROTECTOR_REQUIRED);return e.identify.host.agentVersion===EL&&($T||RT?e.identify.host.agentVersion+=` UserAgent=${globalThis.process.version}`:($d||rm||TT||iU)&&(e.identify.host.agentVersion+=` UserAgent=${globalThis.navigator.userAgent}`)),e}var F$;(function(r){let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.id!=null&&(n.uint32(10),n.bytes(t.id)),t.pubKey!=null&&(n.uint32(18),n.bytes(t.pubKey)),t.privKey!=null&&(n.uint32(26),n.bytes(t.privKey)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.id=t.bytes();break;case 2:s.pubKey=t.bytes();break;case 3:s.privKey=t.bytes();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(F$||(F$={}));const UL=async()=>{const r=await tm("Ed25519"),e=await BL(r);if(e.type==="Ed25519")return e;throw new Error(`Generated unexpected PeerId type "${e.type}"`)},bke=async r=>{const e=await tm("RSA",r?.bits??2048),t=await BL(e);if(t.type==="RSA")return t;throw new Error(`Generated unexpected PeerId type "${t.type}"`)};async function BL(r){return rs(em(r.public),oU(r))}class mke extends gt{get[Hh](){return!0}get[Symbol.toStringTag](){return"@libp2p/dummy-dht"}get wan(){throw $(new Error(Oe.DHT_DISABLED),O.DHT_DISABLED)}get lan(){throw $(new Error(Oe.DHT_DISABLED),O.DHT_DISABLED)}get(){throw $(new Error(Oe.DHT_DISABLED),O.DHT_DISABLED)}findProviders(){throw $(new Error(Oe.DHT_DISABLED),O.DHT_DISABLED)}findPeer(){throw $(new Error(Oe.DHT_DISABLED),O.DHT_DISABLED)}getClosestPeers(){throw $(new Error(Oe.DHT_DISABLED),O.DHT_DISABLED)}provide(){throw $(new Error(Oe.DHT_DISABLED),O.DHT_DISABLED)}put(){throw $(new Error(Oe.DHT_DISABLED),O.DHT_DISABLED)}async getMode(){throw $(new Error(Oe.DHT_DISABLED),O.DHT_DISABLED)}async setMode(){throw $(new Error(Oe.DHT_DISABLED),O.DHT_DISABLED)}async refreshRoutingTable(){throw $(new Error(Oe.DHT_DISABLED),O.DHT_DISABLED)}}class Eke extends gt{constructor(){super(...arguments),this.topicValidators=new Map}isStarted(){return!1}start(){}stop(){}get globalSignaturePolicy(){throw $(new Error(Oe.PUBSUB_DISABLED),O.ERR_PUBSUB_DISABLED)}get multicodecs(){throw $(new Error(Oe.PUBSUB_DISABLED),O.ERR_PUBSUB_DISABLED)}getPeers(){throw $(new Error(Oe.PUBSUB_DISABLED),O.ERR_PUBSUB_DISABLED)}getTopics(){throw $(new Error(Oe.PUBSUB_DISABLED),O.ERR_PUBSUB_DISABLED)}subscribe(){throw $(new Error(Oe.PUBSUB_DISABLED),O.ERR_PUBSUB_DISABLED)}unsubscribe(){throw $(new Error(Oe.PUBSUB_DISABLED),O.ERR_PUBSUB_DISABLED)}getSubscribers(){throw $(new Error(Oe.PUBSUB_DISABLED),O.ERR_PUBSUB_DISABLED)}async publish(){throw $(new Error(Oe.PUBSUB_DISABLED),O.ERR_PUBSUB_DISABLED)}}var vke=class{constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}clear(){this.top=this.btm=0,this.next=null,this.buffer.fill(void 0)}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}peek(){return this.buffer[this.btm]}isEmpty(){return this.buffer[this.btm]===void 0}};const V$=vke;var _ke=class{constructor(e){this.hwm=e||16,this.head=new V$(this.hwm),this.tail=this.head,this.length=0}clear(){this.head=this.tail,this.head.clear(),this.length=0}push(e){if(this.length++,!this.head.push(e)){const t=this.head;this.head=t.next=new V$(2*this.head.buffer.length),this.head.push(e)}}shift(){this.length!==0&&this.length--;const e=this.tail.shift();if(e===void 0&&this.tail.next){const t=this.tail.next;return this.tail.next=null,this.tail=t,this.tail.shift()}return e}peek(){return this.tail.peek()}isEmpty(){return this.head.isEmpty()}};const Ske=()=>{const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r};var Ake=Ske;const j$=_ke,q$=Ake;var $ke=class{constructor(){this._buffer=new j$,this._waitingConsumers=new j$}push(e){const{promise:t,resolve:n}=q$();return this._buffer.push({chunk:e,resolve:n}),this._consume(),t}_consume(){for(;!this._waitingConsumers.isEmpty()&&!this._buffer.isEmpty();){const e=this._waitingConsumers.shift(),t=this._buffer.shift();e.resolve(t.chunk),t.resolve()}}shift(){const{promise:e,resolve:t}=q$();return this._waitingConsumers.push({resolve:t}),this._consume(),e}isEmpty(){return this._buffer.isEmpty()}};const Rke=Ge($ke),K$=N("libp2p:dialer:dial-request");class Tke{constructor(e){const{addrs:t,dialAction:n,dialer:s}=e;this.addrs=t,this.dialer=s,this.dialAction=n}async run(e={}){const t=this.dialer.getTokens(this.addrs.length);if(t.length<1)throw $(new Error("No dial tokens available"),O.ERR_NO_DIAL_TOKENS);const n=new Rke;for(const a of t)n.push(a).catch(c=>{K$.error(c)});const s=this.addrs.map(()=>{const a=new AbortController;try{Qe.setMaxListeners?.(1/0,a.signal)}catch{}return a});if(e.signal!=null)try{Qe.setMaxListeners?.(1/0,e.signal)}catch{}let i=0,o=!1;try{return await Promise.any(this.addrs.map(async(a,c)=>{const u=await n.shift();if(o)throw this.dialer.releaseToken(t.splice(t.indexOf(u),1)[0]),$(new Error("dialAction already succeeded"),O.ERR_ALREADY_SUCCEEDED);const l=s[c];if(l==null)throw $(new Error("dialAction did not come with an AbortController"),O.ERR_INVALID_PARAMETERS);let d;try{const f=l.signal;d=await this.dialAction(a,{...e,signal:e.signal!=null?Xs([f,e.signal]):f}),s[c]=void 0}finally{i++,this.addrs.length-i>=t.length?n.push(u).catch(f=>{K$.error(f)}):this.dialer.releaseToken(t.splice(t.indexOf(u),1)[0])}if(d==null)throw $(new Error("dialAction led to empty object"),O.ERR_TRANSPORT_DIAL_FAILED);return o=!0,d}))}finally{s.forEach(a=>{a!==void 0&&a.abort()}),t.forEach(a=>this.dialer.releaseToken(a))}}}const Ns=N("libp2p:dialer");class Ike{constructor(e,t={}){this.started=!1,this.addressSorter=t.addressSorter??i8,this.maxAddrsToDial=t.maxAddrsToDial??gke,this.timeout=t.dialTimeout??NL,this.maxDialsPerPeer=t.maxDialsPerPeer??ML,this.tokens=[...new Array(t.maxParallelDials??LL)].map((n,s)=>s),this.components=e,this.pendingDials=Ka({name:"libp2p_dialler_pending_dials",metrics:e.metrics}),this.pendingDialTargets=Ka({name:"libp2p_dialler_pending_dial_targets",metrics:e.metrics});for(const[n,s]of Object.entries(t.resolvers??{}))RN.set(n,s)}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1;for(const e of this.pendingDials.values())try{e.controller.abort()}catch(t){Ns.error(t)}this.pendingDials.clear();for(const e of this.pendingDialTargets.values())e.abort();this.pendingDialTargets.clear()}async dial(e,t={}){const{peerId:n,multiaddr:s}=ON(e);if(n!=null){if(this.components.peerId.equals(n))throw $(new Error("Tried to dial self"),O.ERR_DIALED_SELF);if(s!=null&&(Ns("storing multiaddrs %p",n,s),await this.components.peerStore.addressBook.add(n,[s])),await this.components.connectionGater.denyDialPeer(n))throw $(new Error("The dial request is blocked by gater.allowDialPeer"),O.ERR_PEER_DIAL_INTERCEPTED)}Ns("creating dial target for %p",n);const i=new AbortController,o=G$();this.pendingDialTargets.set(o,i);let a=i.signal;t.signal!=null&&(a=Xs([a,t.signal]));let c;try{c=await this._createDialTarget({peerId:n,multiaddr:s},{...t,signal:a})}finally{this.pendingDialTargets.delete(o)}if(c.addrs.length===0)throw $(new Error("The dial request has no valid addresses"),O.ERR_NO_VALID_ADDRESSES);const u=this.pendingDials.get(c.id)??this._createPendingDial(c,t);try{const l=await u.promise;return Ns("dial succeeded to %s",c.id),l}catch(l){throw Ns("dial failed to %s",c.id,l),u.controller.signal.aborted&&(l.code=O.ERR_TIMEOUT),Ns.error(l),l}finally{u.destroy()}}async _createDialTarget(e,t){let n=[];if(Ca(e.multiaddr)&&n.push(e.multiaddr),!Ca(e.multiaddr)&&xi(e.peerId)&&n.push(...await this._loadAddresses(e.peerId)),n=(await Promise.all(n.map(async i=>await this._resolve(i,t)))).flat().filter(i=>!!this.components.transportManager.transportForMultiaddr(i)),n=[...new Set(n.map(i=>i.toString()))].map(i=>St(i)),n.length>this.maxAddrsToDial)throw $(new Error("dial with more addresses than allowed"),O.ERR_TOO_MANY_ADDRESSES);const s=xi(e.peerId)?e.peerId:void 0;if(s!=null){const i=`/p2p/${s.toString()}`;n=n.map(o=>{const a=o.getPeerId();return a==null||!s.equals(a)?o.encapsulate(i):o})}return{id:s==null?G$():s.toString(),addrs:n}}async _loadAddresses(e){const t=await this.components.peerStore.addressBook.get(e);return(await Promise.all(t.map(async n=>await this.components.connectionGater.denyDialMultiaddr(e,n.multiaddr)?!1:n))).filter(Cke).sort(this.addressSorter).map(n=>n.multiaddr)}_createPendingDial(e,t={}){const n=async(u,l={})=>{if(l.signal?.aborted===!0)throw $(new Error("already aborted"),O.ERR_ALREADY_ABORTED);return await this.components.transportManager.dial(u,l).catch(d=>{throw Ns.error("dial to %s failed",u,d),d})},s=new Tke({addrs:e.addrs,dialAction:n,dialer:this}),i=new ft.TimeoutController(this.timeout),o=[i.signal];t.signal!=null&&o.push(t.signal);const a=Xs(o);try{Qe.setMaxListeners?.(1/0,a)}catch{}const c={dialRequest:s,controller:i,promise:s.run({...t,signal:a}),destroy:()=>{i.clear(),this.pendingDials.delete(e.id)}};return this.pendingDials.set(e.id,c),c}getTokens(e){const t=Math.min(e,this.maxDialsPerPeer,this.tokens.length),n=this.tokens.splice(0,t);return Ns("%d tokens request, returning %d, %d remaining",e,t,this.tokens.length),n}releaseToken(e){this.tokens.includes(e)||(Ns("token %d released",e),this.tokens.push(e))}async _resolve(e,t){if(!e.protoNames().includes("dnsaddr"))return[e];const s=await this._resolveRecord(e,t);return(await Promise.all(s.map(async a=>await this._resolve(a,t)))).flat().reduce((a,c)=>(a.find(u=>u.equals(c))==null&&a.push(c),a),[])}async _resolveRecord(e,t){try{return e=St(e.toString()),await e.resolve(t)}catch(n){return Ns.error(`multiaddr ${e.toString()} could not be resolved`,n),[]}}}function Cke(r){return!!r}function G$(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}const pi=N("libp2p");class xke extends gt{constructor(e){super(),this.started=!1,this.peerId=e.peerId;const t=this.components=new XPe({peerId:e.peerId,datastore:e.datastore??new rZ,connectionGater:{denyDialPeer:async()=>await Promise.resolve(!1),denyDialMultiaddr:async()=>await Promise.resolve(!1),denyInboundConnection:async()=>await Promise.resolve(!1),denyOutboundConnection:async()=>await Promise.resolve(!1),denyInboundEncryptedConnection:async()=>await Promise.resolve(!1),denyOutboundEncryptedConnection:async()=>await Promise.resolve(!1),denyInboundUpgradedConnection:async()=>await Promise.resolve(!1),denyOutboundUpgradedConnection:async()=>await Promise.resolve(!1),filterMultiaddrForPeer:async()=>await Promise.resolve(!0),...e.connectionGater}});t.peerStore=new QPe(t,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore}),this.services=[t],e.metrics!=null&&(this.metrics=this.components.metrics=this.configureComponent(e.metrics(this.components))),this.peerStore=this.components.peerStore,this.peerStore.addEventListener("peer",o=>{const{detail:a}=o;this.dispatchEvent(new W("peer:discovery",{detail:a}))}),e.connectionProtector!=null&&(this.components.connectionProtector=e.connectionProtector(t)),this.components.upgrader=new ODe(this.components,{connectionEncryption:(e.connectionEncryption??[]).map(o=>this.configureComponent(o(this.components))),muxers:(e.streamMuxers??[]).map(o=>this.configureComponent(o(this.components))),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),this.components.dialer=new Ike(this.components,e.connectionManager),this.connectionManager=this.components.connectionManager=new OTe(this.components,e.connectionManager),this.components.connectionManager.addEventListener("peer:disconnect",o=>{this.dispatchEvent(new W("peer:disconnect",{detail:o.detail}))}),this.components.connectionManager.addEventListener("peer:connect",o=>{this.dispatchEvent(new W("peer:connect",{detail:o.detail}))}),this.registrar=this.components.registrar=new CDe(this.components),this.components.transportManager=new rDe(this.components,e.transportManager),this.components.addressManager=new ATe(this.components,e.addresses),this.configureComponent(new JDe(this.components)),this.configureComponent(new kTe(this.components,{enabled:e.connectionManager.autoDial,minConnections:e.connectionManager.minConnections,autoDialInterval:e.connectionManager.autoDialInterval}));const n=S0.generateOptions();this.keychain=this.configureComponent(new S0(this.components,{...n,...e.keychain})),this.services.push(new YDe(this.components,e.nat)),e.transports.forEach(o=>{this.components.transportManager.add(this.configureComponent(o(this.components)))}),this.identifyService=new g8(this.components,{...e.identify}),this.configureComponent(this.identifyService),e.dht!=null?this.dht=this.components.dht=e.dht(this.components):this.dht=new mke,e.pubsub!=null?this.pubsub=this.components.pubsub=e.pubsub(this.components):this.pubsub=new Eke;const s=(e.peerRouters??[]).map(o=>this.configureComponent(o(this.components)));e.dht!=null&&(s.push(this.configureComponent(new ZDe(this.dht))),this.dht.addEventListener("peer",o=>{this.onDiscoveryPeer(o)})),this.peerRouting=this.components.peerRouting=this.configureComponent(new vTe(this.components,{...e.peerRouting,routers:s}));const i=(e.contentRouters??[]).map(o=>this.configureComponent(o(this.components)));e.dht!=null&&i.push(this.configureComponent(new YPe(this.dht))),this.contentRouting=this.components.contentRouting=this.configureComponent(new _Te(this.components,{routers:i})),e.relay.enabled&&(this.components.transportManager.add(this.configureComponent(new QCe(this.components,e.relay))),this.configureComponent(new dxe(this.components,{addressSorter:e.connectionManager.addressSorter,...e.relay}))),this.fetchService=this.configureComponent(new FDe(this.components,{...e.fetch})),this.pingService=this.configureComponent(new KDe(this.components,{...e.ping}));for(const o of e.peerDiscovery??[])this.configureComponent(o(this.components)).addEventListener("peer",c=>{this.onDiscoveryPeer(c)})}configureComponent(e){return ra(e)&&this.services.push(e),e}async start(){if(!this.started){this.started=!0,pi("libp2p is starting");try{await Promise.all(this.services.map(async e=>{e.beforeStart!=null&&await e.beforeStart()})),await Promise.all(this.services.map(e=>e.start())),await Promise.all(this.services.map(async e=>{e.afterStart!=null&&await e.afterStart()})),pi("libp2p has started")}catch(e){throw pi.error("An error occurred starting libp2p",e),await this.stop(),e}}}async stop(){this.started&&(pi("libp2p is stopping"),this.started=!1,await Promise.all(this.services.map(async e=>{e.beforeStop!=null&&await e.beforeStop()})),await Promise.all(this.services.map(e=>e.stop())),await Promise.all(this.services.map(async e=>{e.afterStop!=null&&await e.afterStop()})),pi("libp2p has stopped"))}isStarted(){return this.started}getConnections(e){return this.components.connectionManager.getConnections(e)}getPeers(){const e=new ko;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return await this.components.connectionManager.openConnection(e,t)}async dialProtocol(e,t,n={}){if(t==null)throw $(new Error("no protocols were provided to open a stream"),O.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(t=Array.isArray(t)?t:[t],t.length===0)throw $(new Error("no protocols were provided to open a stream"),O.ERR_INVALID_PROTOCOLS_FOR_STREAM);return await(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e){Ca(e)&&(e=de(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e)}async getPublicKey(e,t={}){if(pi("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;const n=await this.peerStore.get(e);if(n.pubKey!=null)return n.pubKey;if(this.dht==null)throw $(new Error("Public key was not in the peer store and the DHT is not enabled"),O.ERR_NO_ROUTERS_AVAILABLE);const s=M([L("/pk/"),e.multihash.digest]);for await(const i of this.dht.get(s,t))if(i.name==="VALUE"){const o=ka(i.value);return await this.peerStore.keyBook.set(e,i.value),o.bytes}throw $(new Error(`Node not responding with its public key: ${e.toString()}`),O.ERR_INVALID_RECORD)}async fetch(e,t,n={}){if(Ca(e)){const s=de(e.getPeerId()??"");await this.components.peerStore.addressBook.add(s,[e]),e=s}return await this.fetchService.fetch(e,t,n)}async ping(e,t={}){if(Ca(e)){const n=de(e.getPeerId()??"");await this.components.peerStore.addressBook.add(n,[e]),e=n}return await this.pingService.ping(e,t)}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,n)}))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async t=>{await this.components.registrar.unhandle(t)}))}async register(e,t){return await this.registrar.register(e,t)}unregister(e){this.registrar.unregister(e)}onDiscoveryPeer(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){pi.error(new Error(O.ERR_DISCOVERED_SELF));return}t.multiaddrs.length>0&&this.components.peerStore.addressBook.add(t.id,t.multiaddrs).catch(n=>pi.error(n)),t.protocols.length>0&&this.components.peerStore.protoBook.set(t.id,t.protocols).catch(n=>pi.error(n)),this.dispatchEvent(new W("peer:discovery",{detail:t}))}}async function Dke(r){if(r.peerId==null){const e=r.datastore;if(e!=null)try{const t=new S0({datastore:e},{...S0.generateOptions(),...r.keychain??{}});r.peerId=await t.exportPeerId("self")}catch(t){if(t.code!=="ERR_NOT_FOUND")throw t}}return r.peerId==null&&(r.peerId=await UL()),new xke(wke(r))}async function Oke(r){const e=await Dke(r);return r.start!==!1&&await e.start(),e}const Pke=aU(),{EventEmitter:kke}=Qe;function H$(r,e){if(r===e)return!0;if(r.length!==e.length)return!1;for(let t=0,n=r.length;t<n;++t)if(r[t]!==e[t])return!1;return!0}function pw(){return{contacts:[],dontSplit:!1,left:null,right:null}}function Hu(r,e){if(!(e instanceof Uint8Array))throw new TypeError(r+" is not a Uint8Array")}class P0 extends kke{constructor(e={}){super(),this.localNodeId=e.localNodeId||Pke(20),this.numberOfNodesPerKBucket=e.numberOfNodesPerKBucket||20,this.numberOfNodesToPing=e.numberOfNodesToPing||3,this.distance=e.distance||P0.distance,this.arbiter=e.arbiter||P0.arbiter,this.metadata=Object.assign({},e.metadata),Hu("option.localNodeId as parameter 1",this.localNodeId),this.root=pw()}static arbiter(e,t){return e.vectorClock>t.vectorClock?e:t}static distance(e,t){let n=0,s=0;const i=Math.min(e.length,t.length),o=Math.max(e.length,t.length);for(;s<i;++s)n=n*256+(e[s]^t[s]);for(;s<o;++s)n=n*256+255;return n}add(e){Hu("contact.id",(e||{}).id);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e.id,t++);const s=this._indexOf(n,e.id);return s>=0?(this._update(n,s,e),this):n.contacts.length<this.numberOfNodesPerKBucket?(n.contacts.push(e),this.emit("added",e),this):n.dontSplit?(this.emit("ping",n.contacts.slice(0,this.numberOfNodesToPing),e),this):(this._split(n,t),this.add(e))}closest(e,t=1/0){if(Hu("id",e),!Number.isInteger(t)&&t!==1/0||t<=0)throw new TypeError("n is not positive number");let n=[];for(let s=[this.root],i=0;s.length>0&&n.length<t;){const o=s.pop();if(o.contacts===null){const a=this._determineNode(o,e,i++);s.push(o.left===a?o.right:o.left),s.push(a)}else n=n.concat(o.contacts)}return n.map(s=>[this.distance(s.id,e),s]).sort((s,i)=>s[0]-i[0]).slice(0,t).map(s=>s[1])}count(){let e=0;for(const t=[this.root];t.length>0;){const n=t.pop();n.contacts===null?t.push(n.right,n.left):e+=n.contacts.length}return e}_determineNode(e,t,n){const s=n>>3,i=n%8;return t.length<=s&&i!==0?e.left:t[s]&1<<7-i?e.right:e.left}get(e){Hu("id",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);const s=this._indexOf(n,e);return s>=0?n.contacts[s]:null}_indexOf(e,t){for(let n=0;n<e.contacts.length;++n)if(H$(e.contacts[n].id,t))return n;return-1}remove(e){Hu("the id as parameter 1",e);let t=0,n=this.root;for(;n.contacts===null;)n=this._determineNode(n,e,t++);const s=this._indexOf(n,e);if(s>=0){const i=n.contacts.splice(s,1)[0];this.emit("removed",i)}return this}_split(e,t){e.left=pw(),e.right=pw();for(const i of e.contacts)this._determineNode(e,i.id,t).contacts.push(i);e.contacts=null;const n=this._determineNode(e,this.localNodeId,t),s=e.left===n?e.right:e.left;s.dontSplit=!0}toArray(){let e=[];for(const t=[this.root];t.length>0;){const n=t.pop();n.contacts===null?t.push(n.right,n.left):e=e.concat(n.contacts)}return e}*toIterable(){for(const e=[this.root];e.length>0;){const t=e.pop();t.contacts===null?e.push(t.right,t.left):yield*t.contacts}}_update(e,t,n){if(!H$(e.contacts[t].id,n.id))throw new Error("wrong index for _update");const s=e.contacts[t],i=this.arbiter(s,n);i===s&&s!==n||(e.contacts.splice(t,1),e.contacts.push(i),this.emit("updated",s,i))}}var Nke=P0;const Lke=Ge(Nke),Mke=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},v8=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},Uke=r=>new TextEncoder().encode(r),Bke=r=>new TextDecoder().decode(r);var zke=zL,W$=128,Fke=127,Vke=~Fke,jke=Math.pow(2,31);function zL(r,e,t){e=e||[],t=t||0;for(var n=t;r>=jke;)e[t++]=r&255|W$,r/=128;for(;r&Vke;)e[t++]=r&255|W$,r>>>=7;return e[t]=r|0,zL.bytes=t-n+1,e}var qke=R6,Kke=128,Q$=127;function R6(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw R6.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&Q$)<<s:(o&Q$)*Math.pow(2,s),s+=7}while(o>=Kke);return R6.bytes=i-n,t}var Gke=Math.pow(2,7),Hke=Math.pow(2,14),Wke=Math.pow(2,21),Qke=Math.pow(2,28),Yke=Math.pow(2,35),Xke=Math.pow(2,42),Jke=Math.pow(2,49),Zke=Math.pow(2,56),eNe=Math.pow(2,63),tNe=function(r){return r<Gke?1:r<Hke?2:r<Wke?3:r<Qke?4:r<Yke?5:r<Xke?6:r<Jke?7:r<Zke?8:r<eNe?9:10},rNe={encode:zke,decode:qke,encodingLength:tNe},k0=rNe;const T6=(r,e=0)=>[k0.decode(r,e),k0.decode.bytes],N0=(r,e,t=0)=>(k0.encode(r,e,t),e),L0=r=>k0.encodingLength(r),I6=(r,e)=>{const t=e.byteLength,n=L0(r),s=n+L0(t),i=new Uint8Array(s+t);return N0(r,i,0),N0(t,i,n),i.set(e,s),new _8(r,t,e,i)},FL=r=>{const e=v8(r),[t,n]=T6(e),[s,i]=T6(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new _8(t,s,o,e)},nNe=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Mke(r.bytes,t.bytes)}};let _8=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const sNe=({name:r,code:e,encode:t})=>new iNe(r,e,t);let iNe=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?I6(this.code,t):t.then(n=>I6(this.code,n))}else throw Error("Unknown type, must be binary type")}};const oNe=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),VL=sNe({name:"sha2-256",code:18,encode:oNe("SHA-256")}),yg=1e3,S8=60*yg,A8=60*S8,aNe=36*A8,cNe="/lan",lNe="/ipfs",uNe="/kad/1.0.0",dNe="/dht/record",jL="/dht/provider",hNe=256,fNe=24*A8,pNe=A8,C6=20,M0=3,gNe=Number(5*S8),yNe=Number(30*yg),wNe=Number(5*S8),bNe=Number(30*yg),mNe=Number(30*yg),ENe=L("/pk/");function $8(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;const s=dg(n);return s==null?!0:!s})}}function R8(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();if(n==="localhost")return!0;if(t!==4&&t!==6||n==null)return!1;const s=dg(n);return s??!1})}}async function El(r){return(await VL.digest(r)).digest}async function Ci(r){return await El(r.toBytes())}function zc(r){return new ie(`${dNe}/${C(r,"base32")}`,!1)}function vNe(r){return M([ENe,r.toBytes()])}function _Ne(r){return C(r.subarray(0,4))==="/pk/"}function SNe(r){return ni(r.subarray(4))}function Y$(r,e){const t=new Date;return new Kr(r,e,t).serialize()}function ANe(r,e=100){let t;return()=>{clearTimeout(t),t=setTimeout(()=>{r()},e)}}const $Ne="kad-close",RNe=50,X$=20,TNe=1e4,INe=10;class CNe{constructor(e,t){const{kBucketSize:n,pingTimeout:s,lan:i,pingConcurrency:o,protocol:a,tagName:c,tagValue:u}=t;this.components=e,this.log=N(`libp2p:kad-dht:${i?"lan":"wan"}:routing-table`),this.kBucketSize=n??X$,this.pingTimeout=s??TNe,this.pingConcurrency=o??INe,this.lan=i,this.running=!1,this.protocol=a,this.tagName=c??$Ne,this.tagValue=u??RNe;const l=()=>{this.metrics?.pingQueueSize.update(this.pingQueue.size),this.metrics?.pingRunning.update(this.pingQueue.pending)};this.pingQueue=new zt({concurrency:this.pingConcurrency}),this.pingQueue.addListener("add",l),this.pingQueue.addListener("next",l),this._onPing=this._onPing.bind(this)}isStarted(){return this.running}async start(){this.running=!0,this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_routing_table_size`),pingQueueSize:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_queue_size`),pingRunning:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_ping_running`)});const e=new Lke({localNodeId:await Ci(this.components.peerId),numberOfNodesPerKBucket:this.kBucketSize,numberOfNodesToPing:1});this.kb=e,e.on("ping",this._onPing),this._tagPeers(e)}async stop(){this.running=!1,this.pingQueue.clear(),this.kb=void 0}_tagPeers(e){let t=new ko;const n=ANe(()=>{const s=new ko(e.closest(e.localNodeId,X$).map(a=>a.peer)),i=s.difference(t),o=t.difference(s);Promise.resolve().then(async()=>{for(const a of i)await this.components.peerStore.tagPeer(a,this.tagName,{value:this.tagValue});for(const a of o)await this.components.peerStore.unTagPeer(a,this.tagName)}).catch(a=>{this.log.error("Could not update peer tags",a)}),t=s});e.on("added",()=>{n()}),e.on("removed",()=>{n()})}_onPing(e,t){this.pingQueue.add(async()=>{if(!this.running)return;let n=0;try{await Promise.all(e.map(async s=>{let i;try{i=new ft.TimeoutController(this.pingTimeout);const o={signal:i.signal};this.log("pinging old contact %p",s.peer),(await(await this.components.connectionManager.openConnection(s.peer,o)).newStream(this.protocol,o)).close(),n++}catch(o){this.running&&this.kb!=null&&(this.log.error("could not ping peer %p",s.peer,o),this.log("evicting old contact after ping failed %p",s),this.kb.remove(s.id))}finally{i?.clear(),this.metrics?.routingTableSize.update(this.size)}})),this.running&&n<e.length&&this.kb!=null&&(this.log("adding new contact %p",t.peer),this.kb.add(t))}catch(s){this.log.error("could not process k-bucket ping event",s)}}).catch(n=>{this.log.error("could not process k-bucket ping event",n)})}get size(){return this.kb==null?0:this.kb.count()}async find(e){const t=await Ci(e),n=this.closestPeer(t);if(n!=null&&e.equals(n))return n}closestPeer(e){const t=this.closestPeers(e,1);if(t.length>0)return t[0]}closestPeers(e,t=this.kBucketSize){return this.kb==null?[]:this.kb.closest(e,t).map(s=>s.peer)}async add(e){if(this.kb==null)throw new Error("RoutingTable is not started");const t=await Ci(e);this.kb.add({id:t,peer:e}),this.log("added %p with kad id %b",e,t),this.metrics?.routingTableSize.update(this.size)}async remove(e){if(this.kb==null)throw new Error("RoutingTable is not started");const t=await Ci(e);this.kb.remove(t),this.metrics?.routingTableSize.update(this.size)}}const xNe=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],Qf=15;class DNe{constructor(e){const{peerRouting:t,routingTable:n,refreshInterval:s,refreshQueryTimeout:i,lan:o}=e;this.log=N(`libp2p:kad-dht:${o?"lan":"wan"}:routing-table:refresh`),this.peerRouting=t,this.routingTable=n,this.refreshInterval=s??wNe,this.refreshQueryTimeout=i??bNe,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async start(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");const t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map(s=>s.toISOString()).join(", ")} ]`),Promise.all(n.map(async(s,i)=>{try{if(await this._refreshCommonPrefixLength(i,s,e),this._numPeersForCpl(t)===0){const o=Math.min(2*(i+1),n.length-1);for(let a=i+1;a<o+1;a++)try{await this._refreshCommonPrefixLength(a,s,e)}catch(c){this.log.error(c)}}}catch(o){this.log.error(o)}})).catch(s=>{this.log.error(s)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(s=>{this.log.error(s)})}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const s=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,s,this.routingTable.size);const i=new ft.TimeoutController(this.refreshQueryTimeout);try{const o=await ll(this.peerRouting.getClosestPeers(s.toBytes(),{signal:i.signal}));this.log(`found ${o} peers that were close to imaginary peer %p`,s),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,s,this.routingTable.size)}finally{i.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>Qf&&(e=Qf);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");const t=J0(2),n=(t[1]<<8)+t[0],s=await this._makePeerId(this.routingTable.kb.localNodeId,n,e);return ni(s)}async _makePeerId(e,t,n){if(n>Qf)throw new Error(`Cannot generate peer ID for common prefix length greater than ${Qf}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,u=xNe[c],l=new ArrayBuffer(34),d=new DataView(l,0,l.byteLength);return d.setUint8(0,VL.code),d.setUint8(1,32),d.setUint32(2,u,!1),new Uint8Array(d.buffer,d.byteOffset,d.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb!=null)for(const{id:e}of this.routingTable.kb.toIterable()){const t=Rd(this.routingTable.kb.localNodeId,e);let n=0;for(const s of t)if(s===0)n++;else break;yield n}}}function ONe(r){return globalThis?.Buffer?.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r)}const wg=r=>{const e=pt.encodingLength(r),t=ONe(e);return pt.encode(r,t),wg.bytes=e,t};wg.bytes=0;function U0(r){r=r??{};const e=r.lengthEncoder??wg;return async function*(n){for await(const s of n){const i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}}}U0.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??wg;return new ue(t(r.byteLength),r)};const PNe=8,kNe=1024*1024*4;var ca;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(ca||(ca={}));const T8=r=>{const e=pt.decode(r);return T8.bytes=pt.encodingLength(e),e};T8.bytes=0;function B0(r){return async function*(t){const n=new ue;let s=ca.LENGTH,i=-1;const o=r?.lengthDecoder??T8,a=r?.maxLengthLength??PNe,c=r?.maxDataLength??kNe;for await(const u of t)for(n.append(u);n.byteLength>0;){if(s===ca.LENGTH)try{if(i=o(n),i<0)throw $(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(i>c)throw $(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const l=o.bytes;n.consume(l),r?.onLength!=null&&r.onLength(i),s=ca.DATA}catch(l){if(l instanceof RangeError){if(n.byteLength>a)throw $(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw l}if(s===ca.DATA){if(n.byteLength<i)break;const l=n.sublist(0,i);n.consume(i),r?.onData!=null&&r.onData(l),yield l,s=ca.LENGTH}}if(n.byteLength>0)throw $(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}}B0.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return B0({...e??{},onLength:i=>{t=i}})(n)};const J$=es,NNe=ts,qL=function(r){let e=0;if(r=r.toString().trim(),J$(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(NNe(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const i=J$(t[n]);let o;i&&(o=qL(t[n]),t[n]=C(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,C(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const i=[n,1];for(n=9-t.length;n>0;n--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(n=0;n<t.length;n++){const i=parseInt(t[n],16);s[e++]=i>>8&255,s[e++]=i&255}return s}throw new Error("invalid ip address")},LNe=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const s=[];for(let i=0;i<t;i++)s.push(r[e+i]);return s.join(".")}if(t===16){const s=[];for(let i=0;i<t;i+=2)s.push(n.getUint16(e+i).toString(16));return s.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},zn=-1,z0={},x6={},MNe=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,zn,"ip6zone"],[43,8,"ipcidr"],[53,zn,"dns",!0],[54,zn,"dns4",!0],[55,zn,"dns6",!0],[56,zn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc"],[281,0,"webrtc-w3c"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,zn,"unix",!1,!0],[421,zn,"ipfs"],[421,zn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,zn,"garlic64"],[448,0,"tls"],[449,zn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,zn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[777,zn,"memory"]];MNe.forEach(r=>{const e=UNe(...r);x6[e.code]=e,z0[e.name]=e});function UNe(r,e,t,n,s){return{code:r,size:e,name:t,resolvable:!!n,path:!!s}}function _t(r){if(typeof r=="number"){if(x6[r]!=null)return x6[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(z0[r]!=null)return z0[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}function BNe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var zNe=BNe,FNe=zNe;let VNe=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},jNe=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return KL(this,e)}},qNe=class{constructor(e){this.decoders=e}or(e){return KL(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const KL=(r,e)=>new qNe({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let KNe=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new VNe(e,t,n),this.decoder=new jNe(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const bg=({name:r,prefix:e,encode:t,decode:n})=>new KNe(r,e,t,n),Zh=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=FNe(t,e);return bg({prefix:r,name:e,encode:n,decode:i=>v8(s(i))})},GNe=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},HNe=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},ur=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>bg({prefix:e,name:r,encode(s){return HNe(s,n,t)},decode(s){return GNe(s,n,t,r)}}),Rs=Zh({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),WNe=Zh({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),QNe=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Rs,base58flickr:WNe},Symbol.toStringTag,{value:"Module"})),Oa=ur({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),YNe=ur({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),XNe=ur({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),JNe=ur({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ZNe=ur({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),eLe=ur({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),tLe=ur({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),rLe=ur({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),nLe=ur({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),sLe=Object.freeze(Object.defineProperty({__proto__:null,base32:Oa,base32hex:ZNe,base32hexpad:tLe,base32hexpadupper:rLe,base32hexupper:eLe,base32pad:XNe,base32padupper:JNe,base32upper:YNe,base32z:nLe},Symbol.toStringTag,{value:"Module"})),Z$=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return oLe(t,D6(r),e||Rs.encoder);default:return aLe(t,D6(r),e||Oa.encoder)}},eR=new WeakMap,D6=r=>{const e=eR.get(r);if(e==null){const t=new Map;return eR.set(r,t),t}return e};let mg=class Pr{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Wu)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==cLe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Pr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=I6(e,t);return Pr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Pr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&nNe(e.multihash,n.multihash)}toString(e){return Z$(this,e)}toJSON(){return{"/":Z$(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Pr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new Pr(n,s,i,o||tR(n,s,i.bytes))}else if(t[lLe]===!0){const{version:n,multihash:s,code:i}=t,o=FL(s);return Pr.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Wu)throw new Error(`Version 0 CID must use dag-pb (code: ${Wu}) block encoding`);return new Pr(e,t,n,n.bytes)}case 1:{const s=tR(e,t,n.bytes);return new Pr(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return Pr.create(0,Wu,e)}static createV1(e,t){return Pr.create(1,e,t)}static decode(e){const[t,n]=Pr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Pr.inspectBytes(e),n=t.size-t.multihashSize,s=v8(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new _8(t.multihashCode,t.digestSize,i,s);return[t.version===0?Pr.createV0(o):Pr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=T6(e.subarray(t));return t+=f,d};let s=n(),i=Wu;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=iLe(e,t),i=Pr.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return D6(i).set(n,e),i}};const iLe=(r,e)=>{switch(r[0]){case"Q":{const t=e||Rs;return[Rs.prefix,t.decode(`${Rs.prefix}${r}`)]}case Rs.prefix:{const t=e||Rs;return[Rs.prefix,t.decode(r)]}case Oa.prefix:{const t=e||Oa;return[Oa.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},oLe=(r,e,t)=>{const{prefix:n}=t;if(n!==Rs.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},aLe=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},Wu=112,cLe=18,tR=(r,e,t)=>{const n=L0(r),s=n+L0(e),i=new Uint8Array(s+t.byteLength);return N0(r,i,0),N0(e,i,n),i.set(t,s),i},lLe=Symbol.for("@ipld/js-cid/CID"),uLe=bg({prefix:"\0",name:"identity",encode:r=>Bke(r),decode:r=>Uke(r)}),dLe=Object.freeze(Object.defineProperty({__proto__:null,identity:uLe},Symbol.toStringTag,{value:"Module"})),hLe=ur({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),fLe=Object.freeze(Object.defineProperty({__proto__:null,base2:hLe},Symbol.toStringTag,{value:"Module"})),pLe=ur({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),gLe=Object.freeze(Object.defineProperty({__proto__:null,base8:pLe},Symbol.toStringTag,{value:"Module"})),yLe=Zh({prefix:"9",name:"base10",alphabet:"0123456789"}),wLe=Object.freeze(Object.defineProperty({__proto__:null,base10:yLe},Symbol.toStringTag,{value:"Module"})),bLe=ur({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),mLe=ur({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),ELe=Object.freeze(Object.defineProperty({__proto__:null,base16:bLe,base16upper:mLe},Symbol.toStringTag,{value:"Module"})),vLe=Zh({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),_Le=Zh({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),SLe=Object.freeze(Object.defineProperty({__proto__:null,base36:vLe,base36upper:_Le},Symbol.toStringTag,{value:"Module"})),ALe=ur({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),$Le=ur({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),RLe=ur({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),TLe=ur({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),ILe=Object.freeze(Object.defineProperty({__proto__:null,base64:ALe,base64pad:$Le,base64url:RLe,base64urlpad:TLe},Symbol.toStringTag,{value:"Module"})),GL=Array.from(""),CLe=GL.reduce((r,e,t)=>(r[t]=e,r),[]),xLe=GL.reduce((r,e,t)=>(r[e.codePointAt(0)]=t,r),[]);function DLe(r){return r.reduce((e,t)=>(e+=CLe[t],e),"")}function OLe(r){const e=[];for(const t of r){const n=xLe[t.codePointAt(0)];if(n===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(n)}return new Uint8Array(e)}const PLe=bg({prefix:"",name:"base256emoji",encode:DLe,decode:OLe}),kLe=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:PLe},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const NLe={...dLe,...fLe,...gLe,...wLe,...ELe,...sLe,...SLe,...QNe,...ILe,...kLe};function LLe(r,e){switch(_t(r).code){case 4:case 41:return BLe(e);case 42:return sR(e);case 6:case 273:case 33:case 132:return HL(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return sR(e);case 421:return jLe(e);case 444:return iR(e);case 445:return iR(e);case 466:return VLe(e);default:return C(e,"base16")}}function MLe(r,e){switch(_t(r).code){case 4:return rR(e);case 41:return rR(e);case 42:return nR(e);case 6:case 273:case 33:case 132:return I8(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return nR(e);case 421:return zLe(e);case 444:return qLe(e);case 445:return KLe(e);case 466:return FLe(e);default:return L(e,"base16")}}const gw=Object.values(NLe).map(r=>r.decoder),ULe=function(){let r=gw[0].or(gw[1]);return gw.slice(2).forEach(e=>r=r.or(e)),r}();function rR(r){if(!tt(r))throw new Error("invalid ip address");return qL(r)}function BLe(r){const e=LNe(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!tt(e))throw new Error("invalid ip address");return e}function I8(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function HL(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function nR(r){const e=L(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function sR(r){const e=D.decode(r);if(r=r.slice(D.decode.bytes),r.length!==e)throw new Error("inconsistent lengths");return C(r)}function zLe(r){let e;r[0]==="Q"||r[0]==="1"?e=FL(Rs.decode(`z${r}`)).bytes:e=mg.parse(r).multihash.bytes;const t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function FLe(r){const e=ULe.decode(r),t=Uint8Array.from(D.encode(e.length));return M([t,e],t.length+e.length)}function VLe(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return"u"+C(t,"base64url")}function jLe(r){const e=D.decode(r),t=r.slice(D.decode.bytes);if(t.length!==e)throw new Error("inconsistent lengths");return C(t,"base58btc")}function qLe(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=Oa.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=I8(n);return M([t,s],t.length+s.length)}function KLe(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Oa.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const s=I8(n);return M([t,s],t.length+s.length)}function iR(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=C(e,"base32"),s=HL(t);return`${n}:${s}`}function GLe(r){const e=[],t=r.split("/").slice(1);if(t.length===1&&t[0]==="")return[];for(let n=0;n<t.length;n++){const s=t[n],i=_t(s);if(i.size===0){e.push([s]);continue}if(n++,n>=t.length)throw XL("invalid address: "+r);if(i.path===!0){e.push([s,x8(t.slice(n).join("/"))]);break}e.push([s,t[n]])}return e}function HLe(r){const e=[];return r.map(t=>{const n=Eg(t);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),x8(e.join("/"))}function WLe(r){return r.map(e=>{Array.isArray(e)||(e=[e]);const t=Eg(e);return e.length>1?[t.code,MLe(t.code,e[1])]:[t.code]})}function WL(r){return r.map(e=>{const t=Eg(e);return e[1]!=null?[t.code,LLe(t.code,e[1])]:[t.code]})}function QL(r){return O6(M(r.map(e=>{const t=Eg(e);let n=Uint8Array.from(D.encode(t.code));return e.length>1&&e[1]!=null&&(n=M([n,e[1]])),n})))}function YL(r,e){return r.size>0?r.size/8:r.size===0?0:D.decode(e)+(D.decode.bytes??0)}function C8(r){const e=[];let t=0;for(;t<r.length;){const n=D.decode(r,t),s=D.decode.bytes??0,i=_t(n),o=YL(i,r.slice(t+s));if(o===0){e.push([n]),t+=s;continue}const a=r.slice(t+s,t+s+o);if(t+=o+s,t>r.length)throw XL("Invalid address Uint8Array: "+C(r,"base16"));e.push([n,a])}return e}function oR(r){const e=C8(r),t=WL(e);return HLe(t)}function QLe(r){r=x8(r);const e=GLe(r),t=WLe(e);return QL(t)}function YLe(r){return QLe(r)}function O6(r){const e=XLe(r);if(e!=null)throw e;return Uint8Array.from(r)}function XLe(r){try{C8(r)}catch(e){return e}}function x8(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}function XL(r){return new Error("Error parsing address: "+r)}function Eg(r){return _t(r[0])}var Sc=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},yw=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(r,t):s?s.value=t:e.set(r,t),t},Qu,Yu,Xu,aR;const JLe=Symbol.for("nodejs.util.inspect.custom"),ZLe=[_t("dns").code,_t("dns4").code,_t("dns6").code,_t("dnsaddr").code],eMe=new Map,JL=Symbol.for("@multiformats/js-multiaddr/multiaddr");function tMe(r){return!!r?.[JL]}class la{constructor(e){if(Qu.set(this,void 0),Yu.set(this,void 0),Xu.set(this,void 0),this[aR]=!0,e==null&&(e=""),e instanceof Uint8Array)this.bytes=O6(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);this.bytes=YLe(e)}else if(tMe(e))this.bytes=O6(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr")}toString(){return Sc(this,Qu,"f")==null&&yw(this,Qu,oR(this.bytes),"f"),Sc(this,Qu,"f")}toJSON(){return this.toString()}toOptions(){let e,t,n,s,i="";const o=_t("tcp"),a=_t("udp"),c=_t("ip4"),u=_t("ip6"),l=_t("dns6"),d=_t("ip6zone");for(const[g,h]of this.stringTuples())g===d.code&&(i=`%${h??""}`),ZLe.includes(g)&&(t=o.name,s=443,n=`${h??""}${i}`,e=g===l.code?6:4),(g===o.code||g===a.code)&&(t=_t(g).name,s=parseInt(h??"")),(g===c.code||g===u.code)&&(t=_t(g).name,n=`${h??""}${i}`,e=g===u.code?6:4);if(e==null||t==null||n==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:s}}protos(){return this.protoCodes().map(e=>Object.assign({},_t(e)))}protoCodes(){const e=[],t=this.bytes;let n=0;for(;n<t.length;){const s=D.decode(t,n),i=D.decode.bytes??0,o=_t(s),a=YL(o,t.slice(n+i));n+=a+i,e.push(s)}return e}protoNames(){return this.protos().map(e=>e.name)}tuples(){return Sc(this,Yu,"f")==null&&yw(this,Yu,C8(this.bytes),"f"),Sc(this,Yu,"f")}stringTuples(){return Sc(this,Xu,"f")==null&&yw(this,Xu,WL(this.tuples()),"f"),Sc(this,Xu,"f")}encapsulate(e){return e=new la(e),new la(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),s=n.lastIndexOf(t);if(s<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new la(n.slice(0,s))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new la(QL(t.slice(0,n)));return this}getPeerId(){try{const t=this.stringTuples().filter(n=>n[0]===z0.ipfs.code).pop();if(t?.[1]!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?C(Rs.decode(`z${n}`),"base58btc"):C(mg.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){let e=null;try{e=this.stringTuples().filter(t=>_t(t[0]).path===!0)[0][1],e==null&&(e=null)}catch{e=null}return e}equals(e){return me(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const n=eMe.get(t.name);if(n==null)throw $(new Error(`no available resolver for ${t.name}`),"ERR_NO_AVAILABLE_RESOLVER");return(await n(this,e)).map(i=>new la(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(Qu=new WeakMap,Yu=new WeakMap,Xu=new WeakMap,aR=JL,JLe)](){return`Multiaddr(${oR(this.bytes)})`}}function rMe(r){return new la(r)}var cR;(function(r){let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.key=t.bytes();break;case 2:s.value=t.bytes();break;case 3:s.author=t.bytes();break;case 4:s.signature=t.bytes();break;case 5:s.timeReceived=t.string();break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(cR||(cR={}));var Pa;(function(r){(function(s){s.PUT_VALUE="PUT_VALUE",s.GET_VALUE="GET_VALUE",s.ADD_PROVIDER="ADD_PROVIDER",s.GET_PROVIDERS="GET_PROVIDERS",s.FIND_NODE="FIND_NODE",s.PING="PING"})(r.MessageType||(r.MessageType={}));let e;(function(s){s[s.PUT_VALUE=0]="PUT_VALUE",s[s.GET_VALUE=1]="GET_VALUE",s[s.ADD_PROVIDER=2]="ADD_PROVIDER",s[s.GET_PROVIDERS=3]="GET_PROVIDERS",s[s.FIND_NODE=4]="FIND_NODE",s[s.PING=5]="PING"})(e||(e={})),function(s){s.codec=()=>q8(e)}(r.MessageType||(r.MessageType={})),function(s){s.NOT_CONNECTED="NOT_CONNECTED",s.CONNECTED="CONNECTED",s.CAN_CONNECT="CAN_CONNECT",s.CANNOT_CONNECT="CANNOT_CONNECT"}(r.ConnectionType||(r.ConnectionType={}));let t;(function(s){s[s.NOT_CONNECTED=0]="NOT_CONNECTED",s[s.CONNECTED=1]="CONNECTED",s[s.CAN_CONNECT=2]="CAN_CONNECT",s[s.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(t||(t={})),function(s){s.codec=()=>q8(t)}(r.ConnectionType||(r.ConnectionType={})),function(s){let i;s.codec=()=>(i==null&&(i=Wr((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const u of o.addrs)a.uint32(18),a.bytes(u);o.connection!=null&&(a.uint32(24),r.ConnectionType.codec().encode(o.connection,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a)=>{const c={addrs:[]},u=a==null?o.len:o.pos+a;for(;o.pos<u;){const l=o.uint32();switch(l>>>3){case 1:c.id=o.bytes();break;case 2:c.addrs.push(o.bytes());break;case 3:c.connection=r.ConnectionType.codec().decode(o);break;default:o.skipType(l&7);break}}return c})),i),s.encode=o=>Qr(o,s.codec()),s.decode=o=>Yr(o,s.codec())}(r.Peer||(r.Peer={}));let n;r.codec=()=>(n==null&&(n=Wr((s,i,o={})=>{if(o.lengthDelimited!==!1&&i.fork(),s.type!=null&&(i.uint32(8),r.MessageType.codec().encode(s.type,i)),s.clusterLevelRaw!=null&&(i.uint32(80),i.int32(s.clusterLevelRaw)),s.key!=null&&(i.uint32(18),i.bytes(s.key)),s.record!=null&&(i.uint32(26),i.bytes(s.record)),s.closerPeers!=null)for(const a of s.closerPeers)i.uint32(66),r.Peer.codec().encode(a,i);if(s.providerPeers!=null)for(const a of s.providerPeers)i.uint32(74),r.Peer.codec().encode(a,i);o.lengthDelimited!==!1&&i.ldelim()},(s,i)=>{const o={closerPeers:[],providerPeers:[]},a=i==null?s.len:s.pos+i;for(;s.pos<a;){const c=s.uint32();switch(c>>>3){case 1:o.type=r.MessageType.codec().decode(s);break;case 10:o.clusterLevelRaw=s.int32();break;case 2:o.key=s.bytes();break;case 3:o.record=s.bytes();break;case 8:o.closerPeers.push(r.Peer.codec().decode(s,s.uint32()));break;case 9:o.providerPeers.push(r.Peer.codec().decode(s,s.uint32()));break;default:s.skipType(c&7);break}}return o})),n),r.encode=s=>Qr(s,r.codec()),r.decode=s=>Yr(s,r.codec())})(Pa||(Pa={}));const Vr=Pa.MessageType,nMe=Pa.ConnectionType,sMe=Object.keys(Vr);let Qn=class ZL{constructor(e,t,n){if(!(t instanceof Uint8Array))throw new Error("Key must be a Uint8Array");this.type=e,this.key=t,this.clusterLevelRaw=n,this.closerPeers=[],this.providerPeers=[],this.record=void 0}get clusterLevel(){const e=this.clusterLevelRaw-1;return e<0?0:e}set clusterLevel(e){this.clusterLevelRaw=e}serialize(){return Pa.encode({key:this.key,type:this.type,clusterLevelRaw:this.clusterLevelRaw,closerPeers:this.closerPeers.map(lR),providerPeers:this.providerPeers.map(lR),record:this.record==null?void 0:this.record.serialize().subarray()})}static deserialize(e){const t=Pa.decode(e),n=new ZL(t.type??Pa.MessageType.PUT_VALUE,t.key??Uint8Array.from([]),t.clusterLevelRaw??0);return n.closerPeers=t.closerPeers.map(uR),n.providerPeers=t.providerPeers.map(uR),t.record?.length!=null&&(n.record=Kr.deserialize(t.record)),n}};function lR(r){return{id:r.id.toBytes(),addrs:(r.multiaddrs??[]).map(t=>t.bytes),connection:nMe.CONNECTED}}function uR(r){if(r.id==null)throw new Error("Invalid peer in message");return{id:ni(r.id),multiaddrs:(r.addrs??[]).map(e=>rMe(e)),protocols:[]}}function dR(r){return{...r,name:"SENDING_QUERY",type:0,messageName:r.type,messageType:sMe.indexOf(r.type.toString())}}function P6(r){return{...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer!=null?r.closer:[],providers:r.providers!=null?r.providers:[]}}function Yf(r){return{...r,name:"FINAL_PEER",type:2}}function ki(r){return{...r,name:"QUERY_ERROR",type:3}}function hR(r){return{...r,name:"PROVIDER",type:4}}function k6(r){return{...r,name:"VALUE",type:5}}function fR(r){return{...r,name:"DIALING_PEER",type:7}}let pR=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function eM(r,e,t){const n=t??{},s=Wa(r);async function*i(){let o;const a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){const{abortMessage:l,abortCode:d}=n;throw new pR(l,d)}const u=new Promise((l,d)=>{o=()=>{const{abortMessage:f,abortCode:g}=n;d(new pR(f,g))}});c=await Promise.race([u,s.next()]),o=null}catch(u){e.removeEventListener("abort",a);const l=u.type==="aborted"&&e.aborted;if(l&&n.onAbort!=null&&await n.onAbort(r),typeof s.return=="function")try{const d=s.return();d instanceof Promise&&d.catch(f=>{n.onReturnError!=null&&n.onReturnError(f)})}catch(d){n.onReturnError!=null&&n.onReturnError(d)}if(l&&n.returnOnAbort===!0)return;throw u}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return i()}function iMe(r,e,t){return n=>r(eM(n,e,t))}function gR(r,e,t){return{sink:iMe(r.sink,e,{...t,onAbort:void 0}),source:eM(r.source,e,t)}}let oMe=class extends gt{constructor(e,t){super();const{protocol:n,lan:s}=t;this.components=e,this.log=N(`libp2p:kad-dht:${s?"lan":"wan"}:network`),this.running=!1,this.protocol=n}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,n={}){if(this.running){this.log("sending %s to %p",t.type,e),yield fR({peer:e}),yield dR({to:e,type:t.type});try{const i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n),o=await this._writeReadMessage(i,t.serialize(),n);yield P6({from:e,messageType:o.type,closer:o.closerPeers,providers:o.providerPeers,record:o.record})}catch(s){yield ki({from:e,error:s})}finally{}}}async*sendMessage(e,t,n={}){if(this.running){this.log("sending %s to %p",t.type,e),yield fR({peer:e}),yield dR({to:e,type:t.type});try{const i=await(await this.components.connectionManager.openConnection(e,n)).newStream(this.protocol,n);await this._writeMessage(i,t.serialize(),n),yield P6({from:e,messageType:t.type})}catch(s){yield ki({from:e,error:s})}finally{}}}async _writeMessage(e,t,n){n.signal!=null&&(e=gR(e,n.signal)),await Ae([t],U0(),e,Wt)}async _writeReadMessage(e,t,n){n.signal!=null&&(e=gR(e,n.signal));const s=await Ae([t],U0(),e,B0(),async o=>{const a=await xs(o);if(a!=null)return a;throw new B("No message received","ERR_NO_MESSAGE_RECEIVED")}),i=Qn.deserialize(s);return i.closerPeers.forEach(o=>{this.dispatchEvent(new W("peer",{detail:o}))}),i.providerPeers.forEach(o=>{this.dispatchEvent(new W("peer",{detail:o}))}),i}};var aMe=tM,yR=128,cMe=127,lMe=~cMe,uMe=Math.pow(2,31);function tM(r,e,t){e=e||[],t=t||0;for(var n=t;r>=uMe;)e[t++]=r&255|yR,r/=128;for(;r&lMe;)e[t++]=r&255|yR,r>>>=7;return e[t]=r|0,tM.bytes=t-n+1,e}var dMe=N6,hMe=128,wR=127;function N6(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw N6.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&wR)<<s:(o&wR)*Math.pow(2,s),s+=7}while(o>=hMe);return N6.bytes=i-n,t}var fMe=Math.pow(2,7),pMe=Math.pow(2,14),gMe=Math.pow(2,21),yMe=Math.pow(2,28),wMe=Math.pow(2,35),bMe=Math.pow(2,42),mMe=Math.pow(2,49),EMe=Math.pow(2,56),vMe=Math.pow(2,63),_Me=function(r){return r<fMe?1:r<pMe?2:r<gMe?3:r<yMe?4:r<wMe?5:r<bMe?6:r<mMe?7:r<EMe?8:r<vMe?9:10},SMe={encode:aMe,decode:dMe,encodingLength:_Me},rM=SMe;const bR=(r,e,t=0)=>(rM.encode(r,e,t),e),mR=r=>rM.encodingLength(r),ER=(r,e)=>{const t=e.byteLength,n=mR(r),s=n+mR(t),i=new Uint8Array(s+t);return bR(r,i,0),bR(t,i,n),i.set(e,s),new AMe(r,t,e,i)};let AMe=class{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}};const $Me=({name:r,code:e,encode:t})=>new RMe(r,e,t);let RMe=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?ER(this.code,t):t.then(n=>ER(this.code,n))}else throw Error("Unknown type, must be binary type")}};const TMe=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),IMe=$Me({name:"sha2-256",code:18,encode:TMe("SHA-256")});async function D8(r,e){const t=e.key,s=C(t).split("/");if(s.length<3)return;const i=r[s[1].toString()];if(i==null){const o="Invalid record keytype";throw new B(o,"ERR_INVALID_RECORD_KEY_TYPE")}await i(t,e.value)}const CMe=async(r,e)=>{if(!(r instanceof Uint8Array))throw new B('"key" must be a Uint8Array',"ERR_INVALID_RECORD_KEY_NOT_BUFFER");if(r.byteLength<5)throw new B("invalid public key record","ERR_INVALID_RECORD_KEY_TOO_SHORT");if(C(r.subarray(0,4))!=="/pk/")throw new B("key was not prefixed with /pk/","ERR_INVALID_RECORD_KEY_BAD_PREFIX");const n=r.slice(4),s=await IMe.digest(e);if(!me(n,s.bytes))throw new B("public key does not match passed in key","ERR_INVALID_RECORD_HASH_MISMATCH")},xMe={pk:CMe};function DMe(r,e,t){if(t.length===0){const o="No records given";throw new B(o,"ERR_NO_RECORDS_RECEIVED")}const s=C(e).split("/");if(s.length<3){const o="Record key does not have a selector function";throw new B(o,"ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")}const i=r[s[1].toString()];if(i==null){const o=`Unrecognized key prefix: ${s[1]}`;throw new B(o,"ERR_UNRECOGNIZED_KEY_PREFIX")}return t.length===1?0:i(e,t)}function OMe(r,e){return 0}const PMe={pk:OMe};class kMe{constructor(e,t){const{validators:n,selectors:s,peerRouting:i,queryManager:o,routingTable:a,network:c,lan:u}=t;this.components=e,this.log=N(`libp2p:kad-dht:${u?"lan":"wan"}:content-fetching`),this.validators=n,this.selectors=s,this.peerRouting=i,this.queryManager=o,this.routingTable=a,this.network=c}async putLocal(e,t){const n=zc(e);await this.components.datastore.put(n,t)}async getLocal(e){this.log("getLocal %b",e);const t=zc(e);this.log("fetching record for key %k",t);const n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);const s=Kr.deserialize(n);return await D8(this.validators,s),s}async*sendCorrectionRecord(e,t,n,s={}){this.log("sendCorrection for %b",e);const i=Y$(e,n);for(const{value:o,from:a}of t){if(me(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const l=zc(e);this.log(`Storing corrected record for key ${l.toString()}`),await this.components.datastore.put(l,i.subarray())}catch(l){this.log.error("Failed error correcting self",l)}continue}let c=!1;const u=new Qn(Vr.PUT_VALUE,e,0);u.record=Kr.deserialize(i);for await(const l of this.network.sendRequest(a,u,s))l.name==="PEER_RESPONSE"&&l.record!=null&&me(l.record.value,Kr.deserialize(i).value)&&(c=!0),yield l;c||(yield ki({from:a,error:new B("value not put correctly","ERR_PUT_VALUE_INVALID")})),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);const s=Y$(e,t),i=zc(e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray()),yield*Ae(this.peerRouting.getClosestPeers(e,{signal:n.signal}),o=>Xr(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],u=new Qn(Vr.PUT_VALUE,e,0);u.record=Kr.deserialize(s),this.log("send put to %p",a.peer.id);for await(const l of this.network.sendRequest(a.peer.id,u,n))c.push(l),l.name==="PEER_RESPONSE"&&(l.record!=null&&me(l.record.value,Kr.deserialize(s).value)||c.push(ki({from:a.peer.id,error:new B("value not put correctly","ERR_PUT_VALUE_INVALID")})));return c}),o=>_2(o,{ordered:!1,concurrency:M0}),async function*(o){for await(const a of o)yield*a})}async*get(e,t={}){this.log("get %b",e);const n=[];for await(const a of this.getMany(e,t))a.name==="VALUE"&&n.push(a),yield a;if(n.length===0)return;const s=n.map(a=>a.value);let i=0;try{i=DMe(this.selectors,e,s)}catch(a){if(a.code!=="ERR_NO_SELECTOR_FUNCTION_FOR_RECORD_KEY")throw a}const o=s[i];if(this.log("GetValue %b %b",e,o),o==null)throw new B("best value was not found","ERR_NOT_FOUND");yield*this.sendCorrectionRecord(e,n,o,t),yield n[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const a=await this.getLocal(e);yield k6({value:a.value,from:this.components.peerId})}catch(a){this.log("error getting local value for %b",e,a)}const n=await El(e),s=this.routingTable.closestPeers(n);this.log("found %d peers in routing table",s.length);const i=this,o=async function*({peer:a,signal:c}){for await(const u of i.peerRouting.getValueOrPeers(a,e,{signal:c}))yield u,u.name==="PEER_RESPONSE"&&u.record!=null&&(yield k6({from:a,value:u.record.value}))};yield*this.queryManager.run(e,s,o,t)}}class NMe{constructor(e,t){const{network:n,peerRouting:s,queryManager:i,routingTable:o,providers:a,lan:c}=t;this.components=e,this.log=N(`libp2p:kad-dht:${c?"lan":"wan"}:content-routing`),this.network=n,this.peerRouting=s,this.queryManager=i,this.routingTable=o,this.providers=a}async*provide(e,t,n={}){this.log("provide %s",e),await this.providers.addProvider(e,this.components.peerId);const s=new Qn(Vr.ADD_PROVIDER,e.multihash.bytes,0);s.providerPeers=[{id:this.components.peerId,multiaddrs:t,protocols:[]}];let i=0;const o=a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[];this.log("putProvider %s to %p",e,a.peer.id);try{this.log("sending provider record for %s to %p",e,a.peer.id);for await(const u of this.network.sendMessage(a.peer.id,s,n))u.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,a.peer.id),i++),c.push(u)}catch(u){this.log.error("error sending provide record to peer %p",a.peer.id,u),c.push(ki({from:a.peer.id,error:u}))}return c};yield*Ae(this.peerRouting.getClosestPeers(e.multihash.bytes,n),a=>Xr(a,c=>o(c)),a=>_2(a,{ordered:!1,concurrency:M0}),async function*(a){for await(const c of a)yield*c}),this.log("sent provider records to %d peers",i)}async*findProviders(e,t){const n=this.routingTable.kBucketSize,s=e.multihash.bytes,i=await El(s),o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e);if(a.length>0){const l=[];for(const d of a.slice(0,n))l.push({id:d,multiaddrs:(await this.components.peerStore.addressBook.get(d)??[]).map(f=>f.multiaddr),protocols:[]});yield P6({from:this.components.peerId,messageType:Vr.GET_PROVIDERS,providers:l}),yield hR({from:this.components.peerId,providers:l})}if(a.length>=n)return;const c=async function*({peer:l,signal:d}){const f=new Qn(Vr.GET_PROVIDERS,s,0);yield*o.network.sendRequest(l,f,{signal:d})},u=new Set(a.map(l=>l.toString()));for await(const l of this.queryManager.run(s,this.routingTable.closestPeers(i),c,t))if(yield l,l.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",l.providers.length,e,l.closer.length);const d=[];for(const f of l.providers)u.has(f.id.toString())||(u.add(f.id.toString()),d.push(f));if(d.length>0&&(yield hR({from:l.from,providers:d})),u.size===n)return}}}class LMe{constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peerId)}async add(e){if(this.peerDistances.find(s=>s.peerId.equals(e))!=null)return;const t=await Ci(e),n={peerId:e,distance:Rd(this.originDhtKey,t)};this.peerDistances.push(n),this.peerDistances.sort((s,i)=>Sw(s.distance,i.distance)),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async anyCloser(e){if(e.length===0)return!1;if(this.length===0)return!0;const t=await Promise.all(e.map(Ci)),n=this.peerDistances[this.peerDistances.length-1].distance;for(const s of t){const i=Rd(this.originDhtKey,s);if(Sw(i,n)<0)return!0}return!1}}class MMe{constructor(e,t){const{routingTable:n,network:s,validators:i,queryManager:o,lan:a}=t;this.components=e,this.routingTable=n,this.network=s,this.validators=i,this.queryManager=o,this.log=N(`libp2p:kad-dht:${a?"lan":"wan"}:peer-routing`)}async findPeerLocal(e){let t;const n=await this.routingTable.find(e);if(n!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.components.peerStore.get(n)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}}if(t==null)try{t=await this.components.peerStore.get(e)}catch(s){if(s.code!=="ERR_NOT_FOUND")throw s}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(s=>s.multiaddr),protocols:[]}}async*_getValueSingle(e,t,n={}){const s=new Qn(Vr.GET_VALUE,t,0);yield*this.network.sendRequest(e,s,n)}async*getPublicKeyFromNode(e,t={}){const n=vNe(e);for await(const s of this._getValueSingle(e,n,t))if(yield s,s.name==="PEER_RESPONSE"&&s.record!=null){const i=await rs(em({bytes:s.record.value}));if(!i.equals(e))throw new B("public key does not match id","ERR_PUBLIC_KEY_DOES_NOT_MATCH_ID");if(i.publicKey==null)throw new B("public key missing","ERR_PUBLIC_KEY_MISSING");yield k6({from:e,value:i.publicKey})}throw new B(`Node not responding with its public key: ${e.toString()}`,"ERR_INVALID_RECORD")}async*findPeer(e,t={}){this.log("findPeer %p",e);const n=await this.findPeerLocal(e);if(n!=null){this.log("found local"),yield Yf({from:this.components.peerId,peer:n});return}const s=await Ci(e),i=this.routingTable.closestPeers(s);if(i.find(l=>l.equals(e))!=null)try{const l=await this.components.peerStore.get(e);this.log("found in peerStore"),yield Yf({from:this.components.peerId,peer:{id:l.id,multiaddrs:l.addresses.map(d=>d.multiaddr),protocols:[]}});return}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}const a=this,c=async function*({peer:l,signal:d}){const f=new Qn(Vr.FIND_NODE,e.toBytes(),0);for await(const g of a.network.sendRequest(l,f,{signal:d}))if(yield g,g.name==="PEER_RESPONSE"){const h=g.closer.find(p=>p.id.equals(e));h!=null&&(yield Yf({from:g.from,peer:h}))}};let u=!1;for await(const l of this.queryManager.run(e.toBytes(),i,c,t))l.name==="FINAL_PEER"&&(u=!0),yield l;u||(yield ki({from:this.components.peerId,error:new B("Not found","ERR_NOT_FOUND")}))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await El(e),s=this.routingTable.closestPeers(n),i=this,o=new LMe(n,this.routingTable.kBucketSize);await Promise.all(s.map(async c=>{await o.add(c)}));const a=async function*({peer:c,signal:u}){i.log("closerPeersSingle %s from %p",C(e,"base32"),c);const l=new Qn(Vr.FIND_NODE,e,0);yield*i.network.sendRequest(c,l,{signal:u})};for await(const c of this.queryManager.run(e,s,a,t))yield c,c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async u=>{await o.add(u.id)}));this.log("found %d peers close to %b",o.length,e);for(const c of o.peers)yield Yf({from:this.components.peerId,peer:{id:c,multiaddrs:(await this.components.peerStore.addressBook.get(c)??[]).map(u=>u.multiaddr),protocols:[]}})}async*getValueOrPeers(e,t,n={}){for await(const s of this._getValueSingle(e,t,n)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record)}catch{const o="invalid record received, discarded";this.log(o),yield ki({from:s.from,error:new B(o,"ERR_INVALID_RECORD")});continue}yield s}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw new B("invalid record received","ERR_INVALID_RECORD");await D8(this.validators,new Kr(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){const n=await El(e),s=this.routingTable.closestPeers(n),i=[];for(const o of s)if(!o.equals(t))try{const a=await this.components.peerStore.addressBook.get(o),c=await this.components.peerStore.protoBook.get(o);i.push({id:o,multiaddrs:a.map(u=>u.multiaddr),protocols:c})}catch(a){if(a.code!=="ERR_NOT_FOUND")throw a}return i.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",i.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p",e,t),i}}const gi=N("libp2p:kad-dht:providers");class UMe{constructor(e,t={}){const{cacheSize:n,cleanupInterval:s,provideValidity:i}=t;this.components=e,this.cleanupInterval=s??pNe,this.provideValidity=i??fNe,this.cache=f2(n??hNe),this.syncQueue=new zt({concurrency:1}),this.started=!1}isStarted(){return this.started}async start(){this.started||(this.started=!0,this.cleaner=setInterval(()=>{this._cleanup().catch(e=>{gi.error(e)})},this.cleanupInterval))}async stop(){this.started=!1,this.cleaner!=null&&(clearInterval(this.cleaner),this.cleaner=void 0)}async _cleanup(){await this.syncQueue.add(async()=>{const e=Date.now();let t=0,n=0;const s=new Map,i=this.components.datastore.batch(),o=this.components.datastore.query({prefix:jL});for await(const a of o)try{const{cid:c,peerId:u}=nM(a.key),l=sM(a.value).getTime(),d=Date.now(),f=d-l,g=f>this.provideValidity;if(gi("comparing: %d - %d = %d > %d %s",d,l,f,this.provideValidity,g?"(expired)":""),g){n++,i.delete(a.key);const h=s.get(c)??new Set;h.add(u),s.set(c,h)}t++}catch(c){gi.error(c.message)}s.size>0?(gi("deleting %d / %d entries",n,t),await i.commit()):gi("nothing to delete");for(const[a,c]of s){const u=_d(a),l=this.cache.get(u);if(l!=null){for(const d of c)l.delete(d);l.size===0?this.cache.remove(u):this.cache.set(u,l)}}gi("Cleanup successful (%dms)",Date.now()-e)})}async _getProvidersMap(e){const t=_d(e);let n=this.cache.get(t);return n==null&&(n=await zMe(this.components.datastore,e),this.cache.set(t,n)),n}async addProvider(e,t){await this.syncQueue.add(async()=>{gi("%p provides %s",t,e);const n=await this._getProvidersMap(e);gi("loaded %s provs",n.size);const s=new Date;n.set(t.toString(),s);const i=_d(e);this.cache.set(i,n),await BMe(this.components.datastore,e,t,s)})}async getProviders(e){return await this.syncQueue.add(async()=>(gi("get providers for %s",e),[...(await this._getProvidersMap(e)).keys()].map(n=>de(n))),{throwOnTimeout:!0})}}function _d(r){const e=typeof r=="string"?r:C(r.multihash.bytes,"base32");return`${jL}/${e}`}async function BMe(r,e,t,n){const s=[_d(e),"/",t.toString()].join(""),i=new ie(s),o=Uint8Array.from(D.encode(n.getTime()));await r.put(i,o)}function nM(r){const e=r.toString().split("/");if(e.length!==5)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:e[3],peerId:e[4]}}async function zMe(r,e){const t=new Map,n=r.query({prefix:_d(e)});for await(const s of n){const{peerId:i}=nM(s.key);t.set(i,sM(s.value))}return t}function sM(r){return new Date(D.decode(r))}const FMe=BigInt("0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF");async function*VMe(r){const{key:e,startingPeer:t,ourPeerId:n,signal:s,query:i,alpha:o,pathIndex:a,numPaths:c,cleanUp:u,queryFuncTimeout:l,log:d,peersSeen:f}=r,g=new zt({concurrency:o}),h=await El(e);function p(w,y){if(w==null)return;f.add(w);const E=BigInt("0x"+C(Rd(y,h),"base16"));g.add(async()=>{let m;const b=[s];l!=null&&(m=new ft.TimeoutController(l),b.push(m.signal));const v=Xs(b);try{for await(const S of i({key:e,peer:w,signal:v,pathIndex:a,numPaths:c})){if(v.aborted)return;if(S.name==="PEER_RESPONSE")for(const _ of S.closer){if(f.has(_.id)){d("already seen %p in query",_.id);continue}if(n.equals(_.id)){d("not querying ourselves");continue}const A=await Ci(_.id);if(BigInt("0x"+C(Rd(A,h),"base16"))>E){d("skipping %p as they are not closer to %b than %p",_.id,e,w);continue}d("querying closer peer %p",_.id),p(_.id,A)}g.emit("completed",S)}m?.clear()}catch(S){s.aborted?g.emit("error",S):g.emit("completed",ki({from:w,error:S}))}finally{m?.clear()}},{priority:FMe-E}).catch(m=>{d.error(m)})}p(t,await Ci(t)),yield*jMe(g,s,u,d)}async function*jMe(r,e,t,n){let s=Pe(),i=!0;const o=[],a=()=>{i&&(n("clean up queue, results %d, queue size %d, pending tasks %d",o.length,r.size,r.pending),i=!1,r.clear(),o.splice(0,o.length))};for(r.on("completed",c=>{o.push(c),s.resolve()}),r.on("error",c=>{n("queue error",c),a(),s.reject(c)}),r.on("idle",()=>{n("queue idle"),i=!1,s.resolve()}),e.addEventListener("abort",()=>{n("abort queue");const c=i;a(),c&&s.reject(new B("Query aborted","ERR_QUERY_ABORTED"))}),t.addEventListener("cleanup",()=>{a(),s.resolve()});i;)for(await s.promise,s=Pe();o.length>0;){const c=o.shift();c!=null&&(yield c)}yield*o}class qMe{constructor(e,t){const{lan:n=!1,disjointPaths:s=C6,alpha:i=M0}=t;this.components=e,this.disjointPaths=s??C6,this.controllers=new Set,this.running=!1,this.alpha=i??M0,this.lan=n,this.queries=0}isStarted(){return this.running}async start(){this.running=!0,this.components.metrics!=null&&this.metrics==null&&(this.metrics={runningQueries:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_running_queries`),queryTime:this.components.metrics.registerMetric(`libp2p_kad_dht_${this.lan?"lan":"wan"}_query_time_seconds`)})}async stop(){this.running=!1;for(const e of this.controllers)e.abort();this.controllers.clear()}async*run(e,t,n,s={}){if(!this.running)throw new Error("QueryManager not started");const i=this.metrics?.queryTime.timer();let o;if(s.signal==null){o=new ft.TimeoutController(mNe),s.signal=o.signal;try{Qe.setMaxListeners!=null&&Qe.setMaxListeners(1/0,o.signal)}catch{}}const a=new AbortController;this.controllers.add(a);const c=[a.signal];s.signal!=null&&c.push(s.signal);const u=Xs(c);try{Qe.setMaxListeners!=null&&Qe.setMaxListeners(1/0,u)}catch{}const l=N(`libp2p:kad-dht:${this.lan?"lan":"wan"}:query:`+C(e,"base58btc")),d=t.slice(0,Math.min(this.disjointPaths,t.length)),f=Date.now(),g=new gt;try{if(l("query:start"),this.queries++,this.metrics?.runningQueries.update(this.queries),t.length===0){l.error("Running query with no peers");return}const h=new ko,p=d.map((w,y)=>VMe({key:e,startingPeer:w,ourPeerId:this.components.peerId,signal:u,query:n,pathIndex:y,numPaths:d.length,alpha:this.alpha,cleanUp:g,queryFuncTimeout:s.queryFuncTimeout,log:l,peersSeen:h}));for await(const w of nn(...p))yield w,w.name==="QUERY_ERROR"&&l("error",w.error)}catch(h){if(!(!this.running&&h.code==="ERR_QUERY_ABORTED"))throw h}finally{this.controllers.delete(a),o?.clear(),this.queries--,this.metrics?.runningQueries.update(this.queries),i?.(),g.dispatchEvent(new W("cleanup")),l("query:done in %dms",Date.now()-f)}}}const Ju=N("libp2p:kad-dht:rpc:handlers:add-provider");class KMe{constructor(e){const{providers:t}=e;this.providers=t}async handle(e,t){if(Ju("start"),t.key==null||t.key.length===0)throw new B("Missing key","ERR_MISSING_KEY");let n;try{n=mg.decode(t.key)}catch{throw new B("Invalid CID","ERR_INVALID_CID")}(t.providerPeers==null||t.providerPeers.length===0)&&Ju.error("no providers found in message"),await Promise.all(t.providerPeers.map(async s=>{if(!s.id.equals(e)){Ju("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){Ju("no valid addresses for provider %p. Ignore",e);return}Ju("received provider %p for %s (addrs %s)",e,n,s.multiaddrs.map(i=>i.toString())),await this.providers.addProvider(n,s.id)}))}}const vR=N("libp2p:kad-dht:rpc:handlers:find-node");class GMe{constructor(e,t){const{peerRouting:n,lan:s}=t;this.components=e,this.peerRouting=n,this.lan=!!s}async handle(e,t){vR("incoming request from %p for peers closer to %b",e,t.key);let n=[];me(this.components.peerId.toBytes(),t.key)?n=[{id:this.components.peerId,multiaddrs:this.components.addressManager.getAddresses().map(i=>i.decapsulateCode(_t("p2p").code)),protocols:[]}]:n=await this.peerRouting.getCloserPeersOffline(t.key,e),n=n.map(this.lan?R8:$8).filter(({multiaddrs:i})=>i.length);const s=new Qn(t.type,new Uint8Array(0),t.clusterLevel);return n.length>0?s.closerPeers=n:vR("could not find any peers closer to %b than %p",t.key,e),s}}const _R=N("libp2p:kad-dht:rpc:handlers:get-providers");class HMe{constructor(e,t){const{peerRouting:n,providers:s,lan:i}=t;this.components=e,this.peerRouting=n,this.providers=s,this.lan=!!i}async handle(e,t){let n;try{n=mg.decode(t.key)}catch{throw new B("Invalid CID","ERR_INVALID_CID")}_R("%p asking for providers for %s",e,n);const[s,i]=await Promise.all([this.providers.getProviders(n),this.peerRouting.getCloserPeersOffline(t.key,e)]),o=await this._getPeers(s),a=await this._getPeers(i.map(({id:u})=>u)),c=new Qn(t.type,t.key,t.clusterLevel);return o.length>0&&(c.providerPeers=o),a.length>0&&(c.closerPeers=a),_R("got %s providers %s closerPeers",o.length,a.length),c}async _getAddresses(e){return(await this.components.peerStore.addressBook.get(e)).map(n=>n.multiaddr)}async _getPeers(e){const t=[],n=this.lan?R8:$8;for(const s of e){const i=n({id:s,multiaddrs:await this._getAddresses(s),protocols:[]});i.multiaddrs.length>0&&t.push(i)}return t}}const Ac=N("libp2p:kad-dht:rpc:handlers:get-value");class WMe{constructor(e,t){const{peerRouting:n}=t;this.components=e,this.peerRouting=n}async handle(e,t){const n=t.key;if(Ac("%p asked for key %b",e,n),n==null||n.length===0)throw new B("Invalid key","ERR_INVALID_KEY");const s=new Qn(Vr.GET_VALUE,n,t.clusterLevel);if(_Ne(n)){Ac("is public key");const a=SNe(n);let c;try{const u=await this.components.peerStore.keyBook.get(a);if(u==null)throw new B("No public key found in key book","ERR_NOT_FOUND");c=u}catch(u){if(u.code!=="ERR_NOT_FOUND")throw u}if(c!=null)return Ac("returning found public key"),s.record=new Kr(n,c,new Date),s}const[i,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(t.key,e)]);return i!=null&&(Ac("had record for %b in local datastore",n),s.record=i),o.length>0&&(Ac("had %s closer peers in routing table",o.length),s.closerPeers=o),s}async _checkLocalDatastore(e){Ac("checkLocalDatastore looking for %b",e);const t=zc(e);let n;try{n=await this.components.datastore.get(t)}catch(i){if(i.code==="ERR_NOT_FOUND")return;throw i}const s=Kr.deserialize(n);if(s==null)throw new B("Invalid record","ERR_INVALID_RECORD");if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>aNe){await this.components.datastore.delete(t);return}return s}}const QMe=N("libp2p:kad-dht:rpc:handlers:ping");class YMe{async handle(e,t){return QMe("ping from %p",e),t}}class XMe{constructor(e,t){const{validators:n}=t;this.components=e,this.log=N("libp2p:kad-dht:rpc:handlers:put-value"),this.validators=n}async handle(e,t){const n=t.key;this.log("%p asked us to store value for key %b",e,n);const s=t.record;if(s==null){const i=`Empty record from: ${e.toString()}`;throw this.log.error(i),new B(i,"ERR_EMPTY_RECORD")}try{await D8(this.validators,s),s.timeReceived=new Date;const i=zc(s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,i)}catch(i){this.log("did not put record for key %b into datastore %o",n,i)}return t}}class JMe{constructor(e,t){const{providers:n,peerRouting:s,validators:i,lan:o}=t;this.log=N("libp2p:kad-dht:rpc"),this.routingTable=t.routingTable,this.handlers={[Vr.GET_VALUE]:new WMe(e,{peerRouting:s}),[Vr.PUT_VALUE]:new XMe(e,{validators:i}),[Vr.FIND_NODE]:new GMe(e,{peerRouting:s,lan:o}),[Vr.ADD_PROVIDER]:new KMe({providers:n}),[Vr.GET_PROVIDERS]:new HMe(e,{peerRouting:s,providers:n,lan:o}),[Vr.PING]:new YMe}}async handleMessage(e,t){try{await this.routingTable.add(e)}catch(s){this.log.error("Failed to update the kbucket store",s)}const n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}return await n.handle(e,t)}onIncomingStream(e){Promise.resolve().then(async()=>{const{stream:t,connection:n}=e,s=n.remotePeer;try{await this.routingTable.add(s)}catch(o){this.log.error(o)}const i=this;await Ae(t,B0(),async function*(o){for await(const a of o){const c=Qn.deserialize(a);i.log("incoming %s from %p",c.type,s);const u=await i.handleMessage(s,c);u!=null&&(yield u.serialize())}},U0(),t)}).catch(t=>{this.log.error(t)})}}class ZMe extends gt{constructor(e,t){super();const{protocol:n,lan:s}=t;this.components=e,this.log=N(`libp2p:kad-dht:topology-listener:${s?"lan":"wan"}`),this.running=!1,this.protocol=n}isStarted(){return this.running}async start(){if(this.running)return;this.running=!0;const e=J4({onConnect:t=>{this.log("observed peer %p with protocol %s",t,this.protocol),this.dispatchEvent(new W("peer",{detail:t}))}});this.registrarId=await this.components.registrar.register(this.protocol,e)}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class eUe{constructor(e,t){const{peerRouting:n,lan:s,count:i,interval:o,queryTimeout:a}=t;this.components=e,this.log=N(`libp2p:kad-dht:${s?"lan":"wan"}:query-self`),this.running=!1,this.peerRouting=n,this.count=i??C6,this.interval=o??gNe,this.queryTimeout=a??yNe}isStarted(){return this.running}async start(){this.running||(this.running=!0,this._querySelf())}async stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}_querySelf(){Promise.resolve().then(async()=>{const e=new ft.TimeoutController(this.queryTimeout);try{this.controller=new AbortController;const t=Xs([this.controller.signal,e.signal]);try{Qe.setMaxListeners!=null&&Qe.setMaxListeners(1/0,t)}catch{}const n=await Ae(this.peerRouting.getClosestPeers(this.components.peerId.toBytes(),{signal:t}),s=>La(s,this.count),async s=>await ll(s));this.log("query ran successfully - found %d peers",n)}catch(t){this.log("query error",t)}finally{this.timeoutId=setTimeout(this._querySelf.bind(this),this.interval),e.clear()}}).catch(e=>{this.log("query error",e)})}}const tUe=32,rUe=64;let SR=class extends gt{constructor(e,t){super();const{kBucketSize:n,clientMode:s,validators:i,selectors:o,querySelfInterval:a,lan:c,protocolPrefix:u,pingTimeout:l,pingConcurrency:d,maxInboundStreams:f,maxOutboundStreams:g,providers:h}=t;this.running=!1,this.components=e,this.lan=!!c,this.log=N(`libp2p:kad-dht:${c===!0?"lan":"wan"}`),this.protocol=`${u??lNe}${c===!0?cNe:""}${uNe}`,this.kBucketSize=n??20,this.clientMode=s??!0,this.maxInboundStreams=f??tUe,this.maxOutboundStreams=g??rUe,this.routingTable=new CNe(e,{kBucketSize:n,lan:this.lan,pingTimeout:l,pingConcurrency:d,protocol:this.protocol}),this.providers=new UMe(e,h??{}),this.validators={...xMe,...i},this.selectors={...PMe,...o},this.network=new oMe(e,{protocol:this.protocol,lan:this.lan}),this.queryManager=new qMe(e,{disjointPaths:Math.ceil(this.kBucketSize/2),lan:c}),this.peerRouting=new MMe(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,lan:this.lan}),this.contentFetching=new kMe(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,network:this.network,lan:this.lan}),this.contentRouting=new NMe(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,lan:this.lan}),this.routingTableRefresh=new DNe({peerRouting:this.peerRouting,routingTable:this.routingTable,lan:this.lan}),this.rpc=new JMe(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,lan:this.lan}),this.topologyListener=new ZMe(e,{protocol:this.protocol,lan:this.lan}),this.querySelf=new eUe(e,{peerRouting:this.peerRouting,interval:a,lan:this.lan}),this.network.addEventListener("peer",p=>{const w=p.detail;this.onPeerConnect(w).catch(y=>{this.log.error("could not add %p to routing table",w.id,y)}),this.dispatchEvent(new W("peer",{detail:w}))}),this.topologyListener.addEventListener("peer",p=>{const w=p.detail;Promise.resolve().then(async()=>{const y=await this.components.peerStore.addressBook.get(w),E={id:w,multiaddrs:y.map(m=>m.multiaddr),protocols:[]};await this.onPeerConnect(E)}).catch(y=>{this.log.error("could not add %p to routing table",w,y)})})}get[Hh](){return!0}get[Symbol.toStringTag](){return"@libp2p/kad-dht"}async onPeerConnect(e){if(this.log("peer %p connected with protocols %s",e.id,e.protocols),this.lan?e=R8(e):e=$8(e),e.multiaddrs.length===0){this.log("ignoring %p as they do not have any %s addresses in %s",e.id,this.lan?"private":"public",e.multiaddrs.map(t=>t.toString()));return}try{await this.routingTable.add(e.id)}catch(t){this.log.error("could not add %p to routing table",e.id,t)}}isStarted(){return this.running}async getMode(){return this.clientMode?"client":"server"}async setMode(e){await this.components.registrar.unhandle(this.protocol),e==="client"?(this.log("enabling client mode"),this.clientMode=!0):(this.log("enabling server mode"),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running=!0,await this.setMode(this.clientMode?"client":"server"),await Promise.all([this.providers.start(),this.queryManager.start(),this.network.start(),this.routingTable.start(),this.topologyListener.start(),this.querySelf.start()]),await this.routingTableRefresh.start()}async stop(){this.running=!1,await Promise.all([this.providers.stop(),this.queryManager.stop(),this.network.stop(),this.routingTable.stop(),this.routingTableRefresh.stop(),this.topologyListener.stop(),this.querySelf.stop()])}async*put(e,t,n={}){yield*this.contentFetching.put(e,t,n)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}};const nUe=N("libp2p:kad-dht");class sUe extends gt{constructor(e,t,n){super(),this.components=e,this.wan=t,this.lan=n,this.wan.addEventListener("peer",s=>{this.dispatchEvent(new W("peer",{detail:s.detail}))}),this.lan.addEventListener("peer",s=>{this.dispatchEvent(new W("peer",{detail:s.detail}))})}get[Hh](){return!0}get[Symbol.toStringTag](){return"@libp2p/dual-kad-dht"}isStarted(){return this.wan.isStarted()&&this.lan.isStarted()}async getMode(){return await this.wan.getMode()}async setMode(e){await this.wan.setMode(e)}async start(){await Promise.all([this.lan.start(),this.wan.start()])}async stop(){await Promise.all([this.lan.stop(),this.wan.stop()])}async*put(e,t,n={}){for await(const s of nn(this.lan.put(e,t,n),this.wan.put(e,t,n)))yield s}async*get(e,t={}){let n=!1,s=!1;for await(const i of nn(this.lan.get(e,t),this.wan.get(e,t)))yield i,i.name==="DIALING_PEER"&&(n=!0),i.name==="VALUE"&&(n=!0,i.value!=null&&(s=!0)),i.name==="SENDING_QUERY"&&(n=!0);if(!n)throw new B("No peers found in routing table!","ERR_NO_PEERS_IN_ROUTING_TABLE");s||(yield ki({from:this.components.peerId,error:new B("Not found","ERR_NOT_FOUND")}))}async*provide(e,t={}){let n=0,s=0;const i=[],o=[this.lan];await this.wan.getMode()==="server"&&o.push(this.wan);for await(const a of nn(...o.map(c=>c.provide(e,t))))yield a,a.name==="SENDING_QUERY"&&n++,a.name==="QUERY_ERROR"&&i.push(a.error),a.name==="PEER_RESPONSE"&&a.messageName==="ADD_PROVIDER"&&(nUe("sent provider record for %s to %p",e,a.from),s++);if(s===0)throw i.length>0?new B(`Failed to provide to ${i.length} of ${n} peers`,"ERR_PROVIDES_FAILED",{errors:i}):new B("Failed to provide - no peers found","ERR_PROVIDES_FAILED")}async*findProviders(e,t={}){yield*nn(this.lan.findProviders(e,t),this.wan.findProviders(e,t))}async*findPeer(e,t={}){let n=!1;for await(const s of nn(this.lan.findPeer(e,t),this.wan.findPeer(e,t)))yield s,(s.name==="SENDING_QUERY"||s.name==="FINAL_PEER")&&(n=!0);if(!n)throw new B("Peer lookup failed","ERR_LOOKUP_FAILED")}async*getClosestPeers(e,t={}){yield*nn(this.lan.getClosestPeers(e,t),this.wan.getClosestPeers(e,t))}async refreshRoutingTable(){await Promise.all([this.lan.refreshRoutingTable(),this.wan.refreshRoutingTable()])}}class iUe extends sUe{constructor(e,t){super(e,new SR(e,{protocolPrefix:"/ipfs",...t,lan:!1}),new SR(e,{protocolPrefix:"/ipfs",...t,clientMode:!1,lan:!0}))}}function oUe(r){return e=>new iUe(e,r)}const aUe=J("dns4"),cUe=J("dns6"),lUe=J("dnsaddr"),Ha=Vt(J("dns"),lUe,aUe,cUe),vg=Vt(J("ip4"),J("ip6")),vl=Vt(he(vg,J("tcp")),he(Ha,J("tcp"))),_g=he(vg,J("udp")),uUe=he(_g,J("utp")),dUe=he(_g,J("quic")),hUe=he(_g,J("quic-v1")),L6=Vt(he(vl,J("ws")),he(Ha,J("ws"))),M6=Vt(he(L6,J("p2p")),L6),U6=Vt(he(vl,J("wss")),he(Ha,J("wss")),he(vl,J("tls"),J("ws")),he(Ha,J("tls"),J("ws"))),F0=Vt(he(U6,J("p2p")),U6),B6=Vt(he(vl,J("http")),he(vg,J("http")),he(Ha,J("http"))),z6=Vt(he(vl,J("https")),he(vg,J("https")),he(Ha,J("https"))),AR=he(_g,J("webrtc-direct"),J("certhash")),iM=Vt(he(AR,J("p2p")),AR),$R=he(hUe,J("webtransport"),J("certhash"),J("certhash")),oM=Vt(he($R,J("p2p")),$R),aM=Vt(he(M6,J("p2p-webrtc-star"),J("p2p")),he(F0,J("p2p-webrtc-star"),J("p2p")),he(M6,J("p2p-webrtc-star")),he(F0,J("p2p-webrtc-star"))),cM=Vt(he(B6,J("p2p-webrtc-direct"),J("p2p")),he(z6,J("p2p-webrtc-direct"),J("p2p")),he(B6,J("p2p-webrtc-direct")),he(z6,J("p2p-webrtc-direct"))),F6=Vt(L6,U6,B6,z6,aM,cM,vl,uUe,dUe,Ha,iM,oM),Ro=Vt(he(F6,J("p2p")),aM,cM,iM,oM,J("p2p")),RR=Vt(he(Ro,J("p2p-circuit"),Ro),he(Ro,J("p2p-circuit")),he(J("p2p-circuit"),Ro),he(F6,J("p2p-circuit")),he(J("p2p-circuit"),F6),J("p2p-circuit")),lM=()=>Vt(he(RR,lM),RR),Zu=lM(),fUe=Vt(he(Zu,Ro,Zu),he(Ro,Zu),he(Zu,Ro),Zu,Ro);function uM(r){function e(t){let n;try{n=Lh(t)}catch{return!1}const s=r(n.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function he(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(s=>(n=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:uM(e),partialMatch:e}}function Vt(...r){function e(n){let s=null;return r.some(i=>{const o=typeof i=="function"?i().partialMatch(n):i.partialMatch(n);return o!=null?(s=o,!0):!1}),s}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:uM(e),partialMatch:e}}function J(r){const e=r;function t(s){let i;try{i=Lh(s)}catch{return!1}const o=i.protoNames();return o.length===1&&o[0]===e}function n(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}const Xf=N("libp2p:bootstrap"),pUe="bootstrap",gUe=50,yUe=12e4,wUe=1e3;class dM extends gt{constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.timeout=t.timeout??wUe,this.list=[];for(const n of t.list){if(!fUe.matches(n)){Xf.error("Invalid multiaddr");continue}const s=Lh(n),i=s.getPeerId();if(i==null){Xf.error("Invalid bootstrap multiaddr without peer id");continue}const o={id:de(i),multiaddrs:[s],protocols:[]};this.list.push(o)}this._init=t}get[Hh](){return!0}get[Symbol.toStringTag](){return"@libp2p/bootstrap"}isStarted(){return!!this.timer}start(){this.isStarted()||(Xf("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{Xf.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.tagPeer(e.id,this._init.tagName??pUe,{value:this._init.tagValue??gUe,ttl:this._init.tagTTL??yUe}),this.timer==null)return;this.dispatchEvent(new W("peer",{detail:e}))}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}dM.tag="bootstrap";function bUe(r){return e=>new dM(e,r)}const mUe=WebSocket;var Sg={},Ag={};Object.defineProperty(Ag,"__esModule",{value:!0});class EUe{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{const t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,s)=>{this.pullQueue.push({resolve:n,reject:s})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}let hM=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){const s=new EUe;s.highWaterMark=t,s.lowWaterMark=n,s.removeCallback=e({push:i=>s.push(i),stop:()=>s.stop(),fail:i=>s.fail(i),on:(i,o)=>{s.eventHandlers[i]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>s[Symbol.asyncIterator](),Object.freeze(this)}};Ag.EventIterator=hM;Ag.default=hM;Object.defineProperty(Sg,"__esModule",{value:!0});const O8=Ag;var vUe=Sg.EventIterator=O8.EventIterator;function _Ue(r,e,t){return new O8.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}Sg.subscribe=_Ue;Sg.default=O8.EventIterator;function TR(r){return r instanceof ArrayBuffer||r?.constructor?.name==="ArrayBuffer"&&typeof r?.byteLength=="number"}const SUe=r=>{r.binaryType="arraybuffer";const e=async()=>await new Promise((i,o)=>{if(n)return i();if(s!=null)return o(s);const a=l=>{r.removeEventListener("open",c),r.removeEventListener("error",u),l()},c=()=>a(i),u=l=>{a(()=>o(l.error??new Error(`connect ECONNREFUSED ${r.url}`)))};r.addEventListener("open",c),r.addEventListener("error",u)}),t=async function*(){const i=new vUe(({push:o,stop:a,fail:c})=>{const u=d=>{let f=null;typeof d.data=="string"&&(f=L(d.data)),TR(d.data)&&(f=new Uint8Array(d.data)),d.data instanceof Uint8Array&&(f=d.data),f!=null&&o(f)},l=d=>c(d.error??new Error("Socket error"));return r.addEventListener("message",u),r.addEventListener("error",l),r.addEventListener("close",a),()=>{r.removeEventListener("message",u),r.removeEventListener("error",l),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of i)yield TR(o)?new Uint8Array(o):o}();let n=r.readyState===1,s;return r.addEventListener("open",()=>{n=!0,s=null}),r.addEventListener("close",()=>{n=!1,s=null}),r.addEventListener("error",i=>{n||(s=i.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})},AUe=r=>{if(r.readyState>=2)throw new Error("socket closed");if(r.readyState!==1)return new Promise((e,t)=>{function n(){r.removeEventListener("open",s),r.removeEventListener("error",i)}function s(){n(),e()}function i(o){n(),t(o.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",s),r.addEventListener("error",i)})},$Ue=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(const s of n){try{await AUe(r)}catch(i){if(i.message==="socket closed")break;throw i}r.send(s)}if(e.closeOnEnd!=null&&r.readyState<=1)return await new Promise((s,i)=>{r.addEventListener("close",o=>{if(o.wasClean||o.code===1006)s();else{const a=Object.assign(new Error("ws error"),{event:o});i(a)}}),setTimeout(()=>r.close())})}),RUe=(r,e)=>{e=e??{};const t=SUe(r);let n=e.remoteAddress,s=e.remotePort;if(r.url!=null)try{const o=new URL(r.url);n=o.hostname,s=parseInt(o.port,10)}catch{}if(n==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:$Ue(r,e),source:t,connected:async()=>await t.connected(),close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(o=>{r.addEventListener("close",()=>{o()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:s,socket:r}},TUe={http:"ws",https:"wss"},IUe="ws",CUe=(r,e)=>Cm.relative(r,e,TUe,IUe);function xUe(r,e){const t=typeof window>"u"?"":window.location;e=e??{};const n=CUe(r,t.toString()),s=new mUe(n,e.websocket);return RUe(s,e)}function DUe(){throw new Error("WebSocket Servers can not be created in the browser!")}let IR=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function CR(r,e,t){const n=t??{},s=Wa(r);async function*i(){let o;const a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){const{abortMessage:l,abortCode:d}=n;throw new IR(l,d)}const u=new Promise((l,d)=>{o=()=>{const{abortMessage:f,abortCode:g}=n;d(new IR(f,g))}});c=await Promise.race([u,s.next()]),o=null}catch(u){e.removeEventListener("abort",a);const l=u.type==="aborted"&&e.aborted;if(l&&n.onAbort!=null&&await n.onAbort(r),typeof s.return=="function")try{const d=s.return();d instanceof Promise&&d.catch(f=>{n.onReturnError!=null&&n.onReturnError(f)})}catch(d){n.onReturnError!=null&&n.onReturnError(d)}if(l&&n.returnOnAbort===!0)return;throw u}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return i()}const fM=421,pM=290,OUe=2e3;class PUe extends Error{constructor(e){super(e),this.name="TimeoutError"}}let kUe=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const xR=r=>globalThis.DOMException===void 0?new kUe(r):new DOMException(r),DR=r=>{const e=r.reason===void 0?xR("This operation was aborted."):r.reason;return e instanceof Error?e:xR(e)};function NUe(r,e){const{milliseconds:t,fallback:n,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let o;const c=new Promise((u,l)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:f}=e;f.aborted&&l(DR(f)),f.addEventListener("abort",()=>{l(DR(f))})}if(t===Number.POSITIVE_INFINITY){r.then(u,l);return}const d=new PUe;o=i.setTimeout.call(void 0,()=>{if(n){try{u(n())}catch(f){l(f)}return}typeof r.cancel=="function"&&r.cancel(),s===!1?u():s instanceof Error?l(s):(d.message=s??`Promise timed out after ${t} milliseconds`,l(d))},t),(async()=>{try{u(await r)}catch(f){l(f)}})()}).finally(()=>{c.clear()});return c.clear=()=>{i.clearTimeout.call(void 0,o),o=void 0},c}const OR=N("libp2p:websockets:socket");function LUe(r,e,t){t=t??{};const n={async sink(s){t?.signal!=null&&(s=CR(s,t.signal));try{await r.sink(s)}catch(i){i.type!=="aborted"&&OR.error(i)}},source:t.signal!=null?CR(r.source,t.signal):r.source,remoteAddr:e,timeline:{open:Date.now()},async close(){const s=Date.now();try{await NUe(r.close(),{milliseconds:OUe})}catch{const{host:o,port:a}=n.remoteAddr.toOptions();OR("timeout closing stream to %s:%s after %dms, destroying it manually",o,a,Date.now()-s),r.destroy()}finally{n.timeline.close=Date.now()}}};return r.socket.addEventListener("close",()=>{n.timeline.close==null&&(n.timeline.close=Date.now())},{once:!0}),n}function MUe(r){return r.filter(e=>{if(e.protoCodes().includes(pM))return!1;const t=e.decapsulateCode(fM);return M6.matches(t)||F0.matches(t)})}function UUe(r){return r.filter(e=>{if(e.protoCodes().includes(pM))return!1;const t=e.decapsulateCode(fM);return F0.matches(t)})}const Ji=N("libp2p:websockets");class BUe{constructor(e){this.init=e}get[Symbol.toStringTag](){return"@libp2p/websockets"}get[F5](){return!0}async dial(e,t){Ji("dialing %s",e),t=t??{};const n=await this._connect(e,t),s=LUe(n,e);Ji("new outbound connection %s",s.remoteAddr);const i=await t.upgrader.upgradeOutbound(s);return Ji("outbound connection %s upgraded",s.remoteAddr),i}async _connect(e,t){if(t?.signal?.aborted===!0)throw new K8;const n=e.toOptions();Ji("dialing %s:%s",n.host,n.port);const s=Pe(),i=u=>{Ji.error("connection error:",u),s.reject(u)},o=xUe(x4(e),this.init);if(o.socket.on!=null?o.socket.on("error",i):o.socket.onerror=i,t.signal==null)return await Promise.race([o.connected(),s.promise]),Ji("connected %s",e),o;let a;const c=new Promise((u,l)=>{if(a=()=>{l(new K8),o.close().catch(d=>{Ji.error("error closing raw socket",d)})},t?.signal?.aborted===!0){a();return}t?.signal?.addEventListener("abort",a)});try{await Promise.race([c,s.promise,o.connected()])}finally{a!=null&&t?.signal?.removeEventListener("abort",a)}return Ji("connected %s",e),o}createListener(e){return DUe({...this.init,...e})}filter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):$d||rm?UUe(e):MUe(e)}}function zUe(r={}){return()=>new BUe(r)}let PR=class extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function gM(r,e,t){const n=t??{},s=Wa(r);async function*i(){let o;const a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){const{abortMessage:l,abortCode:d}=n;throw new PR(l,d)}const u=new Promise((l,d)=>{o=()=>{const{abortMessage:f,abortCode:g}=n;d(new PR(f,g))}});c=await Promise.race([u,s.next()]),o=null}catch(u){e.removeEventListener("abort",a);const l=u.type==="aborted"&&e.aborted;if(l&&n.onAbort!=null&&await n.onAbort(r),typeof s.return=="function")try{const d=s.return();d instanceof Promise&&d.catch(f=>{n.onReturnError!=null&&n.onReturnError(f)})}catch(d){n.onReturnError!=null&&n.onReturnError(d)}if(l&&n.returnOnAbort===!0)return;throw u}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return i()}function kR(r){return new Uint8Array(r)}var Ie;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(Ie||(Ie={}));const P8=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),NR=Object.freeze({NEW_STREAM:Ie.NEW_STREAM,MESSAGE:Ie.MESSAGE_INITIATOR,CLOSE:Ie.CLOSE_INITIATOR,RESET:Ie.RESET_INITIATOR}),FUe=Object.freeze({MESSAGE:Ie.MESSAGE_RECEIVER,CLOSE:Ie.CLOSE_RECEIVER,RESET:Ie.RESET_RECEIVER}),LR=1024*1024,VUe=(r,e)=>{e.append(r)};async function*jUe(r,e={}){let t=new ue,n=!1,s=Pe(),i=Number(e.size??LR);(isNaN(i)||i===0||i<0)&&(i=LR);const o=e.yieldAfter??0,a=e.serialize??VUe;for(Promise.resolve().then(async()=>{try{let c;for await(const u of r){if(a(u,t),t.byteLength>=i){clearTimeout(c),s.resolve();continue}c=setTimeout(()=>{s.resolve()},o)}clearTimeout(c),s.resolve()}catch(c){s.reject(c)}finally{n=!0}});!n;)if(await s.promise,s=Pe(),t.byteLength>0){const c=t;t=new ue,yield c.subarray()}}const ww=10*1024;let qUe=class{constructor(){this._pool=kR(ww),this._poolOffset=0}write(e,t){const n=this._pool;let s=this._poolOffset;D.encode(e.id<<3|e.type,n,s),s+=D.encode.bytes??0,(e.type===Ie.NEW_STREAM||e.type===Ie.MESSAGE_INITIATOR||e.type===Ie.MESSAGE_RECEIVER)&&e.data!=null?D.encode(e.data.length,n,s):D.encode(0,n,s),s+=D.encode.bytes??0;const i=n.subarray(this._poolOffset,s);ww-s<100?(this._pool=kR(ww),this._poolOffset=0):this._poolOffset=s,t.append(i),(e.type===Ie.NEW_STREAM||e.type===Ie.MESSAGE_INITIATOR||e.type===Ie.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}};const MR=new qUe;async function*KUe(r,e=0){if(e==null||e===0){for await(const t of r){const n=new ue;for(const s of t)MR.write(s,n);yield n.subarray()}return}yield*jUe(r,{size:e,serialize:(t,n)=>{for(const s of t)MR.write(s,n)}})}const yM=1<<20,GUe=4<<20;let HUe=class{constructor(e=yM,t=GUe){this._buffer=new ue,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw Object.assign(new Error("unprocessed message queue size too large!"),{code:"ERR_MSG_QUEUE_TOO_BIG"});const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(u){if(u.code==="ERR_MSG_TOO_BIG")throw u;break}const{id:n,type:s,length:i,offset:o}=this._headerInfo;if(this._buffer.length-o<i)break;const c={id:n,type:s};(s===Ie.NEW_STREAM||s===Ie.MESSAGE_INITIATOR||s===Ie.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+i)),t.push(c),this._buffer.consume(o+i),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=BR(e),{value:s,offset:i}=BR(e,n),o=t&7;if(P8[o]==null)throw new Error(`Invalid type received: ${o}`);if(s>this._maxMessageSize)throw Object.assign(new Error("message size too large!"),{code:"ERR_MSG_TOO_BIG"});return{id:t>>3,type:o,offset:n+i,length:s}}};const WUe=128,UR=127;function BR(r,e=0){let t=0,n=0,s=e,i;const o=r.length;do{if(s>=o||n>49)throw e=0,new RangeError("Could not decode varint");i=r.get(s++),t+=n<28?(i&UR)<<n:(i&UR)*Math.pow(2,n),n+=7}while(i>=WUe);return e=s-e,{value:t,offset:e}}function wM(r){const e=new globalThis.AbortController;function t(){e.abort();for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(const i of r){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function n(){for(const i of r)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=n,s}const os=N("libp2p:mplex:stream"),bw="ERR_STREAM_RESET",QUe="ERR_STREAM_ABORT",YUe="ERR_SINK_ENDED",XUe="ERR_DOUBLE_SINK";function JUe(r){const{id:e,name:t,send:n,onEnd:s,type:i="initiator",maxMsgSize:o=yM}=r,a=new AbortController,c=new AbortController,u=new AbortController,l=i==="initiator"?NR:FUe,d=i==="initiator"?`i${e}`:`r${e}`,f=`${t??e}`;let g=!1,h=!1,p=!1,w;const y={open:Date.now()},E=S=>{g||(g=!0,os.trace("%s stream %s source end - err: %o",i,f,S),S!=null&&w==null&&(w=S),h&&(v.stat.timeline.close=Date.now(),s?.(w)))},m=S=>{h||(h=!0,os.trace("%s stream %s sink end - err: %o",i,f,S),S!=null&&w==null&&(w=S),g&&(y.close=Date.now(),s?.(w)))},b=Mt({onEnd:E}),v={close:()=>{os.trace("%s stream %s close",i,f),v.closeRead(),v.closeWrite()},closeRead:()=>{os.trace("%s stream %s closeRead",i,f),!g&&b.end()},closeWrite:()=>{if(os.trace("%s stream %s closeWrite",i,f),!h){u.abort();try{n({id:e,type:l.CLOSE})}catch(S){os.trace("%s stream %s error sending close",i,t,S)}m()}},abort:S=>{os.trace("%s stream %s abort",i,f,S),b.end(S),a.abort(),m(S)},reset:()=>{const S=new B("stream reset",bw);c.abort(),b.end(S),m(S)},sink:async S=>{if(p)throw new B("sink already called on stream",XUe);if(p=!0,h)throw new B("stream closed for writing",YUe);const _=wM([a.signal,c.signal,u.signal]);try{S=gM(S,_),i==="initiator"&&n({id:e,type:NR.NEW_STREAM,data:new ue(L(f))});for await(let A of S)for(;A.length>0;){if(A.length<=o){n({id:e,type:l.MESSAGE,data:A instanceof Uint8Array?new ue(A):A});break}A=A instanceof Uint8Array?new ue(A):A,n({id:e,type:l.MESSAGE,data:A.sublist(0,o)}),A.consume(o)}}catch(A){if(A.type==="aborted"&&A.message==="The operation was aborted"){if(u.signal.aborted)return;c.signal.aborted&&(A.message="stream reset",A.code=bw),a.signal.aborted&&(A.message="stream aborted",A.code=QUe)}if(A.code===bw)os.trace("%s stream %s reset",i,t);else{os.trace("%s stream %s error",i,t,A);try{n({id:e,type:l.RESET})}catch(T){os.trace("%s stream %s error sending reset",i,t,T)}}b.end(A),m(A);return}finally{_.clear()}try{n({id:e,type:l.CLOSE})}catch(A){os.trace("%s stream %s error sending close",i,t,A)}m()},source:b,sourcePush:S=>{b.push(S)},sourceReadableLength(){return b.readableLength},stat:{direction:i==="initiator"?"outbound":"inbound",timeline:y},metadata:{},id:d};return v}const as=N("libp2p:mplex"),ZUe=1024,eBe=1024,tBe=1024*1024*4,rBe=5;function zR(r){const e={...r,type:`${P8[r.type]} (${r.type})`};return r.type===Ie.NEW_STREAM&&(e.data=C(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===Ie.MESSAGE_INITIATOR||r.type===Ie.MESSAGE_RECEIVER)&&(e.data=C(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}class nBe{constructor(e){this.protocol="/mplex/6.7.0",e=e??{},this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=e,this.sink=this._createSink();const t=this._createSource();this._source=t,this.source=t,this.closeController=new AbortController,this.rateLimiter=new nm.RateLimiterMemory({points:e.disconnectThreshold??rBe,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Error("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}close(e){this.closeController.signal.aborted||(e!=null?this.streams.forEach(t=>{t.abort(e)}):this.streams.forEach(t=>{t.close()}),this.closeController.abort())}_newReceiverStream(e){const{id:t,name:n}=e,s=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:s})}_newStream(e){const{id:t,name:n,type:s,registry:i}=e;if(as("new %s stream %s",s,t),s==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??eBe))throw new B("Too many outbound streams open","ERR_TOO_MANY_OUTBOUND_STREAMS");if(i.has(t))throw new Error(`${s} stream ${t} already exists!`);const c=JUe({id:t,name:n,send:u=>{as.enabled&&as.trace("%s stream %s send",s,t,zR(u)),this._source.push(u)},type:s,onEnd:()=>{as("%s stream with id %s and protocol %s ended",s,t,c.stat.protocol),i.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize});return i.set(t,c),c}_createSink(){return async t=>{const n=wM([this.closeController.signal,this._init.signal]);try{t=gM(t,n);const s=new HUe(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const i of t)for(const o of s.write(i))await this._handleIncoming(o);this._source.end()}catch(s){as("error in sink",s),this._source.end(s)}finally{n.clear()}}}_createSource(){const t=PT({objectMode:!0,onEnd:n=>{this.close(n)}});return Object.assign(KUe(t,this._init.minSendBytes),{push:t.push,end:t.end,return:t.return})}async _handleIncoming(e){const{id:t,type:n}=e;if(as.enabled&&as.trace("incoming message",zR(e)),e.type===Ie.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??ZUe)){as("too many inbound streams open"),this._source.push({id:t,type:Ie.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{as("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this._source.end(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:C(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const i=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(i==null){as("missing stream %s for message type %s",t,P8[n]);return}const o=this._init.maxStreamBufferSize??tBe;switch(n){case Ie.MESSAGE_INITIATOR:case Ie.MESSAGE_RECEIVER:if(i.sourceReadableLength()>o){this._source.push({id:e.id,type:n===Ie.MESSAGE_INITIATOR?Ie.RESET_RECEIVER:Ie.RESET_INITIATOR});const a=new B("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers","ERR_STREAM_INPUT_BUFFER_FULL");i.abort(a);return}i.sourcePush(e.data);break;case Ie.CLOSE_INITIATOR:case Ie.CLOSE_RECEIVER:i.closeRead();break;case Ie.RESET_INITIATOR:case Ie.RESET_RECEIVER:i.reset();break;default:as("unknown message type %s",n)}}}class sBe{constructor(e={}){this.protocol="/mplex/6.7.0",this._init=e}createStreamMuxer(e={}){return new nBe({...e,...this._init})}}function iBe(r={}){return()=>new sBe(r)}const bM=r=>pt.decode(r);bM.bytes=0;function FR(r,e={}){const t=Mt();r.sink(t).catch(o=>{t.end(o)}),r.sink=async o=>{for await(const a of o)t.push(a)};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());const s=new ue,i={read:async o=>{if(o==null){const{done:c,value:u}=await n.next();return c===!0?new ue:u}for(;s.byteLength<o;){const{value:c,done:u}=await n.next();if(u===!0)throw $(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF");s.append(c)}const a=s.sublist(0,o);return s.consume(o),a},readLP:async()=>{let o=-1;const a=new ue,c=e?.lengthDecoder??bM;for(;;){a.append(await i.read(1));try{o=c(a)}catch(u){if(u instanceof RangeError)continue;throw u}if(o>-1)break;if(e?.maxLengthLength!=null&&a.byteLength>e.maxLengthLength)throw $(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG")}if(e?.maxDataLength!=null&&o>e.maxDataLength)throw $(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");return await i.read(o)},readPB:async o=>{const a=await i.readLP();if(a==null)throw new Error("Value is null");const c=a instanceof Uint8Array?a:a.subarray();return o.decode(c)},write:o=>{o instanceof Uint8Array?t.push(o):t.push(o.subarray())},writeLP:o=>{i.write(h8.single(o,e))},writePB:(o,a)=>{i.writeLP(a.encode(o))},pb:o=>({read:async()=>await i.readPB(o),write:a=>{i.writePB(a,o)},unwrap:()=>i}),unwrap:()=>{const o=r.source;return r.source=async function*(){yield*s,yield*o}(),r}};return i}function VR(){const r=Pe();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function oBe(){const r=VR(),e=VR();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}const aBe=8,cBe=1024*1024*4;var ua;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(ua||(ua={}));const k8=r=>{const e=pt.decode(r);return k8.bytes=pt.encodingLength(e),e};k8.bytes=0;function V6(r){return async function*(t){const n=new ue;let s=ua.LENGTH,i=-1;const o=r?.lengthDecoder??k8,a=r?.maxLengthLength??aBe,c=r?.maxDataLength??cBe;for await(const u of t)for(n.append(u);n.byteLength>0;){if(s===ua.LENGTH)try{if(i=o(n),i<0)throw $(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(i>c)throw $(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const l=o.bytes;n.consume(l),r?.onLength!=null&&r.onLength(i),s=ua.DATA}catch(l){if(l instanceof RangeError){if(n.byteLength>a)throw $(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw l}if(s===ua.DATA){if(n.byteLength<i)break;const l=n.sublist(0,i);n.consume(i),r?.onData!=null&&r.onData(l),yield l,s=ua.LENGTH}}if(n.byteLength>0)throw $(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}}V6.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return V6({...e??{},onLength:i=>{t=i}})(n)};const Zd=65535,jR=Zd-16,lBe=!!globalThis.process?.env?.DUMP_SESSION_KEYS;var mM={},ef={},N8={};Object.defineProperty(N8,"__esModule",{value:!0});function uBe(r){return typeof r.saveState<"u"&&typeof r.restoreState<"u"&&typeof r.cleanSavedState<"u"}N8.isSerializableHash=uBe;Object.defineProperty(ef,"__esModule",{value:!0});var Ls=N8,dBe=cU,hBe=IT,EM=function(){function r(e,t){this._finished=!1,this._inner=new e,this._outer=new e,this.blockSize=this._outer.blockSize,this.digestLength=this._outer.digestLength;var n=new Uint8Array(this.blockSize);t.length>this.blockSize?this._inner.update(t).finish(n).clean():n.set(t);for(var s=0;s<n.length;s++)n[s]^=54;this._inner.update(n);for(var s=0;s<n.length;s++)n[s]^=106;this._outer.update(n),Ls.isSerializableHash(this._inner)&&Ls.isSerializableHash(this._outer)&&(this._innerKeyedState=this._inner.saveState(),this._outerKeyedState=this._outer.saveState()),hBe.wipe(n)}return r.prototype.reset=function(){if(!Ls.isSerializableHash(this._inner)||!Ls.isSerializableHash(this._outer))throw new Error("hmac: can't reset() because hash doesn't implement restoreState()");return this._inner.restoreState(this._innerKeyedState),this._outer.restoreState(this._outerKeyedState),this._finished=!1,this},r.prototype.clean=function(){Ls.isSerializableHash(this._inner)&&this._inner.cleanSavedState(this._innerKeyedState),Ls.isSerializableHash(this._outer)&&this._outer.cleanSavedState(this._outerKeyedState),this._inner.clean(),this._outer.clean()},r.prototype.update=function(e){return this._inner.update(e),this},r.prototype.finish=function(e){return this._finished?(this._outer.finish(e),this):(this._inner.finish(e),this._outer.update(e.subarray(0,this.digestLength)).finish(e),this._finished=!0,this)},r.prototype.digest=function(){var e=new Uint8Array(this.digestLength);return this.finish(e),e},r.prototype.saveState=function(){if(!Ls.isSerializableHash(this._inner))throw new Error("hmac: can't saveState() because hash doesn't implement it");return this._inner.saveState()},r.prototype.restoreState=function(e){if(!Ls.isSerializableHash(this._inner)||!Ls.isSerializableHash(this._outer))throw new Error("hmac: can't restoreState() because hash doesn't implement it");return this._inner.restoreState(e),this._outer.restoreState(this._outerKeyedState),this._finished=!1,this},r.prototype.cleanSavedState=function(e){if(!Ls.isSerializableHash(this._inner))throw new Error("hmac: can't cleanSavedState() because hash doesn't implement it");this._inner.cleanSavedState(e)},r}();ef.HMAC=EM;function fBe(r,e,t){var n=new EM(r,e);n.update(t);var s=n.digest();return n.clean(),s}ef.hmac=fBe;ef.equal=dBe.equal;Object.defineProperty(mM,"__esModule",{value:!0});var qR=ef,KR=IT,pBe=function(){function r(e,t,n,s){n===void 0&&(n=new Uint8Array(0)),this._counter=new Uint8Array(1),this._hash=e,this._info=s;var i=qR.hmac(this._hash,n,t);this._hmac=new qR.HMAC(e,i),this._buffer=new Uint8Array(this._hmac.digestLength),this._bufpos=this._buffer.length}return r.prototype._fillBuffer=function(){this._counter[0]++;var e=this._counter[0];if(e===0)throw new Error("hkdf: cannot expand more");this._hmac.reset(),e>1&&this._hmac.update(this._buffer),this._info&&this._hmac.update(this._info),this._hmac.update(this._counter),this._hmac.finish(this._buffer),this._bufpos=0},r.prototype.expand=function(e){for(var t=new Uint8Array(e),n=0;n<t.length;n++)this._bufpos===this._buffer.length&&this._fillBuffer(),t[n]=this._buffer[this._bufpos++];return t},r.prototype.clean=function(){this._hmac.clean(),KR.wipe(this._buffer),KR.wipe(this._counter),this._bufpos=0},r}(),gBe=mM.HKDF=pBe;const yBe={hashSHA256(r){return G8.hash(r)},getHKDF(r,e){const s=new gBe(G8.SHA256,e,r).expand(96),i=s.subarray(0,32),o=s.subarray(32,64),a=s.subarray(64,96);return[i,o,a]},generateX25519KeyPair(){const r=Tg.generateKeyPair();return{publicKey:r.publicKey,privateKey:r.secretKey}},generateX25519KeyPairFromSeed(r){const e=Tg.generateKeyPairFromSeed(r);return{publicKey:e.publicKey,privateKey:e.secretKey}},generateX25519SharedKey(r,e){return Tg.sharedKey(r,e)},chaCha20Poly1305Encrypt(r,e,t,n){return new vp.ChaCha20Poly1305(n).seal(e,r,t)},chaCha20Poly1305Decrypt(r,e,t,n,s){return new vp.ChaCha20Poly1305(n).open(e,r,t,s)}},wBe=r=>globalThis.Buffer?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r),V0=r=>{const e=wBe(2);return new DataView(e.buffer,e.byteOffset,e.byteLength).setUint16(0,r,!1),e};V0.bytes=2;const mp=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");return r instanceof Uint8Array?new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,!1):r.getUint16(0)};mp.bytes=2;function bBe(r){return M([r.ne,r.ciphertext],r.ne.length+r.ciphertext.length)}function mBe(r){return M([r.ne,r.ns,r.ciphertext],r.ne.length+r.ns.length+r.ciphertext.length)}function EBe(r){return M([r.ns,r.ciphertext],r.ns.length+r.ciphertext.length)}function vBe(r){if(r.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:r.subarray(0,32),ciphertext:r.subarray(32,r.length),ns:new Uint8Array(0)}}function _Be(r){if(r.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:r.subarray(0,32),ns:r.subarray(32,80),ciphertext:r.subarray(80,r.length)}}function SBe(r){if(r.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:new Uint8Array(0),ns:r.subarray(0,48),ciphertext:r.subarray(48,r.length)}}function ABe(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=jR){let i=s+jR;i>n.length&&(i=n.length);const o=r.encrypt(n.subarray(s,i),r.session);e?.encryptedPackets.increment(),yield V0(o.byteLength),yield o}}}function $Be(r,e){return async function*(t){for await(const n of t)for(let s=0;s<n.length;s+=Zd){let i=s+Zd;if(i>n.length&&(i=n.length),i-vp.TAG_LENGTH<s)throw new Error("Invalid chunk");const o=n.subarray(s,i),a=n.subarray(s,i-vp.TAG_LENGTH),{plaintext:c,valid:u}=r.decrypt(o,r.session,a);if(!u)throw e?.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");e?.decryptedPackets.increment(),yield c}}}class j0 extends Error{constructor(e="Unexpected Peer"){super(e),this.code=j0.code}static get code(){return"ERR_UNEXPECTED_PEER"}}class Fc extends Error{constructor(e="Invalid crypto exchange"){super(e),this.code=Fc.code}static get code(){return"ERR_INVALID_CRYPTO_EXCHANGE"}}var q0;(function(r){let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{if(s.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(const i of t.webtransportCerthashes)n.uint32(10),n.bytes(i);s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={webtransportCerthashes:[]},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.webtransportCerthashes.push(t.bytes());break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(q0||(q0={}));var K0;(function(r){let e;r.codec=()=>(e==null&&(e=Wr((t,n,s={})=>{s.lengthDelimited!==!1&&n.fork(),(s.writeDefaults===!0||t.identityKey!=null&&t.identityKey.byteLength>0)&&(n.uint32(10),n.bytes(t.identityKey??new Uint8Array(0))),(s.writeDefaults===!0||t.identitySig!=null&&t.identitySig.byteLength>0)&&(n.uint32(18),n.bytes(t.identitySig??new Uint8Array(0))),t.extensions!=null&&(n.uint32(34),q0.codec().encode(t.extensions,n,{writeDefaults:!1})),s.lengthDelimited!==!1&&n.ldelim()},(t,n)=>{const s={identityKey:new Uint8Array(0),identitySig:new Uint8Array(0)},i=n==null?t.len:t.pos+n;for(;t.pos<i;){const o=t.uint32();switch(o>>>3){case 1:s.identityKey=t.bytes();break;case 2:s.identitySig=t.bytes();break;case 4:s.extensions=q0.codec().decode(t,t.uint32());break;default:t.skipType(o&7);break}}return s})),e),r.encode=t=>Qr(t,r.codec()),r.decode=t=>Yr(t,r.codec())})(K0||(K0={}));async function RBe(r,e,t){const n=await IBe(r,vM(e));if(r.publicKey==null)throw new Error("PublicKey was missing from local PeerId");return TBe(r.publicKey,n,t)}function TBe(r,e,t){return K0.encode({identityKey:r,identitySig:e,extensions:t??{webtransportCerthashes:[]}}).subarray()}async function IBe(r,e){if(r.privateKey==null)throw new Error("PrivateKey was missing from PeerId");return await(await Vo(r.privateKey)).sign(e)}async function GR(r){return await rs(r.identityKey)}function HR(r){return K0.decode(r)}function vM(r){const e=L("noise-libp2p-static-key:");return M([e,r],e.length+r.length)}async function WR(r,e,t){const n=await rs(e.identityKey);if(!n.equals(t))throw new Error(`Payload identity key ${n.toString()} does not match expected remote peer ${t.toString()}`);const s=vM(r);if(n.publicKey==null)throw new Error("PublicKey was missing from PeerId");if(e.identitySig==null)throw new Error("Signature was missing from message");if(!await ka(n.publicKey).verify(s,e.identitySig))throw new Error("Static key doesn't match to peer that signed payload!");return n}function Jf(r){return!(!(r instanceof Uint8Array)||r.length!==32)}const kr=N("libp2p:noise");let Yn;lBe?Yn=kr:Yn=Object.assign(()=>{},{enabled:!1,trace:()=>{},error:()=>{}});function CBe(r){Yn(`LOCAL_STATIC_PUBLIC_KEY ${C(r.publicKey,"hex")}`),Yn(`LOCAL_STATIC_PRIVATE_KEY ${C(r.privateKey,"hex")}`)}function QR(r){r?(Yn(`LOCAL_PUBLIC_EPHEMERAL_KEY ${C(r.publicKey,"hex")}`),Yn(`LOCAL_PRIVATE_EPHEMERAL_KEY ${C(r.privateKey,"hex")}`)):Yn("Missing local ephemeral keys.")}function xBe(r){Yn(`REMOTE_STATIC_PUBLIC_KEY ${C(r,"hex")}`)}function YR(r){Yn(`REMOTE_EPHEMERAL_PUBLIC_KEY ${C(r,"hex")}`)}function DBe(r){r.cs1&&r.cs2?(Yn(`CIPHER_STATE_1 ${r.cs1.n.getUint64()} ${C(r.cs1.k,"hex")}`),Yn(`CIPHER_STATE_2 ${r.cs2.n.getUint64()} ${C(r.cs2.k,"hex")}`)):Yn("Missing cipher state.")}const OBe=0,PBe=4294967295,kBe="Cipherstate has reached maximum n, a new handshake must be performed";class NBe{constructor(e=OBe){this.n=e,this.bytes=new Uint8Array(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>PBe)throw new Error(kBe)}}class LBe{constructor(e){this.crypto=e}encryptWithAd(e,t,n){const s=this.encrypt(e.k,e.n,t,n);return e.n.increment(),s}decryptWithAd(e,t,n,s){const{plaintext:i,valid:o}=this.decrypt(e.k,e.n,t,n,s);return o&&e.n.increment(),{plaintext:i,valid:o}}hasKey(e){return!this.isEmptyKey(e.k)}createEmptyKey(){return new Uint8Array(32)}isEmptyKey(e){const t=this.createEmptyKey();return me(t,e)}encrypt(e,t,n,s){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(s,t.getBytes(),n,e)}encryptAndHash(e,t){let n;return this.hasKey(e.cs)?n=this.encryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,n),n}decrypt(e,t,n,s,i){t.assertValue();const o=this.crypto.chaCha20Poly1305Decrypt(s,t.getBytes(),n,e,i);return o?{plaintext:o,valid:!0}:{plaintext:new Uint8Array(0),valid:!1}}decryptAndHash(e,t){let n,s=!0;return this.hasKey(e.cs)?{plaintext:n,valid:s}=this.decryptWithAd(e.cs,e.h,t):n=t,this.mixHash(e,t),{plaintext:n,valid:s}}dh(e,t){try{const n=this.crypto.generateX25519SharedKey(e,t);return n.length===32?n:n.subarray(0,32)}catch(n){const s=n;return kr.error(s),new Uint8Array(32)}}mixHash(e,t){e.h=this.getHash(e.h,t)}getHash(e,t){return this.crypto.hashSHA256(M([e,t],e.length+t.length))}mixKey(e,t){const[n,s]=this.crypto.getHKDF(e.ck,t);e.cs=this.initializeKey(s),e.ck=n}initializeKey(e){return{k:e,n:new NBe}}initializeSymmetric(e){const t=L(e,"utf-8"),n=this.hashProtocolName(t),s=n,i=this.createEmptyKey();return{cs:this.initializeKey(i),ck:s,h:n}}hashProtocolName(e){if(e.length<=32){const t=new Uint8Array(32);return t.set(e),t}else return this.getHash(e,new Uint8Array(0))}split(e){const[t,n]=this.crypto.getHKDF(e.ck,new Uint8Array(0)),s=this.initializeKey(t),i=this.initializeKey(n);return{cs1:s,cs2:i}}writeMessageRegular(e,t){const n=this.encryptWithAd(e,new Uint8Array(0),t),s=this.createEmptyKey(),i=new Uint8Array(0);return{ne:s,ns:i,ciphertext:n}}readMessageRegular(e,t){return this.decryptWithAd(e,new Uint8Array(0),t.ciphertext)}}class MBe extends LBe{initializeInitiator(e,t,n,s){const i="Noise_XX_25519_ChaChaPoly_SHA256",o=this.initializeSymmetric(i);this.mixHash(o,e);const a=new Uint8Array(32);return{ss:o,s:t,rs:n,psk:s,re:a}}initializeResponder(e,t,n,s){const i="Noise_XX_25519_ChaChaPoly_SHA256",o=this.initializeSymmetric(i);this.mixHash(o,e);const a=new Uint8Array(32);return{ss:o,s:t,rs:n,psk:s,re:a}}writeMessageA(e,t,n){const s=new Uint8Array(0);n!==void 0?e.e=n:e.e=this.crypto.generateX25519KeyPair();const i=e.e.publicKey;this.mixHash(e.ss,i);const o=this.encryptAndHash(e.ss,t);return{ne:i,ns:s,ciphertext:o}}writeMessageB(e,t){e.e=this.crypto.generateX25519KeyPair();const n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const s=e.s.publicKey,i=this.encryptAndHash(e.ss,s);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));const o=this.encryptAndHash(e.ss,t);return{ne:n,ns:i,ciphertext:o}}writeMessageC(e,t){const n=e.s.publicKey,s=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));const i=this.encryptAndHash(e.ss,t),a={ne:this.createEmptyKey(),ns:s,ciphertext:i},{cs1:c,cs2:u}=this.split(e.ss);return{h:e.ss.h,messageBuffer:a,cs1:c,cs2:u}}readMessageA(e,t){return Jf(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}readMessageB(e,t){if(Jf(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const{plaintext:n,valid:s}=this.decryptAndHash(e.ss,t.ns);s&&Jf(n)&&(e.rs=n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:i,valid:o}=this.decryptAndHash(e.ss,t.ciphertext);return{plaintext:i,valid:s&&o}}readMessageC(e,t){const{plaintext:n,valid:s}=this.decryptAndHash(e.ss,t.ns);if(s&&Jf(n)&&(e.rs=n),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:i,valid:o}=this.decryptAndHash(e.ss,t.ciphertext),{cs1:a,cs2:c}=this.split(e.ss);return{h:e.ss.h,plaintext:i,valid:s&&o,cs1:a,cs2:c}}initSession(e,t,n){const s=this.createEmptyKey(),i=new Uint8Array(32);let o;return e?o=this.initializeInitiator(t,n,i,s):o=this.initializeResponder(t,n,i,s),{hs:o,i:e,mc:0}}sendMessage(e,t,n){let s;if(e.mc===0)s=this.writeMessageA(e.hs,t,n);else if(e.mc===1)s=this.writeMessageB(e.hs,t);else if(e.mc===2){const{h:i,messageBuffer:o,cs1:a,cs2:c}=this.writeMessageC(e.hs,t);s=o,e.h=i,e.cs1=a,e.cs2=c}else if(e.mc>2)if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");s=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");s=this.writeMessageRegular(e.cs2,t)}else throw new Error("Session invalid.");return e.mc++,s}recvMessage(e,t){let n=new Uint8Array(0),s=!1;if(e.mc===0)({plaintext:n,valid:s}=this.readMessageA(e.hs,t));else if(e.mc===1)({plaintext:n,valid:s}=this.readMessageB(e.hs,t));else if(e.mc===2){const{h:i,plaintext:o,valid:a,cs1:c,cs2:u}=this.readMessageC(e.hs,t);n=o,s=a,e.h=i,e.cs1=c,e.cs2=u}return e.mc++,{plaintext:n,valid:s}}}class UBe{constructor(e,t,n,s,i,o,a,c){this.remoteExtensions={webtransportCerthashes:[]},this.isInitiator=e,this.payload=t,this.prologue=n,this.staticKeypair=i,this.connection=o,a&&(this.remotePeer=a),this.xx=c??new MBe(s),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}async propose(){if(CBe(this.session.hs.s),this.isInitiator){kr.trace("Stage 0 - Initiator starting to send first message.");const e=this.xx.sendMessage(this.session,new Uint8Array(0));this.connection.writeLP(bBe(e)),kr.trace("Stage 0 - Initiator finished sending first message."),QR(this.session.hs.e)}else{kr.trace("Stage 0 - Responder waiting to receive first message...");const e=vBe((await this.connection.readLP()).subarray()),{valid:t}=this.xx.recvMessage(this.session,e);if(!t)throw new Fc("xx handshake stage 0 validation fail");kr.trace("Stage 0 - Responder received first message."),YR(this.session.hs.re)}}async exchange(){if(this.isInitiator){kr.trace("Stage 1 - Initiator waiting to receive first message from responder...");const e=_Be((await this.connection.readLP()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new Fc("xx handshake stage 1 validation fail");kr.trace("Stage 1 - Initiator received the message."),YR(this.session.hs.re),xBe(this.session.hs.rs),kr.trace("Initiator going to check remote's signature...");try{const s=HR(t);this.remotePeer=this.remotePeer||await GR(s),await WR(this.session.hs.rs,s,this.remotePeer),this.setRemoteNoiseExtension(s.extensions)}catch(s){const i=s;throw new j0(`Error occurred while verifying signed payload: ${i.message}`)}kr.trace("All good with the signature!")}else{kr.trace("Stage 1 - Responder sending out first message with signed payload and static key.");const e=this.xx.sendMessage(this.session,this.payload);this.connection.writeLP(mBe(e)),kr.trace("Stage 1 - Responder sent the second handshake message with signed payload."),QR(this.session.hs.e)}}async finish(){if(this.isInitiator){kr.trace("Stage 2 - Initiator sending third handshake message.");const e=this.xx.sendMessage(this.session,this.payload);this.connection.writeLP(EBe(e)),kr.trace("Stage 2 - Initiator sent message with signed payload.")}else{kr.trace("Stage 2 - Responder waiting for third handshake message...");const e=SBe((await this.connection.readLP()).subarray()),{plaintext:t,valid:n}=this.xx.recvMessage(this.session,e);if(!n)throw new Fc("xx handshake stage 2 validation fail");kr.trace("Stage 2 - Responder received the message, finished handshake.");try{const s=HR(t);this.remotePeer=this.remotePeer||await GR(s),await WR(this.session.hs.rs,s,this.remotePeer),this.setRemoteNoiseExtension(s.extensions)}catch(s){const i=s;throw new j0(`Error occurred while verifying signed payload: ${i.message}`)}}DBe(this.session)}encrypt(e,t){const n=this.getCS(t);return this.xx.encryptWithAd(n,new Uint8Array(0),e)}decrypt(e,t,n){const s=this.getCS(t,!1);return this.xx.decryptWithAd(s,new Uint8Array(0),e,n)}getRemoteStaticKey(){return this.session.hs.rs}getCS(e,t=!0){if(!e.cs1||!e.cs2)throw new Fc("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}setRemoteNoiseExtension(e){e&&(this.remoteExtensions=e)}}function BBe(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}class zBe{constructor(e={}){this.protocol="/noise";const{staticNoiseKey:t,extensions:n,crypto:s,prologueBytes:i,metrics:o}=e;this.crypto=s??yBe,this.extensions=n,this.metrics=o?BBe(o):void 0,t?this.staticKeys=this.crypto.generateX25519KeyPairFromSeed(t):this.staticKeys=this.crypto.generateX25519KeyPair(),this.prologue=i??new Uint8Array(0)}async secureOutbound(e,t,n){const s=FR(t,{lengthEncoder:V0,lengthDecoder:mp,maxDataLength:Zd}),i=await this.performHandshake({connection:s,isInitiator:!0,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(s,i),remoteExtensions:i.remoteExtensions,remotePeer:i.remotePeer}}async secureInbound(e,t,n){const s=FR(t,{lengthEncoder:V0,lengthDecoder:mp,maxDataLength:Zd}),i=await this.performHandshake({connection:s,isInitiator:!1,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(s,i),remotePeer:i.remotePeer,remoteExtensions:i.remoteExtensions}}async performHandshake(e){const t=await RBe(e.localPeer,this.staticKeys.publicKey,this.extensions);return await this.performXXHandshake(e,t)}async performXXHandshake(e,t){const{isInitiator:n,remotePeer:s,connection:i}=e,o=new UBe(n,t,this.prologue,this.crypto,this.staticKeys,i,s);try{await o.propose(),await o.exchange(),await o.finish(),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){if(this.metrics?.xxHandshakeErrors.increment(),a instanceof Error)throw a.message=`Error occurred during XX handshake: ${a.message}`,a}return o}async createSecureConnection(e,t){const[n,s]=oBe(),i=e.unwrap();return await Ae(n,ABe(t,this.metrics),i,V6({lengthDecoder:mp}),$Be(t,this.metrics),n),s}}function _M(r={}){return()=>new zBe(r)}const FBe=et.bind({ignoreUndefined:!0,concatArrays:!0});function L8({options:r={},peerId:e,multiaddrs:t=[],repo:n,keychainConfig:s={},config:i={}}){const{datastore:o}=n,a=VBe({options:r,config:i,datastore:o,keychainConfig:s,peerId:e,multiaddrs:t});return typeof r.libp2p=="function"?r.libp2p({libp2pOptions:a,options:r,config:i,datastore:o,peerId:e}):(a.start=!1,Oke(a))}function VBe({options:r,config:e,datastore:t,keychainConfig:n,peerId:s,multiaddrs:i}){const o=()=>{const g=ve(e,"Pubsub.Router")||"gossipsub",h=Nbe();if(!h[g])throw $(new Error(`Router unavailable. Configure libp2p.modules.pubsub to use the ${g} router.`),"ERR_NOT_SUPPORTED");return h[g]},a={datastore:t,peerId:s},c={addresses:{listen:i.map(g=>g.toString()),announce:ve(r,"addresses.announce",ve(e,"Addresses.Announce",[])),noAnnounce:ve(r,"addresses.noAnnounce",ve(e,"Addresses.NoAnnounce",[]))},connectionManager:ve(r,"connectionManager",{maxConnections:ve(r,"config.Swarm.ConnMgr.HighWater",ve(e,"Swarm.ConnMgr.HighWater")),minConnections:ve(r,"config.Swarm.ConnMgr.LowWater",ve(e,"Swarm.ConnMgr.LowWater"))}),keychain:n,identify:{host:{agentVersion:`js-ipfs/${f1}`}},contentRouters:[],peerRouters:[],peerDiscovery:[],transports:[],streamMuxers:[iBe({maxInboundStreams:256,maxOutboundStreams:1024})],connectionEncryption:[_M()],relay:{enabled:ve(r,"relay.enabled",ve(e,"relay.enabled",!0)),hop:{enabled:ve(r,"relay.hop.enabled",ve(e,"relay.hop.enabled",!1)),active:ve(r,"relay.hop.active",ve(e,"relay.hop.active",!1))}},nat:{enabled:!ve(e,"Swarm.DisableNatPortMap",!1)}};ve(r,"config.Pubsub.Enabled",ve(e,"Pubsub.Enabled",!0))&&(c.pubsub=o()),ve(e,"Routing.Type","dhtclient")!=="none"&&(c.dht=oUe({clientMode:ve(e,"Routing.Type","dht")!=="dhtserver",kBucketSize:ve(r,"dht.kBucketSize",20),validators:{ipns:jm},selectors:{ipns:OC}}));const u=ve(r,"config.Bootstrap",ve(e,"Bootstrap",[]));u.length>0&&c.peerDiscovery?.push(bUe({list:u}));let l=ve(r,"libp2p",void 0);typeof l=="function"&&(l=void 0);const d=FBe(a,$$e(),c,l),f=ve(r,"config.Addresses.Delegates",ve(e,"Addresses.Delegates",[]));if(f.length>0){const g=f[Math.floor(Math.random()*f.length)],h=xl(g).toOptions(),p={host:h.host,protocol:parseInt(h.port)===443?"https":"http",port:h.port},w=V9e(p);d.contentRouters?.push(Ime(w)),d.peerRouters?.push(cme(w))}return ve(r,"config.Discovery.MDNS.Enabled",ve(e,"Discovery.MDNS.Enabled",!0))||(d.peerDiscovery=d.peerDiscovery?.filter(g=>{try{if(typeof g=="function")return g({})[Symbol.toStringTag]!=="@libp2p/mdns"}catch{}return!0})),d.transports==null&&(d.transports=[]),d.transports.find(g=>{try{if(typeof g=="function")return g({})[Symbol.toStringTag]==="@libp2p/websockets"}catch{}return!1})==null&&d.transports.push(zUe()),d}const SM=et.bind({ignoreUndefined:!0}),Sd=N("ipfs:components:peer:storage");class M8{constructor(e,t,n,s,i){this.print=s,this.peerId=e,this.keychain=t,this.repo=n,this.print=s,this.isNew=i}static async start(e,t,n){const{repoAutoMigrate:s,repo:i,onMigrationProgress:o}=n,a=typeof i=="string"||i==null?yye(e,t,{path:i,autoMigrate:s,onMigrationProgress:o}):i,{peerId:c,keychain:u,isNew:l}=await jBe(e,a,n);return new M8(c,u,a,e,l)}}const jBe=async(r,e,t)=>{if(!e.closed)return{...await XR(e,t),isNew:!1};try{return await e.open(),{...await XR(e,t),isNew:!1}}catch(n){if(n.code!==ad)throw n;if(t.init&&t.init.allowNew===!1)throw new Cl("Initialization of new repos disabled by config, pass `config.init.isNew: true` to enable it");return{...await qBe(r,e,t),isNew:!0}}},qBe=async(r,e,t)=>{const n=t.init||{},s=await e.exists();if(Sd("repo exists?",s),s===!0)throw new Error("repo already exists");const i=n.privateKey?await KBe(n.privateKey):await GBe(r,n),o=HBe(i);Sd("peer identity: %s",o.PeerID);const a={...SM(AM(qc(),n.profiles),t.config),Identity:o};await e.init(a),await e.open(),Sd("repo opened");const c={pass:t.pass};try{c.dek=await e.config.get("Keychain.DEK")}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l}const u=await L8({options:void 0,multiaddrs:void 0,peerId:i,repo:e,config:a,keychainConfig:c});return await e.datastore.has(new ie("/info/self"))||await u.keychain.importPeer("self",i),await e.config.set("Keychain",{DEK:u.keychain.init.dek}),{peerId:i,keychain:u.keychain}},KBe=async r=>{if(Sd("using user-supplied private-key"),xi(r))return r;const e=L(r,"base64pad"),t=await Vo(e);return await rs(t.public.bytes,t.bytes)},GBe=(r,{algorithm:e="Ed25519",bits:t=2048})=>{if(r("generating %s keypair...",e),e==="Ed25519")return UL();if(e==="RSA")return bke({bits:t});throw $(new Error("Unknown PeerId algorithm"),"ERR_UNKNOWN_PEER_ID_ALGORITHM")},HBe=r=>{if(r.privateKey==null)throw $(new Error("Private key missing"),"ERR_MISSING_PRIVATE_KEY");return{PeerID:r.toString(),PrivKey:C(r.privateKey,"base64pad")}},XR=async(r,e)=>{const t=e.config,n=e.init&&e.init.profiles||[],s=e.pass,i=await r.config.getAll(),o=WBe(AM(i,n),t);if(i!==o&&await r.config.replace(o),!o.Identity||!o.Identity.PrivKey)throw new fh("No private key was found in the config, please intialize the repo");const a=L(o.Identity.PrivKey,"base64pad"),c=await Vo(a),u=await rs(c.public.bytes,c.bytes),l=await L8({options:void 0,multiaddrs:void 0,peerId:u,repo:r,config:o,keychainConfig:{pass:s,...o.Keychain}});return{peerId:u,keychain:l.keychain}},WBe=(r,e)=>e?SM(r,e):r,AM=(r,e)=>(e||[]).reduce((t,n)=>{const s=p1[n];if(!s)throw new Error(`Could not find profile with name '${n}'`);return Sd("applying profile %s",n),s.transform(t)},r);var QBe=$M,JR=128,YBe=127,XBe=~YBe,JBe=Math.pow(2,31);function $M(r,e,t){e=e||[],t=t||0;for(var n=t;r>=JBe;)e[t++]=r&255|JR,r/=128;for(;r&XBe;)e[t++]=r&255|JR,r>>>=7;return e[t]=r|0,$M.bytes=t-n+1,e}var ZBe=j6,eze=128,ZR=127;function j6(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw j6.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&ZR)<<s:(o&ZR)*Math.pow(2,s),s+=7}while(o>=eze);return j6.bytes=i-n,t}var tze=Math.pow(2,7),rze=Math.pow(2,14),nze=Math.pow(2,21),sze=Math.pow(2,28),ize=Math.pow(2,35),oze=Math.pow(2,42),aze=Math.pow(2,49),cze=Math.pow(2,56),lze=Math.pow(2,63),uze=function(r){return r<tze?1:r<rze?2:r<nze?3:r<sze?4:r<ize?5:r<oze?6:r<aze?7:r<cze?8:r<lze?9:10},dze={encode:QBe,decode:ZBe,encodingLength:uze},G0=dze;const q6=(r,e=0)=>[G0.decode(r,e),G0.decode.bytes],H0=(r,e,t=0)=>(G0.encode(r,e,t),e),W0=r=>G0.encodingLength(r),hze=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},U8=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")},K6=(r,e)=>{const t=e.byteLength,n=W0(r),s=n+W0(t),i=new Uint8Array(s+t);return H0(r,i,0),H0(t,i,n),i.set(e,s),new B8(r,t,e,i)},fze=r=>{const e=U8(r),[t,n]=q6(e),[s,i]=q6(e.subarray(n)),o=e.subarray(n+i);if(o.byteLength!==s)throw new Error("Incorrect length");return new B8(t,s,o,e)},pze=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&hze(r.bytes,t.bytes)}};class B8{constructor(e,t,n,s){this.code=e,this.size=t,this.digest=n,this.bytes=s}}function gze(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var yze=gze,wze=yze;let bze=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},mze=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return RM(this,e)}},Eze=class{constructor(e){this.decoders=e}or(e){return RM(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const RM=(r,e)=>new Eze({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let vze=class{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new bze(e,t,n),this.decoder=new mze(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const TM=({name:r,prefix:e,encode:t,decode:n})=>new vze(r,e,t,n),IM=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=wze(t,e);return TM({prefix:r,name:e,encode:n,decode:i=>U8(s(i))})},_ze=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},Sze=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},qi=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>TM({prefix:e,name:r,encode(s){return Sze(s,n,t)},decode(s){return _ze(s,n,t,r)}}),it=IM({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});IM({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Ep=qi({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});qi({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});qi({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});qi({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});qi({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});qi({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});qi({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});qi({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});qi({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const eT=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return $ze(t,G6(r),e||it.encoder);default:return Rze(t,G6(r),e||Ep.encoder)}},tT=new WeakMap,G6=r=>{const e=tT.get(r);if(e==null){const t=new Map;return tT.set(r,t),t}return e};class We{constructor(e,t,n,s){this.code=t,this.version=e,this.multihash=n,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ed)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Tze)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return We.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=K6(e,t);return We.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return We.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&pze(e.multihash,n.multihash)}toString(e){return eT(this,e)}toJSON(){return{"/":eT(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof We)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:s,multihash:i,bytes:o}=t;return new We(n,s,i,o||rT(n,s,i.bytes))}else if(t[Ize]===!0){const{version:n,multihash:s,code:i}=t,o=fze(s);return We.create(n,i,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ed)throw new Error(`Version 0 CID must use dag-pb (code: ${ed}) block encoding`);return new We(e,t,n,n.bytes)}case 1:{const s=rT(e,t,n.bytes);return new We(e,t,n,s)}default:throw new Error("Invalid version")}}static createV0(e){return We.create(0,ed,e)}static createV1(e,t){return We.create(1,e,t)}static decode(e){const[t,n]=We.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=We.inspectBytes(e),n=t.size-t.multihashSize,s=U8(e.subarray(n,n+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),o=new B8(t.multihashCode,t.digestSize,i,s);return[t.version===0?We.createV0(o):We.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,f]=q6(e.subarray(t));return t+=f,d};let s=n(),i=ed;if(s===18?(s=0,t=0):i=n(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const o=t,a=n(),c=n(),u=t+c,l=u-o;return{version:s,codec:i,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,s]=Aze(e,t),i=We.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return G6(i).set(n,e),i}}const Aze=(r,e)=>{switch(r[0]){case"Q":{const t=e||it;return[it.prefix,t.decode(`${it.prefix}${r}`)]}case it.prefix:{const t=e||it;return[it.prefix,t.decode(r)]}case Ep.prefix:{const t=e||Ep;return[Ep.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},$ze=(r,e,t)=>{const{prefix:n}=t;if(n!==it.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(n);if(s==null){const i=t.encode(r).slice(1);return e.set(n,i),i}else return s},Rze=(r,e,t)=>{const{prefix:n}=t,s=e.get(n);if(s==null){const i=t.encode(r);return e.set(n,i),i}else return s},ed=112,Tze=18,rT=(r,e,t)=>{const n=W0(r),s=n+W0(e),i=new Uint8Array(s+t.byteLength);return H0(r,i,0),H0(e,i,n),i.set(t,s),i},Ize=Symbol.for("@ipld/js-cid/CID"),Cze=({name:r,code:e,encode:t})=>new xze(r,e,t);class xze{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?K6(this.code,t):t.then(n=>K6(this.code,n))}else throw Error("Unknown type, must be binary type")}}const Dze=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),mw=Cze({name:"sha2-256",code:18,encode:Dze("SHA-256")});var Oze=CM,nT=128,Pze=127,kze=~Pze,Nze=Math.pow(2,31);function CM(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Nze;)e[t++]=r&255|nT,r/=128;for(;r&kze;)e[t++]=r&255|nT,r>>>=7;return e[t]=r|0,CM.bytes=t-n+1,e}var Lze=H6,Mze=128,sT=127;function H6(r,n){var t=0,n=n||0,s=0,i=n,o,a=r.length;do{if(i>=a)throw H6.bytes=0,new RangeError("Could not decode varint");o=r[i++],t+=s<28?(o&sT)<<s:(o&sT)*Math.pow(2,s),s+=7}while(o>=Mze);return H6.bytes=i-n,t}var Uze=Math.pow(2,7),Bze=Math.pow(2,14),zze=Math.pow(2,21),Fze=Math.pow(2,28),Vze=Math.pow(2,35),jze=Math.pow(2,42),qze=Math.pow(2,49),Kze=Math.pow(2,56),Gze=Math.pow(2,63),Hze=function(r){return r<Uze?1:r<Bze?2:r<zze?3:r<Fze?4:r<Vze?5:r<jze?6:r<qze?7:r<Kze?8:r<Gze?9:10},Wze={encode:Oze,decode:Lze,encodingLength:Hze};const iT=Wze;var Qze=r=>{if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const e=[];for(;r.length>0;){const t=iT.decode(r);e.push(t),r=r.slice(iT.decode.bytes)}return e};const Yze=Ge(Qze);function Xze(r){let e=new Uint8Array(r.reduce((n,s)=>n+D.encodingLength(s),0)),t=0;for(const n of r)e=jT.encode(n,e,t),t+=D.encodingLength(n);return e}class xM{constructor(e,t,n){this._refCounter=1,this.cid=e,this.priority=t||1,this.wantType=n}inc(){this._refCounter+=1}dec(){this._refCounter=Math.max(0,this._refCounter-1)}hasRefs(){return this._refCounter>0}get[Symbol.toStringTag](){return`WantlistEntry <key: ${this.cid.toString(it)}, priority: ${this.priority}, refs: ${this._refCounter}>`}equals(e){return this._refCounter===e._refCounter&&this.cid.equals(e.cid)&&this.priority===e.priority&&this.wantType===e.wantType}}const Ms=X.Reader,td=X.Writer,Re=X.util,Ee=X.roots["ipfs-bitswap"]||(X.roots["ipfs-bitswap"]={}),Ts=Ee.Message=(()=>{function r(e){if(this.blocks=[],this.payload=[],this.blockPresences=[],e)for(var t=Object.keys(e),n=0;n<t.length;++n)e[t[n]]!=null&&(this[t[n]]=e[t[n]])}return r.prototype.wantlist=null,r.prototype.blocks=Re.emptyArray,r.prototype.payload=Re.emptyArray,r.prototype.blockPresences=Re.emptyArray,r.prototype.pendingBytes=0,r.encode=function(t,n){if(n||(n=td.create()),t.wantlist!=null&&Object.hasOwnProperty.call(t,"wantlist")&&Ee.Message.Wantlist.encode(t.wantlist,n.uint32(10).fork()).ldelim(),t.blocks!=null&&t.blocks.length)for(var s=0;s<t.blocks.length;++s)n.uint32(18).bytes(t.blocks[s]);if(t.payload!=null&&t.payload.length)for(var s=0;s<t.payload.length;++s)Ee.Message.Block.encode(t.payload[s],n.uint32(26).fork()).ldelim();if(t.blockPresences!=null&&t.blockPresences.length)for(var s=0;s<t.blockPresences.length;++s)Ee.Message.BlockPresence.encode(t.blockPresences[s],n.uint32(34).fork()).ldelim();return t.pendingBytes!=null&&Object.hasOwnProperty.call(t,"pendingBytes")&&n.uint32(40).int32(t.pendingBytes),n},r.decode=function(t,n){t instanceof Ms||(t=Ms.create(t));for(var s=n===void 0?t.len:t.pos+n,i=new Ee.Message;t.pos<s;){var o=t.uint32();switch(o>>>3){case 1:{i.wantlist=Ee.Message.Wantlist.decode(t,t.uint32());break}case 2:{i.blocks&&i.blocks.length||(i.blocks=[]),i.blocks.push(t.bytes());break}case 3:{i.payload&&i.payload.length||(i.payload=[]),i.payload.push(Ee.Message.Block.decode(t,t.uint32()));break}case 4:{i.blockPresences&&i.blockPresences.length||(i.blockPresences=[]),i.blockPresences.push(Ee.Message.BlockPresence.decode(t,t.uint32()));break}case 5:{i.pendingBytes=t.int32();break}default:t.skipType(o&7);break}}return i},r.fromObject=function(t){if(t instanceof Ee.Message)return t;var n=new Ee.Message;if(t.wantlist!=null){if(typeof t.wantlist!="object")throw TypeError(".Message.wantlist: object expected");n.wantlist=Ee.Message.Wantlist.fromObject(t.wantlist)}if(t.blocks){if(!Array.isArray(t.blocks))throw TypeError(".Message.blocks: array expected");n.blocks=[];for(var s=0;s<t.blocks.length;++s)typeof t.blocks[s]=="string"?Re.base64.decode(t.blocks[s],n.blocks[s]=Re.newBuffer(Re.base64.length(t.blocks[s])),0):t.blocks[s].length>=0&&(n.blocks[s]=t.blocks[s])}if(t.payload){if(!Array.isArray(t.payload))throw TypeError(".Message.payload: array expected");n.payload=[];for(var s=0;s<t.payload.length;++s){if(typeof t.payload[s]!="object")throw TypeError(".Message.payload: object expected");n.payload[s]=Ee.Message.Block.fromObject(t.payload[s])}}if(t.blockPresences){if(!Array.isArray(t.blockPresences))throw TypeError(".Message.blockPresences: array expected");n.blockPresences=[];for(var s=0;s<t.blockPresences.length;++s){if(typeof t.blockPresences[s]!="object")throw TypeError(".Message.blockPresences: object expected");n.blockPresences[s]=Ee.Message.BlockPresence.fromObject(t.blockPresences[s])}}return t.pendingBytes!=null&&(n.pendingBytes=t.pendingBytes|0),n},r.toObject=function(t,n){n||(n={});var s={};if((n.arrays||n.defaults)&&(s.blocks=[],s.payload=[],s.blockPresences=[]),n.defaults&&(s.wantlist=null,s.pendingBytes=0),t.wantlist!=null&&t.hasOwnProperty("wantlist")&&(s.wantlist=Ee.Message.Wantlist.toObject(t.wantlist,n)),t.blocks&&t.blocks.length){s.blocks=[];for(var i=0;i<t.blocks.length;++i)s.blocks[i]=n.bytes===String?Re.base64.encode(t.blocks[i],0,t.blocks[i].length):n.bytes===Array?Array.prototype.slice.call(t.blocks[i]):t.blocks[i]}if(t.payload&&t.payload.length){s.payload=[];for(var i=0;i<t.payload.length;++i)s.payload[i]=Ee.Message.Block.toObject(t.payload[i],n)}if(t.blockPresences&&t.blockPresences.length){s.blockPresences=[];for(var i=0;i<t.blockPresences.length;++i)s.blockPresences[i]=Ee.Message.BlockPresence.toObject(t.blockPresences[i],n)}return t.pendingBytes!=null&&t.hasOwnProperty("pendingBytes")&&(s.pendingBytes=t.pendingBytes),s},r.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},r.getTypeUrl=function(t){return t===void 0&&(t="type.googleapis.com"),t+"/Message"},r.Wantlist=function(){function e(t){if(this.entries=[],t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.entries=Re.emptyArray,e.prototype.full=!1,e.encode=function(n,s){if(s||(s=td.create()),n.entries!=null&&n.entries.length)for(var i=0;i<n.entries.length;++i)Ee.Message.Wantlist.Entry.encode(n.entries[i],s.uint32(10).fork()).ldelim();return n.full!=null&&Object.hasOwnProperty.call(n,"full")&&s.uint32(16).bool(n.full),s},e.decode=function(n,s){n instanceof Ms||(n=Ms.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new Ee.Message.Wantlist;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:{o.entries&&o.entries.length||(o.entries=[]),o.entries.push(Ee.Message.Wantlist.Entry.decode(n,n.uint32()));break}case 2:{o.full=n.bool();break}default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof Ee.Message.Wantlist)return n;var s=new Ee.Message.Wantlist;if(n.entries){if(!Array.isArray(n.entries))throw TypeError(".Message.Wantlist.entries: array expected");s.entries=[];for(var i=0;i<n.entries.length;++i){if(typeof n.entries[i]!="object")throw TypeError(".Message.Wantlist.entries: object expected");s.entries[i]=Ee.Message.Wantlist.Entry.fromObject(n.entries[i])}}return n.full!=null&&(s.full=!!n.full),s},e.toObject=function(n,s){s||(s={});var i={};if((s.arrays||s.defaults)&&(i.entries=[]),s.defaults&&(i.full=!1),n.entries&&n.entries.length){i.entries=[];for(var o=0;o<n.entries.length;++o)i.entries[o]=Ee.Message.Wantlist.Entry.toObject(n.entries[o],s)}return n.full!=null&&n.hasOwnProperty("full")&&(i.full=n.full),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},e.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/Message.Wantlist"},e.WantType=function(){const t={},n=Object.create(t);return n[t[0]="Block"]=0,n[t[1]="Have"]=1,n}(),e.Entry=function(){function t(n){if(n)for(var s=Object.keys(n),i=0;i<s.length;++i)n[s[i]]!=null&&(this[s[i]]=n[s[i]])}return t.prototype.block=Re.newBuffer([]),t.prototype.priority=0,t.prototype.cancel=!1,t.prototype.wantType=0,t.prototype.sendDontHave=!1,t.encode=function(s,i){return i||(i=td.create()),s.block!=null&&Object.hasOwnProperty.call(s,"block")&&i.uint32(10).bytes(s.block),s.priority!=null&&Object.hasOwnProperty.call(s,"priority")&&i.uint32(16).int32(s.priority),s.cancel!=null&&Object.hasOwnProperty.call(s,"cancel")&&i.uint32(24).bool(s.cancel),s.wantType!=null&&Object.hasOwnProperty.call(s,"wantType")&&i.uint32(32).int32(s.wantType),s.sendDontHave!=null&&Object.hasOwnProperty.call(s,"sendDontHave")&&i.uint32(40).bool(s.sendDontHave),i},t.decode=function(s,i){s instanceof Ms||(s=Ms.create(s));for(var o=i===void 0?s.len:s.pos+i,a=new Ee.Message.Wantlist.Entry;s.pos<o;){var c=s.uint32();switch(c>>>3){case 1:{a.block=s.bytes();break}case 2:{a.priority=s.int32();break}case 3:{a.cancel=s.bool();break}case 4:{a.wantType=s.int32();break}case 5:{a.sendDontHave=s.bool();break}default:s.skipType(c&7);break}}return a},t.fromObject=function(s){if(s instanceof Ee.Message.Wantlist.Entry)return s;var i=new Ee.Message.Wantlist.Entry;switch(s.block!=null&&(typeof s.block=="string"?Re.base64.decode(s.block,i.block=Re.newBuffer(Re.base64.length(s.block)),0):s.block.length>=0&&(i.block=s.block)),s.priority!=null&&(i.priority=s.priority|0),s.cancel!=null&&(i.cancel=!!s.cancel),s.wantType){case"Block":case 0:i.wantType=0;break;case"Have":case 1:i.wantType=1;break}return s.sendDontHave!=null&&(i.sendDontHave=!!s.sendDontHave),i},t.toObject=function(s,i){i||(i={});var o={};return i.defaults&&(i.bytes===String?o.block="":(o.block=[],i.bytes!==Array&&(o.block=Re.newBuffer(o.block))),o.priority=0,o.cancel=!1,o.wantType=i.enums===String?"Block":0,o.sendDontHave=!1),s.block!=null&&s.hasOwnProperty("block")&&(o.block=i.bytes===String?Re.base64.encode(s.block,0,s.block.length):i.bytes===Array?Array.prototype.slice.call(s.block):s.block),s.priority!=null&&s.hasOwnProperty("priority")&&(o.priority=s.priority),s.cancel!=null&&s.hasOwnProperty("cancel")&&(o.cancel=s.cancel),s.wantType!=null&&s.hasOwnProperty("wantType")&&(o.wantType=i.enums===String?Ee.Message.Wantlist.WantType[s.wantType]:s.wantType),s.sendDontHave!=null&&s.hasOwnProperty("sendDontHave")&&(o.sendDontHave=s.sendDontHave),o},t.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},t.getTypeUrl=function(s){return s===void 0&&(s="type.googleapis.com"),s+"/Message.Wantlist.Entry"},t}(),e}(),r.Block=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.prefix=Re.newBuffer([]),e.prototype.data=Re.newBuffer([]),e.encode=function(n,s){return s||(s=td.create()),n.prefix!=null&&Object.hasOwnProperty.call(n,"prefix")&&s.uint32(10).bytes(n.prefix),n.data!=null&&Object.hasOwnProperty.call(n,"data")&&s.uint32(18).bytes(n.data),s},e.decode=function(n,s){n instanceof Ms||(n=Ms.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new Ee.Message.Block;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:{o.prefix=n.bytes();break}case 2:{o.data=n.bytes();break}default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof Ee.Message.Block)return n;var s=new Ee.Message.Block;return n.prefix!=null&&(typeof n.prefix=="string"?Re.base64.decode(n.prefix,s.prefix=Re.newBuffer(Re.base64.length(n.prefix)),0):n.prefix.length>=0&&(s.prefix=n.prefix)),n.data!=null&&(typeof n.data=="string"?Re.base64.decode(n.data,s.data=Re.newBuffer(Re.base64.length(n.data)),0):n.data.length>=0&&(s.data=n.data)),s},e.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.prefix="":(i.prefix=[],s.bytes!==Array&&(i.prefix=Re.newBuffer(i.prefix))),s.bytes===String?i.data="":(i.data=[],s.bytes!==Array&&(i.data=Re.newBuffer(i.data)))),n.prefix!=null&&n.hasOwnProperty("prefix")&&(i.prefix=s.bytes===String?Re.base64.encode(n.prefix,0,n.prefix.length):s.bytes===Array?Array.prototype.slice.call(n.prefix):n.prefix),n.data!=null&&n.hasOwnProperty("data")&&(i.data=s.bytes===String?Re.base64.encode(n.data,0,n.data.length):s.bytes===Array?Array.prototype.slice.call(n.data):n.data),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},e.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/Message.Block"},e}(),r.BlockPresenceType=function(){const e={},t=Object.create(e);return t[e[0]="Have"]=0,t[e[1]="DontHave"]=1,t}(),r.BlockPresence=function(){function e(t){if(t)for(var n=Object.keys(t),s=0;s<n.length;++s)t[n[s]]!=null&&(this[n[s]]=t[n[s]])}return e.prototype.cid=Re.newBuffer([]),e.prototype.type=0,e.encode=function(n,s){return s||(s=td.create()),n.cid!=null&&Object.hasOwnProperty.call(n,"cid")&&s.uint32(10).bytes(n.cid),n.type!=null&&Object.hasOwnProperty.call(n,"type")&&s.uint32(16).int32(n.type),s},e.decode=function(n,s){n instanceof Ms||(n=Ms.create(n));for(var i=s===void 0?n.len:n.pos+s,o=new Ee.Message.BlockPresence;n.pos<i;){var a=n.uint32();switch(a>>>3){case 1:{o.cid=n.bytes();break}case 2:{o.type=n.int32();break}default:n.skipType(a&7);break}}return o},e.fromObject=function(n){if(n instanceof Ee.Message.BlockPresence)return n;var s=new Ee.Message.BlockPresence;switch(n.cid!=null&&(typeof n.cid=="string"?Re.base64.decode(n.cid,s.cid=Re.newBuffer(Re.base64.length(n.cid)),0):n.cid.length>=0&&(s.cid=n.cid)),n.type){case"Have":case 0:s.type=0;break;case"DontHave":case 1:s.type=1;break}return s},e.toObject=function(n,s){s||(s={});var i={};return s.defaults&&(s.bytes===String?i.cid="":(i.cid=[],s.bytes!==Array&&(i.cid=Re.newBuffer(i.cid))),i.type=s.enums===String?"Have":0),n.cid!=null&&n.hasOwnProperty("cid")&&(i.cid=s.bytes===String?Re.base64.encode(n.cid,0,n.cid.length):s.bytes===Array?Array.prototype.slice.call(n.cid):n.cid),n.type!=null&&n.hasOwnProperty("type")&&(i.type=s.enums===String?Ee.Message.BlockPresenceType[n.type]:n.type),i},e.prototype.toJSON=function(){return this.constructor.toObject(this,X.util.toJSONOptions)},e.getTypeUrl=function(n){return n===void 0&&(n="type.googleapis.com"),n+"/Message.BlockPresence"},e}(),r})(),oT={Block:Ts.Wantlist.WantType.Block,Have:Ts.Wantlist.WantType.Have},Jze=(r,e)=>Array.prototype.slice.call(e,0).sort((t,n)=>{const s=r(t),i=r(n);return s<i?-1:s>i?1:0});class tf{constructor(e,t){this.set=t?Ka({name:"ipfs_bitswap_wantlist",metrics:t.metrics}):new Map,this._stats=e}get length(){return this.set.size}add(e,t,n){const s=e.toString(it),i=this.set.get(s);i?(i.inc(),i.priority=t,i.wantType===oT.Have&&n===oT.Block&&(i.wantType=n)):(this.set.set(s,new xM(e,t,n)),this._stats&&this._stats.push(null,"wantListSize",1))}remove(e){const t=e.toString(it),n=this.set.get(t);n&&(n.dec(),!n.hasRefs()&&(this.set.delete(t),this._stats&&this._stats.push(null,"wantListSize",-1)))}removeForce(e){this.set.has(e)&&this.set.delete(e)}forEach(e){return this.set.forEach(e)}entries(){return this.set.entries()}sortedEntries(){return new Map(Jze(e=>e[1].key,Array.from(this.set.entries())))}contains(e){const t=e.toString(it);return this.set.has(t)}get(e){const t=e.toString(it);return this.set.get(t)}}tf.Entry=xM;const Zze=tf.Entry;class Q0{constructor(e,t,n,s,i){this.entry=new Zze(e,t,n),this.cancel=!!s,this.sendDontHave=!!i}get cid(){return this.entry.cid}set cid(e){this.entry.cid=e}get priority(){return this.entry.priority}set priority(e){this.entry.priority=e}get wantType(){return this.entry.wantType}set wantType(e){this.entry.wantType=e}get[Symbol.toStringTag](){return`BitswapMessageEntry ${this.cid.toString(it)} <cancel: ${this.cancel}, priority: ${this.priority}>`}equals(e){return this.cancel===e.cancel&&this.sendDontHave===e.sendDontHave&&this.wantType===e.wantType&&this.entry.equals(e.entry)}}const Fl=(r,e)=>{const t=["bitswap"];return e&&t.push(e),r&&t.push(`${r.toString().slice(0,8)}`),N(t.join(":"))},Ew=(r,e)=>{if(r.size!==e.size)return!1;for(const[t,n]of r){const s=e.get(t);if(s===void 0||n instanceof Uint8Array&&s instanceof Uint8Array&&!me(n,s)||n instanceof Q0&&s instanceof Q0&&!n.equals(s))return!1}return!0};class ot{constructor(e){this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}get empty(){return this.blocks.size===0&&this.wantlist.size===0&&this.blockPresences.size===0}addEntry(e,t,n,s,i){n==null&&(n=ot.WantType.Block);const o=e.toString(it),a=this.wantlist.get(o);a?(a.wantType===n&&(a.priority=t),s&&(a.cancel=!!s),i&&(a.sendDontHave=!!i),n===ot.WantType.Block&&a.wantType===ot.WantType.Have&&(a.wantType=n)):this.wantlist.set(o,new Q0(e,t,n,s,i))}addBlock(e,t){const n=e.toString(it);this.blocks.set(n,t)}addHave(e){const t=e.toString(it);this.blockPresences.has(t)||this.blockPresences.set(t,ot.BlockPresenceType.Have)}addDontHave(e){const t=e.toString(it);this.blockPresences.has(t)||this.blockPresences.set(t,ot.BlockPresenceType.DontHave)}cancel(e){const t=e.toString(it);this.wantlist.delete(t),this.addEntry(e,0,ot.WantType.Block,!0,!1)}setPendingBytes(e){this.pendingBytes=e}serializeToBitswap100(){const e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),cancel:!!t.cancel})),full:this.full?!0:void 0},blocks:Array.from(this.blocks.values())};return Ts.encode(e).finish()}serializeToBitswap110(){const e={wantlist:{entries:Array.from(this.wantlist.values()).map(t=>({block:t.cid.bytes,priority:Number(t.priority),wantType:t.wantType,cancel:!!t.cancel,sendDontHave:!!t.sendDontHave})),full:this.full?!0:void 0},blockPresences:[],payload:[],pendingBytes:this.pendingBytes};for(const[t,n]of this.blocks.entries()){const s=We.parse(t),i=s.version,o=s.code,a=s.multihash.code,c=s.multihash.digest.length,u=Xze([i,o,a,c]);e.payload.push(new Ts.Block({prefix:u,data:n}))}for(const[t,n]of this.blockPresences)e.blockPresences.push(new Ts.BlockPresence({cid:We.parse(t).bytes,type:n}));return this.pendingBytes>0&&(e.pendingBytes=this.pendingBytes),Ts.encode(e).finish()}equals(e){return!(this.full!==e.full||this.pendingBytes!==e.pendingBytes||!Ew(this.wantlist,e.wantlist)||!Ew(this.blocks,e.blocks)||!Ew(this.blockPresences,e.blockPresences))}get[Symbol.toStringTag](){const e=Array.from(this.wantlist.keys()),t=Array.from(this.blocks.keys());return`BitswapMessage <full: ${this.full}, list: ${e}, blocks: ${t}>`}}ot.deserialize=async(r,e)=>{const t=Ts.decode(r),n=t.wantlist&&t.wantlist.full||!1,s=new ot(n);return t.wantlist&&t.wantlist.entries&&t.wantlist.entries.forEach(i=>{if(!i.block)return;const o=We.decode(i.block);s.addEntry(o,i.priority||0,i.wantType,!!i.cancel,!!i.sendDontHave)}),t.blockPresences&&t.blockPresences.forEach(i=>{if(!i.cid)return;const o=We.decode(i.cid);i.type===ot.BlockPresenceType.Have?s.addHave(o):s.addDontHave(o)}),t.blocks.length>0?(await Promise.all(t.blocks.map(async i=>{const o=await mw.digest(i),a=We.createV0(o);s.addBlock(a,i)})),s):(t.payload.length>0&&(await Promise.all(t.payload.map(async i=>{if(!i.prefix||!i.data)return;const o=Yze(i.prefix),a=o[0],c=o[1],u=o[2],l=u===mw.code?mw:e&&await e.getHasher(u);if(!l)throw new B("Unknown hash algorithm","ERR_UNKNOWN_HASH_ALG");const d=await l.digest(i.data),f=We.create(a,c,d);s.addBlock(f,i.data)})),s.setPendingBytes(t.pendingBytes)),s)};ot.blockPresenceSize=r=>r.bytes.length+1;ot.Entry=Q0;ot.WantType={Block:Ts.Wantlist.WantType.Block,Have:Ts.Wantlist.WantType.Have};ot.BlockPresenceType={Have:Ts.BlockPresenceType.Have,DontHave:Ts.BlockPresenceType.DontHave};const eFe=3,tFe=Math.pow(2,31)-1,rFe=1e3,nFe=1;var sFe=iFe;function iFe(r,e,t){var n=null,s=null,i=function(){n&&(clearTimeout(n),s=null,n=null)},o=function(){var c=s;i(),c&&c()},a=function(){if(!e)return r.apply(this,arguments);var c=this,u=arguments,l=t&&!n;if(i(),s=function(){r.apply(c,u)},n=setTimeout(function(){if(n=null,!l){var d=s;return s=null,d()}},e),l)return s()};return a.cancel=i,a.flush=o,a}class oFe{constructor(e,t,n){this.peerId=t,this.network=n,this.refcnt=1,this._entries=[],this._log=Fl(e,"msgqueue"),this.sendEntries=sFe(this._sendEntries.bind(this),nFe)}addMessage(e){e.empty||this.send(e)}addEntries(e){this._entries=this._entries.concat(e),this.sendEntries()}_sendEntries(){if(!this._entries.length)return;const e=new ot(!1);this._entries.forEach(t=>{t.cancel?e.cancel(t.cid):e.addEntry(t.cid,t.priority)}),this._entries=[],this.addMessage(e)}async send(e){try{await this.network.connectTo(this.peerId)}catch(t){this._log.error("cant connect to peer %s: %s",this.peerId.toString(),t.message);return}this._log("sending message to peer %s",this.peerId.toString()),this.network.sendMessage(this.peerId,e).catch(t=>{this._log.error("send error: %s",t.message)})}}class aFe{constructor(e,t,n,s){this.peers=Ka({name:"ipfs_bitswap_want_manager_peers",metrics:s.metrics}),this.wantlist=new tf(n,s),this.network=t,this._stats=n,this._peerId=e,this._log=Fl(e,"want")}_addEntries(e,t,n){const s=e.map((i,o)=>new ot.Entry(i,tFe-o,ot.WantType.Block,t));s.forEach(i=>{i.cancel?n?this.wantlist.removeForce(i.cid.toString(it)):this.wantlist.remove(i.cid):(this._log("adding to wl"),this.wantlist.add(i.cid,i.priority))});for(const i of this.peers.values())i.addEntries(s)}_startPeerHandler(e){let t=this.peers.get(e.toString());if(t){t.refcnt++;return}t=new oFe(this._peerId,e,this.network);const n=new ot(!0);for(const s of this.wantlist.entries())n.addEntry(s[1].cid,s[1].priority);return t.addMessage(n),this.peers.set(e.toString(),t),t}_stopPeerHandler(e){const t=this.peers.get(e.toString());t&&(t.refcnt--,!(t.refcnt>0)&&this.peers.delete(e.toString()))}wantBlocks(e,t={}){this._addEntries(e,!1),t&&t.signal&&t.signal.addEventListener("abort",()=>{this.cancelWants(e)})}unwantBlocks(e){this._log("unwant blocks: %s",e.length),this._addEntries(e,!0,!0)}cancelWants(e){this._log("cancel wants: %s",e.length),this._addEntries(e,!0)}connectedPeers(){return Array.from(this.peers.keys())}connected(e){this._startPeerHandler(e)}disconnected(e){this._stopPeerHandler(e)}start(){}stop(){this.peers.forEach(e=>this.disconnected(e.peerId))}}function cFe(r){return globalThis?.Buffer?.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(r):new Uint8Array(r)}const $g=r=>{const e=pt.encodingLength(r),t=cFe(e);return pt.encode(r,t),$g.bytes=e,t};$g.bytes=0;function DM(r){r=r??{};const e=r.lengthEncoder??$g;return async function*(n){for await(const s of n){const i=e(s.byteLength);i instanceof Uint8Array?yield i:yield*i,s instanceof Uint8Array?yield s:yield*s}}}DM.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??$g;return new ue(t(r.byteLength),r)};const lFe=8,uFe=1024*1024*4;var da;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(da||(da={}));const z8=r=>{const e=pt.decode(r);return z8.bytes=pt.encodingLength(e),e};z8.bytes=0;function W6(r){return async function*(t){const n=new ue;let s=da.LENGTH,i=-1;const o=r?.lengthDecoder??z8,a=r?.maxLengthLength??lFe,c=r?.maxDataLength??uFe;for await(const u of t)for(n.append(u);n.byteLength>0;){if(s===da.LENGTH)try{if(i=o(n),i<0)throw $(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(i>c)throw $(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const l=o.bytes;n.consume(l),r?.onLength!=null&&r.onLength(i),s=da.DATA}catch(l){if(l instanceof RangeError){if(n.byteLength>a)throw $(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw l}if(s===da.DATA){if(n.byteLength<i)break;const l=n.sublist(0,i);n.consume(i),r?.onData!=null&&r.onData(l),yield l,s=da.LENGTH}}if(n.byteLength>0)throw $(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}}W6.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:i,value:o}=await r.next(t);if(i===!0)return;o!=null&&(yield o)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return W6({...e??{},onLength:i=>{t=i}})(n)};class aT extends Error{constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}}function dFe(r,e,t){const n=t??{},s=Wa(r);async function*i(){let o;const a=()=>{o?.()};for(e.addEventListener("abort",a);;){let c;try{if(e.aborted){const{abortMessage:l,abortCode:d}=n;throw new aT(l,d)}const u=new Promise((l,d)=>{o=()=>{const{abortMessage:f,abortCode:g}=n;d(new aT(f,g))}});c=await Promise.race([u,s.next()]),o=null}catch(u){e.removeEventListener("abort",a);const l=u.type==="aborted"&&e.aborted;if(l&&n.onAbort!=null&&await n.onAbort(r),typeof s.return=="function")try{const d=s.return();d instanceof Promise&&d.catch(f=>{n.onReturnError!=null&&n.onReturnError(f)})}catch(d){n.onReturnError!=null&&n.onReturnError(d)}if(l&&n.returnOnAbort===!0)return;throw u}if(c.done===!0)break;yield c.value}e.removeEventListener("abort",a)}return i()}const Q6="/ipfs/bitswap/1.0.0",Y6="/ipfs/bitswap/1.1.0",X6="/ipfs/bitswap/1.2.0",hFe=32,fFe=128,pFe=3e4;let gFe=class{constructor(e,t,n,s={}){this._log=Fl(e.peerId,"network"),this._libp2p=e,this._bitswap=t,this._protocols=[Q6],s.b100Only||(this._protocols.unshift(Y6),this._protocols.unshift(X6)),this._stats=n,this._running=!1,this._onPeerConnect=this._onPeerConnect.bind(this),this._onPeerDisconnect=this._onPeerDisconnect.bind(this),this._onConnection=this._onConnection.bind(this),this._hashLoader=s.hashLoader,this._maxInboundStreams=s.maxInboundStreams??hFe,this._maxOutboundStreams=s.maxOutboundStreams??fFe,this._incomingStreamTimeout=s.incomingStreamTimeout??pFe}async start(){this._running=!0,await this._libp2p.handle(this._protocols,this._onConnection,{maxInboundStreams:this._maxInboundStreams,maxOutboundStreams:this._maxOutboundStreams});const e=J4({onConnect:this._onPeerConnect,onDisconnect:this._onPeerDisconnect});this._registrarIds=[];for(const t of this._protocols)this._registrarIds.push(await this._libp2p.register(t,e));this._libp2p.getConnections().forEach(t=>{this._onPeerConnect(t.remotePeer)})}async stop(){if(this._running=!1,await this._libp2p.unhandle(this._protocols),this._registrarIds!=null){for(const e of this._registrarIds)this._libp2p.unregister(e);this._registrarIds=[]}}_onConnection({stream:e,connection:t}){if(!this._running)return;const n=new ft.TimeoutController(this._incomingStreamTimeout);Promise.resolve().then(async()=>{this._log("incoming new bitswap %s connection from %p",e.stat.protocol,t.remotePeer),await Ae(dFe(e.source,n.signal),W6(),async s=>{for await(const i of s){try{const o=await ot.deserialize(i.subarray(),this._hashLoader);await this._bitswap._receiveMessage(t.remotePeer,o)}catch(o){this._bitswap._receiveError(o);break}n.reset()}})}).catch(s=>{this._log(s),e.abort(s)}).finally(()=>{n.clear(),e.close()})}_onPeerConnect(e){this._bitswap._onPeerConnected(e)}_onPeerDisconnect(e){this._bitswap._onPeerDisconnected(e)}findProviders(e,t={}){return this._libp2p.contentRouting.findProviders(e,t)}async findAndConnect(e,t){const n=[];let s=0;for await(const i of this.findProviders(e,t))if(this._log(`connecting to provider ${i.id}`),n.push(this.connectTo(i.id,t).catch(o=>{this._log.error(o)})),s++,s===eFe)break;await Promise.all(n)}async provide(e,t){await this._libp2p.contentRouting.provide(e,t)}async sendMessage(e,t){if(!this._running)throw new Error("network isn't running");const n=e.toString();this._log("sendMessage to %s",n,t);const i=await(await this._libp2p.dial(e)).newStream([X6,Y6,Q6]);await yFe(i,t,this._log),this._updateSentStats(e,t.blocks)}async connectTo(e,t){if(!this._running)throw new Error("network isn't running");return this._libp2p.dial(e,t)}_updateSentStats(e,t){const n=e.toString();if(this._stats){for(const s of t.values())this._stats.push(n,"dataSent",s.length);this._stats.push(n,"blocksSent",t.size)}}};async function yFe(r,e,t){try{let n;switch(r.stat.protocol){case Q6:n=e.serializeToBitswap100();break;case Y6:case X6:n=e.serializeToBitswap110();break;default:throw new Error("Unknown protocol: "+r.stat.protocol)}await Ae([n],DM(),r)}catch(n){t(n)}finally{r.close()}}class wFe{constructor(e){this.partner=e,this.wantlist=new tf,this.exchangeCount=0,this.sentToPeer=new Map,this.accounting={bytesSent:0,bytesRecv:0}}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.accounting.bytesRecv+=e}wants(e,t,n){this.wantlist.add(e,t,n)}cancelWant(e){this.wantlist.remove(e)}wantlistContains(e){return this.wantlist.get(e)}debtRatio(){return this.accounting.bytesSent/(this.accounting.bytesRecv+1)}}class OM extends Map{constructor(e,t){super(),this._cmp=t||this._defaultSort,this._keys=[];for(const[n,s]of e||[])this.set(n,s)}update(e){if(e<0||e>=this._keys.length)return;const t=this._keys[e];this._keys.splice(e,1);const n=this._find(t);this._keys.splice(n,0,t)}set(e,t){if(this.has(e)){const s=this.indexOf(e);this._keys.splice(s,1)}super.set(e,t);const n=this._find(e);return this._keys.splice(n,0,e),this}clear(){super.clear(),this._keys=[]}delete(e){if(!this.has(e))return!1;const t=this.indexOf(e);return this._keys.splice(t,1),super.delete(e)}indexOf(e){if(!this.has(e))return-1;const t=this._find(e);if(this._keys[t]===e)return t;for(let n=1;n<this._keys.length;n++){if(this._keys[t+n]===e)return t+n;if(this._keys[t-n]===e)return t-n}return-1}_find(e){let t=0,n=this._keys.length;for(;t<n;){const s=t+n>>>1,i=this._kCmp(this._keys[s],e);if(i<0)t=s+1;else if(i>0)n=s;else return s}return t}*keys(){for(const e of this._keys)yield e}*values(){for(const e of this._keys)yield this.get(e)}*entries(){for(const e of this._keys)yield[e,this.get(e)]}*[Symbol.iterator](){yield*this.entries()}forEach(e,t){if(e)for(const n of this._keys)e.apply(t,[[n,this.get(n)]])}_defaultSort(e,t){return e[0]<t[0]?-1:t[0]<e[0]?1:0}_kCmp(e,t){return this._cmp([e,this.get(e)],[t,this.get(t)])}}const bFe={hasNewInfo(){return!1},merge(){}};class mFe{constructor(e=bFe){this._taskMerger=e,this._byPeer=new OM([],cT.compare)}pushTasks(e,t){let n=this._byPeer.get(e.toString());n||(n=new cT(e,this._taskMerger)),n.pushTasks(t),this._byPeer.set(e.toString(),n)}popTasks(e){const t=this._head();if(t===void 0)return{tasks:[],pendingSize:0};const{tasks:n,pendingSize:s}=t.popTasks(e);if(n.length===0)return{tasks:n,pendingSize:s};const i=t.peerId;return t.isIdle()?this._byPeer.delete(i.toString()):this._byPeer.update(0),{peerId:i,tasks:n,pendingSize:s}}_head(){if(this._byPeer.size!==0)for(const[,e]of this._byPeer)return e}remove(e,t){const n=this._byPeer.get(t.toString());n&&n.remove(e)}tasksDone(e,t){const n=this._byPeer.get(e.toString());if(!n)return;const s=this._byPeer.indexOf(e.toString());for(const i of t)n.taskDone(i);this._byPeer.update(s)}}class cT{constructor(e,t){this.peerId=e,this._taskMerger=t,this._activeTotalSize=0,this._pending=new EFe,this._active=new Set}pushTasks(e){for(const t of e)this._pushTask(t)}_pushTask(e){if(!this._taskHasMoreInfoThanActiveTasks(e))return;const t=this._pending.get(e.topic);if(t){e.priority>t.priority&&this._pending.updatePriority(e.topic,e.priority),this._taskMerger.merge(e,t);return}this._pending.add(e)}_taskHasMoreInfoThanActiveTasks(e){const t=[];for(const n of this._active)n.topic===e.topic&&t.push(n);return t.length===0?!0:this._taskMerger.hasNewInfo(e,t)}popTasks(e){let t=0;const n=[],s=this._pending.tasks();for(let i=0;i<s.length&&t<e;i++){const o=s[i];n.push(o),t+=o.size,this._pending.delete(o.topic),this._activeTotalSize+=o.size,this._active.add(o)}return{tasks:n,pendingSize:this._pending.totalSize}}taskDone(e){this._active.has(e)&&(this._activeTotalSize-=e.size,this._active.delete(e))}remove(e){this._pending.delete(e)}isIdle(){return this._pending.length===0&&this._active.size===0}static compare(e,t){return e[1]._pending.length===0?1:t[1]._pending.length===0?-1:e[1]._activeTotalSize===t[1]._activeTotalSize?t[1]._pending.length-e[1]._pending.length:e[1]._activeTotalSize-t[1]._activeTotalSize}}class EFe{constructor(){this._tasks=new OM([],this._compare)}get length(){return this._tasks.size}get totalSize(){return[...this._tasks.values()].reduce((e,t)=>e+t.task.size,0)}get(e){return(this._tasks.get(e)||{}).task}add(e){this._tasks.set(e.topic,{created:Date.now(),task:e})}delete(e){this._tasks.delete(e)}tasks(){return[...this._tasks.values()].map(e=>e.task)}updatePriority(e,t){const n=this._tasks.get(e);if(!n)return;const s=this._tasks.indexOf(e);n.task.priority=t,this._tasks.update(s)}_compare(e,t){return e[1].task.priority===t[1].task.priority?e[1].created-t[1].created:t[1].task.priority-e[1].task.priority}}const vFe={hasNewInfo(r,e){let t=!1,n=!1;for(const s of e)s.data.haveBlock&&(t=!0),s.data.isWantBlock&&(n=!0);return!!(!n&&r.data.isWantBlock||!t&&r.data.haveBlock)},merge(r,e){const t=r.data,n=e.data;!n.haveBlock&&t.haveBlock&&(n.haveBlock=t.haveBlock,n.blockSize=t.blockSize),!n.isWantBlock&&t.isWantBlock&&(n.isWantBlock=!0,(!n.haveBlock||t.haveBlock)&&(n.haveBlock=t.haveBlock,e.size=r.size)),n.isWantBlock&&n.haveBlock&&(e.size=n.blockSize)}},lT=ot.WantType,_Fe=16*1024,SFe=1024;class AFe{constructor(e,t,n,s,i,o={}){this._log=Fl(e,"engine"),this.blockstore=t,this.network=n,this._stats=s,this._opts=this._processOpts(o),this.ledgerMap=Ka({name:"ipfs_bitswap_ledger_map",metrics:i.metrics}),this._running=!1,this._requestQueue=new mFe(vFe)}_processOpts(e){return{maxSizeReplaceHasWithBlock:SFe,targetMessageSize:_Fe,...e}}_scheduleProcessTasks(){setTimeout(()=>{this._processTasks()})}async _processTasks(){if(!this._running)return;const{peerId:e,tasks:t,pendingSize:n}=this._requestQueue.popTasks(this._opts.targetMessageSize);if(t.length===0)return;const s=new ot(!1);s.setPendingBytes(n);const i=[],o=new Map;for(const c of t){const u=We.parse(c.topic);c.data.haveBlock?c.data.isWantBlock?(i.push(u),o.set(c.topic,c.data)):s.addHave(u):s.addDontHave(u)}const a=await this._getBlocks(i);for(const[c,u]of o){const l=We.parse(c),d=a.get(c);d?s.addBlock(l,d):u.sendDontHave&&s.addDontHave(l)}if(s.empty){e&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks();return}try{e&&await this.network.sendMessage(e,s);for(const[c,u]of a.entries())e&&this.messageSent(e,We.parse(c),u)}catch(c){this._log.error(c)}e&&this._requestQueue.tasksDone(e,t),this._scheduleProcessTasks()}wantlistForPeer(e){const t=e.toString(),n=this.ledgerMap.get(t);return n?n.wantlist.sortedEntries():new Map}ledgerForPeer(e){const t=e.toString(),n=this.ledgerMap.get(t);return n?{peer:n.partner,value:n.debtRatio(),sent:n.accounting.bytesSent,recv:n.accounting.bytesRecv,exchanged:n.exchangeCount}:null}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.partner)}receivedBlocks(e){if(e.length){for(const t of this.ledgerMap.values())for(const n of e){const s=t.wantlistContains(n.cid);if(!s)continue;const i=n.data.length,o=this._sendAsBlock(s.wantType,i);let a=i;o||(a=ot.blockPresenceSize(s.cid)),this._requestQueue.pushTasks(t.partner,[{topic:s.cid.toString(it),priority:s.priority,size:a,data:{blockSize:i,isWantBlock:o,haveBlock:!0,sendDontHave:!1}}])}this._scheduleProcessTasks()}}async messageReceived(e,t){const n=this._findOrCreate(e);if(t.empty)return;if(t.full&&(n.wantlist=new tf),this._updateBlockAccounting(t.blocks,n),t.wantlist.size===0){this._scheduleProcessTasks();return}const s=[],i=[];t.wantlist.forEach(o=>{o.cancel?(n.cancelWant(o.cid),s.push(o.cid)):(n.wants(o.cid,o.priority,o.wantType),i.push(o))}),this._cancelWants(e,s),await this._addWants(e,i),this._scheduleProcessTasks()}_cancelWants(e,t){for(const n of t)this._requestQueue.remove(n.toString(it),e)}async _addWants(e,t){const n=await this._getBlockSizes(t.map(i=>i.cid)),s=[];for(const i of t){const o=i.cid.toString(it),a=n.get(o);if(a==null)i.sendDontHave&&s.push({topic:o,priority:i.priority,size:ot.blockPresenceSize(i.cid),data:{isWantBlock:i.wantType===lT.Block,blockSize:0,haveBlock:!1,sendDontHave:i.sendDontHave}});else{const c=this._sendAsBlock(i.wantType,a);let u=a;c||(u=ot.blockPresenceSize(i.cid)),s.push({topic:o,priority:i.priority,size:u,data:{isWantBlock:c,blockSize:a,haveBlock:!0,sendDontHave:i.sendDontHave}})}this._requestQueue.pushTasks(e,s)}}_sendAsBlock(e,t){return e===lT.Block||t<=this._opts.maxSizeReplaceHasWithBlock}async _getBlockSizes(e){const t=await this._getBlocks(e);return new Map([...t].map(([n,s])=>[n,s.length]))}async _getBlocks(e){const t=new Map;return await Promise.all(e.map(async n=>{try{const s=await this.blockstore.get(n);t.set(n.toString(it),s)}catch(s){s.code!=="ERR_NOT_FOUND"&&this._log.error("failed to query blockstore for %s: %s",n,s)}})),t}_updateBlockAccounting(e,t){for(const n of e.values())this._log("got block (%s bytes)",n.length),t.receivedBytes(n.length)}messageSent(e,t,n){const s=this._findOrCreate(e);s.sentBytes(n.length),s.wantlist.remove(t)}numBytesSentTo(e){return this._findOrCreate(e).accounting.bytesSent}numBytesReceivedFrom(e){return this._findOrCreate(e).accounting.bytesRecv}peerDisconnected(e){this.ledgerMap.delete(e.toString())}_findOrCreate(e){const t=e.toString(),n=this.ledgerMap.get(t);if(n)return n;const s=new wFe(e);return this.ledgerMap.set(t,s),this._stats&&this._stats.push(t,"peerCount",1),s}start(){this._running=!0}stop(){this._running=!1}}const uT=r=>`unwant:${C(r.multihash.bytes,"base64")}`,dT=r=>`block:${C(r.multihash.bytes,"base64")}`;class $Fe extends Qe.EventEmitter{constructor(e){super(),this.setMaxListeners(rFe),this._log=Fl(e,"notif")}hasBlock(e,t){const n=dT(e);this._log(n),this.emit(n,t)}wantBlock(e,t={}){if(!e)throw new Error("Not a valid cid");const n=dT(e),s=uT(e);return this._log(`wantBlock:${e}`),new Promise((i,o)=>{const a=()=>{this.removeListener(n,c),o(new Error(`Block for ${e} unwanted`))},c=u=>{this.removeListener(s,a),i(u)};this.once(s,a),this.once(n,c),t&&t.signal&&t.signal.addEventListener("abort",()=>{this.removeListener(n,c),this.removeListener(s,a),o(new Error(`Want for ${e} aborted`))})})}unwantBlock(e){const t=uT(e);this._log(t),this.emit(t)}}var PM={exports:{}};(function(r,e){const t=Math.exp;r.exports=function(s){if(typeof s!="number")throw new Error("must provide a timespan to the moving average constructor");if(s<=0)throw new Error("must provide a timespan > 0 to the moving average constructor");let i,o=0,a=0,c=0,u,l={};function d(f,g){return 1-t(-(f-g)/s)}return l.push=function(g,h){if(u){const p=d(g,u),w=h-i,y=p*w;i=p*h+(1-p)*i,o=(1-p)*(o+w*y),a=Math.sqrt(o),c=i+p*w}else i=h;u=g},l.movingAverage=function(){return i},l.variance=function(){return o},l.deviation=function(){return a},l.forecast=function(){return c},l}})(PM);var RFe=PM.exports;const hT=Ge(RFe);class fT extends Qe.EventEmitter{constructor(e,t){super(),this._options=t,this._queue=[],this._stats={},this._frequencyLastTime=Date.now(),this._frequencyAccumulators={},this._movingAverages={},this._update=this._update.bind(this),e.forEach(n=>{this._stats[n]=BigInt(0),this._movingAverages[n]={},this._options.movingAverageIntervals.forEach(s=>{(this._movingAverages[n][s]=hT(s)).push(this._frequencyLastTime,0)})}),this._enabled=this._options.enabled}enable(){this._enabled=!0}disable(){this._disabled=!0}stop(){this._timeout&&clearTimeout(this._timeout)}get snapshot(){return Object.assign({},this._stats)}get movingAverages(){return Object.assign({},this._movingAverages)}push(e,t){this._enabled&&(this._queue.push([e,t,Date.now()]),this._resetComputeTimeout())}_resetComputeTimeout(){this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(this._update,this._nextTimeout())}_nextTimeout(){const e=this._queue.length/this._options.computeThrottleMaxQueueSize;return Math.max(this._options.computeThrottleTimeout*(1-e),0)}_update(){if(this._timeout=null,this._queue.length){let e;for(;this._queue.length;){const t=e=this._queue.shift();t&&this._applyOp(t)}e&&this._updateFrequency(e[2]),this.emit("update",this._stats)}}_updateFrequency(e){const t=e-this._frequencyLastTime;t&&Object.keys(this._stats).forEach(n=>{this._updateFrequencyFor(n,t,e)}),this._frequencyLastTime=e}_updateFrequencyFor(e,t,n){const s=this._frequencyAccumulators[e]||0;this._frequencyAccumulators[e]=0;const i=s/t*1e3;let o=this._movingAverages[e];o||(o=this._movingAverages[e]={}),this._options.movingAverageIntervals.forEach(a=>{let c=o[a];c||(c=o[a]=hT(a)),c.push(n,i)})}_applyOp(e){const t=e[0],n=e[1];if(typeof n!="number")throw new Error(`invalid increment number: ${n}`);Object.prototype.hasOwnProperty.call(this._stats,t)||(this._stats[t]=BigInt(0)),this._stats[t]=BigInt(this._stats[t])+BigInt(n),this._frequencyAccumulators[t]||(this._frequencyAccumulators[t]=0),this._frequencyAccumulators[t]+=n}}const pT={enabled:!1,computeThrottleTimeout:1e3,computeThrottleMaxQueueSize:1e3,movingAverageIntervals:[60*1e3,5*60*1e3,15*60*1e3]};class TFe extends Qe.EventEmitter{constructor(e,t=[],n=pT){super();const s=Object.assign({},pT,n);if(typeof s.computeThrottleTimeout!="number")throw new Error("need computeThrottleTimeout");if(typeof s.computeThrottleMaxQueueSize!="number")throw new Error("need computeThrottleMaxQueueSize");this._initialCounters=t,this._options=s,this._enabled=this._options.enabled,this._global=new fT(t,s),this._global.on("update",i=>this.emit("update",i)),this._peers=Ka({name:"ipfs_bitswap_stats_peers",metrics:e.metrics})}enable(){this._enabled=!0,this._options.enabled=!0,this._global.enable()}disable(){this._enabled=!1,this._options.enabled=!1,this._global.disable()}stop(){this._enabled=!1,this._global.stop();for(const e of this._peers)e[1].stop()}get snapshot(){return this._global.snapshot}get movingAverages(){return this._global.movingAverages}forPeer(e){const t=typeof e!="string"&&e.toString?e.toString():`${e}`;return this._peers.get(t)}push(e,t,n){if(this._enabled&&(this._global.push(t,n),e)){let s=this._peers.get(e);s||(s=new fT(this._initialCounters,this._options),this._peers.set(e,s)),s.push(t,n)}}disconnected(e){const t=e.toString(),n=this._peers.get(t);n&&(n.stop(),this._peers.delete(t))}}const IFe={statsEnabled:!1,statsComputeThrottleTimeout:1e3,statsComputeThrottleMaxQueueSize:1e3},CFe=["blocksReceived","dataReceived","dupBlksReceived","dupDataReceived","blocksSent","dataSent","providesBufferLength","wantListLength","peerCount"];class xFe extends Y4{constructor(e,t,n={}){super(),this._libp2p=e,this._log=Fl(this.peerId),this._options=Object.assign({},IFe,n),this._stats=new TFe(e,CFe,{enabled:this._options.statsEnabled,computeThrottleTimeout:this._options.statsComputeThrottleTimeout,computeThrottleMaxQueueSize:this._options.statsComputeThrottleMaxQueueSize}),this.network=new gFe(e,this,this._stats,{hashLoader:n.hashLoader,maxInboundStreams:n.maxInboundStreams,maxOutboundStreams:n.maxOutboundStreams,incomingStreamTimeout:n.incomingStreamTimeout}),this.blockstore=t,this.engine=new AFe(this.peerId,t,this.network,this._stats,e),this.wm=new aFe(this.peerId,this.network,this._stats,e),this.notifications=new $Fe(this.peerId),this.started=!1}isStarted(){return this.started}get peerId(){return this._libp2p.peerId}async _receiveMessage(e,t){try{await this.engine.messageReceived(e,t)}catch{this._log("failed to receive message",t)}if(t.blocks.size===0)return;const n=[];for(const[s,i]of t.blocks.entries()){const o=We.parse(s);n.push({wasWanted:this.wm.wantlist.contains(o),cid:o,data:i})}this.wm.cancelWants(n.filter(({wasWanted:s})=>s).map(({cid:s})=>s)),await Promise.all(n.map(({cid:s,wasWanted:i,data:o})=>this._handleReceivedBlock(e,s,o,i)))}async _handleReceivedBlock(e,t,n,s){this._log("received block");const i=await this.blockstore.has(t);this._updateReceiveCounters(e.toString(),t,n,i),s&&await this.put(t,n)}_updateReceiveCounters(e,t,n,s){this._stats.push(e,"blocksReceived",1),this._stats.push(e,"dataReceived",n.length),s&&(this._stats.push(e,"dupBlksReceived",1),this._stats.push(e,"dupDataReceived",n.length))}_receiveError(e){this._log.error("ReceiveError: %s",e.message)}_onPeerConnected(e){this.wm.connected(e)}_onPeerDisconnected(e){this.wm.disconnected(e),this.engine.peerDisconnected(e),this._stats.disconnected(e)}enableStats(){this._stats.enable()}disableStats(){this._stats.disable()}wantlistForPeer(e,t){return this.engine.wantlistForPeer(e)}ledgerForPeer(e){return this.engine.ledgerForPeer(e)}async get(e,t={}){const n=(c,u)=>(this.wm.wantBlocks([c],u),this.notifications.wantBlock(c,u));let s=!1;const i=async(c,u)=>{try{return await this.blockstore.get(c,u)}catch(l){if(l.code!=="ERR_NOT_FOUND")throw l;return s||(s=!0,this.network.findAndConnect(c,u).catch(d=>this._log.error(d))),n(c,u)}},o=new AbortController,a=t.signal?Xs([t.signal,o.signal]):o.signal;try{return await Promise.race([this.notifications.wantBlock(e,{signal:a}),i(e,{signal:a})])}finally{o.abort()}}async*getMany(e,t={}){for await(const n of e)yield this.get(n,t)}unwant(e){const t=Array.isArray(e)?e:[e];this.wm.unwantBlocks(t),t.forEach(n=>this.notifications.unwantBlock(n))}cancelWants(e){this.wm.cancelWants(Array.isArray(e)?e:[e])}async put(e,t,n){await this.blockstore.put(e,t),this._sendHaveBlockNotifications(e,t)}async*putMany(e,t){for await(const{key:n,value:s}of this.blockstore.putMany(e,t))this._sendHaveBlockNotifications(n,s),yield{key:n,value:s}}_sendHaveBlockNotifications(e,t){this.notifications.hasBlock(e,t),this.engine.receivedBlocks([{cid:e,data:t}]),this.network.provide(e).catch(n=>{this._log.error("Failed to provide: %s",n.message)})}getWantlist(){return this.wm.wantlist.entries()}peers(){return this.engine.peers()}stat(){return this._stats}async start(){this.wm.start(),await this.network.start(),this.engine.start(),this.started=!0}async stop(){this._stats.stop(),this.wm.stop(),await this.network.stop(),this.engine.stop(),this.started=!1}unwrap(){return this.blockstore}has(e){return this.blockstore.has(e)}}const DFe=(r,e,t={})=>new xFe(r,e,t);function OFe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var s=0;s<r.length;s++){var i=r.charAt(s),o=i.charCodeAt(0);if(t[o]!==255)throw new TypeError(i+" is ambiguous");t[o]=s}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var p=0,w=0,y=0,E=h.length;y!==E&&h[y]===0;)y++,p++;for(var m=(E-y)*l+1>>>0,b=new Uint8Array(m);y!==E;){for(var v=h[y],S=0,_=m-1;(v!==0||S<w)&&_!==-1;_--,S++)v+=256*b[_]>>>0,b[_]=v%a>>>0,v=v/a>>>0;if(v!==0)throw new Error("Non-zero carry");w=S,y++}for(var A=m-w;A!==m&&b[A]===0;)A++;for(var T=c.repeat(p);A<m;++A)T+=r.charAt(b[A]);return T}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var p=0;if(h[p]!==" "){for(var w=0,y=0;h[p]===c;)w++,p++;for(var E=(h.length-p)*u+1>>>0,m=new Uint8Array(E);h[p];){var b=t[h.charCodeAt(p)];if(b===255)return;for(var v=0,S=E-1;(b!==0||v<y)&&S!==-1;S--,v++)b+=a*m[S]>>>0,m[S]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");y=v,p++}if(h[p]!==" "){for(var _=E-y;_!==E&&m[_]===0;)_++;for(var A=new Uint8Array(w+(E-_)),T=w;_!==E;)A[T++]=m[_++];return A}}}function g(h){var p=f(h);if(p)return p;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:f,decode:g}}var PFe=OFe,kFe=PFe;const NFe=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};class LFe{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class MFe{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return kM(this,e)}}class UFe{constructor(e){this.decoders=e}or(e){return kM(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}const kM=(r,e)=>new UFe({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});class BFe{constructor(e,t,n,s){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=s,this.encoder=new LFe(e,t,n),this.decoder=new MFe(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const NM=({name:r,prefix:e,encode:t,decode:n})=>new BFe(r,e,t,n),LM=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:s}=kFe(t,e);return NM({prefix:r,name:e,encode:n,decode:i=>NFe(s(i))})},zFe=(r,e,t,n)=>{const s={};for(let l=0;l<e.length;++l)s[e[l]]=l;let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let a=0,c=0,u=0;for(let l=0;l<i;++l){const d=s[r[l]];if(d===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|d,a+=t,a>=8&&(a-=8,o[u++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},FFe=(r,e,t)=>{const n=e[e.length-1]==="=",s=(1<<t)-1;let i="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,i+=e[s&a>>o];if(o&&(i+=e[s&a<<t-o]),n)for(;i.length*t&7;)i+="=";return i},Ki=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>NM({prefix:e,name:r,encode(s){return FFe(s,n,t)},decode(s){return zFe(s,n,t,r)}});Ki({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Ki({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Ki({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Ki({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Ki({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Ki({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Ki({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Ki({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Ki({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});LM({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});LM({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});class VFe extends Y4{constructor(e,t){super(),this.child=e,this.bitswap=t}open(){return this.child.open()}close(){return this.child.close()}unwrap(){return this.child}async put(e,t,n={}){await this.has(e)||(this.bitswap.isStarted()?await this.bitswap.put(e,t,n):await this.child.put(e,t,n))}async*putMany(e,t={}){const n=dt(e,async({key:s})=>!await this.has(s));this.bitswap.isStarted()?yield*this.bitswap.putMany(n,t):yield*this.child.putMany(n,t)}async get(e,t={}){return!await this.has(e)&&this.bitswap.isStarted()?this.bitswap.get(e,t):this.child.get(e,t)}async*getMany(e,t={}){const n=Mt({objectMode:!0}),s=Mt({objectMode:!0});Promise.resolve().then(async()=>{for await(const i of e)!await this.has(i)&&this.bitswap.isStarted()?n.push(i):s.push(i);n.end(),s.end()}),yield*nn(this.bitswap.getMany(n,t),this.child.getMany(s,t))}async delete(e,t){await this.child.delete(e,t)}async*deleteMany(e,t){yield*this.child.deleteMany(e,t)}async has(e,t={}){return this.child.has(e,t)}async*query(e,t={}){yield*this.child.query(e,t)}async*queryKeys(e,t={}){yield*this.child.queryKeys(e,t)}}class F8{constructor(e,t,n,s,i){this.peerId=e,this.libp2p=t,this.bitswap=n,this.repo=s,this.blockstore=i}static async start({peerId:e,repo:t,print:n,hashers:s,options:i}){t.closed&&await t.open();const o=await t.config.getAll(),a=await L8({options:i,repo:t,peerId:e,multiaddrs:jFe(e,o),config:o,keychainConfig:void 0});await a.start();for(const l of a.getMultiaddrs())n(`Swarm listening on ${l.toString()}`);const c=DFe(a,t.blocks,{statsEnabled:!0,hashLoader:s,maxInboundStreams:1024,maxOutboundStreams:1024});await c.start();const u=new VFe(t.blocks,c);return t.blocks=u,t.pins.blockstore=u,new F8(e,a,c,t,u)}static async stop(e){e.repo.blocks=e.blockstore.unwrap(),e.repo.pins.blockstore=e.blockstore.unwrap(),await e.bitswap.stop(),await e.libp2p.stop()}}const jFe=(r,e)=>{const t=r.toString(),n=[],s=e.Addresses&&e.Addresses.Swarm||[];for(const i of s){let o=xl(i);if(o.protoCodes().includes(qFe))throw $(new Error("websocket-star swarm addresses are not supported. See https://github.com/ipfs/js-ipfs/issues/2779"),"ERR_WEBSOCKET_STAR_SWARM_ADDR_NOT_SUPPORTED");const a=o.getPeerId();a&&a!==t&&(o=o.encapsulate(`/p2p/${t}`)),n.push(o)}return n},qFe=479;function KFe({network:r}){async function e(t={}){const n=[],{libp2p:s}=await r.use(t);return await s.peerStore.forEach(i=>{n.push({id:i.id,addrs:i.addresses.map(o=>o.multiaddr)})}),n}return F(e)}function GFe({network:r}){async function e(t,n={}){const{libp2p:s}=await r.use(n);await s.dial(t,n)}return F(e)}function HFe({network:r}){async function e(t,n={}){const{libp2p:s}=await r.use(n);await s.hangUp(t)}return F(e)}function WFe({network:r}){async function e(t={}){const{libp2p:n}=await r.use(t);return n.getMultiaddrs()}return F(e)}function QFe({network:r}){async function e(t={}){const{libp2p:n}=await r.use(t);if(t.verbose){const i=[];for(const o of n.getConnections()){const a={addr:o.remoteAddr,peer:o.remotePeer};(t.verbose||t.direction)&&(a.direction=o.stat.direction),t.verbose&&(a.muxer=o.stat.multiplexer,a.latency="n/a",a.streams=[]),i.push(a)}return i}const s=new Map;for(const i of n.getConnections()){const o={addr:i.remoteAddr,peer:i.remotePeer};s.set(i.remotePeer.toString(),o)}return Array.from(s.values())}return F(e)}class YFe{constructor({network:e}){this.addrs=KFe({network:e}),this.connect=GFe({network:e}),this.disconnect=HFe({network:e}),this.localAddrs=WFe({network:e}),this.peers=QFe({network:e})}}const rd={success:!0,time:0,text:""};function XFe({network:r}){async function*e(t,n={}){const{libp2p:s}=await r.use();n.count=n.count||10;const i=await s.peerStore.get(t);let o=i&&i.id;if(!o){yield{...rd,text:`Looking up peer ${t}`};const u=await s.peerRouting.findPeer(t);o=u&&u.id}if(!o)throw new Error("Peer was not found");yield{...rd,text:`PING ${o.toString()}`};let a=0,c=0;for(let u=0;u<n.count;u++)try{const l=await s.ping(o);c+=l,a++,yield{...rd,time:l}}catch(l){yield{...rd,success:!1,text:l.toString()}}if(a){const u=c/a;yield{...rd,text:`Average latency: ${u}ms`}}}return F(e)}const vw="/ipns/";function gT(r){r.startsWith(vw)&&(r=r.substring(vw.length));let e;if((r[0]==="1"||r[0]==="Q")&&(r=`z${r}`),r[0]==="z"&&(e=qr.decode(r)),r[0]==="k"&&(e=Mp.decode(r)),!e)throw new Error("Could not parse string");if(e[0]!==1&&e[1]!==114&&(e=M([[1,114],e])),e.length!==40)throw new Error("Incorrect length "+e.length);return M([L(vw),e.subarray(2)])}function JFe({network:r,repo:e,peerId:t}){const{get:n,put:s,findProvs:i,findPeer:o,provide:a,query:c}={async*get(u,l={}){const{libp2p:d}=await $c(r,t,l),f=u instanceof Uint8Array?u:gT(u);if(d.dht==null)throw $(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*d.dht.get(f,l)},async*put(u,l,d){const{libp2p:f}=await $c(r,t,d),g=u instanceof Uint8Array?u:gT(u);if(f.dht==null)throw $(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*f.dht.put(g,l,d)},async*findProvs(u,l={}){const{libp2p:d}=await $c(r,t,l);if(d.dht==null)throw $(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*d.dht.findProviders(u,{signal:l.signal})},async*findPeer(u,l={}){const{libp2p:d}=await $c(r,t,l);if(d.dht==null)throw $(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*d.dht.findPeer(u,{signal:l.signal})},async*provide(u,l={recursive:!1}){const{libp2p:d}=await $c(r,t,l);if(!await e.blocks.has(u))throw $(new Error("block(s) not found locally, cannot provide"),"ERR_BLOCK_NOT_FOUND");if(l.recursive)throw $(new Error("not implemented yet"),"ERR_NOT_IMPLEMENTED_YET");if(d.dht==null)throw $(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*d.dht.provide(u)},async*query(u,l={}){const{libp2p:d}=await $c(r,t,l);let f;const g=ne.asCID(u);if(g!=null?f=g.multihash.bytes:f=de(u.toString()).toBytes(),d.dht==null)throw $(new Error("dht not configured"),"ERR_DHT_NOT_CONFIGURED");yield*d.dht.getClosestPeers(f,l)}};return{get:F(n),put:F(s),findProvs:F(i),findPeer:F(o),provide:F(a),query:F(c)}}const $c=async(r,e,t)=>{const n=await r.use(t);if(n.libp2p.dht!=null)return n;{const s=async function*(){yield{from:e,name:"QUERY_ERROR",type:3,error:new Cl("dht not enabled")}};return{libp2p:{dht:{get:s,put:s,findProviders:s,findPeer:s,provide:s,getClosestPeers:s}}}}};function ZFe({network:r,config:e}){const t=ve(e||{},"Pubsub.Enabled",!0),n={};let s;return{subscribe:t?F(i):nd,unsubscribe:t?F(o):nd,publish:t?F(a):nd,ls:t?F(c):nd,peers:t?F(u):nd};async function i(l,d,f={}){const{libp2p:g}=await r.use(f);g.pubsub.subscribe(l),s==null&&(s=h=>{const p=h.detail;n[p.topic]&&n[p.topic].forEach(w=>{if(typeof w=="function"){w(p);return}w!=null&&w.handleEvent!=null&&w.handleEvent(p)})},g.pubsub.addEventListener("message",s)),d!=null&&(n[l]==null&&(n[l]=[]),n[l].push(d))}async function o(l,d,f={}){const{libp2p:g}=await r.use(f);d!=null&&n[l]!=null&&(n[l]=n[l].filter(h=>h!==d),n[l].length===0&&delete n[l]),typeof d!="function"&&delete n[l],n[l]==null&&g.pubsub.unsubscribe(l),Object.keys(n).length===0&&(g.pubsub.removeEventListener("message",s),s=void 0)}async function a(l,d,f={}){const{libp2p:g}=await r.use(f);if(!d)throw $(new Error('argument "data" is required'),"ERR_ARG_REQUIRED");await g.pubsub.publish(l,d)}async function c(l={}){const{libp2p:d}=await r.use(l);return d.pubsub.getTopics()}async function u(l,d={}){const{libp2p:f}=await r.use(d);return f.pubsub.getSubscribers(l)}}const nd=async()=>{throw new Cl("pubsub not enabled")},eVe=et.bind({ignoreUndefined:!0}),Zi=N("ipfs"),tVe=3e4;class rVe{constructor({print:e,storage:t,codecs:n,options:s}){const{peerId:i,repo:o,keychain:a}=t,c=us.create(F8),u=Vhe(s.preload),l=nY(),d=sY({network:c}),f=new fZ(s),g=Object.values(mK);(s.ipld&&s.ipld.hashers?s.ipld.hashers:[]).forEach(se=>g.push(se)),this.hashers=new UP({hashers:g,loadHasher:s.ipld&&s.ipld.loadHasher});const h=Object.values(DI);(s.ipld&&s.ipld.bases?s.ipld.bases:[]).forEach(se=>h.push(se)),this.bases=new LP({bases:h,loadBase:s.ipld&&s.ipld.loadBase});const p=new BX({repo:o,codecs:n}),w=new mre({codecs:n,hashers:this.hashers,preload:u,repo:o}),y=new RZ({dns:l,ipns:f,repo:o,codecs:n,peerId:i,isOnline:d,keychain:a,options:s}),E=xX({repo:o,codecs:n,bases:this.bases,name:y}),m=new Gue({repo:o,codecs:n,hashers:this.hashers,preload:u}),b=Object.assign(IZ({repo:o,codecs:n,resolve:E,preload:u}),{local:kZ({repo:t.repo})}),{add:v,addAll:S,cat:_,get:A,ls:T}=new Ale({preload:u,repo:o,options:s.EXPERIMENTAL,hashers:this.hashers}),P=spe({repo:o,preload:u,hashers:this.hashers,options:s}),V=jhe({files:P,preload:u,options:s.preload});this.preload=u,this.name=y,this.ipns=f,this.pin=p,this.resolve=E,this.block=w,this.refs=b,this.start=fQ({network:c,peerId:i,repo:o,preload:u,ipns:f,mfsPreload:V,print:e,keychain:a,hashers:this.hashers,options:s}),this.stop=pQ({network:c,preload:u,mfsPreload:V,ipns:f,repo:o}),this.dht=JFe({network:c,repo:o,peerId:i}),this.pubsub=ZFe({network:c,config:s.config}),this.dns=l,this.isOnline=d,this.id=Cle({network:c,peerId:i}),this.version=Tle({repo:o}),this.bitswap=new UZ({network:c}),this.bootstrap=new fre({repo:o}),this.config=kle({repo:o}),this.ping=XFe({network:c}),this.add=v,this.addAll=S,this.cat=_,this.get=A,this.ls=T,this.dag=m,this.files=P,this.key=new hpe({keychain:a}),this.object=new _pe({preload:u,codecs:n,repo:o}),this.repo=new Rpe({repo:o,hashers:this.hashers}),this.stats=new Ipe({repo:o,network:c}),this.swarm=new YFe({network:c}),Object.defineProperty(this,"libp2p",{get(){const se=c.try();return se?se.libp2p:void 0}});const Y=()=>Promise.reject($(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")),te=async function*(){throw $(new Error("Not implemented"),"ERR_NOT_IMPLEMENTED")};this.commands=Y,this.diag={cmds:Y,net:Y,sys:Y},this.log={level:Y,ls:Y,tail:te},this.mount=Y,this.codecs=n}async init(){throw new Na}}const nVe=async r=>{const e=Je({Data:new Ze({type:"directory"}).marshal(),Links:[]}),t=await r.block.put(e,{mhtype:"sha2-256",format:"dag-pb"});return await r.pin.add(t),t},sVe=()=>({start:!0,EXPERIMENTAL:{},preload:{enabled:!Pi.isTest,addresses:["/dns4/node0.preload.ipfs.io/https","/dns4/node1.preload.ipfs.io/https","/dns4/node2.preload.ipfs.io/https","/dns4/node3.preload.ipfs.io/https"]}});async function iVe(r={}){r=eVe(sVe(),r);const e=r.init||{},t={name:Mw.name,code:Mw.code,encode:u=>u,decode:u=>u},n=Object.values(EK);[Lo,AT,fI,_I,t].concat(r.ipld&&r.ipld.codecs||[]).forEach(u=>n.push(u));const s=new MP({codecs:n,loadCodec:r.ipld&&r.ipld.loadCodec}),i=r.silent?Zi:console.log;Zi("creating repo");const o=await M8.start(i,s,r);Zi("getting repo config");const a=await o.repo.config.getAll(),c=new rVe({storage:o,print:i,codecs:s,options:{...r,config:a}});if(Zi("starting preload"),await c.preload.start(),Zi("starting storage"),c.ipns.startOffline(o),o.isNew&&!e.emptyRepo){const u=await nVe(c);if(Zi("adding default assets"),await(c.addAll,void 0),Zi("initializing IPNS keyspace"),o.peerId.publicKey==null)throw $(new Error("Public key missing"),"ERR_MISSING_PUBLIC_KEY");const l=new ft.TimeoutController(tVe);try{await c.ipns.initializeKeyspace(o.peerId,L(`/ipfs/${u}`),{signal:l.signal})}finally{l.clear()}}return r.start!==!1&&(Zi("starting node"),await c.start()),c}const oVe=iVe;var J6;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(J6||(J6={}));const aVe=async()=>{let r;return $d||TT?r=(await Vl(()=>import("./configNavigateur-0044a0a6.js"),["configNavigateur-0044a0a6.js","const-bf3ca0eb.js","index-2b10586a.js","index-3acde0f6.css","index-d5be5954.js"])).default:rm?r=(await Vl(()=>import("./configTravailleur-ead68a5e.js"),["configTravailleur-ead68a5e.js","index-d5be5954.js","index-2b10586a.js","index-3acde0f6.css"])).default:RT?r=(await Vl(()=>import("./configlectronPrincipal-23f3d6e8.js"),["configlectronPrincipal-23f3d6e8.js","const-bf3ca0eb.js","index-2b10586a.js","index-3acde0f6.css","index-0a2db50b.js","index-d5be5954.js"])).default:$T?r=(await Vl(()=>import("./configNode-a76e2257.js"),["configNode-a76e2257.js","const-bf3ca0eb.js","index-2b10586a.js","index-3acde0f6.css","index-0a2db50b.js","index-d5be5954.js"])).default:(console.warn("Plateforme non reconnue. On utilisera la configuration navigateur."),r=(await Vl(()=>import("./configNavigateur-0044a0a6.js"),["configNavigateur-0044a0a6.js","const-bf3ca0eb.js","index-2b10586a.js","index-3acde0f6.css","index-d5be5954.js"])).default),r},cVe=()=>({libp2p:{streamMuxers:[dz()],connectionEncryption:[_M()],transportManager:{faultTolerance:J6.NO_FATAL}},relay:{enabled:!0,hop:{enabled:!0,active:!0}}});async function lVe(r="./constl/sfip"){const e=cVe(),t=await aVe();e.repo=r;const n=et(e,t);return await oVe(n)}const SGe=Object.freeze(Object.defineProperty({__proto__:null,default:lVe},Symbol.toStringTag,{value:"Module"}));export{Q8 as A,W as C,gt as E,cM as P,ue as U,f$e as W,Td as a,Ne as b,Pe as c,wp as d,$ as e,a$e as f,cke as g,aM as h,Cqe as i,Hh as j,SGe as k,N as l,Lh as m,_M as n,de as p,U5 as r,F5 as s,zUe as w};
//# sourceMappingURL=index-067efd29.js.map
