{"version":3,"file":"downloader-4U8Usv8C.js","sources":["../../../../node_modules/native-file-system-adapter/src/adapters/downloader.js"],"sourcesContent":["import { errors } from '../util.js'\nimport config from '../config.js'\n\nconst {\n  WritableStream,\n  TransformStream,\n  DOMException,\n  Blob\n} = config\n\nconst { GONE } = errors\n// @ts-ignore - Don't match newer versions of Safari, but that's okay\nconst isOldSafari = /constructor/i.test(window.HTMLElement)\n\nexport class FileHandle {\n  constructor (name = 'unkown') {\n    this.name = name\n    this.kind = 'file'\n  }\n\n  async getFile () {\n    throw new DOMException(...GONE)\n  }\n\n  async isSameEntry(other) {\n    return this === other\n  }\n\n  /**\n   * @param {object} [options={}]\n   */\n  async createWritable (options = {}) {\n    const sw = await navigator.serviceWorker?.getRegistration()\n    const link = document.createElement('a')\n    const ts = new TransformStream()\n    const sink = ts.writable\n\n    link.download = this.name\n\n    if (isOldSafari || !sw) {\n      /** @type {Blob[]} */\n      let chunks = []\n      ts.readable.pipeTo(new WritableStream({\n        write (chunk) {\n          chunks.push(new Blob([chunk]))\n        },\n        close () {\n          const blob = new Blob(chunks, { type: 'application/octet-stream; charset=utf-8' })\n          chunks = []\n          link.href = URL.createObjectURL(blob)\n          link.click()\n          setTimeout(() => URL.revokeObjectURL(link.href), 10000)\n        }\n      }))\n    } else {\n      const { writable, readablePort } = new RemoteWritableStream(WritableStream)\n      // Make filename RFC5987 compatible\n      const fileName = encodeURIComponent(this.name).replace(/['()]/g, escape).replace(/\\*/g, '%2A')\n      const headers = {\n        'content-disposition': \"attachment; filename*=UTF-8''\" + fileName,\n        'content-type': 'application/octet-stream; charset=utf-8',\n        ...(options.size ? { 'content-length': options.size } : {})\n      }\n\n      const keepAlive = setTimeout(() => sw.active.postMessage(0), 10000)\n\n      ts.readable.pipeThrough(new TransformStream({\n        transform (chunk, ctrl) {\n          if (chunk instanceof Uint8Array) return ctrl.enqueue(chunk)\n          const reader = new Response(chunk).body.getReader()\n          const pump = _ => reader.read().then(e => e.done ? 0 : pump(ctrl.enqueue(e.value)))\n          return pump()\n        }\n      })).pipeTo(writable).finally(() => {\n        clearInterval(keepAlive)\n      })\n\n      // Transfer the stream to service worker\n      sw.active.postMessage({\n        url: sw.scope + fileName,\n        headers,\n        readablePort\n      }, [readablePort])\n\n      // Trigger the download with a hidden iframe\n      const iframe = document.createElement('iframe')\n      iframe.hidden = true\n      iframe.src = sw.scope + fileName\n      document.body.appendChild(iframe)\n    }\n\n    return sink.getWriter()\n  }\n}\n\n// Want to remove this postMessage hack, tell them u want transferable streams:\n// https://bugs.webkit.org/show_bug.cgi?id=215485\n\nconst WRITE = 0\nconst PULL = 0\nconst ERROR = 1\nconst ABORT = 1\nconst CLOSE = 2\n\nclass MessagePortSink {\n  /** @param {MessagePort} port */\n  constructor (port) {\n    port.onmessage = event => this._onMessage(event.data)\n    this._port = port\n    this._resetReady()\n  }\n\n  start (controller) {\n    this._controller = controller\n    // Apply initial backpressure\n    return this._readyPromise\n  }\n\n  write (chunk) {\n    const message = { type: WRITE, chunk }\n\n    // Send chunk\n    this._port.postMessage(message, [chunk.buffer])\n\n    // Assume backpressure after every write, until sender pulls\n    this._resetReady()\n\n    // Apply backpressure\n    return this._readyPromise\n  }\n\n  close () {\n    this._port.postMessage({ type: CLOSE })\n    this._port.close()\n  }\n\n  abort (reason) {\n    this._port.postMessage({ type: ABORT, reason })\n    this._port.close()\n  }\n\n  _onMessage (message) {\n    if (message.type === PULL) this._resolveReady()\n    if (message.type === ERROR) this._onError(message.reason)\n  }\n\n  _onError (reason) {\n    this._controller.error(reason)\n    this._rejectReady(reason)\n    this._port.close()\n  }\n\n  _resetReady () {\n    this._readyPromise = new Promise((resolve, reject) => {\n      this._readyResolve = resolve\n      this._readyReject = reject\n    })\n    this._readyPending = true\n  }\n\n  _resolveReady () {\n    this._readyResolve()\n    this._readyPending = false\n  }\n\n  _rejectReady (reason) {\n    if (!this._readyPending) this._resetReady()\n    this._readyPromise.catch(() => {})\n    this._readyReject(reason)\n    this._readyPending = false\n  }\n}\n\nclass RemoteWritableStream {\n  constructor (WritableStream) {\n    const channel = new MessageChannel()\n    this.readablePort = channel.port1\n    this.writable = new WritableStream(\n      new MessagePortSink(channel.port2)\n    )\n  }\n}\n"],"names":["WritableStream","TransformStream","DOMException","Blob","config","GONE","errors","isOldSafari","FileHandle","name","other","options","sw","link","ts","sink","chunks","chunk","blob","writable","readablePort","RemoteWritableStream","fileName","headers","keepAlive","ctrl","reader","pump","_","e","iframe","WRITE","PULL","ERROR","ABORT","CLOSE","MessagePortSink","port","event","controller","message","reason","resolve","reject","channel"],"mappings":"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","x_google_ignoreList":[0]}